<!DOCTYPE html>
<html>
    <head>
        <script src="/static/js/jquery-1.9.1.min.js"> </script>
        <script src="/static/js/bson.js"> </script>

        <script type="text/javascript">
            var sock = null;
            var ellog = null;
            var BSON = bson().BSON;


            window.onload = function() {

                ellog = document.getElementById('log');

                var wsuri;
                if (window.location.protocol === "file:") {
                    wsuri = "ws://localhost:8080/ws";
                } else {
                    wsuri = "ws://" + window.location.hostname + ":8080/ws";
                }

                if ("WebSocket" in window) {
                    sock = new WebSocket(wsuri);
                } else if ("MozWebSocket" in window) {
                    sock = new MozWebSocket(wsuri);
                } else {
                    log("Browser does not support WebSocket!");
                    window.location = "http://autobahn.ws/unsupportedbrowser";
                }

                if (sock) {

                    sock.binaryType = "arraybuffer";

                    sock.onopen = function() {
                        log("Connected to " + wsuri);
                    
                    }

                    sock.onclose = function(e) {
                        log("Connection closed (wasClean = " + e.wasClean + ", code = " + e.code + ", reason = '" + e.reason + "')");
                        sock = null;
                    }

                    sock.onmessage = function(e) {
                        // if response is image
                        // Create an image tag
                        var resp = BSON.deserialize(new Uint8Array(e.data));

                        $("#img").empty();
                        var img = new Image();
                        var imgdata = resp.image.buffer;
                        //var x = new Uint8Array(data, 0);
                        //str = data.rQshiftBytes();
                        img.src = "data:image/jpg;base64," + btoa(String.fromCharCode.apply(null, imgdata))
                        $("#img").append(img);
                        //$("#img").appendChild(img);
                        log("Got echo: " + e.data);
                    }
                }
            };

            function send() {
                var msgstr = document.getElementById('message').value;
                var msg = BSON.serialize({name:msgstr}); 
                if (sock) {
                    sock.send(msg);
                    log("Sent: " + msg);
                } else {
                    log("Not connected.");
                }
            };

            function log(m) {
                ellog.innerHTML += m + '\n';
                ellog.scrollTop = ellog.scrollHeight;
            };
        </script>
    </head>
    <body>
        <h1>Autobahn WebSocket Echo Test</h1>
        <noscript>You must enable JavaScript</noscript>
        <form>
            <p>Message: <input id="message" type="text" size="50" maxlength="50" value="Hello, world!"></p>
        </form>
        <button onclick='send();'>Send Message</button>
        <div id="img"> </div>
        <pre id="log" style="height: 20em; overflow-y: scroll; background-color: #faa;"></pre>
    </body>
</html>
