
{% extends 'frontend_base.html' %}


{% block title %}{{ super() }} - Stack Editor{% endblock title %}


{% block styles %}
{# TODO: base style assumes navbar will be present #}
{#{{ super() }}#}
    <script src="/static/thirdparty/jquery-ui/1.10.2/jquery-ui.min.js"></script>
    <link rel="stylesheet"
          href="/static/thirdparty/jquery-ui/1.10.2/jquery-ui.css">
    <script type="text/javascript" src="/static/thirdparty/glmatrix/0.9.5-r1/glMatrix-min.js"></script>
    <script type="text/javascript" src="{{ url_for('glviewer.static', filename='tile.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('glviewer.static', filename='loader.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('glviewer.static', filename='cache.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('glviewer.static', filename='section.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('glviewer.static', filename='camera.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('glviewer.static', filename='view.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('glviewer.static', filename='viewer-utils.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('glviewer.static', filename='shape.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('glviewer.static', filename='polyline.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('glviewer.static', filename='cutout.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('glviewer.static', filename='align.js') }}"></script>


    <style>

      .clear {
            clear:both;
      }
      .bar {
            width: 100%;
            border: 1px solid #CCC;
      }
      .barItem {
            float: left;
            pad: 4px;
            margin-left: 1em;
            margin-right: 3em;
      }


      body {
            margin: 0;
            overflow: hidden;
      }
      #wrapper {
            width: auto;
            overflow: hidden;
      }

      #collectionLabel {
            font-size: 1.2em;
            font-weight: bold;
      }



      #stackDiv {
            height: 135px;
            width: 100%;
            border: 1px solid #CCC;
            overflow-x: auto;
      }
      #stack {
            position: relative;
            list-style: none;
      }
      .stackItem {
            position: absolute;
            padding: 2px;
            margin: 2px;
            border: 2px solid #CCC;
      }



      #gallery {
            position: relative;
            padding: 0;
            border: 1px solid #CCC;
            height: 100%;
            list-style: none;
            overflow-y: auto;
      }
      #gallery li {
            float: left;
            padding: 2px;
            margin: 2px;
            border: 2px solid #CCC;
      }
      #gallery li div {
            color: #333;
            font-size: 11px;
      }

    </style>
{% endblock styles %}


{% block scripts %}
{{ super() }}
    <script>

var GL = false;                // hack
var TILELOADER = 'http';       // hack
function eventuallyRender() {} // hack

var SESSION_ID = "{{ session.id }}";
var COLLECTIONS;
var SELECTED_COLLECTION;
var SELECTED_SESSION;
var DETECT_MODE = 'single';
var GALLERY_THUMBS = [];

function handleResize() {
    var height = window.innerHeight - 2;
    var y = $('#galleryDiv').position().top + 5;
    var h2 = height - y;
    $('#galleryDiv').css({"height": h2.toString() + "px"});
}


$(document).ready(function() { main(); });


function main() {

    $('#saveButton').prop('disabled',true);

    // A toggle between slide and section view.
    $('<div>')

    //loadSessionFromId(SESSION_ID);
    // This loads the session eventually
    $.get("/sessions?json=true",
      function(data,status){
          if (status == "success") {
              loadCollectionList(data);
          } else {
              alert("ajax failed.");
          }
      });

    // Populate the sessions menu.
    $("#detectList").empty();
    $('<option>').appendTo($('#detectList'))
        .attr('value', 0)
        .text("Single");
    $('<option>').appendTo($('#detectList'))
        .attr('value', 1)
        .text("Multiple");

    $(window).resize(function() { handleResize(); })
             .trigger('resize');
}

function detectCallback (idx) {
    idx = parseInt(idx);
    if (idx == 0) { DETECT_MODE = 'single'; }
    if (idx == 1) { DETECT_MODE = 'multiple'; }
}


// Called once to populate the collection menu.
function loadCollectionList(data) {
    // The first "sessions" list is actually collections.
    COLLECTIONS = data.sessions;
    // Populate the collection menu.
    var defaultCollectionIndex = 0;
    for (var i = 0; i < COLLECTIONS.length; ++i) {
        var option = $('<option>').appendTo($('#collectionList'))
                .attr('value', i)
                .text(data.sessions[i].rule);
        // Set the default selected value.
        if (data.sessions[i].rule == "{{collection.label}}") {
            option.attr('selected', true);
            defaultCollectionIndex = i;
        }
    }
    if (COLLECTIONS.length > 0) {
        selectCollection(defaultCollectionIndex, "{{ session_son.label }}");
    }
    handleResize();

}


function loadSessionFromId(sessionId) {
    $.get("/sessions?json=1&sessid="+sessionId,
          function(data,status){
              if (status == "success") {
                  loadSessionData(data);
              } else {
                  alert("ajax failed."); }
         });

}


// Put all the session views into the gallery.
function loadSessionData(data) {
    var searchStrings = [];
    $('#imagesearch').val("");
    $('#gallery').empty();
    GALLERY_THUMBS = [];

    for (var i = 0; i < data.session.views.length; ++i) {
        searchStrings.push(data.session.views[i].label);
        // Create a div that has both an image and a label.
        var listItem = $('<li>').appendTo($('#gallery'))
                        .attr('search',data.session.views[i].label);

        var imageData = data.images[i];
        // cache expects different variables.
        imageData._id = imageData.img;
        imageData.database = imageData.db;
        var thumb = new CutoutThumb(imageData, 192)
        thumb.AppendTo(listItem);
        thumb.ListItem = listItem; // To check for visibility.
        GALLERY_THUMBS.push(thumb);
        thumb.Click(function(tmb) {
                        addViewToStack(tmb);
                        $('#stackDiv').animate({scrollLeft: STACK_END_X});
                    });

        var labelDiv = $('<div>')
            .appendTo(listItem)
            .text(data.session.views[i].label); // Should really have the image label.
        }
    $('#imagesearch').autocomplete({source: searchStrings});
}

var DEBUG = false;
var STACK_ITEMS = [];
var STACK_END_X = 5;
function addViewToStack(thumb) {
    var imageObj = thumb.ImageData;
    var xMid = thumb.SlideX;
    var yMid = thumb.SlideY;

    $('#saveButton').prop('disabled',false);

    // Get the image.
    // Find contours.
    // Split up the contours into sections.
    var cache = FindCache(imageObj);
    var bds = imageObj.bounds;
    var fp = [(bds[0]+bds[1])*0.5, (bds[2]+bds[3])*0.5];
    var dims = imageObj.dimensions.slice(0);
    var scale = 1.0;
    while (dims[0] > 1024) {
        scale *= 2;
        dims[0] *= 0.5;
        dims[1] *= 0.5;
    }
    dims[0] = Math.floor(dims[0]);
    dims[1] = Math.floor(dims[1]);
    // We do not have the view data to get roll.
    GetCutoutImage(cache, dims, fp, scale, 0,
        function (data) {
            contours = FindSectionContours(data);
            // Find the contour that is closest to the selected point.
            contours[0].TransformToWorld();

            if (DEBUG) {
              CUTOUT_VIEW
                .appendTo('body')
                .css({'position': 'fixed',
                      'left': '50px',
                      'top': '50px'});
              // Draw the contours.
              for (var i = 0; i < contours.length; ++i) {
                  var red = i / contours.length;
                  contours[i].MakePolyline([red,0,1.0-red], CUTOUT_VIEW);
              }
              CUTOUT_VIEW.DrawTiles();
              CUTOUT_VIEW.DrawShapes();
            }
            var closestContour = contours[0];
            var closestDist2 = closestContour.GetDistanceSquared(xMid,yMid);
            for (var i = 1; i < contours.length; ++i) {
                contours[i].TransformToWorld();
                var dist2 = contours[i].GetDistanceSquared(xMid,yMid);
                if (dist2 < closestDist2) {
                    closestDist2 = dist2;
                    closestContour = contours[i];
                }
            }

            if (DETECT_MODE == 'single') {
                addViewSectionToStack(closestContour, imageObj);
            } else {
                // Sort based on the location of the selected section.
                // Filter the contours based on the positive example.
                contours = SortAndFilterContours(contours, closestContour);
                for (var i = 0; i < contours.length; ++i) {
                    addViewSectionToStack(contours[i], imageObj);
                }
            }
        }
    );
}

function deleteItem(item, itemObj) {
    item.remove();
    var index = STACK_ITEMS.indexOf(itemObj);
    if (index > -1) {
        STACK_ITEMS.splice(index, 1);
    }
    // Since we positioned the items explicility.
    var items = $('#stack').children();
    STACK_END_X = 5;
    for (var idx = 0; idx < items.length; ++idx) {
        $(items[idx])
            .css({"top": '2px',
                  "left": STACK_END_X.toString()+"px"});
        STACK_END_X += $(items[idx]).width() + 10;
    }
}

function addViewSectionToStack(contour, imageObj) {
    contour.TransformToWorld();
    var center = contour.GetCenter();
    var bds = contour.GetBounds();

    // Add the contour to the stack

    // Height is only for the first items default view.
    var itemObj = {img:    imageObj.img,
                   db:     imageObj.db,
                   x:      center[0],
                   y:      center[1],
                   height: bds[3]-bds[2]};
    STACK_ITEMS.push(itemObj);

    // Give the image some padding.
    bds[0] = center[0] + (bds[0]-center[0])*1.1;
    bds[1] = center[0] + (bds[1]-center[0])*1.1;
    bds[2] = center[1] + (bds[2]-center[1])*1.1;
    bds[3] = center[1] + (bds[3]-center[1])*1.1;

    var deleteButton = $('<img>');
    var item = $('<div>')
        .attr("class","stackItem")
        .appendTo($('#stack'))
        .css({"top": '2px',
              "left": STACK_END_X.toString()+"px"})
        .hover(function () {
                   deleteButton.css({'-webkit-filter': 'grayscale(0)',
                                    'opacity':'1.0'});
               },
               function () {
                   deleteButton.css({'-webkit-filter': 'grayscale(1)',
                                     'opacity': '0.3'});
               });
     deleteButton
        .appendTo(item)
        .css({'height': '10px',
              'position': 'absolute',
              'top': '0px',
              'right': '0px',
              'z-index': '5',
              'opacity': '0.3',
              '-webkit-filter': 'grayscale(1)'})
        .attr('src',"/webgl-viewer/static/deleteSmall.png")
        .click(function(){
                   deleteItem(item, itemObj);
               });
    var section = new CutoutThumb(imageObj, 100, bds)
        .AppendTo(item);
    STACK_END_X += item.width() + 10;
}

function collectionCallback(idx) {
    $('#gallery').empty();
    GALLERY_THUMBS = [];
    selectCollection(parseInt(idx));
}


function sessionCallback(idx) {
    $('#gallery').empty();
    GALLERY_THUMBS = [];
    selectSession(parseInt(idx));
}


function selectCollection(idx, defaultSessionLabel) {
    SELECTED_COLLECTION = COLLECTIONS[idx];
    // Populate the sessions menu.
    $("#sessionList").empty();
    var defaultSessionIndex = 0;
    var sessions = SELECTED_COLLECTION.sessions;
    for (var i = 0; i < sessions.length; ++i) {
        var option = $('<option>').appendTo($('#sessionList'))
            .attr('value', i)
            .text(sessions[i].label);
        if (defaultSessionLabel && defaultSessionLabel == sessions[i].label) {
            defaultSessionIndex = i;
            option.attr('selected', true);
        }
    }
    if (sessions.length > 0) {
        selectSession(defaultSessionIndex);
    }
    handleResize();
}


function selectSession(idx) {
    SELECTED_SESSION = SELECTED_COLLECTION.sessions[idx];
    $.get("/sessions?json=1&sessid="+SELECTED_SESSION.sessid,
          function(data,status){
              if (status == "success") {
                  loadSessionData(data);
              } else {
                  alert("ajax failed.");
              }
          });
}


function searchCallback() {
    var str = $('#imagesearch').val();
    keys = str.split(" ");
    slides = $('#gallery li');
    for (var i = 0; i < slides.length; ++i) {
        var slide = $(slides[i]);
        var label = slide.attr('search');
        var found = true;
        for (var j = 0; j < keys.length && found; ++j) {
            if (label.indexOf(keys[j]) == -1) { found = false; }
        }
        if (found) {
            slide.show();
        } else {
            slide.hide();
        }
    }
}


function addAllCallback() {
    for (var i = 0; i < GALLERY_THUMBS.length; ++i) {
        var thumb = GALLERY_THUMBS[i];
        if (thumb.ListItem.is(':visible')) {
            // Todo: more sophisticated algorithm that will 
            // will work with multiple option..
            var bds = thumb.ImageData.bounds;
            thumb.SlideX = (bds[0]+bds[1]) * 0.5;
            thumb.SlideY = (bds[2]+bds[3]) * 0.5;
            addViewToStack(thumb);
        }
    }

    $('#saveButton').prop('disabled',false);
    $('#stackDiv').animate({scrollLeft: STACK_END_X});
}


function save() {
  var args = {sessId: SESSION_ID,
              label: $('#stackLabel').val(),
              items: STACK_ITEMS};

  $.ajax({type: "post",
          url: "{{ url_for('.session_save_stack') }}",
          data: {"input" :  JSON.stringify( args )},
          success:
              function save_success (data, status) {
                  // Redirect to stack: problem, getting back to session.
                  //window.location.href = "/webgl-viewer?edit=true&view="+data._id;
                  var d = new Date();
                  window.location.href = "/sessions?sessid="+SESSION_ID+"&reload="+d.getTime();
                  },
                error: function() { alert( "AJAX - error: sessios_save_stack" ); }
            });
}


    </script>
{% endblock scripts %}


{# TODO: with navbar at the top, the session editor isn't the correct vertical height #}
{% block navbar %}{% endblock navbar %}


{% block content %}
{{ super() }}
    <div id="wrapper">
        <div class="bar">
            <label class="barItem" id="collectionLabel"> Stack : </label>
            <div class="barItem">
                <label>Label</label>
                <input type="text" id="stackLabel"
                       name="views" style="width: 340px;" value="new stack"/>
            </div>
            <button class="barItem" id="saveButton" onclick="save()" >Save</button>
            <div class="clear"></div>
        </div>

        <div id="stackDiv">
            <div id="stack">
            </div>
        </div>

        <div class="bar">
            <div class="barItem">
                <label>Collection</label>
                <select id="collectionList" onchange="collectionCallback(this.value)"> </select> 
            </div>
            <div class="barItem">
                <label>Session</label>
                <select id="sessionList" onchange="sessionCallback(this.value)"> </select> 
            </div>
            <div class="barItem">
                Filter: <input type="text" id="imagesearch">
                <button onclick="searchCallback()">Submit</button>
            </div>
            <div class="barItem">
                <label>Detect</label>
                <select id="detectList" onchange="detectCallback(this.value)"> </select> 
            </div>
            <div class="barItem">
                <button onclick="addAllCallback()">Add All</button>
            </div>
            <div class="clear"></div>
        </div>


        <div id="galleryDiv">
            <ul id="gallery">
            </ul>
        </div>
    </div>
{% endblock content %}
