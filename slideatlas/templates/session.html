{% extends "base.html" %}
{% set active_page = "sessions" %}

{% set is_session_admin = security.AdminSessionRequirement(session).can() %}

{% block head_scripts %}
    <style>
    {% if is_session_admin %}
        .bar {
            height: 18px;
            background: green;
        }
    {% endif %}
    </style>

    <script src="/static/thirdparty/bootbox/v4.2.0/bootbox.min.js" type="text/javascript"></script>

    <script src="/static/thirdparty/jquery.fileupload/9.5.7/js/vendor/jquery.ui.widget.js" type="text/javascript"></script>
    <script src="/static/thirdparty/jquery.fileupload/9.5.7/js/jquery.iframe-transport.js" type="text/javascript"></script>
    <script src="/static/thirdparty/jquery.fileupload/9.5.7/js/jquery.fileupload.js" type="text/javascript"></script>

    <script src="/static/js/attachments.js" type="text/javascript"></script>

    <script type="text/javascript">
        $( function () {
            {% if is_session_admin %}
            $(".sa-attachment-delete").click(function() {
                var attachmentItem = $(this).parent();
                var attachmentGet = $(this).siblings(".sa-attachment-get");
                var attachmentUrl = attachmentGet.attr("href");
                var attachmentName = attachmentGet.text();
                confirmAttachmentDelete(attachmentUrl, attachmentName, function() {
                    attachmentItem.remove();
                });
            });
            $(".sa-attachment-post").click(function() {
                var attachmentPostUrl = "{{ url_for('apiv2.session_attachment_list', session=session )}}";
                attachmentUpload(attachmentPostUrl);
            });
            $(".sa-view-permalink").click(function() {
                var viewItem = $(this).parent().parent();
                var viewId = viewItem.attr("imageid")
                var viewGet = viewItem.find(".sa-view-get");
                var viewUrl = viewGet.attr("href");
                var viewName = viewGet.text();
                getPermalink(viewName, viewId, viewUrl);
            });
            {% endif %}
        });
    </script>

{% endblock head_scripts %}

{% block body_content %}
{{ super() }}

<div class="container">
    <div class="row">
        <h1> {{ session_son.label }} </h1>

        {%if session_son.attachments or is_session_admin %}
        <h2>Attachments{% if is_session_admin %}<button class="btn btn-primary pull-right sa-attachment-post"><span class="glyphicon glyphicon-upload"></span> Upload</button>{% endif %}</h2>
        <ul class="list-group">
            {% for attachment_son in session_son.attachments %}
            <li class="list-group-item">
                <a href="{{ url_for('apiv2.session_attachment_item', session=session, attachment_id=attachment_son.id) }}" class="lead sa-attachment-get">{{ attachment_son.name }}</a>
                {% if is_session_admin %}
                <button type="button" class="btn btn-danger badge sa-attachment-delete"><span class="glyphicon glyphicon-remove"></span>Delete</button>
                {% endif %}
            </li>
             {% endfor %}
        </ul>
        {% endif %}

        <br>

        {%if session_son.views %}
        <h2> {{ session_son.views|length }} Images </h2>
        <table class="table table-bordered table-hover" >
            {% for view_son in session_son.views %}
                <tr imageid="{{ view_son.image_id }}">
                    <td>
                        <a href="{{ url_for('glviewer.glview', db=view_son.image_store_id, view=view_son.id) }}">
                            <img src="{{ url_for('tile.thumb_query', db=view_son.image_image_store_id, img=view_son.image_id) }}" width=100px>
                        </a>
                    </td>
                    <td>
                        {% if view_son.label %}
                        <a href="{{ url_for('glviewer.glview', db=view_son.image_store_id, view=view_son.id) }}" class="lead sa-view-get" imageid={{ view_son.image_id }}>
                            {{ view_son.label }}
                        </a>
                        {% endif %}
                    </td>
                    {% if security.EditSessionRequirement(session).can() %}
                    <td align="right">
                        <a href="{{ url_for('glviewer.glview', db=view_son.image_store_id, view=view_son.id, edit='true') }}" class="btn btn-warning badge sa-view-edit">
                            <span class="glyphicon glyphicon-edit"></span>
                            Edit
                        </a>
                        <button type="button" class="btn btn-info badge sa-view-permalink">
                            <span class="glyphicon glyphicon-link"></span>
                            Permalink
                        </button>
                    </td>
                    {% endif %}
                </tr>
             {% endfor %}
        </table>
        {% endif %}
    </div>
</div>

<script>
    $(document).ready(function(){
        // Save the session in localStorage (needed for previous / next slide.
        var views = {{ session_son.views|map(attribute='id')|tojson|safe }};
        localStorage.session = JSON.stringify(views);
        localStorage.sessionId = "{{ session_son.id }}";
    });
</script>

{% endblock %}
