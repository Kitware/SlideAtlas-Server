{% extends 'frontend_base.html' %}
{% set active_page = 'sessions' %}

{% set is_session_admin = security.AdminSessionRequirement(session).can() %}


{% block styles %}
{{ super() }}
    {% if is_session_admin %}
    <style>
        /* file upload progress bar */
        .bar {
            height: 18px;
            background: green;
        }
    </style>
    {% endif %}
{% endblock styles %}


{% block scripts %}
{{ super() }}
    <script src="/static/thirdparty/bootbox/4.2.0/bootbox.min.js"></script>

    <!-- jQuery File Upload -->
    <script src="/static/thirdparty/jquery-fileupload/9.5.7/js/vendor/jquery.ui.widget.js"></script>
    <script src="/static/thirdparty/jquery-fileupload/9.5.7/js/jquery.iframe-transport.js"></script>
    <script src="/static/thirdparty/jquery-fileupload/9.5.7/js/jquery.fileupload.js"></script>

    <script src="/static/js/attachments.js"></script>

    {% if is_session_admin %}
    <script>
        $( function () {
            $(".sa-attachment-delete").click(function() {
                var attachmentItem = $(this).parent();
                var attachmentGet = $(this).siblings(".sa-attachment-get");
                var attachmentUrl = attachmentGet.attr("href");
                var attachmentName = attachmentGet.text();
                confirmAttachmentDelete(attachmentUrl, attachmentName, function() {
                    attachmentItem.remove();
                });
            });
            $(".sa-attachment-post").click(function() {
                var attachmentPostUrl = "{{ url_for('apiv2.session_attachment_list', session=session )}}";
                attachmentUpload(attachmentPostUrl);
            });
            $(".sa-view-permalink").click(function() {
                var viewId = $(this).data("viewid");
                var viewUrl = $(this).data("url");
                var viewName = $(this).parent().parent().find(".sa-view-get").text();
                getPermalink(viewName, viewId, viewUrl);
            });
        });
    </script>
    {% endif %}
    <script>
        $(document).ready(function(){
            // Save the session in localStorage (needed for previous / next slide.
            var views = {{ session_son.views|map(attribute='id')|tojson|safe }};
            localStorage.session = JSON.stringify(views);
            localStorage.sessionId = "{{ session_son.id }}";
        });
    </script>
{% endblock scripts %}


{% block content %}
{{ super() }}
    <div class="container">
        <div class="row">
            <h1>{{ session_son.label }}</h1>
            {%if session_son.attachments or is_session_admin %}
            <h2>Attachments{% if is_session_admin %}<button class="btn btn-primary pull-right sa-attachment-post"><span class="glyphicon glyphicon-upload"></span> Upload</button>{% endif %}</h2>
            <ul class="list-group">
                {% for attachment_son in session_son.attachments %}
                <li class="list-group-item">
                    <a href="{{ url_for('apiv2.session_attachment_item', session=session, attachment_id=attachment_son.id) }}" class="lead sa-attachment-get">{{ attachment_son.name }}</a>
                    {% if is_session_admin %}
                    <button type="button" class="btn btn-danger badge sa-attachment-delete"><span class="glyphicon glyphicon-remove"></span>Delete</button>
                    {% endif %}
                </li>
                 {% endfor %}
            </ul>
            {% endif %}
            <br>
            {% if session_son.views %}
            <h2>{{ session_son.views|length }} Images
                {% if security.EditSessionRequirement(session).can() %}
                <a href="{{ url_for('.session_new_stack', session=session) }}" class="lead">
                    <button class="btn btn-primary pull-right">
                        <span class="glyphicon glyphicon-plus"></span>
                        Stack
                    </button>
                </a>
                {% endif %}
            </h2>

            <table class="table table-bordered table-hover" >
                {% for view_son in session_son.views %}
                {% set viewer_view_url = url_for('glviewer.glview', db=view_son.image_store_id, view=view_son.id) %}
                {% set viewer_edit_url = url_for('glviewer.glview', db=view_son.image_store_id, view=view_son.id, edit='true') %}
                {% set viewer_url = viewer_edit_url if security.EditSessionRequirement(session).can() else viewer_view_url %}
                <tr>
                    <td>
                        <a href="{{ viewer_url }}">
                            <img src="{{ url_for('tile.thumb_query', db=view_son.image_store_id, img=view_son.image_id) }}" width=100px>
                        </a>
                    </td>
                    <td>
                        <a href="{{ viewer_url }}" class="lead sa-view-get">{{ view_son.label }}</a>
                    </td>
                    {% if security.EditSessionRequirement(session).can() %}
                    <td align="right">
                        {# TODO: permalink should redirect to viewer_edit_url if another admin follows it #}
                        <button type="button" class="btn btn-info badge sa-view-permalink" data-url="{{ viewer_view_url }}" data-viewid="{{ view_son.id }}">
                            <span class="glyphicon glyphicon-link"></span>
                            Permalink
                        </button>
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
            </table>
            {% endif %}
        </div>
    </div>
{% endblock content %}
