(function(){"use strict";function e(e,t){var n=this;SAM.DebugLayer=this,this.AnnotationView=new SA.View(e),this.AnnotationView.CanvasDiv.css({"z-index":"100"}),this.AnnotationView.Canvas.saOnResize(function(){n.UpdateCanvasSize()}),this.AnnotationView.InitializeViewport([0,0,100,100]),this.AnnotationView.Camera=t,this.WidgetList=[],this.ActiveWidget=null,this.Visibility=!0,this.ScaleWidget=new SAM.ScaleWidget(this,!1);var n=this,r=this.AnnotationView.CanvasDiv;r.on("mousedown.viewer",function(e){return n.HandleMouseDown(e)}),r.on("mousemove.viewer",function(e){return this.focus(),saFirefoxWhich(e),n.HandleMouseMove(e)}),$(document.body).on("mouseup.viewer",function(e){return n.HandleMouseUp(e),!0}),r.on("wheel.viewer",function(e){return n.HandleMouseWheel(e.originalEvent)}),r.on("touchstart.viewer",function(e){return n.HandleTouchStart(e.originalEvent)}),r.on("touchmove.viewer",function(e){return n.HandleTouchMove(e.originalEvent)}),r.on("touchend.viewer",function(e){return n.HandleTouchEnd(e.originalEvent),!0}),this.AnnotationView.CanvasDiv.attr("tabindex","1"),r.on("keydown.viewer",function(e){return n.HandleKeyDown(e)})}window.SAM=window.SAM||{},window.SAM.ImagePathUrl="/webgl-viewer/static/",SAM.ConvertColor=function(e){if(typeof e=="string"&&e[0]!="#"){var t={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4","indianred ":"#cd5c5c","indigo ":"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgrey:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370d8",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#d87093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"};typeof t[e.toLowerCase()]!="undefined"?e=t[e.toLowerCase()]:alert("Unknown color "+e)}if(typeof e=="string"&&e.length==7&&e[0]=="#"){var n=[],r=1;for(var i=0;i<3;++i){var s=(16*SAM.HexDigitToInt(e[r++])+SAM.HexDigitToInt(e[r++]))/255;n.push(s)}return n}return e},SAM.ConvertColorToHex=function(e){if(typeof e=="string"){e=SAM.ConvertColorNameToHex(e);if(e.substring(0,1)=="#")return e;e.substring(0,3)=="rgb"&&(i=e.substring(4,e.length-1).split(","),e=[parseInt(i[0])/255,parseInt(i[1])/255,parseInt(i[2])/255])}var t="0123456789abcdef",n="#";for(var r=0;r<3;++r){var i=e[r];for(var s=0;s<2;++s){i*=16;var o=Math.floor(i);o<0&&(o=0),o>15&&(o=15),i-=o,n+=t.charAt(o)}}return n},SAM.HexDigitToInt=function(e){return e=="1"?1:e=="2"?2:e=="3"?3:e=="4"?4:e=="5"?5:e=="6"?6:e=="7"?7:e=="8"?8:e=="9"?9:e=="a"||e=="A"?10:e=="b"||e=="B"?11:e=="c"||e=="C"?12:e=="d"||e=="D"?13:e=="e"||e=="E"?14:e=="f"||e=="F"?15:0},SAM.ConvertColorNameToHex=function(e){if(typeof e=="string"&&e[0]!="#"){var t={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4",indianred:"#cd5c5c","indigo ":"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgrey:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370d8",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#d87093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"};e=e.toLowerCase(),typeof t[e]!="undefined"&&(e=t[e])}return e},window.SAM.DistanceToString=function(e){var t="";return e<.001?t+=(e*1e6).toFixed(2)+" µm":e<.01?t+=(e*1e3).toFixed(2)+" mm":e<1?t+=(e*100).toFixed(2)+" cm":e<1e3?t+=e.toFixed(2)+" m":t+=e.toFixed(2)+" km",t},window.SAM.StringToDistance=function(e){var t=0;e=e.trim();var n=e.length;return e.substring(n-2,n)=="µm"?t=parseFloat(e.substring(0,n-2))/1e6:e.substring(n-2,n)=="mm"?t=parseFloat(e.substring(0,n-2))/1e3:e.substring(n-2,n)=="cm"?t=parseFloat(e.substring(0,n-2))/100:e.substring(n-2,n)==" m"?t=parseFloat(e.substring(0,n-2)):e.substring(n-2,n)=="km"&&(t=parseFloat(e.substring(0,n-2))*1e3),t},SAM.ConvertToMeters=function(e){return e.units.toLowerCase()=="nm"?(e.units="m",e.value*=1e-9):e.units.toLowerCase()=="µm"?(e.units="m",e.value*=1e-6):e.units.toLowerCase()=="mm"?(e.units="m",e.value*=.001):e.units.toLowerCase()=="cm"?(e.units="m",e.value*=.01):e.units.toLowerCase()=="dm"?(e.units="m",e.value*=.1):e.units.toLowerCase()=="m"?(e.units="m",e.value):e.units.toLowerCase()=="km"?(e.units="m",e.value*=1e3):(console.log("Unknown units: "+units),e.value)},SAM.ConvertForGui=function(e){this.ConvertToMeters(e);if(e.value>1e3){e.value=e.value/1e3,e.units="km";return}if(e.value>1){e.value=e.value,e.units="m";return}if(e.value>.01){e.value=e.value*100,e.units="cm";return}if(e.value>.001){e.value=e.value*1e3,e.units="mm";return}if(e.value>1e-7){e.value=e.value*1e6,e.units="µm";return}e.value=e.value*1e9,e.units="nm"},e.prototype.Delete=function(){this.AnnotationView.Delete()},e.prototype.GetVisibility=function(){return this.Visibility},e.prototype.SetVisibility=function(e){this.Visibility=e,this.EventuallyDraw()},e.prototype.GetCamera=function(){return this.AnnotationView.GetCamera()},e.prototype.GetViewport=function(){return this.AnnotationView.Viewport},e.prototype.UpdateCanvasSize=function(){this.AnnotationView.UpdateCanvasSize()},e.prototype.Clear=function(){this.AnnotationView.Clear()},e.prototype.GetCanvasDiv=function(){return this.AnnotationView.CanvasDiv},e.prototype.GetPixelsPerUnit=function(){return this.AnnotationView.GetPixelsPerUnit()},e.prototype.Draw=function(e){e=e||this.AnnotationView,e.Clear();if(!this.Visibility)return;for(var t=0;t<this.WidgetList.length;++t)this.WidgetList[t].Draw(e,2);this.ScaleWidget&&this.ScaleWidget.Draw(e)},e.prototype.EventuallyDraw=function(){if(!this.RenderPending){this.RenderPending=!0;var e=this;requestAnimFrame(function(){e.RenderPending=!1,e.Draw()})}},e.prototype.LoadWidget=function(e){var t;switch(e.type){case"lasso":t=new SAM.LassoWidget(this,!1);break;case"pencil":t=new SAM.PencilWidget(this,!1);break;case"text":t=new SAM.TextWidget(this,"");break;case"circle":t=new SAM.CircleWidget(this,!1);break;case"polyline":t=new SAM.PolylineWidget(this,!1);break;case"stack_section":t=new SAM.StackSectionWidget(this);break;case"sections":t=new SAM.SectionsWidget(this);break;case"rect":t=new SAM.RectWidget(this,!1);break;case"grid":t=new SAM.GridWidget(this,!1)}return t.Load(e),t.Type=="sections"&&t.IsEmpty()?undefined:t},e.prototype.ActivateWidget=function(e){if(this.ActiveWidget==e)return;for(var t=0;t<this.WidgetList.length;++t)this.WidgetList[t].Popup&&this.WidgetList[t].Popup.Hide();this.ActiveWidget=e,e.SetActive(!0)},e.prototype.DeactivateWidget=function(e){if(this.ActiveWidget!=e||e==null)return;this.GetCanvasDiv().css({cursor:"default"}),this.EventuallyDraw(),this.ActiveWidget=null,e.SetActive(!1)},e.prototype.GetActiveWidget=function(){return this.ActiveWidget},e.prototype.Reset=function(){this.WidgetList=[]},e.prototype.ComputeMouseWorld=function(e){return this.MouseWorld=this.GetCamera().ConvertPointViewerToWorld(e.offsetX,e.offsetY),e.worldX=this.MouseWorld[0],e.worldY=this.MouseWorld[1],this.MouseWorld},e.prototype.HandleTouchStart=function(e){if(!this.GetVisibility())return!0;if(this.Visibility)for(var t=0;t<this.Touches.length;++t){this.MouseX=this.Touches[t][0],this.MouseY=this.Touches[t][1],this.ComputeMouseWorld(e);for(var n=0;n<this.WidgetList.length;++n)if(!this.WidgetList[n].GetActive()&&this.WidgetList[n].CheckActive(e))return this.ActivateWidget(this.WidgetList[n]),!0}for(var t=0;t<e.Touches.length;++t)for(var n=0;n<this.WidgetList.length;++n)if(!this.WidgetList[n].GetActive()&&this.WidgetList[n].CheckActive(e))return this.ActivateWidget(this.WidgetList[n]),!0},e.prototype.HandleTouchPan=function(e){return this.GetVisibility()?this.ActiveWidget&&this.ActiveWidget.HandleTouchPan?this.ActiveWidget.HandleTouchPan(e):!this.ActiveWidget:!0},e.prototype.HandleTouchPinch=function(e){return this.GetVisibility()?this.ActiveWidget&&this.ActiveWidget.HandleTouchPinch?this.ActiveWidget.HandleTouchPinch(e):!this.ActiveWidget:!0},e.prototype.HandleTouchEnd=function(e){return this.GetVisibility()?this.ActiveWidget&&this.ActiveWidget.HandleTouchEnd?this.ActiveWidget.HandleTouchEnd(e):!this.ActiveWidget:!0},e.prototype.HandleMouseDown=function(e){if(!this.GetVisibility())return!0;var t=(new Date).getTime();return this.LastMouseDownTime&&t-this.LastMouseDownTime<200?(delete this.LastMouseDownTime,this.HandleDoubleClick(e)):(this.LastMouseDownTime=t,this.ActiveWidget&&this.ActiveWidget.HandleMouseDown?this.ActiveWidget.HandleMouseDown(e):!this.ActiveWidget)},e.prototype.HandleDoubleClick=function(e){return this.GetVisibility()?this.ActiveWidget&&this.ActiveWidget.HandleDoubleClick?this.ActiveWidget.HandleDoubleClick(e):!this.ActiveWidget:!0},e.prototype.HandleMouseUp=function(e){return this.GetVisibility()?this.ActiveWidget&&this.ActiveWidget.HandleMouseUp?this.ActiveWidget.HandleMouseUp(e):!this.ActiveWidget:!0},e.prototype.HandleMouseMove=function(e){if(!this.GetVisibility())return!0;if($(e.target).width()!=$(e.currentTarget).width())return!0;this.ComputeMouseWorld(e),e.which=e.buttons,e.which==2?e.which=3:e.which==3&&(e.which=2);if(this.ActiveWidget){if(this.ActiveWidget.HandleMouseMove){var t=this.ActiveWidget.HandleMouseMove(e);return t}}else if(!e.which)return this.CheckActive(e),!0;return!this.ActiveWidget},e.prototype.HandleMouseWheel=function(e){return this.GetVisibility()?this.ActiveWidget&&this.ActiveWidget.HandleMouseWheel?this.ActiveWidget.HandleMouseWheel(e):!this.ActiveWidget:!0},e.prototype.HandleKeyDown=function(e){return this.GetVisibility()?this.ActiveWidget&&this.ActiveWidget.HandleKeyDown?this.ActiveWidget.HandleKeyDown(e):!this.ActiveWidget:!0},e.prototype.CheckActive=function(e){if(!this.GetVisibility())return!0;if(this.ActiveWidget)return this.ActiveWidget.CheckActive(e);for(var t=0;t<this.WidgetList.length;++t)if(this.WidgetList[t].CheckActive(e))return this.ActivateWidget(this.WidgetList[t]),!0;return!1},e.prototype.GetNumberOfWidgets=function(){return this.WidgetList.length},e.prototype.GetWidget=function(e){return this.WidgetList[e]},e.prototype.GetWidgets=function(){return this.WidgetList},e.prototype.AddWidget=function(e){e.Layer=this,this.WidgetList.push(e),SAM.NotesWidget&&SAM.NotesWidget.MarkAsModified()},e.prototype.RemoveWidget=function(e){if(e.Layer==null)return;e.Layer=null;var t=this.WidgetList.indexOf(e);t!=-1&&this.WidgetList.splice(t,1),SAM.NotesWidget&&SAM.NotesWidget.MarkAsModified()},e.prototype.LoadGirderItem=function(e){var t="564e42fe3f24e538e9a20eb9",n={itemId:t,limit:50,offset:0,sort:"lowerName",sortdir:1};girder.restRequest({type:"get",url:"annotation",data:JSON.stringify(n),success:function(e,t){console.log("success")},error:function(){alert("AJAX - error() : annotation get")}});var r="572be29d3f24e53573aa8e91";girder.restRequest({path:"annotation/"+r,method:"GET",contentType:"application/json"}).done(function(e){console.log("done")})},e.prototype.SaveGirderItem=function(e){var t="572be29d3f24e53573aa8e91";data={name:"Test3",elements:[{type:"circle",lineColor:"#FFFF00",lineWidth:20,center:[5e3,5e3,0],radius:2e3}]},girder.restRequest({type:"post",url:"annotation",data:JSON.stringify(data),success:function(e,t){console.log("success")},error:function(){alert("AJAX - error() : annotation get")}}),data={name:"Test",elements:[{type:"polyline",points:[[6500,6600,0],[3300,5600,0],[10600,500,6]],closed:!0,fillColor:"rgba(0, 255, 0, 1)"}]},girder.restRequest({type:"put",url:"annotation/"+t,data:JSON.stringify(data),success:function(e,t){console.log("success2")},error:function(){alert("AJAX - error() : annotation get")}})},e.prototype.UpdateSize=function(){this.AnnotationView&&this.AnnotationView.UpdateCanvasSize()&&this.EventuallyDraw()},SAM.AnnotationLayer=e})();(function(){"use strict";function e(){this.Orientation=0,this.PositionCoordinateSystem=e.SLIDE,this.Origin=[1e4,1e4],this.FixedSize=!0,this.FixedOrientation=!0,this.LineWidth=0,this.Visibility=!0,this.Active=!1,this.ActiveColor=[1,1,0],this.ZOffset=.1}e.SLIDE=0,e.VIEWER=1,e.prototype.destructor=function(){},e.prototype.Draw=function(t){if(!this.Visibility)return;this.Matrix==undefined&&this.UpdateBuffers();if(GL){var n=mat4.create();mat4.identity(n);if(this.FixedSize){var r=t.Camera.ZRange[0]+.01;n[0]=2/t.Viewport[2],n[12]=-1,n[5]=-2/t.Viewport[3],n[13]=1,n[14]=r}var i=this.Orientation*3.1415926536/180;this.Matrix[0]=Math.cos(i),this.Matrix[1]=-Math.sin(i),this.Matrix[4]=Math.sin(i),this.Matrix[5]=Math.cos(i),o=this.Origin[0],u=this.Origin[1];if(this.FixedSize){var s=t.Camera.Matrix,o=(this.Origin[0]*s[0]+this.Origin[1]*s[4]+s[12])/s[15],u=(this.Origin[0]*s[1]+this.Origin[1]*s[5]+s[13])/s[15];o=t.Viewport[2]*.5*(1+o),u=t.Viewport[3]*.5*(1-u)}this.Matrix[12]=o,this.Matrix[13]=u,this.Matrix[14]=this.ZOffset;var a=polyProgram;GL.useProgram(a),GL.disable(GL.BLEND),GL.enable(GL.DEPTH_TEST),GL.bindBuffer(GL.ARRAY_BUFFER,this.VertexPositionBuffer),GL.vertexAttribPointer(a.vertexPositionAttribute,this.VertexPositionBuffer.itemSize,GL.FLOAT,!1,0,0),GL.viewport(t.Viewport[0],t.Viewport[1],t.Viewport[2],t.Viewport[3]),GL.uniformMatrix4fv(a.mvMatrixUniform,!1,this.Matrix),this.FixedSize?GL.uniformMatrix4fv(a.pMatrixUniform,!1,n):GL.uniformMatrix4fv(a.pMatrixUniform,!1,t.Camera.Matrix),this.FillColor!=undefined&&(this.Active?GL.uniform3f(a.colorUniform,this.ActiveColor[0],this.ActiveColor[1],this.ActiveColor[2]):GL.uniform3f(a.colorUniform,this.FillColor[0],this.FillColor[1],this.FillColor[2]),GL.bindBuffer(GL.ELEMENT_ARRAY_BUFFER,this.CellBuffer),GL.drawElements(GL.TRIANGLES,this.CellBuffer.numItems,GL.UNSIGNED_SHORT,0)),this.OutlineColor!=undefined&&(this.Active?GL.uniform3f(a.colorUniform,this.ActiveColor[0],this.ActiveColor[1],this.ActiveColor[2]):GL.uniform3f(a.colorUniform,this.OutlineColor[0],this.OutlineColor[1],this.OutlineColor[2]),this.LineWidth==0?this.WireFrame?(GL.bindBuffer(GL.ELEMENT_ARRAY_BUFFER,this.CellBuffer),GL.drawElements(GL.LINE_LOOP,this.CellBuffer.numItems,GL.UNSIGNED_SHORT,0)):GL.drawArrays(GL.LINE_STRIP,0,this.VertexPositionBuffer.numItems):(GL.bindBuffer(GL.ELEMENT_ARRAY_BUFFER,this.LineCellBuffer),GL.drawElements(GL.TRIANGLES,this.LineCellBuffer.numItems,GL.UNSIGNED_SHORT,0)))}else{t.Context2d.save(),t.Context2d.setTransform(1,0,0,1,0,0);if(this.PositionCoordinateSystem==e.SLIDE){var i=this.Orientation*3.1415926536/180;this.FixedSize||(i-=t.Camera.Roll),this.Matrix[0]=Math.cos(i),this.Matrix[1]=-Math.sin(i),this.Matrix[4]=Math.sin(i),this.Matrix[5]=Math.cos(i),o=this.Origin[0],u=this.Origin[1];var f=1;this.FixedSize||(f=t.Viewport[3]/t.Camera.GetHeight());var s=t.Camera.Matrix,o=(this.Origin[0]*s[0]+this.Origin[1]*s[4]+s[12])/s[15],u=(this.Origin[0]*s[1]+this.Origin[1]*s[5]+s[13])/s[15];o=t.Viewport[2]*.5*(1+o),u=t.Viewport[3]*.5*(1-u),t.Context2d.transform(this.Matrix[0],this.Matrix[1],this.Matrix[4],this.Matrix[5],o,u)}else if(this.PositionCoordinateSystem==e.VIEWER){var i=this.Orientation*3.1415926536/180;this.Matrix[0]=Math.cos(i),this.Matrix[1]=-Math.sin(i),this.Matrix[4]=Math.sin(i),this.Matrix[5]=Math.cos(i),o=this.Origin[0],u=this.Origin[1];var f=1;t.Context2d.transform(this.Matrix[0],this.Matrix[1],this.Matrix[4],this.Matrix[5],o,u)}var l=this.PointBuffer[0],c=this.PointBuffer[1];t.Context2d.beginPath(),t.Context2d.moveTo(l*f,c*f);var h=3;while(h<this.PointBuffer.length){var p=this.PointBuffer[h],d=this.PointBuffer[h+1];t.Context2d.lineTo(p*f,d*f),h+=3}if(this.OutlineColor!=undefined){var v=this.LineWidth*f;v==0&&(v=1),t.Context2d.lineWidth=v,this.Active?t.Context2d.strokeStyle=SAM.ConvertColorToHex(this.ActiveColor):t.Context2d.strokeStyle=SAM.ConvertColorToHex(this.OutlineColor),t.Context2d.stroke()}this.FillColor!=undefined&&(this.Active?t.Context2d.fillStyle=SAM.ConvertColorToHex(this.ActiveColor):t.Context2d.fillStyle=SAM.ConvertColorToHex(this.FillColor),t.Context2d.fill()),t.Context2d.restore()}},e.prototype.ChooseOutlineColor=function(){this.FillColor&&(this.OutlineColor=[1-this.FillColor[0],1-this.FillColor[1],1-this.FillColor[2]])},e.prototype.SetOutlineColor=function(e){this.OutlineColor=SAM.ConvertColor(e)},e.prototype.SetFillColor=function(e){this.FillColor=SAM.ConvertColor(e)},e.prototype.HandleMouseMove=function(e,t,n){return!1},e.prototype.IntersectPointLine=function(e,t,n,r){var i=e[0]-t[0],s=e[1]-t[1],o=n[0]-t[0],u=n[1]-t[1],a=Math.sqrt(o*o+u*u);o/=a,u=-u/a;var f=i*o-s*u,l=i*u+s*o;return Math.abs(l)>r||f<0||f>a?undefined:f/a},SAM.Shape=e})();(function(){"use strict";function e(){this.Shapes=[],this.Bounds=[0,-1,0,-1]}e.prototype.GetBounds=function(){return this.Bounds},e.prototype.ContainedInBounds=function(e){if(this.Shapes.length==0)return 0;var t=this.Shapes[0].ContainedInBounds(e);for(var n=1;n<this.Shapes.length;++n){if(t==1)return t;var r=this.Shapes[n].ContainedInBounds(e);t==0&&r!=0&&(t=1),t==2&&r!=2&&(t=1)}return t},e.prototype.PointOnShape=function(e,t){for(var n=0;n<this.Shapes.length;++n)if(this.Shapes[n].PointOnShape(e,t))return!0;return!1},e.prototype.UpdateBuffers=function(){for(var e=0;e<this.Shapes.length;++e)this.Shapes.UpdateBuffers()},e.prototype.FindPopupPoint=function(e){if(this.Shapes.length==0)return;var t=e.Roll,n=Math.sin(t+Math.PI*.25),r=Math.cos(t+Math.PI*.25),i=this.Shapes[0].FindPopupPoint(e),s=r*i[0]-n*i[1];for(var o=1;o<this.Shapes.length;++o){var u=this.Shapes[o].FindPopupPoint(e),a=r*u[0]-n*u[1];a>s&&(s=a,i=u)}return i},e.prototype.Draw=function(e){for(var t=0;t<this.Shapes.length;++t)this.Shapes[t].Draw(e)},e.prototype.AddShape=function(e){this.Shapes.push(e)},e.prototype.GetNumberOfShapes=function(){return this.Shapes.length},e.prototype.GetShape=function(e){return this.Shapes[e]},e.prototype.SetActive=function(e){for(var t=0;t<this.Shapes.length;++t)this.Shapes[t].SetActive(e)},e.prototype.SetLineWidth=function(e){for(var t=0;t<this.Shapes.length;++t)this.Shapes[t].LineWidth=e},e.prototype.GetLineWidth=function(){return this.Shapes.length!=0?this.Shapes[0].GetLineWidth():0},e.prototype.SetOutlineColor=function(e){for(var t=0;t<this.Shapes.length;++t)this.Shapes[t].OutlineColor=e},e.prototype.GetOutlineColor=function(){return this.Shapes.length!=0?this.Shapes[0].OutlineColor:[0,0,0]},e.prototype.SetOrigin=function(e){for(var t=0;t<this.Shapes.length;++t)this.Shapes[t].SetOrigin(e)},e.prototype.ResetOrigin=function(){for(var e=0;e<this.Shapes.length;++e)this.Shapes[e].ResetOrigin()},e.prototype.GetOrigin=function(){return this.Shapes.length!=0?this.Shapes[0].Origin:[0,0,0]},e.prototype.UpdateBuffers=function(){for(var e=0;e<this.Shapes.length;++e)this.Shapes[e].UpdateBuffers()},SAM.ShapeGroup=e})();(function(){"use strict";function e(e){var t=this;this.Thumb=null,this.Active=!1,this.Color=[0,1,0],this.Shapes=[],this.Bounds=null,e&&(this.Viewer=e,this.Viewer.AddWidget(this))}e.prototype.IsEmpty=function(){return this.Shapes.length==0},e.prototype.Union=function(e){for(var t=0;t<e.Shapes.length;++t)this.Shapes.push(e.Shapes[t]);this.Bounds=null},e.prototype.ContainedInBounds=function(e){var t=this.GetBounds();if(t[0]>e[0]&&t[1]<e[1]&&t[2]>e[2]&&t[3]<e[3])return 2;if(t[1]<e[0]||t[0]>e[1]||t[3]<e[2]||t[2]>e[3])return 0;var n=!1,r=!1;for(var i=0;i<this.Shapes.length;++i){var s=this.Shapes[i].ContainedInBounds(e);if(s==1)return 1;s==0&&(r=!0),s==2&&(n=!0);if(n&&r)return 1}return n?2:0},e.prototype.GetViewCenter=function(e){var t=this.GetBounds();return e.Camera.ConvertPointWorldToViewer((t[0]+t[1])*.5,(t[2]+t[3])*.5)},e.prototype.GetViewBounds=function(e){if(this.Shapes.length==0)return[0,0,0,0];var t=this.GetViewCenter(e),n=[t[0],t[0],t[1],t[1]];for(var r=0;r<this.Shapes.length;++r){var i=this.Shapes[r];for(j=0;j<i.Points.length;++j){var s=i.Points[j];s=e.Camera.ConvertPointWorldToViewer(s[0],s[1]),s[0]<n[0]&&(n[0]=s[0]),s[0]>n[1]&&(n[1]=s[0]),s[1]<n[2]&&(n[2]=s[1]),s[1]>n[3]&&(n[3]=s[1])}}return n},e.prototype.ComputeViewUpperRight=function(e){var t=this.GetBounds(),n=e.Camera.ConvertPointWorldToViewer(t[0],t[2]),r=e.Camera.ConvertPointWorldToViewer(t[0],t[3]),i=e.Camera.ConvertPointWorldToViewer(t[1],t[3]),s=e.Camera.ConvertPointWorldToViewer(t[1],t[2]);this.ViewUpperRight=n;var o=n[0]-n[1],u=r[0]-r[1];u>o&&(o=u,this.ViewUpperRight=r),u=i[0]-i[1],u>o&&(o=u,this.ViewUpperRight=i),u=s[0]-s[1],u>o&&(o=u,this.ViewUpperRight=s)},e.prototype.Draw=function(e){this.ComputeViewUpperRight(e);for(var t=0;t<this.Shapes.length;++t)this.Active?this.Shapes[t].OutlineColor=[1,1,0]:this.Shapes[t].OutlineColor=this.Color,this.Shapes[t].Draw(e)},e.prototype.Serialize=function(){if(this.Thumb)return null;var e=new Object;e.type="stack_section",e.color=this.Color,e.shapes=[];for(var t=0;t<this.Shapes.length;++t){var n=this.Shapes[t],r={closedloop:n.Closed,points:[]};for(var i=0;i<n.Points.length;++i)r.points.push([n.Points[i][0],n.Points[i][1]]);e.shapes.push(r)}return e},e.prototype.Load=function(e){e.color&&(this.Color[0]=parseFloat(e.color[0]),this.Color[1]=parseFloat(e.color[1]),this.Color[2]=parseFloat(e.color[2]));if(!e.shapes)return;for(var t=0;t<e.shapes.length;t++){var n=e.shapes[t];if(n.points){var r=n.points,i=new Polyline;i.OutlineColor=this.Color,i.FixedSize=!1,i.LineWidth=0,n.closedloop&&(i.Closed=n.closedloop),this.Shapes.push(i);for(var s=0;s<r.length;++s)i.Points[s]=[r[s][0],r[s][1]];i.UpdateBuffers()}}},e.prototype.GetCenter=function(){var e=this.GetBounds();return[(e[0]+e[1])*.5,(e[2]+e[3])*.5]},e.prototype.GetBounds=function(){if(this.Thumb){var e=this.Thumb.Height*this.Thumb.ScreenPixelSpacing/4,t=this.ThumbX,n=this.ThumbY;return[t-e,t+e,n-e,n+e]}if(this.Shapes.length==0)return this.Bounds;if(!this.Bounds){this.Bounds=this.Shapes[0].GetBounds();for(var r=1;r<this.Shapes.length;++r){var i=this.Shapes[r].GetBounds();i[0]<this.Bounds[0]&&(this.Bounds[0]=i[0]),i[1]>this.Bounds[1]&&(this.Bounds[1]=i[1]),i[2]<this.Bounds[2]&&(this.Bounds[2]=i[2]),i[3]>this.Bounds[3]&&(this.Bounds[3]=i[3])}}return this.Bounds.slice(0)},e.prototype.Deactivate=function(){this.Viewer.DeactivateWidget(this);for(var e=0;e<this.Shapes.length;++e)this.Shapes[e].Active=!1;eventuallyRender()},e.prototype.HandleKeyPress=function(e,t){return!0},e.prototype.HandleMouseDown=function(e){return!0},e.prototype.HandleMouseUp=function(e){return!0},e.prototype.HandleDoubleClick=function(e){return!0},e.prototype.HandleMouseMove=function(e){return!0},e.prototype.CheckActive=function(e){return!1},e.prototype.GetActive=function(){return!1},e.prototype.SetActive=function(e){if(e){this.Viewer.ActivateWidget(this);for(var t=0;t<this.Shapes.length;++t)this.Shapes[t].Active=!0;eventuallyRender()}else this.Deactivate(),this.Viewer.DeactivateWidget(this)},e.prototype.RemoveFromViewer=function(){this.Viewer&&this.Viewer.RemoveWidget(this)},e.prototype.RigidAlign=function(e,t){var n=this.GetCenter(),r=e.GetCenter();t[0]=r[0]-n[0],t[1]=r[1]-n[1];if(this.Thumb||e.Thumb){t[2]=0;return}var i=this.GetBounds();i[0]+=t[0],i[1]+=t[0],i[2]+=t[1],i[3]+=t[1];var s=e.GetBounds();s[0]=Math.min(i[0],s[0]),s[1]=Math.max(i[1],s[1]),s[2]=Math.min(i[2],s[2]),s[3]=Math.max(i[3],s[3]);var o=(s[0]+s[1])*.5,u=(s[2]+s[3])*.5;s[0]=o+1.1*(i[0]-o),s[1]=o+1.1*(i[1]-o),s[2]=u+1.1*(i[2]-u),s[3]=u+1.1*(i[3]-u);var a;a=Math.sqrt((s[1]-s[0])*(s[3]-s[2])/16e4);var f=new DistanceMap(s,a);for(var l=0;l<e.Shapes.length;++l)f.AddPolyline(e.Shapes[l]);f.Update(),eventuallyRender(),this.RigidAlignWithMap(f,t)},e.prototype.RigidAlignWithMap=function(e,t){var n=this.GetCenter(),r=[0,0,0];bestTrans=null,bestDist=-1;for(a=-180;a<180;a+=30){r=[t[0],t[1],Math.PI*a/180];var i;for(o=0;o<5;++o)i=this.RigidDecentStep(r,n,e,2e5);i*=1+Math.abs(a/180);if(bestDist<0||i<bestDist)bestDist=i,bestTrans=r.slice(0)}r=bestTrans;var s=2e5;for(var o=0;o<100;++o)s=this.RigidDecentStep(r,n,e,s);t[0]=r[0],t[1]=r[1],t[2]=r[2]},e.prototype.RigidDecentStep=function(e,t,n,r){var i,s,o,u,a=Math.sin(e[2]),f=Math.cos(e[2]),l=0,c=0,h=0,p=0,d=0;for(var v=0;v<this.Shapes.length;++v){var m=this.Shapes[v];for(var g=0;g<m.Points.length;++g){var y=m.Points[g],b=y[0],w=y[1];i=b-t[0],s=w-t[1],o=f*i+a*s,u=-a*i+f*s,b=b+(o-i)+e[0],w=w+(u-s)+e[1];var E=n.GetDistance(b,w)*n.Spacing;h+=E;var S=1;r>0&&(S=Math.exp(-0.69*E*E/(r*r))),E*=S;var x=n.GetGradient(b,w),T=Math.sqrt(x[0]*x[0]+x[1]*x[1]);if(T>0){++d,x[0]=-x[0]*E/T,x[1]=-x[1]*E/T,l+=x[0],c+=x[1];var N=u*x[0]-o*x[1];p+=N/(o*o+u*u)}else var C=1}}var k=h/d;return e[0]+=l/d,e[1]+=c/d,e[2]+=p/d,k},e.prototype.Transform=function(e,t,n){this.Bounds=null;for(var r=0;r<this.Shapes.length;++r){var i=this.Shapes[r];i.Trans=null;for(var s=0;s<i.Points.length;++s){var o=i.Points[s],u=o[0],a=o[1],f=u-t[0],l=a-t[1],c=Math.sin(n),h=Math.cos(n),p=h*f+c*l,d=-c*f+h*l;o[0]=u+(p-f)+e[0],o[1]=a+(d-l)+e[1]}i.UpdateBuffers()}},e.prototype.Translate=function(e){this.Bounds=null;for(var t=0;t<this.Shapes.length;++t){var n=this.Shapes[t];for(var r=0;r<n.Points.length;++r){var i=n.Points[r];i[0]+=e[0],i[1]+=e[1]}n.UpdateBuffers()}},e.prototype.RemoveDuplicatePoints=function(e){e==undefined&&(e=0);for(var t=0;t<this.Shapes.length;++t){var n=this.Shapes[t],r=n.Points[n.Points.length-1],i=0;while(i<n.Points.length){var s=n.Points[i],o=s[0]-r[0],u=s[1]-r[1];Math.sqrt(o*o+u*u)<=e?n.Points.splice(i,1):(++i,r=s)}n.UpdateBuffers()}},e.prototype.Decimate=function(){var e=this.GetBounds(),t=(e[1]-e[0]+e[3]-e[2])/400;for(var n=0;n<this.Shapes.length;++n)this.Shapes[n].Decimate(t)},SAM.StackSectionWidget=e})();(function(){"use strict";function e(e,t){if(e==null)return;var n=e.MainView.CanvasDiv;this.Type="sections",this.Viewer=e,this.Layer=e.GetAnnotationLayer(),this.Layer.AddWidget(this);var r=this;this.Sections=[],this.Active=!1,this.Layer.EventuallyDraw(),this.Viewer.EventuallyRender(),this.ActiveSection=null,this.DragBounds=null,this.DragViewBounds=null,this.DeleteButton=$("<img>").appendTo(n).hide().css({height:"20px",position:"absolute","z-index":"5"}).attr("src",SA.ImagePathUrl+"deleteSmall.png").click(function(){r.DeleteActiveSection()}),this.Menu=$("<div>").appendTo(n).hide().css({width:"150px","background-color":"white","border-style":"solid","border-width":"1px","border-radius":"5px","border-color":"#BBB",position:"absolute","z-index":"4",padding:"0px 2px"}),$("<button>").appendTo(this.Menu).text("Horizontal Sort").css({margin:"2px 0px",width:"100%"}).mouseup(function(){r.Menu.hide(),r.Sort(0)}),$("<button>").appendTo(this.Menu).text("Vertical Sort").css({margin:"2px 0px",width:"100%"}).mouseup(function(){r.Menu.hide(),r.Sort(1)})}e.prototype.ComputeSections=function(){var e=GetImageData(this.Viewer.MainView),t=ComputeIntensityHistogram(e,!0),n=PickThreshold(t);console.log("Threshold; "+n);var r=GetHagFishContours(e,n,1e-4,.5);console.log("num contours: "+r.length);for(var i=0;i<r.length;++i)this.Sections.push(r[i].MakeStackSectionWidget());this.MergeCloseSections(0),console.log("num merge: "+this.Sections.length),this.ViewSortSections(1,-1,0,1),this.CreationCamera=this.Layer.GetCamera().Serialize()},e.prototype.GetBounds=function(){if(this.Sections.length==0)return[0,0,0,0];var e=this.Sections[0].GetBounds();for(var t=0;t<this.Sections.length;++t){var n=this.Sections[t].GetBounds();n[0]<e[0]&&(e[0]=n[0]),n[1]>e[1]&&(e[1]=n[1]),n[2]<e[2]&&(e[2]=n[2]),n[3]>e[3]&&(e[3]=n[3])}return e},e.prototype.Sort=function(e){var t=0,n=1,r=1,i=1;if(this.ActiveSection){var s=this.GetBounds(),o=this.Layer.ConvertPointWorldToViewer((s[0]+s[1])*.5,(s[0]+s[1])*.5),u=this.ActiveSection.GetViewCenter(this.Viewer.MainView);u[0]<o[0]&&(r=-1),u[1]<o[1]&&(i=-1)}if(e==1){var a=r;r=i,i=a,t=1,n=0}this.ViewSortSections(t,r,n,i)},e.prototype.ViewSortSections=function(e,t,n,r){function i(t,r){return t[(n<<1)+1]>r[n<<1]&&(t[n<<1]>r[(n<<1)+1]||t[e<<1]>r[(e<<1)+1])?!0:!1}for(var s=0;s<this.Sections.length;++s){var o=this.Sections[s];o.ViewBounds=o.GetViewBounds(this.Viewer.MainView),PermuteBounds(o.ViewBounds,e,t),PermuteBounds(o.ViewBounds,n,r)}for(var s=1;s<this.Sections.length;++s){var u=this.Sections[s-1].ViewBounds,a=-1;for(var f=s;f<this.Sections.length;++f){var l=this.Sections[f].ViewBounds;i(l,u)&&(u=l,a=f)}if(a>0){var c=this.Sections[a];this.Sections[a]=this.Sections[s-1],this.Sections[s-1]=c}}this.Layer.EventuallyDraw()},e.prototype.DeleteActiveSection=function(){if(this.ActiveSection==null)return;var e=this.ActiveSection;this.SetActiveSection(null),this.RemoveSection(e),this.IsEmpty()&&(this.RemoveFromViewer(),this.Layer.EventuallyDraw(),RecordState())},e.prototype.RemoveSection=function(e){this.ActiveSection==e&&(this.ActiveSection=null);var t=this.Sections.indexOf(e);t>-1&&this.Sections.splice(t,1)},e.prototype.SetActiveSection=function(e){if(e==this.ActiveSection)return;this.ActiveSection?(this.ActiveSection.Active=!1,this.DeleteButton.hide()):(e.Active=!0,this.DeleteButton.show()),this.ActiveSection=e,this.Layer.EventuallyDraw()},e.prototype.PlaceDeleteButton=function(e){if(e){var t=e.ViewUpperRight;this.DeleteButton.show().css({left:t[0]-10+"px",top:t[1]-10+"px"})}},e.prototype.DrawBounds=function(e,t,n,r){var i=[t[0],t[2]],s=[t[1],t[2]],o=[t[1],t[3]],u=[t[0],t[3]];n&&(i=e.Camera.ConvertPointWorldToViewer(i[0],i[1]),s=e.Camera.ConvertPointWorldToViewer(s[0],s[1]),o=e.Camera.ConvertPointWorldToViewer(o[0],o[1]),u=e.Camera.ConvertPointWorldToViewer(u[0],u[1]));var a=e.Context2d;a.save(),a.setTransform(1,0,0,1,0,0),a.beginPath(),a.strokeStyle=r,a.moveTo(i[0],i[1]),a.lineTo(s[0],s[1]),a.lineTo(o[0],o[1]),a.lineTo(u[0],u[1]),a.lineTo(i[0],i[1]),a.stroke(),a.restore()},e.prototype.Draw=function(e){if(!this.Active)return;for(var t=0;t<this.Sections.length;++t){var n=this.Sections[t];n.Draw(e);var r=n.ViewUpperRight,i=e.Context2d;i.save(),i.setTransform(1,0,0,1,0,0),i.font="20px Georgia",i.fillStyle="#00F",i.fillText((t+1).toString(),r[0]-10,r[1]+25),i.restore()}this.ActiveSection&&this.PlaceDeleteButton(this.ActiveSection);if(this.ActiveSection){var s=this.ActiveSection.GetBounds();this.DrawBounds(e,s,!0,"#FF0")}this.DragBounds&&this.DrawBounds(e,this.DragBounds,!0,"#F00")},e.prototype.Serialize=function(){var e=new Object;e.type="sections",e.sections=[];for(var t=0;t<this.Sections.length;++t){var n=this.Sections[t].Serialize();e.sections.push(n)}return e.creation_camera=this.CreationCamera,e},e.prototype.Load=function(e){for(var t=0;t<e.sections.length;t++){var n=new SAM.StackSectionWidget;n.Load(e.sections[t]),n.IsEmpty()||this.Sections.push(n)}this.CreationCamera=e.creation_camera,this.IsEmpty()&&this.RemoveFromViewer()},e.prototype.IsEmpty=function(){return this.Sections.length==0},e.prototype.HandleMouseWheel=function(e){return!0},e.prototype.HandleKeyPress=function(e,t){return e.keyCode==46?(this.DeleteActiveSection(),!1):!0},e.prototype.HandleMouseDown=function(e){return this.StartX=e.offsetX,this.StartY=e.offsetY,this.ActiveSection?(e.which==3&&this.Menu.show().css({left:e.offsetX+"px",top:e.offsetY+"px"}),!1):!0},e.prototype.HandleMouseUp=function(e){var t=e.offsetX,n=e.offsetY;return e.which==1&&(Math.abs(t-this.StartX)+Math.abs(n-this.StartY)<5||this.DragBounds&&this.ProcessBounds(this.DragBounds),this.DragBounds=null,this.Layer.EventuallyDraw()),this.Menu.hide(),!1},e.prototype.HandleDoubleClick=function(e){return!0},e.prototype.HandleMouseMove=function(e){var t=e.offsetX,n=e.offsetY;if(e.which==1){var r=this.Viewer.ConvertPointViewerToWorld(this.StartX,this.StartY),i=this.Viewer.ConvertPointViewerToWorld(t,n);return this.DragBounds=[r[0],i[0],r[1],i[1]],this.Layer.EventuallyDraw(),!1}if(e.which==0){var s=this.Viewer.ConvertPointViewerToWorld(t,n),o=null,u=-1;for(var a=0;a<this.Sections.length;++a){var f=this.Sections[a].GetBounds();if(s[0]>f[0]&&s[0]<f[1]&&s[1]>f[2]&&s[1]<f[3]){var l=(f[1]-f[0])*(f[3]-f[2]);if(o==null||l<u)o=this.Sections[a],u=l}}return this.SetActiveSection(o),!0}},e.prototype.CheckActive=function(e){return this.Active},e.prototype.GetActive=function(){return this.Active},e.prototype.SetActive=function(e){e?(this.Layer.ActivateWidget(this),this.Active=!0):(this.Layer.DeactivateWidget(this),this.Active=!1,this.DeactivateCallback&&this.DeactivateCallback()),this.Layer.EventuallyDraw()},e.prototype.Deactivate=function(){this.SetActive(!1)},e.prototype.ProcessBounds=function(e){if(e[0]>e[1]){var t=e[0];e[0]=e[1],e[1]=t}if(e[2]>e[3]){var t=e[2];e[2]=e[3],e[3]=t}var n=[],r=[];for(var i=0;i<this.Sections.length;++i){var s=this.Sections[i],o=s.ContainedInBounds(e);o==2&&n.push(s),o==1&&r.push(s)}if(n.length>1)for(var i=1;i<n.length;++i)n[0].Union(n[i]),this.RemoveSection(n[i]);if(n.length==0&&r.length==0){var u=this,a=(e[1]-e[0]+e[3]-e[2])/600;a<1&&(a=1),GetCutoutImage(this.Viewer.GetCache(),[Math.round((e[1]-e[0])/a),Math.round((e[3]-e[2])/a)],[.5*(e[0]+e[1]),.5*(e[2]+e[3])],a,0,null,function(e){var t=ComputeIntensityHistogram(e,!0),n=PickThreshold(t),r=u.GetBigContours(e,n);if(r.length==0)return;var i=new SAM.StackSectionWidget;for(var s=0;s<r.length;++s)i.Shapes.push(r[s].MakePolyline([0,1,0]));u.Sections.push(i),this.Layer.EventuallyDraw()})}if(n.length==0&&r.length==1){var s=r[0];n=[],r=[];for(var i=0;i<s.Shapes.length;++i){var f=s.Shapes[i].ContainedInBounds(e);f==1&&r.push(s.Shapes[i]),f==2&&n.push(s.Shapes[i])}if(r.length==0){var l,c=new SAM.StackSectionWidget;c.Shapes=n;for(var i=0;i<n.length;++i)l=s.Shapes.indexOf(n[i]),l!=-1&&s.Shapes.splice(l,1),s.Bounds=null;l=this.Sections.indexOf(s),this.Sections.splice(l,0,c)}}},e.prototype.GetContours=function(e,t){var n=[];for(var r=1;r<e.width;++r)for(var i=1;i<e.height;++i){var s=SeedIsoContour(e,r,i,r-1,i,t);if(s){var o=new Contour;o.Camera=e.Camera,o.Threshold=t,o.SetPoints(s),o.RemoveDuplicatePoints(2);var u=o.GetArea();n.push(o)}var a=SeedIsoContour(e,r,i,r,i-1,t);a&&(o=new Contour,o.Camera=e.Camera,o.Threshold=t,o.SetPoints(a),o.RemoveDuplicatePoints(2),u=o.GetArea(),n.push(o))}return n},e.prototype.GetBigContours=function(e,t){var n=this.GetContours(e,t),r=0;for(var i=0;i<n.length;++i)n[i].GetArea()>r&&(r=n[i].GetArea());var s=[];for(var i=0;i<n.length;++i)n[i].GetArea()>r*.5&&s.push(n[i]);return s},e.prototype.MergeCloseSections=function(e){for(var t=0;t<this.Sections.length;++t){var n=this.Sections[t];for(j=t+1;j<this.Sections.length;++j){var r=this.Sections[j],i=n.GetBounds(),s=r.GetBounds();i[1]+e>s[0]&&i[0]-e<s[1]&&i[3]+e>s[2]&&i[2]-e<s[3]&&(n.Union(r),this.Sections.splice(j,1),n,--j)}}},SAM.SectionsWidget=e})();(function(){"use strict";function e(e,t){this.Viewer=t,this.Layer=t.AnnotationLayer;var n=layer.GetCamera(),r=n.GetFocalPoint(),i=n.Height/4;this.Bounds=[r[0]-i,r[0]+i,r[1]-i,r[1]+i],this.DragBounds=[r[0]-i,r[0]+i,r[1]-i,r[1]+i],layer.AddWidget(this),eventuallyRender(),this.Active=0;var s=this;this.Div=$("<div>").appendTo(e).addClass("sa-view-cutout-div"),$("<button>").appendTo(this.Div).text("Cancel").addClass("sa-view-cutout-button").click(function(){s.Cancel()}),$("<button>").appendTo(this.Div).text("Download").addClass("sa-view-cutout-button").click(function(){s.Accept()}),this.Select=$("<select>").appendTo(this.Div),$("<option>").appendTo(this.Select).attr("value",0).text("tif"),$("<option>").appendTo(this.Select).attr("value",1).text("jpeg"),$("<option>").appendTo(this.Select).attr("value",2).text("png"),$("<option>").appendTo(this.Select).attr("value",3).text("svs"),this.Label=$("<div>").addClass("sa-view-cutout-label").appendTo(this.Div),this.UpdateBounds(),this.HandleMouseUp()}e.prototype.Accept=function(){this.Deactivate();var e=["tif","jpeg","png","svs"],t=this.Viewer.GetCache().Image;window.location="/cutout/"+t.database+"/"+t._id+"/image."+e[this.Select.val()]+"?bounds="+JSON.stringify(this.Bounds)},e.prototype.Cancel=function(){this.Deactivate()},e.prototype.Serialize=function(){return!1},e.prototype.Draw=function(e){var t=[(this.DragBounds[0]+this.DragBounds[1])*.5,(this.DragBounds[2]+this.DragBounds[3])*.5],n=e.Camera,r=e.Viewport;if(GL)alert("webGL cutout not supported");else{var i=e.Context2d,n=e.Camera;i.save(),i.setTransform(1,0,0,1,0,0),this.DrawRectangle(i,this.Bounds,n,"#00A",1,0),this.DrawRectangle(i,this.DragBounds,n,"#000",2,this.Active),this.DrawCenter(i,t,n,"#000"),i.restore()}},e.prototype.DrawRectangle=function(e,t,n,r,i,s){var o=n.ConvertPointWorldToViewer(t[0],t[2]),u=n.ConvertPointWorldToViewer(t[1],t[2]),a=n.ConvertPointWorldToViewer(t[1],t[3]),f=n.ConvertPointWorldToViewer(t[0],t[3]);e.lineWidth=i,e.beginPath(),e.strokeStyle=s&4?"#FF0":r,e.moveTo(o[0],o[1]),e.lineTo(u[0],u[1]),e.stroke(),e.beginPath(),e.strokeStyle=s&2?"#FF0":r,e.moveTo(u[0],u[1]),e.lineTo(a[0],a[1]),e.stroke(),e.beginPath(),e.strokeStyle=s&8?"#FF0":r,e.moveTo(a[0],a[1]),e.lineTo(f[0],f[1]),e.stroke(),e.beginPath(),e.strokeStyle=s&1?"#FF0":r,e.moveTo(f[0],f[1]),e.lineTo(o[0],o[1]),e.stroke()},e.prototype.DrawCenter=function(e,t,n,r){var i=n.ConvertPointWorldToViewer(t[0],t[1]);e.strokeStyle=this.Active&16?"#FF0":r,e.lineWidth=1,e.beginPath(),e.moveTo(i[0]-5,i[1]),e.lineTo(i[0]+5,i[1]),e.moveTo(i[0],i[1]-5),e.lineTo(i[0],i[1]+5),e.stroke()},e.prototype.HandleKeyPress=function(e,t){return event.keyCode==67&&alert("Accept"),event.keyCode==67&&alert("Cancel"),!0},e.prototype.HandleDoubleClick=function(e){return!0},e.prototype.HandleMouseDown=function(e){return e.which!=1?!1:!0},e.prototype.HandleMouseUp=function(){if(this.Bounds[0]>this.Bounds[1]){var e=this.Bounds[0];this.Bounds[0]=this.Bounds[1],this.Bounds[1]=e}if(this.Bounds[2]>this.Bounds[3]){var e=this.Bounds[2];this.Bounds[2]=this.Bounds[3],this.Bounds[3]=e}this.DragBounds=this.Bounds.slice(0),eventuallyRender()},e.prototype.HandleMouseMove=function(e){var t=e.offsetX,n=e.offsetY;if(e.which==0){this.CheckActive(e);return}if(this.Active){var r=this.Layer.GetCamera(),i=r.ConvertPointViewerToWorld(e.offsetX,e.offsetY);this.Active&1&&(this.DragBounds[0]=i[0]),this.Active&2&&(this.DragBounds[1]=i[0]),this.Active&4&&(this.DragBounds[2]=i[1]),this.Active&8&&(this.DragBounds[3]=i[1]);if(this.Active&16){var s=i[0]-.5*(this.DragBounds[0]+this.DragBounds[1]),o=i[1]-.5*(this.DragBounds[2]+this.DragBounds[3]);this.DragBounds[0]+=s,this.DragBounds[1]+=s,this.DragBounds[2]+=o,this.DragBounds[3]+=o}return this.UpdateBounds(),eventuallyRender(),!0}return!1},e.prototype.UpdateBounds=function(e){var t=this.Viewer.GetCache(),n=t.Image.TileSize,r=[0,0,0,0];r[0]=Math.round(this.DragBounds[0]/n)*n,r[1]=Math.round(this.DragBounds[1]/n)*n,r[2]=Math.round(this.DragBounds[2]/n)*n,r[3]=Math.round(this.DragBounds[3]/n)*n;var i=t.Image.bounds;r[0]<i[0]&&(r[0]=i[0]),r[1]<i[0]&&(r[1]=i[0]),r[2]<i[2]&&(r[2]=i[2]),r[3]<i[2]&&(r[3]=i[2]),r[0]>i[1]&&(r[0]=i[1]),r[1]>i[1]&&(r[1]=i[1]),r[2]>i[3]&&(r[2]=i[3]),r[3]>i[3]&&(r[3]=i[3]),r[0]!=r[1]&&(this.Bounds[0]=r[0],this.Bounds[1]=r[1]),r[2]!=r[3]&&(this.Bounds[2]=r[2],this.Bounds[3]=r[3]);var s=[this.Bounds[1]-this.Bounds[0],this.Bounds[3]-this.Bounds[2]];this.Label.text(s[0]+" x "+s[1]+" = "+this.FormatPixels(s[0]*s[1])+"pixels")},e.prototype.FormatPixels=function(e){return e>1e9?Math.round(e/1e9)+"G":e>1e6?Math.round(e/1e6)+"M":e>1e3?Math.round(e/1e3)+"k":e},e.prototype.HandleTouchPan=function(e){},e.prototype.HandleTouchPinch=function(e){},e.prototype.HandleTouchEnd=function(e){},e.prototype.CheckActive=function(e){var t=this.Layer.GetCamera(),n=t.Height/200,r=t.ConvertPointViewerToWorld(e.offsetX,e.offsetY),i=0,s=this.DragBounds[0]-n<r[0]&&r[0]<this.DragBounds[1]+n,o=this.DragBounds[2]-n<r[1]&&r[1]<this.DragBounds[3]+n;o&&Math.abs(r[0]-this.DragBounds[0])<n&&(i|=1),o&&Math.abs(r[0]-this.DragBounds[1])<n&&(i|=2),s&&Math.abs(r[1]-this.DragBounds[2])<n&&(i|=4),s&&Math.abs(r[1]-this.DragBounds[3])<n&&(i|=8);var u=[(this.DragBounds[0]+this.DragBounds[1])*.5,(this.DragBounds[2]+this.DragBounds[3])*.5];return n*=2,Math.abs(r[0]-u[0])<n&&Math.abs(r[1]-u[1])<n&&(i|=16),i!=this.Active&&(this.SetActive(i),eventuallyRender()),!1},e.prototype.GetActive=function(){return this.Active},e.prototype.Deactivate=function(){this.Div.remove();if(this.Layer==null)return;this.Layer.DeactivateWidget(this),this.Layer.RemoveWidget(this),eventuallyRender()},e.prototype.SetActive=function(e){if(this.Active==e)return;this.Active=e,e!=0?this.Layer.ActivateWidget(this):this.Layer.DeactivateWidget(this),eventuallyRender()},SAM.CutoutWidget=e})();(function(){"use strict";function n(e){return function(){e.HandleLoadedTexture()}}function r(){alert("Could not load font")}function i(){GL&&(this.TextureLoaded=!1,this.Texture=GL.createTexture(),this.Image=new Image,this.Image.onload=n(this),this.Image.src=SA.ImagePathUrl+"letters.gif"),this.Color=[.5,1,1],this.Size=12,this.Position=[100,100],this.Orientation=0,this.Anchor=[0,0],this.Active=!1,this.String=",./<>?[]{}|-=~!@#$%^&*()_+",this.PixelBounds=[0,0,0,0],this.BackgroundFlag=!1}function s(e,t,n,r,i,s){typeof s=="undefined"&&(s=5),e.fillStyle="#fff",e.strokeStyle="#666",e.beginPath(),e.moveTo(t+s,n),e.lineTo(t+r-s,n),e.quadraticCurveTo(t+r,n,t+r,n+s),e.lineTo(t+r,n+i-s),e.quadraticCurveTo(t+r,n+i,t+r-s,n+i),e.lineTo(t+s,n+i),e.quadraticCurveTo(t,n+i,t,n+i-s),e.lineTo(t,n+s),e.quadraticCurveTo(t,n,t+s,n),e.closePath(),e.stroke(),e.fill()}var e=1.3,t=[[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[900,17,30,98],[791,119,28,95],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[260,18,32,97],[292,18,32,97],[0,413,50,98],[0,413,50,98],[635,120,25,36],[783,17,37,57],[662,121,25,34],[687,121,46,96],[822,214,58,98],[881,214,50,98],[932,214,56,98],[0,114,53,98],[54,114,54,98],[109,114,54,98],[164,114,57,98],[222,114,49,98],[272,114,57,98],[330,114,56,98],[554,18,25,76],[579,121,28,73],[0,413,50,98],[412,120,62,69],[0,413,50,98],[733,10,53,106],[0,413,50,98],[263,314,67,98],[331,314,55,98],[387,314,59,98],[447,314,66,98],[514,314,52,98],[566,314,49,98],[616,314,67,98],[684,314,67,98],[752,314,24,98],[777,314,36,98],[814,314,58,98],[873,314,45,98],[919,314,88,98],[0,214,66,98],[69,214,72,98],[142,214,54,98],[197,214,76,98],[274,214,53,98],[328,214,49,98],[378,214,55,98],[434,214,66,98],[501,214,63,98],[565,214,96,98],[662,214,55,98],[718,214,53,98],[772,214,49,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[51,413,56,98],[108,413,50,98],[154,413,50,98],[210,413,50,98],[263,413,39,98],[301,413,50,98],[350,413,54,98],[406,413,22,98],[427,413,34,98],[458,413,50,98],[508,413,24,98],[532,413,88,98],[619,413,57,98],[675,413,60,98],[734,413,57,98],[790,413,57,98],[847,413,40,98],[886,413,42,98],[925,413,41,98],[966,413,56,98],[0,314,49,98],[50,314,77,98],[127,314,48,98],[173,314,52,98],[224,314,42,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98]];i.prototype.destructor=function(){},i.prototype.HandleLoadedTexture=function(){if(GL){var e=this.Texture;GL.pixelStorei(GL.UNPACK_FLIP_Y_WEBGL,!0),GL.bindTexture(GL.TEXTURE_2D,e),GL.texImage2D(GL.TEXTURE_2D,0,GL.RGBA,GL.RGBA,GL.UNSIGNED_BYTE,this.Image),GL.texParameteri(GL.TEXTURE_2D,GL.TEXTURE_MAG_FILTER,GL.LINEAR),GL.texParameteri(GL.TEXTURE_2D,GL.TEXTURE_MIN_FILTER,GL.LINEAR_MIPMAP_NEAREST),GL.generateMipmap(GL.TEXTURE_2D),GL.bindTexture(GL.TEXTURE_2D,null),this.TextureLoaded=!0}eventuallyRender()},i.prototype.Draw=function(t){var n=this.Position[0],r=this.Position[1];if(this.PositionCoordinateSystem!=SAM.Shape.VIEWER){var i=t.Camera.Matrix;n=(this.Position[0]*i[0]+this.Position[1]*i[4]+i[12])/i[15],r=(this.Position[0]*i[1]+this.Position[1]*i[5]+i[13])/i[15],n=t.Viewport[2]*.5*(1+n),r=t.Viewport[3]*.5*(1-r)}if(Math.abs(this.Anchor[0])>1e3||Math.abs(this.Anchor[1])>1e3)this.Anchor=[-50,0];if(GL){if(this.TextureLoaded==0)return;this.Matrix==undefined&&(this.UpdateBuffers(),this.Matrix=mat4.create(),mat4.identity(this.Matrix));var o=textProgram;GL.useProgram(o),GL.blendFunc(GL.SRC_ALPHA,GL.ONE_MINUS_SRC_ALPHA),GL.enable(GL.BLEND),GL.bindBuffer(GL.ARRAY_BUFFER,this.VertexPositionBuffer),GL.vertexAttribPointer(o.vertexPositionAttribute,this.VertexPositionBuffer.itemSize,GL.FLOAT,!1,0,0),GL.bindBuffer(GL.ARRAY_BUFFER,this.VertexTextureCoordBuffer),GL.vertexAttribPointer(o.textureCoordAttribute,this.VertexTextureCoordBuffer.itemSize,GL.FLOAT,!1,0,0),GL.bindBuffer(GL.ELEMENT_ARRAY_BUFFER,this.CellBuffer),this.Active?GL.uniform3f(o.colorUniform,1,1,0):GL.uniform3f(o.colorUniform,this.Color[0],this.Color[1],this.Color[2]),GL.viewport(t.Viewport[0],t.Viewport[1],t.Viewport[2],t.Viewport[3]);var u=t.Camera.ZRange[0]+.01,a=mat4.create();mat4.identity(a),a[0]=2/t.Viewport[2],a[12]=-1,a[5]=-2/t.Viewport[3],a[13]=1,a[14]=u,GL.uniformMatrix4fv(o.pMatrixUniform,!1,a),this.Matrix[12]=n-this.Anchor[0],this.Matrix[13]=r-this.Anchor[1],GL.uniformMatrix4fv(o.mvMatrixUniform,!1,this.Matrix),GL.activeTexture(GL.TEXTURE0),GL.bindTexture(GL.TEXTURE_2D,this.Texture),GL.uniform1i(o.samplerUniform,0),GL.drawElements(GL.TRIANGLES,this.CellBuffer.numItems,GL.UNSIGNED_SHORT,0)}else{var f=this.String.split("\n"),l=t.Context2d;l.save();var c=this.Orientation*Math.PI/180,h=Math.sin(c),p=Math.cos(c);l.setTransform(p,-h,h,p,n,r),n=-this.Anchor[0],r=-this.Anchor[1],l.font=this.Size+"pt Calibri";var d=this.PixelBounds[1],v=this.PixelBounds[3];this.BackgroundFlag&&s(l,n-2,r-2,d+6,v+2,this.Size/2,!0,!1),this.Active?l.fillStyle="#FF0":l.fillStyle=SAM.ConvertColorToHex(this.Color),r+=this.Size;for(var m=0;m<f.length;++m)l.fillText(f[m],n,r),r+=this.Size*e;l.stroke(),l.restore()}},i.prototype.UpdateBuffers=function(){if(!GL){var n=this.String.split("\n"),r=this.Size*e*n.length,i=0,s=TEXT_VIEW_HACK.Context2d;s.save(),s.setTransform(1,0,0,1,0,0),s.font=this.Size+"pt Calibri";for(var o=0;o<n.length;++o){var u=s.measureText(n[o]).width;u>i&&(i=u)}this.PixelBounds=[0,i,0,r],s.restore();return}var a=[],f=[],l=[],c=98/128,h=0,p=0,d=0;this.PixelBounds=[0,0,0,this.Size];for(var o=0;o<this.String.length;++o){var v=this.String.charCodeAt(o);if(v==10||v==13)h=0,p+=this.Size;else{var m=t[v],g=m[0]/1024,y=(m[0]+m[2])/1024,b=m[1]/512,w=(m[1]+m[3])/512,E=h+m[2]*this.Size/98,S=p+m[3]*this.Size/98;this.PixelBounds[0]>h&&(this.PixelBounds[0]=h),this.PixelBounds[1]<E&&(this.PixelBounds[1]=E),this.PixelBounds[2]>p&&(this.PixelBounds[2]=p),this.PixelBounds[3]<S&&(this.PixelBounds[3]=S),f.push(g),f.push(b),a.push(h),a.push(S),a.push(0),f.push(y),f.push(b),a.push(E),a.push(S),a.push(0),f.push(g),f.push(w),a.push(h),a.push(p),a.push(0),f.push(y),f.push(w),a.push(E),a.push(p),a.push(0),h=E,l.push(0+d),l.push(1+d),l.push(2+d),l.push(2+d),l.push(1+d),l.push(3+d),d+=4}}this.VertexTextureCoordBuffer=GL.createBuffer(),GL.bindBuffer(GL.ARRAY_BUFFER,this.VertexTextureCoordBuffer),GL.bufferData(GL.ARRAY_BUFFER,new Float32Array(f),GL.STATIC_DRAW),this.VertexTextureCoordBuffer.itemSize=2,this.VertexTextureCoordBuffer.numItems=f.length/2,this.VertexPositionBuffer=GL.createBuffer(),GL.bindBuffer(GL.ARRAY_BUFFER,this.VertexPositionBuffer),GL.bufferData(GL.ARRAY_BUFFER,new Float32Array(a),GL.STATIC_DRAW),this.VertexPositionBuffer.itemSize=3,this.VertexPositionBuffer.numItems=a.length/3,this.CellBuffer=GL.createBuffer(),GL.bindBuffer(GL.ELEMENT_ARRAY_BUFFER,this.CellBuffer),GL.bufferData(GL.ELEMENT_ARRAY_BUFFER,new Uint16Array(l),GL.STATIC_DRAW),this.CellBuffer.itemSize=1,this.CellBuffer.numItems=l.length},i.prototype.HandleMouseMove=function(e,t,n){return viewer=e.CurrentViewer,!1},i.prototype.SetColor=function(e){this.Color=SAM.ConvertColor(e)},SAM.Text=i})();(function(){"use strict";function u(n,r){e=this;if(n==null)return null;typeof r!="string"&&(r="");var i=this;this.Dialog=new SAM.Dialog(function(){i.DialogApplyCallback()}),this.Dialog.Title.text("Text Annotation Editor"),this.Dialog.Body.css({margin:"1em 2em"}),this.Dialog.TextInput=$("<textarea>").appendTo(this.Dialog.Body).css({width:"87%"}),this.Dialog.FontDiv=$("<div>").appendTo(this.Dialog.Body).css({display:"table-row"}),this.Dialog.FontLabel=$("<div>").appendTo(this.Dialog.FontDiv).text("Font (px):").css({display:"table-cell","text-align":"left"}),this.Dialog.FontInput=$('<input type="number">').appendTo(this.Dialog.FontDiv).val("12").css({display:"table-cell"}),this.Dialog.ColorDiv=$("<div>").appendTo(this.Dialog.Body).css({display:"table-row"}),this.Dialog.ColorLabel=$("<div>").appendTo(this.Dialog.ColorDiv).text("Color:").css({display:"table-cell","text-align":"left"}),this.Dialog.ColorInput=$('<input type="color">').appendTo(this.Dialog.ColorDiv).val("#30ff00").css({display:"table-cell"}),this.Dialog.VisibilityModeDiv=$("<div>").appendTo(this.Dialog.Body).css({display:"table-row"}),this.Dialog.VisibilityModeLabel=$("<div>").appendTo(this.Dialog.VisibilityModeDiv).text("Visibility:").css({display:"table-cell","text-align":"left"}),this.Dialog.VisibilityModeInputButtons=$("<div>").appendTo(this.Dialog.VisibilityModeDiv).attr("checked","false").css({display:"table-cell"}),this.Dialog.VisibilityModeInputs=[],this.Dialog.VisibilityModeInputs[0]=$('<input type="radio" name="visibilityoptions" value="0">Text only</input>').appendTo(this.Dialog.VisibilityModeInputButtons).attr("checked","false"),$("<br>").appendTo(this.Dialog.VisibilityModeInputButtons),this.Dialog.VisibilityModeInputs[1]=$('<input type="radio" name="visibilityoptions" value="1">Arrow only, text on hover</input>').appendTo(this.Dialog.VisibilityModeInputButtons).attr("checked","false"),$("<br>").appendTo(this.Dialog.VisibilityModeInputButtons),this.Dialog.VisibilityModeInputs[2]=$('<input type="radio" name="visibilityoptions" value="2">Arrow and text visible</input>').appendTo(this.Dialog.VisibilityModeInputButtons).attr("checked","true"),this.Dialog.BackgroundDiv=$("<div>").appendTo(this.Dialog.Body).css({display:"table-row"}),this.Dialog.BackgroundLabel=$("<div>").appendTo(this.Dialog.BackgroundDiv).text("Background:").css({display:"table-cell","text-align":"left"}),this.Dialog.BackgroundInput=$('<input type="checkbox">').appendTo(this.Dialog.BackgroundDiv).attr("checked","true").css({display:"table-cell"}),this.Layer=n,this.Popup=new SAM.WidgetPopup(this),this.State=t,this.CursorLocation=0;var s=this.Layer.GetCamera();this.Text=new SAM.Text,this.Text.String=r,this.Text.UpdateBuffers(),this.Text.Color=[0,0,1],this.Text.Anchor=[.5*(this.Text.PixelBounds[0]+this.Text.PixelBounds[1]),.5*(this.Text.PixelBounds[2]+this.Text.PixelBounds[3])],this.Text.Position=[s.FocalPoint[0],s.FocalPoint[1]],this.Arrow=new SAM.Arrow,this.Arrow.Origin=this.Text.Position,this.Arrow.Length=50,this.Arrow.Width=10,this.Arrow.UpdateBuffers(),this.Arrow.Visibility=!0,this.Arrow.Orientation=45,this.Arrow.FillColor=[0,0,1],this.Arrow.OutlineColor=[1,1,0],this.Arrow.ZOffset=.2,this.Arrow.UpdateBuffers(),n.AddWidget(this),this.ActiveReason=1,this.SetTextOffset(50,0),this.VisibilityMode=2,this.Text.BackgroundFlag=!0,this.Dialog.BackgroundInput.prop("checked",!0);var o=SAM.ConvertColorToHex(this.Dialog.ColorInput.val());if(localStorage.TextWidgetDefaults){var u=JSON.parse(localStorage.TextWidgetDefaults);u.Color&&(o=SAM.ConvertColorToHex(u.Color)),u.FontSize&&(this.Text.Size=parseFloat(u.FontSize)),u.BackgroundFlag!==undefined&&(this.Text.BackgroundFlag=u.BackgroundFlag),u.VisibilityMode!==undefined&&this.SetVisibilityMode(u.VisibilityMode)}this.Text.Color=o,this.Arrow.SetFillColor(o),this.Arrow.ChooseOutlineColor(),this.CreationCamera=n.GetCamera().Serialize()}var e,t=0,n=1,r=2,i=3,s=4,o=5;u.prototype.Draw=function(e,n){n!=ANNOTATION_OFF&&this.VisibilityMode!=0&&this.Arrow.Draw(e),n==ANNOTATION_ON&&(this.VisibilityMode!=1||this.State!=t?(this.Text.Draw(e),this.Text.Visibility=!0):this.Text.Visibility=!1)},u.prototype.PasteCallback=function(e,t){this.Load(e),this.Text.Position[0]=t[0],this.Text.Position[1]=t[1],this.UpdateArrow(),this.Layer.EventuallyDraw(),SAM.NotesWidget&&SAM.NotesWidget.MarkAsModified()},u.prototype.Serialize=function(){if(this.Text===undefined)return null;var e=new Object;return e.type="text",e.color=this.Text.Color,e.size=this.Text.Size,e.offset=[-this.Text.Anchor[0],-this.Text.Anchor[1]],e.position=this.Text.Position,e.string=this.Text.String,e.visibility=this.VisibilityMode,e.backgroundFlag=this.Text.BackgroundFlag,e.creation_camera=this.CreationCamera,e},u.prototype.Load=function(e){var t=e.string;if(e.string&&e.string==""){this.Layer.RemoveWidget(this);return}this.Text.String=e.string;var n=[parseFloat(e.color[0]),parseFloat(e.color[1]),parseFloat(e.color[2])];this.Text.Color=n,this.Text.Size=parseFloat(e.size),e.backgroundFlag!=undefined&&(this.Text.BackgroundFlag=e.backgroundFlag),this.Text.Position=[parseFloat(e.position[0]),parseFloat(e.position[1]),parseFloat(e.position[2])],this.Arrow.Origin=this.Text.Position,e.offset&&this.SetTextOffset(parseFloat(e.offset[0]),parseFloat(e.offset[1])),e.creation_camera!==undefined&&(this.CreationCamera=e.creation_camera),e.anchorVisibility!==undefined?e.anchorVisibility?this.SetVisibilityMode(1):this.SetVisibilityMode(0):e.visibility!==undefined&&this.SetVisibilityMode(e.visibility),this.Arrow.SetFillColor(n),this.Arrow.ChooseOutlineColor(),this.Text.UpdateBuffers(),this.UpdateArrow()},u.prototype.SetTextOffset=function(e,t){this.SavedTextAnchor=[-e,-t],this.Text.Anchor=this.SavedTextAnchor.slice(0),this.UpdateArrow()},u.prototype.SetPosition=function(e,t){this.Text.Position=[e,t],this.Arrow.Origin=this.Text.Position},u.prototype.SetVisibilityMode=function(e){if(this.VisibilityMode==e)return;this.VisibilityMode=e,e==2||e==1?(this.SavedTextAnchor==undefined&&(this.SavedTextAnchor=[-30,0]),this.Text.Anchor=this.SavedTextAnchor.slice(0),this.Arrow.Visibility=!0,this.Arrow.Origin=this.Text.Position,this.UpdateArrow()):e==0&&(this.SavedTextAnchor=this.Text.Anchor.slice(0),this.Text.UpdateBuffers(),this.Text.Anchor=[(this.Text.PixelBounds[0]+this.Text.PixelBounds[1])*.5,this.Text.PixelBounds[2]],this.Arrow.Visibility=!1),this.Layer.EventuallyDraw()},u.prototype.UpdateArrow=function(){var e=.5*(this.Text.PixelBounds[0]+this.Text.PixelBounds[1]),t=.5*(this.Text.PixelBounds[2]+this.Text.PixelBounds[3]),n=.5*(this.Text.PixelBounds[1]-this.Text.PixelBounds[0]),r=.5*(this.Text.PixelBounds[3]-this.Text.PixelBounds[2]),i=this.Text.Anchor[0]-e,s=this.Text.Anchor[1]-t;this.Arrow.Orientation=-(180+Math.atan2(s,i)*180/Math.PI);var o=Math.sqrt(i*i+s*s),u=o;if(s!=0){var a=Math.abs(o*r/s);u>a&&(u=a)}if(i!=0){var a=Math.abs(o*n/i);u>a&&(u=a)}o=o-u-5,o<5&&(o=5),this.Arrow.Length=o,this.Arrow.UpdateBuffers()},u.prototype.HandleMouseWheel=function(e){return!1},u.prototype.HandleKeyDown=function(e){if(this.State==o)return!1;if(e.keyCode==67&&e.ctrlKey){var t={Type:"TextWidget",Data:this.Serialize()};return localStorage.ClipBoard=JSON.stringify(t),!1}return!0},u.prototype.HandleDoubleClick=function(e){return this.ShowPropertiesDialog(),!1},u.prototype.HandleMouseDown=function(e){if(e.which==1){var t=e.offsetX,o=e.offsetY,u=this.Layer.GetCamera();return this.LastMouse=[t,o],this.State==n?this.State=i:this.State==r&&(this.State=s),!1}return!0},u.prototype.HandleMouseUp=function(e){if(e.which==1)return this.State==i?(this.State=n,RecordState()):this.State==s&&(this.State=r,RecordState()),!1;if(e.which==3)if(this.State==n||this.State==r)return this.State=o,this.ShowPropertiesDialog(),!1;return!0},u.prototype.ScreenPixelToTextPixelPoint=function(e,t){var n=this.Layer.GetCamera(),r=n.ConvertPointWorldToViewer(this.Text.Position[0],this.Text.Position[1]);return e=e-r[0]+this.Text.Anchor[0],t=t-r[1]+this.Text.Anchor[1],[e,t]},u.prototype.HandleMouseMove=function(e){if(this.State==i){SAM.NotesWidget&&SAM.NotesWidget.MarkAsModified();var t=this.Layer.GetCamera(),n=t.ConvertPointViewerToWorld(this.LastMouse[0],this.LastMouse[1]),r=t.ConvertPointViewerToWorld(e.offsetX,e.offsetY),u=r[0]-n[0],a=r[1]-n[1];return this.LastMouse=[e.offsetX,e.offsetY],this.Text.Position[0]+=u,this.Text.Position[1]+=a,this.Arrow.Origin=this.Text.Position,this.PlacePopup(),SAM.NotesWidget&&SAM.NotesWidget.MarkAsModified(),this.Layer.EventuallyDraw(),!1}if(this.State==s){SAM.NotesWidget&&SAM.NotesWidget.MarkAsModified();var f=e.offsetX-this.LastMouse[0],l=e.offsetY-this.LastMouse[1];return this.LastMouse=[e.offsetX,e.offsetY],this.Text.Anchor[0]-=f,this.Text.Anchor[1]-=l,this.UpdateArrow(),this.PlacePopup(),this.Layer.EventuallyDraw(),SAM.NotesWidget&&SAM.NotesWidget.MarkAsModified(),!1}return this.State!=o?this.CheckActive(e):!0},u.prototype.HandleTouchPan=function(e,t){return this.State==n?this.State=i:this.State==r&&(this.State=s),t.MouseDeltaX=t.MouseX-t.LastMouseX,t.MouseDeltaY=t.MouseY-t.LastMouseY,this.HandleMouseMove(e),!1},u.prototype.HandleTouchEnd=function(e){return this.State=n,this.SetActive(!1),!1},u.prototype.CheckActive=function(e){var t=this.ScreenPixelToTextPixelPoint(e.offsetX,e.offsetY);return this.Arrow.Visibility&&this.Arrow.PointInShape(t[0]-this.Text.Anchor[0],t[1]-this.Text.Anchor[1])?(this.Arrow.Active=!0,this.Layer.EventuallyDraw(),this.SetActive(!0,n),!0):this.Text.Visibility&&t[0]>this.Text.PixelBounds[0]&&t[0]<this.Text.PixelBounds[1]&&t[1]>this.Text.PixelBounds[2]&&t[1]<this.Text.PixelBounds[3]?(this.SetActive(!0,r),!0):(this.SetActive(!1),!1)},u.prototype.GetActive=function(){return this.State==n||this.State==o?!0:!1},u.prototype.Deactivate=function(){this.Popup.StartHideTimer(),this.State=t,this.Text.Active=!1,this.Arrow.Active=!1,this.Layer.DeactivateWidget(this),this.DeactivateCallback&&this.DeactivateCallback(),this.Layer.EventuallyDraw()},u.prototype.SetActive=function(e,i){i=i||n,e||(i=t);if(i==this.State)return;this.State=i,i==n?(this.Text.Active=!1,this.Arrow.Active=!0,this.Layer.ActivateWidget(this),this.PlacePopup(),this.Layer.EventuallyDraw()):i==r?(this.Text.Active=!0,this.Arrow.Active=!1,this.Layer.ActivateWidget(this),this.PlacePopup(),this.Layer.EventuallyDraw()):i==t&&this.Deactivate()},u.prototype.PlacePopup=function(){var e=this.Text.Position[0],t=this.Text.Position[1],n=this.Layer.GetCamera().ConvertPointWorldToViewer(e,t);n[0]+=this.Text.PixelBounds[1]-this.Text.Anchor[0],n[1]-=this.Text.Anchor[1]+10,this.Popup.Show(n[0],n[1])},u.prototype.ShowPropertiesDialog=function(){this.Popup.Hide(),this.Dialog.ColorInput.val(SAM.ConvertColorToHex(this.Text.Color)),this.Dialog.FontInput.val(this.Text.Size.toFixed(0)),this.Dialog.BackgroundInput.prop("checked",this.Text.BackgroundFlag),this.Dialog.TextInput.val(this.Text.String),this.Dialog.VisibilityModeInputs[this.VisibilityMode].attr("checked",!0),this.State=o,this.Dialog.Show(!0),this.Dialog.TextInput.focus()},u.prototype.DialogApplyCallback=function(){this.SetActive(!1),this.Popup.Hide(),this.ApplyLineBreaks();var e=this.Dialog.TextInput.val();e=e.trim();if(e==""){alert("Empty String");return}var t=SAM.ConvertColorToHex(this.Dialog.ColorInput.val()),n=this.Dialog.FontInput.val();this.Text.String=e,this.Text.Size=parseFloat(n),this.Text.UpdateBuffers(),this.Dialog.VisibilityModeInputs[0].prop("checked")?this.SetVisibilityMode(0):this.Dialog.VisibilityModeInputs[1].prop("checked")?this.SetVisibilityMode(1):this.SetVisibilityMode(2);var r=this.Dialog.BackgroundInput.prop("checked");this.Text.SetColor(t),this.Arrow.SetFillColor(t),this.Arrow.ChooseOutlineColor(),this.Text.BackgroundFlag=r,localStorage.TextWidgetDefaults=JSON.stringify({Color:t,FontSize:this.Text.Size,VisibilityMode:this.VisibilityMode,BackgroundFlag:r}),RecordState(),this.Layer.EventuallyDraw(),SAM.NotesWidget&&SAM.NotesWidget.MarkAsModified()},u.prototype.ApplyLineBreaks=function(){var e=this.Dialog.TextInput[0];e.setAttribute("wrap","off");var t=e.value;e.value="";var n=e.scrollWidth,r=-1;for(var i=0;i<t.length;i++){var s=t.charAt(i);if(s==" "||s=="-"||s=="+")r=i;e.value+=s;if(e.scrollWidth>n){var o="";if(r>=0){for(var u=r+1;u<i;u++)o+=t.charAt(u);r=-1}o+=s,e.value=e.value.substr(0,e.value.length-o.length),e.value+="\n"+o}}e.setAttribute("wrap","")},SAM.TextWidget=u})();(function(){"use strict";function e(){SAM.Shape.call(this),this.Origin=[0,0],this.Points=[],this.Closed=!1,this.Bounds=[0,-1,0,-1]}e.prototype=new SAM.Shape,e.prototype.SetLineWidth=function(e){this.LineWidth=e},e.prototype.GetLineWidth=function(){return this.LineWidth},e.prototype.GetEdgeLength=function(e){if(e<0||e>this.Points.length-2)return 0;var t=this.Points[e+1][0]-this.Points[e][0],n=this.Points[e+1][1]-this.Points[e][1];return Math.sqrt(t*t+n*n)},e.prototype.GetNumberOfPoints=function(){return this.Points.length},e.prototype.GetBounds=function(){var e=this.Bounds.slice(0);return e[0]+=this.Origin[0],e[1]+=this.Origin[0],e[2]+=this.Origin[1],e[3]+=this.Origin[1],e},e.prototype.ContainedInBounds=function(e){var t=this.GetBounds();return e[1]<t[0]||e[0]>t[1]||e[3]<t[2]||e[2]>t[3]?0:e[1]>=t[0]&&e[0]<=t[1]&&e[3]>=t[2]&&e[2]<=t[3]?2:1},e.prototype.SetOrigin=function(e){this.Origin=e.slice(0)},e.prototype.ResetOrigin=function(){for(var e=0;e<this.Points.length;++e){var t=this.Points[e];t[0]+=this.Origin[0],t[1]+=this.Origin[1]}this.Origin[0]=0,this.Origin[1]=0,this.UpdateBuffers()},e.prototype.PointOnVertex=function(e,t){t*=t;for(var n=0;n<this.Points.length;++n){var r=this.Points[n][0]-e[0],i=this.Points[n][1]-e[1];if(r*r+i*i<t)return n}return-1},e.prototype.PointOnShape=function(e,t){e=e.slice(0),e[0]-=this.Origin[0],e[1]-=this.Origin[1];if(e[0]+t<this.Bounds[0]||e[0]-t>this.Bounds[1]||e[1]+t<this.Bounds[2]||e[1]-t>this.Bounds[3])return undefined;for(var n=1;n<this.Points.length;++n){var r=this.IntersectPointLine(e,this.Points[n-1],this.Points[n],t);if(r!==undefined)return[n-1,n,r]}if(this.Closed){var r=this.IntersectPointLine(e,this.Points[this.Points.length-1],this.Points[0],t);if(r!==undefined)return[this.Points.length-1,0,r]}return undefined},e.prototype.FindPopupPoint=function(e){if(this.Points.length==0)return;var t=e.Roll,n=Math.sin(t+Math.PI*.25),r=Math.cos(t+Math.PI*.25),i=this.Points[0],s=r*i[0]-n*i[1];for(var o=1;o<this.Points.length;++o){var u=this.Points[o],a=r*u[0]-n*u[1];a>s&&(s=a,i=u)}return i[0]+=this.Origin[0],i[1]+=this.Origin[1],i},e.prototype.MergePoints=function(e){e*=e;var t=!1;for(var n=1;n<this.Points.length;++n){var r=this.Points[n][0]-this.Points[n-1][0],i=this.Points[n][1]-this.Points[n-1][1];r*r+i*i<e&&(this.Points.splice(n,1),--n,t=!0)}t&&this.UpdateBuffers()},e.prototype.Decimate=function(e){var t=!0;while(t){t=!1;var n=[];n.push(this.Points[0]);var r=3;while(r<this.Points.length){var i=this.Points[r],s=this.Points[r-1],o=this.Points[r-2],u=this.Points[r-3],a=(s[0]+o[0])*.5,f=(s[1]+o[1])*.5,l=i[1]-u[1],c=-(i[0]-u[0]),h=Math.sqrt(l*l+c*c);l/=h,c/=h,h=Math.abs(l*(a-this.Points[r-3][0])+c*(f-this.Points[r-3][1]));var p=(i[0]-s[0])*(u[0]-s[0])+(i[1]-s[1])*(u[1]-s[1]),d=(i[0]-o[0])*(u[0]-o[0])+(i[1]-o[1])*(u[1]-o[1]);h<e&&p<0&&d<0?(n.push([a,f]),t=!0,r+=2):(n.push(this.Points[r-2]),++r)}r-=2;while(r<this.Points.length)n.push(this.Points[r]),++r;this.Points=n}this.UpdateBuffers()},e.prototype.AddPointToBounds=function(e,t){e[0]-t<this.Bounds[0]&&(this.Bounds[0]=e[0]-t),e[0]+t>this.Bounds[1]&&(this.Bounds[1]=e[0]+t),e[1]-t<this.Bounds[2]&&(this.Bounds[2]=e[1]-t),e[1]+t>this.Bounds[3]&&(this.Bounds[3]=e[1]+t)},e.prototype.UpdateBuffers=function(){var e=this.Points.slice(0);this.Closed&&e.length>2&&e.push(e[0]),this.PointBuffer=[];var t=[],n=[];this.Matrix=mat4.create(),mat4.identity(this.Matrix);if(this.Points.length==0)return;this.Bounds=[e[0][0],e[0][0],e[0][1],e[0][1]];if(this.LineWidth==0||!GL){for(var r=0;r<e.length;++r)this.PointBuffer.push(e[r][0]),this.PointBuffer.push(e[r][1]),this.PointBuffer.push(0),this.AddPointToBounds(e[r],0);for(var r=2;r<e.length;++r)t.push(0),t.push(r-1),t.push(r)}else{var i=[],s,o,u,a=e.length-1;for(var r=0;r<a;++r)o=e[r+1][0]-e[r][0],u=e[r+1][1]-e[r][1],s=Math.sqrt(o*o+u*u),i.push([-u/s,o/s]);if(a>0){var f=this.LineWidth/2,l=i[0][0]*f,c=i[0][1]*f;this.PointBuffer.push(e[0][0]-l),this.PointBuffer.push(e[0][1]-c),this.PointBuffer.push(0),this.PointBuffer.push(e[0][0]+l),this.PointBuffer.push(e[0][1]+c),this.PointBuffer.push(0),this.AddPointToBounds(e[r],f);for(var r=1;r<a;++r)this.PointBuffer.push(e[r][0]-l),this.PointBuffer.push(e[r][1]-c),this.PointBuffer.push(0),this.PointBuffer.push(e[r][0]+l),this.PointBuffer.push(e[r][1]+c),this.PointBuffer.push(0),l=i[r][0]*f,c=i[r][1]*f,this.PointBuffer.push(e[r][0]-l),this.PointBuffer.push(e[r][1]-c),this.PointBuffer.push(0),this.PointBuffer.push(e[r][0]+l),this.PointBuffer.push(e[r][1]+c),this.PointBuffer.push(0);this.PointBuffer.push(e[a][0]-l),this.PointBuffer.push(e[a][1]-c),this.PointBuffer.push(0),this.PointBuffer.push(e[a][0]+l),this.PointBuffer.push(e[a][1]+c),this.PointBuffer.push(0)}for(var r=0;r<a;++r)n.push(0+4*r),n.push(1+4*r),n.push(3+4*r),n.push(0+4*r),n.push(3+4*r),n.push(2+4*r);for(var r=2;r<e.length;++r)t.push(0),t.push(2*r-1),t.push(2*r)}GL&&(this.VertexPositionBuffer=GL.createBuffer(),GL.bindBuffer(GL.ARRAY_BUFFER,this.VertexPositionBuffer),GL.bufferData(GL.ARRAY_BUFFER,new Float32Array(this.PointBuffer),GL.STATIC_DRAW),this.VertexPositionBuffer.itemSize=3,this.VertexPositionBuffer.numItems=this.PointBuffer.length/3,this.CellBuffer=GL.createBuffer(),GL.bindBuffer(GL.ELEMENT_ARRAY_BUFFER,this.CellBuffer),GL.bufferData(GL.ELEMENT_ARRAY_BUFFER,new Uint16Array(t),GL.STATIC_DRAW),this.CellBuffer.itemSize=1,this.CellBuffer.numItems=t.length,this.LineWidth!=0&&(this.LineCellBuffer=GL.createBuffer(),GL.bindBuffer(GL.ELEMENT_ARRAY_BUFFER,this.LineCellBuffer),GL.bufferData(GL.ELEMENT_ARRAY_BUFFER,new Uint16Array(n),GL.STATIC_DRAW),this.LineCellBuffer.itemSize=1,this.LineCellBuffer.numItems=n.length))};var t=0,n=2*Math.PI*0/24,r=0,i="edge",s=200;e.prototype.SampleEdge=function(e,t,n,r,i){var s=e.GetCamera(),o=s.GetHeight()/s.ViewportHeight;n*=o;var u=e.GetCache(),a=[t,t],f=n/2;this.RecursiveSampleEdge(this.Points.length-1,0,f,n,r,u,a,o,i)},e.prototype.RecursiveSampleEdge=function(e,o,u,a,f,l,c,h,p){var d=this.Points[e],v=this.Points[o],m=v[0]-d[0],g=v[1]-d[1],y=Math.sqrt(m*m+g*g);if(u>y)u-=y,e=o,o+=1,o<this.Points.length?this.RecursiveSampleEdge(e,o,u,a,f,l,c,h,p):p();else{var b=this,w=-Math.atan2(g,m)+n,E=u/y,S=d[0]+E*(v[0]-d[0]),x=d[1]+E*(v[1]-d[1]),T=-g,N=m,C=Math.sqrt(T*T+N*N);T=T/C*r*h,N=N/C*r*h,GetCutoutImage(l,c,[S+T,x+N],h,w,i+f+".png",function(){setTimeout(function(){++f,t=f,u+=a,b.RecursiveSampleEdge(e,o,u,a,f,l,c,h,p)},s)})}},e.prototype.SetActive=function(e){this.Active=e},SAM.Polyline=e})();(function(){"use strict";function a(e,t){if(e===undefined)return;this.Circle=new SAM.Circle,this.Polyline=new SAM.Polyline,this.InitializeDialog(),this.LineWidth=10,this.Polyline.Closed=!1;if(localStorage.PolylineWidgetDefaults){var r=JSON.parse(localStorage.PolylineWidgetDefaults);r.Color&&this.Dialog.ColorInput.val(SAM.ConvertColorToHex(r.Color)),r.LineWidth&&(this.LineWidth=r.LineWidth,this.Dialog.LineWidthInput.val(this.LineWidth))}this.Circle.FillColor=[1,1,.2],this.Circle.OutlineColor=[0,0,0],this.Circle.FixedSize=!1,this.Circle.ZOffset=-0.05,this.Polyline.OutlineColor=[0,0,0],this.Polyline.SetOutlineColor(this.Dialog.ColorInput.val()),this.Polyline.FixedSize=!1,this.Layer=e,this.Popup=new SAM.WidgetPopup(this);var s=e.GetCamera();this.Layer.AddWidget(this),this.Polyline.LineWidth=this.LineWidth,this.Circle.Radius=this.LineWidth,this.Circle.UpdateBuffers(),this.ActiveVertex=-1,this.ActiveEdge=undefined,this.DrawingVertex=-1,t?(this.State=n,this.SetCursorToDrawing(),this.Layer.ActivateWidget(this)):(this.State=i,this.Circle.Visibility=!1),this.CreationCamera=e.GetCamera().Serialize(),this.MinLine=1,this.Layer.EventuallyDraw(!1)}var e=8,t=4,n=0,r=1,i=2,s=3,o=5,u=6;a.prototype.InitializeDialog=function(){var e=this;this.Dialog=new SAM.Dialog(function(){e.DialogApplyCallback()}),this.Dialog.Title.text("Lasso Annotation Editor"),this.Dialog.Body.css({margin:"1em 2em"}),this.Dialog.ColorDiv=$("<div>").appendTo(this.Dialog.Body).css({display:"table-row"}),this.Dialog.ColorLabel=$("<div>").appendTo(this.Dialog.ColorDiv).text("Color:").css({display:"table-cell","text-align":"left"}),this.Dialog.ColorInput=$('<input type="color">').appendTo(this.Dialog.ColorDiv).val("#30ff00").css({display:"table-cell"}),this.Dialog.ClosedDiv=$("<div>").appendTo(this.Dialog.Body).css({display:"table-row"}),this.Dialog.ClosedLabel=$("<div>").appendTo(this.Dialog.ClosedDiv).text("Closed:").css({display:"table-cell","text-align":"left"}),this.Dialog.ClosedInput=$('<input type="checkbox">').appendTo(this.Dialog.ClosedDiv).attr("checked","false").css({display:"table-cell"}),this.Dialog.LineWidthDiv=$("<div>").appendTo(this.Dialog.Body).css({display:"table-row"}),this.Dialog.LineWidthLabel=$("<div>").appendTo(this.Dialog.LineWidthDiv).text("Line Width:").css({display:"table-cell","text-align":"left"}),this.Dialog.LineWidthInput=$('<input type="number">').appendTo(this.Dialog.LineWidthDiv).css({display:"table-cell"}).keypress(function(e){return e.keyCode!=13}),this.Dialog.LengthDiv=$("<div>").appendTo(this.Dialog.Body).css({display:"table-row"}),this.Dialog.LengthLabel=$("<div>").appendTo(this.Dialog.LengthDiv).text("Length:").css({display:"table-cell","text-align":"left"}),this.Dialog.Length=$("<div>").appendTo(this.Dialog.LengthDiv).css({display:"table-cell"}),this.Dialog.AreaDiv=$("<div>").appendTo(this.Dialog.Body).css({display:"table-row"}),this.Dialog.AreaLabel=$("<div>").appendTo(this.Dialog.AreaDiv).text("Area:").css({display:"table-cell","text-align":"left"}),this.Dialog.Area=$("<div>").appendTo(this.Dialog.AreaDiv).css({display:"table-cell"})},a.prototype.Draw=function(e){var t=this.Layer.GetCamera();this.MinLine=t.GetSpacing(),this.LineWidth<this.MinLine?this.Polyline.LineWidth=0:this.Polyline.LineWidth=this.LineWidth,this.Polyline.Draw(e),this.Circle.Draw(e)},a.prototype.PasteCallback=function(e,t){this.Load(e);var n=this.Polyline.GetBounds();if(!n){console.log("Warining: Pasting empty polyline");return}var r=t[0]-(n[0]+n[1])/2,i=t[1]-(n[2]+n[3])/2;for(var s=0;s<this.Polyline.GetNumberOfPoints();++s)this.Polyline.Points[s][0]+=r,this.Polyline.Points[s][1]+=i;this.Polyline.UpdateBuffers(),SA.notesWidget&&SA.notesWidget.MarkAsModified(),this.Layer.EventuallyDraw(!0)},a.prototype.Serialize=function(){if(this.Polyline===undefined)return null;var e=new Object;e.type="polyline",e.outlinecolor=this.Polyline.OutlineColor,e.linewidth=this.LineWidth,e.points=[];for(var t=0;t<this.Polyline.GetNumberOfPoints();++t)e.points.push([this.Polyline.Points[t][0],this.Polyline.Points[t][1]]);return e.creation_camera=this.CreationCamera,e.closedloop=this.Polyline.Closed,e},a.prototype.Load=function(e){this.Polyline.OutlineColor[0]=parseFloat(e.outlinecolor[0]),this.Polyline.OutlineColor[1]=parseFloat(e.outlinecolor[1]),this.Polyline.OutlineColor[2]=parseFloat(e.outlinecolor[2]),this.LineWidth=parseFloat(e.linewidth),this.Polyline.LineWidth=this.LineWidth,this.Polyline.Points=[];for(var t=0;t<e.points.length;t++)this.Polyline.Points[t]=[parseFloat(e.points[t][0]),parseFloat(e.points[t][1])];this.Polyline.Closed=e.closedloop,this.Polyline.UpdateBuffers(),e.view_height!==undefined&&(this.CreationCamera=e.creation_camera)},a.prototype.CityBlockDistance=function(e,t){return Math.abs(t[0]-e[0])+Math.abs(t[1]-e[1])},a.prototype.HandleKeyDown=function(e){if(e.keyCode==67&&e.ctrlKey){var t={Type:"PolylineWidget",Data:this.Serialize()};return localStorage.ClipBoard=JSON.stringify(t),!1}return e.keyCode==27||e.keyCode==32||e.keyCode==13?(this.Layer.DeactivateWidget(this),SAM.NotesWidget&&SAM.NotesWidget.MarkAsModified(),RecordState(),!1):!0},a.prototype.HandleDoubleClick=function(e){if(this.State==n||this.State==r)return this.Polyline.MergePoints(this.Circle.Radius),this.Layer.DeactivateWidget(this),!1;if(this.State==o){var t=e.offsetX,i=e.offsetY,s=this.Layer.GetCamera().ConvertPointViewerToWorld(t,i);if(this.ActiveVertex!=-1)this.Polyline.Points[this.ActiveVertex]=s,this.DrawingVertex=this.ActiveVertex,this.ActiveVertex=-1;else{if(!this.ActiveEdge)return console.log("No vertex or edge is active."),!1;this.Polyline.Points.splice(this.ActiveEdge[1],0,s),this.DrawingVertex=this.ActiveEdge[1],this.ActiveEdge=undefined}return this.Polyline.UpdateBuffers(),this.SetCursorToDrawing(),this.State=n,this.Layer.EventuallyDraw(!1),!1}},a.prototype.HandleMouseDown=function(e){return e.which==1&&this.State==o&&(this.Popup.Hide(),this.Circle.FillColor=this.Polyline.OutlineColor,this.Circle.Active=!1),!1},a.prototype.HandleMouseUp=function(e){if(e.which==3)return this.State=u,this.ShowPropertiesDialog(),!1;if(e.which!=1)return!1;if(this.State==o)return this.Polyline.MergePoints(this.Circle.Radius),SAM.NotesWidget&&SAM.NotesWidget.MarkAsModified(),RecordState(),!1;var t=e.offsetX,i=e.offsetY,s=this.Layer.GetCamera().ConvertPointViewerToWorld(t,i);if(this.State==n){if(this.Polyline.GetNumberOfPoints()>0)return!1;this.Polyline.Points.push(s),this.DrawingVertex=this.Polyline.GetNumberOfPoints()-1,this.State=r}return this.State==r?this.Polyline.GetNumberOfPoints()>2&&this.ActiveVertex==0?(this.Polyline.Points.pop(),this.Polyline.Closed=!0,this.Layer.DeactivateWidget(this),RecordState(),!1):(this.DrawingVertex+=1,this.Polyline.Points.splice(this.DrawingVertex,0,s),this.Polyline.UpdateBuffers(),this.Layer.EventuallyDraw(!0),!1):!1},a.prototype.HandleDrag=function(e){if(this.ActiveEdge){var t=this.Polyline.Points[this.ActiveEdge[0]],n=this.Polyline.Points[this.ActiveEdge[1]],r=t[0]+this.ActiveEdge[2]*(n[0]-t[0]),i=t[1]+this.ActiveEdge[2]*(n[1]-t[1]);this.Polyline.Points.splice(this.ActiveEdge[1],0,[r,i]),this.ActiveVertex=this.ActiveEdge[1],this.ActiveEdge=undefined,this.HighlightVertex(this.ActiveVertex),this.Circle.Active=!1}if(this.ActiveVertex==-1)return!1;this.Circle.Active=!1,this.Polyline.Points[this.ActiveVertex]=e,this.ActiveVertex>0&&this.Polyline.GetEdgeLength(this.ActiveVertex-1)<this.Circle.Radius&&(this.Circle.Active=!0,e=this.Polyline.Points[this.ActiveVertex-1].slice(0)),this.ActiveVertex<this.Polyline.GetNumberOfPoints()-1&&this.Polyline.GetEdgeLength(this.ActiveVertex)<this.Circle.Radius&&(this.Circle.Active=!0,e=this.Polyline.Points[this.ActiveVertex+1].slice(0)),this.Polyline.Points[this.ActiveVertex]=e,this.Circle.Origin=e,this.Polyline.UpdateBuffers(),SAM.NotesWidget&&SAM.NotesWidget.MarkAsModified(),this.Layer.EventuallyDraw(!0)},a.prototype.StartDrawing=function(e){if(this.Polyline.GetNumberOfPoints()==0)return;this.DrawingVertex==0&&(this.Polyline.Points.reverse(),this.DrawingVertex=this.Polyline.GetNumberOfPoints()-1);if(this.DrawingVertex==this.Polyline.GetNumberOfPoints()-1){this.Polyline.Points.push(e),this.DrawingVertex+=1,this.State=r;return}var t=this.Polyline.Points[this.DrawingVertex-1],n=this.Polyline.Points[this.DrawingVertex],i=this.Polyline.Points[this.DrawingVertex+1],s=e[0]-n[0],o=e[1]-n[1],u=[t[0]-n[0],t[1]-n[1]],a=Math.sqrt(u[0]*u[0]+u[1]*u[1]);a=(s*u[0]+o*u[1])/a;var f=[i[0]-n[0],i[1]-n[1]],l=Math.sqrt(f[0]*f[0]+f[1]*f[1]);return l=(s*f[0]+o*f[1])/a,a>l&&(this.Polyline.Points.reverse(),this.DrawingVertex=this.Polyline.GetNumberOfPoints()-this.DrawingVertex-1),this.DrawingVertex+=1,this.Polyline.Points.splice(this.DrawingVertex,0,e),this.State=r,!1},a.prototype.HandleMouseMove=function(e){var t=e.offsetX,i=e.offsetY,s=this.Layer.GetCamera().ConvertPointViewerToWorld(t,i);if(this.State==n)return this.StartDrawing(s),!1;if(this.State==r){this.Polyline.Points[this.DrawingVertex]=s,this.Polyline.UpdateBuffers();var u=this.Polyline.PointOnVertex(s,this.Circle.Radius);return this.DrawingVertex==this.Polyline.GetNumberOfPoints()-1&&u==0?this.HighlightVertex(0):this.HighlightVertex(-1),!1}if(this.State==o){if(e.which==0)return this.CheckActive(e)?this.UpdateActiveCircle():this.Layer.DeactivateWidget(this),!1;this.State==o&&e.which==1&&this.HandleDrag(s)}},a.prototype.CheckActive=function(n){var i=n.offsetX,s=n.offsetY,o=this.Layer.GetCamera().ConvertPointViewerToWorld(i,s),u;this.ActiveEdge=undefined,u=e/this.Layer.GetPixelsPerUnit(),u=Math.max(u,this.Polyline.GetLineWidth()),this.ActiveVertex=this.Polyline.PointOnVertex(o,u);if(this.State==r)return this.Polyline.GetNumberOfPoints()<2||this.ActiveVertex!=0?(this.ActiveVertex=-1,!1):!0;if(this.ActiveVertex==-1){u=t/this.Layer.GetPixelsPerUnit(),u=Math.max(u,this.Polyline.GetLineWidth()/2),this.ActiveEdge=this.Polyline.PointOnShape(o,u);if(!this.ActiveEdge)return!1}return!0},a.prototype.HighlightVertex=function(t){t<0||t>=this.Polyline.GetNumberOfPoints()?this.Circle.Visibility=!1:(this.Circle.Visibility=!0,this.Circle.Active=!0,this.Circle.Radius=e/this.Layer.GetPixelsPerUnit(),this.CircleRadius=Math.max(this.CircleRadius,this.Polyline.GetLineWidth()*1.5),this.Circle.UpdateBuffers(),this.Circle.Origin=this.Polyline.Points[t]),this.ActiveVertex=t,this.Layer.EventuallyDraw(!0)},a.prototype.UpdateActiveCircle=function(){if(this.ActiveVertex!=-1){this.HighlightVertex(this.ActiveVertex);return}if(this.ActiveEdge){this.Circle.Visibility=!0,this.Circle.Active=!0,this.Circle.Radius=t/this.Layer.GetPixelsPerUnit(),this.CircleRadius=Math.max(this.CircleRadius,this.Polyline.GetLineWidth());var e=this.Polyline.Points[this.ActiveEdge[0]],n=this.Polyline.Points[this.ActiveEdge[1]],r=e[0]+this.ActiveEdge[2]*(n[0]-e[0]),i=e[1]+this.ActiveEdge[2]*(n[1]-e[1]);this.Circle.Origin=[r,i,0],this.Circle.UpdateBuffers()}else this.Circle.Visibility=!1;this.Layer.EventuallyDraw(!1)},a.prototype.GetActive=function(){return this.State==i?!1:!0},a.prototype.SetActive=function(e){if(e==this.GetActive())return;e?(this.State=o,this.UpdateActiveCircle(),this.PlacePopup()):(this.Popup.StartHideTimer(),this.State=i,this.DrawingVertex=-1,this.ActiveVertex=-1,this.ActiveEdge=undefined,this.Circle.Visibility=!1,this.DeactivateCallback&&this.DeactivateCallback(),this.Polyline.GetNumberOfPoints()<2&&this.Layer&&this.Layer.RemoveWidget(this)),this.Layer.EventuallyDraw(!1)},a.prototype.SetCursorToDrawing=function(){this.Popup.Hide(),this.Layer.GetCanvasDiv().css({cursor:"url("+SAM.ImagePathUrl+"dotCursor8.png) 4 4,crosshair"}),this.Layer.EventuallyDraw()},a.prototype.PlacePopup=function(){if(this.State==r||this.State==n)return;var e=this.Polyline.FindPopupPoint(this.Layer.GetCamera());e=this.Layer.GetCamera().ConvertPointWorldToViewer(e[0],e[1]),e[0]+=20,e[1]-=10,this.Popup.Show(e[0],e[1])};var f;a.prototype.ShowPropertiesDialog=function(){this.Dialog.ColorInput.val(SAM.ConvertColorToHex(this.Polyline.OutlineColor)),this.Dialog.ClosedInput.prop("checked",this.Polyline.Closed),this.Dialog.LineWidthInput.val(this.Polyline.LineWidth.toFixed(2));var e=this.ComputeLength()*.25,t="";this.Polyline.FixedSize?(t+=e.toFixed(2),t+=" px"):e>1e3?t+=(e/1e3).toFixed(2)+" mm":t+=e.toFixed(2)+" µm",this.Dialog.Length.text(t);if(this.Polyline.Closed){this.Dialog.AreaDiv.show();var n=this.ComputeArea()*.25*.25,r="";this.Polyline.FixedSize?(r+=n.toFixed(2),r+=" pixels^2"):n>1e6?r+=(n/1e6).toFixed(2)+" mm^2":r+=n.toFixed(2)+" µm^2",this.Dialog.Area.text(r)}else this.Dialog.AreaDiv.hide();this.Dialog.Show(!0)},a.prototype.DialogApplyCallback=function(){var e=this.Dialog.ColorInput.val();this.Polyline.SetOutlineColor(e),this.Polyline.Closed=this.Dialog.ClosedInput.prop("checked"),this.LineWidth=parseFloat(this.Dialog.LineWidthInput.val()),this.Polyline.UpdateBuffers(),this.SetActive(!1),RecordState(),this.Layer.EventuallyDraw(!1),localStorage.PolylineWidgetDefaults=JSON.stringify({Color:e,ClosedLoop:this.Polyline.Closed,LineWidth:this.LineWidth}),SAM.NotesWidget&&SAM.NotesWidget.MarkAsModified()},a.prototype.ComputeArea=function(){if(this.Polyline.GetNumberOfPoints()==0)return 0;var e=0,t=0;for(var n=0;n<this.Polyline.GetNumberOfPoints();++n)e+=this.Polyline.Points[n][0],t+=this.Polyline.Points[n][1];e/=this.Polyline.GetNumberOfPoints(),t/=this.Polyline.GetNumberOfPoints();var r=0,i=this.Polyline.GetNumberOfPoints()-1,s=this.Polyline.Points[i][0]-e,o=this.Polyline.Points[i][1]-t;for(var n=0;n<this.Polyline.GetNumberOfPoints();++n){var u=s,a=o;s=this.Polyline.Points[n][0]-e,o=this.Polyline.Points[n][1]-t,r+=s*a-u*o}return r<0&&(r=-r),r},a.prototype.ComputeLength=function(){if(this.Polyline.GetNumberOfPoints()<2)return 0;var e=0,t=this.Polyline.Points[0][0],n=this.Polyline.Points[0][1];for(var r=1;r<this.Polyline.GetNumberOfPoints();++r){var i=this.Polyline.Points[r][0],s=this.Polyline.Points[r][1],o=i-t,u=s-n;t=i,n=s,e+=Math.sqrt(o*o+u*u)}return e},a.prototype.PointInside=function(e,t){if(this.Polyline.Closed==0)return!1;var n,r,i=this.Polyline.GetNumberOfPoints()-1,s=0,o=0,u=this.Polyline.Points[i];u=[u[0]-e,u[1]-t];for(var a=0;a<=i;++a){var f=this.Polyline.Points[a];f=[f[0]-e,f[1]-t];var l;l=f[1]-u[1],l!=0&&(l=-u[1]/l,l>0&&l<=1&&(n=u[0]+l*(f[0]-u[0]),n>0&&(s+=1),n<0&&(o+=1))),u=f}return s%2&&o%2?!0:!1},a.prototype.Sample=function(e,t,n,r,i){var s=this.Polyline.GetBounds(),o=this.Layer.Context2d;for(var u=s[2];u<s[3];u+=n)for(var a=s[0];a<s[1];a+=n)if(this.PointInside(a,u)){ip=this.Layer.GetCamera().ConvertPointWorldToViewer(a,u),ip[0]=Math.round(ip[0]-e/2),ip[1]=Math.round(ip[1]-e/2);var f=o.getImageData(ip[0],ip[1],e,e);DownloadImageData(f,r+"_"+i+".png"),++i}},a.prototype.SampleStack=function(e,t,n,r,i){var s=LAYERS[0].GetCache(),o=this.Polyline.GetBounds();for(var u=o[2];u<o[3];u+=n)for(var a=o[0];a<o[1];a+=n)this.PointInside(a,u)&&GetCutoutimage(s,e,[a,u],t,0,null,function(e){DownloadImageData(e,r+"_"+i+".png"),++i})},a.prototype.DownloadStack=function(e,t,n,r,i){var s=LAYERS[0].GetCache();for(var o=0;o<3;++o)levelSpacing=r<<o,GetCutoutImage(s,n,[e,t],levelSpacing,0,i+o+".png",null)},SAM.PolylineWidget=a})();(function(){"use strict";function i(e,t){if(e==null)return;var n=this;this.Dialog=new SAM.Dialog(function(){n.DialogApplyCallback()}),this.Dialog.Title.text("Pencil Annotation Editor"),this.Dialog.Body.css({margin:"1em 2em"}),this.Dialog.ColorDiv=$("<div>").appendTo(this.Dialog.Body).css({display:"table-row"}),this.Dialog.ColorLabel=$("<div>").appendTo(this.Dialog.ColorDiv).text("Color:").css({display:"table-cell","text-align":"left"}),this.Dialog.ColorInput=$('<input type="color">').appendTo(this.Dialog.ColorDiv).val("#30ff00").css({display:"table-cell"}),this.Dialog.LineWidthDiv=$("<div>").appendTo(this.Dialog.Body).css({display:"table-row"}),this.Dialog.LineWidthLabel=$("<div>").appendTo(this.Dialog.LineWidthDiv).text("Line Width:").css({display:"table-cell","text-align":"left"}),this.Dialog.LineWidthInput=$('<input type="number">').appendTo(this.Dialog.LineWidthDiv).css({display:"table-cell"}).keypress(function(e){return e.keyCode!=13}),this.LineWidth=0;if(localStorage.PencilWidgetDefaults){var i=JSON.parse(localStorage.PencilWidgetDefaults);i.Color&&this.Dialog.ColorInput.val(SAM.ConvertColorToHex(i.Color)),i.LineWidth&&(this.LineWidth=i.LineWidth,this.Dialog.LineWidthInput.val(this.LineWidth))}this.Layer=e,this.Popup=new SAM.WidgetPopup(this),this.Layer.AddWidget(this);var n=this;this.Shapes=new SAM.ShapeGroup,this.SetStateToDrawing(),t||(this.State=r,this.Layer.GetCanvasDiv().css({cursor:"default"})),this.CreationCamera=e.GetCamera().Serialize()}var e=0,t=1,n=2,r=3;i.prototype.SetStateToDrawing=function(){this.State=e,this.Shapes.SetActive(!1),this.Popup.Hide(),this.Layer.GetCanvasDiv().css({cursor:"url("+SAM.ImagePathUrl+"Pencil-icon.png) 0 24,crosshair"}),this.Layer.EventuallyDraw()},i.prototype.Draw=function(e){this.Shapes.Draw(e)},i.prototype.Serialize=function(){var e=new Object;e.type="pencil",e.shapes=[];for(var t=0;t<this.Shapes.GetNumberOfShapes();++t){var n=this.Shapes.GetShape(t),r=[];for(var i=0;i<n.Points.length;++i)r.push([n.Points[i][0],n.Points[i][1]]);e.shapes.push(r),e.outlinecolor=n.OutlineColor,e.linewidth=n.LineWidth}return e.creation_camera=this.CreationCamera,e},i.prototype.Load=function(e){this.LineWidth=parseFloat(e.linewidth),e.linewidth&&(this.LineWidth=parseFloat(e.linewidth));var t=this.Dialog.ColorInput.val();e.outlinecolor&&(t[0]=parseFloat(e.outlinecolor[0]),t[1]=parseFloat(e.outlinecolor[1]),t[2]=parseFloat(e.outlinecolor[2]));for(var n=0;n<e.shapes.length;n++){var r=e.shapes[n],i=new SAM.Polyline;i.SetOutlineColor(t),i.FixedSize=!1,i.LineWidth=this.LineWidth,this.Shapes.AddShape(i);for(var s=0;s<r.length;++s)i.Points[s]=[r[s][0],r[s][1]];i.UpdateBuffers()}e.view_height!==undefined&&(this.CreationCamera=e.creation_camera)},i.prototype.Deactivate=function(){this.Popup.StartHideTimer(),this.Layer.GetCanvasDiv().css({cursor:"default"}),this.Layer.DeactivateWidget(this),this.State=r,this.Shapes.SetActive(!1),this.DeactivateCallback&&this.DeactivateCallback(),this.Layer.EventuallyDraw()},i.prototype.HandleKeyDown=function(t){if(this.State==e)if(t.keyCode==27||t.keyCode==32||t.keyCode==13)return this.Deactivate(),!1},i.prototype.HandleMouseWheel=function(n){if(this.State==e||this.State==t){if(this.Shapes.GetNumberOfShapes()<0)return;var r=0;n.deltaY?r=n.deltaY:n.wheelDelta&&(r=n.wheelDelta);var i=1/this.Layer.GetPixelsPerUnit(),s=this.Shapes.GetLineWidth();return s=s||i,r>0?s*=1.1:r<0&&(s/=1.1),s<=i&&(s=0),this.Dialog.LineWidthInput.val(s),this.Shapes.SetLineWidth(s),this.Shapes.UpdateBuffers(),this.Layer.EventuallyDraw(),!1}return!0},i.prototype.HandleMouseDown=function(n){var r=n.offsetX,i=n.offsetY;if(n.which==1){if(this.State==e){var s=new SAM.Polyline;s.OutlineColor=[0,0,0],s.SetOutlineColor(this.Dialog.ColorInput.val()),s.FixedSize=!1,s.LineWidth=0,s.LineWidth=this.Shapes.GetLineWidth(),this.Shapes.AddShape(s);var o=this.Layer.GetCamera().ConvertPointViewerToWorld(r,i);s.Points.push([o[0],o[1]])}if(this.State==t){var u=this.Layer.GetCamera();this.LastMouse=u.ConvertPointViewerToWorld(r,i)}}},i.prototype.HandleMouseUp=function(r){if(r.which==3)return this.ShowPropertiesDialog(),!1;if(r.which==2)return this.Deactivate(),!1;this.State==n&&(this.Shapes.ResetOrigin(),this.State=t);var i=this.Shapes.GetNumberOfShapes()-1;if(this.State==e&&r.which==1&&i>=0){var s=this.Layer.GetCamera().GetSpacing();this.Shapes.GetShape(i).Decimate(s),RecordState()}return!1},i.prototype.HandleDoubleClick=function(n){return this.State==e?(this.Deactivate(),!1):this.State==t?(this.SetStateToDrawing(),!1):!0},i.prototype.HandleMouseMove=function(r){var i=r.offsetX,s=r.offsetY;if(r.which==1&&this.State==e){var o=this.Shapes.GetNumberOfShapes()-1,u=this.Shapes.GetShape(o),a=this.Layer.GetCamera().ConvertPointViewerToWorld(i,s);return u.Points.push([a[0],a[1]]),u.UpdateBuffers(),SAM.NotesWidget&&SAM.NotesWidget.MarkAsModified(),this.Layer.EventuallyDraw(),!1}if(this.State==t&&r.which==0)return this.SetActive(this.CheckActive(r)),!1;this.State==t&&r.which==1&&(this.State=n);if(this.State==n){this.State=n,this.Popup.Hide();var f=this.Layer.GetCamera(),l=f.ConvertPointViewerToWorld(i,s),c=this.Shapes.GetOrigin();return c[0]+=l[0]-this.LastMouse[0],c[1]+=l[1]-this.LastMouse[1],this.Shapes.SetOrigin(c),this.LastMouse=l,this.Layer.EventuallyDraw(),!1}},i.prototype.PlacePopup=function(){var e=this.Shapes.FindPopupPoint(this.Layer.GetCamera());if(!e)return;e=this.Layer.GetCamera().ConvertPointWorldToViewer(e[0],e[1]),e[0]+=20,e[1]-=10,this.Popup.Show(e[0],e[1])},i.prototype.CheckActive=function(n){if(this.State==e)return!0;if(this.Shapes.GetNumberOfShapes()==0)return!1;var i=n.offsetX,s=n.offsetY,o=this.Layer.GetCamera().ConvertPointViewerToWorld(i,s),u=this.Shapes.GetLineWidth(),a=10/this.Layer.GetPixelsPerUnit();u<a&&(u=a);var f=this.Shapes.PointOnShape(o,u);return this.State==t&&!f?this.SetActive(f):this.State==r&&f&&(this.PlacePopup(),this.SetActive(f)),f},i.prototype.SetActive=function(e){if(e==this.GetActive())return;if(e)this.Layer.ActivateWidget(this),this.State=t,this.Shapes.SetActive(!0),this.PlacePopup(),this.Layer.EventuallyDraw();else{if(this.State!=t)return;this.Deactivate(),this.Layer.DeactivateWidget(this)}},i.prototype.GetActive=function(){return this.State!=r},i.prototype.RemoveFromLayer=function(){this.Layer&&this.Layer.RemoveWidget(this),this.Layer=null};var s;i.prototype.ShowPropertiesDialog=function(){this.Dialog.ColorInput.val(SAM.ConvertColorToHex(this.Shapes.GetOutlineColor())),this.Dialog.LineWidthInput.val(this.Shapes.GetLineWidth().toFixed(2)),this.Dialog.Show(!0)},i.prototype.DialogApplyCallback=function(){var e=this.Dialog.ColorInput.val();this.LineWidth=parseFloat(this.Dialog.LineWidthInput.val()),this.Shapes.SetOutlineColor(e),this.Shapes.SetLineWidth(parseFloat(this.Dialog.LineWidthInput.val())),this.Shapes.UpdateBuffers(),this.SetActive(!1),RecordState(),this.Layer.EventuallyDraw(),localStorage.PencilWidgetDefaults=JSON.stringify({Color:e,LineWidth:this.LineWidth}),SAM.NotesWidget&&SAM.NotesWidget.MarkAsModified()},SAM.PencilWidget=i})();(function(){"use strict";function r(t,r){if(t==null)return;this.Dialog=new SAM.Dialog(this),this.Dialog.Title.text("Fill Annotation Editor"),this.Dialog.Body.css({margin:"1em 2em"}),this.Dialog.ColorDiv=$("<div>").appendTo(this.Dialog.Body).addClass("sa-view-fill-div"),this.Dialog.ColorLabel=$("<div>").appendTo(this.Dialog.ColorDiv).text("Color:").addClass("sa-view-fill-label"),this.Dialog.ColorInput=$('<input type="color">').appendTo(this.Dialog.ColorDiv).val("#30ff00").addClass("sa-view-fill-input"),this.Dialog.LineWidthDiv=$("<div>").appendTo(this.Dialog.Body).addClass("sa-view-fill-div"),this.Dialog.LineWidthLabel=$("<div>").appendTo(this.Dialog.LineWidthDiv).text("Line Width:").addClass("sa-view-fill-label"),this.Dialog.LineWidthInput=$('<input type="number">').appendTo(this.Dialog.LineWidthDiv).addClass("sa-view-fill-input").keypress(function(e){return e.keyCode!=13}),this.Popup=new SAM.WidgetPopup(this),this.Viewer=t,this.Viewer.AddWidget(this),this.Cursor=$("<img>").appendTo("body").addClass("sa-view-fill-cursor").attr("type","image").attr("src",SAM.ImagePathUrl+"brush1.jpg");var i=this;this.ActiveCenter=[0,0],this.State=e,r||(this.State=n),this.CreationCamera=t.GetCamera().Serialize}var e=0,t=1,n=2;r.prototype.Initialize=function(e){this.Segmentation=new Segmentation(this.Viewer)},r.prototype.Draw=function(e){this.Segmentation.ImageAnnotation.Draw(e)},r.prototype.Serialize=function(){},r.prototype.Load=function(e){},r.prototype.HandleKeyPress=function(e,t){return!1},r.prototype.Deactivate=function(){this.Popup.StartHideTimer(),this.Viewer.DeactivateWidget(this),this.State=n,this.DeactivateCallback&&this.DeactivateCallback(),eventuallyRender()},r.prototype.HandleMouseDown=function(e){var t=this.Viewer.MouseX,n=this.Viewer.MouseY;if(e.which==1){var r=this.Viewer.ConvertPointViewerToWorld(t,n);this.Cursor.attr("src",SAM.ImagePathUrl+"brush1.jpg"),this.Cursor.show(),this.Segmentation.AddPositive(r)}if(e.which==3){var r=this.Viewer.ConvertPointViewerToWorld(t,n);this.Cursor.attr("src",SAM.ImagePathUrl+"eraser1.jpg"),this.Cursor.show(),this.Segmentation.AddNegative(r)}},r.prototype.HandleMouseUp=function(e){e.which==2&&this.Deactivate();if(e.which==1||e.which==3)this.Cursor.hide(),this.Segmentation.Update(),this.Segmentation.Draw(),eventuallyRender()},r.prototype.HandleDoubleClick=function(e){},r.prototype.HandleMouseMove=function(t){var n=this.Viewer.MouseX,r=this.Viewer.MouseY;this.Cursor.css({left:n+4,top:r-32});if(this.Viewer.MouseDown==1&&this.State==e){if(t.which==1){var i=this.Viewer.ConvertPointViewerToWorld(n,r);this.Segmentation.AddPositive(i)}if(t.which==3){var i=this.Viewer.ConvertPointViewerToWorld(n,r);this.Segmentation.AddNegative(i)}return}},r.prototype.ComputeActiveCenter=function(){},r.prototype.PlacePopup=function(){},r.prototype.CheckActive=function(e){},r.prototype.GetActive=function(){return!1},r.prototype.SetActive=function(e){if(e){this.Viewer.ActivateWidget(this),this.State=t;for(var n=0;n<this.Shapes.length;++n)this.Shapes[n].Active=!0;this.PlacePopup(),eventuallyRender()}else this.Deactivate(),this.Viewer.DeactivateWidget(this)},r.prototype.RemoveFromViewer=function(){this.Viewer&&this.Viewer.RemoveWidget()};var i;r.prototype.ShowPropertiesDialog=function(){this.Dialog.ColorInput.val(SAM.ConvertColorToHex(this.Shapes[0].OutlineColor)),this.Dialog.LineWidthInput.val(this.Shapes[0].LineWidth.toFixed(2)),this.Dialog.Show(!0)},r.prototype.DialogApplyCallback=function(){var e=this.Dialog.ColorInput.val();for(var t=0;t<this.Shapes.length;++t)this.Shapes[t].SetOutlineColor(e),this.Shapes[t].LineWidth=parseFloat(this.Dialog.LineWidthInput.val()),this.Shapes[t].UpdateBuffers();this.SetActive(!1),RecordState(),eventuallyRender()},SAM.FillWidget=r})();(function(){"use strict";function r(e,t){if(e==null)return;var r=this;this.Dialog=new SAM.Dialog(function(){r.DialogApplyCallback()}),this.Dialog.Title.text("Lasso Annotation Editor"),this.Dialog.Body.css({margin:"1em 2em"}),this.Dialog.ColorDiv=$("<div>").appendTo(this.Dialog.Body).addClass("sa-view-annotation-modal-div"),this.Dialog.ColorLabel=$("<div>").appendTo(this.Dialog.ColorDiv).text("Color:").addClass("sa-view-annotation-modal-input-label"),this.Dialog.ColorInput=$('<input type="color">').appendTo(this.Dialog.ColorDiv).val("#30ff00").addClass("sa-view-annotation-modal-input"),this.Dialog.LineWidthDiv=$("<div>").appendTo(this.Dialog.Body).addClass("sa-view-annotation-modal-div"),this.Dialog.LineWidthLabel=$("<div>").appendTo(this.Dialog.LineWidthDiv).text("Line Width:").addClass("sa-view-annotation-modal-input-label"),this.Dialog.LineWidthInput=$('<input type="number">').appendTo(this.Dialog.LineWidthDiv).addClass("sa-view-annotation-modal-input").keypress(function(e){return e.keyCode!=13}),this.Dialog.AreaDiv=$("<div>").appendTo(this.Dialog.Body).addClass("sa-view-annotation-modal-div"),this.Dialog.AreaLabel=$("<div>").appendTo(this.Dialog.AreaDiv).text("Area:").addClass("sa-view-annotation-modal-input-label"),this.Dialog.Area=$("<div>").appendTo(this.Dialog.AreaDiv).addClass("sa-view-annotation-modal-input");if(localStorage.LassoWidgetDefaults){var i=JSON.parse(localStorage.LassoWidgetDefaults);i.Color&&this.Dialog.ColorInput.val(SAM.ConvertColorToHex(i.Color)),i.LineWidth&&this.Dialog.LineWidthInput.val(i.LineWidth)}this.Layer=e,this.Popup=new SAM.WidgetPopup(this),this.Layer.AddWidget(this);var r=this;this.Loop=new SAM.Polyline,this.Loop.OutlineColor=[0,0,0],this.Loop.SetOutlineColor(this.Dialog.ColorInput.val()),this.Loop.FixedSize=!1,this.Loop.LineWidth=0,this.Loop.Closed=!0,this.Stroke=!1,this.ActiveCenter=[0,0],t?this.SetStateToDrawing():this.State=n}var e=0,t=1,n=2;r.prototype.Draw=function(e){this.Loop.Draw(e),this.Stroke&&this.Stroke.Draw(e)},r.prototype.Serialize=function(){var e=new Object;e.type="lasso",e.outlinecolor=this.Loop.OutlineColor,e.linewidth=this.Loop.GetLineWidth(),e.points=[];for(var t=0;t<this.Loop.Points.length;++t)e.points.push([this.Loop.Points[t][0],this.Loop.Points[t][1]]);return e.closedloop=!0,e},r.prototype.Load=function(e){e.outlinecolor!=undefined&&(this.Loop.OutlineColor[0]=parseFloat(e.outlinecolor[0]),this.Loop.OutlineColor[1]=parseFloat(e.outlinecolor[1]),this.Loop.OutlineColor[2]=parseFloat(e.outlinecolor[2])),e.outlinewidth!=undefined&&(this.Loop.LineWidth=e.linewidth);var t=[];e.points!=undefined&&(t=e.points),e.shape!=undefined&&(t=e.shapes[0]);for(var n=0;n<t.length;n++)this.Loop.Points[n]=[parseFloat(t[n][0]),parseFloat(t[n][1])];this.ComputeActiveCenter(),this.Loop.UpdateBuffers()},r.prototype.HandleMouseWheel=function(n){if(this.State==e||this.State==t){if(!this.Loop)return!0;var r=0;n.deltaY?r=n.deltaY:n.wheelDelta&&(r=n.wheelDelta);var i=1/this.Layer.GetPixelsPerUnit(),s=this.Loop.GetLineWidth();return s=s||i,r>0?s*=1.1:r<0&&(s/=1.1),s<=i&&(s=0),this.Dialog.LineWidthInput.val(s),this.Loop.SetLineWidth(s),this.Loop.UpdateBuffers(),this.Layer.EventuallyDraw(),!1}return!0},r.prototype.Deactivate=function(){this.Popup.StartHideTimer(),this.Layer.DeactivateWidget(this),this.State=n,this.Loop.SetActive(!1),this.Stroke&&this.Stroke.SetActive(!1),this.DeactivateCallback&&this.DeactivateCallback(),this.Layer.EventuallyDraw()},r.prototype.HandleKeyDown=function(t){if(this.State==e)if(t.keyCode==27||t.keyCode==32||t.keyCode==13)return this.Deactivate(),!1},r.prototype.HandleMouseDown=function(e){var t=e.offsetX,n=e.offsetY;if(e.which==1){this.Stroke=new SAM.Polyline,this.Stroke.OutlineColor=[0,0,0],this.Stroke.SetOutlineColor(this.Loop.OutlineColor),this.Stroke.FixedSize=!1,this.Stroke.LineWidth=0;var r=this.Layer.GetCamera().ConvertPointViewerToWorld(t,n);return this.Stroke.Points=[],this.Stroke.Points.push([r[0],r[1]]),!1}return!0},r.prototype.HandleMouseUp=function(t){t.which==2&&this.Deactivate();if(t.which==1&&this.State==e){var n=this.Layer.GetCamera().GetSpacing();this.Stroke.Decimate(n),this.Loop&&this.Loop.Points.length>0?this.CombineStroke():(this.Stroke.Closed=!0,this.Stroke.UpdateBuffers(),this.Loop=this.Stroke,this.Stroke=!1),this.ComputeActiveCenter(),this.Layer.EventuallyDraw(),RecordState()}return!1},r.prototype.HandleDoubleClick=function(n){return this.State==e?(this.Deactivate(),!1):this.State==t?(this.SetStateToDrawing(),!1):!0},r.prototype.SetStateToDrawing=function(){this.State=e,this.Loop.SetActive(!1),this.Popup.Hide(),this.Layer.GetCanvasDiv().css({cursor:"url("+SAM.ImagePathUrl+"select_lasso.png) 5 30,crosshair"}),this.Layer.EventuallyDraw()},r.prototype.HandleMouseMove=function(n){var r=n.offsetX,i=n.offsetY;if(n.which==1&&this.State==e){var s=this.Stroke,o=this.Layer.GetCamera().ConvertPointViewerToWorld(r,i);return s.Points.push([o[0],o[1]]),s.UpdateBuffers(),SA.notesWidget&&SA.notesWidget.MarkAsModified(),this.Layer.EventuallyDraw(),!1}return this.State==t&&n.which==0?(this.SetActive(this.CheckActive(n)),!1):!0},r.prototype.ComputeActiveCenter=function(){var e=0,t=0,n=0,r=this.Loop,i=[];for(var s=0;s<r.Points.length;++s)t+=r.Points[s][0],n+=r.Points[s][1];this.ActiveCenter[0]=t/r.Points.length,this.ActiveCenter[1]=n/r.Points.length},r.prototype.PlacePopup=function(){var e=this.Loop.FindPopupPoint(this.Layer.GetCamera());e=this.Layer.GetCamera().ConvertPointWorldToViewer(e[0],e[1]),e[0]+=20,e[1]-=10,this.Popup.Show(e[0],e[1])},r.prototype.CheckActive=function(t){if(this.State==e)return;var n=t.offsetX,r=t.offsetY,i=this.Layer.GetCamera().ConvertPointViewerToWorld(n,r),s=this.Loop.GetLineWidth()/2,o=10/this.Layer.GetPixelsPerUnit();return s<o&&(s=o),this.Loop.PointOnShape(i,s)?!0:!1},r.prototype.GetActive=function(){return this.State!=n},r.prototype.SetActive=function(e){e?this.State==n&&(this.State=t,this.Loop.SetActive(!0),this.PlacePopup(),this.Layer.EventuallyDraw()):this.State!=n&&(this.Deactivate(),this.Layer.DeactivateWidget(this)),this.Layer.EventuallyDraw()},r.prototype.RemoveFromLayer=function(){this.Layer&&this.RemoveWidget(this)},r.prototype.ShowPropertiesDialog=function(){this.Dialog.ColorInput.val(SAM.ConvertColorToHex(this.Loop.OutlineColor)),this.Dialog.LineWidthInput.val(this.Loop.LineWidth.toFixed(2));var e=this.ComputeArea(),t=""+e.toFixed(2);this.Loop.FixedSize?t+=" pixels^2":t+=" units^2",this.Dialog.Area.text(t),this.Dialog.Show(!0)},r.prototype.DialogApplyCallback=function(){var e=this.Dialog.ColorInput.val();this.Loop.SetOutlineColor(e),this.Loop.LineWidth=parseFloat(this.Dialog.LineWidthInput.val()),this.Loop.UpdateBuffers(),this.SetActive(!1),RecordState(),this.Layer.EventuallyDraw(),localStorage.LassoWidgetDefaults=JSON.stringify({Color:e,LineWidth:this.Loop.LineWidth}),SAM.NotesWidget&&SAM.NotesWidget.MarkAsModified()},r.prototype.CombineStroke=function(){this.Loop.Points.push(this.Loop.Points[0]);var e,t;for(var n=1;n<this.Stroke.Points.length;++n){var r=this.Stroke.Points[n-1],i=this.Stroke.Points[n],s=this.FindIntersection(r,i);s&&(this.Stroke.Points.splice(n,0,s.Point),e==undefined?(e=s,e.StrokeIndex=n):(s.LoopIndex<e.LoopIndex&&(e.LoopIndex+=1),t=s,t.StrokeIndex=n))}var o=0;if(t!=undefined){var u=[],a=0,f=[],l=0,n;for(n=e.StrokeIndex;n<t.StrokeIndex;++n)u.push(this.Stroke.Points[n]),f.push(this.Stroke.Points[n]);n=t.LoopIndex;while(n!=e.LoopIndex){if(++o>1e6){alert("Combine loop 1 is taking too long.");return}u.push(this.Loop.Points[n]);var c=this.Loop.Points[n][0],h=this.Loop.Points[n][1];--n==0&&(n=this.Loop.Points.length-1),c-=this.Loop.Points[n][0],h-=this.Loop.Points[n][1],a+=Math.sqrt(c*c+h*h)}u.push(e.Point),n=t.LoopIndex;while(n!=e.LoopIndex){if(++o>1e6){alert("Combine loop 2 is taking too long.");return}f.push(this.Loop.Points[n]);var c=this.Loop.Points[n][0],h=this.Loop.Points[n][1];++n==this.Loop.Points.length-1&&(n=0),c-=this.Loop.Points[n][0],h-=this.Loop.Points[n][1],l+=Math.sqrt(c*c+h*h)}f.push(e.Point),a>l?this.Loop.Points=u:this.Loop.Points=f,RecordState()}this.Loop.Points.pop(),this.Loop.UpdateBuffers(),this.ComputeActiveCenter(),this.Stroke=!1,this.Layer.EventuallyDraw()},r.prototype.FindIntersection=function(e,t){var n=!1,r=[t[0]-e[0],t[1]-e[1]],i=Math.sqrt(r[0]*r[0]+r[1]*r[1]);if(i<0)return!1;r[0]=r[0]/i,r[1]=r[1]/i;var s=this.Loop.Points[0],o=[(s[0]-e[0])/i,(s[1]-e[1])/i],u=[o[0]*r[0]+o[1]*r[1],o[1]*r[0]-o[0]*r[1]];for(var a=1;a<this.Loop.Points.length;++a){var f=this.Loop.Points[a];if(e==s||e==f)continue;var l=[(f[0]-e[0])/i,(f[1]-e[1])/i],c=[l[0]*r[0]+l[1]*r[1],l[1]*r[0]-l[0]*r[1]];if(c[1]>=0&&u[1]<=0||c[1]<=0&&u[1]>=0){var h=u[1]/(u[1]-c[1]),p=u[0]+h*(c[0]-u[0]);if(p>0&&p<=1){var d=[s[0]+h*(f[0]-s[0]),s[1]+h*(f[1]-s[1])];if(!n||p<n.k)n={Point:d,LoopIndex:a,k:p}}}s=f,o=l,u=c}return n&&this.Loop.Points.splice(n.LoopIndex,0,n.Point),n},r.prototype.IsPointInsideLoop=function(e,t){var n=0,r=this.Loop.Points[this.Loop.length-1];for(var i=0;i<this.Loop.length;++i){var s=this.Loop.Points[i],o=[r[0]-e,r[1]-t],u=[s[0]-e,s[1]-t],a=Math.sqrt(o[0]*o[0]+o[1]*o[1]),f=Math.sqrt(u[0]*u[0]+u[1]*u[1]);n+=Math.arcsin((o[0]*u[1]-o[1]*u[0])/(a*f))}return n>3.14||n<-3.14},r.prototype.ComputeArea=function(){var e=0,t=this.Loop.Points[0][0]-this.ActiveCenter[0],n=this.Loop.Points[0][1]-this.ActiveCenter[1];for(var r=1;r<this.Loop.Points.length;++r){var i=t,s=n;t=this.Loop.Points[r][0]-this.ActiveCenter[0],n=this.Loop.Points[r][1]-this.ActiveCenter[1],e+=t*s-i*n}return e<0&&(e=-e),e},SAM.LassoWidget=r})();(function(){"use strict";function e(e){this.Widget=e,this.Visible=!1,this.HideTimerId=0;var t=e.Layer.GetCanvasDiv(),n=this;this.ButtonDiv=$("<div>").appendTo(t).hide().css({position:"absolute","z-index":"1"}).mouseenter(function(){n.CancelHideTimer()}).mouseleave(function(){n.StartHideTimer()}),this.DeleteButton=$("<img>").appendTo(this.ButtonDiv).css({height:"20px"}).attr("src",SA.ImagePathUrl+"deleteSmall.png").click(function(){n.DeleteCallback()}),this.PropertiesButton=$("<img>").appendTo(this.ButtonDiv).css({height:"20px"}).attr("src",SA.ImagePathUrl+"Menu.jpg").click(function(){n.PropertiesCallback()}),this.HideCallback=undefined}e.prototype.SetHideCallback=function(e){this.HideCllback=e},e.prototype.DeleteCallback=function(){this.Widget.SetActive(!1),this.Hide(),this.Widget.Layer.EventuallyDraw(),this.Widget.Layer.RemoveWidget(this.Widget),RecordState()},e.prototype.PropertiesCallback=function(){this.Hide(),this.Widget.ShowPropertiesDialog()},e.prototype.Show=function(e,t){this.CancelHideTimer(),this.ButtonDiv.css({left:e+"px",top:t+"px"}).show()},e.prototype.Hide=function(){this.CancelHideTimer(),this.ButtonDiv.hide(),this.HideCallback&&this.HideCallback()},e.prototype.StartHideTimer=function(){if(!this.HideTimerId){var e=this;MOBILE_DEVICE?this.HideTimerId=setTimeout(function(){e.HideTimerCallback()},1500):this.HideTimerId=setTimeout(function(){e.HideTimerCallback()},800)}},e.prototype.CancelHideTimer=function(){this.HideTimerId&&(clearTimeout(this.HideTimerId),this.HideTimerId=0)},e.prototype.HideTimerCallback=function(){this.ButtonDiv.hide(),this.HideTimerId=0},SAM.WidgetPopup=e})();(function(){"use strict";function e(){SAM.Shape.call(this),this.Length=50,this.Width=1,this.Origin=[1e4,1e4],this.FillColor=[0,0,0],this.OutlineColor=[1,1,1],this.PointBuffer=[]}e.prototype=new SAM.Shape,e.prototype.destructor=function(){},e.prototype.UpdateBuffers=function(){this.PointBuffer=[];var e=[],t=this.Length*.5+.5,n=this.Width*.5+.5;this.Matrix=mat4.create(),mat4.identity(this.Matrix),this.PointBuffer.push(-n),this.PointBuffer.push(-n),this.PointBuffer.push(0),this.PointBuffer.push(-t),this.PointBuffer.push(-n),this.PointBuffer.push(0),this.PointBuffer.push(-t),this.PointBuffer.push(n),this.PointBuffer.push(0),this.PointBuffer.push(-n),this.PointBuffer.push(n),this.PointBuffer.push(0),this.PointBuffer.push(-n),this.PointBuffer.push(t),this.PointBuffer.push(0),this.PointBuffer.push(n),this.PointBuffer.push(t),this.PointBuffer.push(0),this.PointBuffer.push(n),this.PointBuffer.push(n),this.PointBuffer.push(0),this.PointBuffer.push(t),this.PointBuffer.push(n),this.PointBuffer.push(0),this.PointBuffer.push(t),this.PointBuffer.push(-n),this.PointBuffer.push(0),this.PointBuffer.push(n),this.PointBuffer.push(-n),this.PointBuffer.push(0),this.PointBuffer.push(n),this.PointBuffer.push(-t),this.PointBuffer.push(0),this.PointBuffer.push(-n),this.PointBuffer.push(-t),this.PointBuffer.push(0),this.PointBuffer.push(-n),this.PointBuffer.push(-n),this.PointBuffer.push(0),e.push(1),e.push(2),e.push(7),e.push(1),e.push(7),e.push(8),e.push(4),e.push(5),e.push(10),e.push(4),e.push(10),e.push(11),GL&&(this.VertexPositionBuffer=GL.createBuffer(),GL.bindBuffer(GL.ARRAY_BUFFER,this.VertexPositionBuffer),GL.bufferData(GL.ARRAY_BUFFER,new Float32Array(this.PointBuffer),GL.STATIC_DRAW),this.VertexPositionBuffer.itemSize=3,this.VertexPositionBuffer.numItems=this.PointBuffer.length/3,this.CellBuffer=GL.createBuffer(),GL.bindBuffer(GL.ELEMENT_ARRAY_BUFFER,this.CellBuffer),GL.bufferData(GL.ELEMENT_ARRAY_BUFFER,new Uint16Array(e),GL.STATIC_DRAW),this.CellBuffer.itemSize=1,this.CellBuffer.numItems=e.length)},SAM.CrossHairs=e})();(function(){"use strict";function e(){SAM.Shape.call(this),this.Width=10,this.Length=50,this.Orientation=45,this.Origin=[1e4,1e4],this.OutlineColor=[0,0,0],this.ZOffset=-0.1}e.prototype=new SAM.Shape,e.prototype.destructor=function(){},e.prototype.PointInShape=function(e,t){var n=-(this.Orientation*Math.PI/180),r=Math.cos(n),i=Math.sin(n),s=e*r+t*i,o=-e*i+t*r;n=this.Width/2;if(s>0&&s<this.Length*1.3&&o<n*3&&o>-n*3)return!0},e.prototype.UpdateBuffers=function(){this.PointBuffer=[];var e=[],t=this.Width*.5,n=this.Width*2;this.Matrix=mat4.create(),mat4.identity(this.Matrix),this.PointBuffer.push(0),this.PointBuffer.push(0),this.PointBuffer.push(0),this.PointBuffer.push(n),this.PointBuffer.push(this.Width),this.PointBuffer.push(0),this.PointBuffer.push(n),this.PointBuffer.push(t),this.PointBuffer.push(0),this.PointBuffer.push(this.Length),this.PointBuffer.push(t),this.PointBuffer.push(0),this.PointBuffer.push(this.Length),this.PointBuffer.push(-t),this.PointBuffer.push(0),this.PointBuffer.push(n),this.PointBuffer.push(-t),this.PointBuffer.push(0),this.PointBuffer.push(n),this.PointBuffer.push(-this.Width),this.PointBuffer.push(0),this.PointBuffer.push(0),this.PointBuffer.push(0),this.PointBuffer.push(0),GL&&(e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(5),e.push(0),e.push(5),e.push(6),e.push(2),e.push(3),e.push(4),e.push(2),e.push(4),e.push(5),this.VertexPositionBuffer=GL.createBuffer(),GL.bindBuffer(GL.ARRAY_BUFFER,this.VertexPositionBuffer),GL.bufferData(GL.ARRAY_BUFFER,new Float32Array(this.PointBuffer),GL.STATIC_DRAW),this.VertexPositionBuffer.itemSize=3,this.VertexPositionBuffer.numItems=this.PointBuffer.length/3,this.CellBuffer=GL.createBuffer(),GL.bindBuffer(GL.ELEMENT_ARRAY_BUFFER,this.CellBuffer),GL.bufferData(GL.ELEMENT_ARRAY_BUFFER,new Uint16Array(e),GL.STATIC_DRAW),this.CellBuffer.itemSize=1,this.CellBuffer.numItems=e.length)},SAM.Arrow=e})();(function(){"use strict";function u(t,n){if(t==null)return null;this.Viewer=t,this.Shape=new Arrow,this.Shape.Origin=[0,0],this.Shape.SetFillColor([0,0,0]),this.Shape.OutlineColor=[1,1,1],this.Shape.Length=50,this.Shape.Width=8,this.TipPosition=[0,0],this.TipOffset=[0,0];if(t){t.AddWidget(this);if(n&&t){this.State=e,this.Viewer.ActivateWidget(this);return}}this.State=i}function f(){var e=a;if(!e)return;var t=document.getElementById("arrowcolor").value;e.Shape.SetFillColor(t),e!=null&&e.SetActive(!1),eventuallyRender()}function l(){var e=a;e!=null&&e.SetActive(!1)}function c(){var e=a;e!=null&&(viewer.ActiveWidget=null,e.RemoveFromViewer(),eventuallyRender())}var e=0,t=1,n=2,r=3,i=4,s=5,o=6;u.prototype.Draw=function(e){this.Shape.Draw(e)},u.prototype.RemoveFromViewer=function(){this.Viewer&&this.Viewer.RemoveWidget(this)},u.prototype.Serialize=function(){if(this.Shape===undefined)return null;var e=new Object;return e.type="arrow",e.origin=this.Shape.Origin,e.fillcolor=this.Shape.FillColor,e.outlinecolor=this.Shape.OutlineColor,e.length=this.Shape.Length,e.width=this.Shape.Width,e.orientation=this.Shape.Orientation,e.fixedsize=this.Shape.FixedSize,e.fixedorientation=this.Shape.FixedOrientation,e},u.prototype.Load=function(e){this.Shape.Origin=[parseFloat(e.origin[0]),parseFloat(e.origin[1])],this.Shape.FillColor=[parseFloat(e.fillcolor[0]),parseFloat(e.fillcolor[1]),parseFloat(e.fillcolor[2])],this.Shape.OutlineColor=[parseFloat(e.outlinecolor[0]),parseFloat(e.outlinecolor[1]),parseFloat(e.outlinecolor[2])],this.Shape.Length=parseFloat(e.length),this.Shape.Width=parseFloat(e.width),this.Shape.Orientation=parseFloat(e.orientation),e.fixedsize===undefined?this.Shape.FixedSize=!0:this.Shape.FixedSize=e.fixedsize=="true",e.fixedorientation===undefined?this.Shape.FixedOrientation=!0:this.Shape.FixedOrientation=e.fixedorientation=="true",this.Shape.UpdateBuffers()},u.prototype.SetFixedSize=function(e){if(this.Shape.FixedSize==e)return;var t=this.Viewer.GetPixelsPerUnit();e?(this.Shape.Length*=t,this.Shape.Width*=t):(this.Shape.Length/=t,this.Shape.Width/=t),this.Shape.FixedSize=e,this.Shape.UpdateBuffers(),eventuallyRender()},u.prototype.HandleKeyPress=function(e,t){},u.prototype.HandleMouseDown=function(n){if(n.which!=1)return;this.State==e&&(this.TipPosition=[this.Viewer.MouseX,this.Viewer.MouseY],this.State=r);if(this.State==s)if(this.ActiveTail)this.TipPosition=this.Viewer.ConvertPointWorldToViewer(this.Shape.Origin[0],this.Shape.Origin[1]),this.State=r;else{var i=this.Viewer.ConvertPointWorldToViewer(this.Shape.Origin[0],this.Shape.Origin[1]);this.TipOffset[0]=i[0]-this.Viewer.MouseX,this.TipOffset[1]=i[1]-this.Viewer.MouseY,this.State=t}},u.prototype.HandleMouseUp=function(e){this.State==s&&e.which==3?(this.State=o,this.ShowPropertiesDialog()):this.State!=o&&this.SetActive(!1)},u.prototype.HandleMouseMove=function(n){var o=this.Viewer.MouseX,u=this.Viewer.MouseY;if(this.Viewer.MouseDown==0&&this.State==s){this.CheckActive(n);return}if(this.State==e||this.State==t){var a=this.Viewer.GetViewport();this.Shape.Origin=this.Viewer.ConvertPointViewerToWorld(o+this.TipOffset[0],u+this.TipOffset[1]),eventuallyRender()}if(this.State==r){var f=o-this.TipPosition[0],l=u-this.TipPosition[1];if(!this.Shape.FixedSize){var c=this.Viewer.GetPixelsPerUnit();f/=c,l/=c}this.Shape.Length=Math.sqrt(f*f+l*l),this.Shape.Orientation=Math.atan2(l,f)*180/Math.PI,this.Shape.UpdateBuffers(),eventuallyRender()}this.State==i&&this.CheckActive(n)},u.prototype.CheckActive=function(e){var t=this.Viewer.GetViewport(),n=this.Viewer.MainView.Camera,r=n.Matrix,i=this.Shape.Origin[0],s=this.Shape.Origin[1],o=i*r[3]+s*r[7]+r[15],u=(i*r[0]+s*r[4]+r[12])/o,a=(i*r[1]+s*r[5]+r[13])/o;u=(u+1)*.5*t[2]+t[0],a=(a+1)*.5*t[3]+t[1],i=this.Viewer.MouseX-u,s=this.Viewer.MouseY-a;var f=this.Shape.Orientation*Math.PI/180,l=Math.cos(f),c=Math.sin(f);u=i*l+s*c,a=-i*c+s*l;var h=this.Shape.Length,p=this.Shape.Width/2;if(!this.Shape.FixedSize){var d=this.Viewer.GetPixelsPerUnit();h*=d,p*=d}return this.ActiveTail=!1,u>0&&u<h&&a>-p&&a<p?(this.SetActive(!0),u>h-p&&(this.ActiveTail=!0),!0):(this.SetActive(!1),!1)},u.prototype.GetActive=function(){return this.State==i?!1:!0},u.prototype.SetActive=function(e){if(e==this.GetActive())return;e?(this.State=s,this.Shape.Active=!0,this.Viewer.ActivateWidget(this),eventuallyRender()):(this.State=i,this.Shape.Active=!1,this.Viewer.DeactivateWidget(this),eventuallyRender())};var a;u.prototype.ShowPropertiesDialog=function(){var e=document.getElementById("arrowcolor");e.value=SAM.ConvertColorToHex(this.Shape.FillColor);var t=document.getElementById("ArrowLength");a=this,$("#arrow-properties-dialog").dialog("open")},u.prototype.SetColor=function(e){this.Shape.SetFillColor(e),eventuallyRender()},SAM.ArrowWidget=u})();(function(){"use strict";function e(){SAM.Shape.call(this),this.Radius=10,this.Origin=[1e4,1e4],this.OutlineColor=[0,0,0],this.PointBuffer=[]}e.prototype=new SAM.Shape,e.prototype.destructor=function(){},e.prototype.UpdateBuffers=function(){this.PointBuffer=[];var e=[],t=[],n=Math.floor(this.Radius/2)+10;if(n>50||!this.FixedSize)n=50;this.Matrix=mat4.create(),mat4.identity(this.Matrix);if(GL)if(this.LineWidth==0){for(var r=0;r<=n;++r){var i=r*2*3.14159265359/n;this.PointBuffer.push(this.Radius*Math.cos(i)),this.PointBuffer.push(this.Radius*Math.sin(i)),this.PointBuffer.push(0)}for(var r=2;r<n;++r)e.push(0),e.push(r-1),e.push(r);this.VertexPositionBuffer=GL.createBuffer(),GL.bindBuffer(GL.ARRAY_BUFFER,this.VertexPositionBuffer),GL.bufferData(GL.ARRAY_BUFFER,new Float32Array(this.PointBuffer),GL.STATIC_DRAW),this.VertexPositionBuffer.itemSize=3,this.VertexPositionBuffer.numItems=this.PointBuffer.length/3,this.CellBuffer=GL.createBuffer(),GL.bindBuffer(GL.ELEMENT_ARRAY_BUFFER,this.CellBuffer),GL.bufferData(GL.ELEMENT_ARRAY_BUFFER,new Uint16Array(e),GL.STATIC_DRAW),this.CellBuffer.itemSize=1,this.CellBuffer.numItems=e.length}else{var s=this.Radius,o=this.Radius+this.LineWidth;for(var r=0;r<=n;++r){var i=r*2*3.14159265359/n;this.PointBuffer.push(s*Math.cos(i)),this.PointBuffer.push(s*Math.sin(i)),this.PointBuffer.push(0),this.PointBuffer.push(o*Math.cos(i)),this.PointBuffer.push(o*Math.sin(i)),this.PointBuffer.push(0)}this.VertexPositionBuffer=GL.createBuffer(),GL.bindBuffer(GL.ARRAY_BUFFER,this.VertexPositionBuffer),GL.bufferData(GL.ARRAY_BUFFER,new Float32Array(this.PointBuffer),GL.STATIC_DRAW),this.VertexPositionBuffer.itemSize=3,this.VertexPositionBuffer.numItems=this.PointBuffer.length/3;for(var r=2;r<n;++r)e.push(0),e.push((r-1)*2),e.push(r*2);this.CellBuffer=GL.createBuffer(),GL.bindBuffer(GL.ELEMENT_ARRAY_BUFFER,this.CellBuffer),GL.bufferData(GL.ELEMENT_ARRAY_BUFFER,new Uint16Array(e),GL.STATIC_DRAW),this.CellBuffer.itemSize=1,this.CellBuffer.numItems=e.length;for(var r=0;r<n;++r)t.push(0+r*2),t.push(1+r*2),t.push(2+r*2),t.push(1+r*2),t.push(3+r*2),t.push(2+r*2);this.LineCellBuffer=GL.createBuffer(),GL.bindBuffer(GL.ELEMENT_ARRAY_BUFFER,this.LineCellBuffer),GL.bufferData(GL.ELEMENT_ARRAY_BUFFER,new Uint16Array(t),GL.STATIC_DRAW),this.LineCellBuffer.itemSize=1,this.LineCellBuffer.numItems=t.length}else for(var r=0;r<=n;++r){var i=r*2*3.14159265359/n;this.PointBuffer.push(this.Radius*Math.cos(i)),this.PointBuffer.push(this.Radius*Math.sin(i)),this.PointBuffer.push(0)}},SAM.Circle=e})();(function(){"use strict";function u(t,n){var r=this;this.Dialog=new SAM.Dialog(function(){r.DialogApplyCallback()}),this.Dialog.Title.text("Circle Annotation Editor"),this.Dialog.Body.css({margin:"1em 2em"}),this.Dialog.ColorDiv=$("<div>").css({height:"24px"}).appendTo(this.Dialog.Body).addClass("sa-view-annotation-modal-div"),this.Dialog.ColorLabel=$("<div>").appendTo(this.Dialog.ColorDiv).text("Color:").addClass("sa-view-annotation-modal-input-label"),this.Dialog.ColorInput=$('<input type="color">').appendTo(this.Dialog.ColorDiv).val("#30ff00").addClass("sa-view-annotation-modal-input"),this.Dialog.LineWidthDiv=$("<div>").appendTo(this.Dialog.Body).addClass("sa-view-annotation-modal-div"),this.Dialog.LineWidthLabel=$("<div>").appendTo(this.Dialog.LineWidthDiv).text("Line Width:").addClass("sa-view-annotation-modal-input-label"),this.Dialog.LineWidthInput=$('<input type="number">').appendTo(this.Dialog.LineWidthDiv).addClass("sa-view-annotation-modal-input").keypress(function(e){return e.keyCode!=13}),this.Dialog.AreaDiv=$("<div>").appendTo(this.Dialog.Body).addClass("sa-view-annotation-modal-div"),this.Dialog.AreaLabel=$("<div>").appendTo(this.Dialog.AreaDiv).text("Area:").addClass("sa-view-annotation-modal-input-label"),this.Dialog.Area=$("<div>").appendTo(this.Dialog.AreaDiv).addClass("sa-view-annotation-modal-input");if(localStorage.CircleWidgetDefaults){var s=JSON.parse(localStorage.CircleWidgetDefaults);s.Color&&this.Dialog.ColorInput.val(SAM.ConvertColorToHex(s.Color)),s.LineWidth&&this.Dialog.LineWidthInput.val(s.LineWidth)}this.Tolerance=.05,MOBILE_DEVICE&&(this.Tolerance=.1);if(t==null)return;this.CreationCamera=t.GetCamera().Serialize(),this.Layer=t,this.Popup=new SAM.WidgetPopup(this);var o=t.GetCamera(),u=t.GetViewport();this.Shape=new SAM.Circle,this.Shape.Origin=[0,0],this.Shape.OutlineColor=[0,0,0],this.Shape.SetOutlineColor(this.Dialog.ColorInput.val()),this.Shape.Radius=50*o.Height/u[3],this.Shape.LineWidth=5*o.Height/u[3],this.Shape.FixedSize=!1,this.Layer.AddWidget(this);if(n){this.State=e,this.Layer.ActivateWidget(this);return}this.State=i}var e=0,t=1,n=2,r=3,i=4,s=5,o=6;u.prototype.Draw=function(t){this.State!=e&&this.Shape.Draw(t)},u.prototype.Serialize=function(){if(this.Shape===undefined)return null;var e=new Object;return e.type="circle",e.origin=this.Shape.Origin,e.outlinecolor=this.Shape.OutlineColor,e.radius=this.Shape.Radius,e.linewidth=this.Shape.LineWidth,e.creation_camera=this.CreationCamera,e},u.prototype.Load=function(e){this.Shape.Origin[0]=parseFloat(e.origin[0]),this.Shape.Origin[1]=parseFloat(e.origin[1]),this.Shape.OutlineColor[0]=parseFloat(e.outlinecolor[0]),this.Shape.OutlineColor[1]=parseFloat(e.outlinecolor[1]),this.Shape.OutlineColor[2]=parseFloat(e.outlinecolor[2]),this.Shape.Radius=parseFloat(e.radius),this.Shape.LineWidth=parseFloat(e.linewidth),this.Shape.FixedSize=!1,this.Shape.UpdateBuffers(),e.creation_camera!==undefined&&(this.CreationCamera=e.CreationCamera)},u.prototype.HandleMouseWheel=function(e){return!1},u.prototype.HandleKeyDown=function(e){if(this.State==o)return!1;if(event.keyCode==67&&event.ctrlKey){var t={Type:"CircleWidget",Data:this.Serialize()};return localStorage.ClipBoard=JSON.stringify(t),!1}return!0},u.prototype.HandleDoubleClick=function(e){return ShowPropertiesDialog(),!1},u.prototype.HandleMouseDown=function(e){if(e.which!=1)return!1;var i=this.Layer.GetCamera();return this.State==t&&(this.OriginViewer=i.ConvertPointWorldToViewer(this.Shape.Origin[0],this.Shape.Origin[1]),this.State=r),this.State==s&&(this.NormalizedActiveDistance<.5?this.State=n:(this.OriginViewer=i.ConvertPointWorldToViewer(this.Shape.Origin[0],this.Shape.Origin[1]),this.State=r)),!1},u.prototype.HandleMouseUp=function(e){if(this.State==n||this.State==r)this.SetActive(!1),RecordState();return!1},u.prototype.HandleMouseMove=function(o){var u=o.offsetX,a=o.offsetY;if(o.which==0&&this.State==s)return this.SetActive(this.CheckActive(o)),!1;var f=this.Layer.GetCamera();this.State==e&&(this.State=t);if(this.State==t||this.State==n)SA&&SA.notesWidget&&SA.notesWidget.MarkAsModified(),this.Shape.Origin=f.ConvertPointViewerToWorld(u,a),this.PlacePopup(),this.Layer.EventuallyDraw();if(this.State==r){var l=this.Layer.GetViewport(),f=this.Layer.GetCamera(),c=u-this.OriginViewer[0],h=a-this.OriginViewer[1];this.Shape.Radius=Math.sqrt(c*c+h*h)*f.Height/l[3],this.Shape.UpdateBuffers(),SA&&SA.notesWidget&&SA.notesWidget.MarkAsModified(),this.PlacePopup(),this.Layer.EventuallyDraw()}return this.State==i&&this.CheckActive(o),!1},u.prototype.HandleTouchPan=function(e){var t=this.Layer.GetCamera();w0=t.ConvertPointViewerToWorld(this.Layer.LastMouseX,this.Layer.LastMouseY),w1=t.ConvertPointViewerToWorld(e.offsetX,e.offsetY);var n=w1[0]-w0[0],r=w1[1]-w0[1];return this.Shape.Origin[0]+=n,this.Shape.Origin[1]+=r,this.Layer.EventuallyDraw(),!1},u.prototype.HandleTouchPinch=function(e){return this.Shape.Radius*=e.PinchScale,this.Shape.UpdateBuffers(),SA&&SA.notesWidget&&SA.notesWidget.MarkAsModified(),this.Layer.EventuallyDraw(),!1},u.prototype.HandleTouchEnd=function(e){return this.SetActive(!1),!1},u.prototype.CheckActive=function(n){if(this.State==e||this.State==t)return!0;var r=n.offsetX,i=n.offsetY;this.FixedSize?(r=n.offsetX-this.Shape.Origin[0],i=n.offsetY-this.Shape.Origin[1]):(r=n.worldX-this.Shape.Origin[0],i=n.worldY-this.Shape.Origin[1]);var s=Math.sqrt(r*r+i*i)/this.Shape.Radius,o=!1,u=this.Shape.LineWidth/this.Shape.Radius;this.NormalizedActiveDistance=s;if(this.Shape.FillColor==undefined){if(s<1+this.Tolerance+u&&s>1-this.Tolerance||s<this.Tolerance+u)o=!0}else if(s<1+this.Tolerance+u&&s>this.Tolerance+u||s<u)o=!0;return o},u.prototype.GetActive=function(){return this.State==i?!1:!0},u.prototype.Deactivate=function(){if(this.State==e){this.Layer.RemoveWidget(this);return}this.Popup.StartHideTimer(),this.State=i,this.Shape.Active=!1,this.Layer.DeactivateWidget(this),this.DeactivateCallback&&this.DeactivateCallback(),this.Layer.EventuallyDraw()},u.prototype.SetActive=function(e){if(e==this.GetActive())return;e?(this.State=s,this.Shape.Active=!0,this.Layer.ActivateWidget(this),this.Layer.EventuallyDraw(),this.PlacePopup()):this.Deactivate(),this.Layer.EventuallyDraw()},u.prototype.PlacePopup=function(){var e=this.Layer.GetCamera(),t=e.Roll,n=this.Shape.Origin[0]+.8*this.Shape.Radius*(Math.cos(t)-Math.sin(t)),r=this.Shape.Origin[1]-.8*this.Shape.Radius*(Math.cos(t)+Math.sin(t)),i=e.ConvertPointWorldToViewer(n,r);this.Popup.Show(i[0],i[1])};var a;u.prototype.ShowPropertiesDialog=function(){this.Dialog.ColorInput.val(SAM.ConvertColorToHex(this.Shape.OutlineColor)),this.Dialog.LineWidthInput.val(this.Shape.LineWidth.toFixed(2));var e=2*Math.PI*this.Shape.Radius*this.Shape.Radius*.25*.25,t="";this.Shape.FixedSize?(t+=e.toFixed(2),t+=" pixels^2"):e>1e6?(t+=(e/1e6).toFixed(2),t+=" mm^2"):(t+=e.toFixed(2),t+=" um^2"),this.Dialog.Area.text(t),this.Dialog.Show(!0)},u.prototype.DialogApplyCallback=function(){var e=this.Dialog.ColorInput.val();this.Shape.SetOutlineColor(e),this.Shape.LineWidth=parseFloat(this.Dialog.LineWidthInput.val()),this.Shape.UpdateBuffers(),this.SetActive(!1),RecordState(),this.Layer.EventuallyDraw(),localStorage.CircleWidgetDefaults=JSON.stringify({Color:e,LineWidth:this.Shape.LineWidth}),SA&&SA.notesWidget&&SA.notesWidget.MarkAsModified()},SAM.CircleWidget=u})();(function(){"use strict";function o(){SAM.Shape.call(this),this.Width=20,this.Length=50,this.Radius=60,this.Orientation=90,this.Origin=[1e4,1e4],this.OutlineColor=[0,0,0],this.PointBuffer=[]}function u(t,n){this.Dialog=new SAM.Dialog(this),this.Dialog.Title.text("Rect Annotation Editor"),this.Dialog.ColorDiv=$("<div>").appendTo(this.Dialog.Body).css({display:"table-row"}),this.Dialog.ColorLabel=$("<div>").appendTo(this.Dialog.ColorDiv).text("Color:").css({display:"table-cell","text-align":"left"}),this.Dialog.ColorInput=$('<input type="color">').appendTo(this.Dialog.ColorDiv).val("#30ff00").css({display:"table-cell"}),this.Dialog.LineWidthDiv=$("<div>").appendTo(this.Dialog.Body).css({display:"table-row"}),this.Dialog.LineWidthLabel=$("<div>").appendTo(this.Dialog.LineWidthDiv).text("Line Width:").css({display:"table-cell","text-align":"left"}),this.Dialog.LineWidthInput=$('<input type="number">').appendTo(this.Dialog.LineWidthDiv).css({display:"table-cell"}).keypress(function(e){return e.keyCode!=13}),this.Dialog.AreaDiv=$("<div>").appendTo(this.Dialog.Body).css({display:"table-row"}),this.Dialog.AreaLabel=$("<div>").appendTo(this.Dialog.AreaDiv).text("Area:").css({display:"table-cell","text-align":"left"}),this.Dialog.Area=$("<div>").appendTo(this.Dialog.AreaDiv).css({display:"table-cell"});if(localStorage.RectWidgetDefaults){var i=JSON.parse(localStorage.RectWidgetDefaults);i.Color&&this.Dialog.ColorInput.val(SAM.ConvertColorToHex(i.Color)),i.LineWidth&&this.Dialog.LineWidthInput.val(i.LineWidth)}this.Tolerance=.05,MOBILE_DEVICE&&(this.Tolerance=.1);if(t===null)return;this.CreationCamera=t.GetCamera().Serialize(),this.Viewer=t,this.Popup=new SAM.WidgetPopup(this);var s=t.MainView.Camera,u=t.MainView.Viewport;this.Shape=new o,this.Shape.Origin=[0,0],this.Shape.OutlineColor=[0,0,0],this.Shape.SetOutlineColor(this.Dialog.ColorInput.val()),this.Shape.Length=50*s.Height/u[3],this.Shape.Width=30*s.Height/u[3],this.Shape.Radius=50*s.Height/u[3],this.Shape.LineWidth=5*s.Height/u[3],this.Shape.FixedSize=!1,this.Viewer.AddWidget(this);if(n){this.State=e,this.Viewer.ActivateWidget(this);return}this.State=r}var e=0,t=1,n=2,r=3,i=4,s=5;o.prototype=new SAM.Shape,o.prototype.destructor=function(){},o.prototype.UpdateBuffers=function(){this.PointBuffer=[],this.Matrix=mat4.create(),mat4.identity(this.Matrix),mat4.rotateZ(this.Matrix,this.Orientation/180*3.14159),this.PointBuffer.push(1*this.Width/2),this.PointBuffer.push(1*this.Length/2),this.PointBuffer.push(0),this.PointBuffer.push(-1*this.Width/2),this.PointBuffer.push(1*this.Length/2),this.PointBuffer.push(0),this.PointBuffer.push(-1*this.Width/2),this.PointBuffer.push(-1*this.Length/2),this.PointBuffer.push(0),this.PointBuffer.push(1*this.Width/2),this.PointBuffer.push(-1*this.Length/2),this.PointBuffer.push(0),this.PointBuffer.push(1*this.Width/2),this.PointBuffer.push(1*this.Length/2),this.PointBuffer.push(0)},u.prototype.Draw=function(e){this.Shape.Draw(e)},u.prototype.RemoveFromViewer=function(){this.Viewer&&this.Viewer.RemoveWidget(this)},u.prototype.PasteCallback=function(e,t){this.Load(e),this.Shape.Origin=[t[0],t[1]],eventuallyRender()},u.prototype.Serialize=function(){if(this.Shape===undefined)return null;var e={};return e.type="rect",e.origin=this.Shape.Origin,e.outlinecolor=this.Shape.OutlineColor,e.radius=this.Shape.Radius,e.length=this.Shape.Length,e.width=this.Shape.Width,e.orientation=this.Shape.Orientation,e.linewidth=this.Shape.LineWidth,e.creation_camera=this.CreationCamera,e},u.prototype.Load=function(e){this.Shape.Origin[0]=parseFloat(e.origin[0]),this.Shape.Origin[1]=parseFloat(e.origin[1]),this.Shape.OutlineColor[0]=parseFloat(e.outlinecolor[0]),this.Shape.OutlineColor[1]=parseFloat(e.outlinecolor[1]),this.Shape.OutlineColor[2]=parseFloat(e.outlinecolor[2]),this.Shape.Radius=parseFloat(e.radius),this.Shape.Width=parseFloat(e.width),this.Shape.Length=parseFloat(e.length),this.Shape.Orientation=parseFloat(e.orientation),this.Shape.LineWidth=parseFloat(e.linewidth),this.Shape.FixedSize=!1,this.Shape.UpdateBuffers(),e.creation_camera!==undefined&&(this.CreationCamera=e.CreationCamera)},u.prototype.HandleKeyPress=function(e,t){if(this.State==s)return!1;if(event.keyCode==67&&event.ctrlKey){var n={Type:"RectWidget",Data:this.Serialize()};return localStorage.ClipBoard=JSON.stringify(n),!1}return!0},u.prototype.HandleDoubleClick=function(e){return!0},u.prototype.HandleMouseDown=function(r){return r.which!=1?!1:(this.State==e&&(this.OriginViewer=this.Viewer.ConvertPointWorldToViewer(this.Shape.Origin[0],this.Shape.Origin[1]),this.State=n),this.State==i&&(this.NormalizedActiveDistance<.5?this.State=t:(this.OriginViewer=this.Viewer.ConvertPointWorldToViewer(this.Shape.Origin[0],this.Shape.Origin[1]),this.State=n)),!0)},u.prototype.HandleMouseUp=function(e){if(this.State==t||this.State==n)this.SetActive(!1),RecordState()},u.prototype.HandleMouseMove=function(s){var o=s.offsetX,u=s.offsetY;if(s.which===0&&this.State==i){this.CheckActive(s);return}if(this.State==e||this.State==t)this.Shape.Origin=this.Viewer.ConvertPointViewerToWorld(o,u),this.PlacePopup(),eventuallyRender();if(this.State==n){var a=this.Viewer.GetViewport(),f=this.Viewer.MainView.Camera,l=o-this.OriginViewer[0],c=u-this.OriginViewer[1];this.Shape.Radius=Math.sqrt(l*l+c*c)*f.Height/a[3],this.Shape.UpdateBuffers(),this.PlacePopup(),eventuallyRender()}this.State==r&&this.CheckActive(s)},u.prototype.HandleMouseWheel=function(e){var t=e.offsetX,n=e.offsetY;if(this.State==i&&this.NormalizedActiveDistance<.5){var r=1.05,s=1;e.wheelDelta<0&&(r=.95,s=-1),e.shiftKey&&(this.Shape.Length=this.Shape.Length*r),e.ctrlKey&&(this.Shape.Width=this.Shape.Width*r),!e.shiftKey&&!e.ctrlKey&&(this.Shape.Orientation=this.Shape.Orientation+3*s),this.Shape.UpdateBuffers(),this.PlacePopup(),eventuallyRender()}},u.prototype.HandleTouchPan=function(e){w0=this.Viewer.ConvertPointViewerToWorld(EVENT_MANAGER.LastMouseX,EVENT_MANAGER.LastMouseY),w1=this.Viewer.ConvertPointViewerToWorld(e.offsetX,e.offsetY);var t=w1[0]-w0[0],n=w1[1]-w0[1];this.Shape.Origin[0]+=t,this.Shape.Origin[1]+=n,eventuallyRender()},u.prototype.HandleTouchPinch=function(e){this.Shape.Radius*=e.PinchScale,this.Shape.UpdateBuffers(),eventuallyRender()},u.prototype.HandleTouchEnd=function(e){this.SetActive(!1)},u.prototype.CheckActive=function(e){var t=e.offsetX,n=e.offsetY,r,i;this.FixedSize?(r=e.offsetX-this.Shape.Origin[0],i=e.offsetY-this.Shape.Origin[1]):(r=e.worldX-this.Shape.Origin[0],i=e.worldY-this.Shape.Origin[1]);var s=Math.sqrt(r*r+i*i)/this.Shape.Radius,o=!1,u=this.Shape.LineWidth/this.Shape.Radius;this.NormalizedActiveDistance=s;if(this.Shape.FillColor===undefined){if(s<1+this.Tolerance+u&&s>1-this.Tolerance||s<this.Tolerance+u)o=!0}else if(s<1+this.Tolerance+u&&s>this.Tolerance+u||s<u)o=!0;return this.SetActive(o),o},u.prototype.GetActive=function(){return this.State==r?!1:!0},u.prototype.Deactivate=function(){this.Popup.StartHideTimer(),this.State=r,this.Shape.Active=!1,this.Viewer.DeactivateWidget(this),this.DeactivateCallback&&this.DeactivateCallback(),eventuallyRender()},u.prototype.SetActive=function(e){if(e==this.GetActive())return;e?(this.State=i,this.Shape.Active=!0,this.Viewer.ActivateWidget(this),eventuallyRender(),this.PlacePopup()):this.Deactivate(),eventuallyRender()},u.prototype.PlacePopup=function(){var e=this.Viewer.GetCamera().Roll,t=this.Shape.Origin[0]+.8*this.Shape.Radius*(Math.cos(e)-Math.sin(e)),n=this.Shape.Origin[1]-.8*this.Shape.Radius*(Math.cos(e)+Math.sin(e)),r=this.Viewer.ConvertPointWorldToViewer(t,n);this.Popup.Show(r[0],r[1])};var a;u.prototype.ShowPropertiesDialog=function(){this.Dialog.ColorInput.val(SAM.ConvertColorToHex(this.Shape.OutlineColor)),this.Dialog.LineWidthInput.val(this.Shape.LineWidth.toFixed(2));var e=2*Math.PI*this.Shape.Radius*this.Shape.Radius*.25*.25,t="";this.Shape.FixedSize?(t+=e.toFixed(2),t+=" pixels^2"):e>1e6?(t+=(e/1e6).toFixed(2),t+=" mm^2"):(t+=e.toFixed(2),t+=" um^2"),this.Dialog.Area.text(t),this.Dialog.Show(!0)},u.prototype.DialogApplyCallback=function(){var e=this.Dialog.ColorInput.val();this.Shape.SetOutlineColor(e),this.Shape.LineWidth=parseFloat(this.Dialog.LineWidthInput.val()),this.Shape.UpdateBuffers(),this.SetActive(!1),RecordState(),eventuallyRender(),localStorage.RectWidgetDefaults=JSON.stringify({Color:e,LineWidth:this.Shape.LineWidth})},SAM.RectWidget=u})();(function(){"use strict";function l(){SAM.Shape.call(this),this.BinWidth=20,this.BinHeight=20,this.Dimensions=[10,8],this.Orientation=0,this.Origin=[1e4,1e4],this.OutlineColor=[0,0,0],this.PointBuffer=[],this.ActiveIndex=undefined}function c(e,n){var r=this;this.Dialog=new SAM.Dialog(function(){r.DialogApplyCallback()}),this.Dialog.Title.text("Grid Annotation Editor"),this.Dialog.BinWidthDiv=$("<div>").appendTo(this.Dialog.Body).css({display:"table-row"}),this.Dialog.BinWidthLabel=$("<div>").appendTo(this.Dialog.BinWidthDiv).text("Bin Width:").css({display:"table-cell","text-align":"left"}),this.Dialog.BinWidthInput=$("<input>").appendTo(this.Dialog.BinWidthDiv).css({display:"table-cell"}).keypress(function(e){return e.keyCode!=13}),this.Dialog.BinHeightDiv=$("<div>").appendTo(this.Dialog.Body).css({display:"table-row"}),this.Dialog.BinHeightLabel=$("<div>").appendTo(this.Dialog.BinHeightDiv).text("Bin Height:").css({display:"table-cell","text-align":"left"}),this.Dialog.BinHeightInput=$("<input>").appendTo(this.Dialog.BinHeightDiv).css({display:"table-cell"}).keypress(function(e){return e.keyCode!=13}),this.Dialog.RotationDiv=$("<div>").appendTo(this.Dialog.Body).css({display:"table-row"}),this.Dialog.RotationLabel=$("<div>").appendTo(this.Dialog.RotationDiv).text("Rotation:").css({display:"table-cell","text-align":"left"}),this.Dialog.RotationInput=$("<input>").appendTo(this.Dialog.RotationDiv).css({display:"table-cell"}).keypress(function(e){return e.keyCode!=13}),this.Dialog.ColorDiv=$("<div>").appendTo(this.Dialog.Body).css({display:"table-row"}),this.Dialog.ColorLabel=$("<div>").appendTo(this.Dialog.ColorDiv).text("Color:").css({display:"table-cell","text-align":"left"}),this.Dialog.ColorInput=$('<input type="color">').appendTo(this.Dialog.ColorDiv).val("#30ff00").css({display:"table-cell"}),this.Dialog.LineWidthDiv=$("<div>").appendTo(this.Dialog.Body).css({display:"table-row"}),this.Dialog.LineWidthLabel=$("<div>").appendTo(this.Dialog.LineWidthDiv).text("Line Width:").css({display:"table-cell","text-align":"left"}),this.Dialog.LineWidthInput=$('<input type="number">').appendTo(this.Dialog.LineWidthDiv).css({display:"table-cell"}).keypress(function(e){return e.keyCode!=13}),this.Tolerance=.05,MOBILE_DEVICE&&(this.Tolerance=.1);if(e===null)return;this.CreationCamera=e.GetCamera().Serialize(),this.Layer=e,this.Popup=new SAM.WidgetPopup(this);var i=e.AnnotationView.Camera,s=e.AnnotationView.Viewport;this.Grid=new l,this.Grid.Origin=[0,0],this.Grid.OutlineColor=[0,0,0],this.Grid.SetOutlineColor("#0A0F7A"),e.ScaleWidget?this.Grid.BinWidth=e.ScaleWidget.LengthWorld:this.Grid.BinWidth=30*i.Height/s[3],this.Grid.BinHeight=this.Grid.BinWidth,this.Grid.LineWidth=2*i.Height/s[3],this.Grid.FixedSize=!1;var o=.8*s[2]/e.GetPixelsPerUnit();this.Grid.Dimensions[0]=Math.floor(o/this.Grid.BinWidth);var u=.8*s[3]/e.GetPixelsPerUnit();this.Grid.Dimensions[1]=Math.floor(u/this.Grid.BinHeight),this.Grid.UpdateBuffers(),this.Text=new SAM.Text,this.Text.Position=this.Grid.Origin,this.Text.String=SAM.DistanceToString(this.Grid.BinWidth*2.5e-7),this.Text.Color=[0,0,.5],this.Text.Anchor=[0,0],this.Text.UpdateBuffers();if(localStorage.GridWidgetDefaults){var a=JSON.parse(localStorage.GridWidgetDefaults);a.Color&&(this.Dialog.ColorInput.val(SAM.ConvertColorToHex(a.Color)),this.Grid.SetOutlineColor(this.Dialog.ColorInput.val())),a.LineWidth!=undefined&&(this.Dialog.LineWidthInput.val(a.LineWidth),this.Grid.LineWidth==a.LineWidth)}this.Layer.AddWidget(this),this.State=t}var e=0,t=3,n=4,r=5,i=6,s=7,o=8,u=9,a=10,f=11;l.prototype=new SAM.Shape,l.prototype.destructor=function(){},l.prototype.UpdateBuffers=function(){this.PointBuffer=[],this.Matrix=mat4.create(),mat4.identity(this.Matrix);if(this.Dimensions[0]<1||this.Dimensions[1]<1||this.BinWidth<=0||this.BinHeight<=0)return;var e=this.BinWidth*this.Dimensions[0],t=this.BinHeight*this.Dimensions[1],n=e/2,r=t/2,i=this.Dimensions[1]%2?0:e,s=0;this.PointBuffer.push(i-n),this.PointBuffer.push(s-r),this.PointBuffer.push(0);for(var o=0;o<this.Dimensions[1];++o)i=i?0:e,this.PointBuffer.push(i-n),this.PointBuffer.push(s-r),this.PointBuffer.push(0),s+=this.BinHeight,this.PointBuffer.push(i-n),this.PointBuffer.push(s-r),this.PointBuffer.push(0);i=i?0:e,this.PointBuffer.push(i-n),this.PointBuffer.push(s-r),this.PointBuffer.push(0);for(var o=0;o<this.Dimensions[0];++o)s=s?0:t,this.PointBuffer.push(i-n),this.PointBuffer.push(s-r),this.PointBuffer.push(0),i+=this.BinWidth,this.PointBuffer.push(i-n),this.PointBuffer.push(s-r),this.PointBuffer.push(0);s=s?0:t,this.PointBuffer.push(i-n),this.PointBuffer.push(s-r),this.PointBuffer.push(0)},c.prototype.ComputeCorner=function(e,t,n,r){var i=this.Grid.BinWidth*this.Grid.Dimensions[0]/2,s=this.Grid.BinHeight*this.Grid.Dimensions[1]/2;i+=n,s+=r;var o=this.Grid.Origin[0],u=this.Grid.Origin[1],a=(this.Layer.GetCamera().GetRotation()-this.Grid.Orientation)/90;a=Math.round(a),a=(a%4+4)%4;var f=Math.cos(3.14156*this.Grid.Orientation/180),l=Math.sin(3.14156*this.Grid.Orientation/180),c,h;return a==0?(c=e*i,h=t*s):a==3?(c=e*i,h=-t*s):a==2?(c=-e*i,h=-t*s):a==1&&(c=-e*i,h=t*s),o=o+f*c+l*h,u=u+f*h-l*c,[o,u]},c.prototype.Draw=function(e){this.Grid.Draw(e);var t=-(this.Grid.BinWidth*this.Grid.Dimensions[0]/2),n=-(this.Grid.BinHeight*this.Grid.Dimensions[1]/2);this.Text.Anchor=[0,20],this.Text.Orientation=this.Grid.Orientation-this.Layer.GetCamera().GetRotation(),this.Text.Orientation=(this.Text.Orientation%360+360)%360,this.Text.Orientation>90&&this.Text.Orientation<270&&(this.Text.Orientation-=180,this.Text.Anchor=[this.Text.PixelBounds[1],0]);var r=this.Grid.Orientation*Math.PI/180,i=Math.cos(r),s=Math.sin(r),o=i*t+s*n,u=i*n-s*t;this.Text.Position=[this.Grid.Origin[0]+o,this.Grid.Origin[1]+u],this.Text.Draw(e)},c.prototype.PasteCallback=function(e,t,n){this.Load(e);var r=this.Layer.GetCamera().GetRotation()-n.GetRotation();this.Grid.Orientation+=r,this.Grid.Origin=[t[0],t[1]],this.Text.Position=[t[0],t[1]],this.Layer.EventuallyDraw()},c.prototype.Serialize=function(){if(this.Grid===undefined)return null;var e={};return e.type="grid",e.origin=this.Grid.Origin,e.outlinecolor=this.Grid.OutlineColor,e.bin_width=this.Grid.BinWidth,e.bin_height=this.Grid.BinHeight,e.dimensions=this.Grid.Dimensions,e.orientation=this.Grid.Orientation,e.linewidth=this.Grid.LineWidth,e.creation_camera=this.CreationCamera,e},c.prototype.Load=function(e){this.Grid.Origin[0]=parseFloat(e.origin[0]),this.Grid.Origin[1]=parseFloat(e.origin[1]),this.Grid.OutlineColor[0]=parseFloat(e.outlinecolor[0]),this.Grid.OutlineColor[1]=parseFloat(e.outlinecolor[1]),this.Grid.OutlineColor[2]=parseFloat(e.outlinecolor[2]),e.width&&(this.Grid.BinWidth=parseFloat(e.width)),e.height&&(this.Grid.BinHeight=parseFloat(e.height)),e.bin_width&&(this.Grid.BinWidth=parseFloat(e.bin_width)),e.bin_height&&(this.Grid.BinHeight=parseFloat(e.bin_height)),this.Grid.Dimensions[0]=parseInt(e.dimensions[0]),this.Grid.Dimensions[1]=parseInt(e.dimensions[1]),this.Grid.Orientation=parseFloat(e.orientation),this.Grid.LineWidth=parseFloat(e.linewidth),this.Grid.FixedSize=!1,this.Grid.UpdateBuffers(),this.Text.String=SAM.DistanceToString(this.Grid.BinWidth*2.5e-7),this.Text.Position=this.Grid.Origin,this.Text.UpdateBuffers(),e.creation_camera!==undefined&&(this.CreationCamera=e.CreationCamera)},c.prototype.HandleKeyPress=function(e,t){if(this.State==r)return!1;if(event.keyCode==67&&event.ctrlKey){var n={Type:"GridWidget",Data:this.Serialize(),Camera:this.Layer.GetCamera().Serialize()};return localStorage.ClipBoard=JSON.stringify(n),!1}return!0},c.prototype.HandleDoubleClick=function(e){return!0},c.prototype.HandleMouseDown=function(e){if(e.which!=1)return!0;var t=this.Layer.GetCamera();return this.DragLast=t.ConvertPointViewerToWorld(e.offsetX,e.offsetY),!1},c.prototype.HandleMouseUp=function(e){return this.SetActive(!1),RecordState(),!0},c.prototype.HandleMouseMove=function(e){if(e.which==1){var t=this.Layer.GetCamera(),n=t.ConvertPointViewerToWorld(e.offsetX,e.offsetY),r,f;if(this.State==i)r=n[0]-this.DragLast[0],f=n[1]-this.DragLast[1],this.DragLast=n,this.Grid.Origin[0]+=r,this.Grid.Origin[1]+=f;else{r=n[0]-this.Grid.Origin[0],f=n[1]-this.Grid.Origin[1];var l=Math.cos(3.14156*this.Grid.Orientation/180),c=Math.sin(3.14156*this.Grid.Orientation/180),h=l*r-c*f,p=l*f+c*r;h=.5*this.Grid.Dimensions[0]+h/this.Grid.BinWidth,p=.5*this.Grid.Dimensions[1]+p/this.Grid.BinHeight;var d=Math.round(h),v=Math.round(p);r=f=0;var m=!1;this.State==o?(r=d-this.Grid.Dimensions[0],r&&(this.Grid.Dimensions[0]=d,r=.5*r*this.Grid.BinWidth,m=!0)):this.State==s?d&&(this.Grid.Dimensions[0]-=d,r=.5*d*this.Grid.BinWidth,m=!0):this.State==a?(f=v-this.Grid.Dimensions[1],f&&(this.Grid.Dimensions[1]=v,f=.5*f*this.Grid.BinHeight,m=!0)):this.State==u&&v&&(this.Grid.Dimensions[1]-=v,f=.5*v*this.Grid.BinHeight,m=!0),m&&(h=l*r+c*f,p=l*f-c*r,this.Grid.Origin[0]+=h,this.Grid.Origin[1]+=p,this.Grid.UpdateBuffers())}this.Layer.EventuallyDraw();return}return e.which==0&&this.SetActive(this.CheckActive(e)),!0},c.prototype.HandleMouseWheel=function(e){},c.prototype.HandleTouchPan=function(e){return!0},c.prototype.HandleTouchPinch=function(e){return!0},c.prototype.HandleTouchEnd=function(e){this.SetActive(!1)},c.prototype.CheckActive=function(e){var t,n;this.Grid.FixedSize?(t=e.offsetX,n=e.offsetY,pixelSize=1):(t=e.worldX,n=e.worldY),t-=this.Grid.Origin[0],n-=this.Grid.Origin[1];var r=Math.cos(3.14156*this.Grid.Orientation/180),i=Math.sin(3.14156*this.Grid.Orientation/180),s=r*t-i*n,o=r*n+i*t;t=.5*this.Grid.Dimensions[0]+s/this.Grid.BinWidth,n=.5*this.Grid.Dimensions[1]+o/this.Grid.BinHeight;var u=Math.round(t),a=Math.round(n);if(u<0||u>this.Grid.Dimensions[0]||a<0||a>this.Grid.Dimensions[1])return this.SetActive(!1),!1;t=(t-u)*this.Grid.BinWidth,n=(n-a)*this.Grid.BinHeight;var f=5/this.Layer.GetPixelsPerUnit();return Math.abs(t)<f||Math.abs(n)<f?(this.ActiveIndex=[u,a],!0):!1},c.prototype.GetActive=function(){return this.State==t?!1:!0},c.prototype.Deactivate=function(){this.Layer.AnnotationView.CanvasDiv.css({cursor:"default"}),this.Popup.StartHideTimer(),this.State=t,this.Grid.Active=!1,this.Layer.DeactivateWidget(this),this.DeactivateCallback&&this.DeactivateCallback(),this.Layer.EventuallyDraw()},c.prototype.SetActive=function(e){if(e){this.State=n,this.Grid.Active=!0;if(!this.ActiveIndex){console.log("No active index");return}this.ActiveIndex[0]==0?(this.State=s,this.Layer.AnnotationView.CanvasDiv.css({cursor:"col-resize"})):this.ActiveIndex[0]==this.Grid.Dimensions[0]?(this.State=o,this.Layer.AnnotationView.CanvasDiv.css({cursor:"col-resize"})):this.ActiveIndex[1]==0?(this.State=u,this.Layer.AnnotationView.CanvasDiv.css({cursor:"row-resize"})):this.ActiveIndex[1]==this.Grid.Dimensions[1]?(this.State=a,this.Layer.AnnotationView.CanvasDiv.css({cursor:"row-resize"})):(this.State=i,this.Layer.AnnotationView.CanvasDiv.css({cursor:"move"})),this.PlacePopup()}else this.Deactivate();this.Layer.EventuallyDraw()},c.prototype.PlacePopup=function(){var e=this.ComputeCorner(1,-1,0,0),t=this.Layer.GetCamera();e=t.ConvertPointWorldToViewer(e[0],e[1]),this.Popup.Show(e[0]+10,e[1]-30)};var h;c.prototype.ShowPropertiesDialog=function(){this.Dialog.ColorInput.val(SAM.ConvertColorToHex(this.Grid.OutlineColor)),this.Dialog.LineWidthInput.val(this.Grid.LineWidth.toFixed(2)),this.Dialog.BinWidthInput.val(SAM.DistanceToString(this.Grid.BinWidth*2.5e-7)),this.Dialog.BinHeightInput.val(SAM.DistanceToString(this.Grid.BinHeight*2.5e-7)),this.Dialog.RotationInput.val(this.Grid.Orientation),this.Dialog.Show(!0)},c.prototype.DialogApplyCallback=function(){var e=this.Dialog.ColorInput.val();this.Grid.SetOutlineColor(e),this.Grid.LineWidth=parseFloat(this.Dialog.LineWidthInput.val()),this.Grid.BinWidth=SAM.StringToDistance(this.Dialog.BinWidthInput.val())*4e6,this.Grid.BinHeight=SAM.StringToDistance(this.Dialog.BinHeightInput.val())*4e6,this.Grid.Orientation=parseFloat(this.Dialog.RotationInput.val()),this.Grid.UpdateBuffers(),this.SetActive(!1),this.Text.String=SAM.DistanceToString(this.Grid.BinWidth*2.5e-7),this.Text.UpdateBuffers(),RecordState(),this.Layer.EventuallyDraw(),localStorage.GridWidgetDefaults=JSON.stringify({Color:e,LineWidth:this.Grid.LineWidth})},SAM.GridWidget=c})();(function(){"use strict";function u(){SAM.Shape.call(this),this.BinLength=100,this.TickSize=6,this.NumberOfBins=1,this.Orientation=0,this.Origin=[1e4,1e4],this.OutlineColor=[0,0,0],this.PointBuffer=[],this.PositionCoordinateSystem=SAM.Shape.VIEWER}function a(e,n){var r=this;if(e===null)return;this.Layer=e,this.PixelsPerMeter=0,this.Shape=new u,this.Shape.OutlineColor=[0,0,0],this.Shape.Origin=[30,20],this.Shape.BinLength=200,this.Shape.FixedSize=!0,this.Text=new SAM.Text,this.Text.PositionCoordinateSystem=SAM.Shape.VIEWER,this.Text.Position=[30,5],this.Text.String="",this.Text.Color=[0,0,0],this.Text.Anchor=[20,0],this.Update(e.GetPixelsPerUnit()),this.State=t}var e=0,t=3,n=4,r=5,i=6,s=7,o=8;u.prototype=new SAM.Shape,u.prototype.destructor=function(){},u.prototype.UpdateBuffers=function(){this.PointBuffer=[],this.Matrix=mat4.create(),mat4.identity(this.Matrix);var e=0,t=this.TickSize;this.PointBuffer.push(e),this.PointBuffer.push(t),this.PointBuffer.push(0),t=0,this.PointBuffer.push(e),this.PointBuffer.push(t),this.PointBuffer.push(0);for(var n=0;n<this.NumberOfBins;++n)e+=this.BinLength,this.PointBuffer.push(e),this.PointBuffer.push(t),this.PointBuffer.push(0),t=this.TickSize,this.PointBuffer.push(e),this.PointBuffer.push(t),this.PointBuffer.push(0),t=0,this.PointBuffer.push(e),this.PointBuffer.push(t),this.PointBuffer.push(0)},a.prototype.Update=function(){var e=Math.round(this.Layer.GetPixelsPerUnit()/this.Layer.GetMetersPerUnit());if(this.PixelsPerMeter==e)return;this.PixelsPerMeter=e;var t=200,n=0,r=this.PixelsPerMeter;while(r>t)r/=10,--n;this.Units="nm";var i=1e-9;n>=-6&&(this.Units="µm",i=1e-6),n>=-3&&(this.Units="mm",i=.001),n>=-2&&(this.Units="cm",i=.01),n>=0&&(this.Units="m",i=1),n>=3&&(this.Units="km",i=1e3),this.Shape.BinLength=r,this.Shape.NumberOfBins=Math.floor(t/r);var s=r*this.Shape.NumberOfBins,o=s/this.PixelsPerMeter,u=Math.round(o/i);this.Label=u.toString()+this.Units,this.LengthWorld=o*4e6,this.Text.String=this.Label,this.Text.UpdateBuffers(),this.Text.Position=[this.Shape.Origin[0]+s/2,this.Shape.Origin[1]-15],this.Shape.UpdateBuffers()},a.prototype.Draw=function(e){this.Update(),this.Shape.Draw(e),this.Text.Draw(e)},a.prototype.HandleKeyPress=function(e,t){return!0},a.prototype.HandleDoubleClick=function(e){return!0},a.prototype.HandleMouseDown=function(e){return!1},a.prototype.HandleMouseUp=function(e){return!0},a.prototype.HandleMouseMove=function(e){return!0},a.prototype.HandleMouseWheel=function(e){},a.prototype.HandleTouchPan=function(e){return!0},a.prototype.HandleTouchPinch=function(e){return!0},a.prototype.HandleTouchEnd=function(e){this.SetActive(!1)},a.prototype.CheckActive=function(e){return this.SetActive(!1),!1},a.prototype.GetActive=function(){return this.State==t?!1:!0},a.prototype.Deactivate=function(){this.Layer.AnnotationView.CanvasDiv.css({cursor:"default"}),this.Popup.StartHideTimer(),this.State=t,this.Shape.Active=!1,this.Layer.DeactivateWidget(this),this.DeactivateCallback&&this.DeactivateCallback(),eventuallyRender()},a.prototype.SetActive=function(e){if(e==this.GetActive())return;e?(this.State=n,this.Shape.Active=!0,this.Layer.ActivateWidget(this),eventuallyRender(),this.PlacePopup()):this.Deactivate(),eventuallyRender()},SAM.ScaleWidget=a})();(function(){"use strict";function e(e,t){this.Viewer=t,this.Layer=t.AnnotationLayer;var n=layer.GetCamera(),r=n.GetFocalPoint(),i=n.Height/4;this.Bounds=[r[0]-i,r[0]+i,r[1]-i,r[1]+i],this.DragBounds=[r[0]-i,r[0]+i,r[1]-i,r[1]+i],layer.AddWidget(this),eventuallyRender(),this.Active=0;var s=this;this.Div=$("<div>").appendTo(e).addClass("sa-view-cutout-div"),$("<button>").appendTo(this.Div).text("Cancel").addClass("sa-view-cutout-button").click(function(){s.Cancel()}),$("<button>").appendTo(this.Div).text("Download").addClass("sa-view-cutout-button").click(function(){s.Accept()}),this.Select=$("<select>").appendTo(this.Div),$("<option>").appendTo(this.Select).attr("value",0).text("tif"),$("<option>").appendTo(this.Select).attr("value",1).text("jpeg"),$("<option>").appendTo(this.Select).attr("value",2).text("png"),$("<option>").appendTo(this.Select).attr("value",3).text("svs"),this.Label=$("<div>").addClass("sa-view-cutout-label").appendTo(this.Div),this.UpdateBounds(),this.HandleMouseUp()}e.prototype.Accept=function(){this.Deactivate();var e=["tif","jpeg","png","svs"],t=this.Viewer.GetCache().Image;window.location="/cutout/"+t.database+"/"+t._id+"/image."+e[this.Select.val()]+"?bounds="+JSON.stringify(this.Bounds)},e.prototype.Cancel=function(){this.Deactivate()},e.prototype.Serialize=function(){return!1},e.prototype.Draw=function(e){var t=[(this.DragBounds[0]+this.DragBounds[1])*.5,(this.DragBounds[2]+this.DragBounds[3])*.5],n=e.Camera,r=e.Viewport;if(GL)alert("webGL cutout not supported");else{var i=e.Context2d,n=e.Camera;i.save(),i.setTransform(1,0,0,1,0,0),this.DrawRectangle(i,this.Bounds,n,"#00A",1,0),this.DrawRectangle(i,this.DragBounds,n,"#000",2,this.Active),this.DrawCenter(i,t,n,"#000"),i.restore()}},e.prototype.DrawRectangle=function(e,t,n,r,i,s){var o=n.ConvertPointWorldToViewer(t[0],t[2]),u=n.ConvertPointWorldToViewer(t[1],t[2]),a=n.ConvertPointWorldToViewer(t[1],t[3]),f=n.ConvertPointWorldToViewer(t[0],t[3]);e.lineWidth=i,e.beginPath(),e.strokeStyle=s&4?"#FF0":r,e.moveTo(o[0],o[1]),e.lineTo(u[0],u[1]),e.stroke(),e.beginPath(),e.strokeStyle=s&2?"#FF0":r,e.moveTo(u[0],u[1]),e.lineTo(a[0],a[1]),e.stroke(),e.beginPath(),e.strokeStyle=s&8?"#FF0":r,e.moveTo(a[0],a[1]),e.lineTo(f[0],f[1]),e.stroke(),e.beginPath(),e.strokeStyle=s&1?"#FF0":r,e.moveTo(f[0],f[1]),e.lineTo(o[0],o[1]),e.stroke()},e.prototype.DrawCenter=function(e,t,n,r){var i=n.ConvertPointWorldToViewer(t[0],t[1]);e.strokeStyle=this.Active&16?"#FF0":r,e.lineWidth=1,e.beginPath(),e.moveTo(i[0]-5,i[1]),e.lineTo(i[0]+5,i[1]),e.moveTo(i[0],i[1]-5),e.lineTo(i[0],i[1]+5),e.stroke()},e.prototype.HandleKeyPress=function(e,t){return event.keyCode==67&&alert("Accept"),event.keyCode==67&&alert("Cancel"),!0},e.prototype.HandleDoubleClick=function(e){return!0},e.prototype.HandleMouseDown=function(e){return e.which!=1?!1:!0},e.prototype.HandleMouseUp=function(){if(this.Bounds[0]>this.Bounds[1]){var e=this.Bounds[0];this.Bounds[0]=this.Bounds[1],this.Bounds[1]=e}if(this.Bounds[2]>this.Bounds[3]){var e=this.Bounds[2];this.Bounds[2]=this.Bounds[3],this.Bounds[3]=e}this.DragBounds=this.Bounds.slice(0),eventuallyRender()},e.prototype.HandleMouseMove=function(e){var t=e.offsetX,n=e.offsetY;if(e.which==0){this.CheckActive(e);return}if(this.Active){var r=this.Layer.GetCamera(),i=r.ConvertPointViewerToWorld(e.offsetX,e.offsetY);this.Active&1&&(this.DragBounds[0]=i[0]),this.Active&2&&(this.DragBounds[1]=i[0]),this.Active&4&&(this.DragBounds[2]=i[1]),this.Active&8&&(this.DragBounds[3]=i[1]);if(this.Active&16){var s=i[0]-.5*(this.DragBounds[0]+this.DragBounds[1]),o=i[1]-.5*(this.DragBounds[2]+this.DragBounds[3]);this.DragBounds[0]+=s,this.DragBounds[1]+=s,this.DragBounds[2]+=o,this.DragBounds[3]+=o}return this.UpdateBounds(),eventuallyRender(),!0}return!1},e.prototype.UpdateBounds=function(e){var t=this.Viewer.GetCache(),n=t.Image.TileSize,r=[0,0,0,0];r[0]=Math.round(this.DragBounds[0]/n)*n,r[1]=Math.round(this.DragBounds[1]/n)*n,r[2]=Math.round(this.DragBounds[2]/n)*n,r[3]=Math.round(this.DragBounds[3]/n)*n;var i=t.Image.bounds;r[0]<i[0]&&(r[0]=i[0]),r[1]<i[0]&&(r[1]=i[0]),r[2]<i[2]&&(r[2]=i[2]),r[3]<i[2]&&(r[3]=i[2]),r[0]>i[1]&&(r[0]=i[1]),r[1]>i[1]&&(r[1]=i[1]),r[2]>i[3]&&(r[2]=i[3]),r[3]>i[3]&&(r[3]=i[3]),r[0]!=r[1]&&(this.Bounds[0]=r[0],this.Bounds[1]=r[1]),r[2]!=r[3]&&(this.Bounds[2]=r[2],this.Bounds[3]=r[3]);var s=[this.Bounds[1]-this.Bounds[0],this.Bounds[3]-this.Bounds[2]];this.Label.text(s[0]+" x "+s[1]+" = "+this.FormatPixels(s[0]*s[1])+"pixels")},e.prototype.FormatPixels=function(e){return e>1e9?Math.round(e/1e9)+"G":e>1e6?Math.round(e/1e6)+"M":e>1e3?Math.round(e/1e3)+"k":e},e.prototype.HandleTouchPan=function(e){},e.prototype.HandleTouchPinch=function(e){},e.prototype.HandleTouchEnd=function(e){},e.prototype.CheckActive=function(e){var t=this.Layer.GetCamera(),n=t.Height/200,r=t.ConvertPointViewerToWorld(e.offsetX,e.offsetY),i=0,s=this.DragBounds[0]-n<r[0]&&r[0]<this.DragBounds[1]+n,o=this.DragBounds[2]-n<r[1]&&r[1]<this.DragBounds[3]+n;o&&Math.abs(r[0]-this.DragBounds[0])<n&&(i|=1),o&&Math.abs(r[0]-this.DragBounds[1])<n&&(i|=2),s&&Math.abs(r[1]-this.DragBounds[2])<n&&(i|=4),s&&Math.abs(r[1]-this.DragBounds[3])<n&&(i|=8);var u=[(this.DragBounds[0]+this.DragBounds[1])*.5,(this.DragBounds[2]+this.DragBounds[3])*.5];return n*=2,Math.abs(r[0]-u[0])<n&&Math.abs(r[1]-u[1])<n&&(i|=16),i!=this.Active&&(this.SetActive(i),eventuallyRender()),!1},e.prototype.GetActive=function(){return this.Active},e.prototype.Deactivate=function(){this.Div.remove();if(this.Layer==null)return;this.Layer.DeactivateWidget(this),this.Layer.RemoveWidget(this),eventuallyRender()},e.prototype.SetActive=function(e){if(this.Active==e)return;this.Active=e,e!=0?this.Layer.ActivateWidget(this):this.Layer.DeactivateWidget(this),eventuallyRender()},SAM.CutoutWidget=e})();(function(){"use strict";function e(){this.Visibility=!0,this.Origin=[0,0],this.Image=undefined,this.Height=5e3}e.prototype.destructor=function(){},e.prototype.Draw=function(e){if(!this.Visibility||!this.Image)return;var t=e.Context2d;t.save(),t.setTransform(1,0,0,1,0,0),t.transform(.5*e.Viewport[2],0,0,-0.5*e.Viewport[3],.5*e.Viewport[2],.5*e.Viewport[3]);var n=1/e.Camera.Matrix[15];t.transform(e.Camera.Matrix[0]*n,e.Camera.Matrix[1]*n,e.Camera.Matrix[4]*n,e.Camera.Matrix[5]*n,e.Camera.Matrix[12]*n,e.Camera.Matrix[13]*n);var r=this.Height/this.Image.height;t.transform(r,0,0,r,this.Origin[0],this.Origin[1]),t.drawImage(this.Image,0,0),t.restore()},SAM.ImageAnnotation=e})();(function(){"use strict";function e(e){SAM.DialogOverlay||(SAM.DialogOverlay=$("<div>").appendTo("body").css({position:"fixed",left:"0px",width:"100%","background-color":"#AAA",opacity:"0.4","z-index":"1010"}).saFullHeight().hide()),this.Dialog=$("<div>").appendTo("body").css({"z-index":"1011"}).addClass("sa-view-dialog-div"),this.Row1=$("<div>").addClass("sa-view-dialog-title").appendTo(this.Dialog).css({width:"100%",height:"2.25em","box-sizing":"border-box"}),this.Title=$("<div>").appendTo(this.Row1).css({"float":"left"}).addClass("sa-view-dialog-title").text("Title"),this.CloseButton=$("<div>").appendTo(this.Row1).css({"float":"right"}).addClass("sa-view-dialog-close").text("Close"),this.Body=$("<div>").appendTo(this.Dialog).css({width:"100%","box-sizing":"border-box","margin-bottom":"30px"}),this.ApplyButtonDiv=$("<div>").appendTo(this.Dialog).addClass("sa-view-dialog-apply-div"),this.ApplyButton=$("<button>").appendTo(this.ApplyButtonDiv).addClass("sa-view-dialog-apply-button").text("Apply");var t=this;(function(){t.CloseButton.click(function(e){return t.Hide(),!0}),t.ApplyButton.click(function(n){return t.Hide(),e(),!0})})()}e.prototype.Show=function(e){var t=this;SAM.DialogOverlay.show(),this.Dialog.fadeIn(300),e?SAM.DialogOverlay.off("click.dialog"):SAM.DialogOverlay.on("click.dialog",function(e){t.Hide()}),SAM.ContentEditableHasFocus=!0},e.prototype.Hide=function(){SAM.DialogOverlay.off("click.dialog"),SAM.DialogOverlay.hide(),this.Dialog.fadeOut(300),SAM.ContentEditableHasFocus=!1},SAM.Dialog=e})();(function(){"use strict";function e(e,t){t&&(this.ImageItemId=t,this.LoadGirderImageItem(t)),this.Radius=7,this.AnnotationLayer=e;var n=0,r=70+n*6*this.Radius,i=this;this.Plus=$("<img>").appendTo(this.AnnotationLayer.GetCanvasDiv()).attr("src",SA.ImagePathUrl+"bluePlus.png").css({position:"absolute",left:3*this.Radius+"px",top:r+"px",width:2*this.Radius+"px",height:2*this.Radius+"px",opacity:"0.6"}).prop("title","Add Annotation").hover(function(){$(this).css({opacity:"1"})},function(){$(this).css({opacity:"0.6"})}).click(function(){i.NewAnnotationItem()}),this.AnnotationObjects=[],this.Highlighted=undefined,this.MenuAnnotationObject=undefined,this.Menu=$("<div>").appendTo(this.AnnotationLayer.GetCanvasDiv()).hide().mouseleave(function(){$(this).hide()}).css({position:"absolute","background-color":"#FFFFFF",border:"1px solid #666666","box-sizing":"border-box",left:"-78px",width:"100px",padding:"0px 2px"}),$("<button>").appendTo(this.Menu).text("Snap Shot").css({margin:"2px 0px",width:"100%"}).prop("title","Replace Annotation").click(function(){i.SnapShotAnnotation(i.MenuAnnotationObject),i.Menu.hide()}),$("<button>").appendTo(this.Menu).text("Delete").css({margin:"2px 0px",width:"100%"}).click(function(){i.DeleteAnnotation(i.MenuAnnotationObject),i.Menu.hide()}),$("<button>").appendTo(this.Menu).text("Properties").css({margin:"2px 0px",width:"100%"}).click(function(){i.Menu.hide()})}e.prototype.NewAnnotationItem=function(){var e={elements:[]};e.name=this.AnnotationObjects.length.toString(),e.elements=this.RecordAnnotation();var t=this;window.girder?girder.restRequest({path:"annotation?itemId="+this.ImageItemId,method:"POST",contentType:"application/json",data:JSON.stringify(e)}).done(function(e){t.Highlight(t.AddAnnotation(e))}):t.Highlight(t.AddAnnotation({_id:"ABC",annotation:e,itemId:t.ImageItemId}))},e.prototype.LoadGirderImageItem=function(e){var t={itemId:e,limit:50,offset:0,sort:"lowerName",sortdir:0},n=this;girder.restRequest({path:"annotation",method:"GET",data:JSON.stringify(t)}).done(function(e){for(var t=0;t<e.length;++t)n.LoadAnnotationItem(e[t]._id)})},e.prototype.LoadAnnotationItem=function(e){var t=this;girder.restRequest({path:"annotation/"+e,method:"GET",contentType:"application/json"}).done(function(e){t.AddAnnotation(e)})},e.prototype.RecordAnnotation=function(){var e=[],t=this.AnnotationLayer.GetCamera(),n={type:"view",center:t.GetFocalPoint(),height:t.GetHeight(),width:t.GetWidth(),rotation:t.Roll};n.center.push(0),e.push(n);for(var r=0;r<this.AnnotationLayer.GetNumberOfWidgets();++r){var i=this.AnnotationLayer.GetWidget(r).Serialize();if(i.type=="circle"){i.origin.push(0);var n={type:"circle",center:i.origin,radius:i.radius}}if(i.type=="text"){var s=[i.position,i.offset];s[1][0]+=i.position[0],s[1][1]+=i.position[1],s[0].push(0),s[1].push(0);var n={type:"arrow",lineWidth:10,fillColor:SAM.ConvertColorToHex(i.color),points:s};n.label={value:i.string,fontSize:i.size,color:SAM.ConvertColorToHex(i.color)}}if(i.type=="grid")var n={type:"rectanglegrid",center:i.origin,width:i.bin_width*i.dimensions[0],height:i.bin_height*i.dimensions[1],rotation:i.orientation,normal:[0,0,1],widthSubdivisions:i.dimensions[0],heightSubdivisions:i.dimensions[1]};if(i.type=="polyline"){for(var o=0;o<i.points.length;++o)i.points[o].push(0);var n={type:"polyline",closed:i.closedloop,points:i.points}}if(i.type=="lasso"){for(var o=0;o<i.points.length;++o)i.points[o].push(0);var n={type:"polyline",closed:!0,points:i.points}}if(i.type=="pencil")for(var r=0;r<i.shapes.length;++r){var s=i.shapes[r];for(var o=0;o<s.length;++o)s[o].push(0);var n={type:"polyline",closed:!1,points:s};i.outlinecolor&&(n.lineColor=SAM.ConvertColorToHex(i.outlinecolor)),i.linewidth&&(n.lineWidth=Math.round(i.linewidth)),e.push(n)}else i.outlinecolor&&(n.lineColor=SAM.ConvertColorToHex(i.outlinecolor)),i.linewidth&&(n.lineWidth=Math.round(i.linewidth)),e.push(n)}return e},e.prototype.SnapShotAnnotation=function(e){this.Highlight(e),e.Data.annotation.elements=this.RecordAnnotation(),window.girder&&girder.restRequest({path:"annotation/"+e.Data._id,method:"PUT",data:JSON.stringify(e.Data.annotation),contentType:"application/json"})},e.prototype.DeleteAnnotation=function(e){var t=!1,n=[];for(var r=0;r<this.AnnotationObjects.length;++r){var i=this.AnnotationObjects[r];if(t){var s=70+(r-1)*6*this.Radius;i.Circle.animate({top:s+"px"}),n.push(i)}else e==i?(t=!0,i.Circle.remove(),window.girder&&girder.restRequest({path:"annotation/"+i.Data._id,method:"DELETE",contentType:"application/json"})):n.push(i)}var s=70+(r-1)*6*this.Radius;this.Plus.animate({top:s+"px"}),this.AnnotationObjects=n},e.prototype.AddAnnotation=function(e){var t=this.AnnotationObjects.length,n=70+t*6*this.Radius,r=this,i=$("<div>").appendTo(this.AnnotationLayer.GetCanvasDiv()).css({position:"absolute",left:3*this.Radius+"px",top:n+"px","min-width":2*this.Radius+"px",height:2*this.Radius+"px","background-color":"#55BBFF",opacity:"0.6",border:"1px solid #666666","border-radius":this.Radius+"px"}).prop("title","Show Annotation").text(e.name).hide().hover(function(){$(this).css({opacity:"1"})},function(){$(this).css({opacity:"0.6"})}),s={Data:e,Circle:i};return this.AnnotationObjects.push(s),i.contextmenu(function(){return!1}),i.mousedown(function(e){if(e.button==0)return r.DisplayAnnotation(s),!1;if(e.button==2){r.MenuAnnotationObject=s;var t=$(this).position();return r.Menu.css({left:5+t.left+2*r.Radius+"px",top:t.top+"px"}).show(),!1}return!0}),this.Plus.animate({top:n+6*this.Radius+"px"},400,function(){i.show()}),s},e.prototype.Highlight=function(e){this.Highlighted&&this.Highlighted.Circle.css({"background-color":"#55BBFF"}),this.Highlighted=e,e&&e.Circle.css({"background-color":"#FFDD00"})},e.prototype.DisplayAnnotation=function(e){this.AnnotationLayer.SetVisibility(!0),this.Highlight(e),this.AnnotationLayer.Reset();var t=e.Data.annotation;for(var n=0;n<t.elements.length;++n){var r=t.elements[n],i={};if(r.type=="view"){var s=this.AnnotationLayer.GetCamera();s.SetFocalPoint(r.center),s.SetHeight(r.height),r.rotation?s.Roll=r.rotation:s.Roll=0,s.ComputeMatrix(),this.AnnotationLayer.Viewer&&this.AnnotationLayer.Viewer.EventuallyRender()}r.type=="circle"&&(i.type=r.type,i.outlinecolor=SAM.ConvertColor(r.lineColor),i.linewidth=r.lineWidth,i.origin=r.center,i.radius=r.radius,this.AnnotationLayer.LoadWidget(i)),r.type=="arrow"&&(i.type="text",i.string=r.label.value,i.color=SAM.ConvertColor(r.fillColor),i.size=r.label.fontSize,i.position=r.points[0].slice(0),i.offset=r.points[1].slice(0),i.offset[0]-=i.position[0],i.offset[1]-=i.position[1],this.AnnotationLayer.LoadWidget(i)),r.type=="rectanglegrid"&&(i.type="grid",i.outlinecolor=SAM.ConvertColor(r.lineColor),i.linewidth=r.lineWidth,i.origin=r.center,i.bin_width=r.width/r.widthSubdivisions,i.bin_height=r.height/r.heightSubdivisions,i.orientation=r.rotation,i.dimensions=[r.widthSubdivisions,r.heightSubdivisions],this.AnnotationLayer.LoadWidget(i)),r.type=="polyline"&&(i.type=r.type,i.closedloop=r.closed,i.outlinecolor=SAM.ConvertColor(r.lineColor),i.linewidth=r.lineWidth,i.points=r.points,this.AnnotationLayer.LoadWidget(i))}this.AnnotationLayer.EventuallyDraw()},SAM.GirderWidget=e})();