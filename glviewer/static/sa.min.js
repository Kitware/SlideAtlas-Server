(function(e,t){function n(t,n){var i=t.nodeName.toLowerCase();if("area"===i){var s=t.parentNode,o=s.name,u;return!t.href||!o||s.nodeName.toLowerCase()!=="map"?!1:(u=e("img[usemap=#"+o+"]")[0],!!u&&r(u))}return(/input|select|textarea|button|object/.test(i)?!t.disabled:"a"==i?t.href||n:n)&&r(t)}function r(t){return!e(t).parents().andSelf().filter(function(){return e.curCSS(this,"visibility")==="hidden"||e.expr.filters.hidden(this)}).length}e.ui=e.ui||{};if(e.ui.version)return;e.extend(e.ui,{version:"1.8.22",keyCode:{ALT:18,BACKSPACE:8,CAPS_LOCK:20,COMMA:188,COMMAND:91,COMMAND_LEFT:91,COMMAND_RIGHT:93,CONTROL:17,DELETE:46,DOWN:40,END:35,ENTER:13,ESCAPE:27,HOME:36,INSERT:45,LEFT:37,MENU:93,NUMPAD_ADD:107,NUMPAD_DECIMAL:110,NUMPAD_DIVIDE:111,NUMPAD_ENTER:108,NUMPAD_MULTIPLY:106,NUMPAD_SUBTRACT:109,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,RIGHT:39,SHIFT:16,SPACE:32,TAB:9,UP:38,WINDOWS:91}}),e.fn.extend({propAttr:e.fn.prop||e.fn.attr,_focus:e.fn.focus,focus:function(t,n){return typeof t=="number"?this.each(function(){var r=this;setTimeout(function(){e(r).focus(),n&&n.call(r)},t)}):this._focus.apply(this,arguments)},scrollParent:function(){var t;return e.browser.msie&&/(static|relative)/.test(this.css("position"))||/absolute/.test(this.css("position"))?t=this.parents().filter(function(){return/(relative|absolute|fixed)/.test(e.curCSS(this,"position",1))&&/(auto|scroll)/.test(e.curCSS(this,"overflow",1)+e.curCSS(this,"overflow-y",1)+e.curCSS(this,"overflow-x",1))}).eq(0):t=this.parents().filter(function(){return/(auto|scroll)/.test(e.curCSS(this,"overflow",1)+e.curCSS(this,"overflow-y",1)+e.curCSS(this,"overflow-x",1))}).eq(0),/fixed/.test(this.css("position"))||!t.length?e(document):t},zIndex:function(n){if(n!==t)return this.css("zIndex",n);if(this.length){var r=e(this[0]),i,s;while(r.length&&r[0]!==document){i=r.css("position");if(i==="absolute"||i==="relative"||i==="fixed"){s=parseInt(r.css("zIndex"),10);if(!isNaN(s)&&s!==0)return s}r=r.parent()}}return 0},disableSelection:function(){return this.bind((e.support.selectstart?"selectstart":"mousedown")+".ui-disableSelection",function(e){e.preventDefault()})},enableSelection:function(){return this.unbind(".ui-disableSelection")}}),e("<a>").outerWidth(1).jquery||e.each(["Width","Height"],function(n,r){function i(t,n,r,i){return e.each(s,function(){n-=parseFloat(e.curCSS(t,"padding"+this,!0))||0,r&&(n-=parseFloat(e.curCSS(t,"border"+this+"Width",!0))||0),i&&(n-=parseFloat(e.curCSS(t,"margin"+this,!0))||0)}),n}var s=r==="Width"?["Left","Right"]:["Top","Bottom"],o=r.toLowerCase(),u={innerWidth:e.fn.innerWidth,innerHeight:e.fn.innerHeight,outerWidth:e.fn.outerWidth,outerHeight:e.fn.outerHeight};e.fn["inner"+r]=function(n){return n===t?u["inner"+r].call(this):this.each(function(){e(this).css(o,i(this,n)+"px")})},e.fn["outer"+r]=function(t,n){return typeof t!="number"?u["outer"+r].call(this,t):this.each(function(){e(this).css(o,i(this,t,!0,n)+"px")})}}),e.extend(e.expr[":"],{data:e.expr.createPseudo?e.expr.createPseudo(function(t){return function(n){return!!e.data(n,t)}}):function(t,n,r){return!!e.data(t,r[3])},focusable:function(t){return n(t,!isNaN(e.attr(t,"tabindex")))},tabbable:function(t){var r=e.attr(t,"tabindex"),i=isNaN(r);return(i||r>=0)&&n(t,!i)}}),e(function(){var t=document.body,n=t.appendChild(n=document.createElement("div"));n.offsetHeight,e.extend(n.style,{minHeight:"100px",height:"auto",padding:0,borderWidth:0}),e.support.minHeight=n.offsetHeight===100,e.support.selectstart="onselectstart"in n,t.removeChild(n).style.display="none"}),e.curCSS||(e.curCSS=e.css),e.extend(e.ui,{plugin:{add:function(t,n,r){var i=e.ui[t].prototype;for(var s in r)i.plugins[s]=i.plugins[s]||[],i.plugins[s].push([n,r[s]])},call:function(e,t,n){var r=e.plugins[t];if(!r||!e.element[0].parentNode)return;for(var i=0;i<r.length;i++)e.options[r[i][0]]&&r[i][1].apply(e.element,n)}},contains:function(e,t){return document.compareDocumentPosition?e.compareDocumentPosition(t)&16:e!==t&&e.contains(t)},hasScroll:function(t,n){if(e(t).css("overflow")==="hidden")return!1;var r=n&&n==="left"?"scrollLeft":"scrollTop",i=!1;return t[r]>0?!0:(t[r]=1,i=t[r]>0,t[r]=0,i)},isOverAxis:function(e,t,n){return e>t&&e<t+n},isOver:function(t,n,r,i,s,o){return e.ui.isOverAxis(t,r,s)&&e.ui.isOverAxis(n,i,o)}})})(jQuery),function(e,t){if(e.cleanData){var n=e.cleanData;e.cleanData=function(t){for(var r=0,i;(i=t[r])!=null;r++)try{e(i).triggerHandler("remove")}catch(s){}n(t)}}else{var r=e.fn.remove;e.fn.remove=function(t,n){return this.each(function(){return n||(!t||e.filter(t,[this]).length)&&e("*",this).add([this]).each(function(){try{e(this).triggerHandler("remove")}catch(t){}}),r.call(e(this),t,n)})}}e.widget=function(t,n,r){var i=t.split(".")[0],s;t=t.split(".")[1],s=i+"-"+t,r||(r=n,n=e.Widget),e.expr[":"][s]=function(n){return!!e.data(n,t)},e[i]=e[i]||{},e[i][t]=function(e,t){arguments.length&&this._createWidget(e,t)};var o=new n;o.options=e.extend(!0,{},o.options),e[i][t].prototype=e.extend(!0,o,{namespace:i,widgetName:t,widgetEventPrefix:e[i][t].prototype.widgetEventPrefix||t,widgetBaseClass:s},r),e.widget.bridge(t,e[i][t])},e.widget.bridge=function(n,r){e.fn[n]=function(i){var s=typeof i=="string",o=Array.prototype.slice.call(arguments,1),u=this;return i=!s&&o.length?e.extend.apply(null,[!0,i].concat(o)):i,s&&i.charAt(0)==="_"?u:(s?this.each(function(){var r=e.data(this,n),s=r&&e.isFunction(r[i])?r[i].apply(r,o):r;if(s!==r&&s!==t)return u=s,!1}):this.each(function(){var t=e.data(this,n);t?t.option(i||{})._init():e.data(this,n,new r(i,this))}),u)}},e.Widget=function(e,t){arguments.length&&this._createWidget(e,t)},e.Widget.prototype={widgetName:"widget",widgetEventPrefix:"",options:{disabled:!1},_createWidget:function(t,n){e.data(n,this.widgetName,this),this.element=e(n),this.options=e.extend(!0,{},this.options,this._getCreateOptions(),t);var r=this;this.element.bind("remove."+this.widgetName,function(){r.destroy()}),this._create(),this._trigger("create"),this._init()},_getCreateOptions:function(){return e.metadata&&e.metadata.get(this.element[0])[this.widgetName]},_create:function(){},_init:function(){},destroy:function(){this.element.unbind("."+this.widgetName).removeData(this.widgetName),this.widget().unbind("."+this.widgetName).removeAttr("aria-disabled").removeClass(this.widgetBaseClass+"-disabled "+"ui-state-disabled")},widget:function(){return this.element},option:function(n,r){var i=n;if(arguments.length===0)return e.extend({},this.options);if(typeof n=="string"){if(r===t)return this.options[n];i={},i[n]=r}return this._setOptions(i),this},_setOptions:function(t){var n=this;return e.each(t,function(e,t){n._setOption(e,t)}),this},_setOption:function(e,t){return this.options[e]=t,e==="disabled"&&this.widget()[t?"addClass":"removeClass"](this.widgetBaseClass+"-disabled"+" "+"ui-state-disabled").attr("aria-disabled",t),this},enable:function(){return this._setOption("disabled",!1)},disable:function(){return this._setOption("disabled",!0)},_trigger:function(t,n,r){var i,s,o=this.options[t];r=r||{},n=e.Event(n),n.type=(t===this.widgetEventPrefix?t:this.widgetEventPrefix+t).toLowerCase(),n.target=this.element[0],s=n.originalEvent;if(s)for(i in s)i in n||(n[i]=s[i]);return this.element.trigger(n,r),!(e.isFunction(o)&&o.call(this.element[0],n,r)===!1||n.isDefaultPrevented())}}}(jQuery),function(e,t){var n=!1;e(document).mouseup(function(e){n=!1}),e.widget("ui.mouse",{options:{cancel:":input,option",distance:1,delay:0},_mouseInit:function(){var t=this;this.element.bind("mousedown."+this.widgetName,function(e){return t._mouseDown(e)}).bind("click."+this.widgetName,function(n){if(!0===e.data(n.target,t.widgetName+".preventClickEvent"))return e.removeData(n.target,t.widgetName+".preventClickEvent"),n.stopImmediatePropagation(),!1}),this.started=!1},_mouseDestroy:function(){this.element.unbind("."+this.widgetName),e(document).unbind("mousemove."+this.widgetName,this._mouseMoveDelegate).unbind("mouseup."+this.widgetName,this._mouseUpDelegate)},_mouseDown:function(t){if(n)return;this._mouseStarted&&this._mouseUp(t),this._mouseDownEvent=t;var r=this,i=t.which==1,s=typeof this.options.cancel=="string"&&t.target.nodeName?e(t.target).closest(this.options.cancel).length:!1;if(!i||s||!this._mouseCapture(t))return!0;this.mouseDelayMet=!this.options.delay,this.mouseDelayMet||(this._mouseDelayTimer=setTimeout(function(){r.mouseDelayMet=!0},this.options.delay));if(this._mouseDistanceMet(t)&&this._mouseDelayMet(t)){this._mouseStarted=this._mouseStart(t)!==!1;if(!this._mouseStarted)return t.preventDefault(),!0}return!0===e.data(t.target,this.widgetName+".preventClickEvent")&&e.removeData(t.target,this.widgetName+".preventClickEvent"),this._mouseMoveDelegate=function(e){return r._mouseMove(e)},this._mouseUpDelegate=function(e){return r._mouseUp(e)},e(document).bind("mousemove."+this.widgetName,this._mouseMoveDelegate).bind("mouseup."+this.widgetName,this._mouseUpDelegate),t.preventDefault(),n=!0,!0},_mouseMove:function(t){return!e.browser.msie||document.documentMode>=9||!!t.button?this._mouseStarted?(this._mouseDrag(t),t.preventDefault()):(this._mouseDistanceMet(t)&&this._mouseDelayMet(t)&&(this._mouseStarted=this._mouseStart(this._mouseDownEvent,t)!==!1,this._mouseStarted?this._mouseDrag(t):this._mouseUp(t)),!this._mouseStarted):this._mouseUp(t)},_mouseUp:function(t){return e(document).unbind("mousemove."+this.widgetName,this._mouseMoveDelegate).unbind("mouseup."+this.widgetName,this._mouseUpDelegate),this._mouseStarted&&(this._mouseStarted=!1,t.target==this._mouseDownEvent.target&&e.data(t.target,this.widgetName+".preventClickEvent",!0),this._mouseStop(t)),!1},_mouseDistanceMet:function(e){return Math.max(Math.abs(this._mouseDownEvent.pageX-e.pageX),Math.abs(this._mouseDownEvent.pageY-e.pageY))>=this.options.distance},_mouseDelayMet:function(e){return this.mouseDelayMet},_mouseStart:function(e){},_mouseDrag:function(e){},_mouseStop:function(e){},_mouseCapture:function(e){return!0}})}(jQuery),function(e,t){e.widget("ui.draggable",e.ui.mouse,{widgetEventPrefix:"drag",options:{addClasses:!0,appendTo:"parent",axis:!1,connectToSortable:!1,containment:!1,cursor:"auto",cursorAt:!1,grid:!1,handle:!1,helper:"original",iframeFix:!1,opacity:!1,refreshPositions:!1,revert:!1,revertDuration:500,scope:"default",scroll:!0,scrollSensitivity:20,scrollSpeed:20,snap:!1,snapMode:"both",snapTolerance:20,stack:!1,zIndex:!1},_create:function(){this.options.helper=="original"&&!/^(?:r|a|f)/.test(this.element.css("position"))&&(this.element[0].style.position="relative"),this.options.addClasses&&this.element.addClass("ui-draggable"),this.options.disabled&&this.element.addClass("ui-draggable-disabled"),this._mouseInit()},destroy:function(){if(!this.element.data("draggable"))return;return this.element.removeData("draggable").unbind(".draggable").removeClass("ui-draggable ui-draggable-dragging ui-draggable-disabled"),this._mouseDestroy(),this},_mouseCapture:function(t){var n=this.options;return this.helper||n.disabled||e(t.target).is(".ui-resizable-handle")?!1:(this.handle=this._getHandle(t),this.handle?(n.iframeFix&&e(n.iframeFix===!0?"iframe":n.iframeFix).each(function(){e('<div class="ui-draggable-iframeFix" style="background: #fff;"></div>').css({width:this.offsetWidth+"px",height:this.offsetHeight+"px",position:"absolute",opacity:"0.001",zIndex:1e3}).css(e(this).offset()).appendTo("body")}),!0):!1)},_mouseStart:function(t){var n=this.options;return this.helper=this._createHelper(t),this.helper.addClass("ui-draggable-dragging"),this._cacheHelperProportions(),e.ui.ddmanager&&(e.ui.ddmanager.current=this),this._cacheMargins(),this.cssPosition=this.helper.css("position"),this.scrollParent=this.helper.scrollParent(),this.offset=this.positionAbs=this.element.offset(),this.offset={top:this.offset.top-this.margins.top,left:this.offset.left-this.margins.left},e.extend(this.offset,{click:{left:t.pageX-this.offset.left,top:t.pageY-this.offset.top},parent:this._getParentOffset(),relative:this._getRelativeOffset()}),this.originalPosition=this.position=this._generatePosition(t),this.originalPageX=t.pageX,this.originalPageY=t.pageY,n.cursorAt&&this._adjustOffsetFromHelper(n.cursorAt),n.containment&&this._setContainment(),this._trigger("start",t)===!1?(this._clear(),!1):(this._cacheHelperProportions(),e.ui.ddmanager&&!n.dropBehaviour&&e.ui.ddmanager.prepareOffsets(this,t),this._mouseDrag(t,!0),e.ui.ddmanager&&e.ui.ddmanager.dragStart(this,t),!0)},_mouseDrag:function(t,n){this.position=this._generatePosition(t),this.positionAbs=this._convertPositionTo("absolute");if(!n){var r=this._uiHash();if(this._trigger("drag",t,r)===!1)return this._mouseUp({}),!1;this.position=r.position}if(!this.options.axis||this.options.axis!="y")this.helper[0].style.left=this.position.left+"px";if(!this.options.axis||this.options.axis!="x")this.helper[0].style.top=this.position.top+"px";return e.ui.ddmanager&&e.ui.ddmanager.drag(this,t),!1},_mouseStop:function(t){var n=!1;e.ui.ddmanager&&!this.options.dropBehaviour&&(n=e.ui.ddmanager.drop(this,t)),this.dropped&&(n=this.dropped,this.dropped=!1);var r=this.element[0],i=!1;while(r&&(r=r.parentNode))r==document&&(i=!0);if(!i&&this.options.helper==="original")return!1;if(this.options.revert=="invalid"&&!n||this.options.revert=="valid"&&n||this.options.revert===!0||e.isFunction(this.options.revert)&&this.options.revert.call(this.element,n)){var s=this;e(this.helper).animate(this.originalPosition,parseInt(this.options.revertDuration,10),function(){s._trigger("stop",t)!==!1&&s._clear()})}else this._trigger("stop",t)!==!1&&this._clear();return!1},_mouseUp:function(t){return this.options.iframeFix===!0&&e("div.ui-draggable-iframeFix").each(function(){this.parentNode.removeChild(this)}),e.ui.ddmanager&&e.ui.ddmanager.dragStop(this,t),e.ui.mouse.prototype._mouseUp.call(this,t)},cancel:function(){return this.helper.is(".ui-draggable-dragging")?this._mouseUp({}):this._clear(),this},_getHandle:function(t){var n=!this.options.handle||!e(this.options.handle,this.element).length?!0:!1;return e(this.options.handle,this.element).find("*").andSelf().each(function(){this==t.target&&(n=!0)}),n},_createHelper:function(t){var n=this.options,r=e.isFunction(n.helper)?e(n.helper.apply(this.element[0],[t])):n.helper=="clone"?this.element.clone().removeAttr("id"):this.element;return r.parents("body").length||r.appendTo(n.appendTo=="parent"?this.element[0].parentNode:n.appendTo),r[0]!=this.element[0]&&!/(fixed|absolute)/.test(r.css("position"))&&r.css("position","absolute"),r},_adjustOffsetFromHelper:function(t){typeof t=="string"&&(t=t.split(" ")),e.isArray(t)&&(t={left:+t[0],top:+t[1]||0}),"left"in t&&(this.offset.click.left=t.left+this.margins.left),"right"in t&&(this.offset.click.left=this.helperProportions.width-t.right+this.margins.left),"top"in t&&(this.offset.click.top=t.top+this.margins.top),"bottom"in t&&(this.offset.click.top=this.helperProportions.height-t.bottom+this.margins.top)},_getParentOffset:function(){this.offsetParent=this.helper.offsetParent();var t=this.offsetParent.offset();this.cssPosition=="absolute"&&this.scrollParent[0]!=document&&e.ui.contains(this.scrollParent[0],this.offsetParent[0])&&(t.left+=this.scrollParent.scrollLeft(),t.top+=this.scrollParent.scrollTop());if(this.offsetParent[0]==document.body||this.offsetParent[0].tagName&&this.offsetParent[0].tagName.toLowerCase()=="html"&&e.browser.msie)t={top:0,left:0};return{top:t.top+(parseInt(this.offsetParent.css("borderTopWidth"),10)||0),left:t.left+(parseInt(this.offsetParent.css("borderLeftWidth"),10)||0)}},_getRelativeOffset:function(){if(this.cssPosition=="relative"){var e=this.element.position();return{top:e.top-(parseInt(this.helper.css("top"),10)||0)+this.scrollParent.scrollTop(),left:e.left-(parseInt(this.helper.css("left"),10)||0)+this.scrollParent.scrollLeft()}}return{top:0,left:0}},_cacheMargins:function(){this.margins={left:parseInt(this.element.css("marginLeft"),10)||0,top:parseInt(this.element.css("marginTop"),10)||0,right:parseInt(this.element.css("marginRight"),10)||0,bottom:parseInt(this.element.css("marginBottom"),10)||0}},_cacheHelperProportions:function(){this.helperProportions={width:this.helper.outerWidth(),height:this.helper.outerHeight()}},_setContainment:function(){var t=this.options;t.containment=="parent"&&(t.containment=this.helper[0].parentNode);if(t.containment=="document"||t.containment=="window")this.containment=[t.containment=="document"?0:e(window).scrollLeft()-this.offset.relative.left-this.offset.parent.left,t.containment=="document"?0:e(window).scrollTop()-this.offset.relative.top-this.offset.parent.top,(t.containment=="document"?0:e(window).scrollLeft())+e(t.containment=="document"?document:window).width()-this.helperProportions.width-this.margins.left,(t.containment=="document"?0:e(window).scrollTop())+(e(t.containment=="document"?document:window).height()||document.body.parentNode.scrollHeight)-this.helperProportions.height-this.margins.top];if(!/^(document|window|parent)$/.test(t.containment)&&t.containment.constructor!=Array){var n=e(t.containment),r=n[0];if(!r)return;var i=n.offset(),s=e(r).css("overflow")!="hidden";this.containment=[(parseInt(e(r).css("borderLeftWidth"),10)||0)+(parseInt(e(r).css("paddingLeft"),10)||0),(parseInt(e(r).css("borderTopWidth"),10)||0)+(parseInt(e(r).css("paddingTop"),10)||0),(s?Math.max(r.scrollWidth,r.offsetWidth):r.offsetWidth)-(parseInt(e(r).css("borderLeftWidth"),10)||0)-(parseInt(e(r).css("paddingRight"),10)||0)-this.helperProportions.width-this.margins.left-this.margins.right,(s?Math.max(r.scrollHeight,r.offsetHeight):r.offsetHeight)-(parseInt(e(r).css("borderTopWidth"),10)||0)-(parseInt(e(r).css("paddingBottom"),10)||0)-this.helperProportions.height-this.margins.top-this.margins.bottom],this.relative_container=n}else t.containment.constructor==Array&&(this.containment=t.containment)},_convertPositionTo:function(t,n){n||(n=this.position);var r=t=="absolute"?1:-1,i=this.options,s=this.cssPosition!="absolute"||this.scrollParent[0]!=document&&!!e.ui.contains(this.scrollParent[0],this.offsetParent[0])?this.scrollParent:this.offsetParent,o=/(html|body)/i.test(s[0].tagName);return{top:n.top+this.offset.relative.top*r+this.offset.parent.top*r-(e.browser.safari&&e.browser.version<526&&this.cssPosition=="fixed"?0:(this.cssPosition=="fixed"?-this.scrollParent.scrollTop():o?0:s.scrollTop())*r),left:n.left+this.offset.relative.left*r+this.offset.parent.left*r-(e.browser.safari&&e.browser.version<526&&this.cssPosition=="fixed"?0:(this.cssPosition=="fixed"?-this.scrollParent.scrollLeft():o?0:s.scrollLeft())*r)}},_generatePosition:function(t){var n=this.options,r=this.cssPosition!="absolute"||this.scrollParent[0]!=document&&!!e.ui.contains(this.scrollParent[0],this.offsetParent[0])?this.scrollParent:this.offsetParent,i=/(html|body)/i.test(r[0].tagName),s=t.pageX,o=t.pageY;if(this.originalPosition){var u;if(this.containment){if(this.relative_container){var f=this.relative_container.offset();u=[this.containment[0]+f.left,this.containment[1]+f.top,this.containment[2]+f.left,this.containment[3]+f.top]}else u=this.containment;t.pageX-this.offset.click.left<u[0]&&(s=u[0]+this.offset.click.left),t.pageY-this.offset.click.top<u[1]&&(o=u[1]+this.offset.click.top),t.pageX-this.offset.click.left>u[2]&&(s=u[2]+this.offset.click.left),t.pageY-this.offset.click.top>u[3]&&(o=u[3]+this.offset.click.top)}if(n.grid){var l=n.grid[1]?this.originalPageY+Math.round((o-this.originalPageY)/n.grid[1])*n.grid[1]:this.originalPageY;o=u?l-this.offset.click.top<u[1]||l-this.offset.click.top>u[3]?l-this.offset.click.top<u[1]?l+n.grid[1]:l-n.grid[1]:l:l;var c=n.grid[0]?this.originalPageX+Math.round((s-this.originalPageX)/n.grid[0])*n.grid[0]:this.originalPageX;s=u?c-this.offset.click.left<u[0]||c-this.offset.click.left>u[2]?c-this.offset.click.left<u[0]?c+n.grid[0]:c-n.grid[0]:c:c}}return{top:o-this.offset.click.top-this.offset.relative.top-this.offset.parent.top+(e.browser.safari&&e.browser.version<526&&this.cssPosition=="fixed"?0:this.cssPosition=="fixed"?-this.scrollParent.scrollTop():i?0:r.scrollTop()),left:s-this.offset.click.left-this.offset.relative.left-this.offset.parent.left+(e.browser.safari&&e.browser.version<526&&this.cssPosition=="fixed"?0:this.cssPosition=="fixed"?-this.scrollParent.scrollLeft():i?0:r.scrollLeft())}},_clear:function(){this.helper.removeClass("ui-draggable-dragging"),this.helper[0]!=this.element[0]&&!this.cancelHelperRemoval&&this.helper.remove(),this.helper=null,this.cancelHelperRemoval=!1},_trigger:function(t,n,r){return r=r||this._uiHash(),e.ui.plugin.call(this,t,[n,r]),t=="drag"&&(this.positionAbs=this._convertPositionTo("absolute")),e.Widget.prototype._trigger.call(this,t,n,r)},plugins:{},_uiHash:function(e){return{helper:this.helper,position:this.position,originalPosition:this.originalPosition,offset:this.positionAbs}}}),e.extend(e.ui.draggable,{version:"1.8.22"}),e.ui.plugin.add("draggable","connectToSortable",{start:function(t,n){var r=e(this).data("draggable"),i=r.options,s=e.extend({},n,{item:r.element});r.sortables=[],e(i.connectToSortable).each(function(){var n=e.data(this,"sortable");n&&!n.options.disabled&&(r.sortables.push({instance:n,shouldRevert:n.options.revert}),n.refreshPositions(),n._trigger("activate",t,s))})},stop:function(t,n){var r=e(this).data("draggable"),i=e.extend({},n,{item:r.element});e.each(r.sortables,function(){this.instance.isOver?(this.instance.isOver=0,r.cancelHelperRemoval=!0,this.instance.cancelHelperRemoval=!1,this.shouldRevert&&(this.instance.options.revert=!0),this.instance._mouseStop(t),this.instance.options.helper=this.instance.options._helper,r.options.helper=="original"&&this.instance.currentItem.css({top:"auto",left:"auto"})):(this.instance.cancelHelperRemoval=!1,this.instance._trigger("deactivate",t,i))})},drag:function(t,n){var r=e(this).data("draggable"),i=this,s=function(t){var n=this.offset.click.top,r=this.offset.click.left,i=this.positionAbs.top,s=this.positionAbs.left,o=t.height,u=t.width,f=t.top,l=t.left;return e.ui.isOver(i+n,s+r,f,l,o,u)};e.each(r.sortables,function(s){this.instance.positionAbs=r.positionAbs,this.instance.helperProportions=r.helperProportions,this.instance.offset.click=r.offset.click,this.instance._intersectsWith(this.instance.containerCache)?(this.instance.isOver||(this.instance.isOver=1,this.instance.currentItem=e(i).clone().removeAttr("id").appendTo(this.instance.element).data("sortable-item",!0),this.instance.options._helper=this.instance.options.helper,this.instance.options.helper=function(){return n.helper[0]},t.target=this.instance.currentItem[0],this.instance._mouseCapture(t,!0),this.instance._mouseStart(t,!0,!0),this.instance.offset.click.top=r.offset.click.top,this.instance.offset.click.left=r.offset.click.left,this.instance.offset.parent.left-=r.offset.parent.left-this.instance.offset.parent.left,this.instance.offset.parent.top-=r.offset.parent.top-this.instance.offset.parent.top,r._trigger("toSortable",t),r.dropped=this.instance.element,r.currentItem=r.element,this.instance.fromOutside=r),this.instance.currentItem&&this.instance._mouseDrag(t)):this.instance.isOver&&(this.instance.isOver=0,this.instance.cancelHelperRemoval=!0,this.instance.options.revert=!1,this.instance._trigger("out",t,this.instance._uiHash(this.instance)),this.instance._mouseStop(t,!0),this.instance.options.helper=this.instance.options._helper,this.instance.currentItem.remove(),this.instance.placeholder&&this.instance.placeholder.remove(),r._trigger("fromSortable",t),r.dropped=!1)})}}),e.ui.plugin.add("draggable","cursor",{start:function(t,n){var r=e("body"),i=e(this).data("draggable").options;r.css("cursor")&&(i._cursor=r.css("cursor")),r.css("cursor",i.cursor)},stop:function(t,n){var r=e(this).data("draggable").options;r._cursor&&e("body").css("cursor",r._cursor)}}),e.ui.plugin.add("draggable","opacity",{start:function(t,n){var r=e(n.helper),i=e(this).data("draggable").options;r.css("opacity")&&(i._opacity=r.css("opacity")),r.css("opacity",i.opacity)},stop:function(t,n){var r=e(this).data("draggable").options;r._opacity&&e(n.helper).css("opacity",r._opacity)}}),e.ui.plugin.add("draggable","scroll",{start:function(t,n){var r=e(this).data("draggable");r.scrollParent[0]!=document&&r.scrollParent[0].tagName!="HTML"&&(r.overflowOffset=r.scrollParent.offset())},drag:function(t,n){var r=e(this).data("draggable"),i=r.options,s=!1;if(r.scrollParent[0]!=document&&r.scrollParent[0].tagName!="HTML"){if(!i.axis||i.axis!="x")r.overflowOffset.top+r.scrollParent[0].offsetHeight-t.pageY<i.scrollSensitivity?r.scrollParent[0].scrollTop=s=r.scrollParent[0].scrollTop+i.scrollSpeed:t.pageY-r.overflowOffset.top<i.scrollSensitivity&&(r.scrollParent[0].scrollTop=s=r.scrollParent[0].scrollTop-i.scrollSpeed);if(!i.axis||i.axis!="y")r.overflowOffset.left+r.scrollParent[0].offsetWidth-t.pageX<i.scrollSensitivity?r.scrollParent[0].scrollLeft=s=r.scrollParent[0].scrollLeft+i.scrollSpeed:t.pageX-r.overflowOffset.left<i.scrollSensitivity&&(r.scrollParent[0].scrollLeft=s=r.scrollParent[0].scrollLeft-i.scrollSpeed)}else{if(!i.axis||i.axis!="x")t.pageY-e(document).scrollTop()<i.scrollSensitivity?s=e(document).scrollTop(e(document).scrollTop()-i.scrollSpeed):e(window).height()-(t.pageY-e(document).scrollTop())<i.scrollSensitivity&&(s=e(document).scrollTop(e(document).scrollTop()+i.scrollSpeed));if(!i.axis||i.axis!="y")t.pageX-e(document).scrollLeft()<i.scrollSensitivity?s=e(document).scrollLeft(e(document).scrollLeft()-i.scrollSpeed):e(window).width()-(t.pageX-e(document).scrollLeft())<i.scrollSensitivity&&(s=e(document).scrollLeft(e(document).scrollLeft()+i.scrollSpeed))}s!==!1&&e.ui.ddmanager&&!i.dropBehaviour&&e.ui.ddmanager.prepareOffsets(r,t)}}),e.ui.plugin.add("draggable","snap",{start:function(t,n){var r=e(this).data("draggable"),i=r.options;r.snapElements=[],e(i.snap.constructor!=String?i.snap.items||":data(draggable)":i.snap).each(function(){var t=e(this),n=t.offset();this!=r.element[0]&&r.snapElements.push({item:this,width:t.outerWidth(),height:t.outerHeight(),top:n.top,left:n.left})})},drag:function(t,n){var r=e(this).data("draggable"),i=r.options,s=i.snapTolerance,o=n.offset.left,u=o+r.helperProportions.width,f=n.offset.top,l=f+r.helperProportions.height;for(var c=r.snapElements.length-1;c>=0;c--){var h=r.snapElements[c].left,p=h+r.snapElements[c].width,d=r.snapElements[c].top,v=d+r.snapElements[c].height;if(!(h-s<o&&o<p+s&&d-s<f&&f<v+s||h-s<o&&o<p+s&&d-s<l&&l<v+s||h-s<u&&u<p+s&&d-s<f&&f<v+s||h-s<u&&u<p+s&&d-s<l&&l<v+s)){r.snapElements[c].snapping&&r.options.snap.release&&r.options.snap.release.call(r.element,t,e.extend(r._uiHash(),{snapItem:r.snapElements[c].item})),r.snapElements[c].snapping=!1;continue}if(i.snapMode!="inner"){var m=Math.abs(d-l)<=s,g=Math.abs(v-f)<=s,y=Math.abs(h-u)<=s,b=Math.abs(p-o)<=s;m&&(n.position.top=r._convertPositionTo("relative",{top:d-r.helperProportions.height,left:0}).top-r.margins.top),g&&(n.position.top=r._convertPositionTo("relative",{top:v,left:0}).top-r.margins.top),y&&(n.position.left=r._convertPositionTo("relative",{top:0,left:h-r.helperProportions.width}).left-r.margins.left),b&&(n.position.left=r._convertPositionTo("relative",{top:0,left:p}).left-r.margins.left)}var w=m||g||y||b;if(i.snapMode!="outer"){var m=Math.abs(d-f)<=s,g=Math.abs(v-l)<=s,y=Math.abs(h-o)<=s,b=Math.abs(p-u)<=s;m&&(n.position.top=r._convertPositionTo("relative",{top:d,left:0}).top-r.margins.top),g&&(n.position.top=r._convertPositionTo("relative",{top:v-r.helperProportions.height,left:0}).top-r.margins.top),y&&(n.position.left=r._convertPositionTo("relative",{top:0,left:h}).left-r.margins.left),b&&(n.position.left=r._convertPositionTo("relative",{top:0,left:p-r.helperProportions.width}).left-r.margins.left)}!r.snapElements[c].snapping&&(m||g||y||b||w)&&r.options.snap.snap&&r.options.snap.snap.call(r.element,t,e.extend(r._uiHash(),{snapItem:r.snapElements[c].item})),r.snapElements[c].snapping=m||g||y||b||w}}}),e.ui.plugin.add("draggable","stack",{start:function(t,n){var r=e(this).data("draggable").options,i=e.makeArray(e(r.stack)).sort(function(t,n){return(parseInt(e(t).css("zIndex"),10)||0)-(parseInt(e(n).css("zIndex"),10)||0)});if(!i.length)return;var s=parseInt(i[0].style.zIndex)||0;e(i).each(function(e){this.style.zIndex=s+e}),this[0].style.zIndex=s+i.length}}),e.ui.plugin.add("draggable","zIndex",{start:function(t,n){var r=e(n.helper),i=e(this).data("draggable").options;r.css("zIndex")&&(i._zIndex=r.css("zIndex")),r.css("zIndex",i.zIndex)},stop:function(t,n){var r=e(this).data("draggable").options;r._zIndex&&e(n.helper).css("zIndex",r._zIndex)}})}(jQuery),function(e,t){e.widget("ui.droppable",{widgetEventPrefix:"drop",options:{accept:"*",activeClass:!1,addClasses:!0,greedy:!1,hoverClass:!1,scope:"default",tolerance:"intersect"},_create:function(){var t=this.options,n=t.accept;this.isover=0,this.isout=1,this.accept=e.isFunction(n)?n:function(e){return e.is(n)},this.proportions={width:this.element[0].offsetWidth,height:this.element[0].offsetHeight},e.ui.ddmanager.droppables[t.scope]=e.ui.ddmanager.droppables[t.scope]||[],e.ui.ddmanager.droppables[t.scope].push(this),t.addClasses&&this.element.addClass("ui-droppable")},destroy:function(){var t=e.ui.ddmanager.droppables[this.options.scope];for(var n=0;n<t.length;n++)t[n]==this&&t.splice(n,1);return this.element.removeClass("ui-droppable ui-droppable-disabled").removeData("droppable").unbind(".droppable"),this},_setOption:function(t,n){t=="accept"&&(this.accept=e.isFunction(n)?n:function(e){return e.is(n)}),e.Widget.prototype._setOption.apply(this,arguments)},_activate:function(t){var n=e.ui.ddmanager.current;this.options.activeClass&&this.element.addClass(this.options.activeClass),n&&this._trigger("activate",t,this.ui(n))},_deactivate:function(t){var n=e.ui.ddmanager.current;this.options.activeClass&&this.element.removeClass(this.options.activeClass),n&&this._trigger("deactivate",t,this.ui(n))},_over:function(t){var n=e.ui.ddmanager.current;if(!n||(n.currentItem||n.element)[0]==this.element[0])return;this.accept.call(this.element[0],n.currentItem||n.element)&&(this.options.hoverClass&&this.element.addClass(this.options.hoverClass),this._trigger("over",t,this.ui(n)))},_out:function(t){var n=e.ui.ddmanager.current;if(!n||(n.currentItem||n.element)[0]==this.element[0])return;this.accept.call(this.element[0],n.currentItem||n.element)&&(this.options.hoverClass&&this.element.removeClass(this.options.hoverClass),this._trigger("out",t,this.ui(n)))},_drop:function(t,n){var r=n||e.ui.ddmanager.current;if(!r||(r.currentItem||r.element)[0]==this.element[0])return!1;var i=!1;return this.element.find(":data(droppable)").not(".ui-draggable-dragging").each(function(){var t=e.data(this,"droppable");if(t.options.greedy&&!t.options.disabled&&t.options.scope==r.options.scope&&t.accept.call(t.element[0],r.currentItem||r.element)&&e.ui.intersect(r,e.extend(t,{offset:t.element.offset()}),t.options.tolerance))return i=!0,!1}),i?!1:this.accept.call(this.element[0],r.currentItem||r.element)?(this.options.activeClass&&this.element.removeClass(this.options.activeClass),this.options.hoverClass&&this.element.removeClass(this.options.hoverClass),this._trigger("drop",t,this.ui(r)),this.element):!1},ui:function(e){return{draggable:e.currentItem||e.element,helper:e.helper,position:e.position,offset:e.positionAbs}}}),e.extend(e.ui.droppable,{version:"1.8.22"}),e.ui.intersect=function(t,n,r){if(!n.offset)return!1;var i=(t.positionAbs||t.position.absolute).left,s=i+t.helperProportions.width,o=(t.positionAbs||t.position.absolute).top,u=o+t.helperProportions.height,f=n.offset.left,l=f+n.proportions.width,c=n.offset.top,h=c+n.proportions.height;switch(r){case"fit":return f<=i&&s<=l&&c<=o&&u<=h;case"intersect":return f<i+t.helperProportions.width/2&&s-t.helperProportions.width/2<l&&c<o+t.helperProportions.height/2&&u-t.helperProportions.height/2<h;case"pointer":var p=(t.positionAbs||t.position.absolute).left+(t.clickOffset||t.offset.click).left,d=(t.positionAbs||t.position.absolute).top+(t.clickOffset||t.offset.click).top,v=e.ui.isOver(d,p,c,f,n.proportions.height,n.proportions.width);return v;case"touch":return(o>=c&&o<=h||u>=c&&u<=h||o<c&&u>h)&&(i>=f&&i<=l||s>=f&&s<=l||i<f&&s>l);default:return!1}},e.ui.ddmanager={current:null,droppables:{"default":[]},prepareOffsets:function(t,n){var r=e.ui.ddmanager.droppables[t.options.scope]||[],i=n?n.type:null,s=(t.currentItem||t.element).find(":data(droppable)").andSelf();e:for(var o=0;o<r.length;o++){if(r[o].options.disabled||t&&!r[o].accept.call(r[o].element[0],t.currentItem||t.element))continue;for(var u=0;u<s.length;u++)if(s[u]==r[o].element[0]){r[o].proportions.height=0;continue e}r[o].visible=r[o].element.css("display")!="none";if(!r[o].visible)continue;i=="mousedown"&&r[o]._activate.call(r[o],n),r[o].offset=r[o].element.offset(),r[o].proportions={width:r[o].element[0].offsetWidth
,height:r[o].element[0].offsetHeight}}},drop:function(t,n){var r=!1;return e.each(e.ui.ddmanager.droppables[t.options.scope]||[],function(){if(!this.options)return;!this.options.disabled&&this.visible&&e.ui.intersect(t,this,this.options.tolerance)&&(r=this._drop.call(this,n)||r),!this.options.disabled&&this.visible&&this.accept.call(this.element[0],t.currentItem||t.element)&&(this.isout=1,this.isover=0,this._deactivate.call(this,n))}),r},dragStart:function(t,n){t.element.parents(":not(body,html)").bind("scroll.droppable",function(){t.options.refreshPositions||e.ui.ddmanager.prepareOffsets(t,n)})},drag:function(t,n){t.options.refreshPositions&&e.ui.ddmanager.prepareOffsets(t,n),e.each(e.ui.ddmanager.droppables[t.options.scope]||[],function(){if(this.options.disabled||this.greedyChild||!this.visible)return;var r=e.ui.intersect(t,this,this.options.tolerance),i=!r&&this.isover==1?"isout":r&&this.isover==0?"isover":null;if(!i)return;var s;if(this.options.greedy){var o=this.element.parents(":data(droppable):eq(0)");o.length&&(s=e.data(o[0],"droppable"),s.greedyChild=i=="isover"?1:0)}s&&i=="isover"&&(s.isover=0,s.isout=1,s._out.call(s,n)),this[i]=1,this[i=="isout"?"isover":"isout"]=0,this[i=="isover"?"_over":"_out"].call(this,n),s&&i=="isout"&&(s.isout=0,s.isover=1,s._over.call(s,n))})},dragStop:function(t,n){t.element.parents(":not(body,html)").unbind("scroll.droppable"),t.options.refreshPositions||e.ui.ddmanager.prepareOffsets(t,n)}}}(jQuery),function(e,t){e.widget("ui.resizable",e.ui.mouse,{widgetEventPrefix:"resize",options:{alsoResize:!1,animate:!1,animateDuration:"slow",animateEasing:"swing",aspectRatio:!1,autoHide:!1,containment:!1,ghost:!1,grid:!1,handles:"e,s,se",helper:!1,maxHeight:null,maxWidth:null,minHeight:10,minWidth:10,zIndex:1e3},_create:function(){var t=this,n=this.options;this.element.addClass("ui-resizable"),e.extend(this,{_aspectRatio:!!n.aspectRatio,aspectRatio:n.aspectRatio,originalElement:this.element,_proportionallyResizeElements:[],_helper:n.helper||n.ghost||n.animate?n.helper||"ui-resizable-helper":null}),this.element[0].nodeName.match(/canvas|textarea|input|select|button|img/i)&&(this.element.wrap(e('<div class="ui-wrapper" style="overflow: hidden;"></div>').css({position:this.element.css("position"),width:this.element.outerWidth(),height:this.element.outerHeight(),top:this.element.css("top"),left:this.element.css("left")})),this.element=this.element.parent().data("resizable",this.element.data("resizable")),this.elementIsWrapper=!0,this.element.css({marginLeft:this.originalElement.css("marginLeft"),marginTop:this.originalElement.css("marginTop"),marginRight:this.originalElement.css("marginRight"),marginBottom:this.originalElement.css("marginBottom")}),this.originalElement.css({marginLeft:0,marginTop:0,marginRight:0,marginBottom:0}),this.originalResizeStyle=this.originalElement.css("resize"),this.originalElement.css("resize","none"),this._proportionallyResizeElements.push(this.originalElement.css({position:"static",zoom:1,display:"block"})),this.originalElement.css({margin:this.originalElement.css("margin")}),this._proportionallyResize()),this.handles=n.handles||(e(".ui-resizable-handle",this.element).length?{n:".ui-resizable-n",e:".ui-resizable-e",s:".ui-resizable-s",w:".ui-resizable-w",se:".ui-resizable-se",sw:".ui-resizable-sw",ne:".ui-resizable-ne",nw:".ui-resizable-nw"}:"e,s,se");if(this.handles.constructor==String){this.handles=="all"&&(this.handles="n,e,s,w,se,sw,ne,nw");var r=this.handles.split(",");this.handles={};for(var i=0;i<r.length;i++){var s=e.trim(r[i]),o="ui-resizable-"+s,u=e('<div class="ui-resizable-handle '+o+'"></div>');u.css({zIndex:n.zIndex}),"se"==s&&u.addClass("ui-icon ui-icon-gripsmall-diagonal-se"),this.handles[s]=".ui-resizable-"+s,this.element.append(u)}}this._renderAxis=function(t){t=t||this.element;for(var n in this.handles){this.handles[n].constructor==String&&(this.handles[n]=e(this.handles[n],this.element).show());if(this.elementIsWrapper&&this.originalElement[0].nodeName.match(/textarea|input|select|button/i)){var r=e(this.handles[n],this.element),i=0;i=/sw|ne|nw|se|n|s/.test(n)?r.outerHeight():r.outerWidth();var s=["padding",/ne|nw|n/.test(n)?"Top":/se|sw|s/.test(n)?"Bottom":/^e$/.test(n)?"Right":"Left"].join("");t.css(s,i),this._proportionallyResize()}if(!e(this.handles[n]).length)continue}},this._renderAxis(this.element),this._handles=e(".ui-resizable-handle",this.element).disableSelection(),this._handles.mouseover(function(){if(!t.resizing){if(this.className)var e=this.className.match(/ui-resizable-(se|sw|ne|nw|n|e|s|w)/i);t.axis=e&&e[1]?e[1]:"se"}}),n.autoHide&&(this._handles.hide(),e(this.element).addClass("ui-resizable-autohide").hover(function(){if(n.disabled)return;e(this).removeClass("ui-resizable-autohide"),t._handles.show()},function(){if(n.disabled)return;t.resizing||(e(this).addClass("ui-resizable-autohide"),t._handles.hide())})),this._mouseInit()},destroy:function(){this._mouseDestroy();var t=function(t){e(t).removeClass("ui-resizable ui-resizable-disabled ui-resizable-resizing").removeData("resizable").unbind(".resizable").find(".ui-resizable-handle").remove()};if(this.elementIsWrapper){t(this.element);var n=this.element;n.after(this.originalElement.css({position:n.css("position"),width:n.outerWidth(),height:n.outerHeight(),top:n.css("top"),left:n.css("left")})).remove()}return this.originalElement.css("resize",this.originalResizeStyle),t(this.originalElement),this},_mouseCapture:function(t){var n=!1;for(var r in this.handles)e(this.handles[r])[0]==t.target&&(n=!0);return!this.options.disabled&&n},_mouseStart:function(t){var r=this.options,i=this.element.position(),s=this.element;this.resizing=!0,this.documentScroll={top:e(document).scrollTop(),left:e(document).scrollLeft()},(s.is(".ui-draggable")||/absolute/.test(s.css("position")))&&s.css({position:"absolute",top:i.top,left:i.left}),this._renderProxy();var o=n(this.helper.css("left")),u=n(this.helper.css("top"));r.containment&&(o+=e(r.containment).scrollLeft()||0,u+=e(r.containment).scrollTop()||0),this.offset=this.helper.offset(),this.position={left:o,top:u},this.size=this._helper?{width:s.outerWidth(),height:s.outerHeight()}:{width:s.width(),height:s.height()},this.originalSize=this._helper?{width:s.outerWidth(),height:s.outerHeight()}:{width:s.width(),height:s.height()},this.originalPosition={left:o,top:u},this.sizeDiff={width:s.outerWidth()-s.width(),height:s.outerHeight()-s.height()},this.originalMousePosition={left:t.pageX,top:t.pageY},this.aspectRatio=typeof r.aspectRatio=="number"?r.aspectRatio:this.originalSize.width/this.originalSize.height||1;var f=e(".ui-resizable-"+this.axis).css("cursor");return e("body").css("cursor",f=="auto"?this.axis+"-resize":f),s.addClass("ui-resizable-resizing"),this._propagate("start",t),!0},_mouseDrag:function(t){var n=this.helper,r=this.options,i={},s=this,o=this.originalMousePosition,u=this.axis,f=t.pageX-o.left||0,l=t.pageY-o.top||0,c=this._change[u];if(!c)return!1;var h=c.apply(this,[t,f,l]),p=e.browser.msie&&e.browser.version<7,d=this.sizeDiff;this._updateVirtualBoundaries(t.shiftKey);if(this._aspectRatio||t.shiftKey)h=this._updateRatio(h,t);return h=this._respectSize(h,t),this._propagate("resize",t),n.css({top:this.position.top+"px",left:this.position.left+"px",width:this.size.width+"px",height:this.size.height+"px"}),!this._helper&&this._proportionallyResizeElements.length&&this._proportionallyResize(),this._updateCache(h),this._trigger("resize",t,this.ui()),!1},_mouseStop:function(t){this.resizing=!1;var n=this.options,r=this;if(this._helper){var i=this._proportionallyResizeElements,s=i.length&&/textarea/i.test(i[0].nodeName),o=s&&e.ui.hasScroll(i[0],"left")?0:r.sizeDiff.height,u=s?0:r.sizeDiff.width,f={width:r.helper.width()-u,height:r.helper.height()-o},l=parseInt(r.element.css("left"),10)+(r.position.left-r.originalPosition.left)||null,c=parseInt(r.element.css("top"),10)+(r.position.top-r.originalPosition.top)||null;n.animate||this.element.css(e.extend(f,{top:c,left:l})),r.helper.height(r.size.height),r.helper.width(r.size.width),this._helper&&!n.animate&&this._proportionallyResize()}return e("body").css("cursor","auto"),this.element.removeClass("ui-resizable-resizing"),this._propagate("stop",t),this._helper&&this.helper.remove(),!1},_updateVirtualBoundaries:function(e){var t=this.options,n,i,s,o,u;u={minWidth:r(t.minWidth)?t.minWidth:0,maxWidth:r(t.maxWidth)?t.maxWidth:Infinity,minHeight:r(t.minHeight)?t.minHeight:0,maxHeight:r(t.maxHeight)?t.maxHeight:Infinity};if(this._aspectRatio||e)n=u.minHeight*this.aspectRatio,s=u.minWidth/this.aspectRatio,i=u.maxHeight*this.aspectRatio,o=u.maxWidth/this.aspectRatio,n>u.minWidth&&(u.minWidth=n),s>u.minHeight&&(u.minHeight=s),i<u.maxWidth&&(u.maxWidth=i),o<u.maxHeight&&(u.maxHeight=o);this._vBoundaries=u},_updateCache:function(e){var t=this.options;this.offset=this.helper.offset(),r(e.left)&&(this.position.left=e.left),r(e.top)&&(this.position.top=e.top),r(e.height)&&(this.size.height=e.height),r(e.width)&&(this.size.width=e.width)},_updateRatio:function(e,t){var n=this.options,i=this.position,s=this.size,o=this.axis;return r(e.height)?e.width=e.height*this.aspectRatio:r(e.width)&&(e.height=e.width/this.aspectRatio),o=="sw"&&(e.left=i.left+(s.width-e.width),e.top=null),o=="nw"&&(e.top=i.top+(s.height-e.height),e.left=i.left+(s.width-e.width)),e},_respectSize:function(e,t){var n=this.helper,i=this._vBoundaries,s=this._aspectRatio||t.shiftKey,o=this.axis,u=r(e.width)&&i.maxWidth&&i.maxWidth<e.width,a=r(e.height)&&i.maxHeight&&i.maxHeight<e.height,f=r(e.width)&&i.minWidth&&i.minWidth>e.width,l=r(e.height)&&i.minHeight&&i.minHeight>e.height;f&&(e.width=i.minWidth),l&&(e.height=i.minHeight),u&&(e.width=i.maxWidth),a&&(e.height=i.maxHeight);var c=this.originalPosition.left+this.originalSize.width,h=this.position.top+this.size.height,p=/sw|nw|w/.test(o),v=/nw|ne|n/.test(o);f&&p&&(e.left=c-i.minWidth),u&&p&&(e.left=c-i.maxWidth),l&&v&&(e.top=h-i.minHeight),a&&v&&(e.top=h-i.maxHeight);var m=!e.width&&!e.height;return m&&!e.left&&e.top?e.top=null:m&&!e.top&&e.left&&(e.left=null),e},_proportionallyResize:function(){var t=this.options;if(!this._proportionallyResizeElements.length)return;var n=this.helper||this.element;for(var r=0;r<this._proportionallyResizeElements.length;r++){var i=this._proportionallyResizeElements[r];if(!this.borderDif){var s=[i.css("borderTopWidth"),i.css("borderRightWidth"),i.css("borderBottomWidth"),i.css("borderLeftWidth")],o=[i.css("paddingTop"),i.css("paddingRight"),i.css("paddingBottom"),i.css("paddingLeft")];this.borderDif=e.map(s,function(e,t){var n=parseInt(e,10)||0,r=parseInt(o[t],10)||0;return n+r})}if(!(!e.browser.msie||!e(n).is(":hidden")&&!e(n).parents(":hidden").length))continue;i.css({height:n.height()-this.borderDif[0]-this.borderDif[2]||0,width:n.width()-this.borderDif[1]-this.borderDif[3]||0})}},_renderProxy:function(){var t=this.element,n=this.options;this.elementOffset=t.offset();if(this._helper){this.helper=this.helper||e('<div style="overflow:hidden;"></div>');var r=e.browser.msie&&e.browser.version<7,i=r?1:0,s=r?2:-1;this.helper.addClass(this._helper).css({width:this.element.outerWidth()+s,height:this.element.outerHeight()+s,position:"absolute",left:this.elementOffset.left-i+"px",top:this.elementOffset.top-i+"px",zIndex:++n.zIndex}),this.helper.appendTo("body").disableSelection()}else this.helper=this.element},_change:{e:function(e,t,n){return{width:this.originalSize.width+t}},w:function(e,t,n){var r=this.options,i=this.originalSize,s=this.originalPosition;return{left:s.left+t,width:i.width-t}},n:function(e,t,n){var r=this.options,i=this.originalSize,s=this.originalPosition;return{top:s.top+n,height:i.height-n}},s:function(e,t,n){return{height:this.originalSize.height+n}},se:function(t,n,r){return e.extend(this._change.s.apply(this,arguments),this._change.e.apply(this,[t,n,r]))},sw:function(t,n,r){return e.extend(this._change.s.apply(this,arguments),this._change.w.apply(this,[t,n,r]))},ne:function(t,n,r){return e.extend(this._change.n.apply(this,arguments),this._change.e.apply(this,[t,n,r]))},nw:function(t,n,r){return e.extend(this._change.n.apply(this,arguments),this._change.w.apply(this,[t,n,r]))}},_propagate:function(t,n){e.ui.plugin.call(this,t,[n,this.ui()]),t!="resize"&&this._trigger(t,n,this.ui())},plugins:{},ui:function(){return{originalElement:this.originalElement,element:this.element,helper:this.helper,position:this.position,size:this.size,originalSize:this.originalSize,originalPosition:this.originalPosition}}}),e.extend(e.ui.resizable,{version:"1.8.22"}),e.ui.plugin.add("resizable","alsoResize",{start:function(t,n){var r=e(this).data("resizable"),i=r.options,s=function(t){e(t).each(function(){var t=e(this);t.data("resizable-alsoresize",{width:parseInt(t.width(),10),height:parseInt(t.height(),10),left:parseInt(t.css("left"),10),top:parseInt(t.css("top"),10)})})};typeof i.alsoResize=="object"&&!i.alsoResize.parentNode?i.alsoResize.length?(i.alsoResize=i.alsoResize[0],s(i.alsoResize)):e.each(i.alsoResize,function(e){s(e)}):s(i.alsoResize)},resize:function(t,n){var r=e(this).data("resizable"),i=r.options,s=r.originalSize,o=r.originalPosition,u={height:r.size.height-s.height||0,width:r.size.width-s.width||0,top:r.position.top-o.top||0,left:r.position.left-o.left||0},f=function(t,r){e(t).each(function(){var t=e(this),i=e(this).data("resizable-alsoresize"),s={},o=r&&r.length?r:t.parents(n.originalElement[0]).length?["width","height"]:["width","height","top","left"];e.each(o,function(e,t){var n=(i[t]||0)+(u[t]||0);n&&n>=0&&(s[t]=n||null)}),t.css(s)})};typeof i.alsoResize=="object"&&!i.alsoResize.nodeType?e.each(i.alsoResize,function(e,t){f(e,t)}):f(i.alsoResize)},stop:function(t,n){e(this).removeData("resizable-alsoresize")}}),e.ui.plugin.add("resizable","animate",{stop:function(t,n){var r=e(this).data("resizable"),i=r.options,s=r._proportionallyResizeElements,o=s.length&&/textarea/i.test(s[0].nodeName),u=o&&e.ui.hasScroll(s[0],"left")?0:r.sizeDiff.height,f=o?0:r.sizeDiff.width,l={width:r.size.width-f,height:r.size.height-u},c=parseInt(r.element.css("left"),10)+(r.position.left-r.originalPosition.left)||null,h=parseInt(r.element.css("top"),10)+(r.position.top-r.originalPosition.top)||null;r.element.animate(e.extend(l,h&&c?{top:h,left:c}:{}),{duration:i.animateDuration,easing:i.animateEasing,step:function(){var n={width:parseInt(r.element.css("width"),10),height:parseInt(r.element.css("height"),10),top:parseInt(r.element.css("top"),10),left:parseInt(r.element.css("left"),10)};s&&s.length&&e(s[0]).css({width:n.width,height:n.height}),r._updateCache(n),r._propagate("resize",t)}})}}),e.ui.plugin.add("resizable","containment",{start:function(t,r){var i=e(this).data("resizable"),s=i.options,o=i.element,u=s.containment,f=u instanceof e?u.get(0):/parent/.test(u)?o.parent().get(0):u;if(!f)return;i.containerElement=e(f);if(/document/.test(u)||u==document)i.containerOffset={left:0,top:0},i.containerPosition={left:0,top:0},i.parentData={element:e(document),left:0,top:0,width:e(document).width(),height:e(document).height()||document.body.parentNode.scrollHeight};else{var l=e(f),h=[];e(["Top","Right","Left","Bottom"]).each(function(e,t){h[e]=n(l.css("padding"+t))}),i.containerOffset=l.offset(),i.containerPosition=l.position(),i.containerSize={height:l.innerHeight()-h[3],width:l.innerWidth()-h[1]};var p=i.containerOffset,d=i.containerSize.height,v=i.containerSize.width,m=e.ui.hasScroll(f,"left")?f.scrollWidth:v,g=e.ui.hasScroll(f)?f.scrollHeight:d;i.parentData={element:f,left:p.left,top:p.top,width:m,height:g}}},resize:function(t,n){var r=e(this).data("resizable"),i=r.options,s=r.containerSize,o=r.containerOffset,u=r.size,f=r.position,l=r._aspectRatio||t.shiftKey,c={top:0,left:0},h=r.containerElement;h[0]!=document&&/static/.test(h.css("position"))&&(c=o),f.left<(r._helper?o.left:0)&&(r.size.width=r.size.width+(r._helper?r.position.left-o.left:r.position.left-c.left),l&&(r.size.height=r.size.width/r.aspectRatio),r.position.left=i.helper?o.left:0),f.top<(r._helper?o.top:0)&&(r.size.height=r.size.height+(r._helper?r.position.top-o.top:r.position.top),l&&(r.size.width=r.size.height*r.aspectRatio),r.position.top=r._helper?o.top:0),r.offset.left=r.parentData.left+r.position.left,r.offset.top=r.parentData.top+r.position.top;var p=Math.abs((r._helper?r.offset.left-c.left:r.offset.left-c.left)+r.sizeDiff.width),d=Math.abs((r._helper?r.offset.top-c.top:r.offset.top-o.top)+r.sizeDiff.height),v=r.containerElement.get(0)==r.element.parent().get(0),m=/relative|absolute/.test(r.containerElement.css("position"));v&&m&&(p-=r.parentData.left),p+r.size.width>=r.parentData.width&&(r.size.width=r.parentData.width-p,l&&(r.size.height=r.size.width/r.aspectRatio)),d+r.size.height>=r.parentData.height&&(r.size.height=r.parentData.height-d,l&&(r.size.width=r.size.height*r.aspectRatio))},stop:function(t,n){var r=e(this).data("resizable"),i=r.options,s=r.position,o=r.containerOffset,u=r.containerPosition,f=r.containerElement,l=e(r.helper),c=l.offset(),h=l.outerWidth()-r.sizeDiff.width,p=l.outerHeight()-r.sizeDiff.height;r._helper&&!i.animate&&/relative/.test(f.css("position"))&&e(this).css({left:c.left-u.left-o.left,width:h,height:p}),r._helper&&!i.animate&&/static/.test(f.css("position"))&&e(this).css({left:c.left-u.left-o.left,width:h,height:p})}}),e.ui.plugin.add("resizable","ghost",{start:function(t,n){var r=e(this).data("resizable"),i=r.options,s=r.size;r.ghost=r.originalElement.clone(),r.ghost.css({opacity:.25,display:"block",position:"relative",height:s.height,width:s.width,margin:0,left:0,top:0}).addClass("ui-resizable-ghost").addClass(typeof i.ghost=="string"?i.ghost:""),r.ghost.appendTo(r.helper)},resize:function(t,n){var r=e(this).data("resizable"),i=r.options;r.ghost&&r.ghost.css({position:"relative",height:r.size.height,width:r.size.width})},stop:function(t,n){var r=e(this).data("resizable"),i=r.options;r.ghost&&r.helper&&r.helper.get(0).removeChild(r.ghost.get(0))}}),e.ui.plugin.add("resizable","grid",{resize:function(t,n){var r=e(this).data("resizable"),i=r.options,s=r.size,o=r.originalSize,u=r.originalPosition,f=r.axis,l=i._aspectRatio||t.shiftKey;i.grid=typeof i.grid=="number"?[i.grid,i.grid]:i.grid;var c=Math.round((s.width-o.width)/(i.grid[0]||1))*(i.grid[0]||1),h=Math.round((s.height-o.height)/(i.grid[1]||1))*(i.grid[1]||1);/^(se|s|e)$/.test(f)?(r.size.width=o.width+c,r.size.height=o.height+h):/^(ne)$/.test(f)?(r.size.width=o.width+c,r.size.height=o.height+h,r.position.top=u.top-h):/^(sw)$/.test(f)?(r.size.width=o.width+c,r.size.height=o.height+h,r.position.left=u.left-c):(r.size.width=o.width+c,r.size.height=o.height+h,r.position.top=u.top-h,r.position.left=u.left-c)}});var n=function(e){return parseInt(e,10)||0},r=function(e){return!isNaN(parseInt(e,10))}}(jQuery),function(e,t){e.widget("ui.selectable",e.ui.mouse,{options:{appendTo:"body",autoRefresh:!0,distance:0,filter:"*",tolerance:"touch"},_create:function(){var t=this;this.element.addClass("ui-selectable"),this.dragged=!1;var n;this.refresh=function(){n=e(t.options.filter,t.element[0]),n.addClass("ui-selectee"),n.each(function(){var t=e(this),n=t.offset();e.data(this,"selectable-item",{element:this,$element:t,left:n.left,top:n.top,right:n.left+t.outerWidth(),bottom:n.top+t.outerHeight(),startselected:!1,selected:t.hasClass("ui-selected"),selecting:t.hasClass("ui-selecting"),unselecting:t.hasClass("ui-unselecting")})})},this.refresh(),this.selectees=n.addClass("ui-selectee"),this._mouseInit(),this.helper=e("<div class='ui-selectable-helper'></div>")},destroy:function(){return this.selectees.removeClass("ui-selectee").removeData("selectable-item"),this.element.removeClass("ui-selectable ui-selectable-disabled").removeData("selectable").unbind(".selectable"),this._mouseDestroy(),this},_mouseStart:function(t){var n=this;this.opos=[t.pageX,t.pageY];if(this.options.disabled)return;var r=this.options;this.selectees=e(r.filter,this.element[0]),this._trigger("start",t),e(r.appendTo).append(this.helper),this.helper.css({left:t.clientX,top:t.clientY,width:0,height:0}),r.autoRefresh&&this.refresh(),this.selectees.filter(".ui-selected").each(function(){var r=e.data(this,"selectable-item");r.startselected=!0,!t.metaKey&&!t.ctrlKey&&(r.$element.removeClass("ui-selected"),r.selected=!1,r.$element.addClass("ui-unselecting"),r.unselecting=!0,n._trigger("unselecting",t,{unselecting:r.element}))}),e(t.target).parents().andSelf().each(function(){var r=e.data(this,"selectable-item");if(r){var i=!t.metaKey&&!t.ctrlKey||!r.$element.hasClass("ui-selected");return r.$element.removeClass(i?"ui-unselecting":"ui-selected").addClass(i?"ui-selecting":"ui-unselecting"),r.unselecting=!i,r.selecting=i,r.selected=i,i?n._trigger("selecting",t,{selecting:r.element}):n._trigger("unselecting",t,{unselecting:r.element}),!1}})},_mouseDrag:function(t){var n=this;this.dragged=!0;if(this.options.disabled)return;var r=this.options,i=this.opos[0],s=this.opos[1],o=t.pageX,u=t.pageY;if(i>o){var f=o;o=i,i=f}if(s>u){var f=u;u=s,s=f}return this.helper.css({left:i,top:s,width:o-i,height:u-s}),this.selectees.each(function(){var f=e.data(this,"selectable-item");if(!f||f.element==n.element[0])return;var l=!1;r.tolerance=="touch"?l=!(f.left>o||f.right<i||f.top>u||f.bottom<s):r.tolerance=="fit"&&(l=f.left>i&&f.right<o&&f.top>s&&f.bottom<u),l?(f.selected&&(f.$element.removeClass("ui-selected"),f.selected=!1),f.unselecting&&(f.$element.removeClass("ui-unselecting"),f.unselecting=!1),f.selecting||(f.$element.addClass("ui-selecting"),f.selecting=!0,n._trigger("selecting",t,{selecting:f.element}))):(f.selecting&&((t.metaKey||t.ctrlKey)&&f.startselected?(f.$element.removeClass("ui-selecting"),f.selecting=!1,f.$element.addClass("ui-selected"),f.selected=!0):(f.$element.removeClass("ui-selecting"),f.selecting=!1,f.startselected&&(f.$element.addClass("ui-unselecting"),f.unselecting=!0),n._trigger("unselecting",t,{unselecting:f.element}))),f.selected&&!t.metaKey&&!t.ctrlKey&&!f.startselected&&(f.$element.removeClass("ui-selected"),f.selected=!1,f.$element.addClass("ui-unselecting"),f.unselecting=!0,n._trigger("unselecting",t,{unselecting:f.element})))}),!1},_mouseStop:function(t){var n=this;this.dragged=!1;var r=this.options;return e(".ui-unselecting",this.element[0]).each(function(){var r=e.data(this,"selectable-item");r.$element.removeClass("ui-unselecting"),r.unselecting=!1,r.startselected=!1,n._trigger("unselected",t,{unselected:r.element})}),e(".ui-selecting",this.element[0]).each(function(){var r=e.data(this,"selectable-item");r.$element.removeClass("ui-selecting").addClass("ui-selected"),r.selecting=!1,r.selected=!0,r.startselected=!0,n._trigger("selected",t,{selected:r.element})}),this._trigger("stop",t),this.helper.remove(),!1}}),e.extend(e.ui.selectable,{version:"1.8.22"})}(jQuery),function(e,t){e.widget("ui.sortable",e.ui.mouse,{widgetEventPrefix:"sort",ready:!1,options:{appendTo:"parent",axis:!1,connectWith:!1,containment:!1,cursor:"auto",cursorAt:!1,dropOnEmpty:!0,forcePlaceholderSize:!1,forceHelperSize:!1,grid:!1,handle:!1,helper:"original",items:"> *",opacity:!1,placeholder:!1,revert:!1,scroll:!0,scrollSensitivity:20,scrollSpeed:20,scope:"default",tolerance:"intersect",zIndex:1e3},_create:function(){var e=this.options;this.containerCache={},this.element.addClass("ui-sortable"),this.refresh(),this.floating=this.items.length?e.axis==="x"||/left|right/.test(this.items[0].item.css("float"))||/inline|table-cell/.test(this.items[0].item.css("display")):!1,this.offset=this.element.offset(),this._mouseInit(),this.ready=!0},destroy:function(){e.Widget.prototype.destroy.call(this),this.element.removeClass("ui-sortable ui-sortable-disabled"),this._mouseDestroy();for(var t=this.items.length-1;t>=0;t--)this.items[t].item.removeData(this.widgetName+"-item");return this},_setOption:function(t,n){t==="disabled"?(this.options[t]=n,this.widget()[n?"addClass":"removeClass"]("ui-sortable-disabled")):e.Widget.prototype._setOption.apply(this,arguments)},_mouseCapture:function(t,n){var r=this;if(this.reverting)return!1;if(this.options.disabled||this.options.type=="static")return!1;this._refreshItems(t);var i=null,s=this,o=e(t.target).parents().each(function(){if(e.data(this,r.widgetName+"-item")==s)return i=e(this),!1});e.data(t.target,r.widgetName+"-item")==s&&(i=e(t.target));if(!i)return!1;if(this.options.handle&&!n){var u=!1;e(this.options.handle,i).find("*").andSelf().each(function(){this==t.target&&(u=!0)});if(!u)return!1}return this.currentItem=i,this._removeCurrentsFromItems(),!0},_mouseStart:function(t,n,r){var i=this.options,s=this;this.currentContainer=this,this.refreshPositions(),this.helper=this._createHelper(t),this._cacheHelperProportions(),this._cacheMargins(),this.scrollParent=this.helper.scrollParent(),this.offset=this.currentItem.offset(),this.offset={top:this.offset.top-this.margins.top,left:this.offset.left-this.margins.left},e.extend(this.offset,{click:{left:t.pageX-this.offset.left,top:t.pageY-this.offset.top},parent:this._getParentOffset(),relative:this._getRelativeOffset()}),this.helper.css("position","absolute"),this.cssPosition=this.helper.css("position"),this.originalPosition=this._generatePosition(t),this.originalPageX=t.pageX,this.originalPageY=t.pageY,i.cursorAt&&this._adjustOffsetFromHelper(i.cursorAt),this.domPosition={prev:this.currentItem.prev()[0],parent:this.currentItem.parent()[0]},this.helper[0]!=this.currentItem[0]&&this.currentItem.hide(),this._createPlaceholder(),i.containment&&this._setContainment(),i.cursor&&(e("body").css("cursor")&&(this._storedCursor=e("body").css("cursor")),e("body").css("cursor",i.cursor)),i.opacity&&(this.helper.css("opacity")&&(this._storedOpacity=this.helper.css("opacity")),this.helper.css("opacity",i.opacity)),i.zIndex&&(this.helper.css("zIndex")&&(this._storedZIndex=this.helper.css("zIndex")),this.helper.css("zIndex",i.zIndex)),this.scrollParent[0]!=document&&this.scrollParent[0].tagName!="HTML"&&(this.overflowOffset=this.scrollParent.offset()),this._trigger("start",t,this._uiHash()),this._preserveHelperProportions||this._cacheHelperProportions();if(!r)for(var o=this.containers.length-1;o>=0;o--)this.containers[o]._trigger("activate",t,s._uiHash(this));return e.ui.ddmanager&&(e.ui.ddmanager.current=this),e.ui.ddmanager&&!i.dropBehaviour&&e.ui.ddmanager.prepareOffsets(this,t),this.dragging=!0,this.helper.addClass("ui-sortable-helper"),this._mouseDrag(t),!0},_mouseDrag:function(t){this.position=this._generatePosition(t),this.positionAbs=this._convertPositionTo("absolute"),this.lastPositionAbs||(this.lastPositionAbs=this.positionAbs);if(this.options.scroll){var n=this.options,r=!1;this.scrollParent[0]!=document&&this.scrollParent[0].tagName!="HTML"?(this.overflowOffset.top+this.scrollParent[0].offsetHeight-t.pageY<n.scrollSensitivity?this.scrollParent[0].scrollTop=r=this.scrollParent[0].scrollTop+n.scrollSpeed:t.pageY-this.overflowOffset.top<n.scrollSensitivity&&(this.scrollParent[0].scrollTop=r=this.scrollParent[0].scrollTop-n.scrollSpeed),this.overflowOffset.left+this.scrollParent[0].offsetWidth-t.pageX<n.scrollSensitivity?this.scrollParent[0].scrollLeft=r=this.scrollParent[0].scrollLeft+n.scrollSpeed:t.pageX-this.overflowOffset.left<n.scrollSensitivity&&(this.scrollParent[0].scrollLeft=r=this.scrollParent[0].scrollLeft-n.scrollSpeed)):(t.pageY-e(document).scrollTop()<n.scrollSensitivity?r=e(document).scrollTop(e(document).scrollTop()-n.scrollSpeed):e(window).height()-(t.pageY-e(document).scrollTop())<n.scrollSensitivity&&(r=e(document).scrollTop(e(document).scrollTop()+n.scrollSpeed)),t.pageX-e(document).scrollLeft()<n.scrollSensitivity?r=e(document).scrollLeft(e(document).scrollLeft()-n.scrollSpeed):e(window).width()-(t.pageX-e(document).scrollLeft())<n.scrollSensitivity&&(r=e(document).scrollLeft(e(document).scrollLeft()+n.scrollSpeed))),r!==!1&&e.ui.ddmanager&&!n.dropBehaviour&&e.ui.ddmanager.prepareOffsets(this,t)}this.positionAbs=this._convertPositionTo("absolute");if(!this.options.axis||this.options.axis!="y")this.helper[0].style.left=this.position.left+"px";if(!this.options.axis||this.options.axis!="x")this.helper[0].style.top=this.position.top+"px";for(var i=this.items.length-1;i>=0;i--){var s=this.items[i],o=s.item[0],u=this._intersectsWithPointer(s);if(!u)continue;if(o!=this.currentItem[0]&&this.placeholder[u==1?"next":"prev"]()[0]!=o&&!e.ui.contains(this.placeholder[0],o)&&(this.options.type=="semi-dynamic"?!e.ui.contains(this.element[0],o):!0)){this.direction=u==1?"down":"up";if(this.options.tolerance!="pointer"&&!this._intersectsWithSides(s))break;this._rearrange(t,s),this._trigger("change",t,this._uiHash());break}}return this._contactContainers(t),e.ui.ddmanager&&e.ui.ddmanager.drag(this,t),this._trigger("sort",t,this._uiHash()),this.lastPositionAbs=this.positionAbs,!1},_mouseStop:function(t,n){if(!t)return;e.ui.ddmanager&&!this.options.dropBehaviour&&e.ui.ddmanager.drop(this,t);if(this.options.revert){var r=this,i=r.placeholder.offset();r.reverting=!0,e(this.helper).animate({left:i.left-this.offset.parent.left-r.margins.left+(this.offsetParent[0]==document.body?0:this.offsetParent[0].scrollLeft),top:i.top-this.offset.parent.top-r.margins.top+(this.offsetParent[0]==document.body?0:this.offsetParent[0].scrollTop)},parseInt(this.options.revert,10)||500,function(){r._clear(t)})}else this._clear(t,n);return!1},cancel:function(){var t=this;if(this.dragging){this._mouseUp({target:null}),this.options.helper=="original"?this.currentItem.css(this._storedCSS).removeClass("ui-sortable-helper"):this.currentItem.show();for(var n=this.containers.length-1;n>=0;n--)this.containers[n]._trigger("deactivate",null,t._uiHash(this)),this.containers[n].containerCache.over&&(this.containers[n]._trigger("out",null,t._uiHash(this)),this.containers[n].containerCache.over=0)}return this.placeholder&&(this.placeholder[0].parentNode&&this.placeholder[0].parentNode.removeChild(this.placeholder[0]),this.options.helper!="original"&&this.helper&&this.helper[0].parentNode&&this.helper.remove(),e.extend(this,{helper:null,dragging:!1,reverting:!1,_noFinalSort:null}),this.domPosition.prev?e(this.domPosition.prev).after(this.currentItem):e(this.domPosition.parent).prepend(this.currentItem)),this},serialize:function(t){var n=this._getItemsAsjQuery(t&&t.connected),r=[];return t=t||{},e(n).each(function(){var n=(e(t.item||this).attr(t.attribute||"id")||"").match(t.expression||/(.+)[-=_](.+)/);n&&r.push((t.key||n[1]+"[]")+"="+(t.key&&t.expression?n[1]:n[2]))}),!r.length&&t.key&&r.push(t.key+"="),r.join("&")},toArray:function(t){var n=this._getItemsAsjQuery(t&&t.connected),r=[];return t=t||{},n.each(function(){r.push(e(t.item||this).attr(t.attribute||"id")||"")}),r},_intersectsWith:function(e){var t=this.positionAbs.left,n=t+this.helperProportions.width,r=this.positionAbs.top,i=r+this.helperProportions.height,s=e.left,o=s+e.width,u=e.top,a=u+e.height,f=this.offset.click.top,l=this.offset.click.left,c=r+f>u&&r+f<a&&t+l>s&&t+l<o;return this.options.tolerance=="pointer"||this.options.forcePointerForContainers||this.options.tolerance!="pointer"&&this.helperProportions[this.floating?"width":"height"]>e[this.floating?"width":"height"]?c:s<t+this.helperProportions.width/2&&n-this.helperProportions.width/2<o&&u<r+this.helperProportions.height/2&&i-this.helperProportions.height/2<a},_intersectsWithPointer:function(t){var n=this.options.axis==="x"||e.ui.isOverAxis(this.positionAbs.top+this.offset.click.top,t.top,t.height),r=this.options.axis==="y"||e.ui.isOverAxis(this.positionAbs.left+this.offset.click.left,t.left,t.width),i=n&&r,s=this._getDragVerticalDirection(),o=this._getDragHorizontalDirection();return i?this.floating?o&&o=="right"||s=="down"?2:1:s&&(s=="down"?2:1):!1},_intersectsWithSides:function(t){var n=e.ui.isOverAxis(this.positionAbs.top+this.offset.click.top,t.top+t.height/2,t.height),r=e.ui.isOverAxis(this.positionAbs.left+this.offset.click.left,t.left+t.width/2,t.width),i=this._getDragVerticalDirection(),s=this._getDragHorizontalDirection();return this.floating&&s?s=="right"&&r||s=="left"&&!r:i&&(i=="down"&&n||i=="up"&&!n)},_getDragVerticalDirection:function(){var e=this.positionAbs.top-this.lastPositionAbs.top;return e!=0&&(e>0?"down":"up")},_getDragHorizontalDirection:function(){var e=this.positionAbs.left-this.lastPositionAbs.left;return e!=0&&(e>0?"right":"left")},refresh:function(e){return this._refreshItems(e),this.refreshPositions(),this},_connectWith:function(){var e=this.options;return e.connectWith.constructor==String?[e.connectWith]:e.connectWith},_getItemsAsjQuery:function(t){var n=this,r=[],i=[],s=this._connectWith();if(s&&t)for(var o=s.length-1;o>=0;o--){var u=e(s[o]);for(var f=u.length-1;f>=0;f--){var l=e.data(u[f],this.widgetName);l&&l!=this&&!l.options.disabled&&i.push([e.isFunction(l.options.items)?l.options.items.call(l.element):e(l.options.items,l.element).not
(".ui-sortable-helper").not(".ui-sortable-placeholder"),l])}}i.push([e.isFunction(this.options.items)?this.options.items.call(this.element,null,{options:this.options,item:this.currentItem}):e(this.options.items,this.element).not(".ui-sortable-helper").not(".ui-sortable-placeholder"),this]);for(var o=i.length-1;o>=0;o--)i[o][0].each(function(){r.push(this)});return e(r)},_removeCurrentsFromItems:function(){var e=this.currentItem.find(":data("+this.widgetName+"-item)");for(var t=0;t<this.items.length;t++)for(var n=0;n<e.length;n++)e[n]==this.items[t].item[0]&&this.items.splice(t,1)},_refreshItems:function(t){this.items=[],this.containers=[this];var n=this.items,r=this,i=[[e.isFunction(this.options.items)?this.options.items.call(this.element[0],t,{item:this.currentItem}):e(this.options.items,this.element),this]],s=this._connectWith();if(s&&this.ready)for(var o=s.length-1;o>=0;o--){var u=e(s[o]);for(var f=u.length-1;f>=0;f--){var l=e.data(u[f],this.widgetName);l&&l!=this&&!l.options.disabled&&(i.push([e.isFunction(l.options.items)?l.options.items.call(l.element[0],t,{item:this.currentItem}):e(l.options.items,l.element),l]),this.containers.push(l))}}for(var o=i.length-1;o>=0;o--){var c=i[o][1],h=i[o][0];for(var f=0,p=h.length;f<p;f++){var d=e(h[f]);d.data(this.widgetName+"-item",c),n.push({item:d,instance:c,width:0,height:0,left:0,top:0})}}},refreshPositions:function(t){this.offsetParent&&this.helper&&(this.offset.parent=this._getParentOffset());for(var n=this.items.length-1;n>=0;n--){var r=this.items[n];if(r.instance!=this.currentContainer&&this.currentContainer&&r.item[0]!=this.currentItem[0])continue;var i=this.options.toleranceElement?e(this.options.toleranceElement,r.item):r.item;t||(r.width=i.outerWidth(),r.height=i.outerHeight());var s=i.offset();r.left=s.left,r.top=s.top}if(this.options.custom&&this.options.custom.refreshContainers)this.options.custom.refreshContainers.call(this);else for(var n=this.containers.length-1;n>=0;n--){var s=this.containers[n].element.offset();this.containers[n].containerCache.left=s.left,this.containers[n].containerCache.top=s.top,this.containers[n].containerCache.width=this.containers[n].element.outerWidth(),this.containers[n].containerCache.height=this.containers[n].element.outerHeight()}return this},_createPlaceholder:function(t){var n=t||this,r=n.options;if(!r.placeholder||r.placeholder.constructor==String){var i=r.placeholder;r.placeholder={element:function(){var t=e(document.createElement(n.currentItem[0].nodeName)).addClass(i||n.currentItem[0].className+" ui-sortable-placeholder").removeClass("ui-sortable-helper")[0];return i||(t.style.visibility="hidden"),t},update:function(e,t){if(i&&!r.forcePlaceholderSize)return;t.height()||t.height(n.currentItem.innerHeight()-parseInt(n.currentItem.css("paddingTop")||0,10)-parseInt(n.currentItem.css("paddingBottom")||0,10)),t.width()||t.width(n.currentItem.innerWidth()-parseInt(n.currentItem.css("paddingLeft")||0,10)-parseInt(n.currentItem.css("paddingRight")||0,10))}}}n.placeholder=e(r.placeholder.element.call(n.element,n.currentItem)),n.currentItem.after(n.placeholder),r.placeholder.update(n,n.placeholder)},_contactContainers:function(t){var n=null,r=null;for(var i=this.containers.length-1;i>=0;i--){if(e.ui.contains(this.currentItem[0],this.containers[i].element[0]))continue;if(this._intersectsWith(this.containers[i].containerCache)){if(n&&e.ui.contains(this.containers[i].element[0],n.element[0]))continue;n=this.containers[i],r=i}else this.containers[i].containerCache.over&&(this.containers[i]._trigger("out",t,this._uiHash(this)),this.containers[i].containerCache.over=0)}if(!n)return;if(this.containers.length===1)this.containers[r]._trigger("over",t,this._uiHash(this)),this.containers[r].containerCache.over=1;else if(this.currentContainer!=this.containers[r]){var s=1e4,o=null,u=this.positionAbs[this.containers[r].floating?"left":"top"];for(var f=this.items.length-1;f>=0;f--){if(!e.ui.contains(this.containers[r].element[0],this.items[f].item[0]))continue;var l=this.containers[r].floating?this.items[f].item.offset().left:this.items[f].item.offset().top;Math.abs(l-u)<s&&(s=Math.abs(l-u),o=this.items[f],this.direction=l-u>0?"down":"up")}if(!o&&!this.options.dropOnEmpty)return;this.currentContainer=this.containers[r],o?this._rearrange(t,o,null,!0):this._rearrange(t,null,this.containers[r].element,!0),this._trigger("change",t,this._uiHash()),this.containers[r]._trigger("change",t,this._uiHash(this)),this.options.placeholder.update(this.currentContainer,this.placeholder),this.containers[r]._trigger("over",t,this._uiHash(this)),this.containers[r].containerCache.over=1}},_createHelper:function(t){var n=this.options,r=e.isFunction(n.helper)?e(n.helper.apply(this.element[0],[t,this.currentItem])):n.helper=="clone"?this.currentItem.clone():this.currentItem;return r.parents("body").length||e(n.appendTo!="parent"?n.appendTo:this.currentItem[0].parentNode)[0].appendChild(r[0]),r[0]==this.currentItem[0]&&(this._storedCSS={width:this.currentItem[0].style.width,height:this.currentItem[0].style.height,position:this.currentItem.css("position"),top:this.currentItem.css("top"),left:this.currentItem.css("left")}),(r[0].style.width==""||n.forceHelperSize)&&r.width(this.currentItem.width()),(r[0].style.height==""||n.forceHelperSize)&&r.height(this.currentItem.height()),r},_adjustOffsetFromHelper:function(t){typeof t=="string"&&(t=t.split(" ")),e.isArray(t)&&(t={left:+t[0],top:+t[1]||0}),"left"in t&&(this.offset.click.left=t.left+this.margins.left),"right"in t&&(this.offset.click.left=this.helperProportions.width-t.right+this.margins.left),"top"in t&&(this.offset.click.top=t.top+this.margins.top),"bottom"in t&&(this.offset.click.top=this.helperProportions.height-t.bottom+this.margins.top)},_getParentOffset:function(){this.offsetParent=this.helper.offsetParent();var t=this.offsetParent.offset();this.cssPosition=="absolute"&&this.scrollParent[0]!=document&&e.ui.contains(this.scrollParent[0],this.offsetParent[0])&&(t.left+=this.scrollParent.scrollLeft(),t.top+=this.scrollParent.scrollTop());if(this.offsetParent[0]==document.body||this.offsetParent[0].tagName&&this.offsetParent[0].tagName.toLowerCase()=="html"&&e.browser.msie)t={top:0,left:0};return{top:t.top+(parseInt(this.offsetParent.css("borderTopWidth"),10)||0),left:t.left+(parseInt(this.offsetParent.css("borderLeftWidth"),10)||0)}},_getRelativeOffset:function(){if(this.cssPosition=="relative"){var e=this.currentItem.position();return{top:e.top-(parseInt(this.helper.css("top"),10)||0)+this.scrollParent.scrollTop(),left:e.left-(parseInt(this.helper.css("left"),10)||0)+this.scrollParent.scrollLeft()}}return{top:0,left:0}},_cacheMargins:function(){this.margins={left:parseInt(this.currentItem.css("marginLeft"),10)||0,top:parseInt(this.currentItem.css("marginTop"),10)||0}},_cacheHelperProportions:function(){this.helperProportions={width:this.helper.outerWidth(),height:this.helper.outerHeight()}},_setContainment:function(){var t=this.options;t.containment=="parent"&&(t.containment=this.helper[0].parentNode);if(t.containment=="document"||t.containment=="window")this.containment=[0-this.offset.relative.left-this.offset.parent.left,0-this.offset.relative.top-this.offset.parent.top,e(t.containment=="document"?document:window).width()-this.helperProportions.width-this.margins.left,(e(t.containment=="document"?document:window).height()||document.body.parentNode.scrollHeight)-this.helperProportions.height-this.margins.top];if(!/^(document|window|parent)$/.test(t.containment)){var n=e(t.containment)[0],r=e(t.containment).offset(),i=e(n).css("overflow")!="hidden";this.containment=[r.left+(parseInt(e(n).css("borderLeftWidth"),10)||0)+(parseInt(e(n).css("paddingLeft"),10)||0)-this.margins.left,r.top+(parseInt(e(n).css("borderTopWidth"),10)||0)+(parseInt(e(n).css("paddingTop"),10)||0)-this.margins.top,r.left+(i?Math.max(n.scrollWidth,n.offsetWidth):n.offsetWidth)-(parseInt(e(n).css("borderLeftWidth"),10)||0)-(parseInt(e(n).css("paddingRight"),10)||0)-this.helperProportions.width-this.margins.left,r.top+(i?Math.max(n.scrollHeight,n.offsetHeight):n.offsetHeight)-(parseInt(e(n).css("borderTopWidth"),10)||0)-(parseInt(e(n).css("paddingBottom"),10)||0)-this.helperProportions.height-this.margins.top]}},_convertPositionTo:function(t,n){n||(n=this.position);var r=t=="absolute"?1:-1,i=this.options,s=this.cssPosition!="absolute"||this.scrollParent[0]!=document&&!!e.ui.contains(this.scrollParent[0],this.offsetParent[0])?this.scrollParent:this.offsetParent,o=/(html|body)/i.test(s[0].tagName);return{top:n.top+this.offset.relative.top*r+this.offset.parent.top*r-(e.browser.safari&&this.cssPosition=="fixed"?0:(this.cssPosition=="fixed"?-this.scrollParent.scrollTop():o?0:s.scrollTop())*r),left:n.left+this.offset.relative.left*r+this.offset.parent.left*r-(e.browser.safari&&this.cssPosition=="fixed"?0:(this.cssPosition=="fixed"?-this.scrollParent.scrollLeft():o?0:s.scrollLeft())*r)}},_generatePosition:function(t){var n=this.options,r=this.cssPosition!="absolute"||this.scrollParent[0]!=document&&!!e.ui.contains(this.scrollParent[0],this.offsetParent[0])?this.scrollParent:this.offsetParent,i=/(html|body)/i.test(r[0].tagName);this.cssPosition=="relative"&&(this.scrollParent[0]==document||this.scrollParent[0]==this.offsetParent[0])&&(this.offset.relative=this._getRelativeOffset());var s=t.pageX,o=t.pageY;if(this.originalPosition){this.containment&&(t.pageX-this.offset.click.left<this.containment[0]&&(s=this.containment[0]+this.offset.click.left),t.pageY-this.offset.click.top<this.containment[1]&&(o=this.containment[1]+this.offset.click.top),t.pageX-this.offset.click.left>this.containment[2]&&(s=this.containment[2]+this.offset.click.left),t.pageY-this.offset.click.top>this.containment[3]&&(o=this.containment[3]+this.offset.click.top));if(n.grid){var u=this.originalPageY+Math.round((o-this.originalPageY)/n.grid[1])*n.grid[1];o=this.containment?u-this.offset.click.top<this.containment[1]||u-this.offset.click.top>this.containment[3]?u-this.offset.click.top<this.containment[1]?u+n.grid[1]:u-n.grid[1]:u:u;var f=this.originalPageX+Math.round((s-this.originalPageX)/n.grid[0])*n.grid[0];s=this.containment?f-this.offset.click.left<this.containment[0]||f-this.offset.click.left>this.containment[2]?f-this.offset.click.left<this.containment[0]?f+n.grid[0]:f-n.grid[0]:f:f}}return{top:o-this.offset.click.top-this.offset.relative.top-this.offset.parent.top+(e.browser.safari&&this.cssPosition=="fixed"?0:this.cssPosition=="fixed"?-this.scrollParent.scrollTop():i?0:r.scrollTop()),left:s-this.offset.click.left-this.offset.relative.left-this.offset.parent.left+(e.browser.safari&&this.cssPosition=="fixed"?0:this.cssPosition=="fixed"?-this.scrollParent.scrollLeft():i?0:r.scrollLeft())}},_rearrange:function(e,t,n,r){n?n[0].appendChild(this.placeholder[0]):t.item[0].parentNode.insertBefore(this.placeholder[0],this.direction=="down"?t.item[0]:t.item[0].nextSibling),this.counter=this.counter?++this.counter:1;var i=this,s=this.counter;window.setTimeout(function(){s==i.counter&&i.refreshPositions(!r)},0)},_clear:function(t,n){this.reverting=!1;var r=[],i=this;!this._noFinalSort&&this.currentItem.parent().length&&this.placeholder.before(this.currentItem),this._noFinalSort=null;if(this.helper[0]==this.currentItem[0]){for(var s in this._storedCSS)if(this._storedCSS[s]=="auto"||this._storedCSS[s]=="static")this._storedCSS[s]="";this.currentItem.css(this._storedCSS).removeClass("ui-sortable-helper")}else this.currentItem.show();this.fromOutside&&!n&&r.push(function(e){this._trigger("receive",e,this._uiHash(this.fromOutside))}),(this.fromOutside||this.domPosition.prev!=this.currentItem.prev().not(".ui-sortable-helper")[0]||this.domPosition.parent!=this.currentItem.parent()[0])&&!n&&r.push(function(e){this._trigger("update",e,this._uiHash())});if(!e.ui.contains(this.element[0],this.currentItem[0])){n||r.push(function(e){this._trigger("remove",e,this._uiHash())});for(var s=this.containers.length-1;s>=0;s--)e.ui.contains(this.containers[s].element[0],this.currentItem[0])&&!n&&(r.push(function(e){return function(t){e._trigger("receive",t,this._uiHash(this))}}.call(this,this.containers[s])),r.push(function(e){return function(t){e._trigger("update",t,this._uiHash(this))}}.call(this,this.containers[s])))}for(var s=this.containers.length-1;s>=0;s--)n||r.push(function(e){return function(t){e._trigger("deactivate",t,this._uiHash(this))}}.call(this,this.containers[s])),this.containers[s].containerCache.over&&(r.push(function(e){return function(t){e._trigger("out",t,this._uiHash(this))}}.call(this,this.containers[s])),this.containers[s].containerCache.over=0);this._storedCursor&&e("body").css("cursor",this._storedCursor),this._storedOpacity&&this.helper.css("opacity",this._storedOpacity),this._storedZIndex&&this.helper.css("zIndex",this._storedZIndex=="auto"?"":this._storedZIndex),this.dragging=!1;if(this.cancelHelperRemoval){if(!n){this._trigger("beforeStop",t,this._uiHash());for(var s=0;s<r.length;s++)r[s].call(this,t);this._trigger("stop",t,this._uiHash())}return this.fromOutside=!1,!1}n||this._trigger("beforeStop",t,this._uiHash()),this.placeholder[0].parentNode.removeChild(this.placeholder[0]),this.helper[0]!=this.currentItem[0]&&this.helper.remove(),this.helper=null;if(!n){for(var s=0;s<r.length;s++)r[s].call(this,t);this._trigger("stop",t,this._uiHash())}return this.fromOutside=!1,!0},_trigger:function(){e.Widget.prototype._trigger.apply(this,arguments)===!1&&this.cancel()},_uiHash:function(t){var n=t||this;return{helper:n.helper,placeholder:n.placeholder||e([]),position:n.position,originalPosition:n.originalPosition,offset:n.positionAbs,item:n.currentItem,sender:t?t.element:null}}}),e.extend(e.ui.sortable,{version:"1.8.22"})}(jQuery),jQuery.effects||function(e,t){function n(t){var n;return t&&t.constructor==Array&&t.length==3?t:(n=/rgb\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*\)/.exec(t))?[parseInt(n[1],10),parseInt(n[2],10),parseInt(n[3],10)]:(n=/rgb\(\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*\)/.exec(t))?[parseFloat(n[1])*2.55,parseFloat(n[2])*2.55,parseFloat(n[3])*2.55]:(n=/#([a-fA-F0-9]{2})([a-fA-F0-9]{2})([a-fA-F0-9]{2})/.exec(t))?[parseInt(n[1],16),parseInt(n[2],16),parseInt(n[3],16)]:(n=/#([a-fA-F0-9])([a-fA-F0-9])([a-fA-F0-9])/.exec(t))?[parseInt(n[1]+n[1],16),parseInt(n[2]+n[2],16),parseInt(n[3]+n[3],16)]:(n=/rgba\(0, 0, 0, 0\)/.exec(t))?f.transparent:f[e.trim(t).toLowerCase()]}function r(t,r){var i;do{i=(e.curCSS||e.css)(t,r);if(i!=""&&i!="transparent"||e.nodeName(t,"body"))break;r="backgroundColor"}while(t=t.parentNode);return n(i)}function i(){var e=document.defaultView?document.defaultView.getComputedStyle(this,null):this.currentStyle,t={},n,r;if(e&&e.length&&e[0]&&e[e[0]]){var i=e.length;while(i--)n=e[i],typeof e[n]=="string"&&(r=n.replace(/\-(\w)/g,function(e,t){return t.toUpperCase()}),t[r]=e[n])}else for(n in e)typeof e[n]=="string"&&(t[n]=e[n]);return t}function s(t){var n,r;for(n in t)r=t[n],(r==null||e.isFunction(r)||n in c||/scrollbar/.test(n)||!/color/i.test(n)&&isNaN(parseFloat(r)))&&delete t[n];return t}function o(e,t){var n={_:0},r;for(r in t)e[r]!=t[r]&&(n[r]=t[r]);return n}function u(t,n,r,i){typeof t=="object"&&(i=n,r=null,n=t,t=n.effect),e.isFunction(n)&&(i=n,r=null,n={});if(typeof n=="number"||e.fx.speeds[n])i=r,r=n,n={};return e.isFunction(r)&&(i=r,r=null),n=n||{},r=r||n.duration,r=e.fx.off?0:typeof r=="number"?r:r in e.fx.speeds?e.fx.speeds[r]:e.fx.speeds._default,i=i||n.complete,[t,n,r,i]}function a(t){return!t||typeof t=="number"||e.fx.speeds[t]?!0:typeof t=="string"&&!e.effects[t]?!0:!1}e.effects={},e.each(["backgroundColor","borderBottomColor","borderLeftColor","borderRightColor","borderTopColor","borderColor","color","outlineColor"],function(t,i){e.fx.step[i]=function(e){e.colorInit||(e.start=r(e.elem,i),e.end=n(e.end),e.colorInit=!0),e.elem.style[i]="rgb("+Math.max(Math.min(parseInt(e.pos*(e.end[0]-e.start[0])+e.start[0],10),255),0)+","+Math.max(Math.min(parseInt(e.pos*(e.end[1]-e.start[1])+e.start[1],10),255),0)+","+Math.max(Math.min(parseInt(e.pos*(e.end[2]-e.start[2])+e.start[2],10),255),0)+")"}});var f={aqua:[0,255,255],azure:[240,255,255],beige:[245,245,220],black:[0,0,0],blue:[0,0,255],brown:[165,42,42],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgrey:[169,169,169],darkgreen:[0,100,0],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkviolet:[148,0,211],fuchsia:[255,0,255],gold:[255,215,0],green:[0,128,0],indigo:[75,0,130],khaki:[240,230,140],lightblue:[173,216,230],lightcyan:[224,255,255],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightyellow:[255,255,224],lime:[0,255,0],magenta:[255,0,255],maroon:[128,0,0],navy:[0,0,128],olive:[128,128,0],orange:[255,165,0],pink:[255,192,203],purple:[128,0,128],violet:[128,0,128],red:[255,0,0],silver:[192,192,192],white:[255,255,255],yellow:[255,255,0],transparent:[255,255,255]},l=["add","remove","toggle"],c={border:1,borderBottom:1,borderColor:1,borderLeft:1,borderRight:1,borderTop:1,borderWidth:1,margin:1,padding:1};e.effects.animateClass=function(t,n,r,u){return e.isFunction(r)&&(u=r,r=null),this.queue(function(){var a=e(this),f=a.attr("style")||" ",c=s(i.call(this)),p,v=a.attr("class")||"";e.each(l,function(e,n){t[n]&&a[n+"Class"](t[n])}),p=s(i.call(this)),a.attr("class",v),a.animate(o(c,p),{queue:!1,duration:n,easing:r,complete:function(){e.each(l,function(e,n){t[n]&&a[n+"Class"](t[n])}),typeof a.attr("style")=="object"?(a.attr("style").cssText="",a.attr("style").cssText=f):a.attr("style",f),u&&u.apply(this,arguments),e.dequeue(this)}})})},e.fn.extend({_addClass:e.fn.addClass,addClass:function(t,n,r,i){return n?e.effects.animateClass.apply(this,[{add:t},n,r,i]):this._addClass(t)},_removeClass:e.fn.removeClass,removeClass:function(t,n,r,i){return n?e.effects.animateClass.apply(this,[{remove:t},n,r,i]):this._removeClass(t)},_toggleClass:e.fn.toggleClass,toggleClass:function(n,r,i,s,o){return typeof r=="boolean"||r===t?i?e.effects.animateClass.apply(this,[r?{add:n}:{remove:n},i,s,o]):this._toggleClass(n,r):e.effects.animateClass.apply(this,[{toggle:n},r,i,s])},switchClass:function(t,n,r,i,s){return e.effects.animateClass.apply(this,[{add:n,remove:t},r,i,s])}}),e.extend(e.effects,{version:"1.8.22",save:function(e,t){for(var n=0;n<t.length;n++)t[n]!==null&&e.data("ec.storage."+t[n],e[0].style[t[n]])},restore:function(e,t){for(var n=0;n<t.length;n++)t[n]!==null&&e.css(t[n],e.data("ec.storage."+t[n]))},setMode:function(e,t){return t=="toggle"&&(t=e.is(":hidden")?"show":"hide"),t},getBaseline:function(e,t){var n,r;switch(e[0]){case"top":n=0;break;case"middle":n=.5;break;case"bottom":n=1;break;default:n=e[0]/t.height}switch(e[1]){case"left":r=0;break;case"center":r=.5;break;case"right":r=1;break;default:r=e[1]/t.width}return{x:r,y:n}},createWrapper:function(t){if(t.parent().is(".ui-effects-wrapper"))return t.parent();var n={width:t.outerWidth(!0),height:t.outerHeight(!0),"float":t.css("float")},r=e("<div></div>").addClass("ui-effects-wrapper").css({fontSize:"100%",background:"transparent",border:"none",margin:0,padding:0}),i=document.activeElement;try{i.id}catch(s){i=document.body}return t.wrap(r),(t[0]===i||e.contains(t[0],i))&&e(i).focus(),r=t.parent(),t.css("position")=="static"?(r.css({position:"relative"}),t.css({position:"relative"})):(e.extend(n,{position:t.css("position"),zIndex:t.css("z-index")}),e.each(["top","left","bottom","right"],function(e,r){n[r]=t.css(r),isNaN(parseInt(n[r],10))&&(n[r]="auto")}),t.css({position:"relative",top:0,left:0,right:"auto",bottom:"auto"})),r.css(n).show()},removeWrapper:function(t){var n,r=document.activeElement;return t.parent().is(".ui-effects-wrapper")?(n=t.parent().replaceWith(t),(t[0]===r||e.contains(t[0],r))&&e(r).focus(),n):t},setTransition:function(t,n,r,i){return i=i||{},e.each(n,function(e,n){var s=t.cssUnit(n);s[0]>0&&(i[n]=s[0]*r+s[1])}),i}}),e.fn.extend({effect:function(t,n,r,i){var s=u.apply(this,arguments),o={options:s[1],duration:s[2],callback:s[3]},a=o.options.mode,f=e.effects[t];return e.fx.off||!f?a?this[a](o.duration,o.callback):this.each(function(){o.callback&&o.callback.call(this)}):f.call(this,o)},_show:e.fn.show,show:function(e){if(a(e))return this._show.apply(this,arguments);var t=u.apply(this,arguments);return t[1].mode="show",this.effect.apply(this,t)},_hide:e.fn.hide,hide:function(e){if(a(e))return this._hide.apply(this,arguments);var t=u.apply(this,arguments);return t[1].mode="hide",this.effect.apply(this,t)},__toggle:e.fn.toggle,toggle:function(t){if(a(t)||typeof t=="boolean"||e.isFunction(t))return this.__toggle.apply(this,arguments);var n=u.apply(this,arguments);return n[1].mode="toggle",this.effect.apply(this,n)},cssUnit:function(t){var n=this.css(t),r=[];return e.each(["em","px","%","pt"],function(e,t){n.indexOf(t)>0&&(r=[parseFloat(n),t])}),r}}),e.easing.jswing=e.easing.swing,e.extend(e.easing,{def:"easeOutQuad",swing:function(t,n,r,i,s){return e.easing[e.easing.def](t,n,r,i,s)},easeInQuad:function(e,t,n,r,i){return r*(t/=i)*t+n},easeOutQuad:function(e,t,n,r,i){return-r*(t/=i)*(t-2)+n},easeInOutQuad:function(e,t,n,r,i){return(t/=i/2)<1?r/2*t*t+n:-r/2*(--t*(t-2)-1)+n},easeInCubic:function(e,t,n,r,i){return r*(t/=i)*t*t+n},easeOutCubic:function(e,t,n,r,i){return r*((t=t/i-1)*t*t+1)+n},easeInOutCubic:function(e,t,n,r,i){return(t/=i/2)<1?r/2*t*t*t+n:r/2*((t-=2)*t*t+2)+n},easeInQuart:function(e,t,n,r,i){return r*(t/=i)*t*t*t+n},easeOutQuart:function(e,t,n,r,i){return-r*((t=t/i-1)*t*t*t-1)+n},easeInOutQuart:function(e,t,n,r,i){return(t/=i/2)<1?r/2*t*t*t*t+n:-r/2*((t-=2)*t*t*t-2)+n},easeInQuint:function(e,t,n,r,i){return r*(t/=i)*t*t*t*t+n},easeOutQuint:function(e,t,n,r,i){return r*((t=t/i-1)*t*t*t*t+1)+n},easeInOutQuint:function(e,t,n,r,i){return(t/=i/2)<1?r/2*t*t*t*t*t+n:r/2*((t-=2)*t*t*t*t+2)+n},easeInSine:function(e,t,n,r,i){return-r*Math.cos(t/i*(Math.PI/2))+r+n},easeOutSine:function(e,t,n,r,i){return r*Math.sin(t/i*(Math.PI/2))+n},easeInOutSine:function(e,t,n,r,i){return-r/2*(Math.cos(Math.PI*t/i)-1)+n},easeInExpo:function(e,t,n,r,i){return t==0?n:r*Math.pow(2,10*(t/i-1))+n},easeOutExpo:function(e,t,n,r,i){return t==i?n+r:r*(-Math.pow(2,-10*t/i)+1)+n},easeInOutExpo:function(e,t,n,r,i){return t==0?n:t==i?n+r:(t/=i/2)<1?r/2*Math.pow(2,10*(t-1))+n:r/2*(-Math.pow(2,-10*--t)+2)+n},easeInCirc:function(e,t,n,r,i){return-r*(Math.sqrt(1-(t/=i)*t)-1)+n},easeOutCirc:function(e,t,n,r,i){return r*Math.sqrt(1-(t=t/i-1)*t)+n},easeInOutCirc:function(e,t,n,r,i){return(t/=i/2)<1?-r/2*(Math.sqrt(1-t*t)-1)+n:r/2*(Math.sqrt(1-(t-=2)*t)+1)+n},easeInElastic:function(e,t,n,r,i){var s=1.70158,o=0,u=r;if(t==0)return n;if((t/=i)==1)return n+r;o||(o=i*.3);if(u<Math.abs(r)){u=r;var s=o/4}else var s=o/(2*Math.PI)*Math.asin(r/u);return-(u*Math.pow(2,10*(t-=1))*Math.sin((t*i-s)*2*Math.PI/o))+n},easeOutElastic:function(e,t,n,r,i){var s=1.70158,o=0,u=r;if(t==0)return n;if((t/=i)==1)return n+r;o||(o=i*.3);if(u<Math.abs(r)){u=r;var s=o/4}else var s=o/(2*Math.PI)*Math.asin(r/u);return u*Math.pow(2,-10*t)*Math.sin((t*i-s)*2*Math.PI/o)+r+n},easeInOutElastic:function(e,t,n,r,i){var s=1.70158,o=0,u=r;if(t==0)return n;if((t/=i/2)==2)return n+r;o||(o=i*.3*1.5);if(u<Math.abs(r)){u=r;var s=o/4}else var s=o/(2*Math.PI)*Math.asin(r/u);return t<1?-0.5*u*Math.pow(2,10*(t-=1))*Math.sin((t*i-s)*2*Math.PI/o)+n:u*Math.pow(2,-10*(t-=1))*Math.sin((t*i-s)*2*Math.PI/o)*.5+r+n},easeInBack:function(e,n,r,i,s,o){return o==t&&(o=1.70158),i*(n/=s)*n*((o+1)*n-o)+r},easeOutBack:function(e,n,r,i,s,o){return o==t&&(o=1.70158),i*((n=n/s-1)*n*((o+1)*n+o)+1)+r},easeInOutBack:function(e,n,r,i,s,o){return o==t&&(o=1.70158),(n/=s/2)<1?i/2*n*n*(((o*=1.525)+1)*n-o)+r:i/2*((n-=2)*n*(((o*=1.525)+1)*n+o)+2)+r},easeInBounce:function(t,n,r,i,s){return i-e.easing.easeOutBounce(t,s-n,0,i,s)+r},easeOutBounce:function(e,t,n,r,i){return(t/=i)<1/2.75?r*7.5625*t*t+n:t<2/2.75?r*(7.5625*(t-=1.5/2.75)*t+.75)+n:t<2.5/2.75?r*(7.5625*(t-=2.25/2.75)*t+.9375)+n:r*(7.5625*(t-=2.625/2.75)*t+.984375)+n},easeInOutBounce:function(t,n,r,i,s){return n<s/2?e.easing.easeInBounce(t,n*2,0,i,s)*.5+r:e.easing.easeOutBounce(t,n*2-s,0,i,s)*.5+i*.5+r}})}(jQuery),function(e,t){e.effects.blind=function(t){return this.queue(function(){var n=e(this),r=["position","top","bottom","left","right"],i=e.effects.setMode(n,t.options.mode||"hide"),s=t.options.direction||"vertical";e.effects.save(n,r),n.show();var o=e.effects.createWrapper(n).css({overflow:"hidden"}),u=s=="vertical"?"height":"width",f=s=="vertical"?o.height():o.width();i=="show"&&o.css(u,0);var l={};l[u]=i=="show"?f:0,o.animate(l,t.duration,t.options.easing,function(){i=="hide"&&n.hide(),e.effects.restore(n,r),e.effects.removeWrapper(n),t.callback&&t.callback.apply(n[0],arguments),n.dequeue()})})}}(jQuery),function(e,t){e.effects.bounce=function(t){return this.queue(function(){var n=e(this),r=["position","top","bottom","left","right"],i=e.effects.setMode(n,t.options.mode||"effect"),s=t.options.direction||"up",o=t.options.distance||20,u=t.options.times||5,f=t.duration||250;/show|hide/.test(i)&&r.push("opacity"),e.effects.save(n,r),n.show(),e.effects.createWrapper(n);var l=s=="up"||s=="down"?"top":"left",c=s=="up"||s=="left"?"pos":"neg",o=t.options.distance||(l=="top"?n.outerHeight(!0)/3:n.outerWidth(!0)/3);i=="show"&&n.css("opacity",0).css(l,c=="pos"?-o:o),i=="hide"&&(o/=u*2),i!="hide"&&u--;if(i=="show"){var h={opacity:1};h[l]=(c=="pos"?"+=":"-=")+o,n.animate(h,f/2,t.options.easing),o/=2,u--}for(var p=0;p<u;p++){var d={},v={};d[l]=(c=="pos"?"-=":"+=")+o,v[l]=(c=="pos"?"+=":"-=")+o,n.animate(d,f/2,t.options.easing).animate(v,f/2,t.options.easing),o=i=="hide"?o*2:o/2}if(i=="hide"){var h={opacity:0};h[l]=(c=="pos"?"-=":"+=")+o,n.animate(h,f/2,t.options.easing,function(){n.hide(),e.effects.restore(n,r),e.effects.removeWrapper(n),t.callback&&t.callback.apply(this,arguments)})}else{var d={},v={};d[l]=(c=="pos"?"-=":"+=")+o,v[l]=(c=="pos"?"+=":"-=")+o,n.animate(d,f/2,t.options.easing).animate(v,f/2,t.options.easing,function(){e.effects.restore(n,r),e.effects.removeWrapper(n),t.callback&&t.callback.apply(this,arguments)})}n.queue("fx",function(){n.dequeue()}),n.dequeue()})}}(jQuery),function(e,t){e.effects.clip=function(t){return this.queue(function(){var n=e(this),r=["position","top","bottom","left","right","height","width"],i=e.effects.setMode(n,t.options.mode||"hide"),s=t.options.direction||"vertical";e.effects.save(n,r),n.show();var o=e.effects.createWrapper(n).css({overflow:"hidden"}),u=n[0].tagName=="IMG"?o:n,f={size:s=="vertical"?"height":"width",position:s=="vertical"?"top":"left"},l=s=="vertical"?u.height():u.width();i=="show"&&(u.css(f.size,0),u.css(f.position,l/2));var c={};c[f.size]=i=="show"?l:0,c[f.position]=i=="show"?0:l/2,u.animate(c,{queue:!1,duration:t.duration,easing:t.options.easing,complete:function(){i=="hide"&&n.hide(),e.effects.restore(n,r),e.effects.removeWrapper(n),t.callback&&t.callback.apply(n[0],arguments),n.dequeue()}})})}}(jQuery),function(e,t){e.effects.drop=function(t){return this.queue(function(){var n=e(this),r=["position","top","bottom","left","right","opacity"],i=e.effects.setMode(n,t.options.mode||"hide"),s=t.options.direction||"left";e.effects.save(n,r),n.show(),e.effects.createWrapper(n);var o=s=="up"||s=="down"?"top":"left",u=s=="up"||s=="left"?"pos":"neg",f=t.options.distance||(o=="top"?n.outerHeight(!0)/2:n.outerWidth(!0)/2);i=="show"&&n.css("opacity",0).css(o,u=="pos"?-f:f);var l={opacity:i=="show"?1:0};l[o]=(i=="show"?u=="pos"?"+=":"-=":u=="pos"?"-=":"+=")+f,n.animate(l,{queue:!1,duration:t.duration,easing:t.options.easing,complete:function(){i=="hide"&&n.hide(),e.effects.restore(n,r),e.effects.removeWrapper(n),t.callback&&t.callback.apply(this,arguments),n.dequeue()}})})}}(jQuery),function(e,t){e.effects.explode=function(t){return this.queue(function(){var n=t.options.pieces?Math.round(Math.sqrt(t.options.pieces)):3,r=t.options.pieces?Math.round(Math.sqrt(t.options.pieces)):3;t.options.mode=t.options.mode=="toggle"?e(this).is(":visible")?"hide":"show":t.options.mode;var i=e(this).show().css("visibility","hidden"),s=i.offset();s.top-=parseInt(i.css("marginTop"),10)||0,s.left-=parseInt(i.css("marginLeft"),10)||0;var o=i.outerWidth(!0),u=i.outerHeight(!0);for(var f=0;f<n;f++)for(var l=0;l<r;l++)i.clone().appendTo("body").wrap("<div></div>").css({position:"absolute",visibility:"visible",left:-l*(o/r),top:-f*(u/n)}).parent().addClass("ui-effects-explode").css({position:"absolute",overflow:"hidden",width:o/r,height:u/n,left:s.left+l*(o/r)+(t.options.mode=="show"?(l-Math.floor(r/2))*(o/r):0),top:s.top+f*(u/n)+(t.options.mode=="show"?(f-Math.floor(n/2))*(u/n):0),opacity:t.options.mode=="show"?0:1}).animate({left:s.left+l*(o/r)+(t.options.mode=="show"?0:(l-Math.floor(r/2))*(o/r)),top:s.top+f*(u/n)+(t.options.mode=="show"?0:(f-Math.floor(n/2))*(u/n)),opacity:t.options.mode=="show"?1:0},t.duration||500);setTimeout(function(){t.options.mode=="show"?i.css({visibility:"visible"}):i.css({visibility:"visible"}).hide(),t.callback&&t.callback.apply(i[0]),i.dequeue(),e("div.ui-effects-explode").remove()},t.duration||500)})}}(jQuery),function(e,t){e.effects.fade=function(t){return this.queue(function(){var n=e(this),r=e.effects.setMode(n,t.options.mode||"hide");n.animate({opacity:r},{queue:!1,duration:t.duration,easing:t.options.easing,complete:function(){t.callback&&t.callback.apply(this,arguments),n.dequeue()}})})}}(jQuery),function(e,t){e.effects.fold=function(t){return this.queue(function(){var n=e(this),r=["position","top","bottom","left","right"],i=e.effects.setMode(n,t.options.mode||"hide"),s=t.options.size||15,o=!!t.options.horizFirst,u=t.duration?t.duration/2:e.fx.speeds._default/2;e.effects.save(n,r),n.show();var f=e.effects.createWrapper(n).css({overflow:"hidden"}),l=i=="show"!=o,c=l?["width","height"]:["height","width"],h=l?[f.width(),f.height()]:[f.height(),f.width()],p=/([0-9]+)%/.exec(s);p&&(s=parseInt(p[1],10)/100*h[i=="hide"?0:1]),i=="show"&&f.css(o?{height:0,width:s}:{height:s,width:0});var d={},v={};d[c[0]]=i=="show"?h[0]:s,v[c[1]]=i=="show"?h[1]:0,f.animate(d,u,t.options.easing).animate(v,u,t.options.easing,function(){i=="hide"&&n.hide(),e.effects.restore(n,r),e.effects.removeWrapper(n),t.callback&&t.callback.apply(n[0],arguments),n.dequeue()})})}}(jQuery),function(e,t){e.effects.highlight=function(t){return this.queue(function(){var n=e(this),r=["backgroundImage","backgroundColor","opacity"],i=e.effects.setMode(n,t.options.mode||"show"),s={backgroundColor:n.css("backgroundColor")};i=="hide"&&(s.opacity=0),e.effects.save(n,r),n.show().css({backgroundImage:"none",backgroundColor:t.options.color||"#ffff99"}).animate(s,{queue:!1,duration:t.duration,easing:t.options.easing,complete:function(){i=="hide"&&n.hide(),e.effects.restore(n,r),i=="show"&&!e.support.opacity&&this.style.removeAttribute("filter"),t.callback&&t.callback.apply(this,arguments),n.dequeue()}})})}}(jQuery),function(e,t){e.effects.pulsate=function(t){return this.queue(function(){var n=e(this),r=e.effects.setMode(n,t.options.mode||"show"),i=(t.options.times||5)*2-1,s=t.duration?t.duration/2:e.fx.speeds._default/2,o=n.is(":visible"),u=0;o||(n.css("opacity",0).show(),u=1),(r=="hide"&&o||r=="show"&&!o)&&i--;for(var f=0;f<i;f++)n.animate({opacity:u},s,t.options.easing),u=(u+1)%2;n.animate({opacity:u},s,t.options.easing,function(){u==0&&n.hide(),t.callback&&t.callback.apply(this,arguments)}),n.queue("fx",function(){n.dequeue()}).dequeue()})}}(jQuery),function(e,t){e.effects.puff=function(t){return this.queue(function(){var n=e(this),r=e.effects.setMode(n,t.options.mode||"hide"),i=parseInt(t.options.percent,10)||150,s=i/100,o={height:n.height(),width:n.width()};e.extend(t.options,{fade:!0,mode:r,percent:r=="hide"?i:100,from:r=="hide"?o:{height:o.height*s,width:o.width*s}}),n.effect("scale",t.options,t.duration,t.callback),n.dequeue()})},e.effects.scale=function(t){return this.queue(function(){var n=e(this),r=e.extend(!0,{},t.options),i=e.effects.setMode(n,t.options.mode||"effect"),s=parseInt(t.options.percent,10)||(parseInt(t.options.percent,10)==0?0:i=="hide"?0:100),o=t.options.direction||"both",u=t.options.origin;i!="effect"&&(r.origin=u||["middle","center"],r.restore=!0);var f={height:n.height(),width:n.width()};n.from=t.options.from||(i=="show"?{height:0,width:0}:f);var l={y:o!="horizontal"?s/100:1,x:o!="vertical"?s/100:1};n.to={height:f.height*l.y,width:f.width*l.x},t.options.fade&&(i=="show"&&(n.from.opacity=0,n.to.opacity=1),i=="hide"&&(n.from.opacity=1,n.to.opacity=0)),r.from=n.from,r.to=n.to,r.mode=i,n.effect("size",r,t.duration,t.callback),n.dequeue()})},e.effects.size=function(t){return this.queue(function(){var n=e(this),r=["position","top","bottom","left","right","width","height","overflow"
,"opacity"],i=["position","top","bottom","left","right","overflow","opacity"],s=["width","height","overflow"],o=["fontSize"],u=["borderTopWidth","borderBottomWidth","paddingTop","paddingBottom"],f=["borderLeftWidth","borderRightWidth","paddingLeft","paddingRight"],l=e.effects.setMode(n,t.options.mode||"effect"),c=t.options.restore||!1,h=t.options.scale||"both",p=t.options.origin,d={height:n.height(),width:n.width()};n.from=t.options.from||d,n.to=t.options.to||d;if(p){var v=e.effects.getBaseline(p,d);n.from.top=(d.height-n.from.height)*v.y,n.from.left=(d.width-n.from.width)*v.x,n.to.top=(d.height-n.to.height)*v.y,n.to.left=(d.width-n.to.width)*v.x}var m={from:{y:n.from.height/d.height,x:n.from.width/d.width},to:{y:n.to.height/d.height,x:n.to.width/d.width}};if(h=="box"||h=="both")m.from.y!=m.to.y&&(r=r.concat(u),n.from=e.effects.setTransition(n,u,m.from.y,n.from),n.to=e.effects.setTransition(n,u,m.to.y,n.to)),m.from.x!=m.to.x&&(r=r.concat(f),n.from=e.effects.setTransition(n,f,m.from.x,n.from),n.to=e.effects.setTransition(n,f,m.to.x,n.to));(h=="content"||h=="both")&&m.from.y!=m.to.y&&(r=r.concat(o),n.from=e.effects.setTransition(n,o,m.from.y,n.from),n.to=e.effects.setTransition(n,o,m.to.y,n.to)),e.effects.save(n,c?r:i),n.show(),e.effects.createWrapper(n),n.css("overflow","hidden").css(n.from);if(h=="content"||h=="both")u=u.concat(["marginTop","marginBottom"]).concat(o),f=f.concat(["marginLeft","marginRight"]),s=r.concat(u).concat(f),n.find("*[width]").each(function(){var n=e(this);c&&e.effects.save(n,s);var r={height:n.height(),width:n.width()};n.from={height:r.height*m.from.y,width:r.width*m.from.x},n.to={height:r.height*m.to.y,width:r.width*m.to.x},m.from.y!=m.to.y&&(n.from=e.effects.setTransition(n,u,m.from.y,n.from),n.to=e.effects.setTransition(n,u,m.to.y,n.to)),m.from.x!=m.to.x&&(n.from=e.effects.setTransition(n,f,m.from.x,n.from),n.to=e.effects.setTransition(n,f,m.to.x,n.to)),n.css(n.from),n.animate(n.to,t.duration,t.options.easing,function(){c&&e.effects.restore(n,s)})});n.animate(n.to,{queue:!1,duration:t.duration,easing:t.options.easing,complete:function(){n.to.opacity===0&&n.css("opacity",n.from.opacity),l=="hide"&&n.hide(),e.effects.restore(n,c?r:i),e.effects.removeWrapper(n),t.callback&&t.callback.apply(this,arguments),n.dequeue()}})})}}(jQuery),function(e,t){e.effects.shake=function(t){return this.queue(function(){var n=e(this),r=["position","top","bottom","left","right"],i=e.effects.setMode(n,t.options.mode||"effect"),s=t.options.direction||"left",o=t.options.distance||20,u=t.options.times||3,f=t.duration||t.options.duration||140;e.effects.save(n,r),n.show(),e.effects.createWrapper(n);var l=s=="up"||s=="down"?"top":"left",c=s=="up"||s=="left"?"pos":"neg",h={},p={},d={};h[l]=(c=="pos"?"-=":"+=")+o,p[l]=(c=="pos"?"+=":"-=")+o*2,d[l]=(c=="pos"?"-=":"+=")+o*2,n.animate(h,f,t.options.easing);for(var v=1;v<u;v++)n.animate(p,f,t.options.easing).animate(d,f,t.options.easing);n.animate(p,f,t.options.easing).animate(h,f/2,t.options.easing,function(){e.effects.restore(n,r),e.effects.removeWrapper(n),t.callback&&t.callback.apply(this,arguments)}),n.queue("fx",function(){n.dequeue()}),n.dequeue()})}}(jQuery),function(e,t){e.effects.slide=function(t){return this.queue(function(){var n=e(this),r=["position","top","bottom","left","right"],i=e.effects.setMode(n,t.options.mode||"show"),s=t.options.direction||"left";e.effects.save(n,r),n.show(),e.effects.createWrapper(n).css({overflow:"hidden"});var o=s=="up"||s=="down"?"top":"left",u=s=="up"||s=="left"?"pos":"neg",f=t.options.distance||(o=="top"?n.outerHeight(!0):n.outerWidth(!0));i=="show"&&n.css(o,u=="pos"?isNaN(f)?"-"+f:-f:f);var l={};l[o]=(i=="show"?u=="pos"?"+=":"-=":u=="pos"?"-=":"+=")+f,n.animate(l,{queue:!1,duration:t.duration,easing:t.options.easing,complete:function(){i=="hide"&&n.hide(),e.effects.restore(n,r),e.effects.removeWrapper(n),t.callback&&t.callback.apply(this,arguments),n.dequeue()}})})}}(jQuery),function(e,t){e.effects.transfer=function(t){return this.queue(function(){var n=e(this),r=e(t.options.to),i=r.offset(),s={top:i.top,left:i.left,height:r.innerHeight(),width:r.innerWidth()},o=n.offset(),u=e('<div class="ui-effects-transfer"></div>').appendTo(document.body).addClass(t.options.className).css({top:o.top,left:o.left,height:n.innerHeight(),width:n.innerWidth(),position:"absolute"}).animate(s,t.duration,t.options.easing,function(){u.remove(),t.callback&&t.callback.apply(n[0],arguments),n.dequeue()})})}}(jQuery),function(e,t){e.widget("ui.accordion",{options:{active:0,animated:"slide",autoHeight:!0,clearStyle:!1,collapsible:!1,event:"click",fillSpace:!1,header:"> li > :first-child,> :not(li):even",icons:{header:"ui-icon-triangle-1-e",headerSelected:"ui-icon-triangle-1-s"},navigation:!1,navigationFilter:function(){return this.href.toLowerCase()===location.href.toLowerCase()}},_create:function(){var t=this,n=t.options;t.running=0,t.element.addClass("ui-accordion ui-widget ui-helper-reset").children("li").addClass("ui-accordion-li-fix"),t.headers=t.element.find(n.header).addClass("ui-accordion-header ui-helper-reset ui-state-default ui-corner-all").bind("mouseenter.accordion",function(){if(n.disabled)return;e(this).addClass("ui-state-hover")}).bind("mouseleave.accordion",function(){if(n.disabled)return;e(this).removeClass("ui-state-hover")}).bind("focus.accordion",function(){if(n.disabled)return;e(this).addClass("ui-state-focus")}).bind("blur.accordion",function(){if(n.disabled)return;e(this).removeClass("ui-state-focus")}),t.headers.next().addClass("ui-accordion-content ui-helper-reset ui-widget-content ui-corner-bottom");if(n.navigation){var r=t.element.find("a").filter(n.navigationFilter).eq(0);if(r.length){var i=r.closest(".ui-accordion-header");i.length?t.active=i:t.active=r.closest(".ui-accordion-content").prev()}}t.active=t._findActive(t.active||n.active).addClass("ui-state-default ui-state-active").toggleClass("ui-corner-all").toggleClass("ui-corner-top"),t.active.next().addClass("ui-accordion-content-active"),t._createIcons(),t.resize(),t.element.attr("role","tablist"),t.headers.attr("role","tab").bind("keydown.accordion",function(e){return t._keydown(e)}).next().attr("role","tabpanel"),t.headers.not(t.active||"").attr({"aria-expanded":"false","aria-selected":"false",tabIndex:-1}).next().hide(),t.active.length?t.active.attr({"aria-expanded":"true","aria-selected":"true",tabIndex:0}):t.headers.eq(0).attr("tabIndex",0),e.browser.safari||t.headers.find("a").attr("tabIndex",-1),n.event&&t.headers.bind(n.event.split(" ").join(".accordion ")+".accordion",function(e){t._clickHandler.call(t,e,this),e.preventDefault()})},_createIcons:function(){var t=this.options;t.icons&&(e("<span></span>").addClass("ui-icon "+t.icons.header).prependTo(this.headers),this.active.children(".ui-icon").toggleClass(t.icons.header).toggleClass(t.icons.headerSelected),this.element.addClass("ui-accordion-icons"))},_destroyIcons:function(){this.headers.children(".ui-icon").remove(),this.element.removeClass("ui-accordion-icons")},destroy:function(){var t=this.options;this.element.removeClass("ui-accordion ui-widget ui-helper-reset").removeAttr("role"),this.headers.unbind(".accordion").removeClass("ui-accordion-header ui-accordion-disabled ui-helper-reset ui-state-default ui-corner-all ui-state-active ui-state-disabled ui-corner-top").removeAttr("role").removeAttr("aria-expanded").removeAttr("aria-selected").removeAttr("tabIndex"),this.headers.find("a").removeAttr("tabIndex"),this._destroyIcons();var n=this.headers.next().css("display","").removeAttr("role").removeClass("ui-helper-reset ui-widget-content ui-corner-bottom ui-accordion-content ui-accordion-content-active ui-accordion-disabled ui-state-disabled");return(t.autoHeight||t.fillHeight)&&n.css("height",""),e.Widget.prototype.destroy.call(this)},_setOption:function(t,n){e.Widget.prototype._setOption.apply(this,arguments),t=="active"&&this.activate(n),t=="icons"&&(this._destroyIcons(),n&&this._createIcons()),t=="disabled"&&this.headers.add(this.headers.next())[n?"addClass":"removeClass"]("ui-accordion-disabled ui-state-disabled")},_keydown:function(t){if(this.options.disabled||t.altKey||t.ctrlKey)return;var n=e.ui.keyCode,r=this.headers.length,i=this.headers.index(t.target),s=!1;switch(t.keyCode){case n.RIGHT:case n.DOWN:s=this.headers[(i+1)%r];break;case n.LEFT:case n.UP:s=this.headers[(i-1+r)%r];break;case n.SPACE:case n.ENTER:this._clickHandler({target:t.target},t.target),t.preventDefault()}return s?(e(t.target).attr("tabIndex",-1),e(s).attr("tabIndex",0),s.focus(),!1):!0},resize:function(){var t=this.options,n;if(t.fillSpace){if(e.browser.msie){var r=this.element.parent().css("overflow");this.element.parent().css("overflow","hidden")}n=this.element.parent().height(),e.browser.msie&&this.element.parent().css("overflow",r),this.headers.each(function(){n-=e(this).outerHeight(!0)}),this.headers.next().each(function(){e(this).height(Math.max(0,n-e(this).innerHeight()+e(this).height()))}).css("overflow","auto")}else t.autoHeight&&(n=0,this.headers.next().each(function(){n=Math.max(n,e(this).height("").height())}).height(n));return this},activate:function(e){this.options.active=e;var t=this._findActive(e)[0];return this._clickHandler({target:t},t),this},_findActive:function(t){return t?typeof t=="number"?this.headers.filter(":eq("+t+")"):this.headers.not(this.headers.not(t)):t===!1?e([]):this.headers.filter(":eq(0)")},_clickHandler:function(t,n){var r=this.options;if(r.disabled)return;if(!t.target){if(!r.collapsible)return;this.active.removeClass("ui-state-active ui-corner-top").addClass("ui-state-default ui-corner-all").children(".ui-icon").removeClass(r.icons.headerSelected).addClass(r.icons.header),this.active.next().addClass("ui-accordion-content-active");var i=this.active.next(),s={options:r,newHeader:e([]),oldHeader:r.active,newContent:e([]),oldContent:i},o=this.active=e([]);this._toggle(o,i,s);return}var u=e(t.currentTarget||n),f=u[0]===this.active[0];r.active=r.collapsible&&f?!1:this.headers.index(u);if(this.running||!r.collapsible&&f)return;var l=this.active,o=u.next(),i=this.active.next(),s={options:r,newHeader:f&&r.collapsible?e([]):u,oldHeader:this.active,newContent:f&&r.collapsible?e([]):o,oldContent:i},c=this.headers.index(this.active[0])>this.headers.index(u[0]);this.active=f?e([]):u,this._toggle(o,i,s,f,c),l.removeClass("ui-state-active ui-corner-top").addClass("ui-state-default ui-corner-all").children(".ui-icon").removeClass(r.icons.headerSelected).addClass(r.icons.header),f||(u.removeClass("ui-state-default ui-corner-all").addClass("ui-state-active ui-corner-top").children(".ui-icon").removeClass(r.icons.header).addClass(r.icons.headerSelected),u.next().addClass("ui-accordion-content-active"));return},_toggle:function(t,n,r,i,s){var o=this,u=o.options;o.toShow=t,o.toHide=n,o.data=r;var f=function(){if(!o)return;return o._completed.apply(o,arguments)};o._trigger("changestart",null,o.data),o.running=n.size()===0?t.size():n.size();if(u.animated){var l={};u.collapsible&&i?l={toShow:e([]),toHide:n,complete:f,down:s,autoHeight:u.autoHeight||u.fillSpace}:l={toShow:t,toHide:n,complete:f,down:s,autoHeight:u.autoHeight||u.fillSpace},u.proxied||(u.proxied=u.animated),u.proxiedDuration||(u.proxiedDuration=u.duration),u.animated=e.isFunction(u.proxied)?u.proxied(l):u.proxied,u.duration=e.isFunction(u.proxiedDuration)?u.proxiedDuration(l):u.proxiedDuration;var c=e.ui.accordion.animations,h=u.duration,p=u.animated;p&&!c[p]&&!e.easing[p]&&(p="slide"),c[p]||(c[p]=function(e){this.slide(e,{easing:p,duration:h||700})}),c[p](l)}else u.collapsible&&i?t.toggle():(n.hide(),t.show()),f(!0);n.prev().attr({"aria-expanded":"false","aria-selected":"false",tabIndex:-1}).blur(),t.prev().attr({"aria-expanded":"true","aria-selected":"true",tabIndex:0}).focus()},_completed:function(e){this.running=e?0:--this.running;if(this.running)return;this.options.clearStyle&&this.toShow.add(this.toHide).css({height:"",overflow:""}),this.toHide.removeClass("ui-accordion-content-active"),this.toHide.length&&(this.toHide.parent()[0].className=this.toHide.parent()[0].className),this._trigger("change",null,this.data)}}),e.extend(e.ui.accordion,{version:"1.8.22",animations:{slide:function(t,n){t=e.extend({easing:"swing",duration:300},t,n);if(!t.toHide.size()){t.toShow.animate({height:"show",paddingTop:"show",paddingBottom:"show"},t);return}if(!t.toShow.size()){t.toHide.animate({height:"hide",paddingTop:"hide",paddingBottom:"hide"},t);return}var r=t.toShow.css("overflow"),i=0,s={},o={},u=["height","paddingTop","paddingBottom"],f,l=t.toShow;f=l[0].style.width,l.width(l.parent().width()-parseFloat(l.css("paddingLeft"))-parseFloat(l.css("paddingRight"))-(parseFloat(l.css("borderLeftWidth"))||0)-(parseFloat(l.css("borderRightWidth"))||0)),e.each(u,function(n,r){o[r]="hide";var i=(""+e.css(t.toShow[0],r)).match(/^([\d+-.]+)(.*)$/);s[r]={value:i[1],unit:i[2]||"px"}}),t.toShow.css({height:0,overflow:"hidden"}).show(),t.toHide.filter(":hidden").each(t.complete).end().filter(":visible").animate(o,{step:function(e,n){n.prop=="height"&&(i=n.end-n.start===0?0:(n.now-n.start)/(n.end-n.start)),t.toShow[0].style[n.prop]=i*s[n.prop].value+s[n.prop].unit},duration:t.duration,easing:t.easing,complete:function(){t.autoHeight||t.toShow.css("height",""),t.toShow.css({width:f,overflow:r}),t.complete()}})},bounceslide:function(e){this.slide(e,{easing:e.down?"easeOutBounce":"swing",duration:e.down?1e3:200})}}})}(jQuery),function(e,t){var n=0;e.widget("ui.autocomplete",{options:{appendTo:"body",autoFocus:!1,delay:300,minLength:1,position:{my:"left top",at:"left bottom",collision:"none"},source:null},pending:0,_create:function(){var t=this,n=this.element[0].ownerDocument,r;this.isMultiLine=this.element.is("textarea"),this.element.addClass("ui-autocomplete-input").attr("autocomplete","off").attr({role:"textbox","aria-autocomplete":"list","aria-haspopup":"true"}).bind("keydown.autocomplete",function(n){if(t.options.disabled||t.element.propAttr("readOnly"))return;r=!1;var i=e.ui.keyCode;switch(n.keyCode){case i.PAGE_UP:t._move("previousPage",n);break;case i.PAGE_DOWN:t._move("nextPage",n);break;case i.UP:t._keyEvent("previous",n);break;case i.DOWN:t._keyEvent("next",n);break;case i.ENTER:case i.NUMPAD_ENTER:t.menu.active&&(r=!0,n.preventDefault());case i.TAB:if(!t.menu.active)return;t.menu.select(n);break;case i.ESCAPE:t.element.val(t.term),t.close(n);break;default:clearTimeout(t.searching),t.searching=setTimeout(function(){t.term!=t.element.val()&&(t.selectedItem=null,t.search(null,n))},t.options.delay)}}).bind("keypress.autocomplete",function(e){r&&(r=!1,e.preventDefault())}).bind("focus.autocomplete",function(){if(t.options.disabled)return;t.selectedItem=null,t.previous=t.element.val()}).bind("blur.autocomplete",function(e){if(t.options.disabled)return;clearTimeout(t.searching),t.closing=setTimeout(function(){t.close(e),t._change(e)},150)}),this._initSource(),this.menu=e("<ul></ul>").addClass("ui-autocomplete").appendTo(e(this.options.appendTo||"body",n)[0]).mousedown(function(n){var r=t.menu.element[0];e(n.target).closest(".ui-menu-item").length||setTimeout(function(){e(document).one("mousedown",function(n){n.target!==t.element[0]&&n.target!==r&&!e.ui.contains(r,n.target)&&t.close()})},1),setTimeout(function(){clearTimeout(t.closing)},13)}).menu({focus:function(e,n){var r=n.item.data("item.autocomplete");!1!==t._trigger("focus",e,{item:r})&&/^key/.test(e.originalEvent.type)&&t.element.val(r.value)},selected:function(e,r){var i=r.item.data("item.autocomplete"),s=t.previous;t.element[0]!==n.activeElement&&(t.element.focus(),t.previous=s,setTimeout(function(){t.previous=s,t.selectedItem=i},1)),!1!==t._trigger("select",e,{item:i})&&t.element.val(i.value),t.term=t.element.val(),t.close(e),t.selectedItem=i},blur:function(e,n){t.menu.element.is(":visible")&&t.element.val()!==t.term&&t.element.val(t.term)}}).zIndex(this.element.zIndex()+1).css({top:0,left:0}).hide().data("menu"),e.fn.bgiframe&&this.menu.element.bgiframe(),t.beforeunloadHandler=function(){t.element.removeAttr("autocomplete")},e(window).bind("beforeunload",t.beforeunloadHandler)},destroy:function(){this.element.removeClass("ui-autocomplete-input").removeAttr("autocomplete").removeAttr("role").removeAttr("aria-autocomplete").removeAttr("aria-haspopup"),this.menu.element.remove(),e(window).unbind("beforeunload",this.beforeunloadHandler),e.Widget.prototype.destroy.call(this)},_setOption:function(t,n){e.Widget.prototype._setOption.apply(this,arguments),t==="source"&&this._initSource(),t==="appendTo"&&this.menu.element.appendTo(e(n||"body",this.element[0].ownerDocument)[0]),t==="disabled"&&n&&this.xhr&&this.xhr.abort()},_initSource:function(){var t=this,n,r;e.isArray(this.options.source)?(n=this.options.source,this.source=function(t,r){r(e.ui.autocomplete.filter(n,t.term))}):typeof this.options.source=="string"?(r=this.options.source,this.source=function(n,i){t.xhr&&t.xhr.abort(),t.xhr=e.ajax({url:r,data:n,dataType:"json",success:function(e,t){i(e)},error:function(){i([])}})}):this.source=this.options.source},search:function(e,t){e=e!=null?e:this.element.val(),this.term=this.element.val();if(e.length<this.options.minLength)return this.close(t);clearTimeout(this.closing);if(this._trigger("search",t)===!1)return;return this._search(e)},_search:function(e){this.pending++,this.element.addClass("ui-autocomplete-loading"),this.source({term:e},this._response())},_response:function(){var e=this,t=++n;return function(r){t===n&&e.__response(r),e.pending--,e.pending||e.element.removeClass("ui-autocomplete-loading")}},__response:function(e){!this.options.disabled&&e&&e.length?(e=this._normalize(e),this._suggest(e),this._trigger("open")):this.close()},close:function(e){clearTimeout(this.closing),this.menu.element.is(":visible")&&(this.menu.element.hide(),this.menu.deactivate(),this._trigger("close",e))},_change:function(e){this.previous!==this.element.val()&&this._trigger("change",e,{item:this.selectedItem})},_normalize:function(t){return t.length&&t[0].label&&t[0].value?t:e.map(t,function(t){return typeof t=="string"?{label:t,value:t}:e.extend({label:t.label||t.value,value:t.value||t.label},t)})},_suggest:function(t){var n=this.menu.element.empty().zIndex(this.element.zIndex()+1);this._renderMenu(n,t),this.menu.deactivate(),this.menu.refresh(),n.show(),this._resizeMenu(),n.position(e.extend({of:this.element},this.options.position)),this.options.autoFocus&&this.menu.next(new e.Event("mouseover"))},_resizeMenu:function(){var e=this.menu.element;e.outerWidth(Math.max(e.width("").outerWidth()+1,this.element.outerWidth()))},_renderMenu:function(t,n){var r=this;e.each(n,function(e,n){r._renderItem(t,n)})},_renderItem:function(t,n){return e("<li></li>").data("item.autocomplete",n).append(e("<a></a>").text(n.label)).appendTo(t)},_move:function(e,t){if(!this.menu.element.is(":visible")){this.search(null,t);return}if(this.menu.first()&&/^previous/.test(e)||this.menu.last()&&/^next/.test(e)){this.element.val(this.term),this.menu.deactivate();return}this.menu[e](t)},widget:function(){return this.menu.element},_keyEvent:function(e,t){if(!this.isMultiLine||this.menu.element.is(":visible"))this._move(e,t),t.preventDefault()}}),e.extend(e.ui.autocomplete,{escapeRegex:function(e){return e.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&")},filter:function(t,n){var r=new RegExp(e.ui.autocomplete.escapeRegex(n),"i");return e.grep(t,function(e){return r.test(e.label||e.value||e)})}})}(jQuery),function(e){e.widget("ui.menu",{_create:function(){var t=this;this.element.addClass("ui-menu ui-widget ui-widget-content ui-corner-all").attr({role:"listbox","aria-activedescendant":"ui-active-menuitem"}).click(function(n){if(!e(n.target).closest(".ui-menu-item a").length)return;n.preventDefault(),t.select(n)}),this.refresh()},refresh:function(){var t=this,n=this.element.children("li:not(.ui-menu-item):has(a)").addClass("ui-menu-item").attr("role","menuitem");n.children("a").addClass("ui-corner-all").attr("tabindex",-1).mouseenter(function(n){t.activate(n,e(this).parent())}).mouseleave(function(){t.deactivate()})},activate:function(e,t){this.deactivate();if(this.hasScroll()){var n=t.offset().top-this.element.offset().top,r=this.element.scrollTop(),i=this.element.height();n<0?this.element.scrollTop(r+n):n>=i&&this.element.scrollTop(r+n-i+t.height())}this.active=t.eq(0).children("a").addClass("ui-state-hover").attr("id","ui-active-menuitem").end(),this._trigger("focus",e,{item:t})},deactivate:function(){if(!this.active)return;this.active.children("a").removeClass("ui-state-hover").removeAttr("id"),this._trigger("blur"),this.active=null},next:function(e){this.move("next",".ui-menu-item:first",e)},previous:function(e){this.move("prev",".ui-menu-item:last",e)},first:function(){return this.active&&!this.active.prevAll(".ui-menu-item").length},last:function(){return this.active&&!this.active.nextAll(".ui-menu-item").length},move:function(e,t,n){if(!this.active){this.activate(n,this.element.children(t));return}var r=this.active[e+"All"](".ui-menu-item").eq(0);r.length?this.activate(n,r):this.activate(n,this.element.children(t))},nextPage:function(t){if(this.hasScroll()){if(!this.active||this.last()){this.activate(t,this.element.children(".ui-menu-item:first"));return}var n=this.active.offset().top,r=this.element.height(),i=this.element.children(".ui-menu-item").filter(function(){var t=e(this).offset().top-n-r+e(this).height();return t<10&&t>-10});i.length||(i=this.element.children(".ui-menu-item:last")),this.activate(t,i)}else this.activate(t,this.element.children(".ui-menu-item").filter(!this.active||this.last()?":first":":last"))},previousPage:function(t){if(this.hasScroll()){if(!this.active||this.first()){this.activate(t,this.element.children(".ui-menu-item:last"));return}var n=this.active.offset().top,r=this.element.height(),i=this.element.children(".ui-menu-item").filter(function(){var t=e(this).offset().top-n+r-e(this).height();return t<10&&t>-10});i.length||(i=this.element.children(".ui-menu-item:first")),this.activate(t,i)}else this.activate(t,this.element.children(".ui-menu-item").filter(!this.active||this.first()?":last":":first"))},hasScroll:function(){return this.element.height()<this.element[e.fn.prop?"prop":"attr"]("scrollHeight")},select:function(e){this._trigger("selected",e,{item:this.active})}})}(jQuery),function(e,t){var n,r,i,s,o="ui-button ui-widget ui-state-default ui-corner-all",u="ui-state-hover ui-state-active ",a="ui-button-icons-only ui-button-icon-only ui-button-text-icons ui-button-text-icon-primary ui-button-text-icon-secondary ui-button-text-only",f=function(){var t=e(this).find(":ui-button");setTimeout(function(){t.button("refresh")},1)},l=function(t){var n=t.name,r=t.form,i=e([]);return n&&(r?i=e(r).find("[name='"+n+"']"):i=e("[name='"+n+"']",t.ownerDocument).filter(function(){return!this.form})),i};e.widget("ui.button",{options:{disabled:null,text:!0,label:null,icons:{primary:null,secondary:null}},_create:function(){this.element.closest("form").unbind("reset.button").bind("reset.button",f),typeof this.options.disabled!="boolean"?this.options.disabled=!!this.element.propAttr("disabled"):this.element.propAttr("disabled",this.options.disabled),this._determineButtonType(),this.hasTitle=!!this.buttonElement.attr("title");var t=this,u=this.options,a=this.type==="checkbox"||this.type==="radio",h="ui-state-hover"+(a?"":" ui-state-active"),p="ui-state-focus";u.label===null&&(u.label=this.buttonElement.html()),this.buttonElement.addClass(o).attr("role","button").bind("mouseenter.button",function(){if(u.disabled)return;e(this).addClass("ui-state-hover"),this===n&&e(this).addClass("ui-state-active")}).bind("mouseleave.button",function(){if(u.disabled)return;e(this).removeClass(h)}).bind("click.button",function(e){u.disabled&&(e.preventDefault(),e.stopImmediatePropagation())}),this.element.bind("focus.button",function(){t.buttonElement.addClass(p)}).bind("blur.button",function(){t.buttonElement.removeClass(p)}),a&&(this.element.bind("change.button",function(){if(s)return;t.refresh()}),this.buttonElement.bind("mousedown.button",function(e){if(u.disabled)return;s=!1,r=e.pageX,i=e.pageY}).bind("mouseup.button",function(e){if(u.disabled)return;if(r!==e.pageX||i!==e.pageY)s=!0})),this.type==="checkbox"?this.buttonElement.bind("click.button",function(){if(u.disabled||s)return!1;e(this).toggleClass("ui-state-active"),t.buttonElement.attr("aria-pressed",t.element[0].checked)}):this.type==="radio"?this.buttonElement.bind("click.button",function(){if(u.disabled||s)return!1;e(this).addClass("ui-state-active"),t.buttonElement.attr("aria-pressed","true");var n=t.element[0];l(n).not(n).map(function(){return e(this).button("widget")[0]}).removeClass("ui-state-active").attr("aria-pressed","false")}):(this.buttonElement.bind("mousedown.button",function(){if(u.disabled)return!1;e(this).addClass("ui-state-active"),n=this,e(document).one("mouseup",function(){n=null})}).bind("mouseup.button",function(){if(u.disabled)return!1;e(this).removeClass("ui-state-active")}).bind("keydown.button",function(t){if(u.disabled)return!1;(t.keyCode==e.ui.keyCode.SPACE||t.keyCode==e.ui.keyCode.ENTER)&&e(this).addClass("ui-state-active")}).bind("keyup.button",function(){e(this).removeClass("ui-state-active")}),this.buttonElement.is("a")&&this.buttonElement.keyup(function(t){t.keyCode===e.ui.keyCode.SPACE&&e(this).click()})),this._setOption("disabled",u.disabled),this._resetButton()},_determineButtonType:function(){this.element.is(":checkbox")?this.type="checkbox":this.element.is(":radio")?this.type="radio":this.element.is("input")?this.type="input":this.type="button";if(this.type==="checkbox"||this.type==="radio"){var e=this.element.parents().filter(":last"),t="label[for='"+this.element.attr("id")+"']";this.buttonElement=e.find(t),this.buttonElement.length||(e=e.length?e.siblings():this.element.siblings(),this.buttonElement=e.filter(t),this.buttonElement.length||(this.buttonElement=e.find(t))),this.element.addClass("ui-helper-hidden-accessible");var n=this.element.is(":checked");n&&this.buttonElement.addClass("ui-state-active"),this.buttonElement.attr("aria-pressed",n)}else this.buttonElement=this.element},widget:function(){return this.buttonElement},destroy:function(){this.element.removeClass("ui-helper-hidden-accessible"),this.buttonElement.removeClass(o+" "+u+" "+a).removeAttr("role").removeAttr("aria-pressed").html(this.buttonElement.find(".ui-button-text").html()),this.hasTitle||this.buttonElement.removeAttr("title"),e.Widget.prototype.destroy.call(this)},_setOption:function(t,n){e.Widget.prototype._setOption.apply(this,arguments);if(t==="disabled"){n?this.element.propAttr("disabled",!0):this.element.propAttr("disabled",!1);return}this._resetButton()},refresh:function(){var t=this.element.is(":disabled");t!==this.options.disabled&&this._setOption("disabled",t),this.type==="radio"?l(this.element[0]).each(function(){e(this).is(":checked")?e(this).button("widget").addClass("ui-state-active").attr("aria-pressed","true"):e(this).button("widget").removeClass("ui-state-active").attr("aria-pressed","false")}):this.type==="checkbox"&&(this.element.is(":checked")?this.buttonElement.addClass("ui-state-active").attr("aria-pressed","true"):this.buttonElement.removeClass("ui-state-active").attr("aria-pressed","false"))},_resetButton:function(){if(this.type==="input"){this.options.label&&this.element.val(this.options.label);return}var t=this.buttonElement.removeClass(a),n=e("<span></span>",this.element[0].ownerDocument).addClass("ui-button-text").html(this.options.label).appendTo(t.empty()).text(),r=this.options.icons,i=r.primary&&r.secondary,s=[];r.primary||r.secondary?(this.options.text&&s.push("ui-button-text-icon"+(i?"s":r.primary?"-primary":"-secondary")),r.primary&&t.prepend("<span class='ui-button-icon-primary ui-icon "+r.primary+"'></span>"),r.secondary&&t.append("<span class='ui-button-icon-secondary ui-icon "+r.secondary+"'></span>"),this.options.text||(s.push(i?"ui-button-icons-only":"ui-button-icon-only"),this.hasTitle||t.attr("title",n))):s.push("ui-button-text-only"),t.addClass(s.join(" "))}}),e.widget("ui.buttonset",{options:{items:":button, :submit, :reset, :checkbox, :radio, a, :data(button)"},_create:function(){this.element.addClass("ui-buttonset")},_init:function(){this.refresh()},_setOption:function(t,n){t==="disabled"&&this.buttons.button("option",t,n),e.Widget.prototype._setOption.apply(this,arguments)},refresh:function(){var t=this.element.css("direction")==="rtl";this.buttons=this.element.find(this.options.items).filter(":ui-button").button("refresh").end().not(":ui-button").button().end().map(function(){return e(this).button("widget")[0]}).removeClass("ui-corner-all ui-corner-left ui-corner-right").filter(":first").addClass(t?"ui-corner-right":"ui-corner-left").end().filter(":last").addClass(t?"ui-corner-left":"ui-corner-right").end().end()},destroy:function(){this.element.removeClass("ui-buttonset"),this.buttons.map(function(){return e(this).button("widget")[0]}).removeClass("ui-corner-left ui-corner-right").end().button("destroy"),e.Widget.prototype.destroy.call(this)}})}(jQuery),function($,undefined){function Datepicker(){this.debug=!1,this._curInst=null,this._keyEvent=!1,this._disabledInputs=[],this._datepickerShowing=!1,this._inDialog=!1,this._mainDivId="ui-datepicker-div",this._inlineClass="ui-datepicker-inline",this._appendClass="ui-datepicker-append",this._triggerClass="ui-datepicker-trigger",this._dialogClass="ui-datepicker-dialog",this._disableClass="ui-datepicker-disabled",this._unselectableClass="ui-datepicker-unselectable",this._currentClass="ui-datepicker-current-day",this._dayOverClass="ui-datepicker-days-cell-over",this.regional=[],this.regional[""]={closeText:"Done",prevText:"Prev",nextText:"Next",currentText:"Today",monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"],monthNamesShort:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],dayNames:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],dayNamesShort:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],dayNamesMin:["Su","Mo","Tu","We","Th","Fr","Sa"],weekHeader:"Wk",dateFormat:"mm/dd/yy",firstDay:0,isRTL:!1,showMonthAfterYear:!1,yearSuffix:""},this._defaults={showOn:"focus",showAnim:"fadeIn",showOptions:{},defaultDate:null,appendText:"",buttonText:"...",buttonImage:"",buttonImageOnly:!1,hideIfNoPrevNext:!1,navigationAsDateFormat:!1,gotoCurrent:!1,changeMonth:!1,changeYear:!1,yearRange:"c-10:c+10",showOtherMonths:!1,selectOtherMonths:!1,showWeek:!1,calculateWeek:this.iso8601Week,shortYearCutoff:"+10",minDate:null,maxDate:null,duration:"fast",beforeShowDay:null,beforeShow:null,onSelect:null,onChangeMonthYear:null,onClose:null,numberOfMonths:1,showCurrentAtPos:0,stepMonths:1,stepBigMonths:12,altField:"",altFormat:"",constrainInput:!0,showButtonPanel:!1,autoSize:!1,disabled:!1},$.extend(this._defaults,this.regional[""]),this.dpDiv=bindHover($('<div id="'+this._mainDivId+'" class="ui-datepicker ui-widget ui-widget-content ui-helper-clearfix ui-corner-all"></div>'))}function bindHover(e){var t="button, .ui-datepicker-prev, .ui-datepicker-next, .ui-datepicker-calendar td a";return e.bind("mouseout",function(e){var n=$(e.target).closest(t);if(!n.length)return;n.removeClass("ui-state-hover ui-datepicker-prev-hover ui-datepicker-next-hover")}).bind("mouseover",function(n){var r=$(n.target).closest(t);if($.datepicker._isDisabledDatepicker(instActive.inline?e.parent()[0]:instActive.input[0])||!r.length)return;r.parents(".ui-datepicker-calendar").find("a").removeClass("ui-state-hover"),r.addClass("ui-state-hover"),r.hasClass("ui-datepicker-prev")&&r.addClass("ui-datepicker-prev-hover"),r.hasClass("ui-datepicker-next")&&r.addClass("ui-datepicker-next-hover")})}function extendRemove(e,t){$.extend(e,t);for(var n in t)if(t[n]==null||t[n]==undefined)e[n]=t[n];return e}function isArray(e){return e&&($.browser.safari&&typeof e=="object"&&e.length||e.constructor&&e.constructor.toString().match(/\Array\(\)/))}$.extend($.ui,{datepicker:{version:"1.8.22"}});var PROP_NAME="datepicker",dpuuid=(new Date).getTime(),instActive;$.extend(Datepicker.prototype,{markerClassName:"hasDatepicker",maxRows:4,log:function(){this.debug&&console.log.apply("",arguments)},_widgetDatepicker:function(){return this.dpDiv},setDefaults:function(e){return extendRemove(this._defaults,e||{}),this},_attachDatepicker:function(target,settings){var inlineSettings=null;for(var attrName in this._defaults){var attrValue=target.getAttribute("date:"+attrName);if(attrValue){inlineSettings=inlineSettings||{};try{inlineSettings[attrName]=eval(attrValue)}catch(err){inlineSettings[attrName]=attrValue}}}var nodeName=target.nodeName.toLowerCase(),inline=nodeName=="div"||nodeName=="span";target.id||(
this.uuid+=1,target.id="dp"+this.uuid);var inst=this._newInst($(target),inline);inst.settings=$.extend({},settings||{},inlineSettings||{}),nodeName=="input"?this._connectDatepicker(target,inst):inline&&this._inlineDatepicker(target,inst)},_newInst:function(e,t){var n=e[0].id.replace(/([^A-Za-z0-9_-])/g,"\\\\$1");return{id:n,input:e,selectedDay:0,selectedMonth:0,selectedYear:0,drawMonth:0,drawYear:0,inline:t,dpDiv:t?bindHover($('<div class="'+this._inlineClass+' ui-datepicker ui-widget ui-widget-content ui-helper-clearfix ui-corner-all"></div>')):this.dpDiv}},_connectDatepicker:function(e,t){var n=$(e);t.append=$([]),t.trigger=$([]);if(n.hasClass(this.markerClassName))return;this._attachments(n,t),n.addClass(this.markerClassName).keydown(this._doKeyDown).keypress(this._doKeyPress).keyup(this._doKeyUp).bind("setData.datepicker",function(e,n,r){t.settings[n]=r}).bind("getData.datepicker",function(e,n){return this._get(t,n)}),this._autoSize(t),$.data(e,PROP_NAME,t),t.settings.disabled&&this._disableDatepicker(e)},_attachments:function(e,t){var n=this._get(t,"appendText"),r=this._get(t,"isRTL");t.append&&t.append.remove(),n&&(t.append=$('<span class="'+this._appendClass+'">'+n+"</span>"),e[r?"before":"after"](t.append)),e.unbind("focus",this._showDatepicker),t.trigger&&t.trigger.remove();var i=this._get(t,"showOn");(i=="focus"||i=="both")&&e.focus(this._showDatepicker);if(i=="button"||i=="both"){var s=this._get(t,"buttonText"),o=this._get(t,"buttonImage");t.trigger=$(this._get(t,"buttonImageOnly")?$("<img/>").addClass(this._triggerClass).attr({src:o,alt:s,title:s}):$('<button type="button"></button>').addClass(this._triggerClass).html(o==""?s:$("<img/>").attr({src:o,alt:s,title:s}))),e[r?"before":"after"](t.trigger),t.trigger.click(function(){return $.datepicker._datepickerShowing&&$.datepicker._lastInput==e[0]?$.datepicker._hideDatepicker():$.datepicker._datepickerShowing&&$.datepicker._lastInput!=e[0]?($.datepicker._hideDatepicker(),$.datepicker._showDatepicker(e[0])):$.datepicker._showDatepicker(e[0]),!1})}},_autoSize:function(e){if(this._get(e,"autoSize")&&!e.inline){var t=new Date(2009,11,20),n=this._get(e,"dateFormat");if(n.match(/[DM]/)){var r=function(e){var t=0,n=0;for(var r=0;r<e.length;r++)e[r].length>t&&(t=e[r].length,n=r);return n};t.setMonth(r(this._get(e,n.match(/MM/)?"monthNames":"monthNamesShort"))),t.setDate(r(this._get(e,n.match(/DD/)?"dayNames":"dayNamesShort"))+20-t.getDay())}e.input.attr("size",this._formatDate(e,t).length)}},_inlineDatepicker:function(e,t){var n=$(e);if(n.hasClass(this.markerClassName))return;n.addClass(this.markerClassName).append(t.dpDiv).bind("setData.datepicker",function(e,n,r){t.settings[n]=r}).bind("getData.datepicker",function(e,n){return this._get(t,n)}),$.data(e,PROP_NAME,t),this._setDate(t,this._getDefaultDate(t),!0),this._updateDatepicker(t),this._updateAlternate(t),t.settings.disabled&&this._disableDatepicker(e),t.dpDiv.css("display","block")},_dialogDatepicker:function(e,t,n,r,i){var s=this._dialogInst;if(!s){this.uuid+=1;var o="dp"+this.uuid;this._dialogInput=$('<input type="text" id="'+o+'" style="position: absolute; top: -100px; width: 0px;"/>'),this._dialogInput.keydown(this._doKeyDown),$("body").append(this._dialogInput),s=this._dialogInst=this._newInst(this._dialogInput,!1),s.settings={},$.data(this._dialogInput[0],PROP_NAME,s)}extendRemove(s.settings,r||{}),t=t&&t.constructor==Date?this._formatDate(s,t):t,this._dialogInput.val(t),this._pos=i?i.length?i:[i.pageX,i.pageY]:null;if(!this._pos){var u=document.documentElement.clientWidth,a=document.documentElement.clientHeight,f=document.documentElement.scrollLeft||document.body.scrollLeft,l=document.documentElement.scrollTop||document.body.scrollTop;this._pos=[u/2-100+f,a/2-150+l]}return this._dialogInput.css("left",this._pos[0]+20+"px").css("top",this._pos[1]+"px"),s.settings.onSelect=n,this._inDialog=!0,this.dpDiv.addClass(this._dialogClass),this._showDatepicker(this._dialogInput[0]),$.blockUI&&$.blockUI(this.dpDiv),$.data(this._dialogInput[0],PROP_NAME,s),this},_destroyDatepicker:function(e){var t=$(e),n=$.data(e,PROP_NAME);if(!t.hasClass(this.markerClassName))return;var r=e.nodeName.toLowerCase();$.removeData(e,PROP_NAME),r=="input"?(n.append.remove(),n.trigger.remove(),t.removeClass(this.markerClassName).unbind("focus",this._showDatepicker).unbind("keydown",this._doKeyDown).unbind("keypress",this._doKeyPress).unbind("keyup",this._doKeyUp)):(r=="div"||r=="span")&&t.removeClass(this.markerClassName).empty()},_enableDatepicker:function(e){var t=$(e),n=$.data(e,PROP_NAME);if(!t.hasClass(this.markerClassName))return;var r=e.nodeName.toLowerCase();if(r=="input")e.disabled=!1,n.trigger.filter("button").each(function(){this.disabled=!1}).end().filter("img").css({opacity:"1.0",cursor:""});else if(r=="div"||r=="span"){var i=t.children("."+this._inlineClass);i.children().removeClass("ui-state-disabled"),i.find("select.ui-datepicker-month, select.ui-datepicker-year").removeAttr("disabled")}this._disabledInputs=$.map(this._disabledInputs,function(t){return t==e?null:t})},_disableDatepicker:function(e){var t=$(e),n=$.data(e,PROP_NAME);if(!t.hasClass(this.markerClassName))return;var r=e.nodeName.toLowerCase();if(r=="input")e.disabled=!0,n.trigger.filter("button").each(function(){this.disabled=!0}).end().filter("img").css({opacity:"0.5",cursor:"default"});else if(r=="div"||r=="span"){var i=t.children("."+this._inlineClass);i.children().addClass("ui-state-disabled"),i.find("select.ui-datepicker-month, select.ui-datepicker-year").attr("disabled","disabled")}this._disabledInputs=$.map(this._disabledInputs,function(t){return t==e?null:t}),this._disabledInputs[this._disabledInputs.length]=e},_isDisabledDatepicker:function(e){if(!e)return!1;for(var t=0;t<this._disabledInputs.length;t++)if(this._disabledInputs[t]==e)return!0;return!1},_getInst:function(e){try{return $.data(e,PROP_NAME)}catch(t){throw"Missing instance data for this datepicker"}},_optionDatepicker:function(e,t,n){var r=this._getInst(e);if(arguments.length==2&&typeof t=="string")return t=="defaults"?$.extend({},$.datepicker._defaults):r?t=="all"?$.extend({},r.settings):this._get(r,t):null;var i=t||{};typeof t=="string"&&(i={},i[t]=n);if(r){this._curInst==r&&this._hideDatepicker();var s=this._getDateDatepicker(e,!0),o=this._getMinMaxDate(r,"min"),u=this._getMinMaxDate(r,"max");extendRemove(r.settings,i),o!==null&&i.dateFormat!==undefined&&i.minDate===undefined&&(r.settings.minDate=this._formatDate(r,o)),u!==null&&i.dateFormat!==undefined&&i.maxDate===undefined&&(r.settings.maxDate=this._formatDate(r,u)),this._attachments($(e),r),this._autoSize(r),this._setDate(r,s),this._updateAlternate(r),this._updateDatepicker(r)}},_changeDatepicker:function(e,t,n){this._optionDatepicker(e,t,n)},_refreshDatepicker:function(e){var t=this._getInst(e);t&&this._updateDatepicker(t)},_setDateDatepicker:function(e,t){var n=this._getInst(e);n&&(this._setDate(n,t),this._updateDatepicker(n),this._updateAlternate(n))},_getDateDatepicker:function(e,t){var n=this._getInst(e);return n&&!n.inline&&this._setDateFromField(n,t),n?this._getDate(n):null},_doKeyDown:function(e){var t=$.datepicker._getInst(e.target),n=!0,r=t.dpDiv.is(".ui-datepicker-rtl");t._keyEvent=!0;if($.datepicker._datepickerShowing)switch(e.keyCode){case 9:$.datepicker._hideDatepicker(),n=!1;break;case 13:var i=$("td."+$.datepicker._dayOverClass+":not(."+$.datepicker._currentClass+")",t.dpDiv);i[0]&&$.datepicker._selectDay(e.target,t.selectedMonth,t.selectedYear,i[0]);var s=$.datepicker._get(t,"onSelect");if(s){var o=$.datepicker._formatDate(t);s.apply(t.input?t.input[0]:null,[o,t])}else $.datepicker._hideDatepicker();return!1;case 27:$.datepicker._hideDatepicker();break;case 33:$.datepicker._adjustDate(e.target,e.ctrlKey?-$.datepicker._get(t,"stepBigMonths"):-$.datepicker._get(t,"stepMonths"),"M");break;case 34:$.datepicker._adjustDate(e.target,e.ctrlKey?+$.datepicker._get(t,"stepBigMonths"):+$.datepicker._get(t,"stepMonths"),"M");break;case 35:(e.ctrlKey||e.metaKey)&&$.datepicker._clearDate(e.target),n=e.ctrlKey||e.metaKey;break;case 36:(e.ctrlKey||e.metaKey)&&$.datepicker._gotoToday(e.target),n=e.ctrlKey||e.metaKey;break;case 37:(e.ctrlKey||e.metaKey)&&$.datepicker._adjustDate(e.target,r?1:-1,"D"),n=e.ctrlKey||e.metaKey,e.originalEvent.altKey&&$.datepicker._adjustDate(e.target,e.ctrlKey?-$.datepicker._get(t,"stepBigMonths"):-$.datepicker._get(t,"stepMonths"),"M");break;case 38:(e.ctrlKey||e.metaKey)&&$.datepicker._adjustDate(e.target,-7,"D"),n=e.ctrlKey||e.metaKey;break;case 39:(e.ctrlKey||e.metaKey)&&$.datepicker._adjustDate(e.target,r?-1:1,"D"),n=e.ctrlKey||e.metaKey,e.originalEvent.altKey&&$.datepicker._adjustDate(e.target,e.ctrlKey?+$.datepicker._get(t,"stepBigMonths"):+$.datepicker._get(t,"stepMonths"),"M");break;case 40:(e.ctrlKey||e.metaKey)&&$.datepicker._adjustDate(e.target,7,"D"),n=e.ctrlKey||e.metaKey;break;default:n=!1}else e.keyCode==36&&e.ctrlKey?$.datepicker._showDatepicker(this):n=!1;n&&(e.preventDefault(),e.stopPropagation())},_doKeyPress:function(e){var t=$.datepicker._getInst(e.target);if($.datepicker._get(t,"constrainInput")){var n=$.datepicker._possibleChars($.datepicker._get(t,"dateFormat")),r=String.fromCharCode(e.charCode==undefined?e.keyCode:e.charCode);return e.ctrlKey||e.metaKey||r<" "||!n||n.indexOf(r)>-1}},_doKeyUp:function(e){var t=$.datepicker._getInst(e.target);if(t.input.val()!=t.lastVal)try{var n=$.datepicker.parseDate($.datepicker._get(t,"dateFormat"),t.input?t.input.val():null,$.datepicker._getFormatConfig(t));n&&($.datepicker._setDateFromField(t),$.datepicker._updateAlternate(t),$.datepicker._updateDatepicker(t))}catch(r){$.datepicker.log(r)}return!0},_showDatepicker:function(e){e=e.target||e,e.nodeName.toLowerCase()!="input"&&(e=$("input",e.parentNode)[0]);if($.datepicker._isDisabledDatepicker(e)||$.datepicker._lastInput==e)return;var t=$.datepicker._getInst(e);$.datepicker._curInst&&$.datepicker._curInst!=t&&($.datepicker._curInst.dpDiv.stop(!0,!0),t&&$.datepicker._datepickerShowing&&$.datepicker._hideDatepicker($.datepicker._curInst.input[0]));var n=$.datepicker._get(t,"beforeShow"),r=n?n.apply(e,[e,t]):{};if(r===!1)return;extendRemove(t.settings,r),t.lastVal=null,$.datepicker._lastInput=e,$.datepicker._setDateFromField(t),$.datepicker._inDialog&&(e.value=""),$.datepicker._pos||($.datepicker._pos=$.datepicker._findPos(e),$.datepicker._pos[1]+=e.offsetHeight);var i=!1;$(e).parents().each(function(){return i|=$(this).css("position")=="fixed",!i}),i&&$.browser.opera&&($.datepicker._pos[0]-=document.documentElement.scrollLeft,$.datepicker._pos[1]-=document.documentElement.scrollTop);var s={left:$.datepicker._pos[0],top:$.datepicker._pos[1]};$.datepicker._pos=null,t.dpDiv.empty(),t.dpDiv.css({position:"absolute",display:"block",top:"-1000px"}),$.datepicker._updateDatepicker(t),s=$.datepicker._checkOffset(t,s,i),t.dpDiv.css({position:$.datepicker._inDialog&&$.blockUI?"static":i?"fixed":"absolute",display:"none",left:s.left+"px",top:s.top+"px"});if(!t.inline){var o=$.datepicker._get(t,"showAnim"),u=$.datepicker._get(t,"duration"),a=function(){var e=t.dpDiv.find("iframe.ui-datepicker-cover");if(!!e.length){var n=$.datepicker._getBorders(t.dpDiv);e.css({left:-n[0],top:-n[1],width:t.dpDiv.outerWidth(),height:t.dpDiv.outerHeight()})}};t.dpDiv.zIndex($(e).zIndex()+1),$.datepicker._datepickerShowing=!0,$.effects&&$.effects[o]?t.dpDiv.show(o,$.datepicker._get(t,"showOptions"),u,a):t.dpDiv[o||"show"](o?u:null,a),(!o||!u)&&a(),t.input.is(":visible")&&!t.input.is(":disabled")&&t.input.focus(),$.datepicker._curInst=t}},_updateDatepicker:function(e){var t=this;t.maxRows=4;var n=$.datepicker._getBorders(e.dpDiv);instActive=e,e.dpDiv.empty().append(this._generateHTML(e)),this._attachHandlers(e);var r=e.dpDiv.find("iframe.ui-datepicker-cover");!r.length||r.css({left:-n[0],top:-n[1],width:e.dpDiv.outerWidth(),height:e.dpDiv.outerHeight()}),e.dpDiv.find("."+this._dayOverClass+" a").mouseover();var i=this._getNumberOfMonths(e),s=i[1],o=17;e.dpDiv.removeClass("ui-datepicker-multi-2 ui-datepicker-multi-3 ui-datepicker-multi-4").width(""),s>1&&e.dpDiv.addClass("ui-datepicker-multi-"+s).css("width",o*s+"em"),e.dpDiv[(i[0]!=1||i[1]!=1?"add":"remove")+"Class"]("ui-datepicker-multi"),e.dpDiv[(this._get(e,"isRTL")?"add":"remove")+"Class"]("ui-datepicker-rtl"),e==$.datepicker._curInst&&$.datepicker._datepickerShowing&&e.input&&e.input.is(":visible")&&!e.input.is(":disabled")&&e.input[0]!=document.activeElement&&e.input.focus();if(e.yearshtml){var u=e.yearshtml;setTimeout(function(){u===e.yearshtml&&e.yearshtml&&e.dpDiv.find("select.ui-datepicker-year:first").replaceWith(e.yearshtml),u=e.yearshtml=null},0)}},_getBorders:function(e){var t=function(e){return{thin:1,medium:2,thick:3}[e]||e};return[parseFloat(t(e.css("border-left-width"))),parseFloat(t(e.css("border-top-width")))]},_checkOffset:function(e,t,n){var r=e.dpDiv.outerWidth(),i=e.dpDiv.outerHeight(),s=e.input?e.input.outerWidth():0,o=e.input?e.input.outerHeight():0,u=document.documentElement.clientWidth+(n?0:$(document).scrollLeft()),a=document.documentElement.clientHeight+(n?0:$(document).scrollTop());return t.left-=this._get(e,"isRTL")?r-s:0,t.left-=n&&t.left==e.input.offset().left?$(document).scrollLeft():0,t.top-=n&&t.top==e.input.offset().top+o?$(document).scrollTop():0,t.left-=Math.min(t.left,t.left+r>u&&u>r?Math.abs(t.left+r-u):0),t.top-=Math.min(t.top,t.top+i>a&&a>i?Math.abs(i+o):0),t},_findPos:function(e){var t=this._getInst(e),n=this._get(t,"isRTL");while(e&&(e.type=="hidden"||e.nodeType!=1||$.expr.filters.hidden(e)))e=e[n?"previousSibling":"nextSibling"];var r=$(e).offset();return[r.left,r.top]},_hideDatepicker:function(e){var t=this._curInst;if(!t||e&&t!=$.data(e,PROP_NAME))return;if(this._datepickerShowing){var n=this._get(t,"showAnim"),r=this._get(t,"duration"),i=function(){$.datepicker._tidyDialog(t)};$.effects&&$.effects[n]?t.dpDiv.hide(n,$.datepicker._get(t,"showOptions"),r,i):t.dpDiv[n=="slideDown"?"slideUp":n=="fadeIn"?"fadeOut":"hide"](n?r:null,i),n||i(),this._datepickerShowing=!1;var s=this._get(t,"onClose");s&&s.apply(t.input?t.input[0]:null,[t.input?t.input.val():"",t]),this._lastInput=null,this._inDialog&&(this._dialogInput.css({position:"absolute",left:"0",top:"-100px"}),$.blockUI&&($.unblockUI(),$("body").append(this.dpDiv))),this._inDialog=!1}},_tidyDialog:function(e){e.dpDiv.removeClass(this._dialogClass).unbind(".ui-datepicker-calendar")},_checkExternalClick:function(e){if(!$.datepicker._curInst)return;var t=$(e.target),n=$.datepicker._getInst(t[0]);(t[0].id!=$.datepicker._mainDivId&&t.parents("#"+$.datepicker._mainDivId).length==0&&!t.hasClass($.datepicker.markerClassName)&&!t.closest("."+$.datepicker._triggerClass).length&&$.datepicker._datepickerShowing&&(!$.datepicker._inDialog||!$.blockUI)||t.hasClass($.datepicker.markerClassName)&&$.datepicker._curInst!=n)&&$.datepicker._hideDatepicker()},_adjustDate:function(e,t,n){var r=$(e),i=this._getInst(r[0]);if(this._isDisabledDatepicker(r[0]))return;this._adjustInstDate(i,t+(n=="M"?this._get(i,"showCurrentAtPos"):0),n),this._updateDatepicker(i)},_gotoToday:function(e){var t=$(e),n=this._getInst(t[0]);if(this._get(n,"gotoCurrent")&&n.currentDay)n.selectedDay=n.currentDay,n.drawMonth=n.selectedMonth=n.currentMonth,n.drawYear=n.selectedYear=n.currentYear;else{var r=new Date;n.selectedDay=r.getDate(),n.drawMonth=n.selectedMonth=r.getMonth(),n.drawYear=n.selectedYear=r.getFullYear()}this._notifyChange(n),this._adjustDate(t)},_selectMonthYear:function(e,t,n){var r=$(e),i=this._getInst(r[0]);i["selected"+(n=="M"?"Month":"Year")]=i["draw"+(n=="M"?"Month":"Year")]=parseInt(t.options[t.selectedIndex].value,10),this._notifyChange(i),this._adjustDate(r)},_selectDay:function(e,t,n,r){var i=$(e);if($(r).hasClass(this._unselectableClass)||this._isDisabledDatepicker(i[0]))return;var s=this._getInst(i[0]);s.selectedDay=s.currentDay=$("a",r).html(),s.selectedMonth=s.currentMonth=t,s.selectedYear=s.currentYear=n,this._selectDate(e,this._formatDate(s,s.currentDay,s.currentMonth,s.currentYear))},_clearDate:function(e){var t=$(e),n=this._getInst(t[0]);this._selectDate(t,"")},_selectDate:function(e,t){var n=$(e),r=this._getInst(n[0]);t=t!=null?t:this._formatDate(r),r.input&&r.input.val(t),this._updateAlternate(r);var i=this._get(r,"onSelect");i?i.apply(r.input?r.input[0]:null,[t,r]):r.input&&r.input.trigger("change"),r.inline?this._updateDatepicker(r):(this._hideDatepicker(),this._lastInput=r.input[0],typeof r.input[0]!="object"&&r.input.focus(),this._lastInput=null)},_updateAlternate:function(e){var t=this._get(e,"altField");if(t){var n=this._get(e,"altFormat")||this._get(e,"dateFormat"),r=this._getDate(e),i=this.formatDate(n,r,this._getFormatConfig(e));$(t).each(function(){$(this).val(i)})}},noWeekends:function(e){var t=e.getDay();return[t>0&&t<6,""]},iso8601Week:function(e){var t=new Date(e.getTime());t.setDate(t.getDate()+4-(t.getDay()||7));var n=t.getTime();return t.setMonth(0),t.setDate(1),Math.floor(Math.round((n-t)/864e5)/7)+1},parseDate:function(e,t,n){if(e==null||t==null)throw"Invalid arguments";t=typeof t=="object"?t.toString():t+"";if(t=="")return null;var r=(n?n.shortYearCutoff:null)||this._defaults.shortYearCutoff;r=typeof r!="string"?r:(new Date).getFullYear()%100+parseInt(r,10);var i=(n?n.dayNamesShort:null)||this._defaults.dayNamesShort,s=(n?n.dayNames:null)||this._defaults.dayNames,o=(n?n.monthNamesShort:null)||this._defaults.monthNamesShort,u=(n?n.monthNames:null)||this._defaults.monthNames,a=-1,f=-1,l=-1,c=-1,h=!1,p=function(t){var n=y+1<e.length&&e.charAt(y+1)==t;return n&&y++,n},d=function(e){var n=p(e),r=e=="@"?14:e=="!"?20:e=="y"&&n?4:e=="o"?3:2,i=new RegExp("^\\d{1,"+r+"}"),s=t.substring(g).match(i);if(!s)throw"Missing number at position "+g;return g+=s[0].length,parseInt(s[0],10)},v=function(e,n,r){var i=$.map(p(e)?r:n,function(e,t){return[[t,e]]}).sort(function(e,t){return-(e[1].length-t[1].length)}),s=-1;$.each(i,function(e,n){var r=n[1];if(t.substr(g,r.length).toLowerCase()==r.toLowerCase())return s=n[0],g+=r.length,!1});if(s!=-1)return s+1;throw"Unknown name at position "+g},m=function(){if(t.charAt(g)!=e.charAt(y))throw"Unexpected literal at position "+g;g++},g=0;for(var y=0;y<e.length;y++)if(h)e.charAt(y)=="'"&&!p("'")?h=!1:m();else switch(e.charAt(y)){case"d":l=d("d");break;case"D":v("D",i,s);break;case"o":c=d("o");break;case"m":f=d("m");break;case"M":f=v("M",o,u);break;case"y":a=d("y");break;case"@":var b=new Date(d("@"));a=b.getFullYear(),f=b.getMonth()+1,l=b.getDate();break;case"!":var b=new Date((d("!")-this._ticksTo1970)/1e4);a=b.getFullYear(),f=b.getMonth()+1,l=b.getDate();break;case"'":p("'")?m():h=!0;break;default:m()}if(g<t.length)throw"Extra/unparsed characters found in date: "+t.substring(g);a==-1?a=(new Date).getFullYear():a<100&&(a+=(new Date).getFullYear()-(new Date).getFullYear()%100+(a<=r?0:-100));if(c>-1){f=1,l=c;do{var w=this._getDaysInMonth(a,f-1);if(l<=w)break;f++,l-=w}while(!0)}var b=this._daylightSavingAdjust(new Date(a,f-1,l));if(b.getFullYear()!=a||b.getMonth()+1!=f||b.getDate()!=l)throw"Invalid date";return b},ATOM:"yy-mm-dd",COOKIE:"D, dd M yy",ISO_8601:"yy-mm-dd",RFC_822:"D, d M y",RFC_850:"DD, dd-M-y",RFC_1036:"D, d M y",RFC_1123:"D, d M yy",RFC_2822:"D, d M yy",RSS:"D, d M y",TICKS:"!",TIMESTAMP:"@",W3C:"yy-mm-dd",_ticksTo1970:(718685+Math.floor(492.5)-Math.floor(19.7)+Math.floor(4.925))*24*60*60*1e7,formatDate:function(e,t,n){if(!t)return"";var r=(n?n.dayNamesShort:null)||this._defaults.dayNamesShort,i=(n?n.dayNames:null)||this._defaults.dayNames,s=(n?n.monthNamesShort:null)||this._defaults.monthNamesShort,o=(n?n.monthNames:null)||this._defaults.monthNames,u=function(t){var n=h+1<e.length&&e.charAt(h+1)==t;return n&&h++,n},a=function(e,t,n){var r=""+t;if(u(e))while(r.length<n)r="0"+r;return r},f=function(e,t,n,r){return u(e)?r[t]:n[t]},l="",c=!1;if(t)for(var h=0;h<e.length;h++)if(c)e.charAt(h)=="'"&&!u("'")?c=!1:l+=e.charAt(h);else switch(e.charAt(h)){case"d":l+=a("d",t.getDate(),2);break;case"D":l+=f("D",t.getDay(),r,i);break;case"o":l+=a("o",Math.round(((new Date(t.getFullYear(),t.getMonth(),t.getDate())).getTime()-(new Date(t.getFullYear(),0,0)).getTime())/864e5),3);break;case"m":l+=a("m",t.getMonth()+1,2);break;case"M":l+=f("M",t.getMonth(),s,o);break;case"y":l+=u("y")?t.getFullYear():(t.getYear()%100<10?"0":"")+t.getYear()%100;break;case"@":l+=t.getTime();break;case"!":l+=t.getTime()*1e4+this._ticksTo1970;break;case"'":u("'")?l+="'":c=!0;break;default:l+=e.charAt(h)}return l},_possibleChars:function(e){var t="",n=!1,r=function(t){var n=i+1<e.length&&e.charAt(i+1)==t;return n&&i++,n};for(var i=0;i<e.length;i++)if(n)e.charAt(i)=="'"&&!r("'")?n=!1:t+=e.charAt(i);else switch(e.charAt(i)){case"d":case"m":case"y":case"@":t+="0123456789";break;case"D":case"M":return null;case"'":r("'")?t+="'":n=!0;break;default:t+=e.charAt(i)}return t},_get:function(e,t){return e.settings[t]!==undefined?e.settings[t]:this._defaults[t]},_setDateFromField:function(e,t){if(e.input.val()==e.lastVal)return;var n=this._get(e,"dateFormat"),r=e.lastVal=e.input?e.input.val():null,i,s;i=s=this._getDefaultDate(e);var o=this._getFormatConfig(e);try{i=this.parseDate(n,r,o)||s}catch(u){this.log(u),r=t?"":r}e.selectedDay=i.getDate(),e.drawMonth=e.selectedMonth=i.getMonth(),e.drawYear=e.selectedYear=i.getFullYear(),e.currentDay=r?i.getDate():0,e.currentMonth=r?i.getMonth():0,e.currentYear=r?i.getFullYear():0,this._adjustInstDate(e)},_getDefaultDate:function(e){return this._restrictMinMax(e,this._determineDate(e,this._get(e,"defaultDate"),new Date))},_determineDate:function(e,t,n){var r=function(e){var t=new Date;return t.setDate(t.getDate()+e),t},i=function(t){try{return $.datepicker.parseDate($.datepicker._get(e,"dateFormat"),t,$.datepicker._getFormatConfig(e))}catch(n){}var r=(t.toLowerCase().match(/^c/)?$.datepicker._getDate(e):null)||new Date,i=r.getFullYear(),s=r.getMonth(),o=r.getDate(),u=/([+-]?[0-9]+)\s*(d|D|w|W|m|M|y|Y)?/g,f=u.exec(t);while(f){switch(f[2]||"d"){case"d":case"D":o+=parseInt(f[1],10);break;case"w":case"W":o+=parseInt(f[1],10)*7;break;case"m":case"M":s+=parseInt(f[1],10),o=Math.min(o,$.datepicker._getDaysInMonth(i,s));break;case"y":case"Y":i+=parseInt(f[1],10),o=Math.min(o,$.datepicker._getDaysInMonth(i,s))}f=u.exec(t)}return new Date(i,s,o)},s=t==null||t===""?n:typeof t=="string"?i(t):typeof t=="number"?isNaN(t)?n:r(t):new Date(t.getTime());return s=s&&s.toString()=="Invalid Date"?n:s,s&&(s.setHours(0),s.setMinutes(0),s.setSeconds(0),s.setMilliseconds(0)),this._daylightSavingAdjust(s)},_daylightSavingAdjust:function(e){return e?(e.setHours(e.getHours()>12?e.getHours()+2:0),e):null},_setDate:function(e,t,n){var r=!t,i=e.selectedMonth,s=e.selectedYear,o=this._restrictMinMax(e,this._determineDate(e,t,new Date));e.selectedDay=e.currentDay=o.getDate(),e.drawMonth=e.selectedMonth=e.currentMonth=o.getMonth(),e.drawYear=e.selectedYear=e.currentYear=o.getFullYear(),(i!=e.selectedMonth||s!=e.selectedYear)&&!n&&this._notifyChange(e),this._adjustInstDate(e),e.input&&e.input.val(r?"":this._formatDate(e))},_getDate:function(e){var t=!e.currentYear||e.input&&e.input.val()==""?null:this._daylightSavingAdjust(new Date(e.currentYear,e.currentMonth,e.currentDay));return t},_attachHandlers:function(e){var t=this._get(e,"stepMonths"),n="#"+e.id;e.dpDiv.find("[data-handler]").map(function(){var e={prev:function(){window["DP_jQuery_"+dpuuid].datepicker._adjustDate(n,-t,"M")},next:function(){window["DP_jQuery_"+dpuuid].datepicker._adjustDate(n,+t,"M")},hide:function(){window["DP_jQuery_"+dpuuid].datepicker._hideDatepicker()},today:function(){window["DP_jQuery_"+dpuuid].datepicker._gotoToday(n)},selectDay:function(){return window["DP_jQuery_"+dpuuid].datepicker._selectDay(n,+this.getAttribute("data-month"),+this.getAttribute("data-year"),this),!1},selectMonth:function(){return window["DP_jQuery_"+dpuuid].datepicker._selectMonthYear(n,this,"M"),!1},selectYear:function(){return window["DP_jQuery_"+dpuuid].datepicker._selectMonthYear(n,this,"Y"),!1}};$(this).bind(this.getAttribute("data-event"),e[this.getAttribute("data-handler")])})},_generateHTML:function(e){var t=new Date;t=this._daylightSavingAdjust(new Date(t.getFullYear(),t.getMonth(),t.getDate()));var n=this._get(e,"isRTL"),r=this._get(e,"showButtonPanel"),i=this._get(e,"hideIfNoPrevNext"),s=this._get(e,"navigationAsDateFormat"),o=this._getNumberOfMonths(e),u=this._get(e,"showCurrentAtPos"),a=this._get(e,"stepMonths"),f=o[0]!=1||o[1]!=1,l=this._daylightSavingAdjust(e.currentDay?new Date(e.currentYear,e.currentMonth,e.currentDay):new Date(9999,9,9)),c=this._getMinMaxDate(e,"min"),h=this._getMinMaxDate(e,"max"),p=e.drawMonth-u,d=e.drawYear;p<0&&(p+=12,d--);if(h){var v=this._daylightSavingAdjust(new Date(h.getFullYear(),h.getMonth()-o[0]*o[1]+1,h.getDate()));v=c&&v<c?c:v;while(this._daylightSavingAdjust(new Date(d,p,1))>v)p--,p<0&&(p=11,d--)}e.drawMonth=p,e.drawYear=d;var m=this._get(e,"prevText");m=s?this.formatDate(m,this._daylightSavingAdjust(new Date(d,p-a,1)),this._getFormatConfig(e)):m;var g=this._canAdjustMonth(e,-1,d,p)?'<a class="ui-datepicker-prev ui-corner-all" data-handler="prev" data-event="click" title="'+m+'"><span class="ui-icon ui-icon-circle-triangle-'+(n?"e":"w")+'">'+m+"</span></a>":i?"":'<a class="ui-datepicker-prev ui-corner-all ui-state-disabled" title="'+m+'"><span class="ui-icon ui-icon-circle-triangle-'+(n?"e":"w")+'">'+m+"</span></a>",y=this._get(e,"nextText");y=s?this.formatDate(y,this._daylightSavingAdjust(new Date(d,p+a,1)),this._getFormatConfig(e)):y;var b=this._canAdjustMonth(e,1,d,p)?'<a class="ui-datepicker-next ui-corner-all" data-handler="next" data-event="click" title="'+y+'"><span class="ui-icon ui-icon-circle-triangle-'+(n?"w":"e")+'">'+y+"</span></a>":i?"":'<a class="ui-datepicker-next ui-corner-all ui-state-disabled" title="'+y+'"><span class="ui-icon ui-icon-circle-triangle-'+(n?"w":"e")+'">'+y+"</span></a>",w=this._get(e,"currentText"),E=this._get(e,"gotoCurrent")&&e.currentDay?l:t;w=s?this.formatDate(w,E,this._getFormatConfig(e)):w;var S=e.inline?"":'<button type="button" class="ui-datepicker-close ui-state-default ui-priority-primary ui-corner-all" data-handler="hide" data-event="click">'+this._get(e,"closeText")+"</button>",x=r?'<div class="ui-datepicker-buttonpane ui-widget-content">'+(n?S:"")+(this._isInRange(e,E)?'<button type="button" class="ui-datepicker-current ui-state-default ui-priority-secondary ui-corner-all" data-handler="today" data-event="click">'+w+"</button>":"")+(n?"":S)+"</div>":"",T=parseInt(this._get(e,"firstDay"),10);T=isNaN(T)?0:T;var N=this._get(e,"showWeek"),C=this._get(e,"dayNames"),k=this._get(e,"dayNamesShort"),L=this._get(e,"dayNamesMin"),A=this._get(e,"monthNames"),O=this._get(e,"monthNamesShort"),M=this._get(e,"beforeShowDay"),_=this._get(e,"showOtherMonths"),D=this._get(e,"selectOtherMonths"),P=this._get(e,"calculateWeek")||this.iso8601Week,H=this._getDefaultDate(e),B="";for(var j=0;j<o[0];j++){var F="";this.maxRows=4;for(var I=0;I<o[1];I++){var q=this._daylightSavingAdjust(new Date(d,p,e.selectedDay)),R=" ui-corner-all",U="";if(f){U+='<div class="ui-datepicker-group';if(o[1]>1)switch(I){case 0:U+=" ui-datepicker-group-first",R=" ui-corner-"+(n?"right":"left");break;case o[1]-1:U+=" ui-datepicker-group-last",R=" ui-corner-"+(n?"left":"right");break;default:U+=" ui-datepicker-group-middle",R=""}U+='">'}U+='<div class="ui-datepicker-header ui-widget-header ui-helper-clearfix'+R+'">'+(/all|left/.test(R)&&j==0?n?b:g:"")+(/all|right/.test(R)&&j==0?n?g:b:"")+this._generateMonthYearHeader(e,p,d,c,h,j>0||I>0,A,O)+'</div><table class="ui-datepicker-calendar"><thead>'+"<tr>";var z=N?'<th class="ui-datepicker-week-col">'+this._get(e,"weekHeader")+"</th>":"";for(var W=0;W<7;W++){var X=(W+T)%7;z+="<th"+((W+T+6)%7>=5?' class="ui-datepicker-week-end"':"")+">"+'<span title="'+C[X]+'">'+L[X]+"</span></th>"}U+=z+"</tr></thead><tbody>";var V=this._getDaysInMonth(d,p);d==e.selectedYear&&p==e.selectedMonth&&(e.selectedDay=Math.min(e.selectedDay,V));var J=(this._getFirstDayOfMonth(d,p)-T+7)%7,K=Math.ceil((J+V)/7),Q=f?this.maxRows>K?this.maxRows:K:K;this.maxRows=Q;var G=this._daylightSavingAdjust(new Date(d,p,1-J));for(var Y=0;Y<Q;Y++){U+="<tr>";var Z=N?'<td class="ui-datepicker-week-col">'+this._get(e,"calculateWeek")(G)+"</td>":"";for(var W=0;W<7;W++){var et=M?M.apply(e.input?e.input[0]:null,[G]):[!0,""],tt=G.getMonth()!=p,nt=tt&&!D||!et[0]||c&&G<c||h&&G>h;Z+='<td class="'+((W+T+6)%7>=5?" ui-datepicker-week-end":"")+(tt?" ui-datepicker-other-month":"")+(G.getTime()==q.getTime()&&p==e.selectedMonth&&e._keyEvent||H.getTime()==G.getTime()&&H.getTime()==q.getTime()?" "+this._dayOverClass:"")+(nt?" "+this._unselectableClass+" ui-state-disabled":"")+(tt&&!_?"":" "+et[1]+(G.getTime()==l.getTime()?" "+this._currentClass:"")+(G.getTime()==t.getTime()?" ui-datepicker-today":""))+'"'+((!tt||_)&&et[2]?' title="'+et[2]+'"':"")+(nt?"":' data-handler="selectDay" data-event="click" data-month="'+G.getMonth()+'" data-year="'+G.getFullYear()+'"')+">"+(tt&&!_?"&#xa0;":nt?'<span class="ui-state-default">'+G.getDate()+"</span>":'<a class="ui-state-default'+(G.getTime()==t.getTime()?" ui-state-highlight":"")+(G.getTime()==l.getTime()?" ui-state-active":"")+(tt?" ui-priority-secondary":"")+'" href="#">'+G.getDate()+"</a>")+"</td>",G.setDate(G.getDate()+1),G=this._daylightSavingAdjust(G)}U+=Z+"</tr>"}p++,p>11&&(p=0,d++),U+="</tbody></table>"+(f?"</div>"+(o[0]>0&&I==o[1]-1?'<div class="ui-datepicker-row-break"></div>':""):""),F+=U}B+=F}return B+=x+($.browser.msie&&parseInt($.browser.version,10)<7&&!e.inline?'<iframe src="javascript:false;" class="ui-datepicker-cover" frameborder="0"></iframe>':""),e._keyEvent=!1,B},_generateMonthYearHeader:function(e,t,n,r,i,s,o,u){var a=this._get(e,"changeMonth"),f=this._get(e,"changeYear"),l=this._get(e,"showMonthAfterYear"),c='<div class="ui-datepicker-title">',h="";if(s||!a)h+='<span class="ui-datepicker-month">'+o[t]+"</span>";else{var p=r&&r.getFullYear()==n,d=i&&i.getFullYear()==n;h+='<select class="ui-datepicker-month" data-handler="selectMonth" data-event="change">';for(var v=0;v<12;v++)(!p||v>=r.getMonth())&&(!d||v<=i.getMonth())&&(h+='<option value="'+v+'"'+(v==t?' selected="selected"':"")+">"+u[v]+"</option>");h+="</select>"}l||(c+=h+(s||!a||!f?"&#xa0;":""));if(!e.yearshtml){e.yearshtml="";if(s||!f)c+='<span class="ui-datepicker-year">'+n+"</span>";else{var m=this._get(e,"yearRange").split(":"),g=(new Date).getFullYear(),y=function(e){var t=e.match(/c[+-].*/)?n+parseInt(e.substring(1),10):e.match(/[+-].*/)?g+parseInt(e,10):parseInt(e,10);return isNaN(t)?g:t},b=y(m[0]),w=Math.max(b,y(m[1]||""));b=r?Math.max(b,r.getFullYear()):b,w=i?Math.min(w,i.getFullYear()):w,e.yearshtml+='<select class="ui-datepicker-year" data-handler="selectYear" data-event="change">';for(;b<=w;b++)e.yearshtml+='<option value="'+b+'"'+(b==n?' selected="selected"':"")+">"+b+"</option>";e.yearshtml+="</select>",c+=e.yearshtml,e.yearshtml=null}}return c+=this._get(e,"yearSuffix"),l&&(c+=(s||!a||!f?"&#xa0;":"")+h),c+="</div>",c},_adjustInstDate:function(e,t,n){var r=e.drawYear+(n=="Y"?t:0),i=e.drawMonth+(n=="M"?t:0),s=Math.min(e.selectedDay,this._getDaysInMonth(r,i))+(n=="D"?t:0),o=this._restrictMinMax(e,this._daylightSavingAdjust(new Date(r,i,s)));e.selectedDay=o.getDate(),e.drawMonth=e.selectedMonth=o.getMonth(),e.drawYear=e.selectedYear=o.getFullYear(),(n=="M"||n=="Y")&&this._notifyChange(e)},_restrictMinMax:function(e,t){var n=this._getMinMaxDate(e,"min"),r=this._getMinMaxDate(e,"max"),i=n&&t<n?n:t;return i=r&&i>r?r:i,i},_notifyChange:function(e){var t=this._get(e,"onChangeMonthYear");t&&t.apply(e.input?e.input[0]:null,[e.selectedYear,e.selectedMonth+1,e])},_getNumberOfMonths:function(e){var t=this._get(e,"numberOfMonths");return t==null?[1,1]:typeof t=="number"?[1,t]:t},_getMinMaxDate:function(e,t){return this._determineDate(e,this._get(e,t+"Date"),null)},_getDaysInMonth:function(e,t){return 32-this._daylightSavingAdjust(new Date(e,t,32)).getDate()},_getFirstDayOfMonth:function(e,t){return(new Date(e,t,1)).getDay()},_canAdjustMonth:function(e,t,n,r){var i=this._getNumberOfMonths(e),s=this._daylightSavingAdjust(new Date(n,r+(t<0?t:i[0]*i[1]),1));return t<0&&s.setDate(this._getDaysInMonth(s.getFullYear(),s.getMonth())),this._isInRange(e,s)},_isInRange:function(e,t){var n=this._getMinMaxDate(e,"min"),r=this._getMinMaxDate(e,"max");return(!n||t.getTime()>=n.getTime())&&(!r||t.getTime()<=r.getTime())},_getFormatConfig:function(e){var t=this._get(e,"shortYearCutoff");return t=typeof t!="string"?t:(new Date).getFullYear()%100+parseInt(t,10),{shortYearCutoff:t,dayNamesShort:this._get(e,"dayNamesShort"),dayNames:this._get(e,"dayNames"),monthNamesShort:this._get(e,"monthNamesShort"),monthNames:this._get(e,"monthNames")}},_formatDate:function(e,t,n,r){t||(e.currentDay=e.selectedDay,e.currentMonth=e.selectedMonth,e.currentYear=
e.selectedYear);var i=t?typeof t=="object"?t:this._daylightSavingAdjust(new Date(r,n,t)):this._daylightSavingAdjust(new Date(e.currentYear,e.currentMonth,e.currentDay));return this.formatDate(this._get(e,"dateFormat"),i,this._getFormatConfig(e))}}),$.fn.datepicker=function(e){if(!this.length)return this;$.datepicker.initialized||($(document).mousedown($.datepicker._checkExternalClick).find("body").append($.datepicker.dpDiv),$.datepicker.initialized=!0);var t=Array.prototype.slice.call(arguments,1);return typeof e!="string"||e!="isDisabled"&&e!="getDate"&&e!="widget"?e=="option"&&arguments.length==2&&typeof arguments[1]=="string"?$.datepicker["_"+e+"Datepicker"].apply($.datepicker,[this[0]].concat(t)):this.each(function(){typeof e=="string"?$.datepicker["_"+e+"Datepicker"].apply($.datepicker,[this].concat(t)):$.datepicker._attachDatepicker(this,e)}):$.datepicker["_"+e+"Datepicker"].apply($.datepicker,[this[0]].concat(t))},$.datepicker=new Datepicker,$.datepicker.initialized=!1,$.datepicker.uuid=(new Date).getTime(),$.datepicker.version="1.8.22",window["DP_jQuery_"+dpuuid]=$}(jQuery),function(e,t){var n="ui-dialog ui-widget ui-widget-content ui-corner-all ",r={buttons:!0,height:!0,maxHeight:!0,maxWidth:!0,minHeight:!0,minWidth:!0,width:!0},i={maxHeight:!0,maxWidth:!0,minHeight:!0,minWidth:!0},s=e.attrFn||{val:!0,css:!0,html:!0,text:!0,data:!0,width:!0,height:!0,offset:!0,click:!0};e.widget("ui.dialog",{options:{autoOpen:!0,buttons:{},closeOnEscape:!0,closeText:"close",dialogClass:"",draggable:!0,hide:null,height:"auto",maxHeight:!1,maxWidth:!1,minHeight:150,minWidth:150,modal:!1,position:{my:"center",at:"center",collision:"fit",using:function(t){var n=e(this).css(t).offset().top;n<0&&e(this).css("top",t.top-n)}},resizable:!0,show:null,stack:!0,title:"",width:300,zIndex:1e3},_create:function(){this.originalTitle=this.element.attr("title"),typeof this.originalTitle!="string"&&(this.originalTitle=""),this.options.title=this.options.title||this.originalTitle;var t=this,r=t.options,i=r.title||"&#160;",s=e.ui.dialog.getTitleId(t.element),o=(t.uiDialog=e("<div></div>")).appendTo(document.body).hide().addClass(n+r.dialogClass).css({zIndex:r.zIndex}).attr("tabIndex",-1).css("outline",0).keydown(function(n){r.closeOnEscape&&!n.isDefaultPrevented()&&n.keyCode&&n.keyCode===e.ui.keyCode.ESCAPE&&(t.close(n),n.preventDefault())}).attr({role:"dialog","aria-labelledby":s}).mousedown(function(e){t.moveToTop(!1,e)}),u=t.element.show().removeAttr("title").addClass("ui-dialog-content ui-widget-content").appendTo(o),f=(t.uiDialogTitlebar=e("<div></div>")).addClass("ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix").prependTo(o),l=e('<a href="#"></a>').addClass("ui-dialog-titlebar-close ui-corner-all").attr("role","button").hover(function(){l.addClass("ui-state-hover")},function(){l.removeClass("ui-state-hover")}).focus(function(){l.addClass("ui-state-focus")}).blur(function(){l.removeClass("ui-state-focus")}).click(function(e){return t.close(e),!1}).appendTo(f),h=(t.uiDialogTitlebarCloseText=e("<span></span>")).addClass("ui-icon ui-icon-closethick").text(r.closeText).appendTo(l),p=e("<span></span>").addClass("ui-dialog-title").attr("id",s).html(i).prependTo(f);e.isFunction(r.beforeclose)&&!e.isFunction(r.beforeClose)&&(r.beforeClose=r.beforeclose),f.find("*").add(f).disableSelection(),r.draggable&&e.fn.draggable&&t._makeDraggable(),r.resizable&&e.fn.resizable&&t._makeResizable(),t._createButtons(r.buttons),t._isOpen=!1,e.fn.bgiframe&&o.bgiframe()},_init:function(){this.options.autoOpen&&this.open()},destroy:function(){var e=this;return e.overlay&&e.overlay.destroy(),e.uiDialog.hide(),e.element.unbind(".dialog").removeData("dialog").removeClass("ui-dialog-content ui-widget-content").hide().appendTo("body"),e.uiDialog.remove(),e.originalTitle&&e.element.attr("title",e.originalTitle),e},widget:function(){return this.uiDialog},close:function(t){var n=this,r,i;if(!1===n._trigger("beforeClose",t))return;return n.overlay&&n.overlay.destroy(),n.uiDialog.unbind("keypress.ui-dialog"),n._isOpen=!1,n.options.hide?n.uiDialog.hide(n.options.hide,function(){n._trigger("close",t)}):(n.uiDialog.hide(),n._trigger("close",t)),e.ui.dialog.overlay.resize(),n.options.modal&&(r=0,e(".ui-dialog").each(function(){this!==n.uiDialog[0]&&(i=e(this).css("z-index"),isNaN(i)||(r=Math.max(r,i)))}),e.ui.dialog.maxZ=r),n},isOpen:function(){return this._isOpen},moveToTop:function(t,n){var r=this,i=r.options,s;return i.modal&&!t||!i.stack&&!i.modal?r._trigger("focus",n):(i.zIndex>e.ui.dialog.maxZ&&(e.ui.dialog.maxZ=i.zIndex),r.overlay&&(e.ui.dialog.maxZ+=1,r.overlay.$el.css("z-index",e.ui.dialog.overlay.maxZ=e.ui.dialog.maxZ)),s={scrollTop:r.element.scrollTop(),scrollLeft:r.element.scrollLeft()},e.ui.dialog.maxZ+=1,r.uiDialog.css("z-index",e.ui.dialog.maxZ),r.element.attr(s),r._trigger("focus",n),r)},open:function(){if(this._isOpen)return;var t=this,n=t.options,r=t.uiDialog;return t.overlay=n.modal?new e.ui.dialog.overlay(t):null,t._size(),t._position(n.position),r.show(n.show),t.moveToTop(!0),n.modal&&r.bind("keydown.ui-dialog",function(t){if(t.keyCode!==e.ui.keyCode.TAB)return;var n=e(":tabbable",this),r=n.filter(":first"),i=n.filter(":last");if(t.target===i[0]&&!t.shiftKey)return r.focus(1),!1;if(t.target===r[0]&&t.shiftKey)return i.focus(1),!1}),e(t.element.find(":tabbable").get().concat(r.find(".ui-dialog-buttonpane :tabbable").get().concat(r.get()))).eq(0).focus(),t._isOpen=!0,t._trigger("open"),t},_createButtons:function(t){var n=this,r=!1,i=e("<div></div>").addClass("ui-dialog-buttonpane ui-widget-content ui-helper-clearfix"),o=e("<div></div>").addClass("ui-dialog-buttonset").appendTo(i);n.uiDialog.find(".ui-dialog-buttonpane").remove(),typeof t=="object"&&t!==null&&e.each(t,function(){return!(r=!0)}),r&&(e.each(t,function(t,r){r=e.isFunction(r)?{click:r,text:t}:r;var i=e('<button type="button"></button>').click(function(){r.click.apply(n.element[0],arguments)}).appendTo(o);e.each(r,function(e,t){if(e==="click")return;e in s?i[e](t):i.attr(e,t)}),e.fn.button&&i.button()}),i.appendTo(n.uiDialog))},_makeDraggable:function(){function t(e){return{position:e.position,offset:e.offset}}var n=this,r=n.options,i=e(document),s;n.uiDialog.draggable({cancel:".ui-dialog-content, .ui-dialog-titlebar-close",handle:".ui-dialog-titlebar",containment:"document",start:function(i,o){s=r.height==="auto"?"auto":e(this).height(),e(this).height(e(this).height()).addClass("ui-dialog-dragging"),n._trigger("dragStart",i,t(o))},drag:function(e,r){n._trigger("drag",e,t(r))},stop:function(o,u){r.position=[u.position.left-i.scrollLeft(),u.position.top-i.scrollTop()],e(this).removeClass("ui-dialog-dragging").height(s),n._trigger("dragStop",o,t(u)),e.ui.dialog.overlay.resize()}})},_makeResizable:function(n){function r(e){return{originalPosition:e.originalPosition,originalSize:e.originalSize,position:e.position,size:e.size}}n=n===t?this.options.resizable:n;var i=this,s=i.options,o=i.uiDialog.css("position"),u=typeof n=="string"?n:"n,e,s,w,se,sw,ne,nw";i.uiDialog.resizable({cancel:".ui-dialog-content",containment:"document",alsoResize:i.element,maxWidth:s.maxWidth,maxHeight:s.maxHeight,minWidth:s.minWidth,minHeight:i._minHeight(),handles:u,start:function(t,n){e(this).addClass("ui-dialog-resizing"),i._trigger("resizeStart",t,r(n))},resize:function(e,t){i._trigger("resize",e,r(t))},stop:function(t,n){e(this).removeClass("ui-dialog-resizing"),s.height=e(this).height(),s.width=e(this).width(),i._trigger("resizeStop",t,r(n)),e.ui.dialog.overlay.resize()}}).css("position",o).find(".ui-resizable-se").addClass("ui-icon ui-icon-grip-diagonal-se")},_minHeight:function(){var e=this.options;return e.height==="auto"?e.minHeight:Math.min(e.minHeight,e.height)},_position:function(t){var n=[],r=[0,0],i;if(t){if(typeof t=="string"||typeof t=="object"&&"0"in t)n=t.split?t.split(" "):[t[0],t[1]],n.length===1&&(n[1]=n[0]),e.each(["left","top"],function(e,t){+n[e]===n[e]&&(r[e]=n[e],n[e]=t)}),t={my:n.join(" "),at:n.join(" "),offset:r.join(" ")};t=e.extend({},e.ui.dialog.prototype.options.position,t)}else t=e.ui.dialog.prototype.options.position;i=this.uiDialog.is(":visible"),i||this.uiDialog.show(),this.uiDialog.css({top:0,left:0}).position(e.extend({of:window},t)),i||this.uiDialog.hide()},_setOptions:function(t){var n=this,s={},o=!1;e.each(t,function(e,t){n._setOption(e,t),e in r&&(o=!0),e in i&&(s[e]=t)}),o&&this._size(),this.uiDialog.is(":data(resizable)")&&this.uiDialog.resizable("option",s)},_setOption:function(t,r){var i=this,s=i.uiDialog;switch(t){case"beforeclose":t="beforeClose";break;case"buttons":i._createButtons(r);break;case"closeText":i.uiDialogTitlebarCloseText.text(""+r);break;case"dialogClass":s.removeClass(i.options.dialogClass).addClass(n+r);break;case"disabled":r?s.addClass("ui-dialog-disabled"):s.removeClass("ui-dialog-disabled");break;case"draggable":var o=s.is(":data(draggable)");o&&!r&&s.draggable("destroy"),!o&&r&&i._makeDraggable();break;case"position":i._position(r);break;case"resizable":var u=s.is(":data(resizable)");u&&!r&&s.resizable("destroy"),u&&typeof r=="string"&&s.resizable("option","handles",r),!u&&r!==!1&&i._makeResizable(r);break;case"title":e(".ui-dialog-title",i.uiDialogTitlebar).html(""+(r||"&#160;"))}e.Widget.prototype._setOption.apply(i,arguments)},_size:function(){var t=this.options,n,r,i=this.uiDialog.is(":visible");this.element.show().css({width:"auto",minHeight:0,height:0}),t.minWidth>t.width&&(t.width=t.minWidth),n=this.uiDialog.css({height:"auto",width:t.width}).height(),r=Math.max(0,t.minHeight-n);if(t.height==="auto")if(e.support.minHeight)this.element.css({minHeight:r,height:"auto"});else{this.uiDialog.show();var s=this.element.css("height","auto").height();i||this.uiDialog.hide(),this.element.height(Math.max(s,r))}else this.element.height(Math.max(t.height-n,0));this.uiDialog.is(":data(resizable)")&&this.uiDialog.resizable("option","minHeight",this._minHeight())}}),e.extend(e.ui.dialog,{version:"1.8.22",uuid:0,maxZ:0,getTitleId:function(e){var t=e.attr("id");return t||(this.uuid+=1,t=this.uuid),"ui-dialog-title-"+t},overlay:function(t){this.$el=e.ui.dialog.overlay.create(t)}}),e.extend(e.ui.dialog.overlay,{instances:[],oldInstances:[],maxZ:0,events:e.map("focus,mousedown,mouseup,keydown,keypress,click".split(","),function(e){return e+".dialog-overlay"}).join(" "),create:function(t){this.instances.length===0&&(setTimeout(function(){e.ui.dialog.overlay.instances.length&&e(document).bind(e.ui.dialog.overlay.events,function(t){if(e(t.target).zIndex()<e.ui.dialog.overlay.maxZ)return!1})},1),e(document).bind("keydown.dialog-overlay",function(n){t.options.closeOnEscape&&!n.isDefaultPrevented()&&n.keyCode&&n.keyCode===e.ui.keyCode.ESCAPE&&(t.close(n),n.preventDefault())}),e(window).bind("resize.dialog-overlay",e.ui.dialog.overlay.resize));var n=(this.oldInstances.pop()||e("<div></div>").addClass("ui-widget-overlay")).appendTo(document.body).css({width:this.width(),height:this.height()});return e.fn.bgiframe&&n.bgiframe(),this.instances.push(n),n},destroy:function(t){var n=e.inArray(t,this.instances);n!=-1&&this.oldInstances.push(this.instances.splice(n,1)[0]),this.instances.length===0&&e([document,window]).unbind(".dialog-overlay"),t.remove();var r=0;e.each(this.instances,function(){r=Math.max(r,this.css("z-index"))}),this.maxZ=r},height:function(){var t,n;return e.browser.msie&&e.browser.version<7?(t=Math.max(document.documentElement.scrollHeight,document.body.scrollHeight),n=Math.max(document.documentElement.offsetHeight,document.body.offsetHeight),t<n?e(window).height()+"px":t+"px"):e(document).height()+"px"},width:function(){var t,n;return e.browser.msie?(t=Math.max(document.documentElement.scrollWidth,document.body.scrollWidth),n=Math.max(document.documentElement.offsetWidth,document.body.offsetWidth),t<n?e(window).width()+"px":t+"px"):e(document).width()+"px"},resize:function(){var t=e([]);e.each(e.ui.dialog.overlay.instances,function(){t=t.add(this)}),t.css({width:0,height:0}).css({width:e.ui.dialog.overlay.width(),height:e.ui.dialog.overlay.height()})}}),e.extend(e.ui.dialog.overlay.prototype,{destroy:function(){e.ui.dialog.overlay.destroy(this.$el)}})}(jQuery),function(e,t){e.ui=e.ui||{};var n=/left|center|right/,r=/top|center|bottom/,i="center",s={},o=e.fn.position,u=e.fn.offset;e.fn.position=function(t){if(!t||!t.of)return o.apply(this,arguments);t=e.extend({},t);var u=e(t.of),l=u[0],h=(t.collision||"flip").split(" "),p=t.offset?t.offset.split(" "):[0,0],v,m,y;return l.nodeType===9?(v=u.width(),m=u.height(),y={top:0,left:0}):l.setTimeout?(v=u.width(),m=u.height(),y={top:u.scrollTop(),left:u.scrollLeft()}):l.preventDefault?(t.at="left top",v=m=0,y={top:t.of.pageY,left:t.of.pageX}):(v=u.outerWidth(),m=u.outerHeight(),y=u.offset()),e.each(["my","at"],function(){var e=(t[this]||"").split(" ");e.length===1&&(e=n.test(e[0])?e.concat([i]):r.test(e[0])?[i].concat(e):[i,i]),e[0]=n.test(e[0])?e[0]:i,e[1]=r.test(e[1])?e[1]:i,t[this]=e}),h.length===1&&(h[1]=h[0]),p[0]=parseInt(p[0],10)||0,p.length===1&&(p[1]=p[0]),p[1]=parseInt(p[1],10)||0,t.at[0]==="right"?y.left+=v:t.at[0]===i&&(y.left+=v/2),t.at[1]==="bottom"?y.top+=m:t.at[1]===i&&(y.top+=m/2),y.left+=p[0],y.top+=p[1],this.each(function(){var n=e(this),r=n.outerWidth(),o=n.outerHeight(),u=parseInt(e.curCSS(this,"marginLeft",!0))||0,l=parseInt(e.curCSS(this,"marginTop",!0))||0,c=r+u+(parseInt(e.curCSS(this,"marginRight",!0))||0),d=o+l+(parseInt(e.curCSS(this,"marginBottom",!0))||0),g=e.extend({},y),w;t.my[0]==="right"?g.left-=r:t.my[0]===i&&(g.left-=r/2),t.my[1]==="bottom"?g.top-=o:t.my[1]===i&&(g.top-=o/2),s.fractions||(g.left=Math.round(g.left),g.top=Math.round(g.top)),w={left:g.left-u,top:g.top-l},e.each(["left","top"],function(n,i){e.ui.position[h[n]]&&e.ui.position[h[n]][i](g,{targetWidth:v,targetHeight:m,elemWidth:r,elemHeight:o,collisionPosition:w,collisionWidth:c,collisionHeight:d,offset:p,my:t.my,at:t.at})}),e.fn.bgiframe&&n.bgiframe(),n.offset(e.extend(g,{using:t.using}))})},e.ui.position={fit:{left:function(t,n){var r=e(window),i=n.collisionPosition.left+n.collisionWidth-r.width()-r.scrollLeft();t.left=i>0?t.left-i:Math.max(t.left-n.collisionPosition.left,t.left)},top:function(t,n){var r=e(window),i=n.collisionPosition.top+n.collisionHeight-r.height()-r.scrollTop();t.top=i>0?t.top-i:Math.max(t.top-n.collisionPosition.top,t.top)}},flip:{left:function(t,n){if(n.at[0]===i)return;var r=e(window),s=n.collisionPosition.left+n.collisionWidth-r.width()-r.scrollLeft(),o=n.my[0]==="left"?-n.elemWidth:n.my[0]==="right"?n.elemWidth:0,u=n.at[0]==="left"?n.targetWidth:-n.targetWidth,f=-2*n.offset[0];t.left+=n.collisionPosition.left<0?o+u+f:s>0?o+u+f:0},top:function(t,n){if(n.at[1]===i)return;var r=e(window),s=n.collisionPosition.top+n.collisionHeight-r.height()-r.scrollTop(),o=n.my[1]==="top"?-n.elemHeight:n.my[1]==="bottom"?n.elemHeight:0,u=n.at[1]==="top"?n.targetHeight:-n.targetHeight,f=-2*n.offset[1];t.top+=n.collisionPosition.top<0?o+u+f:s>0?o+u+f:0}}},e.offset.setOffset||(e.offset.setOffset=function(t,n){/static/.test(e.curCSS(t,"position"))&&(t.style.position="relative");var r=e(t),i=r.offset(),s=parseInt(e.curCSS(t,"top",!0),10)||0,o=parseInt(e.curCSS(t,"left",!0),10)||0,u={top:n.top-i.top+s,left:n.left-i.left+o};"using"in n?n.using.call(t,u):r.css(u)},e.fn.offset=function(t){var n=this[0];return!n||!n.ownerDocument?null:t?e.isFunction(t)?this.each(function(n){e(this).offset(t.call(this,n,e(this).offset()))}):this.each(function(){e.offset.setOffset(this,t)}):u.call(this)}),function(){var t=document.getElementsByTagName("body")[0],n=document.createElement("div"),r,i,o,u,l;r=document.createElement(t?"div":"body"),o={visibility:"hidden",width:0,height:0,border:0,margin:0,background:"none"},t&&e.extend(o,{position:"absolute",left:"-1000px",top:"-1000px"});for(var c in o)r.style[c]=o[c];r.appendChild(n),i=t||document.documentElement,i.insertBefore(r,i.firstChild),n.style.cssText="position: absolute; left: 10.7432222px; top: 10.432325px; height: 30px; width: 201px;",u=e(n).offset(function(e,t){return t}).offset(),r.innerHTML="",i.removeChild(r),l=u.top+u.left+(t?2e3:0),s.fractions=l>21&&l<22}()}(jQuery),function(e,t){e.widget("ui.progressbar",{options:{value:0,max:100},min:0,_create:function(){this.element.addClass("ui-progressbar ui-widget ui-widget-content ui-corner-all").attr({role:"progressbar","aria-valuemin":this.min,"aria-valuemax":this.options.max,"aria-valuenow":this._value()}),this.valueDiv=e("<div class='ui-progressbar-value ui-widget-header ui-corner-left'></div>").appendTo(this.element),this.oldValue=this._value(),this._refreshValue()},destroy:function(){this.element.removeClass("ui-progressbar ui-widget ui-widget-content ui-corner-all").removeAttr("role").removeAttr("aria-valuemin").removeAttr("aria-valuemax").removeAttr("aria-valuenow"),this.valueDiv.remove(),e.Widget.prototype.destroy.apply(this,arguments)},value:function(e){return e===t?this._value():(this._setOption("value",e),this)},_setOption:function(t,n){t==="value"&&(this.options.value=n,this._refreshValue(),this._value()===this.options.max&&this._trigger("complete")),e.Widget.prototype._setOption.apply(this,arguments)},_value:function(){var e=this.options.value;return typeof e!="number"&&(e=0),Math.min(this.options.max,Math.max(this.min,e))},_percentage:function(){return 100*this._value()/this.options.max},_refreshValue:function(){var e=this.value(),t=this._percentage();this.oldValue!==e&&(this.oldValue=e,this._trigger("change")),this.valueDiv.toggle(e>this.min).toggleClass("ui-corner-right",e===this.options.max).width(t.toFixed(0)+"%"),this.element.attr("aria-valuenow",e)}}),e.extend(e.ui.progressbar,{version:"1.8.22"})}(jQuery),function(e,t){var n=5;e.widget("ui.slider",e.ui.mouse,{widgetEventPrefix:"slide",options:{animate:!1,distance:0,max:100,min:0,orientation:"horizontal",range:!1,step:1,value:0,values:null},_create:function(){var t=this,r=this.options,i=this.element.find(".ui-slider-handle").addClass("ui-state-default ui-corner-all"),s="<a class='ui-slider-handle ui-state-default ui-corner-all' href='#'></a>",o=r.values&&r.values.length||1,u=[];this._keySliding=!1,this._mouseSliding=!1,this._animateOff=!0,this._handleIndex=null,this._detectOrientation(),this._mouseInit(),this.element.addClass("ui-slider ui-slider-"+this.orientation+" ui-widget"+" ui-widget-content"+" ui-corner-all"+(r.disabled?" ui-slider-disabled ui-disabled":"")),this.range=e([]),r.range&&(r.range===!0&&(r.values||(r.values=[this._valueMin(),this._valueMin()]),r.values.length&&r.values.length!==2&&(r.values=[r.values[0],r.values[0]])),this.range=e("<div></div>").appendTo(this.element).addClass("ui-slider-range ui-widget-header"+(r.range==="min"||r.range==="max"?" ui-slider-range-"+r.range:"")));for(var f=i.length;f<o;f+=1)u.push(s);this.handles=i.add(e(u.join("")).appendTo(t.element)),this.handle=this.handles.eq(0),this.handles.add(this.range).filter("a").click(function(e){e.preventDefault()}).hover(function(){r.disabled||e(this).addClass("ui-state-hover")},function(){e(this).removeClass("ui-state-hover")}).focus(function(){r.disabled?e(this).blur():(e(".ui-slider .ui-state-focus").removeClass("ui-state-focus"),e(this).addClass("ui-state-focus"))}).blur(function(){e(this).removeClass("ui-state-focus")}),this.handles.each(function(t){e(this).data("index.ui-slider-handle",t)}),this.handles.keydown(function(r){var i=e(this).data("index.ui-slider-handle"),s,o,u,f;if(t.options.disabled)return;switch(r.keyCode){case e.ui.keyCode.HOME:case e.ui.keyCode.END:case e.ui.keyCode.PAGE_UP:case e.ui.keyCode.PAGE_DOWN:case e.ui.keyCode.UP:case e.ui.keyCode.RIGHT:case e.ui.keyCode.DOWN:case e.ui.keyCode.LEFT:r.preventDefault();if(!t._keySliding){t._keySliding=!0,e(this).addClass("ui-state-active"),s=t._start(r,i);if(s===!1)return}}f=t.options.step,t.options.values&&t.options.values.length?o=u=t.values(i):o=u=t.value();switch(r.keyCode){case e.ui.keyCode.HOME:u=t._valueMin();break;case e.ui.keyCode.END:u=t._valueMax();break;case e.ui.keyCode.PAGE_UP:u=t._trimAlignValue(o+(t._valueMax()-t._valueMin())/n);break;case e.ui.keyCode.PAGE_DOWN:u=t._trimAlignValue(o-(t._valueMax()-t._valueMin())/n);break;case e.ui.keyCode.UP:case e.ui.keyCode.RIGHT:if(o===t._valueMax())return;u=t._trimAlignValue(o+f);break;case e.ui.keyCode.DOWN:case e.ui.keyCode.LEFT:if(o===t._valueMin())return;u=t._trimAlignValue(o-f)}t._slide(r,i,u)}).keyup(function(n){var r=e(this).data("index.ui-slider-handle");t._keySliding&&(t._keySliding=!1,t._stop(n,r),t._change(n,r),e(this).removeClass("ui-state-active"))}),this._refreshValue(),this._animateOff=!1},destroy:function(){return this.handles.remove(),this.range.remove(),this.element.removeClass("ui-slider ui-slider-horizontal ui-slider-vertical ui-slider-disabled ui-widget ui-widget-content ui-corner-all").removeData("slider").unbind(".slider"),this._mouseDestroy(),this},_mouseCapture:function(t){var n=this.options,r,i,s,o,u,f,l,c,h;return n.disabled?!1:(this.elementSize={width:this.element.outerWidth(),height:this.element.outerHeight()},this.elementOffset=this.element.offset(),r={x:t.pageX,y:t.pageY},i=this._normValueFromMouse(r),s=this._valueMax()-this._valueMin()+1,u=this,this.handles.each(function(t){var n=Math.abs(i-u.values(t));s>n&&(s=n,o=e(this),f=t)}),n.range===!0&&this.values(1)===n.min&&(f+=1,o=e(this.handles[f])),l=this._start(t,f),l===!1?!1:(this._mouseSliding=!0,u._handleIndex=f,o.addClass("ui-state-active").focus(),c=o.offset(),h=!e(t.target).parents().andSelf().is(".ui-slider-handle"),this._clickOffset=h?{left:0,top:0}:{left:t.pageX-c.left-o.width()/2,top:t.pageY-c.top-o.height()/2-(parseInt(o.css("borderTopWidth"),10)||0)-(parseInt(o.css("borderBottomWidth"),10)||0)+(parseInt(o.css("marginTop"),10)||0)},this.handles.hasClass("ui-state-hover")||this._slide(t,f,i),this._animateOff=!0,!0))},_mouseStart:function(e){return!0},_mouseDrag:function(e){var t={x:e.pageX,y:e.pageY},n=this._normValueFromMouse(t);return this._slide(e,this._handleIndex,n),!1},_mouseStop:function(e){return this.handles.removeClass("ui-state-active"),this._mouseSliding=!1,this._stop(e,this._handleIndex),this._change(e,this._handleIndex),this._handleIndex=null,this._clickOffset=null,this._animateOff=!1,!1},_detectOrientation:function(){this.orientation=this.options.orientation==="vertical"?"vertical":"horizontal"},_normValueFromMouse:function(e){var t,n,r,i,s;return this.orientation==="horizontal"?(t=this.elementSize.width,n=e.x-this.elementOffset.left-(this._clickOffset?this._clickOffset.left:0)):(t=this.elementSize.height,n=e.y-this.elementOffset.top-(this._clickOffset?this._clickOffset.top:0)),r=n/t,r>1&&(r=1),r<0&&(r=0),this.orientation==="vertical"&&(r=1-r),i=this._valueMax()-this._valueMin(),s=this._valueMin()+r*i,this._trimAlignValue(s)},_start:function(e,t){var n={handle:this.handles[t],value:this.value()};return this.options.values&&this.options.values.length&&(n.value=this.values(t),n.values=this.values()),this._trigger("start",e,n)},_slide:function(e,t,n){var r,i,s;this.options.values&&this.options.values.length?(r=this.values(t?0:1),this.options.values.length===2&&this.options.range===!0&&(t===0&&n>r||t===1&&n<r)&&(n=r),n!==this.values(t)&&(i=this.values(),i[t]=n,s=this._trigger("slide",e,{handle:this.handles[t],value:n,values:i}),r=this.values(t?0:1),s!==!1&&this.values(t,n,!0))):n!==this.value()&&(s=this._trigger("slide",e,{handle:this.handles[t],value:n}),s!==!1&&this.value(n))},_stop:function(e,t){var n={handle:this.handles[t],value:this.value()};this.options.values&&this.options.values.length&&(n.value=this.values(t),n.values=this.values()),this._trigger("stop",e,n)},_change:function(e,t){if(!this._keySliding&&!this._mouseSliding){var n={handle:this.handles[t],value:this.value()};this.options.values&&this.options.values.length&&(n.value=this.values(t),n.values=this.values()),this._trigger("change",e,n)}},value:function(e){if(arguments.length){this.options.value=this._trimAlignValue(e),this._refreshValue(),this._change(null,0);return}return this._value()},values:function(t,n){var r,i,s;if(arguments.length>1){this.options.values[t]=this._trimAlignValue(n),this._refreshValue(),this._change(null,t);return}if(!arguments.length)return this._values();if(!e.isArray(arguments[0]))return this.options.values&&this.options.values.length?this._values(t):this.value();r=this.options.values,i=arguments[0];for(s=0;s<r.length;s+=1)r[s]=this._trimAlignValue(i[s]),this._change(null,s);this._refreshValue()},_setOption:function(t,n){var r,i=0;e.isArray(this.options.values)&&(i=this.options.values.length),e.Widget.prototype._setOption.apply(this,arguments);switch(t){case"disabled":n?(this.handles.filter(".ui-state-focus").blur(),this.handles.removeClass("ui-state-hover"),this.handles.propAttr("disabled",!0),this.element.addClass("ui-disabled")):(this.handles.propAttr("disabled",!1),this.element.removeClass("ui-disabled"));break;case"orientation":this._detectOrientation(),this.element.removeClass("ui-slider-horizontal ui-slider-vertical").addClass("ui-slider-"+this.orientation),this._refreshValue();break;case"value":this._animateOff=!0,this._refreshValue(),this._change(null,0),this._animateOff=!1;break;case"values":this._animateOff=!0,this._refreshValue();for(r=0;r<i;r+=1)this._change(null,r);this._animateOff=!1}},_value:function(){var e=this.options.value;return e=this._trimAlignValue(e),e},_values:function(e){var t,n,r;if(arguments.length)return t=this.options.values[e],t=this._trimAlignValue(t),t;n=this.options.values.slice();for(r=0;r<n.length;r+=1)n[r]=this._trimAlignValue(n[r]);return n},_trimAlignValue:function(e){if(e<=this._valueMin())return this._valueMin();if(e>=this._valueMax())return this._valueMax();var t=this.options.step>0?this.options.step:1,n=(e-this._valueMin())%t,r=e-n;return Math.abs(n)*2>=t&&(r+=n>0?t:-t),parseFloat(r.toFixed(5))},_valueMin:function(){return this.options.min},_valueMax:function(){return this.options.max},_refreshValue:function(){var t=this.options.range,n=this.options,r=this,i=this._animateOff?!1:n.animate,s,o={},u,f,l,c;this.options.values&&this.options.values.length?this.handles.each(function(t,f){s=(r.values(t)-r._valueMin())/(r._valueMax()-r._valueMin())*100,o[r.orientation==="horizontal"?"left":"bottom"]=s+"%",e(this).stop(1,1)[i?"animate":"css"](o,n.animate),r.options.range===!0&&(r.orientation==="horizontal"?(t===0&&r.range.stop(1,1)[i?"animate":"css"]({left:s+"%"},n.animate),t===1&&r.range[i?"animate":"css"]({width:s-u+"%"},{queue:!1,duration:n.animate})):(t===0&&r.range.stop(1,1)[i?"animate":"css"]({bottom:s+"%"},n.animate),t===1&&r.range[i?"animate":"css"]({height:s-u+"%"},{queue:!1,duration:n.animate}))),u=s}):(f=this.value(),l=this._valueMin(),c=this._valueMax(),s=c!==l?(f-l)/(c-l)*100:0,o[r.orientation==="horizontal"?"left":"bottom"]=s+"%",this.handle.stop(1,1)[i?"animate":"css"](o,n.animate),t==="min"&&this.orientation==="horizontal"&&this.range.stop(1,1)[i?"animate":"css"]({width:s+"%"},n.animate),t==="max"&&this.orientation==="horizontal"&&this.range[i?"animate":"css"]({width:100-s+"%"},{queue:!1,duration:n.animate}),t==="min"&&this.orientation==="vertical"&&this.range.stop(1,1)[i?"animate":"css"]({height:s+"%"},n.animate),t==="max"&&this.orientation==="vertical"&&this.range[i?"animate":"css"]({height:100-s+"%"},{queue:!1,duration:n.animate}))}}),e.extend(e.ui.slider,{version:"1.8.22"})}(jQuery),function(e,t){function n(){return++i}function r(){return++s}var i=0,s=0;e.widget("ui.tabs",{options:{add:null,ajaxOptions:null,cache:!1,cookie:null,collapsible:!1,disable:null,disabled:[],enable:null,event:"click",fx:null,idPrefix:"ui-tabs-",load:null,panelTemplate:"<div></div>",remove:null,select:null,show:null,spinner:"<em>Loading&#8230;</em>",tabTemplate:"<li><a href='#{href}'><span>#{label}</span></a></li>"},_create:function(){this._tabify(!0)},_setOption:function(e,t){if(e=="selected"){if(this.options.collapsible&&t==this.options.selected)return;this.select(t)}else this.options[e]=t,this._tabify()},_tabId:function(e){return e.title&&e.title.replace(/\s/g,"_").replace(/[^\w\u00c0-\uFFFF-]/g,"")||this.options.idPrefix+n()},_sanitizeSelector:function(e){return e.replace(/:/g,"\\:")},_cookie:function(){var t=this.cookie||(this.cookie=this.options.cookie.name||"ui-tabs-"+r());return e.cookie.apply(null,[t].concat(e.makeArray(arguments)))},_ui:function(e,t){return{tab:e,panel:t,index:this.anchors.index(e)}},_cleanup:function(){this.lis.filter(".ui-state-processing").removeClass("ui-state-processing").find("span:data(label.tabs)").each(function(){var t=e(this);t.html(t.data("label.tabs")).removeData("label.tabs")})},_tabify:function(n){function r(t,n){t.css("display",""),!e.support.opacity&&n.opacity&&t[0].style.removeAttribute("filter")}var i=this,s=this.options,o=/^#.+/;this.list=this.element.find("ol,ul").eq(0),this.lis=e(" > li:has(a[href])",this.list),this.anchors=this.lis.map(function(){return e("a",this)[0]}),this.panels=e([]),this.anchors.each(function(t,n){var r=e(n).attr("href"),u=r.split("#")[0],f;u&&(u===location.toString().split("#")[0]||(f=e("base")[0])&&u===f.href)&&(r=n.hash,n.href=r);if(o.test(r))i.panels=i.panels.add(i.element.find(i._sanitizeSelector(r)));else if(r&&r!=="#"){e.data(n,"href.tabs",r),e.data(n,"load.tabs",r.replace(/#.*$/,""));var l=i._tabId(n);n.href="#"+l;var c=i.element.find("#"+l);c.length||(c=e(s.panelTemplate).attr("id",l).addClass("ui-tabs-panel ui-widget-content ui-corner-bottom").insertAfter(i.panels[t-1]||i.list),c.data("destroy.tabs",!0)),i.panels=i.panels.add(c)}else s.disabled.push(t)}),n?(this.element.addClass("ui-tabs ui-widget ui-widget-content ui-corner-all"),this.list.addClass("ui-tabs-nav ui-helper-reset ui-helper-clearfix ui-widget-header ui-corner-all"),this.lis.addClass("ui-state-default ui-corner-top"),this.panels.addClass("ui-tabs-panel ui-widget-content ui-corner-bottom"),s.selected===t?(location.hash&&this.anchors.each(function(e,t){if(t.hash==location.hash)return s.selected=e,!1}),typeof s.selected!="number"&&s.cookie&&(s.selected=parseInt(i._cookie(),10)),typeof s.selected!="number"&&this.lis.filter(".ui-tabs-selected").length&&(s.selected=this.lis.index(this.lis.filter(".ui-tabs-selected"))),s.selected=s.selected||(this.lis.length?0:-1)):s.selected===null&&(s.selected=-1),s.selected=s.selected>=0&&this.anchors[s.selected]||s.selected<0?s.selected:0,s.disabled=e.unique(s.disabled.concat(e.map(this.lis.filter(".ui-state-disabled"),function(e,t){return i.lis.index(e)}))).sort(),e.inArray(s.selected,s.disabled)!=-1&&s.disabled.splice(e.inArray(s.selected,s.disabled),1),this.panels.addClass("ui-tabs-hide"),this.lis.removeClass("ui-tabs-selected ui-state-active"),s.selected>=0&&this.anchors.length&&(i.element.find(i._sanitizeSelector(i.anchors[s.selected].hash)).removeClass("ui-tabs-hide"),this.lis.eq(s.selected).addClass("ui-tabs-selected ui-state-active"),i.element.queue("tabs",function(){i._trigger("show",null,i._ui(i.anchors[s.selected],i.element.find(i._sanitizeSelector(i.anchors[s.selected].hash))[0]))}),this.load(s.selected)),e(window).bind("unload",function(){i.lis.add(i.anchors).unbind(".tabs"),i.lis=i.anchors=i.panels=null})):s.selected=this.lis.index(this.lis.filter(".ui-tabs-selected")),this.element[s.collapsible?"addClass":"removeClass"]("ui-tabs-collapsible"),s.cookie&&this._cookie(s.selected,s.cookie);for(var u=0,f;f=this.lis[u];u++)e(f)[e.inArray(u,s.disabled)!=-1&&!e(f).hasClass("ui-tabs-selected")?"addClass":"removeClass"]("ui-state-disabled");s.cache===!1&&this.anchors.removeData("cache.tabs"),this.lis.add(this.anchors).unbind(".tabs");if(s.event!=="mouseover"){var l=function(e,t){t.is(":not(.ui-state-disabled)")&&t.addClass("ui-state-"+e)},c=function(e,t){t.removeClass("ui-state-"+e)};this.lis.bind("mouseover.tabs",function(){l("hover",e(this))}),this.lis.bind("mouseout.tabs",function(){c("hover",e(this))}),this.anchors.bind("focus.tabs",function(){l("focus",e(this).closest("li"))}),this.anchors.bind("blur.tabs",function(){c("focus",e(this).closest("li"))})}var h,p;s.fx&&(e.isArray(s.fx)?(h=s.fx[0],p=s.fx[1]):h=p=s.fx);var d=p?function(t,n){e(t).closest("li").addClass("ui-tabs-selected ui-state-active"),n.hide().removeClass("ui-tabs-hide").animate(p,p.duration||"normal",function(){r(n,p),i._trigger("show",null,i._ui(t,n[0]))})}:function(t,n){e(t).closest("li").addClass("ui-tabs-selected ui-state-active"),n.removeClass("ui-tabs-hide"),i._trigger("show",null,i._ui(t,n[0]))},v=h?function(e,t){t.animate(h,h.duration||"normal",function(){i.lis.removeClass("ui-tabs-selected ui-state-active"),t.addClass("ui-tabs-hide"),r(t,h),i.element.dequeue("tabs")})}:function(e,t,n){i.lis.removeClass("ui-tabs-selected ui-state-active"),t.addClass("ui-tabs-hide"),i.element.dequeue("tabs")};this.anchors.bind(s.event+".tabs",function(){var t=this,n=e(t).closest("li"),r=i.panels.filter(":not(.ui-tabs-hide)")
,o=i.element.find(i._sanitizeSelector(t.hash));if(n.hasClass("ui-tabs-selected")&&!s.collapsible||n.hasClass("ui-state-disabled")||n.hasClass("ui-state-processing")||i.panels.filter(":animated").length||i._trigger("select",null,i._ui(this,o[0]))===!1)return this.blur(),!1;s.selected=i.anchors.index(this),i.abort();if(s.collapsible){if(n.hasClass("ui-tabs-selected"))return s.selected=-1,s.cookie&&i._cookie(s.selected,s.cookie),i.element.queue("tabs",function(){v(t,r)}).dequeue("tabs"),this.blur(),!1;if(!r.length)return s.cookie&&i._cookie(s.selected,s.cookie),i.element.queue("tabs",function(){d(t,o)}),i.load(i.anchors.index(this)),this.blur(),!1}s.cookie&&i._cookie(s.selected,s.cookie);if(!o.length)throw"jQuery UI Tabs: Mismatching fragment identifier.";r.length&&i.element.queue("tabs",function(){v(t,r)}),i.element.queue("tabs",function(){d(t,o)}),i.load(i.anchors.index(this)),e.browser.msie&&this.blur()}),this.anchors.bind("click.tabs",function(){return!1})},_getIndex:function(e){return typeof e=="string"&&(e=this.anchors.index(this.anchors.filter("[href$='"+e+"']"))),e},destroy:function(){var t=this.options;return this.abort(),this.element.unbind(".tabs").removeClass("ui-tabs ui-widget ui-widget-content ui-corner-all ui-tabs-collapsible").removeData("tabs"),this.list.removeClass("ui-tabs-nav ui-helper-reset ui-helper-clearfix ui-widget-header ui-corner-all"),this.anchors.each(function(){var t=e.data(this,"href.tabs");t&&(this.href=t);var n=e(this).unbind(".tabs");e.each(["href","load","cache"],function(e,t){n.removeData(t+".tabs")})}),this.lis.unbind(".tabs").add(this.panels).each(function(){e.data(this,"destroy.tabs")?e(this).remove():e(this).removeClass(["ui-state-default","ui-corner-top","ui-tabs-selected","ui-state-active","ui-state-hover","ui-state-focus","ui-state-disabled","ui-tabs-panel","ui-widget-content","ui-corner-bottom","ui-tabs-hide"].join(" "))}),t.cookie&&this._cookie(null,t.cookie),this},add:function(n,r,i){i===t&&(i=this.anchors.length);var s=this,o=this.options,u=e(o.tabTemplate.replace(/#\{href\}/g,n).replace(/#\{label\}/g,r)),f=n.indexOf("#")?this._tabId(e("a",u)[0]):n.replace("#","");u.addClass("ui-state-default ui-corner-top").data("destroy.tabs",!0);var l=s.element.find("#"+f);return l.length||(l=e(o.panelTemplate).attr("id",f).data("destroy.tabs",!0)),l.addClass("ui-tabs-panel ui-widget-content ui-corner-bottom ui-tabs-hide"),i>=this.lis.length?(u.appendTo(this.list),l.appendTo(this.list[0].parentNode)):(u.insertBefore(this.lis[i]),l.insertBefore(this.panels[i])),o.disabled=e.map(o.disabled,function(e,t){return e>=i?++e:e}),this._tabify(),this.anchors.length==1&&(o.selected=0,u.addClass("ui-tabs-selected ui-state-active"),l.removeClass("ui-tabs-hide"),this.element.queue("tabs",function(){s._trigger("show",null,s._ui(s.anchors[0],s.panels[0]))}),this.load(0)),this._trigger("add",null,this._ui(this.anchors[i],this.panels[i])),this},remove:function(t){t=this._getIndex(t);var n=this.options,r=this.lis.eq(t).remove(),i=this.panels.eq(t).remove();return r.hasClass("ui-tabs-selected")&&this.anchors.length>1&&this.select(t+(t+1<this.anchors.length?1:-1)),n.disabled=e.map(e.grep(n.disabled,function(e,n){return e!=t}),function(e,n){return e>=t?--e:e}),this._tabify(),this._trigger("remove",null,this._ui(r.find("a")[0],i[0])),this},enable:function(t){t=this._getIndex(t);var n=this.options;if(e.inArray(t,n.disabled)==-1)return;return this.lis.eq(t).removeClass("ui-state-disabled"),n.disabled=e.grep(n.disabled,function(e,n){return e!=t}),this._trigger("enable",null,this._ui(this.anchors[t],this.panels[t])),this},disable:function(e){e=this._getIndex(e);var t=this,n=this.options;return e!=n.selected&&(this.lis.eq(e).addClass("ui-state-disabled"),n.disabled.push(e),n.disabled.sort(),this._trigger("disable",null,this._ui(this.anchors[e],this.panels[e]))),this},select:function(e){e=this._getIndex(e);if(e==-1){if(!this.options.collapsible||this.options.selected==-1)return this;e=this.options.selected}return this.anchors.eq(e).trigger(this.options.event+".tabs"),this},load:function(t){t=this._getIndex(t);var n=this,r=this.options,i=this.anchors.eq(t)[0],s=e.data(i,"load.tabs");this.abort();if(!s||this.element.queue("tabs").length!==0&&e.data(i,"cache.tabs")){this.element.dequeue("tabs");return}this.lis.eq(t).addClass("ui-state-processing");if(r.spinner){var o=e("span",i);o.data("label.tabs",o.html()).html(r.spinner)}return this.xhr=e.ajax(e.extend({},r.ajaxOptions,{url:s,success:function(s,o){n.element.find(n._sanitizeSelector(i.hash)).html(s),n._cleanup(),r.cache&&e.data(i,"cache.tabs",!0),n._trigger("load",null,n._ui(n.anchors[t],n.panels[t]));try{r.ajaxOptions.success(s,o)}catch(u){}},error:function(e,s,o){n._cleanup(),n._trigger("load",null,n._ui(n.anchors[t],n.panels[t]));try{r.ajaxOptions.error(e,s,t,i)}catch(o){}}})),n.element.dequeue("tabs"),this},abort:function(){return this.element.queue([]),this.panels.stop(!1,!0),this.element.queue("tabs",this.element.queue("tabs").splice(-2,2)),this.xhr&&(this.xhr.abort(),delete this.xhr),this._cleanup(),this},url:function(e,t){return this.anchors.eq(e).removeData("cache.tabs").data("load.tabs",t),this},length:function(){return this.anchors.length}}),e.extend(e.ui.tabs,{version:"1.8.22"}),e.extend(e.ui.tabs.prototype,{rotation:null,rotate:function(e,t){var n=this,r=this.options,i=n._rotate||(n._rotate=function(t){clearTimeout(n.rotation),n.rotation=setTimeout(function(){var e=r.selected;n.select(++e<n.anchors.length?e:0)},e),t&&t.stopPropagation()}),s=n._unrotate||(n._unrotate=t?function(e){i()}:function(e){e.clientX&&n.rotate(null)});return e?(this.element.bind("tabsshow",i),this.anchors.bind(r.event+".tabs",s),i()):(clearTimeout(n.rotation),this.element.unbind("tabsshow",i),this.anchors.unbind(r.event+".tabs",s),delete this._rotate,delete this._unrotate),this}})}(jQuery);(function(e){"use strict";typeof define=="function"&&define.amd?define(["jquery"],e):typeof exports=="object"&&typeof module=="object"?module.exports=e:e(jQuery)})(function(e,t){"use strict";function a(t,n,r,i){var o=[];for(var u=0;u<t.length;u++){var a=t[u];if(a){var f=tinycolor(a),l=f.toHsl().l<.5?"sp-thumb-el sp-thumb-dark":"sp-thumb-el sp-thumb-light";l+=tinycolor.equals(n,a)?" sp-thumb-active":"";var c=f.toString(i.preferredFormat||"rgb"),h=s?"background-color:"+f.toRgbString():"filter:"+f.toFilter();o.push('<span title="'+c+'" data-color="'+f.toRgbString()+'" class="'+l+'"><span class="sp-thumb-inner" style="'+h+';" /></span>')}else{var p="sp-clear-display";o.push(e("<div />").append(e('<span data-color="" style="background-color:transparent;" class="'+p+'"></span>').attr("title",i.noColorSelectedText)).html())}}return"<div class='sp-cf "+r+"'>"+o.join("")+"</div>"}function f(){for(var e=0;e<r.length;e++)r[e]&&r[e].hide()}function l(t,r){var i=e.extend({},n,t);return i.callbacks={move:v(i.move,r),change:v(i.change,r),show:v(i.show,r),hide:v(i.hide,r),beforeShow:v(i.beforeShow,r)},i}function c(n,c){function Nt(){p.showPaletteOnly&&(p.showPalette=!0),ct.text(p.showPaletteOnly?p.togglePaletteMoreText:p.togglePaletteLessText);if(p.palette){F=p.palette.slice(0),I=e.isArray(F[0])?F:[F],q={};for(var t=0;t<I.length;t++)for(var n=0;n<I[t].length;n++){var r=tinycolor(I[t][n]).toRgbString();q[r]=!0}}Q.toggleClass("sp-flat",v),Q.toggleClass("sp-input-disabled",!p.showInput),Q.toggleClass("sp-alpha-enabled",p.showAlpha),Q.toggleClass("sp-clear-enabled",Tt),Q.toggleClass("sp-buttons-disabled",!p.showButtons),Q.toggleClass("sp-palette-buttons-disabled",!p.togglePaletteOnly),Q.toggleClass("sp-palette-disabled",!p.showPalette),Q.toggleClass("sp-palette-only",p.showPaletteOnly),Q.toggleClass("sp-initial-disabled",!p.showInitial),Q.addClass(p.className).addClass(p.containerClassName),Jt()}function Ct(){function n(t){return t.data&&t.data.ignore?(Rt(e(t.target).closest(".sp-thumb-el").data("color")),Wt()):(Rt(e(t.target).closest(".sp-thumb-el").data("color")),Wt(),$t(!0),p.hideAfterPaletteSelect&&It()),!1}i&&Q.find("*:not(input)").attr("unselectable","on"),Nt(),dt&&J.after(vt).hide(),Tt||ft.hide();if(v)J.after(Q).hide();else{var t=p.appendTo==="parent"?J.parent():e(p.appendTo);t.length!==1&&(t=e("body")),t.append(Q)}kt(),mt.bind("click.spectrum touchstart.spectrum",function(t){K||Ht(),t.stopPropagation(),e(t.target).is("input")||t.preventDefault()}),(J.is(":disabled")||p.disabled===!0)&&Yt(),Q.click(d),st.change(Pt),st.bind("paste",function(){setTimeout(Pt,1)}),st.keydown(function(e){e.keyCode==13&&Pt()}),at.text(p.cancelText),at.bind("click.spectrum",function(e){e.stopPropagation(),e.preventDefault(),qt(),It()}),ft.attr("title",p.clearText),ft.bind("click.spectrum",function(e){e.stopPropagation(),e.preventDefault(),xt=!0,Wt(),v&&$t(!0)}),lt.text(p.chooseText),lt.bind("click.spectrum",function(e){e.stopPropagation(),e.preventDefault(),i&&st.is(":focus")&&st.trigger("change"),zt()&&($t(!0),It())}),ct.text(p.showPaletteOnly?p.togglePaletteMoreText:p.togglePaletteLessText),ct.bind("click.spectrum",function(e){e.stopPropagation(),e.preventDefault(),p.showPaletteOnly=!p.showPaletteOnly,!p.showPaletteOnly&&!v&&Q.css("left","-="+(G.outerWidth(!0)+5)),Nt()}),m(rt,function(e,t,n){j=e/M,xt=!1,n.shiftKey&&(j=Math.round(j*10)/10),Wt()},_t,Dt),m(et,function(e,t){P=parseFloat(t/A),xt=!1,p.showAlpha||(j=1),Wt()},_t,Dt),m(Y,function(e,t,n){if(!n.shiftKey)W=null;else if(!W){var r=H*C,i=k-B*k,s=Math.abs(e-r)>Math.abs(t-i);W=s?"x":"y"}var o=!W||W==="x",u=!W||W==="y";o&&(H=parseFloat(e/C)),u&&(B=parseFloat((k-t)/k)),xt=!1,p.showAlpha||(j=1),Wt()},_t,Dt),yt?(Rt(yt),Xt(),Et=wt||tinycolor(yt).format,Lt(yt)):Xt(),v&&Bt();var r=i?"mousedown.spectrum":"click.spectrum touchstart.spectrum";ot.delegate(".sp-thumb-el",r,n),ut.delegate(".sp-thumb-el:nth-child(1)",r,{ignore:!0},n)}function kt(){if(w&&window.localStorage){try{var t=window.localStorage[w].split(",#");t.length>1&&(delete window.localStorage[w],e.each(t,function(e,t){Lt(t)}))}catch(n){}try{R=window.localStorage[w].split(";")}catch(n){}}}function Lt(t){if(b){var n=tinycolor(t).toRgbString();if(!q[n]&&e.inArray(n,R)===-1){R.push(n);while(R.length>U)R.shift()}if(w&&window.localStorage)try{window.localStorage[w]=R.join(";")}catch(r){}}}function At(){var e=[];if(p.showPalette)for(var t=0;t<R.length;t++){var n=tinycolor(R[t]).toRgbString();q[n]||e.push(R[t])}return e.reverse().slice(0,p.maxSelectionSize)}function Ot(){var t=Ut(),n=e.map(I,function(e,n){return a(e,t,"sp-palette-row sp-palette-row-"+n,p)});kt(),R&&n.push(a(At(),t,"sp-palette-row sp-palette-row-selection",p)),ot.html(n.join(""))}function Mt(){if(p.showInitial){var e=bt,t=Ut();ut.html(a([e,t],t,"sp-palette-row-initial",p))}}function _t(){(k<=0||C<=0||A<=0)&&Jt(),N=!0,Q.addClass(z),W=null,J.trigger("dragstart.spectrum",[Ut()])}function Dt(){N=!1,Q.removeClass(z),J.trigger("dragstop.spectrum",[Ut()])}function Pt(){var e=st.val();if(e!==null&&e!==""||!Tt){var t=tinycolor(e);t.isValid()?(Rt(t),$t(!0)):st.addClass("sp-validation-error")}else Rt(null),$t(!0)}function Ht(){T?It():Bt()}function Bt(){var t=e.Event("beforeShow.spectrum");if(T){Jt();return}J.trigger(t,[Ut()]);if(S.beforeShow(Ut())===!1||t.isDefaultPrevented())return;f(),T=!0,e(X).bind("keydown.spectrum",jt),e(X).bind("click.spectrum",Ft),e(window).bind("resize.spectrum",x),vt.addClass("sp-active"),Q.removeClass("sp-hidden"),Jt(),Xt(),bt=Ut(),Mt(),S.show(bt),J.trigger("show.spectrum",[bt])}function jt(e){e.keyCode===27&&It()}function Ft(e){if(e.button==2)return;if(N)return;St?$t(!0):qt(),It()}function It(){if(!T||v)return;T=!1,e(X).unbind("keydown.spectrum",jt),e(X).unbind("click.spectrum",Ft),e(window).unbind("resize.spectrum",x),vt.removeClass("sp-active"),Q.addClass("sp-hidden"),S.hide(Ut()),J.trigger("hide.spectrum",[Ut()])}function qt(){Rt(bt,!0)}function Rt(e,t){if(tinycolor.equals(e,Ut())){Xt();return}var n,r;!e&&Tt?xt=!0:(xt=!1,n=tinycolor(e),r=n.toHsv(),P=r.h%360/360,H=r.s,B=r.v,j=r.a),Xt(),n&&n.isValid()&&!t&&(Et=wt||n.getFormat())}function Ut(e){return e=e||{},Tt&&xt?null:tinycolor.fromRatio({h:P,s:H,v:B,a:Math.round(j*100)/100},{format:e.format||Et})}function zt(){return!st.hasClass("sp-validation-error")}function Wt(){Xt(),S.move(Ut()),J.trigger("move.spectrum",[Ut()])}function Xt(){st.removeClass("sp-validation-error"),Vt();var e=tinycolor.fromRatio({h:P,s:1,v:1});Y.css("background-color",e.toHexString());var t=Et;j<1&&(j!==0||t!=="name")&&(t==="hex"||t==="hex3"||t==="hex6"||t==="name")&&(t="rgb");var n=Ut({format:t}),r="";gt.removeClass("sp-clear-display"),gt.css("background-color","transparent");if(!n&&Tt)gt.addClass("sp-clear-display");else{var o=n.toHexString(),u=n.toRgbString();s||n.alpha===1?gt.css("background-color",u):(gt.css("background-color","transparent"),gt.css("filter",n.toFilter()));if(p.showAlpha){var a=n.toRgb();a.a=0;var f=tinycolor(a).toRgbString(),l="linear-gradient(left, "+f+", "+o+")";i?nt.css("filter",tinycolor(f).toFilter({gradientType:1},o)):(nt.css("background","-webkit-"+l),nt.css("background","-moz-"+l),nt.css("background","-ms-"+l),nt.css("background","linear-gradient(to right, "+f+", "+o+")"))}r=n.toString(t)}p.showInput&&st.val(r),p.showPalette&&Ot(),Mt()}function Vt(){var e=H,t=B;if(Tt&&xt)it.hide(),tt.hide(),Z.hide();else{it.show(),tt.show(),Z.show();var n=e*C,r=k-t*k;n=Math.max(-L,Math.min(C-L,n-L)),r=Math.max(-L,Math.min(k-L,r-L)),Z.css({top:r+"px",left:n+"px"});var i=j*M;it.css({left:i-_/2+"px"});var s=P*A;tt.css({top:s-D+"px"})}}function $t(e){var t=Ut(),n="",r=!tinycolor.equals(t,bt);t&&(n=t.toString(Et),Lt(t)),ht&&J.val(n),e&&r&&(S.change(t),J.trigger("change",[t]))}function Jt(){C=Y.width(),k=Y.height(),L=Z.height(),O=et.width(),A=et.height(),D=tt.height(),M=rt.width(),_=it.width(),v||(Q.css("position","absolute"),p.offset?Q.offset(p.offset):Q.offset(h(Q,mt))),Vt(),p.showPalette&&Ot(),J.trigger("reflow.spectrum")}function Kt(){J.show(),mt.unbind("click.spectrum touchstart.spectrum"),Q.remove(),vt.remove(),r[en.id]=null}function Qt(n,r){if(n===t)return e.extend({},p);if(r===t)return p[n];p[n]=r,Nt()}function Gt(){K=!1,J.attr("disabled",!1),mt.removeClass("sp-disabled")}function Yt(){It(),K=!0,J.attr("disabled",!0),mt.addClass("sp-disabled")}function Zt(e){p.offset=e,Jt()}var p=l(c,n),v=p.flat,b=p.showSelectionPalette,w=p.localStorageKey,E=p.theme,S=p.callbacks,x=g(Jt,10),T=!1,N=!1,C=0,k=0,L=0,A=0,O=0,M=0,_=0,D=0,P=0,H=0,B=0,j=1,F=[],I=[],q={},R=p.selectionPalette.slice(0),U=p.maxSelectionSize,z="sp-dragging",W=null,X=n.ownerDocument,V=X.body,J=e(n),K=!1,Q=e(u,X).addClass(E),G=Q.find(".sp-picker-container"),Y=Q.find(".sp-color"),Z=Q.find(".sp-dragger"),et=Q.find(".sp-hue"),tt=Q.find(".sp-slider"),nt=Q.find(".sp-alpha-inner"),rt=Q.find(".sp-alpha"),it=Q.find(".sp-alpha-handle"),st=Q.find(".sp-input"),ot=Q.find(".sp-palette"),ut=Q.find(".sp-initial"),at=Q.find(".sp-cancel"),ft=Q.find(".sp-clear"),lt=Q.find(".sp-choose"),ct=Q.find(".sp-palette-toggle"),ht=J.is("input"),pt=ht&&J.attr("type")==="color"&&y(),dt=ht&&!v,vt=dt?e(o).addClass(E).addClass(p.className).addClass(p.replacerClassName):e([]),mt=dt?vt:J,gt=vt.find(".sp-preview-inner"),yt=p.color||ht&&J.val(),bt=!1,wt=p.preferredFormat,Et=wt,St=!p.showButtons||p.clickoutFiresChange,xt=!yt,Tt=p.allowEmpty&&!pt;Ct();var en={show:Bt,hide:It,toggle:Ht,reflow:Jt,option:Qt,enable:Gt,disable:Yt,offset:Zt,set:function(e){Rt(e),$t()},get:Ut,destroy:Kt,container:Q};return en.id=r.push(en)-1,en}function h(t,n){var r=0,i=t.outerWidth(),s=t.outerHeight(),o=n.outerHeight(),u=t[0].ownerDocument,a=u.documentElement,f=a.clientWidth+e(u).scrollLeft(),l=a.clientHeight+e(u).scrollTop(),c=n.offset();return c.top+=o,c.left-=Math.min(c.left,c.left+i>f&&f>i?Math.abs(c.left+i-f):0),c.top-=Math.min(c.top,c.top+s>l&&l>s?Math.abs(s+o-r):r),c}function p(){}function d(e){e.stopPropagation()}function v(e,t){var n=Array.prototype.slice,r=n.call(arguments,2);return function(){return e.apply(t,r.concat(n.call(arguments)))}}function m(t,n,r,s){function p(e){e.stopPropagation&&e.stopPropagation(),e.preventDefault&&e.preventDefault(),e.returnValue=!1}function d(e){if(u){if(i&&o.documentMode<9&&!e.button)return m();var r=e.originalEvent&&e.originalEvent.touches&&e.originalEvent.touches[0],s=r&&r.pageX||e.pageX,h=r&&r.pageY||e.pageY,d=Math.max(0,Math.min(s-a.left,l)),v=Math.max(0,Math.min(h-a.top,f));c&&p(e),n.apply(t,[d,v,e])}}function v(n){var i=n.which?n.which==3:n.button==2;!i&&!u&&r.apply(t,arguments)!==!1&&(u=!0,f=e(t).height(),l=e(t).width(),a=e(t).offset(),e(o).bind(h),e(o.body).addClass("sp-dragging"),d(n),p(n))}function m(){u&&(e(o).unbind(h),e(o.body).removeClass("sp-dragging"),setTimeout(function(){s.apply(t,arguments)},0)),u=!1}n=n||function(){},r=r||function(){},s=s||function(){};var o=document,u=!1,a={},f=0,l=0,c="ontouchstart"in window,h={};h.selectstart=p,h.dragstart=p,h["touchmove mousemove"]=d,h["touchend mouseup"]=m,e(t).bind("touchstart mousedown",v)}function g(e,t,n){var r;return function(){var i=this,s=arguments,o=function(){r=null,e.apply(i,s)};n&&clearTimeout(r);if(n||!r)r=setTimeout(o,t)}}function y(){return e.fn.spectrum.inputTypeColorSupport()}var n={beforeShow:p,move:p,change:p,show:p,hide:p,color:!1,flat:!1,showInput:!1,allowEmpty:!1,showButtons:!0,clickoutFiresChange:!0,showInitial:!1,showPalette:!1,showPaletteOnly:!1,hideAfterPaletteSelect:!1,togglePaletteOnly:!1,showSelectionPalette:!0,localStorageKey:!1,appendTo:"body",maxSelectionSize:7,cancelText:"cancel",chooseText:"choose",togglePaletteMoreText:"more",togglePaletteLessText:"less",clearText:"Clear Color Selection",noColorSelectedText:"No Color Selected",preferredFormat:"hsl",className:"",containerClassName:"",replacerClassName:"",showAlpha:!1,theme:"sp-light",palette:[["#ffffff","#000000","#ff0000","#ff8000","#ffff00","#008000","#0000ff","#4b0082","#9400d3"]],selectionPalette:[],disabled:!1,offset:null},r=[],i=!!/msie/i.exec(window.navigator.userAgent),s=function(){function e(e,t){return!!~(""+e).indexOf(t)}var t=document.createElement("div"),n=t.style;return n.cssText="background-color:rgba(0,0,0,.5)",e(n.backgroundColor,"rgba")||e(n.backgroundColor,"hsla")}(),o=["<div class='sp-replacer'>","<div class='sp-preview'><div class='sp-preview-inner'></div></div>","<div class='sp-dd'>&#9660;</div>","</div>"].join(""),u=function(){var e="";if(i)for(var t=1;t<=6;t++)e+="<div class='sp-"+t+"'></div>";return["<div class='sp-container sp-hidden'>","<div class='sp-palette-container'>","<div class='sp-palette sp-thumb sp-cf'></div>","<div class='sp-palette-button-container sp-cf'>","<button type='button' class='sp-palette-toggle'></button>","</div>","</div>","<div class='sp-picker-container'>","<div class='sp-top sp-cf'>","<div class='sp-fill'></div>","<div class='sp-top-inner'>","<div class='sp-color'>","<div class='sp-sat'>","<div class='sp-val'>","<div class='sp-dragger'></div>","</div>","</div>","</div>","<div class='sp-clear sp-clear-display'>","</div>","<div class='sp-hue'>","<div class='sp-slider'></div>",e,"</div>","</div>","<div class='sp-alpha'><div class='sp-alpha-inner'><div class='sp-alpha-handle'></div></div></div>","</div>","<div class='sp-input-container sp-cf'>","<input class='sp-input' type='text' spellcheck='false'  />","</div>","<div class='sp-initial sp-thumb sp-cf'></div>","<div class='sp-button-container sp-cf'>","<a class='sp-cancel' href='#'></a>","<button type='button' class='sp-choose'></button>","</div>","</div>","</div>"].join("")}(),b="spectrum.id";e.fn.spectrum=function(t,n){if(typeof t=="string"){var i=this,s=Array.prototype.slice.call(arguments,1);return this.each(function(){var n=r[e(this).data(b)];if(n){var o=n[t];if(!o)throw new Error("Spectrum: no such method: '"+t+"'");t=="get"?i=n.get():t=="container"?i=n.container:t=="option"?i=n.option.apply(n,s):t=="destroy"?(n.destroy(),e(this).removeData(b)):o.apply(n,s)}}),i}return this.spectrum("destroy").each(function(){var n=e.extend({},t,e(this).data()),r=c(this,n);e(this).data(b,r.id)})},e.fn.spectrum.load=!0,e.fn.spectrum.loadOpts={},e.fn.spectrum.draggable=m,e.fn.spectrum.defaults=n,e.fn.spectrum.inputTypeColorSupport=function w(){if(typeof w._cachedResult=="undefined"){var t=e("<input type='color'/>")[0];w._cachedResult=t.type==="color"&&t.value!==""}return w._cachedResult},e.spectrum={},e.spectrum.localization={},e.spectrum.palettes={},e.fn.spectrum.processNativeColorInputs=function(){var t=e("input[type=color]");t.length&&!y()&&t.spectrum({preferredFormat:"hex6"})},function(){function f(e){var t={r:0,g:0,b:0},n=1,r=!1,i=!1;return typeof e=="string"&&(e=W(e)),typeof e=="object"&&(e.hasOwnProperty("r")&&e.hasOwnProperty("g")&&e.hasOwnProperty("b")?(t=l(e.r,e.g,e.b),r=!0,i=String(e.r).substr(-1)==="%"?"prgb":"rgb"):e.hasOwnProperty("h")&&e.hasOwnProperty("s")&&e.hasOwnProperty("v")?(e.s=q(e.s),e.v=q(e.v),t=d(e.h,e.s,e.v),r=!0,i="hsv"):e.hasOwnProperty("h")&&e.hasOwnProperty("s")&&e.hasOwnProperty("l")&&(e.s=q(e.s),e.l=q(e.l),t=h(e.h,e.s,e.l),r=!0,i="hsl"),e.hasOwnProperty("a")&&(n=e.a)),n=D(n),{ok:r,format:e.format||i,r:s(255,o(t.r,0)),g:s(255,o(t.g,0)),b:s(255,o(t.b,0)),a:n}}function l(e,t,n){return{r:P(e,255)*255,g:P(t,255)*255,b:P(n,255)*255}}function c(e,t,n){e=P(e,255),t=P(t,255),n=P(n,255);var r=o(e,t,n),i=s(e,t,n),u,a,f=(r+i)/2;if(r==i)u=a=0;else{var l=r-i;a=f>.5?l/(2-r-i):l/(r+i);switch(r){case e:u=(t-n)/l+(t<n?6:0);break;case t:u=(n-e)/l+2;break;case n:u=(e-t)/l+4}u/=6}return{h:u,s:a,l:f}}function h(e,t,n){function o(e,t,n){return n<0&&(n+=1),n>1&&(n-=1),n<1/6?e+(t-e)*6*n:n<.5?t:n<2/3?e+(t-e)*(2/3-n)*6:e}var r,i,s;e=P(e,360),t=P(t,100),n=P(n,100);if(t===0)r=i=s=n;else{var u=n<.5?n*(1+t):n+t-n*t,a=2*n-u;r=o(a,u,e+1/3),i=o(a,u,e),s=o(a,u,e-1/3)}return{r:r*255,g:i*255,b:s*255}}function p(e,t,n){e=P(e,255),t=P(t,255),n=P(n,255);var r=o(e,t,n),i=s(e,t,n),u,a,f=r,l=r-i;a=r===0?0:l/r;if(r==i)u=0;else{switch(r){case e:u=(t-n)/l+(t<n?6:0);break;case t:u=(n-e)/l+2;break;case n:u=(e-t)/l+4}u/=6}return{h:u,s:a,v:f}}function d(e,t,n){e=P(e,360)*6,t=P(t,100),n=P(n,100);var i=r.floor(e),s=e-i,o=n*(1-t),u=n*(1-s*t),a=n*(1-(1-s)*t),f=i%6,l=[n,u,o,o,a,n][f],c=[a,n,n,u,o,o][f],h=[o,o,a,n,n,u][f];return{r:l*255,g:c*255,b:h*255}}function v(e,t,n,r){var s=[I(i(e).toString(16)),I(i(t).toString(16)),I(i(n).toString(16))];return r&&s[0].charAt(0)==s[0].charAt(1)&&s[1].charAt(0)==s[1].charAt(1)&&s[2].charAt(0)==s[2].charAt(1)?s[0].charAt(0)+s[1].charAt(0)+s[2].charAt(0):s.join("")}function m(e,t,n,r){var s=[I(R(r)),I(i(e).toString(16)),I(i(t).toString(16)),I(i(n).toString(16))];return s.join("")}function g(e,t){t=t===0?0:t||10;var n=a(e).toHsl();return n.s-=t/100,n.s=H(n.s),a(n)}function y(e,t){t=t===0?0:t||10;var n=a(e).toHsl();return n.s+=t/100,n.s=H(n.s),a(n)}function b(e){return a(e).desaturate(100)}function w(e,t){t=t===0?0:t||10;var n=a(e).toHsl();return n.l+=t/100,n.l=H(n.l),a(n)}function E(e,t){t=t===0?0:t||10;var n=a(e).toRgb();return n.r=o(0,s(255,n.r-i(255*-(t/100)))),n.g=o(0,s(255,n.g-i(255*-(t/100)))),n.b=o(0,s(255,n.b-i(255*-(t/100)))),a(n)}function S(e,t){t=t===0?0:t||10;var n=a(e).toHsl();return n.l-=t/100,n.l=H(n.l),a(n)}function x(e,t){var n=a(e).toHsl(),r=(i(n.h)+t)%360;return n.h=r<0?360+r:r,a(n)}function T(e){var t=a(e).toHsl();return t.h=(t.h+180)%360,a(t)}function N(e){var t=a(e).toHsl(),n=t.h;return[a(e),a({h:(n+120)%360,s:t.s,l:t.l}),a({h:(n+240)%360,s:t.s,l:t.l})]}function C(e){var t=a(e).toHsl(),n=t.h;return[a(e),a({h:(n+90)%360,s:t.s,l:t.l}),a({h:(n+180)%360,s:t.s,l:t.l}),a({h:(n+270)%360,s:t.s,l:t.l})]}function k(e){var t=a(e).toHsl(),n=t.h;return[a(e),a({h:(n+72)%360,s:t.s,l:t.l}),a({h:(n+216)%360,s:t.s,l:t.l})]}function L(e,t,n){t=t||6,n=n||30;var r=a(e).toHsl(),i=360/n,s=[a(e)];for(r.h=(r.h-(i*t>>1)+720)%360;--t;)r.h=(r.h+i)%360,s.push(a(r));return s}function A(e,t){t=t||6;var n=a(e).toHsv(),r=n.h,i=n.s,s=n.v,o=[],u=1/t;while(t--)o.push(a({h:r,s:i,v:s})),s=(s+u)%1;return o}function _(e){var t={};for(var n in e)e.hasOwnProperty(n)&&(t[e[n]]=n);return t}function D(e){e=parseFloat(e);if(isNaN(e)||e<0||e>1)e=1;return e}function P(e,t){j(e)&&(e="100%");var n=F(e);return e=s(t,o(0,parseFloat(e))),n&&(e=parseInt(e*t,10)/100),r.abs(e-t)<1e-6?1:e%t/parseFloat(t)}function H(e){return s(1,o(0,e))}function B(e){return parseInt(e,16)}function j(e){return typeof e=="string"&&e.indexOf(".")!=-1&&parseFloat(e)===1}function F(e){return typeof e=="string"&&e.indexOf("%")!=-1}function I(e){return e.length==1?"0"+e:""+e}function q(e){return e<=1&&(e=e*100+"%"),e}function R(e){return Math.round(parseFloat(e)*255).toString(16)}function U(e){return B(e)/255}function W(n){n=n.replace(e,"").replace(t,"").toLowerCase();var r=!1;if(O[n])n=O[n],r=!0;else if(n=="transparent")return{r:0,g:0,b:0,a:0,format:"name"};var i;return(i=z.rgb.exec(n))?{r:i[1],g:i[2],b:i[3]}:(i=z.rgba.exec(n))?{r:i[1],g:i[2],b:i[3],a:i[4]}:(i=z.hsl.exec(n))?{h:i[1],s:i[2],l:i[3]}:(i=z.hsla.exec(n))?{h:i[1],s:i[2],l:i[3],a:i[4]}:(i=z.hsv.exec(n))?{h:i[1],s:i[2],v:i[3]}:(i=z.hsva.exec(n))?{h:i[1],s:i[2],v:i[3],a:i[4]}:(i=z.hex8.exec(n))?{a:U(i[1]),r:B(i[2]),g:B(i[3]),b:B(i[4]),format:r?"name":"hex8"}:(i=z.hex6.exec(n))?{r:B(i[1]),g:B(i[2]),b:B(i[3]),format:r?"name":"hex"}:(i=z.hex3.exec(n))?{r:B(i[1]+""+i[1]),g:B(i[2]+""+i[2]),b:B(i[3]+""+i[3]),format:r?"name":"hex"}:!1}var e=/^[\s,#]+/,t=/\s+$/,n=0,r=Math,i=r.round,s=r.min,o=r.max,u=r.random,a=function(e,t){e=e?e:"",t=t||{};if(e instanceof a)return e;if(!(this instanceof a))return new a(e,t);var r=f(e);this._originalInput=e,this._r=r.r,this._g=r.g,this._b=r.b,this._a=r.a,this._roundA=i(100*this._a)/100,this._format=t.format||r.format,this._gradientType=t.gradientType,this._r<1&&(this._r=i(this._r)),this._g<1&&(this._g=i(this._g)),this._b<1&&(this._b=i(this._b)),this._ok=r.ok,this._tc_id=n++};a.prototype={isDark:function(){return this.getBrightness()<128},isLight:function(){return!this.isDark()},isValid:function(){return this._ok},getOriginalInput:function(){return this._originalInput},getFormat:function(){return this._format},getAlpha:function(){return this._a},getBrightness:function(){var e=this.toRgb();return(e.r*299+e.g*587+e.b*114)/1e3},setAlpha:function(e){return this._a=D(e),this._roundA=i(100*this._a)/100,this},toHsv:function(){var e=p(this._r,this._g,this._b);return{h:e.h*360,s:e.s,v:e.v,a:this._a}},toHsvString:function(){var e=p(this._r,this._g,this._b),t=i(e.h*360),n=i(e.s*100),r=i(e.v*100);return this._a==1?"hsv("+t+", "+n+"%, "+r+"%)":"hsva("+t+", "+n+"%, "+r+"%, "+this._roundA+")"},toHsl:function(){var e=c(this._r,this._g,this._b);return{h:e.h*360,s:e.s,l:e.l,a:this._a}},toHslString:function(){var e=c(this._r,this._g,this._b),t=i(e.h*360),n=i(e.s*100),r=i(e.l*100);return this._a==1?"hsl("+t+", "+n+"%, "+r+"%)":"hsla("+t+", "+n+"%, "+r+"%, "+this._roundA+")"},toHex:function(e){return v(this._r,this._g,this._b,e)},toHexString:function(e){return"#"+this.toHex(e)},toHex8:function(){return m(this._r,this._g,this._b,this._a)},toHex8String:function(){return"#"+this.toHex8()},toRgb:function(){return{r:i(this._r),g:i(this._g),b:i(this._b),a:this._a}},toRgbString:function(){return this._a==1?"rgb("+i(this._r)+", "+i(this._g)+", "+i(this._b)+")":"rgba("+i(this._r)+", "+i(this._g)+", "+i(this._b)+", "+this._roundA+")"},toPercentageRgb:function(){return{r:i(P(this._r,255)*100)+"%",g:i(P(this._g,255)*100)+"%",b:i(P(this._b,255)*100)+"%",a:this._a}},toPercentageRgbString:function(){return this._a==1?"rgb("+i(P(this._r,255)*100)+"%, "+i(P(this._g,255)*100)+"%, "+i(P(this._b,255)*100)+"%)":"rgba("+i(P(this._r,255)*100)+"%, "+i(P(this._g,255)*100)+"%, "+i(P(this._b,255)*100)+"%, "+this._roundA+")"},toName:function(){return this._a===0?"transparent":this._a<1?!1:M[v(this._r,this._g,this._b,!0)]||!1},toFilter:function(e){var t="#"+m(this._r,this._g,this._b,this._a),n=t,r=this._gradientType?"GradientType = 1, ":"";if(e){var i=a(e);n=i.toHex8String()}return"progid:DXImageTransform.Microsoft.gradient("+r+"startColorstr="+t+",endColorstr="+n+")"},toString:function(e){var t=!!e;e=e||this._format;var n=!1,r=this._a<1&&this._a>=0,i=!t&&r&&(e==="hex"||e==="hex6"||e==="hex3"||e==="name");if(i)return e==="name"&&this._a===0?this.toName():this.toRgbString();e==="rgb"&&(n=this.toRgbString()),e==="prgb"&&(n=this.toPercentageRgbString());if(e==="hex"||e==="hex6")n=this.toHexString();return e==="hex3"&&(n=this.toHexString(!0)),e==="hex8"&&(n=this.toHex8String()),e==="name"&&(n=this.toName()),e==="hsl"&&(n=this.toHslString()),e==="hsv"&&(n=this.toHsvString()),n||this.toHexString()},_applyModification:function(e,t){var n=e.apply(null,[this].concat([].slice.call(t)));return this._r=n._r,this._g=n._g,this._b=n._b,this.setAlpha(n._a),this},lighten:function(){return this._applyModification(w,arguments)},brighten:function(){return this._applyModification(E,arguments)},darken:function(){return this._applyModification(S,arguments)},desaturate:function(){return this._applyModification(g,arguments)},saturate:function(){return this._applyModification(y,arguments)},greyscale:function(){return this._applyModification(b,arguments)},spin:function(){return this._applyModification(x,arguments)},_applyCombination:function(e,t){return e.apply(null,[this].concat([].slice.call(t)))},analogous:function(){return this._applyCombination(L,arguments)},complement:function(){return this._applyCombination(T,arguments)},monochromatic:function(){return this._applyCombination(A,arguments)},splitcomplement:function(){return this._applyCombination(k,arguments)},triad:function(){return this._applyCombination(N,arguments)},tetrad:function(){return this._applyCombination(C,arguments)}},a.fromRatio=function(e,t){if(typeof e=="object"){var n={};for(var r in e)e.hasOwnProperty(r)&&(r==="a"?n[r]=e[r]:n[r]=q(e[r]));e=n}return a(e,t)},a.equals=function(e,t){return!e||!t?!1:a(e).toRgbString()==a(t).toRgbString()},a.random=function(){return a.fromRatio({r:u(),g:u(),b:u()})},a.mix=function(e,t,n){n=n===0?0:n||50;var r=a(e).toRgb(),i=a(t).toRgb(),s=n/100,o=s*2-1,u=i.a-r.a,f;o*u==-1?f=o:f=(o+u)/(1+o*u),f=(f+1)/2;var l=1-f,c={r:i.r*f+r.r*l,g:i.g*f+r.g*l,b:i.b*f+r.b*l,a:i.a*s+r.a*(1-s)};return a(c)},a.readability=function(e,t){var n=a(e),r=a(t),i=n.toRgb(),s=r.toRgb(),o=n.getBrightness(),u=r.getBrightness(),f=Math.max(i.r,s.r)-Math.min(i.r,s.r)+Math.max(i.g,s.g)-Math.min(i.g,s.g)+Math.max(i.b,s.b)-Math.min(i.b,s.b);return{brightness:Math.abs(o-u),color:f}},a.isReadable=function(e,t){var n=a.readability(e,t);return n.brightness>125&&n.color>500},a.mostReadable=function(e,t){var n=null,r=0,i=!1;for(var s=0;s<t.length;s++){var o=a.readability(e,t[s]),u=o.brightness>125&&o.color>500,f=3*(o.brightness/125)+o.color/500;if(u&&!i||u&&i&&f>r||!u&&!i&&f>r)i=u,r=f,n=a(t[s])}return n};var O=a.names={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"0ff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000",blanchedalmond:"ffebcd",blue:"00f",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",burntsienna:"ea7e5d",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"0ff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkgrey:"a9a9a9",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkslategrey:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dimgrey:"696969",dodgerblue:"1e90ff",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"f0f",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",grey:"808080",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgray:"d3d3d3",lightgreen:"90ee90",lightgrey:"d3d3d3",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslategray:"789",lightslategrey:"789",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"0f0",limegreen:"32cd32",linen:"faf0e6",magenta:"f0f",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370db",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"db7093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",rebeccapurple:"663399",red:"f00",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",slategrey:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",wheat:"f5deb3",white:"fff",whitesmoke:"f5f5f5",yellow:"ff0",yellowgreen:"9acd32"},M=a.hexNames=_(O),z=function(){var e="[-\\+]?\\d+%?",t="[-\\+]?\\d*\\.\\d+%?",n="(?:"+t+")|(?:"+e+")",r="[\\s|\\(]+("+n+")[,|\\s]+("+n+")[,|\\s]+("+n+")\\s*\\)?",i="[\\s|\\(]+("+n+")[,|\\s]+("+n+")[,|\\s]+("+n+")[,|\\s]+("+n+")\\s*\\)?";return{rgb:new RegExp("rgb"+r),rgba:new RegExp("rgba"+i),hsl:new RegExp("hsl"+r),hsla:new RegExp("hsla"+i),hsv:new RegExp("hsv"+r),hsva:new RegExp("hsva"+i),hex3:/^([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})$/,hex6:/^([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})$/,hex8:/^([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})$/}}();window.tinycolor=a}(),e(function(){e.fn.spectrum.load&&e.fn.spectrum.processNativeColorInputs()})});WebGLUtils=function(){var e=function(e){return'<table style="background-color: #8CE; width: 100%; height: 100%;"><tr><td align="center"><div style="display: table-cell; vertical-align: middle;"><div style="">'+e+"</div>"+"</div>"+"</td></tr></table>"},t='This page requires a browser that supports WebGL.<br/><a href="http://get.webgl.org">Click here to upgrade your browser.</a>',n='It doesn\'t appear your computer can support WebGL.<br/><a href="http://get.webgl.org/troubleshooting/">Click here for more information.</a>',r=function(r,s,o){function u(i){var s=r.parentNode;if(s){var o=window.WebGLRenderingContext?n:t;i&&(o+="<br/><br/>Status: "+i),s.innerHTML=e(o)}}o=o||u,r.addEventListener&&r.addEventListener("webglcontextcreationerror",function(e){o(e.statusMessage)},!1);var a=i(r,s);return a||window.WebGLRenderingContext||o(""),a},i=function(e,t){var n=["webgl","experimental-webgl","webkit-3d","moz-webgl"],r=null;for(var i=0;i<n.length;++i){try{r=e.getContext(n[i],t)}catch(s){}if(r)break}return r};return{create3DContext:i,setupWebGL:r}}(),window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e,t){window.setTimeout(e,1e3/60)}}();if(typeof Blob!="function"||typeof URL=="undefined")if(typeof Blob=="function"&&typeof webkitURL!="undefined")var URL=webkitURL;else var Blob=function(e){"use strict";var t=e.BlobBuilder||e.WebKitBlobBuilder||e.MozBlobBuilder||e.MSBlobBuilder||function(e){var t=function(e){return Object.prototype.toString.call(e).match(/^\[object\s(.*)\]$/)[1]},n=function(){this.data=[]},r=function(t,n,r){this.data=t,this.size=t.length,this.type=n,this.encoding=r},i=n.prototype,s=r.prototype,o=e.FileReaderSync,u=function(e){this.code=this[this.name=e]},a="NOT_FOUND_ERR SECURITY_ERR ABORT_ERR NOT_READABLE_ERR ENCODING_ERR NO_MODIFICATION_ALLOWED_ERR INVALID_STATE_ERR SYNTAX_ERR".split(" "),f=a.length,l=e.URL||e.webkitURL||e,c=l.createObjectURL,h=l.revokeObjectURL,p=l,d=e.btoa,v=e.atob,m=!1,g=function(e){m=!e},y=e.ArrayBuffer,b=e.Uint8Array;r.fake=s.fake=!0;while(f--)u.prototype[a[f]]=f+1;try{b&&g.apply(0,new b(1))}catch(w){}return l.createObjectURL||(p=e.URL={}),p.createObjectURL=function(e){var t=e.type,n;t===null&&(t="application/octet-stream");if(e instanceof r)return n="data:"+t,e.encoding==="base64"?n+";base64,"+e.data:e.encoding==="URI"?n+","+decodeURIComponent(e.data):d?n+";base64,"+d(e.data):n+","+encodeURIComponent(e.data);if(c)return c.call(l,e)},p.revokeObjectURL=function(e){e.substring(0,5)!=="data:"&&h&&h.call(l,e)},i.append=function(e){var n=this.data;if(b&&(e instanceof y||e instanceof b))if(m)n.push(String.fromCharCode.apply(String,new b(e)));else{var i="",s=new b(e),a=0,f=s.length;for(;a<f;a++)i+=String.fromCharCode(s[a])}else if(t(e)==="Blob"||t(e)==="File"){if(!o)throw new u("NOT_READABLE_ERR");var l=new o;n.push(l.readAsBinaryString(e))}else e instanceof r?e.encoding==="base64"&&v?n.push(v(e.data)):e.encoding==="URI"?n.push(decodeURIComponent(e.data)):e.encoding==="raw"&&n.push(e.data):(typeof e!="string"&&(e+=""),n.push(unescape(encodeURIComponent(e))))},i.getBlob=function(e){return arguments.length||(e=null),new r(this.data.join(""),e,"raw")},i.toString=function(){return"[object BlobBuilder]"},s.slice=function(e,t,n){var i=arguments.length;return i<3&&(n=null),new r(this.data.slice(e,i>1?t:this.data.length),n,this.encoding)},s.toString=function(){return"[object Blob]"},n}(e);return function(n,r){var i=r?r.type||"":"",s=new t;if(n)for(var o=0,u=n.length;o<u;o++)s.append(n[o]);return s.getBlob(i)}}(self);(function(e){"use strict";var t=e.Uint8Array,n=e.HTMLCanvasElement,r=/\s*;\s*base64\s*(?:;|$)/i,i,s=function(e){var n=e.length,r=new t(n/4*3|0),s=0,o=0,u=[0,0],a=0,f=0,l,c,h;while(n--)c=e.charCodeAt(s++),l=i[c-43],l!==255&&l!==h&&(u[1]=u[0],u[0]=c,f=f<<6|l,a++,a===4&&(r[o++]=f>>>16,u[1]!==61&&(r[o++]=f>>>8),u[0]!==61&&(r[o++]=f),a=0));return r.buffer};t&&(i=new t([62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,0,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51])),n&&!n.prototype.toBlob&&(n.prototype.toBlob=function(e,n){n||(n="image/png");if(this.mozGetAsFile){e(this.mozGetAsFile("canvas",n));return}var i=Array.prototype.slice.call(arguments,1),o=this.toDataURL.apply(this,i),u=o.indexOf(","),a=o.substring(u+1),f=r.test(o.substring(0,u)),l;Blob.fake?(l=new Blob,f?l.encoding="base64":l.encoding="URI",l.data=a,l.size=a.length):t&&(f?l=new Blob([s(a)],{type:n}):l=new Blob([decodeURIComponent(a)],{type:n})),e(l)})})(self);var saveAs=saveAs||navigator.msSaveBlob&&navigator.msSaveBlob.bind(navigator)||function(e){"use strict";var t=e.document,n=function(){return e.URL||e.webkitURL||e},r=e.URL||e.webkitURL||e,i=t.createElementNS("http://www.w3.org/1999/xhtml","a"),s="download"in i,o=function(n){var r=t.createEvent("MouseEvents");r.initMouseEvent("click",!0,!1,e,0,0,0,0,0,!1,!1,!1,!1,0,null),n.dispatchEvent(r)},u=e.webkitRequestFileSystem,a=e.requestFileSystem||u||e.mozRequestFileSystem,f=function(t){(e.setImmediate||e.setTimeout)(function(){throw t},0)},l="application/octet-stream",c=0,h=[],p=function(){var e=h.length;while(e--){var t=h[e];typeof t=="string"?r.revokeObjectURL(t):t.remove()}h.length=0},d=function(e,t,n){t=[].concat(t);var r=t.length;while(r--){var i=e["on"+t[r]];if(typeof i=="function")try{i.call(e,n||e)}catch(s){f(s)}}},v=function(t,r){var f=this,p=t.type,v=!1,m,g,y=function(){var e=n().createObjectURL(t);return h.push(e),e},b=function(){d(f,"writestart progress write writeend".split(" "))},w=function(){if(v||!m)m=y(t);g&&(g.location.href=m),f.readyState=f.DONE,b()},E=function(e){return function(){if(f.readyState!==f.DONE)return e.apply(this,arguments)}},S={create:!0,exclusive:!1},x;f.readyState=f.INIT,r||(r="download");if(s){m=y(t),i.href=m,i.download=r,o(i),f.readyState=f.DONE,b();return}e.chrome&&p&&p!==l&&(x=t.slice||t.webkitSlice,t=x.call(t,0,t.size,l),v=!0),u&&r!=="download"&&(r+=".download"),p===l||u?g=e:g=e.open();if(!a){w();return}c+=t.size,a(e.TEMPORARY,c,E(function(e){e.root.getDirectory("saved",S,E(function(e){var n=function(){e.getFile(r,S,E(function(e){e.createWriter(E(function(n){n.onwriteend=function(t){g.location.href=e.toURL(),h.push(e),f.readyState=f.DONE,d(f,"writeend",t)},n.onerror=function(){var e=n.error;e.code!==e.ABORT_ERR&&w()},"writestart progress write abort".split(" ").forEach(function(e){n["on"+e]=f["on"+e]}),n.write(t),f.abort=function(){n.abort(),f.readyState=f.DONE},f.readyState=f.WRITING}),w)}),w)};e.getFile(r,{create:!1},E(function(e){e.remove(),n()}),E(function(e){e.code===e.NOT_FOUND_ERR?n():w()}))}),w)}),w)},m=v.prototype,g=function(e,t){return new v(e,t)};return m.abort=function(){var e=this;e.readyState=e.DONE,d(e,"abort")},m.readyState=m.INIT=0,m.WRITING=1,m.DONE=2,m.error=m.onwritestart=m.onprogress=m.onwrite=m.onabort=m.onerror=m.onwriteend=null,e.addEventListener("unload",p,!1),g}(self);var bson=function(){function u(){return s()}function a(){return f(Array.prototype.join.call(arguments,"/"))}function f(e){var t=[],n=e.split("/"),r,i,s=0,o=n.length-1;for(;s<=o;s++){r=n[s];if(r==="."&&i!==undefined)continue;r===".."&&t.length&&i!==".."&&i!=="."&&i!==undefined?(t.pop(),i=t.slice(-1)[0]):(i==="."&&t.pop(),t.push(r),i=r)}return t.join("/")}function l(e){return e&&e.substr(0,e.lastIndexOf("/"))||"."}function c(e,t){var n=a(l(e.id),/\.\/$/.test(t)?t+"index":t).replace(/\.js$/,""),r=a(n,"index"),i=e.pkg,s,o=i.modules.length,u;while(o-->0){u=i.modules[o].id;if(u==n||u==r){s=i.modules[o];break}}return s}function h(t){function r(s){var o,u;if(/^\./.test(s))o=c(t,s);else{if(i&&i.hasOwnProperty(s))return i[s];if(aliases&&aliases.hasOwnProperty(s))return r(aliases[s]);u=e[s];if(!u&&n){try{u=n(s)}catch(a){}if(u)return u}if(!u)throw new Error('Cannot find module "'+s+'" @[module: '+t.id+" package: "+t.pkg.name+"]");o=u.index}if(!o)throw new Error('Cannot find module "'+s+'" @[module: '+t.id+" package: "+t.pkg.name+"]");return o.parent=t,o.call()}return r}function p(e,n,r){var i={pkg:e,id:n,wrapper:r},o=!1;i.exports={},i.require=h(i),i.call=function(){return o?i.exports:(o=!0,t.require=i.require,i.wrapper(i,i.exports,t,t.require),i.exports)},e.mainModuleId==i.id&&(e.index=i,e.parents.length===0&&(s=i.call)),e.modules.push(i)}function d(){var t=arguments[arguments.length-1],n=Array.prototype.slice.call(arguments,0,arguments.length-1),r=t(n);return e[r.name]=r,arguments.length==1&&(e.main=r),function(e){var t;for(t in e)p(r,t,e[t])}}var e={},t={},n=typeof require!="undefined"&&require,r,i,s,o;return u.main=u,u.module=p,u.packages=e,u.pkg=d,u.require=function(n){return e.main.index.require(n)},i={},aliases={},u}(this);bson.pkg(function(e){return{name:"bson",mainModuleId:"bson",modules:[],parents:e}})({binary:function(e,t,n,r,i){function f(e,t){if(!(this instanceof f))return new f(e,t);this._bsontype="Binary",e instanceof Number?(this.sub_type=e,this.position=0):(this.sub_type=t==null?o:t,this.position=0);if(e==null||e instanceof Number)typeof s!="undefined"?this.buffer=new s(f.BUFFER_SIZE):typeof Uint8Array!="undefined"?this.buffer=new Uint8Array(new ArrayBuffer(f.BUFFER_SIZE)):this.buffer=new Array(f.BUFFER_SIZE),this.position=0;else{if(typeof e=="string")if(typeof s!="undefined")this.buffer=new s(e);else{if(typeof Uint8Array=="undefined"&&Object.prototype.toString.call(e)!="[object Array]")throw new Error("only String, Buffer, Uint8Array or Array accepted");this.buffer=u(e)}else this.buffer=e;this.position=e.length}}if(typeof window=="undefined")var s=r("buffer").Buffer;var o=0,u=function(e){var t=typeof Uint8Array!="undefined"?new Uint8Array(new ArrayBuffer(e.length)):new Array(e.length);for(var n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t},a=function(e,t,n){var r="";for(var i=t;i<n;i++)r+=String.fromCharCode(e[i]);return r};f.prototype.put=function(t){if(t["length"]!=null&&typeof t!="number"&&t.length!=1)throw new Error("only accepts single character String, Uint8Array or Array");if(typeof t!="number"&&t<0||t>255)throw new Error("only accepts number in a valid unsigned byte range 0-255");var n=null;typeof t=="string"?n=t.charCodeAt(0):t["length"]!=null?n=t[0]:n=t;if(this.buffer.length>this.position)this.buffer[this.position++]=n;else if(typeof s!="undefined"&&s.isBuffer(this.buffer)){var r=new s(f.BUFFER_SIZE+this.buffer.length);this.buffer.copy(r,0,0,this.buffer.length),this.buffer=r,this.buffer[this.position++]=n}else{var r=null;Object.prototype.toString.call(this.buffer)=="[object Uint8Array]"?r=new Uint8Array(new ArrayBuffer(f.BUFFER_SIZE+this.buffer.length)):r=new Array(f.BUFFER_SIZE+this.buffer.length);for(var i=0;i<this.buffer.length;i++)r[i]=this.buffer[i];this.buffer=r,this.buffer[this.position++]=n}},f.prototype.write=function(t,n){n=typeof n=="number"?n:this.position;if(this.buffer.length<n+t.length){var r=null;if(typeof s!="undefined"&&s.isBuffer(this.buffer))r=new s(this.buffer.length+t.length),this.buffer.copy(r,0,0,this.buffer.length);else if(Object.prototype.toString.call(this.buffer)=="[object Uint8Array]"){r=new Uint8Array(new ArrayBuffer(this.buffer.length+t.length));for(var i=0;i<this.position;i++)r[i]=this.buffer[i]}this.buffer=r}if(typeof s!="undefined"&&s.isBuffer(t)&&s.isBuffer(this.buffer))t.copy(this.buffer,n,0,t.length),this.position=n+t.length>this.position?n+t.length:this.position;else if(typeof s!="undefined"&&typeof t=="string"&&s.isBuffer(this.buffer))this.buffer.write(t,"binary",n),this.position=n+t.length>this.position?n+t.length:this.position;else if(Object.prototype.toString.call(t)=="[object Uint8Array]"||Object.prototype.toString.call(t)=="[object Array]"&&typeof t!="string"){for(var i=0;i<t.length;i++)this.buffer[n++]=t[i];this.position=n>this.position?n:this.position}else if(typeof t=="string"){for(var i=0;i<t.length;i++)this.buffer[n++]=t.charCodeAt(i);this.position=n>this.position?n:this.position}},f.prototype.read=function(t,n){n=n&&n>0?n:this.position;if(this.buffer.slice)return this.buffer.slice(t,t+n);var r=typeof Uint8Array!="undefined"?new Uint8Array(new ArrayBuffer(n)):new Array(n);for(var i=0;i<n;i++)r[i]=this.buffer[t++];return r},f.prototype.value=function(t){t=t==null?!1:t;if(typeof s!="undefined"&&s.isBuffer(this.buffer))return t?this.buffer.slice(0,this.position):this.buffer.toString("binary",0,this.position);if(t){if(this.buffer["slice"]!=null)return this.buffer.slice(0,this.position);var n=Object.prototype.toString.call(this.buffer)=="[object Uint8Array]"?new Uint8Array(new ArrayBuffer(this.position)):new Array(this.position);for(var r=0;r<this.position;r++)n[r]=this.buffer[r];return n}return a(this.buffer,0,this.position)},f.prototype.length=function(){return this.position},f.prototype.toJSON=function(){return this.buffer!=null?this.buffer.toString("base64"):""},f.prototype.toString=function(e){return this.buffer!=null?this.buffer.slice(0,this.position).toString(e):""},f.BUFFER_SIZE=256,f.SUBTYPE_DEFAULT=0,f.SUBTYPE_FUNCTION=1,f.SUBTYPE_BYTE_ARRAY=2,f.SUBTYPE_UUID_OLD=3,f.SUBTYPE_UUID=4,f.SUBTYPE_MD5=5,f.SUBTYPE_USER_DEFINED=128,t.Binary=f},binary_parser:function(e,t,n,i,s){function f(e,t){if(!(this instanceof f))return new f(e,t);this.bigEndian=e,this.allowExceptions=t}function l(e,t){this.bigEndian=e||0,this.buffer=[],this.setBuffer(t)}var o=String.fromCharCode,u=[];for(var a=0;a<64;a++)u[a]=Math.pow(2,a);f.warn=function(t){if(this.allowExceptions)throw new Error(t);return 1},f.decodeFloat=function(t,n,r){var i=new this.Buffer(this.bigEndian,t);i.checkBuffer(n+r+1);var s=u[r-1]-1,o=i.readBits(n+r,1),a=i.readBits(n,r),f=0,l=2,c=i.buffer.length+(-n>>3)-1;do for(var h=i.buffer[++c],p=n%8||8,d=1<<p;d>>=1;h&d&&(f+=1/l),l*=2);while(n-=p);return a==(s<<1)+1?f?NaN:o?-Infinity:+Infinity:(1+o*-2)*(a||f?a?Math.pow(2,a-s)*(1+f):Math.pow(2,-s+1)*f:0)},f.decodeInt=function(t,n,r,i){var s=new this.Buffer(this.bigEndian||i,t),o=s.readBits(0,n),a=u[n];return r&&o>=a/2?o-a:o},f.encodeFloat=function(t,n,i){var s=u[i-1]-1,o=-s+1,a=s,f=o-n,l=parseFloat(t),c=isNaN(l)||l==-Infinity||l==+Infinity?l:0,h=0,p=2*s+1+n+3,d=new Array(p),v=(l=c!==0?0:l)<0,m=Math.floor(l=Math.abs(l)),g=l-m,y,b,w,E,S;for(E=p;E;d[--E]=0);for(E=s+2;m&&E;d[--E]=m%2,m=Math.floor(m/2));for(E=s+1;g>0&&E;(d[++E]=((g*=2)>=1)-0)&&--g);for(E=-1;++E<p&&!d[E];);if(d[(y=n-1+(E=(h=s+1-E)>=o&&h<=a?E+1:s+1-(h=o-1)))+1]){if(!(b=d[y]))for(S=y+2;!b&&S<p;b=d[S++]);for(S=y+1;b&&--S>=0;(d[S]=!d[S]-0)&&(b=0));}for(E=E-2<0?-1:E-3;++E<p&&!d[E];);(h=s+1-E)>=o&&h<=a?++E:h<o&&(h!=s+1-p&&h<f&&this.warn("encodeFloat::float underflow"),E=s+1-(h=o-1));if(m||c!==0)this.warn(m?"encodeFloat::float overflow":"encodeFloat::"+c),h=a+1,E=s+2,c==-Infinity?v=1:isNaN(c)&&(d[E]=1);for(l=Math.abs(h+s),S=i+1,w="";--S;w=l%2+w,l=l>>=1);for(l=0,S=0,E=(w=(v?"1":"0")+w+d.slice(E,E+n).join("")).length,r=[];E;S=(S+1)%8)l+=(1<<S)*w.charAt(--E),S==7&&(r[r.length]=String.fromCharCode(l),l=0);return r[r.length]=l?String.fromCharCode(l):"",(this.bigEndian?r.reverse():r).join("")},f.encodeInt=function(t,n,r,i){var s=u[n];if(t>=s||t<-(s/2))this.warn("encodeInt::overflow"),t=0;t<0&&(t+=s);for(var o=[];t;o[o.length]=String.fromCharCode(t%256),t=Math.floor(t/256));for(n=-(-n>>3)-o.length;n--;o[o.length]="\0");return(this.bigEndian||i?o.reverse():o).join("")},f.toSmall=function(e){return this.decodeInt(e,8,!0)},f.fromSmall=function(e){return this.encodeInt(e,8,!0)},f.toByte=function(e){return this.decodeInt(e,8,!1)},f.fromByte=function(e){return this.encodeInt(e,8,!1)},f.toShort=function(e){return this.decodeInt(e,16,!0)},f.fromShort=function(e){return this.encodeInt(e,16,!0)},f.toWord=function(e){return this.decodeInt(e,16,!1)},f.fromWord=function(e){return this.encodeInt(e,16,!1)},f.toInt=function(e){return this.decodeInt(e,32,!0)},f.fromInt=function(e){return this.encodeInt(e,32,!0)},f.toLong=function(e){return this.decodeInt(e,64,!0)},f.fromLong=function(e){return this.encodeInt(e,64,!0)},f.toDWord=function(e){return this.decodeInt(e,32,!1)},f.fromDWord=function(e){return this.encodeInt(e,32,!1)},f.toQWord=function(e){return this.decodeInt(e,64,!0)},f.fromQWord=function(e){return this.encodeInt(e,64,!0)},f.toFloat=function(e){return this.decodeFloat(e,23,8)},f.fromFloat=function(e){return this.encodeFloat(e,23,8)},f.toDouble=function(e){return this.decodeFloat(e,52,11)},f.fromDouble=function(e){return this.encodeFloat(e,52,11)},f.encode_int32=function(t,n){var r,i,s,u,a;return a=t<0?t+4294967296:t,r=Math.floor(a/16777215),a&=16777215,i=Math.floor(a/65535),a&=65535,s=Math.floor(a/255),a&=255,u=Math.floor(a),n?[o(r),o(i),o(s),o(u)]:o(r)+o(i)+o(s)+o(u)},f.encode_int64=function(t){var n,r,i,s,u,a,f,l,c;return c=t<0?t+0x10000000000000000:t,n=Math.floor(c/72057594037927940),c&=72057594037927940,r=Math.floor(c/0xffffffffffff),c&=0xffffffffffff,i=Math.floor(c/0xffffffffff),c&=0xffffffffff,s=Math.floor(c/4294967295),c&=4294967295,u=Math.floor(c/16777215),c&=16777215,a=Math.floor(c/65535),c&=65535,f=Math.floor(c/255),c&=255,l=Math.floor(c),o(n)+o(r)+o(i)+o(s)+o(u)+o(a)+o(f)+o(l)},f.decode_utf8=function(t){var n=t.length,r="",i=0,s=0,o=0,u=0,a;while(i<n)s=t.charCodeAt(i),s<128?(r+=String.fromCharCode(s),i++):s>191&&s<224?(u=t.charCodeAt(i+1),r+=String.fromCharCode((s&31)<<6|u&63),i+=2):(u=t.charCodeAt(i+1),a=t.charCodeAt(i+2),r+=String.fromCharCode((s&15)<<12|(u&63)<<6|a&63),i+=3);return r},f.encode_cstring=function(t){return unescape(encodeURIComponent(t))+f.fromByte(0)},f.encode_utf8=function(t){var n="",r;for(var i=0,s=t.length;i<s;i++)r=t.charCodeAt(i),r<128?n+=String.fromCharCode(r):r>127&&r<2048?(n+=String.fromCharCode(r>>6|192),n+=String.fromCharCode(r&63|128)):(n+=String.fromCharCode(r>>12|224),n+=String.fromCharCode(r>>6&63|128),n+=String.fromCharCode(r&63|128));return n},f.hprint=function(t){var n;for(var r=0,i=t.length;r<i;r++)t.charCodeAt(r)<32?(n=t.charCodeAt(r)<=15?"0"+t.charCodeAt(r).toString(16):t.charCodeAt(r).toString(16),process.stdout.write(n+" ")):(n=t.charCodeAt(r)<=15?"0"+t.charCodeAt(r).toString(16):t.charCodeAt(r).toString(16),process.stdout.write(n+" "));process.stdout.write("\n\n")},f.ilprint=function(t){var n;for(var r=0,s=t.length;r<s;r++)t.charCodeAt(r)<32?(n=t.charCodeAt(r)<=15?"0"+t.charCodeAt(r).toString(10):t.charCodeAt(r).toString(10),i("util").debug(n+" : ")):(n=t.charCodeAt(r)<=15?"0"+t.charCodeAt(r).toString(10):t.charCodeAt(r).toString(10),i("util").debug(n+" : "+t.charAt(r)))},f.hlprint=function(t){var n;for(var r=0,s=t.length;r<s;r++)t.charCodeAt(r)<32?(n=t.charCodeAt(r)<=15?"0"+t.charCodeAt(r).toString(16):t.charCodeAt(r).toString(16),i("util").debug(n+" : ")):(n=t.charCodeAt(r)<=15?"0"+t.charCodeAt(r).toString(16):t.charCodeAt(r).toString(16),i("util").debug(n+" : "+t.charAt(r)))},l.prototype.setBuffer=function(t){var n,r,i;if(t){r=n=t.length,i=this.buffer=new Array(n);for(;r;i[n-r]=t.charCodeAt(--r));this.bigEndian&&i.reverse()}},l.prototype.hasNeededBits=function(t){return this.buffer.length>=-(-t>>3)},l.prototype.checkBuffer=function(t){if(!this.hasNeededBits(t))throw new Error("checkBuffer::missing bytes")},l.prototype.readBits=function(t,n){function r(e,t){for(;t--;e=((e%=2147483647+1)&1073741824)==1073741824?e*2:(e-1073741824)*2+2147483647+1);return e}if(t<0||n<=0)return 0;this.checkBuffer(t+n);var i,s=t%8,o=this.buffer.length-(t>>3)-1,u=this.buffer.length+(-(t+n)>>3),a=o-u,f=(this.buffer[o]>>s&(1<<(a?8-s:n))-1)+(a&&(i=(t+n)%8)?(this.buffer[u++]&(1<<i)-1)<<(a--<<3)-s:0);for(;a;f+=r(this.buffer[u++],(a--<<3)-s));return f},f.Buffer=l,t.BinaryParser=f},bson:function(module,exports,global,require,undefined){function BSON(){}function calculateElement(e,t,n){var r=typeof Buffer!="undefined";switch(typeof t){case"string":return 1+(r?Buffer.byteLength(e,"utf8"):numberOfBytes(e))+1+4+(r?Buffer.byteLength(t,"utf8"):numberOfBytes(t))+1;case"number":return Math.floor(t)===t&&t>=BSON.JS_INT_MIN&&t<=BSON.JS_INT_MAX?t>=BSON.BSON_INT32_MIN&&t<=BSON.BSON_INT32_MAX?(e!=null?(r?Buffer.byteLength(e,"utf8"):numberOfBytes(e))+1:0)+5:(e!=null?(r?Buffer.byteLength(e,"utf8"):numberOfBytes(e))+1:0)+9:(e!=null?(r?Buffer.byteLength(e,"utf8"):numberOfBytes(e))+1:0)+9;case"undefined":return(e!=null?(r?Buffer.byteLength(e,"utf8"):numberOfBytes(e))+1:0)+1;case"boolean":return(e!=null?(r?Buffer.byteLength(e,"utf8"):numberOfBytes(e))+1:0)+2;case"object":if(t==null||t instanceof MinKey||t instanceof MaxKey||t["_bsontype"]=="MinKey"||t["_bsontype"]=="MaxKey")return(e!=null?(r?Buffer.byteLength(e,"utf8"):numberOfBytes(e))+1:0)+1;if(t instanceof ObjectID||t["_bsontype"]=="ObjectID")return(e!=null?(r?Buffer.byteLength(e,"utf8"):numberOfBytes(e))+1:0)+13;if(t instanceof Date||isDate(t))return(e!=null?(r?Buffer.byteLength(e,"utf8"):numberOfBytes(e))+1:0)+9;if(typeof Buffer!="undefined"&&Buffer.isBuffer(t))return(e!=null?(r?Buffer.byteLength(e,"utf8"):numberOfBytes(e))+1:0)+6+t.length;if(t instanceof Long||t instanceof Double||t instanceof Timestamp||t["_bsontype"]=="Long"||t["_bsontype"]=="Double"||t["_bsontype"]=="Timestamp")return(e!=null?(r?Buffer.byteLength(e,"utf8"):numberOfBytes(e))+1:0)+9;if(t instanceof Code||t["_bsontype"]=="Code")return t.scope!=null&&Object.keys(t.scope).length>0?(e!=null?(r?Buffer.byteLength(e,"utf8"):numberOfBytes(e))+1:0)+1+4+4+(r?Buffer.byteLength(t.code.toString(),"utf8"):numberOfBytes(t.code.toString()))+1+BSON.calculateObjectSize(t.scope,n):(e!=null?(r?Buffer.byteLength(e,"utf8"):numberOfBytes(e))+1:0)+1+4+(r?Buffer.byteLength(t.code.toString(),"utf8"):numberOfBytes(t.code.toString()))+1;if(t instanceof Binary||t["_bsontype"]=="Binary")return t.sub_type==Binary.SUBTYPE_BYTE_ARRAY?(e!=null?(r?Buffer.byteLength(e,"utf8"):numberOfBytes(e))+1:0)+(t.position+1+4+1+4):(e!=null?(r?Buffer.byteLength(e,"utf8"):numberOfBytes(e))+1:0)+(t.position+1+4+1);if(t instanceof Symbol||t["_bsontype"]=="Symbol")return(e!=null?(r?Buffer.byteLength(e,"utf8"):numberOfBytes(e))+1:0)+((r?Buffer.byteLength(t.value,"utf8"):numberOfBytes(t.value))+4+1+1);if(t instanceof DBRef||t["_bsontype"]=="DBRef"){var i={$ref:t.namespace,$id:t.oid};return null!=t.db&&(i.$db=t.db),(e!=null?(r?Buffer.byteLength(e,"utf8"):numberOfBytes(e))+1:0)+1+BSON.calculateObjectSize(i,n)}return t instanceof RegExp||Object.prototype.toString.call(t)==="[object RegExp]"?(e!=null?(r?Buffer.byteLength(e,"utf8"):numberOfBytes(e))+1:0)+1+(r?Buffer.byteLength(t.source,"utf8"):numberOfBytes(t.source))+1+(t.global?1:0)+(t.ignoreCase?1:0)+(t.multiline?1:0)+1:(e!=null?(r?Buffer.byteLength(e,"utf8"):numberOfBytes(e))+1:0)+BSON.calculateObjectSize(t,n)+1;case"function":if(t instanceof RegExp||Object.prototype.toString.call(t)==="[object RegExp]"||String.call(t)=="[object RegExp]")return(e!=null?(r?Buffer.byteLength(e,"utf8"):numberOfBytes(e))+1:0)+1+(r?Buffer.byteLength(t.source,"utf8"):numberOfBytes(t.source))+1+(t.global?1:0)+(t.ignoreCase?1:0)+(t.multiline?1:0)+1;if(n&&t.scope!=null&&Object.keys(t.scope).length>0)return(e!=null?(r?Buffer.byteLength(e,"utf8"):numberOfBytes(e))+1:0)+1+4+4+(r?Buffer.byteLength(t.toString(),"utf8"):numberOfBytes(t.toString()))+1+BSON.calculateObjectSize(t.scope,n);if(n)return(e!=null?(r?Buffer.byteLength(e,"utf8"):numberOfBytes(e))+1:0)+1+4+(r?Buffer.byteLength(t.toString(),"utf8"):numberOfBytes(t.toString()))+1}return 0}var Long=require("./long").Long,Double=require("./double").Double,Timestamp=require("./timestamp").Timestamp,ObjectID=require("./objectid").ObjectID,Symbol=require("./symbol").Symbol,Code=require("./code").Code,MinKey=require("./min_key").MinKey,MaxKey=require("./max_key").MaxKey,DBRef=require("./db_ref").DBRef,Binary=require("./binary").Binary,BinaryParser=require("./binary_parser").BinaryParser,writeIEEE754=require("./float_parser").writeIEEE754,readIEEE754=require("./float_parser").readIEEE754,isDate=function(t){return typeof t=="object"&&Object.prototype.toString.call(t)==="[object Date]"};BSON.BSON_INT32_MAX=2147483647,BSON.BSON_INT32_MIN=-2147483648,BSON.BSON_INT64_MAX=Math.pow(2,63)-1,BSON.BSON_INT64_MIN=-Math.pow(2,63),BSON.JS_INT_MAX=9007199254740992,BSON.JS_INT_MIN=-9007199254740992;var JS_INT_MAX_LONG=Long.fromNumber(9007199254740992),JS_INT_MIN_LONG=Long.fromNumber(-9007199254740992);BSON.BSON_DATA_NUMBER=1,BSON.BSON_DATA_STRING=2,BSON.BSON_DATA_OBJECT=3,BSON.BSON_DATA_ARRAY=4,BSON.BSON_DATA_BINARY=5,BSON.BSON_DATA_OID=7,BSON.BSON_DATA_BOOLEAN=8,BSON.BSON_DATA_DATE=9,BSON.BSON_DATA_NULL=10,BSON.BSON_DATA_REGEXP=11,BSON.BSON_DATA_CODE=13,BSON.BSON_DATA_SYMBOL=14,BSON.BSON_DATA_CODE_W_SCOPE=15,BSON.BSON_DATA_INT=16,BSON.BSON_DATA_TIMESTAMP=17,BSON.BSON_DATA_LONG=18,BSON.BSON_DATA_MIN_KEY=255,BSON.BSON_DATA_MAX_KEY=127,BSON.BSON_BINARY_SUBTYPE_DEFAULT=0,BSON.BSON_BINARY_SUBTYPE_FUNCTION=1,BSON.BSON_BINARY_SUBTYPE_BYTE_ARRAY=2,BSON.BSON_BINARY_SUBTYPE_UUID=3,BSON.BSON_BINARY_SUBTYPE_MD5=4,BSON.BSON_BINARY_SUBTYPE_USER_DEFINED=128,BSON.calculateObjectSize=function(t,n){var r=5;if(Array.isArray(t))for(var i=0;i<t.length;i++)r+=calculateElement(i.toString(),t[i],n);else{t.toBSON&&(t=t.toBSON());for(var s in t)r+=calculateElement(s,t[s],n)}return r},BSON.serializeWithBufferAndIndex=function(t,n,r,i,s){s=s==null?!1:s;var o=r.length;return r[i++]=o&255,r[i++]=o>>8&255,r[i++]=o>>16&255,r[i++]=o>>24&255,serializeObject(t,n,r,i,s)-1};var serializeObject=function(e,t,n,r,i){if(Array.isArray(e))for(var s=0;s<e.length;s++)r=packElement(s.toString(),e[s],t,n,r,i);else{e.toBSON&&(e=e.toBSON());for(var o in e)o!="$db"&&o!="$ref"&&o!="$id"&&BSON.checkKey(o,!t),r=packElement(o,e[o],t,n,r,i)}return n[r++]=0,r},stringToBytes=function(e){var t,n,r=[];for(var i=0;i<e.length;i++){t=e.charCodeAt(i),n=[];do n.push(t&255),t>>=8;while(t);r=r.concat(n.reverse())}return r},numberOfBytes=function(e){var t,n,r=0;for(var i=0;i<e.length;i++){t=e.charCodeAt(i),n=[];do n.push(t&255),t>>=8;while(t);r+=n.length}return r},writeToTypedArray=function(e,t,n){var r=stringToBytes(t);for(var i=0;i<r.length;i++)e[n+i]=r[i];return r.length},supportsBuffer=typeof Buffer!="undefined",packElement=function(e,t,n,r,i,s){var o=i;switch(typeof t){case"string":r[i++]=BSON.BSON_DATA_STRING;var u=supportsBuffer?r.write(e,i,"utf8"):writeToTypedArray(r,e,i);i=i+u+1,r[i-1]=0;var a=supportsBuffer?Buffer.byteLength(t)+1:numberOfBytes(t)+1;return r[i+3]=a>>24&255,r[i+2]=a>>16&255,r[i+1]=a>>8&255,r[i]=a&255,i+=4,supportsBuffer?r.write(t,i,"utf8"):writeToTypedArray(r,t,i),i=i+a-1,r[i++]=0,i;case"number":if(Math.floor(t)===t&&t>=BSON.JS_INT_MIN&&t<=BSON.JS_INT_MAX)if(t>=BSON.BSON_INT32_MIN&&t<=BSON.BSON_INT32_MAX){r[i++]=BSON.BSON_DATA_INT;var u=supportsBuffer?r.write(e,i,"utf8"):writeToTypedArray(r,e,i);i=i+u+1,r[i-1]=0,r[i++]=t&255,r[i++]=t>>8&255,r[i++]=t>>16&255,r[i++]=t>>24&255}else if(t>=BSON.JS_INT_MIN&&t<=BSON.JS_INT_MAX){r[i++]=BSON.BSON_DATA_NUMBER;var u=supportsBuffer?r.write(e,i,"utf8"):writeToTypedArray(r,e,i);i=i+u+1,r[i-1]=0,writeIEEE754(r,t,i,"little",52,8),i+=8}else{r[i++]=BSON.BSON_DATA_LONG;var u=supportsBuffer?r.write(e,i,"utf8"):writeToTypedArray(r,e,i);i=i+u+1,r[i-1]=0;var f=Long.fromNumber(t),l=f.getLowBits(),c=f.getHighBits();r[i++]=l&255,r[i++]=l>>8&255,r[i++]=l>>16&255,r[i++]=l>>24&255,r[i++]=c&255,r[i++]=c>>8&255,r[i++]=c>>16&255,r[i++]=c>>24&255}else{r[i++]=BSON.BSON_DATA_NUMBER;var u=supportsBuffer?r.write(e,i,"utf8"):writeToTypedArray(r,e,i);i=i+u+1,r[i-1]=0,writeIEEE754(r,t,i,"little",52,8),i+=8}return i;case"undefined":r[i++]=BSON.BSON_DATA_NULL;var u=supportsBuffer?r.write(e,i,"utf8"):writeToTypedArray(r,e,i);return i=i+u+1,r[i-1]=0,i;case"boolean":r[i++]=BSON.BSON_DATA_BOOLEAN;var u=supportsBuffer?r.write(e,i,"utf8"):writeToTypedArray(r,e,i);return i=i+u+1,r[i-1]=0,r[i++]=t?1:0,i;case"object":if(t===null||t instanceof MinKey||t instanceof MaxKey||t["_bsontype"]=="MinKey"||t["_bsontype"]=="MaxKey"){t===null?r[i++]=BSON.BSON_DATA_NULL:t instanceof MinKey?r[i++]=BSON.BSON_DATA_MIN_KEY:r[i++]=BSON.BSON_DATA_MAX_KEY;var u=supportsBuffer?r.write(e,i,"utf8"):writeToTypedArray(r,e,i);return i=i+u+1,r[i-1]=0,i}if(t instanceof ObjectID||t["_bsontype"]=="ObjectID"){r[i++]=BSON.BSON_DATA_OID;var u=supportsBuffer?r.write(e,i,"utf8"):writeToTypedArray(r,e,i);return i=i+u+1,r[i-1]=0,supportsBuffer?r.write(t.id,i,"binary"):writeToTypedArray(r,t.id,i),i+=12,i}if(t instanceof Date||isDate(t)){r[i++]=BSON.BSON_DATA_DATE;var u=supportsBuffer?r.write(e,i,"utf8"):writeToTypedArray(r,e,i);i=i+u+1,r[i-1]=0;var h=Long.fromNumber(t.getTime()),l=h.getLowBits(),c=h.getHighBits();return r[i++]=l&255,r[i++]=l>>8&255,r[i++]=l>>16&255,r[i++]=l>>24&255,r[i++]=c&255,r[i++]=c>>8&255,r[i++]=c>>16&255,r[i++]=c>>24&255,i}if(typeof Buffer!="undefined"&&Buffer.isBuffer(t)){r[i++]=BSON.BSON_DATA_BINARY;var u=supportsBuffer?r.write(e,i,"utf8"):writeToTypedArray(r,e,i);i=i+u+1,r[i-1]=0;var a=t.length;return r[i++]=a&255,r[i++]=a>>8&255,r[i++]=a>>16&255,r[i++]=a>>24&255,r[i++]=BSON.BSON_BINARY_SUBTYPE_DEFAULT,t.copy(r,i,0,a),i+=a,i}if(t instanceof Long||t instanceof Timestamp||t["_bsontype"]=="Long"||t["_bsontype"]=="Timestamp"){r[i++]=t instanceof Long?BSON.BSON_DATA_LONG:BSON.BSON_DATA_TIMESTAMP;var u=supportsBuffer?r.write(e,i,"utf8"):writeToTypedArray(r,e,i);i=i+u+1,r[i-1]=0;var l=t.getLowBits(),c=t.getHighBits();return r[i++]=l&255,r[i++]=l>>8&255,r[i++]=l>>16&255,r[i++]=l>>24&255,r[i++]=c&255,r[i++]=c>>8&255,r[i++]=c>>16&255,r[i++]=c>>24&255,i}if(t instanceof Double||t["_bsontype"]=="Double"){r[i++]=BSON.BSON_DATA_NUMBER;var u=supportsBuffer?r.write(e,i,"utf8"):writeToTypedArray(r,e,i);return i=i+u+1,r[i-1]=0,writeIEEE754(r,t,i,"little",52,8),i+=8,i}if(t instanceof Code||t["_bsontype"]=="Code"){if(t.scope!=null&&Object.keys(t.scope).length>0){r[i++]=BSON.BSON_DATA_CODE_W_SCOPE;var u=supportsBuffer?r.write(e,i,"utf8"):writeToTypedArray(r,e,i);i=i+u+1,r[i-1]=0;var p=BSON.calculateObjectSize(t.scope,s),d=t.code.toString(),v=supportsBuffer?Buffer.byteLength(d)+1:numberOfBytes(d)+1,m=4+v+p+4;r[i++]=m&255,r[i++]=m>>8&255,r[i++]=m>>16&255,r[i++]=m>>24&255,r[i++]=v&255,r[i++]=v>>8&255,r[i++]=v>>16&255,r[i++]=v>>24&255,supportsBuffer?r.write(d,i,"utf8"):writeToTypedArray(r,d,i),i=i+v-1,r[i++]=0;var g=supportsBuffer?new Buffer(p):new Uint8Array(new ArrayBuffer(p));serializeObject(t.scope,n,g,0,s);var y=p;return r[i++]=y&255,r[i++]=y>>8&255,r[i++]=y>>16&255,r[i++]=y>>24&255,supportsBuffer?g.copy(r,i,0,p):r.set(g,i),i=i+y-5,r[i++]=0,i}r[i++]=BSON.BSON_DATA_CODE;var u=supportsBuffer?r.write(e,i,"utf8"):writeToTypedArray(r,e,i);i=i+u+1,r[i-1]=0;var d=t.code.toString(),a=supportsBuffer?Buffer.byteLength(d)+1:numberOfBytes(d)+1;return r[i++]=a&255,r[i++]=a>>8&255,r[i++]=a>>16&255,r[i++]=a>>24&255,supportsBuffer?r.write(d,i,"utf8"):writeToTypedArray(r,d,i),i=i+a-1,r[i++]=0,i}if(t instanceof Binary||t["_bsontype"]=="Binary"){r[i++]=BSON.BSON_DATA_BINARY;var u=supportsBuffer?r.write(e,i,"utf8"):writeToTypedArray(r,e,i);i=i+u+1,r[i-1]=0;var b=t.value(!0),a=t.position;return r[i++]=a&255,r[i++]=a>>8&255,r[i++]=a>>16&255,r[i++]=a>>24&255,r[i++]=t.sub_type,t.sub_type==Binary.SUBTYPE_BYTE_ARRAY&&(r[i++]=a&255,r[i++]=a>>8&255,r[i++]=a>>16&255,r[i++]=a>>24&255),supportsBuffer?b.copy(r,i,0,t.position):r.set(b,i),i+=t.position,i}if(t instanceof Symbol||t["_bsontype"]=="Symbol"){r[i++]=BSON.BSON_DATA_SYMBOL;var u=supportsBuffer?r.write(e,i,"utf8"):writeToTypedArray(r,e,i);i=i+u+1,r[i-1]=0;var a=supportsBuffer?Buffer.byteLength(t.value)+1:numberOfBytes(t.value)+1;return r[i++]=a&255,r[i++]=a>>8&255,r[i++]=a>>16&255,r[i++]=a>>24&255,r.write(t.value,i,"utf8"),i=i+a-1,r[i++]=0,i}if(t instanceof DBRef||t["_bsontype"]=="DBRef"){r[i++]=BSON.BSON_DATA_OBJECT;var u=supportsBuffer?r.write(e,i,"utf8"):writeToTypedArray(r,e,i);i=i+u+1,r[i-1]=0;var w={$ref:t.namespace,$id:t.oid};null!=t.db&&(w.$db=t.db);var a=BSON.calculateObjectSize(w,s),E=BSON.serializeWithBufferAndIndex(w,n,r,i,s);return r[i++]=a&255,r[i++]=a>>8&255,r[i++]=a>>16&255,r[i++]=a>>24&255,r[E++]=0,E}if(t instanceof RegExp||Object.prototype.toString.call(t)==="[object RegExp]"){r[i++]=BSON.BSON_DATA_REGEXP;var u=supportsBuffer?r.write(e,i,"utf8"):writeToTypedArray(r,e,i);return i=i+u+1,r[i-1]=0,supportsBuffer?r.write(t.source,i,"utf8"):writeToTypedArray(r,t.source,i),i+=supportsBuffer?Buffer.byteLength(t.source):numberOfBytes(t.source),r[i++]=0,t.global&&(r[i++]=115),t.ignoreCase&&(r[i++]=105),t.multiline&&(r[i++]=109),r[i++]=0,i}r[i++]=Array.isArray(t)?BSON.BSON_DATA_ARRAY:BSON.BSON_DATA_OBJECT;var u=supportsBuffer?r.write(e,i,"utf8"):writeToTypedArray(r,e,i);i=i+u+1,r[i-1]=0;var E=serializeObject(t,n,r,i+4,s),a=E-i;return r[i++]=a&255,r[i++]=a>>8&255,r[i++]=a>>16&255,r[i++]=a>>24&255,E;case"function":if(t instanceof RegExp||Object.prototype.toString.call(t)==="[object RegExp]"||String.call(t)=="[object RegExp]"){r[i++]=BSON.BSON_DATA_REGEXP;var u=supportsBuffer?r.write(e,i,"utf8"):writeToTypedArray(r,e,i);return i=i+u+1,r[i-1]=0,r.write(t.source,i,"utf8"),i+=supportsBuffer?Buffer.byteLength(t.source):numberOfBytes(t.source),r[i++]=0,t.global&&(r[i++]=115),t.ignoreCase&&(r[i++]=105),t.multiline&&(r[i++]=109),r[i++]=0,i}if(s&&t.scope!=null&&Object.keys(t.scope).length>0){r[i++]=BSON.BSON_DATA_CODE_W_SCOPE;var u=supportsBuffer?r.write(e,i,"utf8"):writeToTypedArray(r,e,i);i=i+u+1,r[i-1]=0;var p=BSON.calculateObjectSize(t.scope,s),d=t.toString(),v=supportsBuffer?Buffer.byteLength(d)+1:numberOfBytes(d)+1,m=4+v+p;r[i++]=m&255,r[i++]=m>>8&255,r[i++]=m>>16&255,r[i++]=m>>24&255,r[i++]=v&255,r[i++]=v>>8&255,r[i++]=v>>16&255,r[i++]=v>>24&255,supportsBuffer?r.write(d,i,"utf8"):writeToTypedArray(r,d,i),i=i+v-1,r[i++]=0;var g=new Buffer(p);serializeObject(t.scope,n,g,0,s);var y=p-4;return r[i++]=y&255,r[i++]=y>>8&255,r[i++]=y>>16&255,r[i++]=y>>24&255,g.copy(r,i,0,p),i=i+y-5,r[i++]=0,i}if(s){r[i++]=BSON.BSON_DATA_CODE;var u=supportsBuffer?r.write(e,i,"utf8"):writeToTypedArray(r,e,i);i=i+u+1,r[i-1]=0;var d=t.toString(),a=supportsBuffer?Buffer.byteLength(d)+1:numberOfBytes(d)+1;return r[i++]=a&255,r[i++]=a>>8&255,r[i++]=a>>16&255,r[i++]=a>>24&255,supportsBuffer?r.write(d,i,"utf8"):writeToTypedArray(r,d,i),i=i+a-1,r[i++]=0,i}}return i};BSON.serialize=function(e,t,n,r){if(e==null||typeof e!="object"||Array.isArray(e))throw new Error("Only javascript objects supported");var i=null,s=BSON.calculateObjectSize(e,r);return(i=typeof Buffer!="undefined")?(i=new Buffer(s),n=!0):typeof Uint8Array!="undefined"?i=new Uint8Array(new ArrayBuffer(s)):i=new Array(s),BSON.serializeWithBufferAndIndex(e,t,i,0,r),i};var functionCache=BSON.functionCache={},table=[0,1996959894,3993919788,2567524794,124634137,1886057615,3915621685,2657392035,249268274,2044508324,3772115230,2547177864,162941995,2125561021,3887607047,2428444049,498536548,1789927666,4089016648,2227061214,450548861,1843258603,4107580753,2211677639,325883990,1684777152,4251122042,2321926636,335633487,1661365465,4195302755,2366115317,997073096,1281953886,3579855332,2724688242,1006888145,1258607687,3524101629,2768942443,901097722,1119000684,3686517206,2898065728,853044451,1172266101,3705015759,2882616665,651767980,1373503546,3369554304,3218104598,565507253,1454621731,3485111705,3099436303,671266974,1594198024,3322730930,2970347812,795835527,1483230225,3244367275,3060149565,1994146192,31158534,2563907772,4023717930,1907459465,112637215,2680153253,3904427059,2013776290,251722036,2517215374,3775830040,2137656763,141376813,2439277719,3865271297,1802195444,476864866,2238001368,4066508878,1812370925,453092731,2181625025,4111451223,1706088902,314042704,2344532202,4240017532,1658658271,366619977,2362670323,4224994405,1303535960,984961486,2747007092,3569037538,1256170817,1037604311,2765210733,3554079995,1131014506,879679996,2909243462,3663771856,1141124467,855842277,2852801631,3708648649,1342533948,654459306,3188396048,3373015174,1466479909,544179635,3110523913,3462522015,1591671054,702138776,2966460450,3352799412,1504918807,783551873,3082640443,3233442989,3988292384,2596254646,62317068,1957810842,3939845945,2647816111,81470997,1943803523,3814918930,2489596804,225274430,2053790376,3826175755,2466906013,167816743,2097651377,4027552580,2265490386,503444072,1762050814,4150417245,2154129355,426522225,1852507879,4275313526,2312317920,282753626,1742555852,4189708143,2394877945,397917763,1622183637,3604390888,2714866558,953729732,1340076626,3518719985,2797360999,1068828381,1219638859,3624741850,2936675148,906185462,1090812512,3747672003,2825379669,829329135,1181335161,3412177804,3160834842,628085408,1382605366,3423369109,3138078467,570562233,1426400815,3317316542,2998733608,733239954,1555261956,3268935591,3050360625,752459403,1541320221,2607071920,3965973030,1969922972,40735498,2617837225,3943577151,1913087877,83908371,2512341634,3803740692,2075208622,213261112,2463272603,3855990285,2094854071,198958881,2262029012,4057260610,1759359992,534414190,2176718541,4139329115,1873836001,414664567,2282248934,4279200368,1711684554,285281116,2405801727,4167216745,1634467795,376229701,2685067896,3608007406,1308918612,956543938,2808555105,3495958263,1231636301,1047427035,2932959818,3654703836,1088359270,936918e3,2847714899,3736837829,1202900863,817233897,3183342108,3401237130,1404277552,615818150,3134207493,3453421203,1423857449,601450431,3009837614,3294710456,1567103746,711928724,3020668471,3272380065,1510334235,755167117],crc32=function(e,t,n){var r=0,i=0,s=0;r^=-1;for(var o=t,u=n;o<u;o++)s=(r^e[o])&255,i=table[s],r=r>>>8^i;return r^-1};BSON.deserializeStream=function(e,t,n,r,i,s){s=s!=null?s:{};var o=t;for(var u=0;u<n;u++){var a=e[o]|e[o+1]<<8|e[o+2]<<16|e[o+3]<<24;s.index=o,r[i+u]=BSON.deserialize(e,s),o+=a}return o};var isolateEvalWithHash=function(functionCache,hash,functionString,object){var value=null;return functionCache[hash]==null&&(eval("value = "+functionString),functionCache[hash]=value),functionCache[hash].bind(object)},isolateEval=function(functionString){var value=null;return eval("value = "+functionString),value},convertUint8ArrayToUtf8String=function(e,t,n){return BinaryParser.decode_utf8(convertArraytoUtf8BinaryString(e,t,n))},convertArraytoUtf8BinaryString=function(e,t,n){var r="";for(var i=t;i<n;i++)r+=String.fromCharCode(e[i]);return r};BSON.deserialize=function(e,t,n){t=t==null?{}:t;var r=t["evalFunctions"]==null?!1:t.evalFunctions,i=t["cacheFunctions"]==null?!1:t.cacheFunctions,s=t["cacheFunctionsCrc32"]==null?!1:t.cacheFunctionsCrc32,o=t.promoteLongs||!0;if(e.length<5)throw new Error("corrupt bson message < 5 bytes long");var u=typeof t["index"]=="number"?t.index:0,a=function(){var t=u;while(e[t]!==0)t++;var n=supportsBuffer&&Buffer.isBuffer(e)?e.toString("utf8",u,t):convertUint8ArrayToUtf8String(e,u,t);return u=t+1,n},f=n?[]:{},l=e[u++]|e[u++]<<8|e[u++]<<16|e[u++]<<24;if(l<5||l>e.length)throw new Error("corrupt bson message");for(;;){var c=e[u++];if(c==0)break;var h=a();switch(c){case BSON.BSON_DATA_OID:var p=supportsBuffer&&Buffer.isBuffer(e)?e.toString("binary",u,u+12):convertArraytoUtf8BinaryString(e,u,u+12);f[h]=new ObjectID(p),u+=12;break;case BSON.BSON_DATA_STRING:var d=e[u++]|e[u++]<<8|e[u++]<<16|e[u++]<<24;f[h]=supportsBuffer&&Buffer.isBuffer(e)?e.toString("utf8",u,u+d-1):convertUint8ArrayToUtf8String(e,u,u+d-1),u+=d;break;case BSON.BSON_DATA_INT:f[h]=e[u++]|e[u++]<<8|e[u++]<<16|e[u++]<<24;break;case BSON.BSON_DATA_NUMBER:f[h]=readIEEE754(e,u,"little",52,8),u+=8;break;case BSON.BSON_DATA_DATE:var v=e[u++]|e[u++]<<8|e[u++]<<16|e[u++]<<24,m=e[u++]|e[u++]<<8|e[u++]<<16|e[u++]<<24;f[h]=new Date((new Long(v,m)).toNumber());break;case BSON.BSON_DATA_BOOLEAN:f[h]=e[u++]==1;break;case BSON.BSON_DATA_NULL:f[h]=null;break;case BSON.BSON_DATA_BINARY:var g=e[u++]|e[u++]<<8|e[u++]<<16|e[u++]<<24,y=e[u++];if(e["slice"]!=null)y==Binary.SUBTYPE_BYTE_ARRAY&&(g=e[u++]|e[u++]<<8|e[u++]<<16|e[u++]<<24),f[h]=new Binary(e.slice(u,u+g),y);else{var b=typeof Uint8Array!="undefined"?new Uint8Array(new ArrayBuffer(g)):new Array(g);y==Binary.SUBTYPE_BYTE_ARRAY&&(g=e[u++]|e[u++]<<8|e[u++]<<16|e[u++]<<24);for(var w=0;w<g;w++)b[w]=e[u+w];f[h]=new Binary(b,y)}u+=g;break;case BSON.BSON_DATA_ARRAY:t.index=
u;var E=e[u]|e[u+1]<<8|e[u+2]<<16|e[u+3]<<24;f[h]=BSON.deserialize(e,t,!0),u+=E;break;case BSON.BSON_DATA_OBJECT:t.index=u;var E=e[u]|e[u+1]<<8|e[u+2]<<16|e[u+3]<<24;f[h]=BSON.deserialize(e,t,!1),u+=E;break;case BSON.BSON_DATA_REGEXP:var S=a(),x=a(),T=new Array(x.length);for(var w=0;w<x.length;w++)switch(x[w]){case"m":T[w]="m";break;case"s":T[w]="g";break;case"i":T[w]="i"}f[h]=new RegExp(S,T.join(""));break;case BSON.BSON_DATA_LONG:var v=e[u++]|e[u++]<<8|e[u++]<<16|e[u++]<<24,m=e[u++]|e[u++]<<8|e[u++]<<16|e[u++]<<24,N=new Long(v,m);o?f[h]=N.lessThanOrEqual(JS_INT_MAX_LONG)&&N.greaterThanOrEqual(JS_INT_MIN_LONG)?N.toNumber():N:f[h]=N;break;case BSON.BSON_DATA_SYMBOL:var d=e[u++]|e[u++]<<8|e[u++]<<16|e[u++]<<24;f[h]=new Symbol(e.toString("utf8",u,u+d-1)),u+=d;break;case BSON.BSON_DATA_TIMESTAMP:var v=e[u++]|e[u++]<<8|e[u++]<<16|e[u++]<<24,m=e[u++]|e[u++]<<8|e[u++]<<16|e[u++]<<24;f[h]=new Timestamp(v,m);break;case BSON.BSON_DATA_MIN_KEY:f[h]=new MinKey;break;case BSON.BSON_DATA_MAX_KEY:f[h]=new MaxKey;break;case BSON.BSON_DATA_CODE:var d=e[u++]|e[u++]<<8|e[u++]<<16|e[u++]<<24,C=supportsBuffer&&Buffer.isBuffer(e)?e.toString("utf8",u,u+d-1):convertUint8ArrayToUtf8String(e,u,u+d-1);if(r){var k=null;if(i){var L=s?crc32(C):C;f[h]=isolateEvalWithHash(functionCache,L,C,f)}else f[h]=isolateEval(C)}else f[h]=new Code(C,{});u+=d;break;case BSON.BSON_DATA_CODE_W_SCOPE:var A=e[u++]|e[u++]<<8|e[u++]<<16|e[u++]<<24,d=e[u++]|e[u++]<<8|e[u++]<<16|e[u++]<<24,C=supportsBuffer&&Buffer.isBuffer(e)?e.toString("utf8",u,u+d-1):convertUint8ArrayToUtf8String(e,u,u+d-1);u+=d,t.index=u;var E=e[u]|e[u+1]<<8|e[u+2]<<16|e[u+3]<<24,O=BSON.deserialize(e,t,!1);u+=E;if(r){var k=null;if(i){var L=s?crc32(C):C;f[h]=isolateEvalWithHash(functionCache,L,C,f)}else f[h]=isolateEval(C);f[h].scope=O}else f[h]=new Code(C,O)}}return f["$id"]!=null&&(f=new DBRef(f.$ref,f.$id,f.$db)),f},BSON.checkKey=function(t,n){if(!t.length)return;if(!!~t.indexOf("\0"))throw Error("key "+t+" must not contain null bytes");if(!n){if("$"==t[0])throw Error("key "+t+" must not start with '$'");if(!!~t.indexOf("."))throw Error("key "+t+" must not contain '.'")}},BSON.prototype.deserialize=function(e,t){return BSON.deserialize(e,t)},BSON.prototype.deserializeStream=function(e,t,n,r,i,s){return BSON.deserializeStream(e,t,n,r,i,s)},BSON.prototype.serialize=function(e,t,n,r){return BSON.serialize(e,t,n,r)},BSON.prototype.calculateObjectSize=function(e,t){return BSON.calculateObjectSize(e,t)},BSON.prototype.serializeWithBufferAndIndex=function(e,t,n,r,i){return BSON.serializeWithBufferAndIndex(e,t,n,r,i)},exports.Code=Code,exports.Symbol=Symbol,exports.BSON=BSON,exports.DBRef=DBRef,exports.Binary=Binary,exports.ObjectID=ObjectID,exports.Long=Long,exports.Timestamp=Timestamp,exports.Double=Double,exports.MinKey=MinKey,exports.MaxKey=MaxKey},code:function(e,t,n,r,i){function s(e,t){if(!(this instanceof s))return new s(e,t);this._bsontype="Code",this.code=e,this.scope=t==null?{}:t}s.prototype.toJSON=function(){return{scope:this.scope,code:this.code}},t.Code=s},db_ref:function(e,t,n,r,i){function s(e,t,n){if(!(this instanceof s))return new s(e,t,n);this._bsontype="DBRef",this.namespace=e,this.oid=t,this.db=n}s.prototype.toJSON=function(){return{$ref:this.namespace,$id:this.oid,$db:this.db==null?"":this.db}},t.DBRef=s},"double":function(e,t,n,r,i){function s(e){if(!(this instanceof s))return new s(e);this._bsontype="Double",this.value=e}s.prototype.valueOf=function(){return this.value},s.prototype.toJSON=function(){return this.value},t.Double=s},float_parser:function(e,t,n,r,i){var s=function(e,t,n,r,i){var s,o,u=n==="big",a=i*8-r-1,f=(1<<a)-1,l=f>>1,c=-7,h=u?0:i-1,p=u?1:-1,d=e[t+h];h+=p,s=d&(1<<-c)-1,d>>=-c,c+=a;for(;c>0;s=s*256+e[t+h],h+=p,c-=8);o=s&(1<<-c)-1,s>>=-c,c+=r;for(;c>0;o=o*256+e[t+h],h+=p,c-=8);if(s===0)s=1-l;else{if(s===f)return o?NaN:(d?-1:1)*Infinity;o+=Math.pow(2,r),s-=l}return(d?-1:1)*o*Math.pow(2,s-r)},o=function(e,t,n,r,i,s){var o,u,a,f=r==="big",l=s*8-i-1,c=(1<<l)-1,h=c>>1,p=i===23?Math.pow(2,-24)-Math.pow(2,-77):0,d=f?s-1:0,v=f?-1:1,m=t<0||t===0&&1/t<0?1:0;t=Math.abs(t),isNaN(t)||t===Infinity?(u=isNaN(t)?1:0,o=c):(o=Math.floor(Math.log(t)/Math.LN2),t*(a=Math.pow(2,-o))<1&&(o--,a*=2),o+h>=1?t+=p/a:t+=p*Math.pow(2,1-h),t*a>=2&&(o++,a/=2),o+h>=c?(u=0,o=c):o+h>=1?(u=(t*a-1)*Math.pow(2,i),o+=h):(u=t*Math.pow(2,h-1)*Math.pow(2,i),o=0));for(;i>=8;e[n+d]=u&255,d+=v,u/=256,i-=8);o=o<<i|u,l+=i;for(;l>0;e[n+d]=o&255,d+=v,o/=256,l-=8);e[n+d-v]|=m*128};t.readIEEE754=s,t.writeIEEE754=o},index:function(e,t,n,r,i){try{t.BSONPure=r("./bson"),t.BSONNative=r("../../ext")}catch(s){}["./binary_parser","./binary","./code","./db_ref","./double","./max_key","./min_key","./objectid","./symbol","./timestamp","./long"].forEach(function(e){var n=r("./"+e);for(var i in n)t[i]=n[i]}),t.native=function(){var e={};return["./binary_parser","./binary","./code","./db_ref","./double","./max_key","./min_key","./objectid","./symbol","./timestamp","./long","../../ext"].forEach(function(t){var n=r("./"+t);for(var i in n)e[i]=n[i]}),e},t.pure=function(){var e={};return["./binary_parser","./binary","./code","./db_ref","./double","./max_key","./min_key","./objectid","./symbol","./timestamp","./long","././bson"].forEach(function(t){var n=r("./"+t);for(var i in n)e[i]=n[i]}),e}},"long":function(e,t,n,r,i){function s(e,t){if(!(this instanceof s))return new s(e,t);this._bsontype="Long",this.low_=e|0,this.high_=t|0}s.prototype.toInt=function(){return this.low_},s.prototype.toNumber=function(){return this.high_*s.TWO_PWR_32_DBL_+this.getLowBitsUnsigned()},s.prototype.toJSON=function(){return this.toString()},s.prototype.toString=function(e){var t=e||10;if(t<2||36<t)throw Error("radix out of range: "+t);if(this.isZero())return"0";if(this.isNegative()){if(this.equals(s.MIN_VALUE)){var n=s.fromNumber(t),r=this.div(n),i=r.multiply(n).subtract(this);return r.toString(t)+i.toInt().toString(t)}return"-"+this.negate().toString(t)}var o=s.fromNumber(Math.pow(t,6)),i=this,u="";for(;;){var a=i.div(o),f=i.subtract(a.multiply(o)).toInt(),l=f.toString(t);i=a;if(i.isZero())return l+u;while(l.length<6)l="0"+l;u=""+l+u}},s.prototype.getHighBits=function(){return this.high_},s.prototype.getLowBits=function(){return this.low_},s.prototype.getLowBitsUnsigned=function(){return this.low_>=0?this.low_:s.TWO_PWR_32_DBL_+this.low_},s.prototype.getNumBitsAbs=function(){if(this.isNegative())return this.equals(s.MIN_VALUE)?64:this.negate().getNumBitsAbs();var e=this.high_!=0?this.high_:this.low_;for(var t=31;t>0;t--)if((e&1<<t)!=0)break;return this.high_!=0?t+33:t+1},s.prototype.isZero=function(){return this.high_==0&&this.low_==0},s.prototype.isNegative=function(){return this.high_<0},s.prototype.isOdd=function(){return(this.low_&1)==1},s.prototype.equals=function(e){return this.high_==e.high_&&this.low_==e.low_},s.prototype.notEquals=function(e){return this.high_!=e.high_||this.low_!=e.low_},s.prototype.lessThan=function(e){return this.compare(e)<0},s.prototype.lessThanOrEqual=function(e){return this.compare(e)<=0},s.prototype.greaterThan=function(e){return this.compare(e)>0},s.prototype.greaterThanOrEqual=function(e){return this.compare(e)>=0},s.prototype.compare=function(e){if(this.equals(e))return 0;var t=this.isNegative(),n=e.isNegative();return t&&!n?-1:!t&&n?1:this.subtract(e).isNegative()?-1:1},s.prototype.negate=function(){return this.equals(s.MIN_VALUE)?s.MIN_VALUE:this.not().add(s.ONE)},s.prototype.add=function(e){var t=this.high_>>>16,n=this.high_&65535,r=this.low_>>>16,i=this.low_&65535,o=e.high_>>>16,u=e.high_&65535,a=e.low_>>>16,f=e.low_&65535,l=0,c=0,h=0,p=0;return p+=i+f,h+=p>>>16,p&=65535,h+=r+a,c+=h>>>16,h&=65535,c+=n+u,l+=c>>>16,c&=65535,l+=t+o,l&=65535,s.fromBits(h<<16|p,l<<16|c)},s.prototype.subtract=function(e){return this.add(e.negate())},s.prototype.multiply=function(e){if(this.isZero())return s.ZERO;if(e.isZero())return s.ZERO;if(this.equals(s.MIN_VALUE))return e.isOdd()?s.MIN_VALUE:s.ZERO;if(e.equals(s.MIN_VALUE))return this.isOdd()?s.MIN_VALUE:s.ZERO;if(this.isNegative())return e.isNegative()?this.negate().multiply(e.negate()):this.negate().multiply(e).negate();if(e.isNegative())return this.multiply(e.negate()).negate();if(this.lessThan(s.TWO_PWR_24_)&&e.lessThan(s.TWO_PWR_24_))return s.fromNumber(this.toNumber()*e.toNumber());var t=this.high_>>>16,n=this.high_&65535,r=this.low_>>>16,i=this.low_&65535,o=e.high_>>>16,u=e.high_&65535,a=e.low_>>>16,f=e.low_&65535,l=0,c=0,h=0,p=0;return p+=i*f,h+=p>>>16,p&=65535,h+=r*f,c+=h>>>16,h&=65535,h+=i*a,c+=h>>>16,h&=65535,c+=n*f,l+=c>>>16,c&=65535,c+=r*a,l+=c>>>16,c&=65535,c+=i*u,l+=c>>>16,c&=65535,l+=t*f+n*a+r*u+i*o,l&=65535,s.fromBits(h<<16|p,l<<16|c)},s.prototype.div=function(e){if(e.isZero())throw Error("division by zero");if(this.isZero())return s.ZERO;if(this.equals(s.MIN_VALUE)){if(e.equals(s.ONE)||e.equals(s.NEG_ONE))return s.MIN_VALUE;if(e.equals(s.MIN_VALUE))return s.ONE;var t=this.shiftRight(1),n=t.div(e).shiftLeft(1);if(n.equals(s.ZERO))return e.isNegative()?s.ONE:s.NEG_ONE;var r=this.subtract(e.multiply(n)),i=n.add(r.div(e));return i}if(e.equals(s.MIN_VALUE))return s.ZERO;if(this.isNegative())return e.isNegative()?this.negate().div(e.negate()):this.negate().div(e).negate();if(e.isNegative())return this.div(e.negate()).negate();var o=s.ZERO,r=this;while(r.greaterThanOrEqual(e)){var n=Math.max(1,Math.floor(r.toNumber()/e.toNumber())),u=Math.ceil(Math.log(n)/Math.LN2),a=u<=48?1:Math.pow(2,u-48),f=s.fromNumber(n),l=f.multiply(e);while(l.isNegative()||l.greaterThan(r))n-=a,f=s.fromNumber(n),l=f.multiply(e);f.isZero()&&(f=s.ONE),o=o.add(f),r=r.subtract(l)}return o},s.prototype.modulo=function(e){return this.subtract(this.div(e).multiply(e))},s.prototype.not=function(){return s.fromBits(~this.low_,~this.high_)},s.prototype.and=function(e){return s.fromBits(this.low_&e.low_,this.high_&e.high_)},s.prototype.or=function(e){return s.fromBits(this.low_|e.low_,this.high_|e.high_)},s.prototype.xor=function(e){return s.fromBits(this.low_^e.low_,this.high_^e.high_)},s.prototype.shiftLeft=function(e){e&=63;if(e==0)return this;var t=this.low_;if(e<32){var n=this.high_;return s.fromBits(t<<e,n<<e|t>>>32-e)}return s.fromBits(0,t<<e-32)},s.prototype.shiftRight=function(e){e&=63;if(e==0)return this;var t=this.high_;if(e<32){var n=this.low_;return s.fromBits(n>>>e|t<<32-e,t>>e)}return s.fromBits(t>>e-32,t>=0?0:-1)},s.prototype.shiftRightUnsigned=function(e){e&=63;if(e==0)return this;var t=this.high_;if(e<32){var n=this.low_;return s.fromBits(n>>>e|t<<32-e,t>>>e)}return e==32?s.fromBits(t,0):s.fromBits(t>>>e-32,0)},s.fromInt=function(e){if(-128<=e&&e<128){var t=s.INT_CACHE_[e];if(t)return t}var n=new s(e|0,e<0?-1:0);return-128<=e&&e<128&&(s.INT_CACHE_[e]=n),n},s.fromNumber=function(e){return isNaN(e)||!isFinite(e)?s.ZERO:e<=-s.TWO_PWR_63_DBL_?s.MIN_VALUE:e+1>=s.TWO_PWR_63_DBL_?s.MAX_VALUE:e<0?s.fromNumber(-e).negate():new s(e%s.TWO_PWR_32_DBL_|0,e/s.TWO_PWR_32_DBL_|0)},s.fromBits=function(e,t){return new s(e,t)},s.fromString=function(e,t){if(e.length==0)throw Error("number format error: empty string");var n=t||10;if(n<2||36<n)throw Error("radix out of range: "+n);if(e.charAt(0)=="-")return s.fromString(e.substring(1),n).negate();if(e.indexOf("-")>=0)throw Error('number format error: interior "-" character: '+e);var r=s.fromNumber(Math.pow(n,8)),i=s.ZERO;for(var o=0;o<e.length;o+=8){var u=Math.min(8,e.length-o),a=parseInt(e.substring(o,o+u),n);if(u<8){var f=s.fromNumber(Math.pow(n,u));i=i.multiply(f).add(s.fromNumber(a))}else i=i.multiply(r),i=i.add(s.fromNumber(a))}return i},s.INT_CACHE_={},s.TWO_PWR_16_DBL_=65536,s.TWO_PWR_24_DBL_=1<<24,s.TWO_PWR_32_DBL_=s.TWO_PWR_16_DBL_*s.TWO_PWR_16_DBL_,s.TWO_PWR_31_DBL_=s.TWO_PWR_32_DBL_/2,s.TWO_PWR_48_DBL_=s.TWO_PWR_32_DBL_*s.TWO_PWR_16_DBL_,s.TWO_PWR_64_DBL_=s.TWO_PWR_32_DBL_*s.TWO_PWR_32_DBL_,s.TWO_PWR_63_DBL_=s.TWO_PWR_64_DBL_/2,s.ZERO=s.fromInt(0),s.ONE=s.fromInt(1),s.NEG_ONE=s.fromInt(-1),s.MAX_VALUE=s.fromBits(-1,2147483647),s.MIN_VALUE=s.fromBits(0,-2147483648),s.TWO_PWR_24_=s.fromInt(1<<24),t.Long=s},max_key:function(e,t,n,r,i){function s(){if(!(this instanceof s))return new s;this._bsontype="MaxKey"}t.MaxKey=s},min_key:function(e,t,n,r,i){function s(){if(!(this instanceof s))return new s;this._bsontype="MinKey"}t.MinKey=s},objectid:function(e,t,n,r,i){var s=r("./binary_parser").BinaryParser,o=parseInt(Math.random()*16777215,10),u=new RegExp("^[0-9a-fA-F]{24}$"),a=function l(e,t){if(!(this instanceof l))return new l(e,t);this._bsontype="ObjectID";var n=null;if(e!=null&&"number"!=typeof e&&e.length!=12&&e.length!=24)throw new Error("Argument passed in must be a single String of 12 bytes or a string of 24 hex characters");if(e==null||typeof e=="number")this.id=this.generate(e);else{if(e==null||e.length!==12){if(u.test(e))return l.createFromHexString(e);throw new Error("Value passed in is not a valid 24 character hex string")}this.id=e}l.cacheHexString&&(this.__id=this.toHexString())},f=a;a.prototype.toHexString=function(){if(a.cacheHexString&&this.__id)return this.__id;var e="",t,n;for(var r=0,i=this.id.length;r<i;r++)n=s.toByte(this.id[r]),t=n<=15?"0"+n.toString(16):n.toString(16),e+=t;return a.cacheHexString&&(this.__id=e),e},a.prototype.get_inc=function(){return a.index=(a.index+1)%16777215},a.prototype.getInc=function(){return this.get_inc()},a.prototype.generate=function(e){if("number"==typeof e)var t=s.encodeInt(e,32,!0,!0),n=s.encodeInt(o,24,!1),r=s.fromShort(typeof process=="undefined"?Math.floor(Math.random()*1e5):process.pid),i=s.encodeInt(this.get_inc(),24,!1,!0);else var u=parseInt(Date.now()/1e3,10),t=s.encodeInt(u,32,!0,!0),n=s.encodeInt(o,24,!1),r=s.fromShort(typeof process=="undefined"?Math.floor(Math.random()*1e5):process.pid),i=s.encodeInt(this.get_inc(),24,!1,!0);return t+n+r+i},a.prototype.toString=function(){return this.toHexString()},a.prototype.inspect=a.prototype.toString,a.prototype.toJSON=function(){return this.toHexString()},a.prototype.equals=function(t){var n=t instanceof a||t.toHexString?t.id:a.createFromHexString(t).id;return this.id===n},a.prototype.getTimestamp=function(){var e=new Date;return e.setTime(Math.floor(s.decodeInt(this.id.substring(0,4),32,!0,!0))*1e3),e},a.index=parseInt(Math.random()*16777215,10),a.createPk=function(){return new a},a.createFromTime=function(t){var n=s.encodeInt(t,32,!0,!0)+s.encodeInt(0,64,!0,!0);return new a(n)},a.createFromHexString=function(t){if(typeof t=="undefined"||t!=null&&t.length!=24)throw new Error("Argument passed in must be a single String of 12 bytes or a string of 24 hex characters");var n=t.length;if(n>24)throw new Error("Id cannot be longer than 12 bytes");var r="",i,o;for(var u=0;u<n;u+=2)i=t.substr(u,2),o=parseInt(i,16),r+=s.fromByte(o);return new a(r,t)},Object.defineProperty(a.prototype,"generationTime",{enumerable:!0,get:function(){return Math.floor(s.decodeInt(this.id.substring(0,4),32,!0,!0))},set:function(e){var e=s.encodeInt(e,32,!0,!0);this.id=e+this.id.substr(4),this.toHexString()}}),t.ObjectID=a,t.ObjectId=a},symbol:function(e,t,n,r,i){function s(e){if(!(this instanceof s))return new s(e);this._bsontype="Symbol",this.value=e}s.prototype.valueOf=function(){return this.value},s.prototype.toString=function(){return this.value},s.prototype.inspect=function(){return this.value},s.prototype.toJSON=function(){return this.value},t.Symbol=s},timestamp:function(e,t,n,r,i){function s(e,t){if(!(this instanceof s))return new s(e,t);this._bsontype="Timestamp",this.low_=e|0,this.high_=t|0}s.prototype.toInt=function(){return this.low_},s.prototype.toNumber=function(){return this.high_*s.TWO_PWR_32_DBL_+this.getLowBitsUnsigned()},s.prototype.toJSON=function(){return this.toString()},s.prototype.toString=function(e){var t=e||10;if(t<2||36<t)throw Error("radix out of range: "+t);if(this.isZero())return"0";if(this.isNegative()){if(this.equals(s.MIN_VALUE)){var n=s.fromNumber(t),r=this.div(n),i=r.multiply(n).subtract(this);return r.toString(t)+i.toInt().toString(t)}return"-"+this.negate().toString(t)}var o=s.fromNumber(Math.pow(t,6)),i=this,u="";for(;;){var a=i.div(o),f=i.subtract(a.multiply(o)).toInt(),l=f.toString(t);i=a;if(i.isZero())return l+u;while(l.length<6)l="0"+l;u=""+l+u}},s.prototype.getHighBits=function(){return this.high_},s.prototype.getLowBits=function(){return this.low_},s.prototype.getLowBitsUnsigned=function(){return this.low_>=0?this.low_:s.TWO_PWR_32_DBL_+this.low_},s.prototype.getNumBitsAbs=function(){if(this.isNegative())return this.equals(s.MIN_VALUE)?64:this.negate().getNumBitsAbs();var e=this.high_!=0?this.high_:this.low_;for(var t=31;t>0;t--)if((e&1<<t)!=0)break;return this.high_!=0?t+33:t+1},s.prototype.isZero=function(){return this.high_==0&&this.low_==0},s.prototype.isNegative=function(){return this.high_<0},s.prototype.isOdd=function(){return(this.low_&1)==1},s.prototype.equals=function(e){return this.high_==e.high_&&this.low_==e.low_},s.prototype.notEquals=function(e){return this.high_!=e.high_||this.low_!=e.low_},s.prototype.lessThan=function(e){return this.compare(e)<0},s.prototype.lessThanOrEqual=function(e){return this.compare(e)<=0},s.prototype.greaterThan=function(e){return this.compare(e)>0},s.prototype.greaterThanOrEqual=function(e){return this.compare(e)>=0},s.prototype.compare=function(e){if(this.equals(e))return 0;var t=this.isNegative(),n=e.isNegative();return t&&!n?-1:!t&&n?1:this.subtract(e).isNegative()?-1:1},s.prototype.negate=function(){return this.equals(s.MIN_VALUE)?s.MIN_VALUE:this.not().add(s.ONE)},s.prototype.add=function(e){var t=this.high_>>>16,n=this.high_&65535,r=this.low_>>>16,i=this.low_&65535,o=e.high_>>>16,u=e.high_&65535,a=e.low_>>>16,f=e.low_&65535,l=0,c=0,h=0,p=0;return p+=i+f,h+=p>>>16,p&=65535,h+=r+a,c+=h>>>16,h&=65535,c+=n+u,l+=c>>>16,c&=65535,l+=t+o,l&=65535,s.fromBits(h<<16|p,l<<16|c)},s.prototype.subtract=function(e){return this.add(e.negate())},s.prototype.multiply=function(e){if(this.isZero())return s.ZERO;if(e.isZero())return s.ZERO;if(this.equals(s.MIN_VALUE))return e.isOdd()?s.MIN_VALUE:s.ZERO;if(e.equals(s.MIN_VALUE))return this.isOdd()?s.MIN_VALUE:s.ZERO;if(this.isNegative())return e.isNegative()?this.negate().multiply(e.negate()):this.negate().multiply(e).negate();if(e.isNegative())return this.multiply(e.negate()).negate();if(this.lessThan(s.TWO_PWR_24_)&&e.lessThan(s.TWO_PWR_24_))return s.fromNumber(this.toNumber()*e.toNumber());var t=this.high_>>>16,n=this.high_&65535,r=this.low_>>>16,i=this.low_&65535,o=e.high_>>>16,u=e.high_&65535,a=e.low_>>>16,f=e.low_&65535,l=0,c=0,h=0,p=0;return p+=i*f,h+=p>>>16,p&=65535,h+=r*f,c+=h>>>16,h&=65535,h+=i*a,c+=h>>>16,h&=65535,c+=n*f,l+=c>>>16,c&=65535,c+=r*a,l+=c>>>16,c&=65535,c+=i*u,l+=c>>>16,c&=65535,l+=t*f+n*a+r*u+i*o,l&=65535,s.fromBits(h<<16|p,l<<16|c)},s.prototype.div=function(e){if(e.isZero())throw Error("division by zero");if(this.isZero())return s.ZERO;if(this.equals(s.MIN_VALUE)){if(e.equals(s.ONE)||e.equals(s.NEG_ONE))return s.MIN_VALUE;if(e.equals(s.MIN_VALUE))return s.ONE;var t=this.shiftRight(1),n=t.div(e).shiftLeft(1);if(n.equals(s.ZERO))return e.isNegative()?s.ONE:s.NEG_ONE;var r=this.subtract(e.multiply(n)),i=n.add(r.div(e));return i}if(e.equals(s.MIN_VALUE))return s.ZERO;if(this.isNegative())return e.isNegative()?this.negate().div(e.negate()):this.negate().div(e).negate();if(e.isNegative())return this.div(e.negate()).negate();var o=s.ZERO,r=this;while(r.greaterThanOrEqual(e)){var n=Math.max(1,Math.floor(r.toNumber()/e.toNumber())),u=Math.ceil(Math.log(n)/Math.LN2),a=u<=48?1:Math.pow(2,u-48),f=s.fromNumber(n),l=f.multiply(e);while(l.isNegative()||l.greaterThan(r))n-=a,f=s.fromNumber(n),l=f.multiply(e);f.isZero()&&(f=s.ONE),o=o.add(f),r=r.subtract(l)}return o},s.prototype.modulo=function(e){return this.subtract(this.div(e).multiply(e))},s.prototype.not=function(){return s.fromBits(~this.low_,~this.high_)},s.prototype.and=function(e){return s.fromBits(this.low_&e.low_,this.high_&e.high_)},s.prototype.or=function(e){return s.fromBits(this.low_|e.low_,this.high_|e.high_)},s.prototype.xor=function(e){return s.fromBits(this.low_^e.low_,this.high_^e.high_)},s.prototype.shiftLeft=function(e){e&=63;if(e==0)return this;var t=this.low_;if(e<32){var n=this.high_;return s.fromBits(t<<e,n<<e|t>>>32-e)}return s.fromBits(0,t<<e-32)},s.prototype.shiftRight=function(e){e&=63;if(e==0)return this;var t=this.high_;if(e<32){var n=this.low_;return s.fromBits(n>>>e|t<<32-e,t>>e)}return s.fromBits(t>>e-32,t>=0?0:-1)},s.prototype.shiftRightUnsigned=function(e){e&=63;if(e==0)return this;var t=this.high_;if(e<32){var n=this.low_;return s.fromBits(n>>>e|t<<32-e,t>>>e)}return e==32?s.fromBits(t,0):s.fromBits(t>>>e-32,0)},s.fromInt=function(e){if(-128<=e&&e<128){var t=s.INT_CACHE_[e];if(t)return t}var n=new s(e|0,e<0?-1:0);return-128<=e&&e<128&&(s.INT_CACHE_[e]=n),n},s.fromNumber=function(e){return isNaN(e)||!isFinite(e)?s.ZERO:e<=-s.TWO_PWR_63_DBL_?s.MIN_VALUE:e+1>=s.TWO_PWR_63_DBL_?s.MAX_VALUE:e<0?s.fromNumber(-e).negate():new s(e%s.TWO_PWR_32_DBL_|0,e/s.TWO_PWR_32_DBL_|0)},s.fromBits=function(e,t){return new s(e,t)},s.fromString=function(e,t){if(e.length==0)throw Error("number format error: empty string");var n=t||10;if(n<2||36<n)throw Error("radix out of range: "+n);if(e.charAt(0)=="-")return s.fromString(e.substring(1),n).negate();if(e.indexOf("-")>=0)throw Error('number format error: interior "-" character: '+e);var r=s.fromNumber(Math.pow(n,8)),i=s.ZERO;for(var o=0;o<e.length;o+=8){var u=Math.min(8,e.length-o),a=parseInt(e.substring(o,o+u),n);if(u<8){var f=s.fromNumber(Math.pow(n,u));i=i.multiply(f).add(s.fromNumber(a))}else i=i.multiply(r),i=i.add(s.fromNumber(a))}return i},s.INT_CACHE_={},s.TWO_PWR_16_DBL_=65536,s.TWO_PWR_24_DBL_=1<<24,s.TWO_PWR_32_DBL_=s.TWO_PWR_16_DBL_*s.TWO_PWR_16_DBL_,s.TWO_PWR_31_DBL_=s.TWO_PWR_32_DBL_/2,s.TWO_PWR_48_DBL_=s.TWO_PWR_32_DBL_*s.TWO_PWR_16_DBL_,s.TWO_PWR_64_DBL_=s.TWO_PWR_32_DBL_*s.TWO_PWR_32_DBL_,s.TWO_PWR_63_DBL_=s.TWO_PWR_64_DBL_/2,s.ZERO=s.fromInt(0),s.ONE=s.fromInt(1),s.NEG_ONE=s.fromInt(-1),s.MAX_VALUE=s.fromBits(-1,2147483647),s.MIN_VALUE=s.fromBits(0,-2147483648),s.TWO_PWR_24_=s.fromInt(1<<24),t.Timestamp=s}}),typeof module!="undefined"&&module.exports&&(module.exports=bson,module.parent||bson()),typeof window!="undefined"&&typeof require=="undefined"&&(window.require=bson.require);window.SA=window.SA||{},function(){"use strict";function u(e,t){SA.display&&(SA.display.Viewers[0].MainView.Camera.SetFocalPoint([e,t]),SA.display.Viewers[0].MainView.Camera.ComputeMatrix(),SA.display.Draw())}function a(e,t){var n="0000000000"+e.toFixed();return n.slice(-t)}function f(e){var t;try{t=e.getContext("webgl")}catch(n){}return t?t:null}function l(e,t,n){var r;return r=e.createShader(t),e.shaderSource(r,n),e.compileShader(r),e.getShaderParameter(r,e.COMPILE_STATUS)?r:(SA.Debug(e.getShaderInfoLog(r)),null)}function c(e){var t="precision highp float;uniform sampler2D uSampler;varying vec2 vTextureCoord;void main(void) {   vec4 textureColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));   highp float value = textureColor.rgb[1] + textureColor.rgb[1] +textureColor.rgb[2];   if (value < 0.3 || value > 2.5) {     textureColor[0] = textureColor[1] = textureColor[2] = textureColor[3] = 0.0;   }   gl_FragColor = textureColor; }",n="precision highp float;uniform sampler2D uSampler;varying vec2 vTextureCoord;void main(void) {  vec4 textureColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));  textureColor[3] = textureColor[0];  highp float h = textureColor[1] * 6.0;  if (h < 1.0) {    textureColor[0] = 1.0;    textureColor[1] = h;    textureColor[3] = 0.0;  } else if (h < 2.0) {    textureColor[0] = 2.0-h;    textureColor[1] = 1.0;    textureColor[3] = 0.0;  } else if (h < 3.0) {    textureColor[0] = 0.0;    textureColor[1] = 1.0;    textureColor[3] = h-2.0;  } else if (h < 4.0) {    textureColor[0] = 0.0;    textureColor[1] = 4.0-h;    textureColor[3] = 1.0;  } else if (h < 5.0) {    textureColor[0] = h-4.0;    textureColor[1] = 0.0;    textureColor[3] = 1.0;  } else if (h < 6.0) {    textureColor[0] = 1.0;    textureColor[1] = 0.0;    textureColor[3] = 6.0-h;  }  gl_FragColor = textureColor;}",r="precision highp float;uniform sampler2D uSampler;uniform vec3 uColor;varying vec2 vTextureCoord;void main(void) {  vec4 textureColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t)).rgba;  textureColor = vec4(uColor, textureColor[0]);  gl_FragColor = textureColor;}",i="precision highp float;uniform sampler2D uSampler;varying vec2 vTextureCoord;void main(void) {   vec4 textureColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));   gl_FragColor = textureColor; }",s="attribute vec3 aVertexPosition;attribute vec2 aTextureCoord;uniform mat4 uMVMatrix;uniform mat4 uPMatrix;uniform mat3 uNMatrix;varying vec2 vTextureCoord;void main(void) {  gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition,1.0);  vTextureCoord = aTextureCoord;}";view.imageProgram=SA.createWebGlProgram(r,s,e),view.imageProgram.textureCoordAttribute=e.getAttribLocation(view.imageProgram,"aTextureCoord"),e.enableVertexAttribArray(view.imageProgram.textureCoordAttribute),view.imageProgram.samplerUniform=e.getUniformLocation(view.imageProgram,"uSampler"),view.imageProgram.colorUniform=e.getUniformLocation(view.imageProgram,"uColor")}function h(e){var t=[0,0,0,0,1,0,1,1,0,1,0,0,0,0,0],n=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,n),e.bufferData(e.ARRAY_BUFFER,new Float32Array(t),e.STATIC_DRAW),n.itemSize=3,n.numItems=5;var r=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,r),t=[1,1,0,0,1,0,1,0,0,0,0,0],e.bufferData(e.ARRAY_BUFFER,new Float32Array(t),e.STATIC_DRAW),r.itemSize=3,r.numItems=4}function p(e){if(e.tileVertexTextureCoordinateBuffer)return;var t=e.gl,n=[],r=[];r.push(0),r.push(0),n.push(0),n.push(0),n.push(0),r.push(1),r.push(0),n.push(1),n.push(0),n.push(0),r.push(0),r.push(1),n.push(0),n.push(1),n.push(0),r.push(1),r.push(1),n.push(1),n.push(1),n.push(0);var i=[];i.push(0),i.push(1),i.push(2),i.push(2),i.push(1),i.push(3),e.tileVertexTextureCoordBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,e.tileVertexTextureCoordBuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(r),t.STATIC_DRAW),e.tileVertexTextureCoordBuffer.itemSize=2,e.tileVertexTextureCoordBuffer.numItems=r.length/2,e.tileVertexPositionBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,e.tileVertexPositionBuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(n),t.STATIC_DRAW),e.tileVertexPositionBuffer.itemSize=3,e.tileVertexPositionBuffer.numItems=n.length/3,e.tileCellBuffer=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,e.tileCellBuffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint16Array(i),t.STATIC_DRAW),e.tileCellBuffer.itemSize=1,e.tileCellBuffer.numItems=i.length}function d(){SAM.detectMobile()}function g(){var e=[m[0],m[1],m[2],m[3],m[4],m[5]];v.push(e)}function y(){var e=v.pop();m=e,GC.setTransform(e[0],e[1],e[2],e[3],e[4],e[5])}function b(e,t,n,r,i,s){m=[e,t,n,r,i,s],GC.setTransform(e,t,n,r,i,s)}function w(e,t,n,r,i,s){var o=e*m[0]+t*m[2],u=e*m[1]+t*m[3],a=n*m[0]+r*m[2],f=n*m[1]+r*m[3],l=i*m[0]+s*m[2]+m[4],c=i*m[1]+s*m[3]+m[5];m=[o,u,a,f,l,c],GC.setTransform(o,u,a,f,l,c)}function x(e){if(E)return;E=!0}function T(e){E&&S.push(e)}function A(e,t){}function O(){$("window").trigger("resize")}function M(e,t){}function _(e){return SA.HandleKeyDownStack(e)}function D(e){return SA.HandleKeyUpStack(e)}function P(){SA.Edit&&SA.SaveButton&&SA.SaveButton.attr("src",SA.ImagePathUrl+"save.png")}function H(){SA.Edit&&SA.SaveButton&&SA.SaveButton.attr("src",SA.ImagePathUrl+"save22.png")}function B(){SA.notesWidget.SaveCallback(function(){SA.SaveButton.attr("src",SA.ImagePathUrl+"save22.png")})}function j(e){SA.RootNote=e;if(e.Type=="Presentation"||e.Type=="HTML"){SA.presentation=new SA.Presentation(e,SA.Edit);return}SAM.detectMobile(),$(body).addClass("sa-view-body"),!SAM.detectMobile()&&!1?initGL():d(),SAM.detectMobile()&&L&&(L=new SA.MobileAnnotationWidget),SA.MainDiv=$("<div>").appendTo("body").css({position:"fixed",left:"0px",width:"100%"}).saFullHeight(),SA.resizePanel=new SA.ResizePanel(SA.MainDiv),SA.display=new SA.DualViewWidget(SA.resizePanel.MainDiv),SA.notesWidget=new SA.NotesWidget(SA.resizePanel.PanelDiv,SA.display),e.Type=="Stack"&&SA.display.SetNumberOfViewers(2),SA.notesWidget.SetModifiedCallback(P),SA.notesWidget.SetModifiedClearCallback(H),SA.notesWidget.SetNavigationWidget(SA.display.NavigationWidget),SA.display.NavigationWidget&&SA.display.NavigationWidget.SetInteractionEnabled(!0),SA.recorderWidget=new SA.RecorderWidget(SA.display),SA.User!=""&&!SAM.detectMobile()&&(SA.Edit?SA.SaveButton=$("<img>").appendTo(SA.resizePanel.MainDiv).css({position:"absolute",bottom:"4px",left:"10px",height:"28px","z-index":"5"}).prop("title","save to databse").addClass("editButton").attr("src",SA.ImagePathUrl+"save22.png").click(B):SA.FAVORITES_WIDGET=new SA.FavoritesWidget(SA.MainDiv,SA.display)),SAM.MOBILE_DEVICE&&SA.DualDisplay&&SA.DualDisplay.NavigationWidget&&SA.DualDisplay.NavigationWidget.SetVisibility(!1),SAM.MOBILE_DEVICE&&L&&L.SetVisibility(!1),document.onkeydown=_,document.onkeyup=D,document.oncontextmenu=SA.cancelContextMenu;if(!SAM.MOBILE_DEVICE){SA.VIEW_BROWSER=new SA.ViewBrowser($("body")),SA.InitSlideSelector(SA.MainDiv);var t=new SA.ViewEditMenu(SA.display.Viewers[0],SA.display.Viewers[1]),n=new SA.ViewEditMenu(SA.display.Viewers[1],SA.display.Viewers[0]),r=SA.display.Viewers[0],i=SA.display.Viewers[1];SA.display.UpdateGui()}SA.SetNote(e),$(window).bind("orientationchange",function(e){O()}),$(window).resize(function(){O()}).trigger("resize"),SA.display&&SA.display.Draw()}function F(){var e=SA.display.GetNote(),t=e.ViewerRecords[e.StartIndex],n=SA.VIEWER1.WidgetList,r=SA.VIEWER1.GetCamera(),i=r.GetBounds();for(var s=0;s<t.Annotations.length;++s)if(t.Annotations[s].type!="lasso")t.Annotations.splice(s,1),--s;else{var o=t.Annotations[s].points[0];if(!o||o[0]<i[0]||o[0]>i[1]||o[1]<i[2]||o[1]>i[3])t.Annotations.splice(s,1),--s}for(var s=0;s<n.length;++s)if(!n[s]instanceof LassoWidget||!n[s].Loop)n.splice(s,1),--s;else{var o=n[s].Loop.Points[0];if(!o||o[0]<i[0]||o[0]>i[1]||o[1]<i[2]||o[1]>i[3])n.splice(s,1),--s}}var e;SA.imageProgram;var t,n,r=mat4.create(),i=mat4.create(),s,o;SA.tileVertexPositionBuffer,SA.tileVertexTextureCoordBuffer,SA.tileCellBuffer,window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame,SA.SetNote=function(e){SA.notesWidget&&SA.notesWidget.SelectNote(e),SA.navigationWidget&&SA.navigationWidget.SetNote(e),SA.display&&SA.display.SetNote(e)},SA.SetNoteFromId=function(e){var t=SA.GetNoteFromId(e);return t?(SA.SetNote(t),t):(t=new SA.Note,t.LoadViewId(e,function(){SA.SetNote(t)}),t)},SA.FirefoxWhich=function(e){e.which=e.buttons,e.which==2?e.which=3:e.which==3&&(e.which=2)},SA.Debug=function(e){console.log(e)},SA.ProgressCount=0,SA.Caches=[],SA.StartInteractionListeners=[],SA.PushProgress=function(){$("body").css({cursor:"progress"}),SA.ProgressCount+=1},SA.PopProgress=function(){SA.ProgressCount-=1,SA.ProgressCount<=0&&$("body").css({cursor:"default"})},SA.Run=function(){SA.Running==1,self=SA,SA.SessionId?$.ajax({type:"get",url:SA.SessionUrl+"?json=true&sessid="+SA.SessionId,success:function(e,t){self.Session=e,self.HideAnnotations=e.hide,self.Run2()},error:function(){SA.Debug("AJAX - error() : session"),self.Run2()}}):SA.Run2()},SA.Run2=function(){self=SA,(SA.ViewId==""||SA.ViewId=="None")&&delete SA.ViewId,(SA.SessionId==""||SA.SessionId=="None")&&delete SA.SessionId;var e=new SA.Note;if(SA.ViewId=="presentation"){var t=window.prompt("Please enter the presentation title.","SlideShow");if(t==null)return;e.Title=t,e.HiddenTitle=t,e.Text="",e.Type="HTML",j(e)}else{if(SA.ViewId==""){SA.Debug("Missing view id");return}e.LoadViewId(SA.ViewId,function(){j(e)})}},SA.HandleKeyDownStack=function(e){return SA.ContentEditableHasFocus?!0:e.keyCode==16?(SA.ShiftKeyPressed=!0,!0):e.keyCode==17?(SA.ControlKeyPressed=!0,!0):SA.ControlKeyPressed&&e.keyCode==90?(SA.recorderWidget.UndoState(),!1):SA.ControlKeyPressed&&e.keyCode==89?(SA.recorderWidget.RedoState(),!1):SA.presentation?(SA.presentation.HandleKeyDown(e),!0):!0},SA.HandleKeyUpStack=function(e){if(SA.ContentEditableHasFocus)return!0;if(e.keyCode==90&&e.shiftKey)return SA.DeformableAlignViewers(!1),!0;if(e.keyCode==89&&e.shiftKey)return SA.DeformableAlignViewers(!0),!0;if(e.keyCode==88){SA.StackCursorFlag=!SA.StackCursorFlag;if(e.shiftKey&&SA.StackCursorFlag){SA.testAlignTranslation();var t=SA;window.setTimeout(function(){t.StackCursorFlag=!1},1e3)}return SA.display.EventuallyRender(),!1}return e.keyCode==16?SA.ShiftKeyPressed=!1:e.keyCode==17&&(SA.ControlKeyPressed=!1),SA.presentation?(SA.presentation.HandleKeyUp(e),!0):!0},SA.OnStartInteraction=function(e){SA.StartInteractionListeners.push(e)},SA.TriggerStartInteraction=function(){if(!SA.StartInteractionListeners)return;for(var e=0;e<SA.StartInteractionListeners.length;++e)callback=SA.StartInteractionListeners[e],callback()},SA.TagCompare=function(e,t,n){return n?e.toUpperCase()==t.substring(0,e.length).toUpperCase():t.toUpperCase().search(e.toUpperCase())},SA.AddHtmlTags=function(e){var t=undefined,n=[{string:"History:","class":"sa-history"},{string:"Diagnosis:","class":"sa-diagnosis"},{string:"Differential Diagnosis:","class":"sa-differential-diagnosis"},{string:"Teaching Points:","class":"sa-teaching-points"},{string:"Compare with:","class":"sa-compare"},{string:"Notes:","class":"sa-notes"}],r=e.children();for(var i=0;i<r.length;++i){var s=$(r[i]),o=undefined;for(var u=0;u<n.length;++u)s.hasClass(n[u].class)&&(o=n[u]);if(o){t=undefined;continue}if(s.hasClass("sa-ssc-title")){t=undefined;continue}var a=s.text();SA.TagCompare("SSC",a,!0)&&!s.hasClass("sa-ssc-title")&&s.addClass("sa-ssc-title");if(s.children().length>1)for(var u=0;u<n.length;++u){var f=n[u];if(SA.TagCompare(f.string,a,!1)>0){var l=s.children();l.remove(),l.insertAfter(s),r=e.children(),a=s.text();break}}var o=!1;for(var u=0;u<n.length;++u){var f=n[u];if(SA.TagCompare(f.string,a,!0)){o=f;break}}if(o){if(s[0].tagName=="DIV"){var l=s.children();s.empty(),l.insertAfter(s),r=e.children(),t=s,++i,s=$(r[i])}else t=$("<div>").insertBefore(s),r=e.children(),++i;t.addClass(o.class)}t&&(s.remove(),s.appendTo(t),r=e.children(),--i)}},SA.GetSelectionRange=function(e){var t=window.getSelection(),n,r=null;if(t.rangeCount>0){n=t.getRangeAt(0),n.noCursor=!1,r=n.commonAncestorContainer;while(r&&r!=e[0])r&&(r=r.parentNode)}return r?n:null},SA.MakeSelectionRange=function(e){var t=window.getSelection();e[0].focus();var n=$("<br>").appendTo(e),r=document.createRange();return r.selectNode(n[0]),t.removeAllRanges(),t.addRange(r),r},SA.GetUser=function(){return typeof SA.User!="undefined"?SA.User:(SA.Debug("Could not find user"),"")},SA.initWebGL=function(e){p(e)},SA.createWebGlProgram=function(e,t,n){var r=l(n,n.FRAGMENT_SHADER,e),i=l(n,n.VERTEX_SHADER,t),s=n.createProgram();return n.attachShader(s,i),n.attachShader(s,r),n.linkProgram(s),n.getProgramParameter(s,n.LINK_STATUS)||SA.Debug("Could not initialise shaders"),s.vertexPositionAttribute=n.getAttribLocation(s,"aVertexPosition"),n.enableVertexAttribArray(s.vertexPositionAttribute),s.pMatrixUniform=n.getUniformLocation(s,"uPMatrix"),s.mvMatrixUniform=n.getUniformLocation(s,"uMVMatrix"),s};var v=[],m=[1,0,0,1,0,0],E=!1,S=[],N,C,k,L;SA.cancelContextMenu=function(e){return e&&e.stopPropagation&&e.stopPropagation(),!1}}();window.SA=window.SA||{},function(){"use strict";SA.setCookie=function(e,t,n){var r=new Date;r.setDate(r.getDate()+n);var i=escape(t)+(n==null?"":"; expires="+r.toUTCString());document.cookie=e+"="+i},SA.getCookie=function(e){var t,n,r,i=document.cookie.split(";");for(t=0;t<i.length;t++){n=i[t].substr(0,i[t].indexOf("=")),r=i[t].substr(i[t].indexOf("=")+1),n=n.replace(/^\s+|\s+$/g,"");if(n==e)return unescape(r)}}}();window.SA=window.SA||{},function(){"use strict";if(!e)var e={cookie:""};var t=function(){function a(){if(!(this instanceof t))return(new t(arguments[0],arguments[1],arguments[2],arguments[3])).toString();typeof arguments[0]=="object"?(this.timestamp=arguments[0].timestamp,this.machine=arguments[0].machine,this.pid=arguments[0].pid,this.increment=arguments[0].increment):typeof arguments[0]=="string"&&arguments[0].length==24?(this.timestamp=Number("0x"+arguments[0].substr(0,8)),this.machine=Number("0x"+arguments[0].substr(8,6)),this.pid=Number("0x"+arguments[0].substr(14,4)),this.increment=Number("0x"+arguments[0].substr(18,6))):arguments.length==4&&arguments[0]!=null?(this.timestamp=arguments[0],this.machine=arguments[1],this.pid=arguments[2],this.increment=arguments[3]):(this.timestamp=Math.floor((new Date).valueOf()/1e3),this.machine=i,this.pid=r,this.increment=n++,n>16777215&&(n=0))}var n=Math.floor(Math.random()*16777216),r=Math.floor(Math.random()*65536),i=Math.floor(Math.random()*16777216),s=function(){var t=e.cookie.split("; ");for(var n in t){var r=t[n].split("="),s=parseInt(r[1],10);if(r[0]=="mongoMachineId"&&s&&s>=0&&s<=16777215){i=s;break}}e.cookie="mongoMachineId="+i+";expires=Tue, 19 Jan 2038 05:00:00 GMT;path=/"};if(typeof localStorage!="undefined")try{var o=parseInt(localStorage.mongoMachineId);o>=0&&o<=16777215&&(i=Math.floor(localStorage.mongoMachineId)),localStorage.mongoMachineId=i}catch(u){s()}else s();return a}();t.prototype.getDate=function(){return new Date(this.timestamp*1e3)},t.prototype.toArray=function(){var e=this.toString(),t=[],n;for(n=0;n<12;n++)t[n]=parseInt(e.slice(n*2,n*2+2),16);return t},t.prototype.toString=function(){if(this.timestamp===undefined||this.machine===undefined||this.pid===undefined||this.increment===undefined)return"Invalid ObjectId";var e=this.timestamp.toString(16),t=this.machine.toString(16),n=this.pid.toString(16),r=this.increment.toString(16);return"00000000".substr(0,8-e.length)+e+"000000".substr(0,6-t.length)+t+"0000".substr(0,4-n.length)+n+"000000".substr(0,6-r.length)+r},SA.ObjectId=t}();window.SA=window.SA||{},function(){"use strict";function e(e,n){var r=this;this.Viewer=e,this.OtherViewer=n,this.Tab=new SA.Tab(e.GetDiv(),SA.ImagePathUrl+"Menu.jpg","editTab"),this.Tab.Div.css({position:"absolute",right:"47px",bottom:"0px","z-index":"200"}).prop("title","View Menu"),this.Tab.Panel.addClass("sa-view-edit-panel"),SA.VIEW_BROWSER&&$("<button>").appendTo(this.Tab.Panel).text("Load Slide").addClass("sa-view-edit-button").click(function(){r.Tab.PanelOff(),SA.VIEW_BROWSER.Open(r.Viewer)}),SA.Edit&&$("<button>").appendTo(this.Tab.Panel).text("Save View").addClass("sa-view-edit-button").click(function(){r.SaveView()}),SA.notesWidget&&($("<button>").appendTo(this.Tab.Panel).text("Download Image").addClass("sa-view-edit-button").click(function(){r.Tab.PanelOff(),t(r.Viewer)}),$("<button>").appendTo(this.Tab.Panel).text("Slide Info").addClass("sa-view-edit-button").click(function(){r.ShowSlideInformation()}),SA.recorderWidget.TimeLine&&(this.HistoryMenuItem=$("<button>").appendTo(this.Tab.Panel).text("History On").addClass("sa-view-edit-button").click(function(){r.ToggleHistory()})),this.OtherViewer&&(this.CopyZoomMenuItem=$("<button>").appendTo(this.Tab.Panel).text("Copy Zoom").hide().addClass("sa-view-edit-button").click(function(){r.CopyZoom()})),$("<button>").appendTo(this.Tab.Panel).text("Flip Horizontal").addClass("sa-view-edit-button").click(function(){r.FlipHorizontal()}),SA.Edit?$("<button>").appendTo(this.Tab.Panel).text("Save Overview Bounds").addClass("sa-view-edit-button").click(function(){r.SetViewBounds()}):$("<button>").appendTo(this.Tab.Panel).text("Set Overview Bounds").addClass("sa-view-edit-button").click(function(){r.SetViewBounds()}))}function n(e,t){var n=this;this.Editable=t,this.Body=$("<div>").appendTo(e).css({"background-color":"white","border-style":"solid","border-width":"1px","border-radius":"5px",position:"absolute",top:"30%",left:"30%",width:"40%",height:"40%",overflow:"auto",padding:"10px","z-index":"4",color:"#303030","font-size":"20px"}).hide().mouseleave(function(){n.Close()}),this.TitleInput=$("<div>").css({width:"100%",cursor:"text","white-space":"nowrap","margin-bottom":"5px"}).appendTo(this.Body).keypress(function(e){return e.keyCode!=13}),t&&this.TitleInput.attr("contenteditable","true").css({background:"#f0f0ff"}),this.CopyrightDiv=$("<div>").css({width:"100%",display:"inline-block"}).appendTo(this.Body).addClass("sa-view-annotation-modal-div"),this.CopyrightLabel=$("<div>").appendTo(this.CopyrightDiv).text("Copyright:"),this.CopyrightInput=$("<div>").css({width:"300px",cursor:"text"}).appendTo(this.CopyrightDiv).keypress(function(e){return e.keyCode!=13}),t&&this.CopyrightInput.attr("contenteditable","true").css({background:"#f0f0ff"}),this.ResolutionDiv=$("<div>").appendTo(this.Body).addClass("sa-view-annotation-modal-div"),this.ResolutionLabel=$("<div>").appendTo(this.ResolutionDiv).text("Resolution:").addClass("sa-view-annotation-modal-input-label"),this.ResolutionInput=$("<div>").appendTo(this.ResolutionDiv),this.ResolutionUnitsInput=$("<div>").appendTo(this.ResolutionDiv),t&&(this.ResolutionInput.attr("contenteditable","true").css({background:"#f0f0ff",cursor:"text"}).keypress(function(e){return e.keyCode!=13}),this.ResolutionUnitsInput.attr("contenteditable","true").css({background:"#f0f0ff",cursor:"text"}).attr("contenteditable","true").keypress(function(e){return e.keyCode!=13})),this.FileNameDiv=$("<div>").appendTo(this.Body).addClass("sa-view-annotation-modal-div"),this.CreatedDiv=$("<div>").appendTo(this.Body).addClass("sa-view-annotation-modal-div"),this.DimensionsDiv=$("<div>").appendTo(this.Body).addClass("sa-view-annotation-modal-div"),this.LevelsDiv=$("<div>").appendTo(this.Body).addClass("sa-view-annotation-modal-div")}SA.VIEW_BROWSER,e.prototype.SetVisibility=function(e){e?this.Tab.show():this.Tab.hide()},e.prototype.DetectTissueSections=function(){initHagfish(),findHagFishSections(2,2e-4,.01)},e.prototype.ToggleHistory=function(){this.Tab.PanelOff(),this.Viewer.HistoryFlag=!this.Viewer.HitoryFlag,this.Viewer.HistoryFlag?this.HistoryMenuItem.text("History Off"):this.HistoryMenuItem.text("History On"),SA.display.EventuallyRender()},e.prototype.SaveView=function(){this.Tab.PanelOff(),SA.notesWidget&&SA.notesWidget.SaveCallback()},e.prototype.GetViewerBounds=function(e){var t=e.GetCamera(),n=t.GetFocalPoint(),r=t.GetWidth()/2,i=t.GetHeight()/2;return[n[0]-r,n[0]+r,n[1]-i,n[1]+i]},e.prototype.SetViewBounds=function(){this.Tab.PanelOff();var e=this.GetViewerBounds(this.Viewer),t=SA.display.GetNote(),n=t.ViewerRecords[this.Viewer.RecordIndex];n.OverviewBounds=e,n.Image.bounds=n.OverviewBounds,this.Viewer.OverView.Camera.SetFocalPoint([(e[0]+e[1])/2,(e[2]+e[3])/2]),this.Viewer.OverView.Camera.SetHeight(e[3]-e[2]),this.Viewer.OverView.Camera.ComputeMatrix(),eventuallyRender();var r=this;if(SA.Edit){var i=JSON.stringify(t.Serialize(!0)),s=new Date;$.ajax({type:"post",url:"webgl-viewer/saveviewnotes",data:{note:i,date:s.getTime()},success:function(e,t){r.Viewer.EventuallyRender()},error:function(){SA.Debug("AJAX - error() : saveviewnotes (bounds)")}})}},e.prototype.SetImageBounds=function(){this.Tab.PanelOff();var e=this.Viewer,t=e.GetCache().Image.database,n=e.GetCache().Image._id,r=this.GetViewerBounds(e);e.GetCache().Image.bounds=r,e.OverView.Camera.SetFocalPoint([(r[0]+r[1])/2,(r[2]+r[3])/2]),e.OverView.Camera.SetHeight(r[3]-r[2]),e.OverView.Camera.ComputeMatrix(),eventuallyRender();var i=JSON.stringify(r);$.ajax({type:"post",url:"webgl-viewer/set-image-bounds",data:{img:n,imgdb:t,bds:JSON.stringify(r)},success:function(e,t){},error:function(){SA.Debug("AJAX - error() : saveusernote 1")}})},e.prototype.CopyZoom=function(){this.Tab.PanelOff();var e=this.Viewer.GetCamera(),t,t=this.OtherViewer.GetCamera();this.Viewer.AnimateCamera(e.GetFocalPoint(),e.Roll,t.Height)},e.prototype.ShowSlideInformation=function(){this.Tab.PanelOff();var e=this.Viewer.MainView.Section.Caches[0].Image;SA.SlideInformation.Open(e,this.Viewer)},e.prototype.FlipHorizontal=function(){this.Tab.PanelOff();if(!this.Viewer)return;var e=this.Viewer.GetCamera();this.Viewer.ToggleMirror(),this.Viewer.SetCamera(e.GetFocalPoint(),e.GetRotation()+180,e.Height),SA.RecordState()};var t=function(){function t(t){SA.VIEWER=t,e||n();var r=t.GetViewport(),i=e.DimensionDialog;i.PxWidthInput.val(r[2]),i.PxHeightInput.val(r[3]);var s=parseInt(i.SizeResInput.val());i.SizeWidthInput.val((r[2]/s).toFixed(2)),i.SizeHeightInput.val((r[3]/s).toFixed(2)),i.AspectRatio=r[2]/r[3],SA.display.GetNote().Type=="Stack"?e.DimensionDialog.StackDiv.show():e.DimensionDialog.StackDiv.hide(),e.DimensionDialog.Show(1)}function n(){e={};var t=function(){e.Viewer&&(e.Viewer.CancelLargeImage(),e.Viewer=undefined)},n=function(){e.Viewer=SA.VIEWER;var t=parseInt(e.DimensionDialog.PxWidthInput.val()),n=parseInt(e.DimensionDialog.PxHeightInput.val()),r=e.DimensionDialog.StackCheckbox.prop("checked");e.CancelDialog.Show(1),r?e.CancelDialog.StackMessage.show():e.CancelDialog.StackMessage.hide(),SA.VIEWER.SaveLargeImage("slide-atlas.png",t,n,r,function(){e.Viewer=undefined,e.CancelDialog.Hide()})},a=new SAM.Dialog(n);a.Body.css({margin:"1em 2em","padding-bottom":"2em","padding-right":"3em"}),e.DimensionDialog=a,a.Title.text("Download Image"),a.PxDiv=$("<div>").appendTo(a.Body).css({border:"1px solid #555",margin:"15px","padding-left":"5px"}),a.PxLabel=$("<div>").appendTo(a.PxDiv).text("Dimensions:").css({position:"relative",top:"-9px",display:"inline-block","background-color":"white"}),a.PxWidthDiv=$("<div>").appendTo(a.PxDiv).css({display:"table-row"}),a.PxWidthLabel=$("<div>").appendTo(a.PxWidthDiv).text("Width:").css({display:"table-cell","text-align":"right",width:"6em"}),a.PxWidthInput=$('<input type="number">').appendTo(a.PxWidthDiv).val("1900").css({display:"table-cell",width:"100px",margin:"5px"}).change(function(){r()}),a.PxWidthUnits=$("<div>").appendTo(a.PxWidthDiv).text("Pixels").css({display:"table-cell","text-align":"left"}),a.PxHeightDiv=$("<div>").appendTo(a.PxDiv).css({display:"table-row",margin:"5px"}),a.PxHeightLabel=$("<div>").appendTo(a.PxHeightDiv).text("Height:").css({display:"table-cell","text-align":"right"}),a.PxHeightInput=$('<input type="number">').appendTo(a.PxHeightDiv).val("1080").css({display:"table-cell",width:"100px",margin:"5px"}).change(function(){i()}),a.PxHeightUnits=$("<div>").appendTo(a.PxHeightDiv).text("Pixels").css({display:"table-cell","text-align":"left"}),a.SizeDiv=$("<div>").appendTo(a.Body).css({border:"1px solid #555",margin:"15px","padding-left":"5px"}),a.SizeLabel=$("<div>").appendTo(a.SizeDiv).text("Document Size:").css({position:"relative",top:"-9px",display:"inline-block","background-color":"white"}),a.SizeWidthDiv=$("<div>").appendTo(a.SizeDiv).css({display:"table-row",margin:"5px"}),a.SizeWidthLabel=$("<div>").appendTo(a.SizeWidthDiv).text("Width:").css({display:"table-cell","text-align":"right",width:"6em"}),a.SizeWidthInput=$('<input type="number">').appendTo(a.SizeWidthDiv).val("1900").css({display:"table-cell",width:"100px",margin:"5px"}).change(function(){s()}),a.SizeWidthUnits=$("<div>").appendTo(a.SizeWidthDiv).text("Inches").css({display:"table-cell","text-align":"left"}),a.SizeHeightDiv=$("<div>").appendTo(a.SizeDiv).css({display:"table-row",margin:"5px"}),a.SizeHeightLabel=$("<div>").appendTo(a.SizeHeightDiv).text("Height:").css({display:"table-cell","text-align":"right"}),a.SizeHeightInput=$('<input type="number">').appendTo(a.SizeHeightDiv).val("1900").css({display:"table-cell",width:"100px",margin:"5px"}).change(function(){o()}),a.SizeHeightUnits=$("<div>").appendTo(a.SizeHeightDiv).text("Inches").css({display:"table-cell","text-align":"left"}),a.SizeResDiv=$("<div>").appendTo(a.SizeDiv).css({display:"table-row",margin:"5px"}),a.SizeResLabel=$("<div>").appendTo(a.SizeResDiv).text("Resolution:").css({display:"table-cell","text-align":"right"}),a.SizeResInput=$('<input type="number">').appendTo(a.SizeResDiv).val("72").css({display:"table-cell",width:"100px",margin:"5px"}).change(function(){u()}),a.SizeResUnits=$("<div>").appendTo(a.SizeResDiv).text("Pixels/Inch").css({display:"table-cell","text-align":"left"}),a.ProportionsDiv=$("<div>").appendTo(a.Body).css({margin:"15px","padding-left":"5px"}),a.ProportionsLabel=$("<div>").appendTo(a.ProportionsDiv).text("Constrain Proportions:").css({display:"inline"}),a.ProportionsCheckbox=$('<input type="checkbox">').appendTo(a.ProportionsDiv).css({display:"inline"}).prop("checked",!0),a.StackDiv=$("<div>").appendTo(a.Body).css({margin:"15px","padding-left":"5px"}).hide(),a.StackLabel=$("<div>").appendTo(a.StackDiv).text("All stack sections:").css({display:"inline"}),a.StackCheckbox=$('<input type="checkbox">').appendTo(a.StackDiv).css({display:"inline"}).prop("checked",!1),a.AspectRatio=1,a=new SAM.Dialog(t),e.CancelDialog=a,a.Title.text("Processing"),a.WaitingImage=$("<img>").appendTo(a.Body).attr("src",SA.ImagePathUrl+"circular.gif").attr("alt","waiting...").css({width:"40px"}),a.StackMessage=$("<div>").appendTo(a.Body).text("Downloading multiple images.  Turn off browser's prompt-on-download option.").hide(),a.ApplyButton.text("Cancel")}function r(){var t=e.DimensionDialog,n=parseInt(t.SizeResInput.val()),r=parseInt(t.PxWidthInput.val());t.SizeWidthInput.val((r/n).toFixed(2));if(t.ProportionsCheckbox.prop("checked")){var i=r/t.AspectRatio;t.PxHeightInput.val(i.toFixed()),t.SizeHeightInput.val((i/n).toFixed(2))}else{var i=parseInt(t.PxHeightInput.val());t.AspectRatio=r/i}}function i(){var t=e.DimensionDialog,n=parseInt(t.SizeResInput.val()),r=parseInt(t.PxHeightInput.val());t.SizeHeightInput.val((r/n).toFixed(2));if(t.ProportionsCheckbox.prop("checked")){var i=r*t.AspectRatio;t.PxWidthInput.val(i.toFixed()),t.SizeWidthInput.val((i/n).toFixed(2))}else{var i=parseInt(t.PxWidthInput.val());t.AspectRatio=i/r}}function s(){var t=e.DimensionDialog,n=parseInt(t.SizeResInput.val()),r=parseInt(t.SizeWidthInput.val());t.PxWidthInput.val((r*n).toFixed());if(t.ProportionsCheckbox.prop("checked")){var i=r/t.AspectRatio;t.SizeHeightInput.val(i.toFixed(2)),t.PxHeightInput.val((i*n).toFixed())}else{var i=parseInt(t.SizeHeightInput.val());t.AspectRatio=r/i}}function o(){var t=e.DimensionDialog,n=parseInt(t.SizeResInput.val()),r=parseInt(t.SizeHeightInput.val());t.PxHeightInput.val((r*n).toFixed());if(t.ProportionsCheckbox.prop("checked")){var i=r*t.AspectRatio;t.SizeWidthInput.val(i.toFixed(2)),t.PxWidthInput.val((i*n).toFixed())}else{var i=parseInt(t.SizeWidthInput.val());t.AspectRatio=i/r}}function u(){var t=e.DimensionDialog,n=parseInt(t.SizeResInput.val()),r=parseInt(t.SizeHeightInput.val()),i=parseInt(t.SizeWidthInput.val());t.PxHeightInput.val((r*n).toFixed()),t.PxWidthInput.val((i*n).toFixed())}var e=undefined;return t}();SA.InitSlideSelector=function(e){$("<div>").appendTo(e).css({"background-color":"white","border-style":"solid","border-width":"1px","border-radius":"5px",position:"absolute",top:"35px",left:"35px",width:"500px",height:"700px",overflow:"auto","z-index":"4",color:"#303030","font-size":"20px"}).attr("id","sessionMenu").hide().mouseleave(function(){$(this).fadeOut()}),$("<ul>").appendTo("#sessionMenu").attr("id","sessionMenuSelector"),$("<div>").appendTo(e).css({"background-color":"white","border-style":"solid","border-width":"1px","border-radius":"5px",position:"absolute",top:"135px",left:"135px",width:"500px",height:"700px",overflow:"auto","z-index":"4",color:"#303030","font-size":"20px"}).attr("id","viewMenu").hide().mouseleave(function(){$(this).fadeOut()}),$("<ul>").appendTo("#viewMenu").attr("id","viewMenuSelector"),SA.SlideInformation=new n(e,SA.Edit)},n.prototype.Open=function(e,t){this.Viewer=t,this.ImageObj=e,this.TitleInput.text(e.label),this.FileNameDiv.text("File Name: "+e.filename),this.CreatedDiv.text("Created: "+e.uploaded_at),this.DimensionsDiv.text("Dimensions: "+e.dimensions[0]+", "+e.dimensions[1]),this.LevelsDiv.text("Levels: "+e.levels),this.CopyrightInput.text(e.copyright);var n;e.units?n={value:e.spacing[0],units:e.units}:n={value:.25,units:"µm"},SAM.ConvertForGui(n),this.ResolutionInput.text(n.value.toString()),this.ResolutionUnitsInput.text(n.units.toString()),this.Body.show()},n.prototype.Close=function(){if(this.Editable){this.ImageObj.label=this.TitleInput.text(),this.ImageObj.copyright=this.CopyrightInput.text();var e={value:parseFloat(this.ResolutionInput.text()),units:this.ResolutionUnitsInput.text()};SAM.ConvertToMeters(e),this.ImageObj.spacing[0]=this.ImageObj.spacing[1]=e.value,this.ImageObj.units=e.units}this.Body.fadeOut();if(!this.Editable)return;this.ImageObj.dimensions.length<3&&this.ImageObj.dimensions.push(1);var t={_id:this.ImageObj._id,database:this.ImageObj.database,label:this.ImageObj.label,copyright:this.ImageObj.copyright,spacing:this.ImageObj.spacing,units:this.ImageObj.units},n=this;$.ajax({type:"post",url:"webgl-viewer/saveimagedata",data:{metadata:JSON.stringify(t)},success:function(e,t){n.Viewer&&n.Viewer.EventuallyRender()},error:function(){SA.Debug("AJAX - error() : saveimagedata")}})},SA.ViewEditMenu=e}();window.SA=window.SA||{},function(){"use strict";function e(e){var t=this;this.Div=$("<div>").appendTo(e).hide().css({position:"absolute",top:"5%",height:"80%",left:"10%",width:"70%",padding:"5%","z-index":"1007","text-align":"left",color:"#303030"}).mouseleave(function(){t.Div.fadeOut()}),this.TabbedDiv=new SA.TabbedDiv(this.Div),this.BrowserDiv=this.TabbedDiv.NewTabDiv("Browser"),this.BrowserDiv.css({"overflow-y":"auto"}),this.SearchDiv=this.TabbedDiv.NewTabDiv("Search"),this.ClipboardDiv=this.TabbedDiv.NewTabDiv("Clipboard"),this.BrowserPanel=new n(this.BrowserDiv,function(e){t.SelectView(e)}),this.SearchPanel=new SA.SearchPanel(this.SearchDiv,function(e){t.SelectImage(e)}),this.ClipboardPanel=new SA.ClipboardPanel(this.ClipboardDiv,function(e){t.SelectView(e)}),this.Viewer=null}function t(e,t,n,r){var i=this;this.Data=n,this.InitializeCallback=r,this.TitleDiv=$("<div>").css({position:"relative"}).appendTo(e),this.Bullet=$("<span>").appendTo(this.TitleDiv).css({position:"absolute",left:"0px",top:"1px",opacity:"0.75"}).addClass("ui-icon ui-icon-plus").on("click.open",function(){i.OpenCallback()}).addClass("saButton"),this.Title=$("<div>").appendTo(this.TitleDiv).css({"margin-left":"20px"}),this.Label=$("<div>").appendTo(this.Title).css({display:"block"}).text(t),this.List=$("<ul>").appendTo(e).addClass("sa-ul").hide()}function n(e,t){this.BrowserDiv=e,this.SelectView=t,this.BrowserInfo=null,this.ReloadViewBrowserInfo(),this.ProgressCount=0}e.prototype.SelectView=function(e){e==null&&(this.Viewer.SetCache(null),eventuallyRender());var t=new SA.ViewerRecord;t.Load(e.ViewerRecords[0]),t.Apply(this.Viewer)},e.prototype.SelectImage=function(e){this.Div.fadeOut();var t=SA.FindCache(e);this.Viewer.Reset(),this.Viewer.SetCache(t),SA.RecordState(),eventuallyRender()},e.prototype.Open=function(e){this.Viewer=e;if(!e)return;this.Div.show()},t.prototype.OpenCallback=function(){var e=this;this.InitializeCallback&&(this.InitializeCallback(this),delete this.InitializeCallback),this.Bullet.off("click.open").removeClass("ui-icon-plus").addClass("ui-icon-minus").on("click.close",function(){e.CloseCallback()}),this.List.show()},t.prototype.CloseCallback=function(){var e=this;this.Bullet.off("click.close").removeClass("ui-icon-minus").addClass("ui-icon-plus").on("click.open",function(){e.OpenCallback()}),this.List.hide()},n.prototype.PushProgress=function(){this.BrowserDiv.css({cursor:"progress"}),this.ProgressCount+=1},n.prototype.PopProgress=function(){this.ProgressCount-=1,this.ProgressCount<=0&&this.BrowserDiv.css({cursor:"default"})},n.prototype.LoadGUI=function(){var e=this,n=this.BrowserInfo;this.BrowserDiv.empty();var r=$("<ul>").addClass("sa-ul").appendTo(this.BrowserDiv);for(var i=0;i<n.sessions.length;++i){var s=$("<li>").appendTo(r),o=n.sessions[i],u=new t(s,o.rule),a=u.List;for(var f=0;f<o.sessions.length;++f){var l=o.sessions[f],c={db:l.sessdb,sessid:l.sessid},h=$("<li>").appendTo(a);new t(h,l.label,c,function(t){e.RequestSessionViews(t)})}}},n.prototype.ReloadViewBrowserInfo=function(){var e=this;this.PushProgress(),$.get("/sessions?json=true",function(t,n){e.PopProgress(),n=="success"?(e.BrowserInfo=t,e.LoadGUI(t)):SA.Debug("ajax failed.")})},n.prototype.RequestSessionViews=function(e){var t=this;this.PushProgress();var n=e.Data.sessid;$.get("/sessions?json=true&sessid="+n,function(n,r){t.PopProgress(),r=="success"?t.AddSessionViews(e,n):SA.Debug("ajax failed.")})},n.prototype.AddSessionViews=function(e,t){var n=this,r=e.List;for(var i=0;i<t.images.length;++i){var s=t.images[i],o=n.AddViewFolder(r,s.label,s.view);this.RequestViewChildren(o)}},n.prototype.AddViewFolder=function(e,n,r){var i=this,s=$("<li>").appendTo(e),o={viewid:r},u=new t(s,n,o);return u.Bullet.hide(),u.Title.click(function(){i.ViewClickCallback(u)}).addClass("saButton"),u},n.prototype.RequestViewChildren=function(e){var t=this;this.PushProgress();var n=e.Data.viewid;$.ajax({type:"get",url:"/webgl-viewer/getview",data:{viewid:n},success:function(n,r){t.PopProgress(),t.LoadViewChildren(e,n)},error:function(){SA.Debug("AJAX - error() : getview"),t.PopProgress()}})},n.prototype.LoadViewChildren=function(e,t){if(t.Type=="HTML"){var n=$("<div>").appendTo(e.Title).css({position:"relative",height:"100px",width:"134px","margin-bottom":"2px",overflow:"hidden",border:"1px solid #AAA"}),r=$("<div>").appendTo(n).saPresentation({aspectRatio:1.3333});r.saHtml(t.Text),r.trigger("resize"),r.find(".sa-element").saElement({editable:!1,interactive:!1}),r.find(".sa-viewer").saElement({hideCopyright:!0});if(!t.Title||t.Title==""){var i=r.find(".sa-presentation-title");i.length>0&&e.Label.text(i.text())}}else if(t.ViewerRecords&&t.ViewerRecords.length>0){var s=t.ViewerRecords[0].Image;$("<img>").appendTo(e.Title).attr("src","/thumb?db="+s.database+"&img="+s._id).css({height:"50px",display:"block"})}if(!t.Children||t.Children.length<1)return;e.Bullet.show();for(var o=0;o<t.Children.length;++o){var u=t.Children[o],a=this.AddViewFolder(e.List,u.Title,u._id);this.LoadViewChildren(a,u)}},n.prototype.ViewClickCallback=function(e){var t=this,n=e.Data.viewid;this.PushProgress(),$.ajax({type:"get",url:"/webgl-viewer/getview",data:{viewid:n},success:function(e,n){t.PopProgress(),t.SelectView(e)},error:function(){t.PopProgress(),SA.Debug("AJAX - error() : getview (browser)")}})},SA.BrowserPanel=n,SA.ViewBrowser=e}();window.SA=window.SA||{},function(){"use strict";function e(e){var t=this;this.Viewers=[],this.ViewerDivs=[],this.saNote=null,this.saNoteStartIndex=0,this.Parent=e,e.addClass("sa-dual-viewer");var n=e.innerWidth(),r=e.innerHeight(),i=n/2;for(var s=0;s<2;++s){var o=$("<div>").appendTo(e).saViewer({overview:!0,zoomWidget:!0}).addClass("sa-view-canvas-div");this.ViewerDivs[s]=o,this.Viewers[s]=o[0].saViewer,this.Viewers[s].RecordIndex=s}SA.VIEWERS=this.Viewers,SA.VIEWER1=this.Viewers[0],SA.VIEWER2=this.Viewers[1],this.DualView=!1,this.Viewer1Fraction=1,this.AnimationLastTime=0,this.AnimationDuration=0,this.AnimationTarget=0,this.NavigationWidget=new SA.NavigationWidget(e,this),SAM.MOBILE_DEVICE?this.NavigationWidget.SetVisibility(!1):($("<img>").appendTo(this.ViewerDivs[0]).css({position:"absolute",right:"0px",top:"0px"}).addClass("sa-view-dualview-div").attr("id","dualWidgetLeft").attr("src",SA.ImagePathUrl+"dualArrowLeft2.png").click(function(){t.ToggleDualView()}).attr("draggable","false").on("dragstart",function(){return!1}),$("<img>").appendTo(e).appendTo(this.ViewerDivs[1]).css({position:"absolute",left:"0px",top:"0px"}).hide().addClass("sa-view-dualview-img").attr("id","dualWidgetRight").attr("src",SA.ImagePathUrl+"dualArrowRight2.png").click(function(){t.ToggleDualView()}).attr("draggable","false").on("dragstart",function(){return!1}))}SA.VIEWERS=[],SA.VIEWER1,SA.VIEWER2,e.prototype.EventuallyRender=function(){for(var e=0;e<this.Viewers.length;++e)this.GetViewer(e).EventuallyRender(!1)},e.prototype.Record=function(e,t){t&&(e.StartIndex=t),t=t||0;if(e.Type!="Stack"){!this.DualView&&e.ViewerRecords.length>1&&(e.ViewerRecords=[e.ViewerRecords[0]]);if(this.DualView&&e.ViewerRecords.length<2)while(e.ViewerRecords.length<2)e.ViewerRecords.push(new SA.ViewerRecord)}for(var n=0;n<this.GetNumberOfViewers();++n)n+t<e.ViewerRecords.length&&this.GetViewer(n).Record(e,n+t)},e.prototype.ProcessArguments=function(e){e.note&&(this.SetNote(e.note,e.viewIndex),this.Parent.attr("sa-note-id",e.note.Id||e.note.TempId));if(e.tileSource){var t=e.tileSource.width,n=e.tileSource.height,r=new SA.Cache;r.TileSource=e.tileSource;var i=new SA.Note,s={levels:e.maxLevel+1,dimensions:[t,n],bounds:[0,t-1,0,n-1],_id:i.TempId},o=new SA.ViewerRecord;o.Image=s,o.OverviewBounds=[0,t-1,0,n-1],o.Camera={FocalPoint:[t/2,n/2],Roll:0,Height:n},i.ViewerRecords.push(o),r.SetImageData(s),this.SetNote(e.note,e.viewIndex)}for(var u=0;u<this.Viewers.length;++u){var a=this.Viewers[u];e.hideCopyright!=undefined&&a.SetCopyrightVisibility(!e.hideCopyright),e.overview!==undefined&&a.SetOverViewVisibility(e.overview),e.navigation!==undefined&&this.NavigationWidget.SetVisibility(e.navigation),e.dualWidget!==undefined&&(this.HideHandles=!e.dualWidget,this.UpdateGui()),e.zoomWidget!==undefined&&a.SetZoomWidgetVisibility(e.zoomWidget),e.drawWidget!==undefined&&a.SetAnnotationWidgetVisibility(e.drawWidget),e.menu!==undefined&&(a.Menu||(a.Menu=new SA.ViewEditMenu(a,null)),a.Menu.SetVisibility(e.menu)),e.interaction!==undefined&&(a.SetInteractionEnabled(e.interaction),this.NavigationWidget&&this.NavigationWidget.SetInteractionEnabled(e.interaction))}},e.prototype.RecordAnnotations=function(){SA.Edit&&this.saNote&&this.saNote.RecordAnnotations(this)},e.prototype.SetNote=function(e){var t=this;if(e&&e.LoadState!=2){e.LoadViewId(e.Id,function(){t.SetNote(e)});return}this.saNote=e,this.saNoteStartIdx=e.StartIndex;var n=e.StartIndex||0;if(!e||n<0||n>=e.ViewerRecords.length){console.log("Cannot set viewer record of note");return}this.saViewerIndex=n,this.NavigationWidget&&this.NavigationWidget.SetNote(e),this.DisplayNote(e);if(e.Type=="Stack"){var t=this;this.GetViewer(0).OnInteraction(function(){t.SynchronizeViews(0,e)}),this.GetViewer(1).OnInteraction(function(){t.SynchronizeViews(1,e)}),e.DisplayStack(this),this.SynchronizeViews(0,e)}},e.prototype.DisplayNote=function(e){var t=this.GetNumberOfViewers();if(t==0)return;e.Type=="Stack"&&(t=2);for(var n=0;n<t;++n)this.GetViewer(n).Reset();e.Type!="Stack"&&(t=e.ViewerRecords.length,this.SetNumberOfViewers(t));var r=e.StartIndex;for(var n=0;n<t;++n){var i=this.GetViewer(n);n+r<e.ViewerRecords.length&&(e.ViewerRecords[r+n].Apply(i),i.RecordIndex=n)}},e.prototype.GetNote=function(){return this.saNote},e.prototype.GetRootNote=function(){var e=this.saNote;while(e.Parent)e=e.Parent;return e},e.prototype.SetNoteFromId=function(e){var t=SA.GetNoteFromId(e);t||(t=new SA.Note);if(t.LoadState!=2){var n=this;return t.LoadViewId(e,function(){n.SetNote(t)}),t}return this.SetNote(t),t},e.prototype.GetNumberOfViewers=function(){return this.DualView?2:1},e.prototype.GetViewer=function(e){return this.Viewers[e]},e.prototype.SetNumberOfViewers=function(e){this.DualView=e>1,this.DualView?this.Viewer1Fraction=.5:this.Viewer1Fraction=1,this.UpdateSize(),this.UpdateGui()},e.prototype.ToggleDualView=function(){this.DualView=!this.DualView,this.DualView?(this.Viewers[1].GetCache()||(this.Viewers[1].SetCache(this.Viewers[0].GetCache()),this.Viewers[1].GetCamera().DeepCopy(this.Viewers[0].GetCamera())),this.AnimationCurrent=1,this.AnimationTarget=.5,$("#dualViewCopyZoom").show()):(this.AnimationCurrent=.5,this.AnimationTarget=1,this.UpdateGui()),SA.RecordState(),this.AnimationLastTime=(new Date).getTime(),this.AnimationDuration=1e3,this.AnimateViewToggle()},e.prototype.UpdateGui=function(){if(this.HideHandles){$("#dualWidgetLeft").hide(),$("#dualWidgetRight").hide();return}this.DualView?($("#dualWidgetLeft").hide(),$("#dualWidgetRight").show(),$("#dualViewCopyZoom").show()):($("#dualWidgetRight").hide(),$("#dualViewCopyZoom").hide(),$("#dualWidgetLeft").show())},e.prototype.AnimateViewToggle=function(){var e=(new Date).getTime()-this.AnimationLastTime;if(e>this.AnimationDuration){this.Viewer1Fraction=this.AnimationTarget,this.UpdateSize(),this.UpdateGui(),this.Draw();return}var t=e/this.AnimationDuration;this.AnimationDuration*=1-t,this.Viewer1Fraction+=(this.AnimationTarget-this.Viewer1Fraction)*t,this.UpdateSize(),this.Draw();var n=this;requestAnimFrame(function(){n.AnimateViewToggle()})},e.prototype.CreateThumbnailImage=function(e){var t=document.createElement("canvas"),n=t.getContext("2d"),r=this.Viewers[0].MainView.CaptureImage(),i=e/r.height,s=Math.round(r.width*i),o=Math.round(r.height*i);if(this.DualView){var u=this.Viewers[2].MainView.CaptureImage(),a=Math.round(u.width*i),f=Math.round(u.height*i);t.width=s+a,t.height=Math.max(o,f),n.drawImage(u,0,0,u.width,u.height,s,0,a,f)}else t.width=s,t.height=o;n.drawImage(r,0,0,r.width,r.height,0,0,s,o);var l=t.toDataURL("image/jpeg",.8),c=document.createElement("img");return c.src=l,c},e.prototype.Draw=function(e){e&&e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),this.saNote&&this.saNote.WaterMark?SA.WaterMark=!0:SA.WaterMark=!1,this.Viewers[0]&&(this.Viewers[0].Animate(),this.DualView&&this.Viewers[1].Animate(),this.Viewers[0].Draw()),this.Viewers[1]&&this.DualView&&this.Viewers[1].Draw()},e.prototype.UpdateSize=function(){var e=this.Viewer1Fraction*100;this.ViewerDivs[0]&&(this.ViewerDivs[0].css({left:"0%",width:e+"%",height:"100%"}),this.Viewers[0].UpdateSize()),this.ViewerDivs[1]&&(this.ViewerDivs[1].css({left:e+"%",width:100-e+"%",height:"100%"}),this.Viewers[1].UpdateSize()),e>=90?this.Viewers[1].Hide():this.Viewers[1].Show()},e.prototype.AnnotationWidgetOn=function(){for(var e=0;e<this.Viewers.length;++e)this.Viewers.AnnotationWidgetOn()},e.prototype.AnnotationWidgetOff=function(){for(var e=0;e<this.Viewers.length;++e)this.Viewers.AnnotationWidgetOff()},e.prototype.SynchronizeViews=function(e,t){if(e+t.StartIndex>=t.ViewerRecords.length)return;if(SA.Edit&&SA.StackCursorFlag){var n=t.ViewerRecords[t.StartIndex+1].Transform;if(!t.ActiveCorrelation){if(!n){alert("Missing transform");return}var r=this.GetViewer(0).GetCamera(),i=r.GetBounds(),s=0;while(s<n.Correlations.length){var o=n.Correlations[s];o.point0[0]>i[0]&&o.point0[0]<i[1]&&o.point0[1]>i[2]&&o.point0[1]<i[3]?n.Correlations.splice(s,1):++s}t.ActiveCorrelation=new SA.PairCorrelation,n.Correlations.push(t.ActiveCorrelation)}var u=this.GetViewer(0).GetCamera(),a=this.GetViewer(1).GetCamera();t.ActiveCorrelation.SetPoint0(u.GetFocalPoint()),t.ActiveCorrelation.SetPoint1(a.GetFocalPoint());var f=a.Roll-u.Roll;n.Correlations.length>1&&(f=0),t.ActiveCorrelation.SetRoll(f),t.ActiveCorrelation.SetHeight(.5*(a.Height+u.Height));return}t.ActiveCorrelation=undefined,t.PreCamera||(t.PreCamera=new SAM.Camera),t.PostCamera||(t.PostCamera=new SAM.Camera);var l=[t.PreCamera,this.GetViewer(0).GetCamera(),this.GetViewer(1).GetCamera(),t.PostCamera],c=e+1;for(var h=c+1;h<l.length;++h){var p=h-1+t.StartIndex;p<t.ViewerRecords.length?t.ViewerRecords[p].Transform.ForwardTransformCamera(l[h-1],l[h]):l[h]=undefined}for(var h=c;h>0;--h){var p=h+t.StartIndex-1;p>0?t.ViewerRecords[p].Transform.ReverseTransformCamera(l[h],l[h-1]):l[h-1]=undefined}if(l[0]){var d=SA.FindCache(t.ViewerRecords[t.StartIndex-1].Image);l[0].SetViewport(this.GetViewer(0).GetViewport());var v=d.ChooseTiles(l[0],0,[]);for(var h=0;h<v.length;++h)v[h].LoadQueueAdd();SA.LoadQueueUpdate()}if(l[3]){var d=SA.FindCache(t.ViewerRecords[t.StartIndex+2].Image);l[3].SetViewport(this.GetViewer(0).GetViewport());var v=d.ChooseTiles(l[3],0,[]);for(var h=0;h<v.length;++h)v[h].LoadQueueAdd();SA.LoadQueueUpdate()}e==0?(this.GetViewer(1).UpdateCamera(),this.GetViewer(1).EventuallyRender(!1)):(this.GetViewer(0).UpdateCamera(),this.GetViewer(0).EventuallyRender(!1));var m=this.GetViewer(e);for(var h=0;h<2;++h)if(h!=e){var g=this.GetViewer(h);g.AnnotationWidget&&m.AnnotationWidget&&g.AnnotationWidget.SetVisibility(m.AnnotationWidget.GetVisibility())}},SA.DualViewWidget=e}();(function(){"use strict";function e(e){this.Div=$("<div>").appendTo(e).css({position:"relative",width:"100%",height:"100%"}),this.TabDiv=$("<div>").appendTo(this.Div).css({position:"absolute",width:"100%",height:"30px"}),this.BodyDiv=$("<div>").appendTo(this.Div).css({position:"absolute",width:"100%",top:"30px",bottom:"0px"}),this.TabPanels=[],this.CurrentTabPanel=null}function t(e,t){var n=this;this.Enabled=!0,this.Tab=$("<div>").appendTo(e.TabDiv).text(t).css({color:"#AAA","border-color":"#BBB",position:"relative",bottom:"-2px",padding:"2px 7px 2px 7px",margin:"5px 0px 0px 5px",display:"inline-block","border-width":"1px","border-style":"solid","border-radius":"5px 5px 0px 0px",position:"relative","z-index":"6",background:"white"}).click(function(){e.OpenTabPanel(n)}),this.Div=$("<div>").hide().appendTo(e.BodyDiv).css({position:"absolute",top:"0px",bottom:"3px",left:"3px",right:"3px","border-width":"1px","border-style":"solid","border-color":"#BBB","z-index":"5",background:"white"})}e.prototype.NewTabDiv=function(e,n){var r=new t(this,e);return n&&r.Tab.prop("title",n),this.TabPanels.push(r),this.TabPanels.length==1&&this.OpenTabPanel(r),r.Div},e.prototype.OpenTabPanel=function(e){if(!e)return;for(var t=0;t<this.TabPanels.length;++t){var n=this.TabPanels[t];n.Div.hide(),n.Tab.css({color:"#AAA","z-index":"4","border-color":"#BBB"})}e.Div.show(),e.Tab.css({color:"#000","z-index":"6","border-color":"#BBB #BBB #FFF #BBB"}),this.CurrentTabPanel=e,$(window).trigger("resize")},e.prototype.GetCurrentDiv=function(){return this.CurrentTabPanel?this.CurrentTabPanel.Div:undefined},e.prototype.GetTabPanelFromDiv=function(e){for(var t=0;t<this.TabPanels.length;++t){var n=this.TabPanels[t];if(n.Div==e)return n}return null},e.prototype.GetTabPanelFromIndex=function(e){return e<0||e>=this.TabPanels.length?(console.log("GetTabPanelFromIndex("+e+"): error"),null):this.TabPanels[e]},e.prototype.ShowTabDiv=function(e){this.OpenTabPanel(this.GetTabPanelFromDiv(e))},e.prototype.ShowTabIndex=function(e){this.OpenTabPanel(this.GetTabPanelFromIndex(e))},e.prototype.EnableTabDiv=function(e){var t=this.GetTabPanelFromDiv(e);t.Enabled=!0,t.Tab.show()},e.prototype.DisableTabDiv=function(e){var t=this.GetTabPanelFromDiv(e);if(!t)return;t.Enabled=!1;if(t==this.CurrentTabPanel){this.CurrentTabPanel=null;for(var n=0;n<this.TabPanels.length;++n)if(this.TabPanels[n].Enabled){this.OpenTabPanel(this.TabPanel[n]);break}}t.Tab.css({color:"#AAA","z-index":"4","border-color":"#BBB"}),t.Div.hide(),t.Tab.hide()},SA.TabbedDiv=e,SA.TabPanel=t})();(function(){"use strict";function e(){SA.Notes||(SA.Notes=[]),this.Id=this.TempId=(new SA.ObjectId).toString(),SA.Notes.push(this);var e=this;this.LoadState=0,this.User=SA.GetUser();var t=new Date;this.Date=t.getTime(),this.Type="Note",this.Mode="",this.Title="",this.Text="",this.Modified=!1,this.ViewerRecords=[],this.Parent=null,this.Children=[],this.ChildrenVisibility=!0,this.Div=$("<li>").attr({"class":"note"}),this.TitleDiv=$("<div>").css({position:"relative"}).appendTo(this.Div),this.SortHandle=$("<span>").appendTo(this.TitleDiv).css({position:"absolute",left:"0px",top:"0px",opacity:"0.5"}).addClass("ui-icon ui-icon-bullet"),this.ButtonsDiv=$("<div>").appendTo(this.TitleDiv).css({"float":"right"}).hide(),this.TitleEntry=$("<div>").css({"margin-left":"20px"}).appendTo(this.TitleDiv).text(this.Title).addClass("sa-title"),(this.Mode=="answer-hide"||this.Mode=="answer-interactive")&&this.TitleEntry.text("-"),SA.Edit&&(this.AddButton=$("<img>").appendTo(this.ButtonsDiv).attr("src",SA.ImagePathUrl+"page_add.png").addClass("editButton").prop("title","add view").css({width:"12px",height:"12px",opacity:"0.5"}),this.LinkButton=$("<img>").appendTo(this.ButtonsDiv).attr("src",SA.ImagePathUrl+"link.png").prop("title","show url").addClass("editButton").css({width:"12px",height:"12px",opacity:"1.0"}),this.RemoveButton=$("<img>").appendTo(this.ButtonsDiv).hide().attr("src",SA.ImagePathUrl+"remove.png").prop("title","delete").addClass("editButton").css({width:"12px",height:"12px",opacity:"0.5"})),(SA.HideAnnotations||this.Mode=="answer-hide"||this.Mode=="answer-interactive")&&this.TitleEntry.text("-"),SA.Edit&&(this.Modified=!1,this.Mode=="answer-hide"&&this.Mode!="answer-interactive"&&this.TitleEntry.attr("contenteditable","true")),this.ChildrenDiv=$("<ul>").addClass("sa-ul").appendTo(this.Div),SA.Edit?this.ChildrenDiv.sortable({update:function(t,n){e.SortCallback()},handle:".ui-icon"}):this.ChildrenDiv.disableSelection(),this.StartIndex=0,this.ActiveCorrelation=undefined,this.StackDivs=[]}SA.GetNoteFromId=function(e){for(var t=0;t<SA.Notes.length;++t){var n=SA.Notes[t];if(n.Id&&n.Id==e)return n}return null},SA.GetUserNoteFromImageId=function(e){for(var t=0;t<SA.Notes.length;++t){var n=SA.Notes[t];if(n.Type=="UserNote"&&n.Parent==e)return n}return null},SA.DeleteNote=function(e){var t=SA.Notes.indexOf(e);t!=-1&&SA.Notes.splice(t,1)},e.prototype.DeepCopy=function(t){this.Image=e.Image,this.Children=[];for(var n=0;n<t.Children.length;++n){var r=new SA.Note;r.DeepCopy(t.Children[n]),this.Children.push(r)}this.Parent=t.Parent,this.StartIndex=t.StartIndex;var i=t.Id,s=this.Id;this.Text=t.Text.replace(i,s),this.Title=t.Title,this.Type=t.Type,this.User=t.User,this.ViewerRecords=[];for(var n=0;n<t.ViewerRecords.length;++n){var o=new SA.ViewerRecord;o.DeepCopy(t.ViewerRecords[n]),this.ViewerRecords.push(o)}},e.prototype.SortCallback=function(){var e=[],t=this.ChildrenDiv.children();for(var n=0;n<t.length;++n){var r=$(t[n]).data("index"),i=this.Children[r];i.Div.data("index",n),e.push(i)}this.Children=e,this.UpdateChildrenGUI(),SA.notesWidget&&SA.notesWidget.MarkAsModified()},e.prototype.ClearHyperlink=function(){var e=this;if(this.Id){this.SelectHyperlink();var t=window.getSelection();document.execCommand("insertText",t.toString())}},e.prototype.SelectHyperlink=function(){if(this.Id){var e=document.getElementById(this.Id);if(e){var t=document.createRange();t.selectNode(e);var n=window.getSelection();n.removeAllRanges(),n.addRange(t)}}},e.prototype.UnselectHyperlink=function(){if(this.Id){var e=document.getElementById(this.Id);if(e){var t=document.createRange();t.collapse(!0);var n=window.getSelection();n.removeAllRanges(),n.addRange(t)}}},e.prototype.SetParent=function(e){var t=this;this.Parent=e,e&&SA.Edit&&this.RemoveButton.show()},e.prototype.TitleFocusInCallback=function(){SA.ContentEditableHasFocus=!0,SA.SetNote(this)},e.prototype.TitleFocusOutCallback=function(){this.Modified&&(this.Modified=!1,this.Mode!="answer-hide"&&this.Mode!="answer-interactive"&&(this.Title=this.TitleEntry.text()),SA.notesWidget&&SA.notesWidget.MarkAsModified()),SA.ContentEditableHasFocus=!1;if(!this.Modified)return;this.Modified=!1;if(this.Mode!="answer-hide"&&this.Mode!="answer-interactive"){var e=this.TitleEntry.text();this.Title!=e&&!SA.HideAnnotations&&(this.Title=e,this.Save())}},e.prototype.LinkCallback=function(){if(!SA.LinkDiv)return;var e="slide-atlas.org/webgl-viewer?view="+this.Id;SA.LinkDiv.html(e),SA.LinkDiv.show();var t=document.createRange();t.selectNodeContents(SA.LinkDiv[0]);var n=window.getSelection();n.removeAllRanges(),n.addRange(t),document.execCommand("copy",!1,null)},e.prototype.DeleteCallback=function(){if(this.Type=="UserNote")return;var e=this.Parent;if(e==null)return;this.ClearHyperlink(),this.Type!="view"&&SA.display&&SA.display.NavigationWidget&&SA.display.NavigationWidget.GetNote()==this&&SA.display.NavigationWidget.PreviousNote();var t=e.Children.indexOf(this);e.Children.splice(t,1),this.Parent=null,e.UpdateChildrenGUI(),SA.notesWidget&&SA.notesWidget.MarkAsModified()},e.prototype.SetUserNote=function(e){var t=this;console.log("I do not think UserNote is ever set 2."),t.UserNote=e,e.Parent=t,e.Type="UserNote"},e.prototype.UserCanEdit=function(){return SA.Edit},e.prototype.RecordView=function(e){if(e.GetNumberOfViewers()==0)return;if(this.Type=="Stack"){var t=e.GetViewer(0);this.StartIndex==0&&this.ViewerRecords[0].CopyViewer(t);return}this.ViewerRecords=[];for(var n=0;n<e.GetNumberOfViewers();++n){var r=new SA.ViewerRecord;r.CopyViewer(e.GetViewer(n)),this.ViewerRecords.push(r)}},e.prototype.AddChild=function(e,t){e.Div.data("index",this.Children.length),t?this.Children.splice(0,0,e):this.Children.push(e),this.UpdateChildrenGUI()},e.prototype.UpdateChildrenGUI=function(){var e=this;this.ChildrenDiv.empty();if(this.Type=="Stack"){this.StackDivs=[];for(var t=0;t<this.ViewerRecords.length;++t){var n=$("<div>").addClass("note").appendTo(this.ChildrenDiv);SA.HideAnnotations?n.text(t.toString()):n.text(this.ViewerRecords[t].Image.label),this.StackDivs.push(n),t==this.StartIndex&&n.css({"background-color":"#BBB"})}return}if(this.Children.length==0)return;var r=[];for(var t=0;t<this.Children.length;++t)this.Children[t].Type=="Note"&&r.push(this.Children[t]);for(var t=0;t<this.Children.length;++t)this.Children[t].Type!="Note"&&r.push(this.Children[t]);this.Children=r;for(var t=0;t<this.Children.length;++t)this.Children[t].Type=="Note"&&(this.Children[t].DisplayGUI(this.ChildrenDiv),this.Children[t].Div.data("index",t),this.Children.length>1?this.Children[t].SortHandle.addClass("sa-sort-handle"):this.Children[t].SortHandle.removeClass("sa-sort-handle"))},e.prototype.NewIterator=function(){return new SA.NoteIterator(this)},e.prototype.Contains=function(e){for(var t=0;t<this.Children.length;++t){var n=this.Children[t];if(n==e)return!0;if(n.Contains(e))return!0}return!1},e.prototype.NewChild=function(e,t){var n=new SA.Note;n.Title=t;var r=new Date;return n.Date=r.getTime(),this.Children.splice(e,0,n),n.SetParent(this),n},e.prototype.Save=function(e,t){console.log("Save note "+this.Id+" "+this.Title);var n=this,r=JSON.stringify(this.Serialize(t)),i=new Date;SA.PushProgress(),$.ajax({type:"post",url:"/webgl-viewer/saveviewnotes",data:{note:r,date:i.getTime()},success:function(t,r){SA.PopProgress(),e&&e(n),n.LoadState=2},error:function(){SA.PopProgress(),SA.Debug("AJAX - error() : saveviewnotes")}})},e.prototype.HasAnnotations=function(){for(var e=0;e<this.ViewerRecords.length;++e)if(this.ViewerRecords.Annotations.length>0)return!0;return!1},e.prototype.RecordAnnotations=function(e){this.UserNote&&(console.log("I do not think UserNote is ever set 3."),this.UserNote.RecordAnnotations(e),(this.UserNote.HasAnnotations()||this.UserNote.LoadState!=0)&&this.UserNote.Save());for(var t=0;t<e.GetNumberOfViewers();++t)this.ViewerRecords.length>this.StartIndex+t&&this.ViewerRecords[this.StartIndex+t].CopyAnnotations(e.GetViewer(t),this.Type=="UserNote")},e.prototype.DisplayGUI=function(e){var t=this;this.Div.appendTo(e),this.Mode!="answer-hide"&&this.Mode!="answer-interactive"?(this.TitleEntry.click(function(){SA.SetNote(t),t.ButtonsDiv.show()}).bind("input",function(){t.Modified=!0}).focusin(function(){t.TitleFocusInCallback()}).focusout(function(){t.TitleFocusOutCallback()}).mouseleave(function(){t.Modified&&(t.Modified=!1,t.Title=t.TitleEntry.text(),SA.notesWidget&&SA.notesWidget.MarkAsModified())}),this.TitleDiv.hover(function(){t.TitleEntry.css({color:"#33D"}),SA.notesWidget&&SA.notesWidget.SelectedNote==t&&t.ButtonsDiv.show()},function(){t.TitleEntry.css({color:"#3AF"}),t.ButtonsDiv.hide()}),this.TitleEntry.text(this.Title)):this.TitleEntry.text("-"),SA.Edit&&(this.AddButton.click(function(){SA.notesWidget&&SA.notesWidget.NewCallback()}),this.LinkButton.click(function(){t.LinkCallback()}),this.RemoveButton.click(function(){t.DeleteCallback()})),this.UpdateChildrenGUI()},e.prototype.Serialize=function(e){var t={};t.SessionId=localStorage.sessionId,t.Type=this.Type,t.Mode=this.Mode,t.User=this.User,t.Date=this.Date,this.WaterMark&&(t.WaterMark=this.WaterMark),this.TypeData&&(t.TypeData=this.TypeData),this.NotesPanelOpen&&(t.NotesPanelOpen=!0),this.Id&&(t._id=this.Id,delete this._id),this.Parent&&(typeof this.Parent=="string"&&(t.ParentId=this.Parent),typeof this.Parent=="object"&&this.Parent.Id&&(t.ParentId=this.Parent.Id),delete this.ParentId),t.Title=this.Title,t.HiddenTitle=this.HiddenTitle,t.Text=this.Text,t.ViewerRecords=[];for(var n=0;n<this.ViewerRecords.length;++n){if(!this.ViewerRecords[n].Image)continue;var r=this.ViewerRecords[n].Serialize();t.ViewerRecords.push(r)}t.CoordinateSystem="Pixel";if(!e){t.Children=[];for(var n=0;n<this.Children.length;++n)t.Children.push(this.Children[n].Serialize(e))}return t},e.prototype.Load=function(e){var t=this;this.LoadState=2;var n;for(n in e)this[n]=e[n];this._id&&(this.Id=this._id,delete this._id),this.Type!="UserNote"&&this.ParentId&&(this.Parent=SA.GetNoteFromId(this.ParentId),delete this.ParentId),SA.HideAnnotations||this.Mode=="answer-hide"||this.Model=="answer-interactive"?this.TitleEntry.text("-"):this.TitleEntry.text(this.Title);for(var r=0;r<this.Children.length;++r){var i=this.Children[r],s=new SA.Note;s.SetParent(this),typeof i=="string"?s.Id=i:s.Load(i),this.Children[r]=s,s.Div.data("index",r)}if(this.UserNote){console.log("I do not think UserNote is ever set. 1");var e=this.UserNote;this.UserNote=new SA.Note,this.UserNote.Load(e)}for(var r=0;r<this.ViewerRecords.length;++r)this.ViewerRecords[r]&&(e=this.ViewerRecords[r],this.ViewerRecords[r]=new SA.ViewerRecord,this.ViewerRecords[r].Load(e))};var t=[];e.prototype.LoadViewId=function(e,n){if(this.LoadState==2){n();return}if(this.LoadState==1){HACK+LOAD_CALLBACKS.push({note:this,callback:n});return}var r=this;this.LoadState=1,SA.PushProgress(),$.ajax({type:"get",url:"/webgl-viewer/getview",data:{viewid:e},success:function(e,i){SA.PopProgress(),r.Load(e),n&&n();var s=[];for(var o=0;o<t.length;++o)tmp2=t[o],tmp2.note==r?tmp2.callback():s.push(tmp2);t=s},error:function(){SA.PopProgress(),SA.Debug("AJAX - error() : getview")}})},e.prototype.Collapse=function(){this.ChildrenVisibility=!1,this.Contains(SA.notesWidget.SelectedNote)&&SA.SetNote(this),this.UpdateChildrenGUI(),SA.display.NavigationWidget.Update()},e.prototype.Expand=function(){this.ChildrenVisibility=!0,this.UpdateChildrenGUI(),SA.display.NavigationWidget.Update()},e.prototype.DisplayStack=function(e){if(SA.Edit&&this.StartIndex+1<this.ViewerRecords.length){var t=this.ViewerRecords[this.StartIndex+1].Transform;t&&(e.GetViewer(0).StackCorrelations=t.Correlations,e.GetViewer(1).StackCorrelations=t.Correlations)}for(var n=0;n<this.StackDivs.length;++n)n==this.StartIndex?this.StackDivs[n].css({"background-color":"#BBB"}):this.StackDivs[n].css({"background-color":"#FFF"})},e.prototype.InitializeStackTransforms=function(){for(var e=1;e<this.ViewerRecords.length;++e)if(!this.ViewerRecords[e].Transform){var t=this.ViewerRecords[e-1].Camera,n=this.ViewerRecords[e].Camera,r=n.Roll-t.Roll;r<0&&(r+=2*Math.PI);var i=new SA.PairTransformation;i.AddCorrelation(t.FocalPoint,n.FocalPoint,r,.5*(t.Height+n.Height)),this.ViewerRecords[e].Transform=i}},SA.Note=e})();(function(){"use strict";function e(){var e=this;this.Windows=new Array(3),this.Windows[0]=new Array(3),this.Windows[1]=new Array(3),this.Windows[2]=new Array(3),this.ScreenRectangle=$("<div>").appendTo("body").css({position:"absolute",background:"#06F",opacity:"0.5","z-index":"100"}).hide(),this.HorizontalLine=$("<div>").appendTo(this.ScreenRectangle).css({position:"absolute",left:"0px",width:"100%",top:"50%",height:"1px",background:"#FFF",opacity:"0.4"}),this.VerticalLine=$("<div>").appendTo(this.ScreenRectangle).css({position:"absolute",top:"0px",height:"100%",left:"50%",width:"1px",background:"#FFF",opacity:"0.4"}),this.WindowRectangle=$("<div>").appendTo(this.ScreenRectangle).css({position:"absolute","box-sizing":"border-box",background:"#AAA",border:"1px solid #FFF",opacity:"0.7"}),this.ScreenRectangle.bind("mousemove",function(t){e.HandleMouseMove(t)}),this.ScreenRectangle.bind("mouseup",function(t){e.HandleMouseUp(t)}),this.ScreenRectangle.bind("mouseleave",function(t){e.HandleMouseLeave(t)}),$(window).bind("beforeunload",function(){for(var t=0;t<3;++t)for(var n=0;n<3;++n){var r=e.Windows[t][n];r&&!r.closed&&r.close()}})}e.prototype.Show=function(e,t,n,r){this.Title=r||"SlideAtlas",this.Url=n,this.AvailableLeft=screen.availLeft||0,this.AvailableTop=screen.availTop||0,this.AvailableWidth=screen.availWidth||screen.width||1e3,this.AvailableHeight=screen.availHeight||screen.height||800;var i=this.AvailableWidth/10,s=this.AvailableHeight/10,o=e-i/2,u=t-s/2;o<0&&(o=0),u<0&&(u=0),this.Partition=[1,1],this.WindowRectangle.css({left:"3%",top:"3%",width:"94%",height:"94%"}),this.ScreenRectangle.css({left:o+"px",top:u+"px",width:i+"px",height:s+"px"}).show()},e.prototype.HandleMouseLeave=function(e){this.ScreenRectangle.hide()},e.prototype.HandleMouseUp=function(e){var t=this.Partition[0],n=this.Partition[1],r=this.Windows[t][n];if(r&&!r.closed){r.location.href=this.Url,r.document.title=this.Title;return}var i=this.AvailableLeft,s=this.AvailableTop,r=this.AvailableWidth,o=this.AvailableHeight;t!=1&&(r/=2),n!=1&&(o/=2),t==2&&(i+=r),n==2&&(s+=o),r-=27,o-=100;var u=this.Title+" "+t+" "+n;this.Windows[this.Partition[0]][this.Partition[1]]=window.open(this.Url,u,"alwaysRaised=yes,titlebar=no,menubar=no,toolbar=no,dependent=yes,left="+i+",top="+s+",width="+r+",height="+o),this.ScreenRectangle.hide()},e.prototype.HandleMouseMove=function(e){var t=this.ScreenRectangle.width(),n=this.ScreenRectangle.height(),r=e.offsetX,i=e.offsetY,s=$(e.originalEvent.srcElement);while(s[0]!=this.ScreenRectangle[0]){var o=s.position();r+=o.left,i+=o.top,s=s.parent();if(!s)return}r<t/3?(this.Partition[0]=0,this.WindowRectangle.css({left:"3%",width:"44%"})):r>2*t/3?(this.Partition[0]=2,this.WindowRectangle.css({left:"53%",width:"44%"})):(this.Partition[0]=1,this.WindowRectangle.css({left:"3%",width:"94%"})),i<n/3?(this.Partition[1]=0,this.WindowRectangle.css({top:"3%",height:"44%"})):i>2*n/3?(this.Partition[1]=2,this.WindowRectangle.css({top:"53%",height:"44%"})):(this.Partition[1]=1,this.WindowRectangle.css({top:"3%",height:"94%"}))},SA.WindowManager=e})(),function(){"use strict";function e(e,t){var n=this;this.Display=t,this.Parent=e,this.Editable=!0,this.Edit=!0,this.ChangeCallback=null,this.EditButtons=[],this.AddEditButton(SA.ImagePathUrl+"camera.png","link view",function(){n.InsertCameraLink()}),this.AddEditButton(SA.ImagePathUrl+"link.png","link URL",function(){n.InsertUrlLink()}),this.AddEditButton(SA.ImagePathUrl+"font_bold.png","bold",function(){document.execCommand("bold",!1,null)}),this.AddEditButton(SA.ImagePathUrl+"text_italic.png","italic",function(){document.execCommand("italic",!1,null)}),this.AddEditButton(SA.ImagePathUrl+"edit_underline.png","underline",function(){document.execCommand("underline",!1,null)}),this.AddEditButton(SA.ImagePathUrl+"list_bullets.png","unorded list",function(){document.execCommand("InsertUnorderedList",!1,null)}),this.AddEditButton(SA.ImagePathUrl+"list_numbers.png","ordered list",function(){document.execCommand("InsertOrderedList",!1,null)}),this.AddEditButton(SA.ImagePathUrl+"indent_increase.png","indent",function(){document.execCommand("indent",!1,null)}),this.AddEditButton(SA.ImagePathUrl+"indent_decrease.png","outdent",function(){document.execCommand("outdent",!1,null)}),this.AddEditButton(SA.ImagePathUrl+"alignment_left.png","align left",function(){document.execCommand("justifyLeft",!1,null)}),this.AddEditButton(SA.ImagePathUrl+"alignment_center.png","align center",function(){document.execCommand("justifyCenter",!1,null)}),this.AddEditButton(SA.ImagePathUrl+"edit_superscript.png","superscript",function(){document.execCommand("superscript",!1,null)}),this.AddEditButton(SA.ImagePathUrl+"edit_subscript.png","subscript",function(){document.execCommand("subscript",!1,null)}),this.AddEditButton(SA.ImagePathUrl+"font_increase.png","large font",function(){document.execCommand("fontSize",!1,"5"),n.ChangeBulletSize("1.5em")}),this.AddEditButton(SA.ImagePathUrl+"font_decrease.png","small font",function(){document.execCommand("fontSize",!1,"2"),n.ChangeBulletSize("0.9em")}),this.AddEditButton(SA.ImagePathUrl+"question.png","add question",function(){n.AddQuestion()}),this.InitializeHomeButton(e),this.TextEntry=$("<div>").appendTo(e).attr("contenteditable","true").removeAttr("readonly").css({"box-sizing":"border-box",width:"100%",height:"100%","border-style":"solid",overflow:"auto",resize:"none","border-style":"inset","font-size":"10pt","font-family":"Century Gothic",background:"#f5f8ff"}).bind("input",function(){n.EventuallyUpdate()}).focusin(function(){SA.ContentEditableHasFocus=!0}).focusout(function(){SA.ContentEditableHasFocus=!1,n.Update()}).mouseleave(function(){n.Update()}),this.UpdateTimer=null,this.EditOff(),this.Note=null}e.prototype.HomeCallback=function(){if(!this.Note)return;SA.SetNote(this.Note)},e.prototype.InitializeHomeButton=function(e){var t=this;this.HomeButton=$("<div>").appendTo(e).text("Home").css({"text-align":"center",border:"1px solid #666666","border-radius":"10px",margin:"2px",color:"#29C",background:"white"}).hover(function(){$(this).css("color","blue")},function(){$(this).css("color","#29C")}),this.HomeButton.contextmenu(function(){return!1}),this.HomeButton.mousedown(function(e){if(e.button==0)return t.HomeCallback(),!1;if(e.button==2){t.LinkMenuObject={Link:t.HomeButton,Note:t.Note};var n=$(this).position();return t.DeleteLinkButton.hide(),t.LinkMenu.css({left:25+n.left+"px",top:n.top+"px"}).show(),!1}return!0}),this.LinkMenuObject=undefined,this.LinkMenu=$("<div>").appendTo(e).hide().mouseleave(function(){$(this).hide()}).css({position:"absolute","background-color":"#FFFFFF",border:"1px solid #666666","box-sizing":"border-box",left:"-78px",width:"100px",padding:"0px 2px"}),$("<button>").appendTo(this.LinkMenu).text("Save View").css({margin:"2px 0px",width:"100%"}).prop("title","Replace Annotation").click(function(){t.SaveLink(t.LinkMenuObject.Link,t.LinkMenuObject.Note),t.LinkMenu.hide()}),this.DeleteLinkButton=$("<button>").appendTo(this.LinkMenu).text("Delete").css({margin:"2px 0px",width:"100%"}).click(function(){t.DeleteLink(t.LinkMenuObject.Link,t.LinkMenuObject.Note),t.LinkMenu.hide()})},e.prototype.StartWindowManagerTimer=function(e,t,n){this.WindowManagerX=t,this.WindowManagerY=n,this.LinkWindowLocation=0;var r=this;this.WindowManagerTimer=setTimeout(function(){r.WindowManagerTimer=undefined,r.ShowWindowManager(e,t,n)},1e3)},e.prototype.ShowWindowManager=function(e,t,n){this.WindowMangerTimer&&(clearTimeout(this.WindowManagerTimer),this.WindowManagerTimer=undefined),SA.windowManager||(SA.windowManager=new SA.WindowManager),SA.windowManager.Show(t,n,"/webgl-viewer?view="+e.Id,e.Title),this.LinkWindowLocation=1},e.prototype.FormatLink=function(e){var t=this,n=document.getElementById(e.Id);n&&($(n).css({color:"#29C",background:"white"}).hover(function(){$(this).css("color","blue")},function(){$(this).css("color","#29C")}).attr("contenteditable","false"),$(n).contextmenu(function(){return!1}),$(n).mousedown(function(r){if(r.button==0)return t.StartWindowManagerTimer(e,r.pageX,r.pageY),!1;if(r.button==2){t.LinkMenuObject={Link:$(n),Note:e};var i=$(this).position();return t.DeleteLinkButton.show(),t.LinkMenu.css({left:25+i.left+"px",top:i.top+"px"}).show(),!1}return!0}),$(n).mousemove(function(n){if(n.which==1){var r=n.pageX-t.WindowManagerX,i=n.pageY-t.WindowManagerY;Math.abs(r)+Math.abs(i)>5&&t.ShowWindowManager(e,n.pageX,n.pageY)}}),$(n).mouseup(function(n){if(n.button==0){t.WindowManagerTimer&&(clearTimeout(t.WindowManagerTimer),t.WindowManagerTimer=undefined);if(t.LinkWindowLocation==0)return SA.SetNote(e),!1}return!0}))},e.prototype.SaveLink=function(e,t){t.RecordView(this.Display),t.Save()},e.prototype.DeleteLink=function(e,t){var n=e.text();$(document.createTextNode(n)).insertAfter(e),e.remove(),t.DeleteCallback(),this.UpdateNote(),this.Note.Save()},e.prototype.Change=function(e){this.ChangeCallback=e},e.prototype.EventuallyUpdate=function(){this.UpdateTimer&&(clearTimeout(this.UpdateTimer),this.UpdateTimer=null);var e=this;this.UpdateTimer=setTimeout(function(){e.UpdateNote()},5e3)},e.prototype.Update=function(){if(!this.UpdateTimer)return;clearTimeout(this.UpdateTimer),this.UpdateTimer=null,this.UpdateNote()},e.prototype.EditOff=function(){if(!this.Edit)return;this.Edit=!1;for(var e=0;e<this.EditButtons.length;++e)this.EditButtons[e].hide();this.TextEntry.attr("contenteditable","false").attr("spellcheck","false").css({"border-style":"outset",background:"#ffffff"}).unbind("input").unbind("focusin").unbind("focusout").unbind("mouseleave").blur()},e.prototype.EditableOff=function(){this.EditOff(),this.Editable=!1},e.prototype.EditOn=function(){var e=this;if(!this.Editable)return;if(this.Edit)return;this.Edit=!0;for(var t=0;t<this.EditButtons.length;++t)this.EditButtons[t].show();this.TextEntry.attr("contenteditable","true").removeAttr("readonly").css({"border-style":"inset",background:"#f5f8ff"}).bind("input",function(){e.Modified=!0,e.EventuallyUpdate()}).focusin(function(){SA.ContentEditableHasFocus=!0}).focusout(function(){SA.ContentEditableHasFocus=!1,e.Update()}).mouseleave(function(){e.Update()})},e.prototype.AddEditButton=function(e,t,n){var r=this,i=$("<img>");t&&i.prop("title",t),i.appendTo(this.Parent).addClass("editButton").attr("src",e).click(n),this.EditButtons.push(i)},e.prototype.ParseText=function(){var e=this.TextEntry.text()},e.prototype.AddQuestion=function(){var e=$("<div>").css({position:"relative",margin:"3%",width:"90%",background:"#FFF",border:"1px solid #AAA",padding:"1% 1% 1% 1%"}).attr("contenteditable","false").saQuestion({editable:SA.Edit,position:"static"}),t=this,n=SA.GetSelectionRange(this.TextEntry);if(!n.collapsed){var r=n.cloneContents();e.saQuestion("SetQuestionText",r.firstChild.textContent);if(r.childElementCount>1){var i=[],s=0,o=r.querySelector("li");o?i=o.parentElement:r.childElementCount>2?(i=r,s=1):i=r.children[1];for(var u=s;u<i.childElementCount;++u){var a=i.children[u],f=a.style.fontWeight=="bold"||$(a).find("b").length>0;e.saQuestion("AddAnswerText",a.textContent,f)}}}e.saQuestion("OpenDialog",function(){n?(n.deleteContents(),n.insertNode(document.createElement("br"))):n=SA.MakeSelectionRange(t.TextEntry),n.insertNode(e[0]),n.collapse(!1);var r=window.getSelection();r.removeAllRanges(),r.addRange(n),t.TextEntry[0].focus(),t.UpdateNote()})},e.prototype.ChangeBulletSize=function(e){var t=this,n=window.getSelection(),r=SA.GetSelectionRange(this.TextEntry);r=r||SA.MakeSelectionRange(this.TextEntry);var i=$("li");for(var s=0;s<i.length;++s){var o=i[s];(r.isPointInRange(o,0)||r.isPointInRange(o,1))&&$(o).css({"font-size":e})}},e.prototype.InsertUrlLink=function(){var e=this,t=window.getSelection(),n=SA.GetSelectionRange(this.TextEntry),r=t.toString();if(!this.UrlDialog){var e=this,i=new SAM.Dialog(function(){e.InsertUrlLinkAccept()});i.Body.css({margin:"1em 2em"}),this.UrlDialog=i,i.Dialog.css({width:"40em"}),i.Title.text("Paste URL link"),i.TextDiv=$("<div>").appendTo(i.Body).css({display:"table-row",width:"100%"}),i.TextLabel=$("<div>").appendTo(i.TextDiv).text("Text to display:").css({display:"table-cell",height:"2em","text-align":"left"}),i.TextInput=$("<input>").appendTo(i.TextDiv).val("#30ff00").css({display:"table-cell",width:"25em"}),i.UrlDiv=$("<div>").appendTo(i.Body).css({display:"table-row"}),i.UrlLabel=$("<div>").appendTo(i.UrlDiv).text("URL link:").css({display:"table-cell","text-align":"left"}),i.UrlInput=$("<input>").appendTo(i.UrlDiv).val("#30ff00").css({display:"table-cell",width:"25em"}).bind("input",function(){var t=e.UrlDialog.UrlInput.val();e.UrlDialog.LastUrl==e.UrlDialog.TextInput.val()&&e.UrlDialog.TextInput.val(t),e.UrlDialog.LastUrl=t,t==""?e.UrlDialog.ApplyButton.attr("disabled",!0):e.UrlDialog.ApplyButton.attr("disabled",!1)})}this.UrlDialog.SelectionRange=n,this.UrlDialog.TextInput.val(r),this.UrlDialog.UrlInput.val(""),this.UrlDialog.LastUrl="",this.UrlDialog.ApplyButton.attr("disabled",!0),this.UrlDialog.Show(!0)},e.prototype.InsertUrlLinkAccept=function(){var e=window.getSelection(),t=this.UrlDialog.SelectionRange;t=t||SA.MakeSelectionRange(this.TextEntry);var n=document.createElement("a");n.href=this.UrlDialog.UrlInput.val(),n.target="_blank",t.collapsed||(t.extractContents(),t.collapse(!0));var r=this.UrlDialog.TextInput.val();r==""&&(r=this.UrlDialog.UrlInput.val()),n.appendChild(document.createTextNode(r)),t.insertNode(n),t.noCursor&&e.removeAllRanges(),this.UpdateNote()};var t=0;e.prototype.InsertCameraLink=function(){var e=this.Note;e||(e=SA.display.GetRootNote());var t=e.Children.length,n=e.NewChild(t,r);n.RecordView(this.Display),n.Type="View";var r="(view)",i=SA.GetSelectionRange(this.TextEntry);i?i.collapsed||(r=i.toString()):i=SA.MakeSelectionRange(this.TextEntry),n.Title=r,i.deleteContents();var s=document.createElement("span");s.id=n.Id,$(s).attr("contenteditable","false"),s.appendChild(document.createTextNode(r)),i.insertNode(s),this.FormatLink(n),i.collapse(!1);var o=window.getSelection();o.removeAllRanges(),o.addRange(i),this.TextEntry[0].focus(),this.UpdateNote(),this.Note.Save(),SA.SetNote(n)},e.prototype.Resize=function(e,t){var n;n=this.TextEntry.offset(),this.TextEntry.height(t-n.top-5)},e.prototype.SetHtml=function(e){console.log("Something called 'TextEditor::SetHtml'"),this.UpdateTimer&&(clearTimeout(this.UpdateTimer),this.Update()),this.Note=null,this.EditOn(),this.TextEntry.html(e);if(SA.Edit){var t=this.TextEntry.find(".sa-question");t.saQuestion({editable:!0,position:"static"})}SA.AddHtmlTags(this.TextEntry)},e.prototype.GetHtml=function(){return this.TextEntry.html()},e.prototype.LoadNote=function(e){this.UpdateTimer&&(clearTimeout(this.UpdateTimer),this.Update()),this.Note=e,this.HomeButton[0].id=e.Id,this.TextEntry.html(e.Text),SA.AddHtmlTags(this.TextEntry),this.UpdateMode(e.Mode);if(SA.Edit){var t=this.TextEntry.find(".sa-question");t.saQuestion({editable:!0,position:"static"})}for(var n=0;n<e.Children.length;++n)this.FormatLink(e.Children[n]);this.MakeLinksClickable(),SA.Edit&&this.EditOn(),this.TextEntry.trigger("resize")},e.prototype.UpdateMode=function(e){e=="answer-show"&&this.Note&&this.Note.Title?this.HomeButton.text(this.Note.Title):this.HomeButton.text("Home");if(e=="answer-show")$(".sa-note").show(),$(".sa-notes").show(),$(".sa-diagnosis").show(),$(".sa-differential-diagnosis").show(),$(".sa-teaching-points").show(),$(".sa-compare").show(),$(".sa-question").saQuestion("SetMode",e);else if(e=="answer-hide"||e=="answer-interactive")$(".sa-note").hide(),$(".sa-notes").hide(),$(".sa-diagnosis").hide(),$(".sa-differential-diagnosis").hide(),$(".sa-teaching-points").hide(),$(".sa-compare").hide(),$(".sa-question").saQuestion("SetMode",e)},e.prototype.UpdateNote=function(){this.UpdateTimer=null;if(!this.Note)return;this.Note.Text=this.TextEntry.html(),this.ChangeCallback&&this.ChangeCallback(),this.MakeLinksClickable()},e.prototype.MakeLinksClickable=function(){if(SA.Edit){var e=$("a");for(var t=0;t<e.length;++t){var n=e[t];$(n).click(function(){window.open(this.href,"_blank")})}}},SA.TextEditor=e}(),function(){"use strict";function e(e,t){this.ModifiedCallback=null,this.LinkDiv,this.DisplayedNote=null,SA.LinkDiv=$("<div>").appendTo("body").css({top:"30px",left:"10%",position:"absolute",width:"80%",height:"50px","z-index":"3","background-color":"#FFF",border:"1px solid #777","border-radius":"8px","text-align":"center","padding-top":"26px"}).hide().mouseleave(function(){SA.LinkDiv.fadeOut()}),SA.Edit&&SA.LinkDiv.attr("contenteditable","true");var n=this;this.Display=t,this.Modified=!1,this.Window=$("<div>").appendTo(e).css({"background-color":"white",position:"absolute",top:"0%",left:"0%",height:"100%",width:"100%","z-index":"2"}).attr("draggable","false").on("dragstart",function(){return!1}).attr("id","NoteWindow"),this.NavigationWidget,this.SelectedNote,this.TabbedWindow=new SA.TabbedDiv(this.Window),this.TextDiv=this.TabbedWindow.NewTabDiv("Text"),this.UserTextDiv=this.TabbedWindow.NewTabDiv("Notes","private notes"),this.LinksDiv=this.TabbedWindow.NewTabDiv("Views"),this.LinksRoot=$("<ul>").addClass("sa-ul").css({"padding-left":"0px"}).appendTo(this.LinksDiv),this.LinksDiv.css({overflow:"auto","text-align":"left",color:"#303030","font-size":"18px"}).attr("id","NoteTree"),SA.Edit&&(this.AddViewButton=$("<button>").appendTo(this.LinksDiv).css({"border-radius":"4px",margin:"1em"}).text("+ New View")),this.QuizButton=$("<div>").appendTo(this.TextDiv).addClass("editButton").css({"float":"right","font-size":"small","margin-top":"4px","padding-left":"2px","padding-right":"2px",border:"1px solid #AAA","border-radius":"2px"}).text("show").hide(),SA.Edit&&(this.QuizDiv=$("<div>").appendTo(this.TextDiv),this.QuizMenu=$('<select name="quiz" id="quiz">').appendTo(this.QuizDiv).css({"float":"right",margin:"3px"}).change(function(){if(!n.RootNote)return;this.value=="review"?n.RootNote.Mode="answer-show":this.value=="hidden"?n.RootNote.Mode="answer-hide":this.value=="interactive"&&(n.RootNote.Mode="answer-interactive"),n.UpdateQuestionMode()}),this.QuizLabel=$("<div>").appendTo(this.TextDiv).css({"float":"right","font-size":"small","margin-top":"4px"}).text("quiz"),$("<option>").appendTo(this.QuizMenu).text("review"),$("<option>").appendTo(this.QuizMenu).text("hidden"),$("<option>").appendTo(this.QuizMenu).text("interactive"),this.QuizMenu.val("review")),this.TextEditor=new SA.TextEditor(this.TextDiv,this.Display),SA.FillDiv(this.TextEditor.TextEntry),SA.Edit?this.TextEditor.Change(function(){n.MarkAsModified()}):this.TextEditor.EditableOff(),this.UserTextEditor=new SA.TextEditor(this.UserTextDiv,this.Display),SA.FillDiv(this.UserTextEditor.TextEntry),this.UserTextEditor.Change(function(){n.UserTextEditor.Note.Save()})}e.prototype.EventuallySaveUserNote=function(){this.UserNoteTimerId&&clearTimeout(this.UserNoteTimerId);var e=this;this.UserNoteTimerId=setTimeout(function(){e.SaveUserNote()},2e3)},e.prototype.SaveUserNote=function(){this.UserNoteTimerId=!1;var e=SA.notesWidget.UserNote;e.ViewerRecords[0].CopyAnnotations(SA.VIEWER1,!0),(e.ViewerRecords[0].Annotations.length>0||e.LoadState==2)&&e.Save()},e.prototype.IsUserTextTabOpen=function(){return this.TabbedWindow.GetCurrentDiv()==this.UserTextDiv?!0:!1},e.prototype.UpdateQuestionMode=function(){if(!this.RootNote)return;this.RootNote.Mode||(this.RootNote.Mode="answer-show"),this.QuizMenu&&(this.RootNote.Mode=="answer-hide"?this.QuizMenu.val("hidden"):this.RootNote.Mode=="answer-interactive"?this.QuizMenu.val("interactive"):this.QuizMenu.val("review"));if(this.RootNote.Mode=="answer-interactive"){var e=this;this.QuizButton.show().css("background-color","").click(function(){e.SetAnswerVisibility("answer-show"),e.QuizButton.css({"background-color":"#AAAAAA"})})}else this.QuizButton.hide();this.SetAnswerVisibility(this.RootNote.Mode)},e.prototype.SetAnswerVisibility=function(e){SA.AddHtmlTags(this.TextEditor.TextEntry),this.TextEditor.UpdateMode(e)},e.prototype.SetNavigationWidget=function(e){this.NavigationWidget=e},e.prototype.SetModifiedCallback=function(e){this.ModifiedCallback=e},e.prototype.SetModifiedClearCallback=function(e){this.ModifiedClearCallback=e},e.prototype.SelectNote=function(e){var t=e;while(t!=this.RootNote&&t.Parent&&t.Type!="UserNote")t=t.Parent;t!=this.RootNote&&t.Type!="UserNote"&&this.SetRootNote(t),e.ViewerRecords.length>0&&this.RequestUserNote(e.ViewerRecords[0].Image._id),SA.LinkDiv.is(":visible")&&SA.LinkDiv.fadeOut();if(t.Type!="UserNote"){var n=e;while(n&&n.Type=="View")n=n.Parent;n&&this.TextEditor.LoadNote(n)}if(e==this.SelectedNote)return;this.SelectedNote&&(this.SelectedNote.TitleEntry.css({background:"white"}),$("#"+this.SelectedNote.Id).css({background:"white"})),this.SelectedNote=e,e.TitleEntry.css({background:"#f0f0f0"}),$("#"+e.Id).css({background:"#e0e0ff"})},e.prototype.MarkAsModified=function(){this.ModifiedCallback&&this.ModifiedCallback(),this.Modified=!0},e.prototype.MarkAsNotModified=function(){this.ModifiedClearCallback&&this.ModifiedClearCallback(),this.Modified=!1},e.prototype.SetRootNote=function(e){this.UpdateTimer&&(clearTimeout(this.UpdateTimer),this.Update()),this.RootNote=e,this.DisplayRootNote(),this.UpdateQuestionMode()},e.prototype.EditOn=function(){SA.SaveButton.prop("title","save to database").attr("src",SA.ImagePathUrl+"save22.png").click(function(){self.SaveCallback()}),this.AddViewButton.show(),this.TextEditor.EditOn()},e.prototype.EditOff=function(){SA.SaveButton.prop("title","edit view").attr("src",SA.ImagePathUrl+"text_edit.png").click(function(){self.EditOn()}),this.AddViewButton.hide(),this.TextEditor.EditOff()},e.prototype.SaveCallback=function(e){SA.AddHtmlTags(this.TextEditor.TextEntry),SA.display.RecordAnnotations();var t=this.GetCurrentNote();t&&t.RecordView(this.Display),this.RootNote&&(t=this.RootNote),t.NotesPanelOpen=SA.resizePanel&&SA.resizePanel.Visibility;var n=this;t.Save(function(){n.Modified=!1,e&&e()})},e.prototype.GetCurrentNote=function(){return this.Display.GetNote()},e.prototype.SaveBrownNote=function(){var e=new SA.Note;e.RecordView(this.Display),e.SetParent(this.GetCurrentNote());var t;if(SAM.detectMobile()){var n=this.Display.GetViewer(0).GetCache().Image;t="/thumb?db="+n.database+"&img="+n._id+""}else{var r=SA.display.CreateThumbnailImage(110);t=r.src}$.ajax({type:"post",url:"/webgl-viewer/saveusernote",data:{note:JSON.stringify(e.Serialize(!0)),thumb:t,col:"views",type:"Favorite"},success:function(e,t){FAVORITES_WIDGET.FavoritesBar.LoadFavorites()},error:function(){SA.Debug("AJAX - error() : saveusernote 2")}})},e.prototype.RandomCallback=function(){var e=this.GetCurrentNote();e.Children.sort(function(e,t){return Math.random()-.5}),e.UpdateChildrenGUI()},e.prototype.DisplayRootNote=function(){if(!this.RootNote)return;SA.resizePanel&&SA.resizePanel.SetVisibility(this.RootNote.NotesPanelOpen,0),this.TextEditor.LoadNote(this.RootNote),this.LinksRoot.empty(),this.RootNote.DisplayGUI(this.LinksRoot),this.SelectNote(this.RootNote);if(SA.Edit){var e=this;this.AddViewButton.appendTo(this.LinksDiv).click(function(){var t=SA.notesWidget.RootNote,n=t.Children.length,r=t.NewChild(n,"New View");r.RecordView(e.Display),r.Save(),t.UpdateChildrenGUI(),this.Display.SetNote(r)})}this.RootNote.Text==""?this.TabbedWindow.ShowTabDiv(this.LinksDiv):this.TabbedWindow.ShowTabDiv(this.TextDiv)},e.prototype.NewCallback=function(){var e=this.GetCurrentNote(),t=0;if(e.Parent){var n=e.Children.indexOf(e);n>=0&&(t=n+1,e=e.Parent)}var r=e.NewChild(t,"New View");r.RecordView(this.Display),e.UpdateChildrenGUI(),e.Save(),this.Display.SetNote(r)},e.prototype.RequestUserNote=function(e){var t=SA.GetUserNoteFromImageId(e);if(t){if(t.LoadState<2)return;this.SetUserNote(t);return}var t=new SA.Note;t.Parent=e,t.Type="UserNote",t.LoadState==1;var n=this;$.ajax({type:"get",url:"/webgl-viewer/getusernotes",data:{imageid:e},success:function(e,r){n.LoadUserNote(e,t)},error:function(){SA.Debug("AJAX - error() : getusernotes"),SA.DeleteNote(t)}})},e.prototype.LoadUserNote=function(e,t){if(e.Notes.length>0){var n=e.Notes[0];t.Load(n);if(e.Notes.length>1){SA.Debug("Warning: More than one user note for the smae image..");for(var r=1;r<e.Notes.length;++r)t.Text+=e.Notes[r].Text}}else{var i=this.GetCurrentNote();if(i&&i.ViewerRecords.length>0){var s=new SA.ViewerRecord;s.DeepCopy(i.ViewerRecords[0]),t.ViewerRecords.push(s),s.Annotations=[]}}this.SetUserNote(t)},e.prototype.SetUserNote=function(e){if(SA.User!=""&&SA.VIEWER1){this.UserTextEditor.EditOn();var t=SA.VIEWER1.GetAnnotationLayer();if(e.ViewerRecords.length>0&&t){var n=e.ViewerRecords[0].Annotations;for(var r=0;r<n.length;++r){var i=t.LoadWidget(n[r]);i||(n.splice(r,1),--r)}SA.VIEWER1.EventuallyRender()}}if(this.UserNote==e)return;if(this.UserNote&&this.UserNote.Id==e.Id){console.log("Find out why this is happening");return}this.UserNote&&(this.UserNote.Text!=""||this.UserNote.Children.length>0)&&this.UserNote.Save(),this.UserNote=e,this.UserTextEditor.LoadNote(this.UserNote)},SA.NotesWidget=e}();(function(){function t(t,n,r){var i=this;t||alert("null parent: tab"),t=t||SA.MainDiv,this.Div=$("<div>").appendTo(t).attr("id",r).addClass("sa-view-div"),this.Button=$("<img>").appendTo(this.Div).attr("type","image").attr("src",n).addClass("sa-view-button").click(function(){i.TogglePanel()}).attr("draggable","false").on("dragstart",function(){return!1}),this.Panel=$("<div>").appendTo(this.Div).hide().addClass("sa-view-panel"),e.push(this),this.PanelOpen=!1}var e=[];t.prototype.show=function(){this.Div.show()},t.prototype.hide=function(){this.Div.hide()},t.prototype.TogglePanel=function(){this.PanelOpen?this.PanelOff():this.PanelOn()},t.prototype.PanelOn=function(){if(this.PanelOpen)return;this.PanelOpen=!0,this.Panel.show();var t=this.Panel.offset().left,n=t+this.Panel.outerWidth();for(var r=0;r<e.length;++r)if(e[r]!==this){var i=e[r].Panel.offset().left,s=i+e[r].Panel.outerWidth();i=Math.max(t,i),s=Math.min(n,s),i<s&&e[r].PanelOff()}this.Button.addClass("sa-active")},t.prototype.PanelOff=function(){this.PanelOpen=!1,this.Panel.hide(),this.Button.removeClass("sa-active")},SA.Tab=t})();(function(){"use strict";function r(e,t){var n=this;this.Viewer=t,this.Layer=e,e.AnnotationWidget=this,SAM.detectMobile(),this.Tab=new SA.Tab(e.GetCanvasDiv(),SA.ImagePathUrl+"pencil3Up.png","annotationTab"),this.Tab.Div.css({"box-sizing":"border-box",position:"absolute",bottom:"0px",right:"110px"}).prop("title","Annotation"),this.Tab.Panel.addClass("sa-view-annotation-panel"),this.VisibilityDiv=$("<div>").appendTo(this.Tab.Panel).addClass("sa-view-annotation-vis").prop("title","Visibility").click(function(){n.ToggleVisibility()}),this.VisibilityImage=$("<img>").appendTo(this.VisibilityDiv).addClass("sa-view-annotation-vis-img").addClass("sa-active").attr("type","image").attr("src",SA.ImagePathUrl+"toggleswitch.jpg"),this.TextButton=$("<img>").appendTo(this.Tab.Panel).addClass("sa-view-annotation-button sa-flat-button-active").addClass("sa-active").attr("type","image").attr("src",SA.ImagePathUrl+"Text.gif").prop("title","Text").click(function(){n.NewText()}),this.CircleButton=$("<img>").appendTo(this.Tab.Panel).addClass("sa-view-annotation-button sa-flat-button-active").addClass("sa-active").attr("type","image").attr("src",SA.ImagePathUrl+"Circle.gif").prop("title","Circle").click(function(){n.NewCircle()}),this.RectButton=$("<img>").appendTo(this.Tab.Panel).addClass("sa-view-annotation-button sa-flat-button-active").addClass("sa-active").attr("type","image").attr("src",SA.ImagePathUrl+"rectangle.gif").prop("title","Rectangle").click(function(){n.NewRect()}),this.GridButton=$("<img>").appendTo(this.Tab.Panel).addClass("sa-view-annotation-button sa-flat-button-active").addClass("sa-active").attr("type","image").attr("src",SA.ImagePathUrl+"grid.png").prop("title","Grid").click(function(){n.NewGrid()}),this.PolylineButton=$("<img>").appendTo(this.Tab.Panel).addClass("sa-view-annotation-button sa-flat-button-active").addClass("sa-active").attr("type","image").attr("src",SA.ImagePathUrl+"FreeForm.gif").prop("title","Polygon").click(function(){n.NewPolyline()}),this.PencilButton=$("<img>").appendTo(this.Tab.Panel).addClass("sa-view-annotation-button sa-flat-button-active").addClass("sa-active").attr("type","image").prop("title","Pencil").attr("src",SA.ImagePathUrl+"Pencil-icon.jpg").click(function(){n.NewPencil()}),this.LassoButton=$("<img>").appendTo(this.Tab.Panel).addClass("sa-view-annotation-button sa-flat-button-active").addClass("sa-active").attr("type","image").attr("src",SA.ImagePathUrl+"select_lasso.png").prop("title","Lasso").click(function(){n.NewLasso()}),window.SA&&this.Viewer&&(this.SectionsButton=$("<img>").appendTo(this.Tab.Panel).addClass("sa-view-annotation-button sa-flat-button-active").addClass("sa-active").attr("type","image").attr("src",SA.ImagePathUrl+"sections.png").prop("title","Segment").click(function(){n.DetectSections()}))}var e=0,t=1,n=2;r.prototype.show=function(){this.Tab.show()},r.prototype.hide=function(){this.Tab.hide()},r.prototype.SetVisibility=function(t){if(this.Layer.GetVisibility()==t)return;if(SA.notesWidget){var n=SA.notesWidget.GetCurrentNote();if(n&&n.Type=="Stack")for(var r=0;r<n.ViewerRecords.length;++r)n.ViewerRecords[r].AnnotationVisibility=t}this.VisibilityImage&&(t==e?this.VisibilityImage.css({top:"-30px"}):this.VisibilityImage.css({top:"1px"})),this.Layer.SetVisibility(t),this.Layer.EventuallyDraw()},r.prototype.GetVisibility=function(){return this.Layer.GetVisibility()},r.prototype.ToggleVisibility=function(){var t=this.GetVisibility();t==e?t=n:t=e,this.SetVisibility(t),window.SA&&SA.RecordState()},r.prototype.TogglePanel=function(){this.Panel.toggle(),this.Panel.is(":visible")?this.TabButton.addClass("sa-active"):this.TabButton.removeClass("sa-active")},r.prototype.NewText=function(){var e=this.TextButton,t=this.ActivateButton(e,SAM.TextWidget);t.ShowPropertiesDialog()},r.prototype.NewPencil=function(){var e=this.PencilButton,t=this.ActivateButton(e,SAM.PencilWidget)},r.prototype.NewLasso=function(){var e=this.LassoButton,t=this.ActivateButton(e,SAM.LassoWidget)},r.prototype.NewPolyline=function(){var e=this.PolylineButton,t=this.ActivateButton(e,SAM.PolylineWidget)},r.prototype.NewCircle=function(){var e=this.CircleButton,t=this.ActivateButton(e,SAM.CircleWidget)},r.prototype.NewRect=function(){var e=this.RectButton,t=this.ActivateButton(e,SAM.RectWidget)},r.prototype.NewGrid=function(){var e=this.GridButton,t=this.ActivateButton(e,SAM.GridWidget),n=this.Layer.GetCamera(),r=n.GetFocalPoint(),i=n.GetHeight()*.75,s=5,o=i/s,u=n.GetWidth()*.75,a=Math.floor(u/o);t.Grid.Origin=[r[0],r[1],0],t.Grid.Orientation=n.GetRotation(),this.Layer.DeactivateWidget(t)},r.prototype.NewFill=function(){var e=this.FillButton,t=this.ActivateButton(e,SAM.FillWidget);t.Initialize()},r.prototype.ActivateButton=function(e,t){var r=this.Layer.ActiveWidget;if(r){if(e.Pressed){r.Deactivate();return}r.Deactivate()}return e.Pressed=!0,e.addClass("sa-active"),this.SetVisibility(n),r=new t(this.Layer,!0),this.Layer.ActivateWidget(r),r.DeactivateCallback=function(){e.removeClass("sa-active"),r.DeactivateCallback=undefined,e.Pressed=!1},SA.Edit||(this.UserNoteFlag=!0),SA.notesWidget&&SA.notesWidget.IsUserTextTabOpen()&&(r.UserNoteFlag=!0),r},r.prototype.DetectSections=function(){if(!window.SA)return;var e=this.Layer.GetActiveWidget(),t=this.SectionsButton;if(e){if(t.Pressed){e.Deactivate();return}e.Deactivate()}t.Pressed=!0,t.addClass("sa-active");var e=null,n=this.Layer.GetWidgets();for(var r=0;r<n.length&&e==null;++r){var i=n[r];i.Type=="sections"&&(e=i)}if(e==null){e=new SA.SectionsWidget(this.Layer,this.Viewer,!1),e.ComputeSections(this.Viewer);if(e.IsEmpty()){this.Layer.RemoveWidget(e),t.removeClass("sa-active"),t.Pressed=!1;return}}e.SetActive(!0),e.DeactivateCallback=function(){t.removeClass("sa-active"),e.DeactivateCallback=undefined,t.Pressed=!1}},SA.AnnotationWidget=r})();(function(){"use strict";function e(){this.AnnotationVisibility=0,this.Annotations=[]}function t(){$.ajax({type:"get",url:"/webgl-viewer/gettrackingdata",success:function(e,t){t=="success"?n(e):SA.Debug("ajax failed - get tracking data")},error:function(){SA.Debug("AJAX - error() : gettrackingdata")}})}function n(e){alert(e)}SA.RECORDER_WIDGET=null,e.prototype.DeepCopy=function(e){this.AnnotationVisibility=e.AnnotationVisibility,this.Annotations=JSON.parse(JSON.stringify(e.Annotations)),this.Camera=new SAM.Camera,this.Camera.DeepCopy(e.Camera),this.Image=e.Image,this.OverviewBounds=e.OverviewBounds.slice(0)},e.prototype.Load=function(e){if(!e.Image.units&&e.Image.filename){var t=e.Image.filename.split("."),n=t[t.length-1];n=="ptif"&&(e.Image.spacing=[.25,.25,1],e.Image.units="µm")}if(!e.Camera){var r=e.Image.bounds;r&&(e.Camera={FocalPoint:[(r[0]+r[1])/2,(r[2]+r[3])/2],Height:r[3]-r[2],Width:r[1]-r[0],Roll:0})}for(var i in e)this[i]=e[i];this.Camera.Width===undefined&&(this.Camera.Width=this.Camera.Height*1.62),this.OverviewBounds||(this.OverviewBounds=this.Image.bounds);if(this.Annotations)for(var s=0;s<this.Annotations.length;++s){var o=this.Annotations[s];o&&o.color&&(o.color=SAM.ConvertColor(o.color))}if(this.Transform){var u=new SA.PairTransformation;u.Load(this.Transform),this.Transform=u}},e.prototype.CopyViewer=function(e){var t=e.GetCache();if(!t){this.Camera=null,this.AnnotationVisibility=!1,this.Annotations=[];return}this.OverviewBounds=e.GetOverViewBounds(),this.OverviewBounds=e.GetOverViewBounds(),this.Image=t.Image,this.Camera=e.GetCamera().Serialize();var n=e.Layers[0];if(!n)return;this.AnnotationVisibility=n.GetVisibility(),this.Annotations=[];var r=n.GetWidgets();for(var i=0;i<r.length;++i)this.Annotations.push(r[i].Serialize())},e.prototype.CopyAnnotations=function(e,t){this.Annotations=[];if(e.Layers.length==0)return;var n=e.Layers[0];if(!n)return;var r=e.Layers[0].GetWidgets();for(var i=0;i<r.length;++i){var s=r[i];s.UserNoteFlag=s.UserNoteFlag||!1;if(t==s.UserNoteFlag){var o=r[i].Serialize();o&&this.Annotations.push(o)}}},e.prototype.Serialize=function(){var e={};return e.Image=this.Image._id,e.Database=this.Image.database,e.NumberOfLevels=this.Image.levels,e.Camera=this.Camera,this.Annotations&&(e.Annotations=JSON.parse(JSON.stringify(this.Annotations))),e.AnnotationVisibility=this.AnnotationVisibility,this.OverviewBounds&&(e.OverviewBounds=this.OverviewBounds),this.Transform&&(e.Transform=this.Transform.Serialize()),e},e.prototype.Apply=function(e){e.Reset(),e.ActiveWidget&&e.ActiveWidget.SetActive(!1);var t=e.GetCache();if(!t||this.Image._id!=t.Image._id){var n=SA.FindCache(this.Image);e.SetCache(n)}e.SetOverViewBounds(this.OverviewBounds);if(this.Camera!==undefined&&this.Transform===undefined){var r=this.Camera;e.GetCamera().Load(r),e.OverView&&(e.OverView.Camera.Roll=r.Roll,e.OverView.Camera.ComputeMatrix()),e.UpdateZoomGui(),e.UpdateCamera()}e.AnnotationWidget&&this.AnnotationVisibility!=undefined&&e.AnnotationWidget.SetVisibility(this.AnnotationVisibility);if(this.Annotations!=undefined){var i=e.GetAnnotationLayer();if(i){i.Reset();for(var s=0;s<this.Annotations.length;++s){var o=i.LoadWidget(this.Annotations[s]);o||(this.Annotations.splice(s,1),--s)}}}e.UpdateSize()},e.prototype.LoadTiles=function(e){var t=SA.FindCache(this.Image),n=new SAM.Camera;n.Load(this.Camera),n.SetViewport(e),n.ComputeMatrix();var r=t.ChooseTiles(n,0,[]);for(var i=0;i<r.length;++i)SA.LoadQueueAddTile(r[i])},SA.RecordState=function(){SA.RECORDER_WIDGET&&SA.RECORDER_WIDGET.RecordState()};var r=function(e){SA.RECORDER_WIDGET||(SA.RECORDER_WIDGET=this);var t=this;this.Display=e,this.RecordTimerId=0,this.Records,this.TimeLine=[],this.RedoStack=[],this.Recording=!0,this.RecordingName="",this.RecordButton=$("<img>").appendTo("body").css({opacity:"0.5",position:"absolute",height:"20px",bottom:"120px",right:"20px","z-index":"1"}).attr("src",SA.ImagePathUrl+"stopRecording2.png").hide().click(function(){t.RecordingStop()}),this.UndoButton=$("<img>").appendTo("body").css({opacity:"0.5",position:"absolute",height:"30px",bottom:"5px",right:"100px","z-index":"1"}).attr("src",SA.ImagePathUrl+"undo.png").hide().click(function(){alert("undo")}),this.RedoButton=$("<img>").appendTo("body").css({opacity:"0.5",position:"absolute",height:"30px",bottom:"5px",right:"70px","z-index":"1"}).attr("src",SA.ImagePathUrl+"redo.png").hide().click(function(){alert("REDO")}),this.RecordingName=SA.getCookie("SlideAtlasRecording"),this.RecordingName!=undefined&&this.RecordingName!="false"&&(this.Recording=!0,this.UpdateGUI()),this.RecordState()};r.prototype.UpdateGUI=function(){this.Recording?this.RecordButton.show():this.RecordButton.hide()},r.prototype.RecordingStart=function(){if(this.Recording)return;this.Recording=!0;var e=new Date;this.RecordingName="Bev"+e.getTime(),SA.setCookie("SlideAtlasRecording",this.RecordingName,1),this.UpdateGUI(),this.RecordState()},r.prototype.RecordingStop=function(){if(!this.Recording)return;this.Recording=!1,SA.setCookie("SlideAtlasRecording","false",1),this.UpdateGUI()},r.prototype.RecordStateCallback=function(){if(this.Display.GetNumberOfViewers()==0)return;this.RecordTimerId=0,this.RedoStack=[];var e=new SA.Note;e.RecordView(this.Display);if(SA.display){var t=SA.display.GetNote();if(!t||!t.Id){this.RecordState();return}e.ParentId=t.Id,e.SetParent(t)}$.ajax({type:"post",url:"/webgl-viewer/saveusernote",data:{note:JSON.stringify(e.Serialize(!0)),col:"tracking",type:"Record"},success:function(t,n){e.Id=t},error:function(){}}),this.TimeLine.push(e)},r.prototype.RecordState=function(){if(this.Display.GetNumberOfViewers()==0)return;this.RecordTimerId&&(clearTimeout(this.RecordTimerId),this.RecordTimerId=0);var e=this;this.RecordTimerId=setTimeout(function(){e.RecordStateCallback()},1e3)},r.prototype.GetRecords=function(){var e=this;$.ajax({type:"get",url:"/webgl-viewer/getfavoriteviews",data:{col:"tracking"},success:function(t,n){e.Records=t.viewArray},error:function(){SA.Debug("AJAX - error() : get records")}})},r.prototype.RecordState=function(){this.RecordTimerId&&(clearTimeout(this.RecordTimerId),this.RecordTimerId=0);var e=this;this.RecordTimerId=setTimeout(function(){e.RecordStateCallback()},1e3)},r.prototype.UndoState=function(){if(this.TimeLine.length>1){var e=this.TimeLine.pop();this.RedoStack.push(e),e=this.TimeLine[this.TimeLine.length-1],SA.SetNote(e)}},r.prototype.RedoState=function(){if(this.RedoState.length==0)return;var e=this.RedoStack.pop();this.TimeLine.push(e),e.DisplayView()},SA.ViewerRecord=e,SA.RecorderWidget=r})();(function(){"use strict";function e(e,t){this.Display=t,this.SlideIndex=0,this.Session=[],this.NoteIterator=new SA.NoteIterator;var n=this,r="40px",i="170px",s="10px";if(SAM.detectMobile()){this.Tab={},this.Tab.Panel=$("<div>").appendTo(t.GetViewer(0).GetDiv()).hide().addClass("ui-responsive").css({position:"absolute",left:"50px",bottom:"20px","z-index":"5"});var o=this.Tab.Panel;this.Tab.show=function(){o.show()},this.Tab.hide=function(){o.hide()}}else this.Tab=new SA.Tab(e,SA.ImagePathUrl+"nav.png","navigationTab"),this.Tab.Div.prop("title","Navigation"),this.Tab.Div.addClass("sa-view-navigation-div"),this.Tab.Panel.addClass("sa-view-navigation-panel"),this.NoteDisplay=$("<div>").appendTo(this.Tab.Div).addClass("sa-view-note").html("");this.PreviousSlideButton=$("<img>").appendTo(this.Tab.Panel).addClass("sa-view-navigation-button").attr("src",SA.ImagePathUrl+"previousSlide.png").prop("title","Previous Slide. (page-up)").click(function(){n.PreviousSlide()}),this.PreviousNoteButton=$("<img>").appendTo(this.Tab.Panel).addClass("sa-view-navigation-button").attr("src",SA.ImagePathUrl+"previousNote.png").prop("title","Previous Note. (p)").click(function(){n.PreviousNote()}),this.NextNoteButton=$("<img>").appendTo(this.Tab.Panel).addClass("sa-view-navigation-button").attr("src",SA.ImagePathUrl+"nextNote.png").prop("title","Next Note, (n, space)").click(function(){n.NextNote()}),this.NextSlideButton=$("<img>").appendTo(this.Tab.Panel).addClass("sa-view-navigation-button").attr("src",SA.ImagePathUrl+"nextSlide.png").prop("title","Next Slide. (page-down)").css({"z-index":"100"}).click(function(){n.NextSlide()}),this.NextSlideButton.on("touchend",function(e){return n.NextSlide(),!1}),SAM.MOBILE_DEVICE&&(r="80px",SAM.MOBILE_DEVICE=="iPhone"&&(r="100px"),this.PreviousSlideButton.css({height:r,width:r,opacity:"0.8"}).on("touchend",function(){n.PreviousSlide()}),this.PreviousNoteButton.css({height:r,width:r,opacity:"0.8"}).on("touchend",function(){n.PreviousNote()}),this.NextNoteButton.css({height:r,width:r,opacity:"0.8"}).on("touchend",function(){n.NextNote()}),this.NextSlideButton.css({height:r,width:r,opacity:"0.8"})),this.CopyrightWrapper=$("<div>").appendTo(e).css({width:"100%","text-align":"center"}).html()}function t(e){this.Note=e,this.ChildIterator=null}e.prototype.SetInteractionEnabled=function(e){var t=this;e?this.Display.Parent.on("keydown.navigation",function(e){return t.HandleKeyDown(e)}):this.Display.Parent.off("keydown.navigation")},e.prototype.HandleKeyDown=function(e){var t=e.keyCode;return t==34?(this.NextSlide(),!1):t==78||t==32?(this.NextNote(),!1):t==33?(this.PreviousSlide(),!1):t==80?(this.PreviousNote(),!1):!0},e.prototype.SetNote=function(e){if(this.NoteIterator.GetNote()==e)return;var t=this;this.SessionId?e.SessionId=this.SessionId:SA.Session?(this.Session=SA.Session.session.views,this.SessionId=SA.Session.sessid,this.Update()):e.SessionId&&SA.RootNote.Type!="HTML"&&(this.SessionId=e.SessionId,$.ajax({type:"get",url:SA.SessionUrl+"?json=true&sessid="+this.SessionId,success:function(e,n){if(t.SessionId!=e.sessid){console.log("expecting a second session to load.");return}t.Session=e.session.views,t.Update()},error:function(){SA.Debug("AJAX - error() : session")}})),this.NoteIterator.SetNote(e),this.Update()},e.prototype.GetNote=function(){return this.NoteIterator.GetNote()},e.prototype.ToggleVisibility=function(){this.SetVisibility(!this.Visibility)},e.prototype.SetVisibility=function(e){this.Visibility=e,e?this.Tab.show():this.Tab.hide()},e.prototype.Update=function(){this.PreviousNoteButton.removeClass("sa-active"),this.NextNoteButton.removeClass("sa-active");var e=this.NoteIterator.GetNote();if(e){for(var t=0;t<this.Session.length;++t)this.Session[t].id==e.Id&&(this.SlideIndex=t);e.Type=="Stack"?(e.StartIndex>0&&this.PreviousNoteButton.addClass("sa-active"),e.StartIndex<e.ViewerRecords.length-1&&this.NextNoteButton.addClass("sa-active")):(this.NoteIterator.IsStart()||this.PreviousNoteButton.addClass("sa-active"),this.NoteIterator.IsEnd()||this.NextNoteButton.addClass("sa-active"))}this.SlideIndex<=0?this.PreviousSlideButton.removeClass("sa-active"):this.PreviousSlideButton.addClass("sa-active"),this.SlideIndex>=this.Session.length-1?this.NextSlideButton.removeClass("sa-active"):this.NextSlideButton.addClass("sa-active"),SA.RootNote&&SA.RootNote.Type=="HTML"&&(this.PreviousSlideButton.removeClass("sa-active"),this.NextSlideButton.removeClass("sa-active"))},e.prototype.PreviousNote=function(){SA.StackCursorFlag=!1;var e=this.NoteIterator.GetNote();if(e.Type=="Stack"){if(e.StartIndex<=0)return;var t=this.Display.GetViewer(1),n=this.Display.GetViewer(0),r=n.GetCamera(),i=r.FocalPoint.slice(),s=r.GetRotation(),o=r.GetHeight();this.Display.RecordAnnotations(),--e.StartIndex,SA.display=this.Display,SA.SetNote(e),t.SetCamera(i,s,o),e.DisplayStack(this.Display),this.Display.SynchronizeViews(1,e),this.Update(),this.NoteDisplay&&this.NoteDisplay.html(""+e.StartIndex);return}if(this.NoteIterator.IsStart()){this.PreviousSlide();return}SA.display.RecordAnnotations();var u=this.NoteIterator.Previous();this.SetNote(u),this.Update(),SA.display=this.Display,SA.display.RecordAnnotations(),SA.SetNote(u)},e.prototype.NextNote=function(){SA.StackCursorFlag=!1;var e=this.NoteIterator.GetNote();if(e.Type=="Stack"){if(e.StartIndex>=e.ViewerRecords.length-1)return;var t=this.Display.GetViewer(0),n=this.Display.GetViewer(1),r=n.GetCamera(),i=r.FocalPoint.slice(),s=r.GetRotation(),o=r.GetHeight();this.Display.RecordAnnotations(),++e.StartIndex,SA.display=this.Display,SA.SetNote(e),t.SetCamera(i,s,o),e.DisplayStack(this.Display),this.Display.SynchronizeViews(0,e),this.Update(),this.NoteDisplay&&this.NoteDisplay.html(""+e.StartIndex);return}if(this.NoteIterator.IsEnd()){this.NextSlide();return}var u=this.NoteIterator.Next();this.Update(),SA.display=this.Display,SA.display.RecordAnnotations(),SA.SetNote(u)},e.prototype.PreviousSlide=function(){SA.StackCursorFlag=!1;var e=this.SlideIndex-1;while(e>=0&&this.Session[e].Type=="Presentation")--e;if(e<0)return;var t=!0;SA.notesWidget&&SA.notesWidget.Modified&&(t=confirm("Unsaved edits will be lost.  Are you sure you want to move to the next slide?")),t&&(SA.notesWidget&&SA.notesWidget.MarkAsNotModified(),this.SlideIndex=e,SA.SetNoteFromId(this.Session[this.SlideIndex].id),this.NoteDisplay&&this.NoteDisplay.html(""))},e.prototype.NextSlide=function(){SA.StackCursorFlag=!1;var e=this.SlideIndex+1;while(e<this.Session.length&&this.Session[e].Type=="Presentation")++e;if(e>=this.Session.length)return;var t=!0;SA.notesWidget&&SA.notesWidget.Modified&&(t=confirm("Unsaved edits will be lost.  Are you sure you want to move to the next slide?")),t&&(SA.notesWidget&&SA.notesWidget.MarkAsNotModified(),this.SlideIndex=e,SA.SetNoteFromId(this.Session[this.SlideIndex].id),this.NoteDisplay&&this.NoteDisplay.html(""))},t.prototype.GetChildArray=function(){return this.Note?this.Note.Children:[]},t.prototype.GetChildIndex=function(){return this.ChildIterator==null?-1:this.GetChildArray().indexOf(this.ChildIterator.Note)},t.prototype.GetParentNote=function(){if(this.ChildIterator==null)return null;var e=this.ChildIterator.GetParentNote();return e==null&&(e=this.Note),e},t.prototype.IsStart=function(){return this.ChildIterator==null?!0:!1},t.prototype.IsEnd=function(){if(!this.Note)return!0;if(this.ChildIterator==null)return this.Note.Children.length>0&&this.Note.ChildrenVisibility?!1:!0;var e=this.GetChildIndex();return e==this.GetChildArray().length-1?this.ChildIterator.IsEnd():!1},t.prototype.Next=function(){if(!this.Note)return;if(this.ChildIterator==null)return this.Note.Children.length>0&&this.Note.ChildrenVisibility?(this.ChildIterator=this.GetChildArray()[0].NewIterator(),this.ChildIterator.GetNote()):this.Note;if(!this.ChildIterator.IsEnd())return this.ChildIterator.Next();var e=this.GetChildIndex();return e<this.GetChildArray().length-1?(this.ChildIterator=this.GetChildArray()[e+1].NewIterator(),this.ChildIterator.GetNote()):this.ChildIterator.GetNote()},t.prototype.Previous=function(){if(!this.Note)return;if(this.ChildIterator==null)return this.Note;if(!this.ChildIterator.IsStart())return this.ChildIterator.Previous();var e=this.GetChildIndex()-1;return e>=0?(this.ChildIterator=this.GetChildArray()[e].NewIterator(),this.ChildIterator.ToEnd(),this.ChildIterator.GetNote()):(this.ChildIterator=null,this.Note)},t.prototype.ToStart=function(){this.ChildIterator&&(this.ChildIterator=null)},t.prototype.ToEnd=function(){if(!this.Note)return;if(this.Note.Children.length>0&&this.Note.ChildrenVisibility){this.ChildArray=this.Note.Children;var e=this.ChildArray.length-1;return this.ChildIterator=this.ChildArray[e].NewIterator(),this.ChildIterator.ToEnd()}return this.ChildArray=null,this.ChildIterator=null,this.Note},t.prototype.SetNote=function(e){if(this.GetNote()==e)return;this.ToStart();for(;;){if(this.GetNote()==e)return;if(this.IsEnd()){this.ToStart(),this.Note=e;return}this.Next()}},t.prototype.GetNote=function(){return this.ChildIterator!=null?this.ChildIterator.GetNote():this.Note},SA.NoteIterator=t,SA.NavigationWidget=e})();(function(){"use strict";function e(e,t){this.Tab=new SA.Tab(e,SA.ImagePathUrl+"star.png","favorites"),this.Tab.Div.css({position:"absolute",bottom:"0px",left:"10px"}).prop("title","Annotation"),this.Tab.Panel.css({position:"absolute",right:"-400px",left:"-5px",height:"160px"}),this.FavoritesBar=new SA.FavoritesBar(this.Tab.Panel,t),this.FavoritesBar.LoadFavorites()}e.prototype.HandleResize=function(e){this.Tab.Panel.css({left:"-5px",width:e-20+"px"})},SA.FavoritesWidget=e})();(function(){"use strict";function e(e,t){var n=this;this.FavoritesGUI=this,this.Display=t,this.FavoritesList=e,this.SaveFavoriteButton=$("<img>").appendTo(this.FavoritesList).addClass("sa-view-favorites-icon").attr("src",SA.ImagePathUrl+"saveNew.png").click(function(){n.SaveFavorite()}),this.SaveFavoriteButton.prop("title","Save Favorite"),SAM.MOBILE_DEVICE&&this.SaveFavoriteButton.addClass("sa-view-favorites-button"),this.ImageList=$("<div>").appendTo(this.FavoritesList).addClass("sa-view-favorites-img-list"),this.LoadFavorites()}e.prototype.Hide=function(){this.hidden||(this.FavoritesList.fadeOut(),this.hidden=!0)},e.prototype.ShowHideFavorites=function(){if(this.hidden){this.FavoritesList.show(),this.hidden=!1;var e=this;for(var t=0;t<this.Display.GetNumberOfViewers();++t)this.Display.GetViewer(t).OnInteraction(function(){e.Hide()})}else this.FavoritesList.fadeOut(),this.hidden=!0},e.prototype.SaveFavorite=function(){SA.notesWidget.SaveBrownNote();var e=FAVORITES_WIDGET.FavoritesBar.SaveFavoriteButton;e.addClass("sa-inactive"),setTimeout(function(){e.removeClass("sa-inactive")},500)},e.prototype.LoadFavorites=function(){var e=this;$.ajax({type:"get",url:"/webgl-viewer/getfavoriteviews",success:function(t,n){n=="success"?e.LoadFavoritesCallback(t):SA.Debug("ajax failed - get favorite views")},error:function(){SA.Debug("AJAX - error() : getfavoriteviews")}})},e.prototype.LoadFavoritesCallback=function(e){var t=this;this.Favorites=e.viewArray,this.FavoritesGUI.ImageList.html("");for(var n=e.viewArray.length-1;n>=0;--n)var r=$("<div>").appendTo(this.FavoritesGUI.ImageList).addClass("sa-view-favorites-callback-div"),i=e.viewArray[n].Thumb,s=$("<img>").appendTo(r).attr("src",i).attr("height","110px").addClass("sa-view-favorites-callback-img").attr("index",n).click(function(){t.LoadFavorite(this)}),o=$("<div>").appendTo(r).html("X").addClass("sa-view-favorites-callback-del").attr("index",n).click(function(){t.DeleteFavorite(this)})},e.prototype.LoadFavorite=function(e){var t=new SA.Note,n=$(e).attr("index");t.Load(this.Favorites[n]),SA.SetNote(t)},e.prototype.DeleteFavorite=function(e){var t=$(e).attr("index");$.ajax({type:"post",url:"/webgl-viewer/deleteusernote",data:{noteId:this.Favorites[t]._id,col:"views"},success:function(e,t){},error:function(){SA.Debug("AJAX - error() : deleteusernote")}}),this.FavoritesGUI.ImageList.html(""),this.LoadFavorites()},SA.FavoritesBar=e})();(function(){"use strict";function e(){var e="80px",t="0px",n="170px";SAM.detectMobile()=="iPhone"&&(e="100px",n="80px",left="80px");var r=this;this.Div=$("<div>").appendTo(SA.VIEWERS[0].GetDiv()).css({position:"absolute",right:"0px",bottom:"0px","z-index":"5"}),this.CircleButton=$("<img>").appendTo(this.Div).css({height:e,width:e,opacity:"0.6",margin:"1px",padding:"5px"}).attr("src",SA.ImagePathUrl+"Circle128.jpg").on("touchend",function(){r.CircleCallback()}),this.CircleButton.prop("title","Circle Annotation"),this.TextButton=$("<img>").appendTo(this.Div).css({height:e,width:e,opacity:"0.6",margin:"1px",padding:"5px"}).attr("src",SA.ImagePathUrl+"Text128.jpg").on("touchend",function(){r.TextCallback()}),this.TextButton.prop("title","Text Annotation"),this.Visibility=!1;var r=this}e.prototype.CircleCallback=function(){console.log("New circle"),this.Layer=SA.VIEWERS[0].GetAnnotationLayer(),this.Layer.ActiveWidget!=undefined&&e&&this.Layer.ActiveWidget.Deactivate();var e=new SAM.CircleWidget(this.Layer,!1),t=this.Layer.GetCamera(),n=t.FocalPoint[0],r=t.FocalPoint[1];e.Shape.Origin=[n,r],e.Shape.Radius=t.Height/4,e.Shape.UpdateBuffers(this.Layer.AnnotationView),eventuallyRender(),this.Layer.SetVisibility(!0)},e.prototype.TextCallback=function(){this.Layer=SA.VIEWERS[0].GetAnnotationLayer();var e=this.Layer.ActiveWidget;e&&e.Deactivate(),this.Layer.SetVisibility(!0);var e=new SAM.TextWidget(this.Layer,""),t=this.Layer.GetCamera(),n=t.FocalPoint[0],r=t.FocalPoint[1];e.Text.Anchor[0]=n,e.Text.Anchor[1]=r,this.Layer.EventuallyDraw(),this.Layer.ActivateWidget(e),e.ShowPropertiesDialog()},e.prototype.SetVisibility=function(e){this.Visibility=e,e?this.Div.show():this.Div.hide()},e.prototype.ToggleVisibility=function(){this.SetVisibility(!this.Visibility),FAVORITES_WIDGET&&FAVORITES_WIDGET.FavoritesBar.ShowHideFavorites()},SA.MobileAnnotationWidget=e})();(function(){"use strict";function e(e){var t=this;this.Position="absolute",this.Editable=!1,this.Interactive=!0,this.Div=e,this.ClickCallback=null,this.DeleteCallback=null,this.LockActive=!1,this.Div.css({overflow:"hidden"}).hover(function(){t.ActiveOn()},function(){t.ActiveOff()}),this.Div.on("mousedown.element",function(e){return t.HandleMouseDown(e)}).on("tap.element",function(e){return this.ClickCallback?(this.ClickCallback(this.Div[0]),!1):!0}),this.ButtonDiv=$("<div>").addClass("sa-edit-gui").css({height:"20px",position:"absolute",top:"0px",left:"0px",cursor:"auto","z-index":"1000"}).mousedown(function(){return!1}),this.DeleteButton=$("<img>").appendTo(this.ButtonDiv).addClass("editButton").css({height:"16px",position:"absolute",top:"0px",left:"0px"}).attr("src",SA.ImagePathUrl+"remove.png").prop("title","delete"),this.MenuButton=$("<img>").appendTo(this.ButtonDiv).addClass("editButton").css({height:"16px",position:"absolute",top:"0px",left:"20px"}).attr("src",SA.ImagePathUrl+"Menu.jpg").prop("title","properties"),this.InitializeDialog()}function t(e){var t=this;this.Div=e;var n=e[0].saElement;this.BackgroundPanel=n.AddAccordionTab("Background",function(){t.DialogInitialize()},function(){t.DialogApply()}),this.BackgroundLine1=$("<div>").appendTo(this.BackgroundPanel).css({width:"100%"}),this.BackgroundCheck=$('<input type="checkbox">').appendTo(this.BackgroundLine1).change(function(){$(this).is(":checked")?t.BackgroundColor.spectrum("enable"):t.BackgroundColor.spectrum("disable")}),this.BackgroundColorLabel=$("<div>").appendTo(this.BackgroundLine1).css({display:"inline-block",padding:"0px 5px",width:"4em",height:"20px","text-align":"right"}).text("Color"),this.BackgroundColorDiv=$("<div>").appendTo(this.BackgroundLine1).css({display:"inline-block",height:"18px","margin-left":"1em"}),this.BackgroundColor=$('<input type="text">').appendTo(this.BackgroundLine1).val("#005077").spectrum({showAlpha:!0}),this.BackgroundColor.spectrum("disable"),this.BackgroundLine2=$("<div>").appendTo(this.BackgroundPanel).css({width:"100%"}),this.GradientCheck=$('<input type="checkbox">').appendTo(this.BackgroundLine2).change(function(){$(this).is(":checked")?(t.GradientColor.spectrum("enable"),t.GradientColor.spectrum("show")):(t.GradientColor.spectrum("disable"),t.GradientColor.spectrum("hide"))}),this.GradientLabel=$("<div>").appendTo(this.BackgroundLine2).css({display:"inline-block",padding:"0px 5px",width:"4em",height:"20px","text-align":"right"}).text("Gradient"),this.GradientColorDiv=$("<div>").appendTo(this.BackgroundLine2).css({display:"inline-block",height:"18px","margin-left":"1em"}),this.GradientColor=$('<input type="text">').appendTo(this.GradientColorDiv).val("#005077").spectrum({showAlpha:!0})}function n(e){var t=this;this.Div=e;var n=e[0].saElement;this.PaddingPanel=n.AddAccordionTab("Margins",function(){t.DialogPaddingInitialize()},function(){t.DialogPaddingApply()}),this.PaddingLeftLine=$("<div>").appendTo(this.PaddingPanel).css({width:"100%"}),this.PaddingLeftLabel=$("<div>").appendTo(this.PaddingLeftLine).css({display:"inline-block",padding:"0px 5px",width:"4em",height:"20px","text-align":"right"}).text("Left:"),this.PaddingLeft=$('<input type="number">').appendTo(this.PaddingLeftLine).keypress(function(e){return e.keyCode!=13}),this.PaddingTopLine=$("<div>").appendTo(this.PaddingPanel).css({width:"100%"}),this.PaddingTopLabel=$("<div>").appendTo(this.PaddingTopLine).css({display:"inline-block",padding:"0px 5px",width:"4em",height:"20px","text-align":"right"}).text("Top:"),this.PaddingTop=$('<input type="number">').appendTo(this.PaddingTopLine).keypress(function(e){return e.keyCode!=13}),this.PaddingRightLine=$("<div>").appendTo(this.PaddingPanel).css({width:"100%"}),this.PaddingRightLabel=$("<div>").appendTo(this.PaddingRightLine).css({display:"inline-block",padding:"0px 5px",width:"4em",height:"20px","text-align":"right"}).text("Right:"),this.PaddingRight=$('<input type="number">').appendTo(this.PaddingRightLine).keypress(function(e){return e.keyCode!=13}),this.PaddingBottomLine=$("<div>").appendTo(this.PaddingPanel).css({width:"100%"}),this.PaddingBottomLabel=$("<div>").appendTo(this.PaddingBottomLine).css({display:"inline-block",padding:"0px 5px",width:"4em",height:"20px","text-align":"right"}).text("Bottom:"),this.PaddingBottom=$('<input type="number">').appendTo(this.PaddingBottomLine).keypress(function(e){return e.keyCode!=13})}function r(e){var t=this;this.Div=e,this.Div.addClass("sa-question");var n=e[0].saElement;n.Dialog.Dialog.css({width:"500px"}),this.QuestionPanel=n.AddAccordionTab("Question",function(){t.DialogInitialize()},function(){t.DialogApply()}),this.DialogInitialize()}function i(e){var t=this;this.Div=e,this.Div.addClass("sa-text-editor"),e.saText({click:function(){t.EditingOn()}});var n=e[0].saElement;this.TextPanel=n.AddAccordionTab("Text",function(){t.DialogInitialize()},function(){t.DialogApply()}),this.FontSizeDiv=$("<div>").appendTo(this.TextPanel).css({height:"32px"}).addClass("sa-view-annotation-modal-div"),this.FontSizeLabel=$("<div>").appendTo(this.FontSizeDiv).text("Font Size:").addClass("sa-view-annotation-modal-input-label"),this.FontSize=$('<input type="number">').appendTo(this.FontSizeDiv).addClass("sa-view-annotation-modal-input").keypress(function(e){return e.keyCode!=13}),this.FontColorDiv=$("<div>").appendTo(this.TextPanel).css({height:"32px"}).addClass("sa-view-annotation-modal-div"),this.FontColorLabel=$("<div>").appendTo(this.FontColorDiv).text("Color:").addClass("sa-view-annotation-modal-input-label"),this.FontColor=$('<input type="text">').appendTo(this.FontColorDiv).val("#050505").spectrum({showAlpha:!0}),this.LineHeightDiv=$("<div>").appendTo(this.TextPanel).css({height:"32px"}).addClass("sa-view-annotation-modal-div"),this.LineHeightLabel=$("<div>").appendTo(this.LineHeightDiv).text("Line Height %:").addClass("sa-view-annotation-modal-input-label"),this.LineHeight=$('<input type="number">').appendTo(this.LineHeightDiv).addClass("sa-view-annotation-modal-input").val(1).keypress(function(e){return e.keyCode!=13}),this.Div.css({overflow:"visible"}),this.EditButtonDiv=$("<div>").appendTo(this.Div.parent()).addClass("sa-edit-gui").css({height:"20px",position:"absolute",width:"275px",cursor:"auto"}).hide().mousedown(function(){return!1}),this.AddButton(SA.ImagePathUrl+"link.png","link URL",function(){t.InsertUrlLink()}),this.AddButton(SA.ImagePathUrl+"font_bold.png","bold",function(){document.execCommand("bold",!1,null)}),this.AddButton(SA.ImagePathUrl+"text_italic.png","italic",function(){document.execCommand("italic",!1,null)}),this.AddButton(SA.ImagePathUrl+"edit_underline.png","underline",function(){document.execCommand("underline",!1,null)}),this.AddButton(SA.ImagePathUrl+"list_bullets.png","unorded list",function(){document.execCommand("InsertUnorderedList",!1,null)}),this.AddButton(SA.ImagePathUrl+"list_numbers.png","ordered list",function(){document.execCommand("InsertOrderedList",!1,null)}),this.AddButton(SA.ImagePathUrl+"indent_increase.png","indent",function(){document.execCommand("indent",!1,null)}),this.AddButton(SA.ImagePathUrl+"indent_decrease.png","outdent",function(){document.execCommand("outdent",!1,null)}),this.AddButton(SA.ImagePathUrl+"alignment_left.png","align left",function(){document.execCommand("justifyLeft",!1,null)}),this.AddButton(SA.ImagePathUrl+"alignment_center.png","align center",function(){document.execCommand("justifyCenter",!1,null)}),this.AddButton(SA.ImagePathUrl+"alignment_full.png","align full",function(){document.execCommand("justifyFull",!1,null)}),this.AddButton(SA.ImagePathUrl+"edit_superscript.png","superscript",function(){document.execCommand("superscript",!1,null)}),this.AddButton(SA.ImagePathUrl+"edit_subscript.png","subscript",function(){document.execCommand("subscript",!1,null)})}function s(e){var t=this;e[0].saElement.SetClickCallback(function(){t.Expand(!0)}),this.Div=e,this.Expanded=!1,this.ExpandCallback=null,this.AspectRatio=!1,this.Interactive=!0;var n=e.parent();this.Mask=n.find(".sa-light-box-mask"),this.Mask.length==0&&(this.Mask=$("<div>").appendTo(n).addClass("sa-light-box-mask").addClass("sa-edit-gui").hide().css({position:"absolute",left:"0px",top:"0px",width:"100%",height:"100%","z-index":"99",opacity:"0.5","background-color":"#000"}))}function o(e,t,n){if(!e.saDialog){var r=new SAM.Dialog(function(){f(e)});r.ShowCallbacks||(r.ShowCallbacks=[]),r.ApplyCallbacks||(r.ApplyCallbacks=[]),p(e,SA.ImagePathUrl+"Menu.jpg","properties",function(){a(e)}),e.saDialog=r}return t&&e.saDialog.ShowCallbacks.push(t),n&&e.saDialog.ApplyCallbacks.push(n),e.saDialog}function c(e){if(!e.saButtons){var t=new h($(e));e.saButtons=t}return e.saButtons.ButtonsDiv}function h(e){this.Enabled=!0,this.Div=e,this.TimerId=-1;var t=e.position();this.ButtonsDiv=$("<div>").appendTo(e.parent()).addClass("sa-edit-gui").hide().css({position:"absolute",left:t.left+10+"px",top:t.top-20+"px",width:"360px","z-index":"10"}),this.ButtonsDiv[0].saButtons=this;var n=this;this.ButtonsDiv.mouseenter(function(){n.ShowButtons(2)}).mouseleave(function(){n.HideButtons()}),this.Div.mouseenter(function(){n.ShowButtons(1)}).mouseleave(function(){n.HideButtons()})}function p(e,t,n,r,i){var s=c(e),o=$("<img>").addClass("editButton").css({height:"16px"}).attr("src",t);return r&&o.click(r),n&&o.prop("title",n),i?o.prependTo(s):o.appendTo(s),o}function d(e){if(!e.saButtons)return;e.saButtons.Enabled=!1,e.saButtons.ButtonsDiv.hide()}function v(e){if(!e.saButtons)return;e.saButtons.Enabled=!0}function m(e){if(!e.saButtons)return;e.saButtons.ButtonsDiv.remove()}function g(e,t){var n=undefined;typeof t[0]=="object"&&(n=t[0]),n&&n.prefixUrl&&(SA.ImagePathUrl=n.prefixUrl,SAM.ImagePathUrl=n.prefixUrl),$(window).off("resize.sa").on("resize.sa",y);for(var r=0;r<e.length;++r){if(t[0]=="destroy"){$(e[r]).removeClass("sa-resize"),$(e[r]).removeClass("sa-resize"),$(e[r]).removeClass("sa-viewer"),e[r].saViewer&&(e[r].saViewer.Delete(),delete e[r].saViewer);continue}e[r].saViewer||(n&&(e.hasClass("sa-dual-viewer")&&(n.dual=!0),n.dual?e[r].saViewer=new SA.DualViewWidget($(e[r])):e[r].saViewer=new SA.Viewer($(e[r]))),e[r].onresize=function(){this.saViewer.UpdateSize()},$(e[r]).addClass("sa-resize"));var i=e[r].saViewer;if(i&&typeof i[t[0]]=="function")return i[t[0]].apply(i,Array.prototype.slice.call(t,1));n&&e[r].saViewer.ProcessArguments(n),e[r].saViewer.EventuallyRender()}}function y(){var e=window.innerHeight,t=window.innerWidth,n=0,r=0,i=$(".sa-full-height");for(var s=0;s<i.length;++s){var o=i[s];$(o).css({top:"0px",height:e+"px"})}var u=$(".sa-resize");for(var s=0;s<u.length;++s)u[s].onresize&&u[s].onresize()}function b(e,t){this.Div=e,this.AspectRatio=t.aspectRatio,this.Zoom=1,this.ShiftX=0,this.ShiftY=0;var n=this}function w(e){this.XStops=null,this.YStops=null,this.Percentage=!0,this.Div=e;var t=this,n=p(e[0],SA.ImagePathUrl+"fullscreen.png","drag",null,!0);n.mousedown(function(e){var n=t.Div.parent();t.Div.detach(),t.Div.appendTo(n),t.Div.css({"z-index":"5"}),t.OldX=e.pageX,t.OldY=e.pageY;var r=t.Div.position(),i=r.left,s=r.top,o=t.Div.parent().width(),u=t.Div.parent().height();return t.XStops&&t.XStops.Start(i,o),t.YStops&&t.YStops.Start(s,u),$("body").on("mousemove.saDrag",function(e){return t.Drag(e.pageX-t.OldX,e.pageY-t.OldY),t.OldX=e.pageX,t.OldY=e.pageY,!1}),$("body").on("mouseup.saDrag",function(e){return t.Div.css("z-index",""),$("body").off("mousemove.saDrag"),$("body").off("mouseup.saDrag"),!1}),!1})}function E(e){this.Threshold=25,this.Stopped=!1,this.Stop=0,this.Delta=0,this.Target=0,this.Gap=100,this.Divisions=e,this.Last=0}function S(e){var t=this;this.FullWindowOptionButton=$("<img>").appendTo(e).attr("src",SA.ImagePathUrl+"fullscreenOn.png").prop("title","full window").css({position:"absolute",width:"12px",left:"-5px",top:"-5px",opacity:"0.5","z-index":"-1"}).hover(function(){$(this).css({opacity:"1.0"})},function(){$(this).css({opacity:"0.5"})}).click(function(){t.SetFullWindow(e,!0)}),this.FullWindowOptionOffButton=$("<img>").appendTo(e).hide().attr("src",SA.ImagePathUrl+"fullscreenOff.png").prop("title","full window off").css({position:"absolute",background:"#FFF",width:"16px",left:"1px",top:"1px",opacity:"0.5","z-index":"1"}).hover(function(){$(this).css({opacity:"1.0"})},function(){$(this).css({opacity:"0.5"})}).click(function(){t.SetFullWindow(e,!1)})}function x(e){this.Button=p(e,SA.ImagePathUrl+"remove.png","delete",function(){item.saViewer&&T(item.saViewer),m(e),$(e).remove()},!0)}function T(e){var t=e.saViewerIndex,n=e.saNote,r=$(".sa-lightbox-viewer");for(var i=0;i<r.length;++i)r[i].saViewer&&r[i].saViewer.saNote==n&&r[i].saViewer.saViewerIndex>t&&--r[i].saViewer.saViewerIndex;n.ViewerRecords.splice(t,1)}function N(e){var t=this;this.Width=353,this.PanelDiv=$("<div>").appendTo(e).css({"background-color":"white",position:"absolute",top:"0px",bottom:"0px",left:"0px",width:this.Width+"px"}).attr("draggable","false").on("dragstart",function(){return!1}),this.MainDiv=$("<div>").appendTo(e).css({position:"absolute",top:"0px",bottom:"0px",left:this.Width+"px",right:"0px","border-left":"1px solid #AAA"}).attr("draggable","false").on("dragstart",function(){return!1}),this.OpenButton=$("<img>").appendTo(this.MainDiv).css({position:"absolute",height:"20px",width:"20px",top:"0px",left:"1px",opacity:"0.6","-moz-user-select":"none","-webkit-user-select":"none","z-index":"6"}).attr("src",SA.ImagePathUrl+"dualArrowRight2.png").click(function(){t.SetVisibility(!0)}).attr("draggable","false").hide().on("dragstart",function(){return!1}),this.CloseButton=$("<img>").appendTo(this.MainDiv).css({position:"absolute",height:"20px",top:"0px",left:"-22px",opacity:"0.6","-moz-user-select":"none","-webkit-user-select":"none","z-index":"6"}).attr("src",SA.ImagePathUrl+"dualArrowLeft2.png").click(function(){t.SetVisibility(!1)}).attr("draggable","false").on("dragstart",function(){return!1}),this.Visibility=!0,this.Dragging=!1,this.ResizeEdge=$("<div>").appendTo(e).css({position:"absolute",height:"100%",width:"3px",top:"0px",left:this.Width+"px",background:"#BDF","z-index":"10",cursor:"col-resize"}).hover(function(){$(this).css({background:"#9BF"})},function(){$(this).css({background:"#BDF"})}).mousedown(function(){return t.StartDrag(),!1})}function C(e,t){this.InsertMenuTimer=0,this.InsertMenu=$("<ul>").appendTo(t).css({position:"absolute",left:"-110px",top:"25px",width:"150px","font-size":"18px","box-shadow":"10px 10px 5px #AAA","z-index":"5"}).hide();for(var n in e)this.AddMenuItem(n,e[n]);this.InsertMenu.menu();var r=this;n=Object.keys(e)[0],t.click(function(){e[n](),r.InsertMenu.hide()});var r=this;t.mouseover(function(){r.ShowInsertMenu()}),this.InsertMenu.mouseover(function(){r.ShowInsertMenu()}),t.mouseleave(function(){r.EventuallyHideInsertMenu()}),this.InsertMenu.mouseleave(function(){r.EventuallyHideInsertMenu()})}function C(e,t){this.InsertMenuTimer=0,this.InsertMenu=$("<ul>").appendTo(t).css({position:"absolute",left:"-110px",top:"25px",width:"150px","font-size":"18px","box-shadow":"10px 10px 5px #AAA","z-index":"5"}).hide();for(var n in e)this.AddMenuItem(n,e[n]);this.InsertMenu.menu();var r=this;n=Object.keys(e)[0],t.click(function(){e[n](),r.InsertMenu.hide()});var r=this;t.mouseover(function(){r.ShowInsertMenu()}),this.InsertMenu.mouseover(function(){r.ShowInsertMenu()}),t.mouseleave(function(){r.EventuallyHideInsertMenu()}),this.InsertMenu.mouseleave(function(){r.EventuallyHideInsertMenu()})}jQuery.prototype.saElement=function(t){for(var n=0;n<this.length;++n){if(!this[n].saElement){var r=new e($(this[n]));this[n].saElement=r,$(this[n]).addClass("sa-element")}this[n].saElement.ProcessArguments(arguments)}return this},e.prototype.ActiveOn=function(){var e=this;if(!this.Interactive)return!0;this.SavedBorder||(this.SavedBorder=this.Div[0].style.border),this.Div.css({"border-color":"#7BF"}),this.Editable&&(this.ButtonDiv.appendTo(this.Div),this.MenuButton.on("mousedown",function(){return e.OpenDialog(),!1}),this.DeleteButton.on("mousedown",function(){return e.DeleteCallback&&e.DeleteCallback(e.Div[0]),e.Div.remove(),!1}))},e.prototype.ActiveOff=function(){if(!this.Interactive)return!0;this.SavedBorder&&(this.Div[0].style.border=this.SavedBorder,delete this.SavedBorder),this.ButtonDiv.remove()},e.prototype.InitializeDialog=function(){var e=this;this.Dialog=new SAM.Dialog(function(){e.DialogApplyCallback()}),this.Dialog.Title.text("Properties"),this.DialogInitializeFunctions=[],this.DialogApplyFunctions=[],this.Dialog.QuizPanel=this.AddAccordionTab("Quiz",function(){e.Dialog.QuizCheck.prop("checked",e.Div.hasClass("sa-quiz-hide"))},function(){e.Dialog.QuizCheck.is(":checked")?e.Div.addClass("sa-quiz-hide"):e.Div.removeClass("sa-quiz-hide")}),this.Dialog.QuizLabel=$("<div>").appendTo(this.Dialog.QuizPanel).css({display:"inline-block"}).text("Hide for quiz:"),this.Dialog.QuizCheck=$('<input type="checkbox">').appendTo(this.Dialog.QuizPanel),this.Dialog.BorderPanel=this.AddAccordionTab("Border",function(){e.DialogInitialize()},function(){e.DialogApply()}),this.Dialog.BorderLine1=$("<div>").appendTo(this.Dialog.BorderPanel).css({width:"100%"}),this.Dialog.BorderCheck=$('<input type="checkbox">').appendTo(this.Dialog.BorderLine1).change(function(){$(this).is(":checked")?(e.Dialog.BorderWidth.prop("disabled",!1),e.Dialog.BorderColor.spectrum("enable")):(e.Dialog.BorderWidth.prop("disabled",!0),e.Dialog.BorderColor.spectrum("disable"))}),this.Dialog.BorderWidthLabel=$("<div>").appendTo(this.Dialog.BorderLine1).css({display:"inline-block",padding:"0px 5px",width:"4em",height:"20px","text-align":"right"}).text("Width"),this.Dialog.BorderWidth=$('<input type="number">').appendTo(this.Dialog.BorderLine1).addClass("sa-view-annotation-modal-input").css({display:"inline-block",width:"3em"}).prop("disabled",!0).val(1).keypress(function(e){return e.keyCode!=13}),this.Dialog.BorderColorDiv=$("<div>").appendTo(this.Dialog.BorderLine1).css({"float":"right",height:"18px"}),this.Dialog.BorderColor=$('<input type="text">').appendTo(this.Dialog.BorderColorDiv).spectrum({showAlpha:!0}),this.Dialog.BorderLine2=$("<div>").appendTo(this.Dialog.BorderPanel).css({width:"100%"}),this.Dialog.BorderRadiusCheck=$('<input type="checkbox">').appendTo(this.Dialog.BorderLine2).change(function(){$(this).is(":checked")?e.Dialog.BorderRadius.prop("disabled",!1):e.Dialog.BorderRadius.prop("disabled",!0)}),this.Dialog.BorderRadiusLabel=$("<div>").appendTo(this.Dialog.BorderLine2).css({display:"inline-block",padding:"0px 5px",width:"4em",height:"20px","text-align":"right"}).text("Radius"),this.Dialog.BorderRadius=$('<input type="number">').appendTo(this.Dialog.BorderLine2).addClass("sa-view-annotation-modal-input").prop("disabled",!0).css({display:"inline-block",width:"3em"}).val(5).keypress(function(e){return e.keyCode!=13}),this.Dialog.BorderLine3=$("<div>").appendTo(this.Dialog.BorderPanel).css({width:"100%"}),this.Dialog.ShadowCheck=$('<input type="checkbox">').appendTo(this.Dialog.BorderLine3).change(function(){$(this).is(":checked")?(e.Dialog.ShadowOffset.prop("disabled",!1),e.Dialog.ShadowBlur.prop("disabled",!1),e.Dialog.ShadowColor.spectrum("enable")):(e.Dialog.ShadowOffset.prop("disabled",!0),e.Dialog.ShadowBlur.prop("disabled",!0),e.Dialog.ShadowColor.spectrum("disable"))}),this.Dialog.ShadowLabel=$("<div>").appendTo(this.Dialog.BorderLine3).css({display:"inline-block",padding:"0px 5px",width:"4em",height:"20px","text-align":"right"}).text("Shadow"),this.Dialog.ShadowOffset=$('<input type="number">').appendTo(this.Dialog.BorderLine3).addClass("sa-view-annotation-modal-input").prop("disabled",!0).css({display:"inline-block",width:"3em"}).val(10).keypress(function(e){return e.keyCode!=13}),this.Dialog.ShadowBlurLabel=$("<div>").appendTo(this.Dialog.BorderLine3).css({display:"inline-block",padding:"0px 5px",width:"3em",height:"20px","text-align":"right"}).text("Blur"),this.Dialog.ShadowBlur=$('<input type="number">').appendTo(this.Dialog.BorderLine3).addClass("sa-view-annotation-modal-input").prop("disabled",!0).css({display:"inline-block",width:"3em"}).val(5).keypress(function(e){return e.keyCode!=13}),this.Dialog.ShadowColorDiv=$("<div>").appendTo(this.Dialog.BorderLine3).css({"float":"right",height:"18px"}),this.Dialog.ShadowColor=$('<input type="text">').appendTo(this.Dialog.ShadowColorDiv).val("#AAAAAA").prop("disabled",!0).css({"float":"right",height:"18px"}).spectrum({showAlpha:!0})},e.prototype.AddAccordionTab=function(e,t,n){t&&this.DialogInitializeFunctions.push(t),n&&this.DialogApplyFunctions.push(n);var r=$("<div>").appendTo(this.Dialog.Body).attr("title",e).css({width:"100%"}),i=$("<div>").appendTo(r).text(e).addClass("sa-accordion-tab"),s=$("<div>").appendTo(r).css({width:"100%",padding:"5px",border:"1px solid #AAA","box-sizing":"border-box"}).hide(),o=this;return i.click(function(){o.OpenAccordionPanel&&o.OpenAccordionPanel.hide(200);if(o.OpenAccordionPanel==s){o.OpenAccordionPanel=null;return}s.show(200),o.OpenAccordionPanel=s}),this.OpenAccordionPanel&&this.OpenAccordionPanel.hide(),this.OpenAccordionPanel=s,s.show(),s},e.prototype.HideAccordionTab=function(e){this.Div[0].saElement.Dialog.Body.children("[title=Quiz]").hide()},e.prototype.OpenDialog=function(e){if(!this.DialogInitialized){for(var t=0;t<this.DialogInitializeFunctions.length;++t)this.DialogInitializeFunctions[t](this.Dialog);this.DialogInitialized=!0}this.OpenDialogCallback=e,this.Dialog.Show(!0)},e.prototype.DialogInitialize=function(){var e=this.Div[0].style.borderWidth;if(e!=""){this.Dialog.BorderCheck.prop("checked",!0),this.Dialog.BorderWidth.prop("disabled",!1),this.Dialog.BorderColor.spectrum("enable"),this.Dialog.BorderWidth.val(parseInt(e)),e=this.SavedBorder;if(!e||e=="")e=this.Div[0].style.border;e!=""&&(e=e.substr(e.indexOf("rgb")),this.Dialog.BorderColor.spectrum("set",e))}e=this.Div[0].style.borderRadius,e!=""&&(this.Dialog.BorderRadiusCheck.prop("checked",!0),this.Dialog.BorderRadius.prop("disabled",!1),this.Dialog.BorderRadius.val(parseInt(e))),e=this.Div[0].style.boxShadow;if(e!=""){this.Dialog.ShadowCheck.prop("checked",!0);var t=e.indexOf(")")+1,n=e.substr(e.indexOf("rgb"),t);this.Dialog.ShadowColor.spectrum("set",n),this.Dialog.ShadowColor.spectrum("enable"),e=e.substr(t+1);var r=e.split(" ");this.Dialog.ShadowOffset.prop("disabled",!1),this.Dialog.ShadowOffset.val(parseInt(r[0])),this.Dialog.ShadowBlur.prop("disabled",!1),this.Dialog.ShadowBlur.val(parseInt(r[2]))}},e.prototype.DialogApplyCallback=function(){for(var e=0;e<this.DialogApplyFunctions.length;++e)this.DialogApplyFunctions[e](this.Dialog);this.OpenDialogCallback&&(this.OpenDialogCallback(this),delete this.OpenDialogCallback)},e.prototype.DialogApply=function(){delete this.SavedBorder;if(this.Dialog.BorderCheck.is(":checked")){var e=this.Dialog.BorderColor.spectrum("get"),t=parseFloat(this.Dialog.BorderWidth.val());this.Div.css({border:t+"px solid "+e})}else this.Div.css("border","");if(this.Dialog.BorderRadiusCheck.is(":checked")){var t=parseFloat(this.Dialog.BorderRadius.val());this.Div.css({borderRadius:t+"px"})}else this.Div.css("borderRadius","");if(this.Dialog.ShadowCheck.is(":checked")){var n=this.Dialog.ShadowColor.spectrum("get"),r=parseInt(this.Dialog.ShadowOffset.val()),i=parseInt(this.Dialog.ShadowBlur.val());this.Div.css({"box-shadow":r+"px "+r+"px "+i+"px "+n})}else this.Div.css("box-shadow","")},e.prototype.ProcessArguments=function(e){if(e.length>0){if(typeof this[e[0]]=="function")return this[e[0]].apply(this,Array.prototype.slice.call(e,1));e=e[0]}else e={};var t=this;e.position&&(this.Position=e.position),e.aspectRatio!==undefined?e.apsectRatio==""?(delete this.AspectRatio,this.Div.removeAttr("sa-aspect-ratio")):(this.AspectRatio=e.aspectRatio,this.Div.attr("sa-aspect-ratio",e.aspectRatio)):this.AspectRatio=this.Div.attr("sa-aspect-ratio"),e.editable!==undefined&&(e.editable?this.EditableOn():(this.EditableOff(),this.Div.attr("contenteditable","false").addClass("sa-noselect"),this.Div.find("div").attr("contenteditable","false").addClass("sa-noselect"))),e.interactive!==undefined&&(this.Interactive=e.interactive,this.Interactive?this.Div.removeClass("sa-noselect"):this.Div.addClass("sa-noselect")),e.click!==undefined&&(this.ClickCallback=e.click,this.Clickable=!0),e.delete!==undefined&&(this.DeleteCallback=e.delete),this.ConvertToPercentages()},e.prototype.SetClickCallback=function(e){this.ClickCallback=e,this.Clickable=!0},e.prototype.EditableOn=function(){this.Editable=!0,this.Clickable=!0;var e=this;this.Div.on("mousewheel.element",function(t){return e.HandleMouseWheel(t.originalEvent)}),this.Position=="absolute"&&this.Div.on("mousemove.elementCursor",function(t){return e.HandleMouseMoveCursor(t)})},e.prototype.EditableOff=function(){this.Editable=!1,this.Div.css({cursor:"auto"}),this.Div.off("mousewheel.element"),this.Div.off("keyup.element"),this.Div.off("mousemove.elementCursor"),this.ButtonDiv.remove()},e.prototype.HandleMouseDown=function(e){if(!this.Interactive)return!0;if(e.which==1){if(!this.Clickable)return!0;var t=this;return this.ClickStart=Date.now(),$("body").on("mouseup.element",function(e){return t.HandleMouseUp(e)}),this.Editable&&this.Position=="absolute"&&(this.DragLastX=e.screenX,this.DragLastY=e.screenY,$("body").on("mousemove.element",function(e){return t.HandleMouseMove(e)}),$("body").on("mouseleave.element",function(e){return t.HandleMouseUp(e)}),this.Div[0].saElement.LockActive=!0),!1}return!0},e.prototype.RaiseToTop=function(){var e=this.Div.parent();this.Div.detach(),this.Div.appendTo(e)},e.prototype.HandleMouseMoveCursor=function(e){if(!this.Interactive)return!0;SA.FirefoxWhich(e);if(e.which==0){while(e.srcElement&&e.srcElement!=this.Div[0])e.offsetX+=e.srcElement.offsetLeft,e.offsetY+=e.srcElement.offsetTop,e.srcElement=e.srcElement.parentElement;var t=e.offsetX,n=e.offsetY,r=this.Div.outerWidth(),i=this.Div.outerHeight(),s=(r+i)/100;s<6&&(s=6);var o=r-s,u=i-s;t<s&&n<s?(this.Div.css({cursor:"nwse-resize"}),this.MoveState=5):t>o&&n>u?(this.Div.css({cursor:"nwse-resize"}),this.MoveState=6):t<s&&n>u?(this.Div.css({cursor:"nesw-resize"}),this.MoveState=7):t>o&&n<s?(this.Div.css({cursor:"nesw-resize"}),this.MoveState=8):t<s?(this.Div.css({cursor:"ew-resize"}),this.MoveState=1):t>o?(this.Div.css({cursor:"ew-resize"}),this.MoveState=2):n<s?(this.Div.css({cursor:"ns-resize"}),this.MoveState=3):n>u?(this.Div.css({cursor:"ns-resize"}),this.MoveState=4):(this.Div.css({cursor:"move"}),this.MoveState=0)}return!0},e.prototype.HandleMouseMove=function(e){SA.FirefoxWhich(e);if(e.which==1){if(Date.now()-this.ClickStart<200)return!0;this.Dragging||(this.RaiseToTop(),this.Dragging=!0);var t=e.screenX-this.DragLastX,n=e.screenY-this.DragLastY;this.DragLastX=e.screenX,this.DragLastY=e.screenY;var r=this.Div.position(),i=this.Div.outerWidth(),s=this.Div.outerHeight(),o=this.Div.css("box-sizing");this.AspectRatio&&typeof this.AspectRatio!="number"&&(this.AspectRatio=i/s);if(this.MoveState==0){var u=r.left+t,a=r.top+n;return this.Div[0].style.top=a.toString()+"px",this.Div[0].style.left=u.toString()+"px",!1}if(this.MoveState==1){var u=r.left+t;return i-=t,this.Div[0].style.left=u.toString()+"px",o=="border-box"?this.Div.width(i):this.Div.outerWidth(i),this.AspectRatio&&this.Div.innerHeight(this.Div.innerWidth/this.AspectRatio),this.Div.trigger("resize"),!1}if(this.MoveState==2)return i+=t,o=="border-box"?this.Div.width(i):this.Div.outerWidth(i),this.AspectRatio&&this.Div.innerHeight(this.Div.innerWidth()/this.AspectRatio),this.Div.trigger("resize"),!1;if(this.MoveState==3){var a=r.top+n;return s-=n,this.Div[0].style.top=a.toString()+"px",o=="border-box"?this.Div.height(s):this.Div.outerHeight(s),this.AspectRatio&&this.Div.innerWidth(this.Div.innerHeight()*this.AspectRatio),this.Div.trigger("resize"),!1}if(this.MoveState==4)return s+=n,o=="border-box"?this.Div.height(s):this.Div.outerHeight(s),this.AspectRatio&&this.Div.innerWidth(this.Div.innerHeight()*this.AspectRatio),this.Div.trigger("resize"),!1;if(this.MoveState==5){var u=r.left+t,a=r.top+n;return i-=t,s-=n,this.Div[0].style.top=a.toString()+"px",this.Div[0].style.left=u.toString()+"px",o=="border-box"?(this.Div.width(i),this.Div.height(s)):(this.Div.outerWidth(i),this.Div.outerHeight(s)),this.AspectRatio&&this.Div.innerWidth(this.Div.innerHeight()*this.AspectRatio),this.Div.trigger("resize"),!1}if(this.MoveState==6)return i+=t,s+=n,o=="border-box"?(this.Div.width(i),this.Div.height(s)):(this.Div.outerWidth(i),this.Div.outerHeight(s)),this.AspectRatio&&this.Div.innerWidth(this.Div.innerHeight()*this.AspectRatio),this.Div.trigger("resize"),!1;if(this.MoveState==7){var u=r.left+t;return i-=t,s+=n,this.Div[0].style.left=u.toString()+"px",o=="border-box"?(this.Div.width(i),this.Div.height(s)):(this.Div.outerWidth(i),this.Div.outerHeight(s)),this.AspectRatio&&this.Div.innerWidth(this.Div.innerHeight()*this.AspectRatio),this.Div.trigger("resize"),!1}if(this.MoveState==8){var a=r.top+n;return i+=t,s-=n,this.Div[0].style.top=a.toString()+"px",o=="border-box"?(this.Div.width(i),this.Div.height(s)):(this.Div.outerWidth(i),this.Div.outerHeight(s)),this.AspectRatio&&this.Div.innerWidth(this.Div.innerHeight()*this.AspectRatio),this.Div.trigger("resize"),!1}}return!0},e.prototype.HandleMouseUp=function(e){$("body").off("mouseup.element"),this.Editable&&(this.Dragging&&(this.Dragging=!1,this.ConvertToPercentages()),$("body").off("mousemove.element"),$("body").off("mouseleave.element"),this.Div[0].saElement.LockActive=!1,this.Div[0].saElement.ActiveOff());var t=Date.now()-this.ClickStart;return t<200&&this.ClickCallback&&this.ClickCallback(this.Div[0]),!1},e.prototype.HandleMouseWheel=function(e){var t=this.Div.width(),n=this.Div.height(),r=0,i=0,s=0;e.deltaY?s=e.deltaY:e.wheelDelta&&(s=e.wheelDelta),s>0?(r=.05*t,i=.05*n):s<0&&(r=t*-0.0476,i=n*-0.0476),t+=r,this.Div[0].style.width=t.toString()+"px",n+=i,this.Div[0].style.height=n.toString()+"px";var o=this.Div.position(),u=o.left-r/2,a=o.top-i/2;return this.Div[0].style.top=a.toString()+"px",this.Div[0].style.left=u.toString()+"px",this.Div.trigger("resize"),!1},e.prototype.ConvertToPercentages=function(){var e=this.Div[0].style.width;e.indexOf("%")==-1&&(e=parseFloat(e),e=100*e/this.Div.parent().width(),this.Div[0].style.width=e.toString()+"%");var t=this.Div[0].style.height;t.indexOf("%")==-1&&(t=parseFloat(t),t=100*t/this.Div.parent().height(),this.Div[0].style.height=t.toString()+"%");var n=this.Div.css("top");n.indexOf("%")==-1&&(n=parseFloat(n),n=100*n/this.Div.parent().height(),this.Div[0].style.top=n.toString()+"%");var r=this.Div.css("left");r.indexOf("%")==-1&&(r=parseFloat(r),r=100*r/this.Div.parent().width(),this.Div[0].style.left=r.toString()+"%")},jQuery.prototype.saRectangle=function(e){this.saElement(),this.addClass("sa-presentation-rectangle");for(var n=0;n<this.length;++n){var r=this[n];r.saRectangle||(r.saRectangle=new t($(r))),r.saRectangle.ProcessArguments(arguments)}return this},t.prototype.ProcessArguments=function(e){if(e.length==0)return;this.Div[0].saElement.ProcessArguments(e);if(typeof this[e[0]]=="function")return this[e[0]].apply(this,Array.prototype.slice.call(e,1))},t.prototype.DialogInitialize=function(){var e=this.Div[0].style.background;e==""&&(e=this.Div[0].style.backgroundColor);if(e==""){this.BackgroundCheck.prop("checked",!1),this.BackgroundColor.spectrum("disable"),this.GradientCheck.prop("checked",!1),this.GradientColor.spectrum("disable"),this.GradientColor.spectrum("hide");return}if(e.substring(0,3)=="rgb"){this.BackgroundCheck.prop("checked",!0),this.BackgroundColor.spectrum("set",e),this.BackgroundColor.spectrum("enable"),this.GradientCheck.prop("checked",!1),this.GradientColor.spectrum("disable"),this.GradientColor.spectrum("hide");return}if(e.substring(0,15)=="linear-gradient"){var t=e.indexOf("rgb"),n=e.indexOf(")")+1;this.BackgroundCheck.prop("checked",!0),this.BackgroundColor.spectrum("enable"),this.BackgroundColor.spectrum("set",e.substring(t,n)),t=e.indexOf("rgb",n),n=e.indexOf(")",n)+1,this.GradientCheck.prop("checked",!0),this.GradientColor.spectrum("enable"),this.GradientColor.spectrum("show"),this.GradientColor.spectrum("set",e.substring(t,n));return}SA.Debug("parse error: "+e)},t.prototype.DialogApply=function(){if(!this.BackgroundCheck.is(":checked")){this.Div.css("background","");return}var e=this.BackgroundColor.spectrum("get");if(!this.GradientCheck.is(":checked")){this.Div.css({background:e});return}var t=this.GradientColor.spectrum("get");this.Div.css({background:"linear-gradient("+e+","+t+")"})},jQuery.prototype.saText=function(e){this.saRectangle(),this.addClass("sa-text");for(var t=0;t<this.length;++t){var r=this[t];r.saText||(r.saText=new n($(r))),r.saText.ProcessArguments(arguments)}return this},n.prototype.ProcessArguments=function(e){if(e.length==0)return;this.Div[0].saRectangle
.ProcessArguments(e);if(typeof this[e[0]]=="function")return this[e[0]].apply(this,Array.prototype.slice.call(e,1))},n.prototype.DialogPaddingInitialize=function(){var e;e=this.Div[0].style.paddingLeft,this.PaddingLeft.val(8*parseFloat(e)),e=this.Div[0].style.paddingTop,this.PaddingTop.val(8*parseFloat(e)),e=this.Div[0].style.paddingRight,this.PaddingRight.val(8*parseFloat(e)),e=this.Div[0].style.paddingBottom,this.PaddingBottom.val(8*parseFloat(e))},n.prototype.DialogPaddingApply=function(){this.Div[0].style.paddingLeft=this.PaddingLeft.val()/8+"%",this.Div[0].style.paddingTop=this.PaddingTop.val()/8+"%",this.Div[0].style.paddingRight=this.PaddingRight.val()/8+"%",this.Div[0].style.paddingBottom=this.PaddingBottom.val()/8+"%"},jQuery.prototype.saQuestion=function(e){this.saText();for(var t=0;t<this.length;++t)this[t].saQuestion||(this[t].saQuestion=new r($(this[t])),this[t].saElement.HideAccordionTab("Quiz")),this[t].saQuestion.ProcessArguments(arguments);return this},r.prototype.SetQuestionText=function(e){var t=this.Div.find(".sa-q");t.length==0&&(t=$("<div>").addClass("sa-q").appendTo(this.Div)),t.text(e),this.Div.attr("type","multiple-choice")},r.prototype.AddAnswerText=function(e,t){var n=e;if(e[0]=="-")n=e.substring(1);else if(e[1]=="."||e[1]==":")n=e.substring(2);n=n.trim();var r=this.Div.find("ol");r.length==0&&(r=$("<ol>").appendTo(this.Div));var i=$("<li>").appendTo(r).addClass("sa-answer");i.text(n),t&&i.addClass("sa-true")},r.prototype.ProcessArguments=function(e){if(e.length==0)return;this.Div[0].saText.ProcessArguments(e);if(typeof this[e[0]]=="function")return this[e[0]].apply(this,Array.prototype.slice.call(e,1))},r.prototype.SetMode=function(e){this.Div.find(".sa-answer").css({color:"#000"}),e=="answer-show"?(this.Div.find(".sa-quiz-hide").show(),this.Div.find(".sa-true").css({"font-weight":"bold"}),this.Div.find(".sa-short-answer").css({color:"#00C"}).show()):(this.Div.find(".sa-quiz-hide").hide(),this.Div.find(".sa-true").css({"font-weight":"normal"}),this.Div.find(".sa-short-answer").hide()),e=="answer-interactive"?this.Div.find(".sa-answer").css({cursor:"pointer",color:"#057"}).hover(function(){$(this).css({background:"#DDD"})},function(){$(this).css({background:"#FFF"})}).on("click.answer",function(){$(this).hasClass("sa-true")?$(this).css({"font-weight":"bold",color:"#000"}):$(this).css({color:"#C00"})}):this.Div.find(".sa-answer").css({color:"#000"}).css("cursor","").off("hover").off("click.answer")},r.prototype.AddAnswerTo=function(e,t,n,r){var i=this,s=$("<div>").appendTo(e).css({width:"100%",position:"relative"}),o=$('<input type="checkbox">').appendTo(s),u=$("<div>").appendTo(s).css({border:"1px solid #AAA",position:"absolute",left:"30px",right:"2px",top:"2px"}).attr("contenteditable","true");o.change(function(){$(this).is(":checked")?u.css({"font-weight":"bold"}):u.css({"font-weight":"normal"})}),n&&(u.text(n),r&&(o.attr("checked","true"),u.css({"font-weight":"bold"})));var a={Div:s,Check:o,Input:u};return t.push(a),a},r.prototype.DialogInitialize=function(){var e=this,t=this.QuestionPanel;t.empty(),this.QuestionTypeSelect=$("<select>").appendTo(t),this.QuestionTypeMultipleChoice=$("<option>").appendTo(this.QuestionTypeSelect).text("Multiple Choice"),this.QuestionTypeSortAnswer=$("<option>").appendTo(this.QuestionTypeSelect).text("Short Answer"),this.QuestionTypeSelect.change(function(){$(this).val()=="Multiple Choice"&&(e.MultipleChoiceDiv.show(),e.TrueFalseDiv.hide(),e.ShortAnswerDiv.hide()),$(this).val()=="True or False"&&(e.MultipleChoiceDiv.hide(),e.TrueFalseDiv.show(),e.ShortAnswerDiv.hide()),$(this).val()=="Short Answer"&&(e.MultipleChoiceDiv.hide(),e.TrueFalseDiv.hide(),e.ShortAnswerDiv.show())}),this.QuestionLabel=$("<div>").appendTo(t).text("Question:"),this.Question=$("<div>").appendTo(t).css({border:"1px solid #AAA",margin:"2px"}).attr("contenteditable","true"),this.ShortAnswerDiv=$("<div>").appendTo(t).css({border:"1px solid #AAA",width:"100%",height:"3em",margin:"1px"}).attr("contenteditable","true").hide(),this.TrueFalseDiv=$("<div>").appendTo(t).hide(),this.TrueFalseAnswers=[],this.AddAnswerTo(this.TrueFalseDiv,this.TrueFalseAnswers,"True"),this.AddAnswerTo(this.TrueFalseDiv,this.TrueFalseAnswers,"False"),this.MultipleChoiceDiv=$("<div>").appendTo(t),this.MultipleChoiceAnswerLabel=$("<div>").appendTo(this.MultipleChoiceDiv).addClass("sa-mutliple-choice-answer").text("Answers:"),this.MultipleChoiceAnswers=[];var n=this.Div.find(".sa-q");if(n.length>0){this.Question.text(n.text());var r=this.Div.attr("type");if(r=="multiple-choice"){this.QuestionTypeSelect.val("Multiple Choice");var i=this.Div.find(".sa-answer");for(var s=0;s<i.length;++s){var o=$(i[s]),u=o.hasClass("sa-true");this.AddAnswerTo(this.MultipleChoiceDiv,this.MultipleChoiceAnswers,o.text(),u)}}else r=="short-answer"&&(this.ShortAnswerDiv.text($(".sa-short-answer").text()),this.QuestionTypeSelect.val("Short Answer"),this.ShortAnswerDiv.show(),this.MultipleChoiceDiv.hide())}this.AddBlankMultipleChoiceAnswer()},r.prototype.AddBlankMultipleChoiceAnswer=function(){var e=this,t=this.AddAnswerTo(this.MultipleChoiceDiv,this.MultipleChoiceAnswers);t.Input.on("focus.answer",function(){e.AddBlankMultipleChoiceAnswer()})},r.prototype.DialogApply=function(){this.Div.find(".sa-q").remove(),this.Div.find("ol").remove(),this.Div.find(".sa-short-answer").remove();var e=$("<div>").appendTo(this.Div).addClass("sa-q").text(this.Question.text());if(this.QuestionTypeSelect.val()=="Multiple Choice"){this.Div.attr("type","multiple-choice"),e=$("<ol>").appendTo(this.Div).css({margin:"0px 0px 0px 0.5em"});var t=[];while(this.MultipleChoiceAnswers.length>0){var n=Math.floor(Math.random()*this.MultipleChoiceAnswers.length),r=this.MultipleChoiceAnswers.splice(n,1)[0];t.push(r)}this.MultipleChoiceAnswers=t;for(var i=0;i<this.MultipleChoiceAnswers.length;++i){var r=this.MultipleChoiceAnswers[i];if(r.Input.text()!=""){var s=$("<li>").appendTo(e).addClass("sa-answer").text(r.Input.text());r.Check.is(":checked")&&(s.css({"font-weight":"bold"}),s.addClass("sa-true"))}}}if(this.QuestionTypeSelect.val()=="True or False"){this.Div.attr("type","true-false"),e=$("<ol>").appendTo(this.Div).css({margin:"0px 0px 0px 0.5em"});for(var i=0;i<this.TrueFalseAnswers.length;++i){var r=this.TrueFalseAnswers[i];if(r.Input.text()!=""){var s=$("<li>").appendTo(e).addClass("sa-true-false-answer").text(r.Input.text());r.Check.is(":checked")&&(s.css({"font-weight":"bold"}),s.addClass("sa-true"))}}}if(this.QuestionTypeSelect.val()=="Short Answer"){this.Div.attr("type","short-answer");var e=$("<div>").appendTo(this.Div).css({color:"#00C"}).addClass("sa-short-answer").text(this.ShortAnswerDiv.text())}},jQuery.prototype.saTextEditor=function(e){for(var t=0;t<this.length;++t){if(!this[t].saTextEditor){var n=new i($(this[t]),e);this[t].saTextEditor=n}this[t].saTextEditor.ProcessArguments(arguments)}return this},i.prototype.EditingOn=function(){$("body")[0].saTextEditing&&$("body")[0].saTextEditing.EditingOff(),$("body")[0].saTextEditing=this;var e=20,t=this.Div.position(),n=this.Div.outerWidth();n<275&&(n=275);var r=this.Div.outerHeight()+e;this.EditButtonDiv.css({left:t.left+"px",top:t.top-e+"px",width:n+"px",height:r+"px"}).show();var i=this;$("body").on("mousedown.textEditor",function(e){i.Div[0]!=e.srcElement&&i.EditButtonDiv[0]!=e.srcElement&&!$.contains(i.Div[0],e.srcElement)&&!$.contains(i.EditButtonDiv[0],e.srcElement)&&i.EditingOff()}),this.Div[0].saElement.LockActive=!0,this.SavedMovable=this.Div[0].saElement.Editable,this.Div[0].saElement.EditableOff(),this.Div[0].saElement.Clickable=!1;var i=this;this.Div.attr("contenteditable","true").css({cursor:"text"}),SA.ContentEditableHasFocus=!0},i.prototype.EditingOff=function(){delete $("body")[0].saTextEditing,$("body").off("mousedown.textEditor");var e=this.Div.find("*");for(var t=0;t<e.length;++t)if(e[t].style.lineHeight.indexOf("px")>-1){var n=parseFloat(e[t].style.lineHeight);n=100*n/parseFloat($(e[t]).css("font-size")),e[t].style.lineHeight=n.toString()+"%"}var r=this.Div[0].scrollHeight;r>this.Div.outerHeight()&&(this.Div.css("box-sizing")=="border-box"?this.Div.height(r+4):this.Div.outerHeight(r+4),this.Div.trigger("resize"),this.Div[0].saElement.ConvertToPercentages()),this.EditButtonDiv.hide(),this.Div[0].saElement.LockActive=!1,this.Div[0].saElement.ActiveOff(),this.SavedMovable&&this.Div[0].saElement.EditableOn(),this.Div[0].saElement.Clickable=!0,this.Div.attr("contenteditable","false").off("mouseleave.textEditor").css("cursor",""),SA.ContentEditableHasFocus=!1},i.prototype.AddButton=function(e,t,n,r){var i=this.EditButtonDiv,s=$("<img>").addClass("editButton").css({height:"16px"}).attr("src",e);return n&&s.click(n),t&&s.prop("title",t),r?s.prependTo(i):s.appendTo(i),s},i.prototype.ProcessArguments=function(e){e=e||{dialog:!0},this.Div[0].saText.ProcessArguments(e);if(typeof this[e[0]]=="function")return this[e[0]].apply(this,Array.prototype.slice.call(e,1))},i.prototype.DialogInitialize=function(){var e;if(this.Div[0].saScalableFont){var t=this.Div[0].saScalableFont.scale,n=Math.round(t*800);this.FontSize.val(n)}var r="#000000";e=this.Div[0].style.color,e!=""&&(r=SAM.ConvertColorToHex(e)),this.FontColor.spectrum("set",r);var i=120,e=this.Div[0].style.lineHeight;e!=""&&e.substring(e.length-1)=="%"&&(i=parseFloat(e.substr(0,e.length-1))),this.LineHeight.val(i)},i.prototype.DialogApply=function(){if(this.FontSize){var e=parseFloat(this.FontSize.val())/800,t=this.Div;t.saScalableFont({scale:e})}if(this.LineHeight){var n=parseFloat(this.LineHeight.val());this.Div[0].style.lineHeight=n+"%"}if(this.FontColor){var r=this.FontColor.spectrum("get");this.Div[0].style.color=r}var r="#000000";str=this.Div[0].style.color,str!=""&&(r=str),this.FontColor.spectrum("set",r)},i.prototype.Delete=function(){this.Div.remove()},i.prototype.InsertUrlLink=function(){var e=this,t=window.getSelection(),n=SA.GetSelectionRange(this.Div),r=t.toString();if(!this.UrlDialog){var e=this,i=new SAM.Dialog(function(){e.InsertUrlLinkAccept()});this.UrlDialog=i,i.Dialog.css({width:"40em"}),i.Title.text("Paste URL link"),i.TextDiv=$("<div>").appendTo(i.Body).css({display:"table-row",width:"100%"}),i.TextLabel=$("<div>").appendTo(i.TextDiv).text("Text to display:").css({display:"table-cell",height:"2em","text-align":"left"}),i.TextInput=$("<input>").appendTo(i.TextDiv).val("#30ff00").css({display:"table-cell",width:"25em"}),i.UrlDiv=$("<div>").appendTo(i.Body).css({display:"table-row"}),i.UrlLabel=$("<div>").appendTo(i.UrlDiv).text("URL link:").css({display:"table-cell","text-align":"left"}),i.UrlInput=$("<input>").appendTo(i.UrlDiv).val("#30ff00").css({display:"table-cell",width:"25em"}).on("input",function(){var t=e.UrlDialog.UrlInput.val();e.UrlDialog.LastUrl==e.UrlDialog.TextInput.val()&&e.UrlDialog.TextInput.val(t),e.UrlDialog.LastUrl=t,t==""?e.UrlDialog.ApplyButton.attr("disabled",!0):e.UrlDialog.ApplyButton.attr("disabled",!1)})}this.UrlDialog.SelectionRange=n,this.UrlDialog.TextInput.val(r),this.UrlDialog.UrlInput.val(""),this.UrlDialog.LastUrl="",this.UrlDialog.ApplyButton.attr("disabled",!0),this.UrlDialog.Show(!0)},i.prototype.InsertUrlLinkAccept=function(){var e=window.getSelection(),t=this.UrlDialog.SelectionRange;t||(t=SA.MakeSelectionRange(this.Div));var n=document.createElement("a");n.href=this.UrlDialog.UrlInput.val(),n.target="_blank",t.collapsed||(t.extractContents(),t.collapse(!0));var r=this.UrlDialog.TextInput.val();r==""&&(r=this.UrlDialog.UrlInput.val()),n.appendChild(document.createTextNode(r)),t.insertNode(n),t.noCursor&&e.removeAllRanges()},i.prototype.GetSelection=function(){var e=window.getSelection(),t,n=null;if(e.rangeCount>0){t=e.getRangeAt(0),t.noCursor=!1,n=t.commonAncestorContainer;while(n&&n!=this.Div[0])n&&(n=n.parentNode)}if(!n)return this.Div;var r=t.extractContents().children;for(var i=0;i<r.length;++i)t.insertNode(r[i]);return $(r)},i.prototype.SetPositionPixel=function(e,t){this.Percentage?(e=100*e/this.Div.parent().width(),t=100*t/this.Div.parent().height(),this.Div[0].style.left=e.toString()+"%",this.Div[0].style.top=t.toString()+"%"):(this.Div[0].style.left=e+"px",this.Div[0].style.top=t+"px")},jQuery.prototype.saLightBox=function(e){this.saElement(),this.addClass("sa-light-box");for(var t=0;t<this.length;++t){if(!this[t].saLightBox){var n=new s($(this[t]));this[t].saLightBox=n}this[t].saLightBox.ProcessArguments(arguments)}return this},s.prototype.ProcessArguments=function(e){if(e.length==0)return;this.Div[0].saElement.ProcessArguments(e);if(typeof this[e[0]]=="function")return this[e[0]].apply(this,Array.prototype.slice.call(e,1));e=e[0],e.aspectRatio!==undefined&&(this.AspectRatio=e.aspectRatio),e.editable!==undefined&&(this.Editable=e.editable),e.expand!==undefined&&this.Expand(e.expand,e.animate),e.Interactive!==undefined&&(this.Interactive=e.interactive),e.onExpand&&(this.ExpandCallback=e.onExpand);if(typeof this[e[0]]=="function")return this[e[0]].apply(this,Array.prototype.slice.call(e,1))},s.prototype.UpdateSize=function(){if(!this.Expanded)return;var e=this,t="5%",n="5%",r="90%",i="90%";if(this.AspectRatio){this.Div[0].onresize||(this.Div[0].onresize=function(){e.UpdateSize()},this.Div.addClass("sa-resize"));var s=this.Div.width()/this.Div.height(),o=this.Div.parent().width(),u=this.Div.parent().height();r=Math.floor(o*.9),i=Math.floor(u*.9),r/i>s?r=Math.floor(i*s):i=Math.floor(r/s),t=Math.floor(.5*(o-r))+"px",n=Math.floor(.5*(u-i))+"px",r+="px",i+="px"}this.Div.css({"z-index":"1001"}),this.Div.css({left:t,top:n,width:r,height:i})},s.prototype.Expand=function(e,t){if(!this.Interactive)return;if(e==this.Expanded)return;var n=this;e?(this.Div.saElement({editable:!1}),this.Expanded=!0,this.SavedTop=this.Div[0].style.top,this.SavedLeft=this.Div[0].style.left,this.SavedWidth=this.Div[0].style.width,this.SavedHeight=this.Div[0].style.height,this.SavedZIndex=this.Div[0].style.zIndex,this.Div.css({"z-index":"1001"}),this.UpdateSize(),this.Div.trigger("resize"),this.Mask.show(),this.Mask.on("mousedown.lightbox",function(){n.Expand(!1,!0)})):(this.Mask.hide(),this.Mask.off("mousedown.lightbox"),t?this.Div.animate({top:n.SavedTop,left:n.SavedLeft,width:n.SavedWidth,height:n.SavedHeight,"z-index":n.SavedZIndex},{step:function(){n.Div.trigger("resize")}}):this.Div.css({top:n.SavedTop,left:n.SavedLeft,width:n.SavedWidth,height:n.SavedHeight,"z-index":n.SavedZIndex}),this.Expanded=!1,this.Editable&&this.Div.saElement({editable:!0})),this.ExpandCallback&&this.ExpandCallback(e),this.Div.trigger("resize")},jQuery.prototype.saLightBoxViewer=function(e){return e.hideCopyright||(e.hideCopyright=!0),e.zoomWidget||(e.zoomWidget=!1),e.dualWidget||(e.dualWidget=!1),e.navigation||(e.navigation=!1),e.drawWidget||(e.drawWidget=!1),e.interaction===undefined&&(e.interaction=!1),e.overview=!1,this.saViewer(e),e.onExpand=function(e){this.Div.saViewer({interaction:e});if(e)this.Div.saViewer({overview:!0,navigation:!0,menu:!0,zoomWidget:!0,dualWidget:!0,drawWidget:!0});else{this.Div.saViewer({overview:!1,navigation:!1,menu:!1,zoomWidget:!1,dualWidget:!1,drawWidget:!1});var t=this.Div[0].saViewer,n=t.saNote;if(!this.Div[0].saLightBox.Editable&&n){var r=t.saViewerIndex||0;t.SetNote(n,r)}}},this.saLightBox(e),this.addClass("sa-lightbox-viewer"),this};var u=function(e){if(!e.saDialog)return;e.saDialog.Dialog.Body.empty,delete e.saDialog},a=function(e){var t=e.saDialog.ShowCallbacks;for(var n=0;n<t.length;++n)t[n](e);e.saDialog.Show(!0)},f=function(e){var t=e.saDialog.ApplyCallbacks;for(var n=0;n<t.length;++n)t[n](e)},l=null;jQuery.prototype.saButtons=function(e){if(e=="enable")for(var t=0;t<this.length;++t)v(this[t]);if(e=="disable")for(var t=0;t<this.length;++t)d(this[t])},h.prototype.PlaceButtons=function(){var e=this.Div.position();this.ButtonsDiv.css({left:e.left+10+"px",top:e.top-20+"px"})},h.prototype.ShowButtons=function(e){this.TimerId>=0&&(clearTimeout(this.TimerId),this.TimerId=-1),this.Enabled&&(l&&l!=this.ButtonsDiv&&(l.fadeOut(200),l=this.ButtonsDiv),this.PlaceButtons(),e==1?(this.ButtonsDiv.fadeIn(400),this.ButtonsDiv.children().css({opacity:"0.4"})):(this.ButtonsDiv.show(),this.ButtonsDiv.children().css({opacity:"1.0"})))},h.prototype.HideButtons=function(){if(this.TimerId<0){var e=this;this.TimerId=setTimeout(function(){l==e.ButtonsDiv&&(l=null),e.ButtonsDiv.fadeOut(200)},200)}},jQuery.prototype.saHtml=function(e){if(e){this.html(e),this.find(".sa-scalable-font").saScalableFont(),this.find(".sa-presentation-rectangle").saRectangle(),this.find(".sa-presentation-view").addClass("sa-lightbox-viewer").removeClass("sa-presentation-view"),this.find(".ui-resizable-handle").remove(),this.find(".ui-resizable").removeClass("ui-resizable");var t=this.find(".sa-lightbox-viewer");t.saLightBoxViewer({hideCopyright:!0,interaction:!1});for(var n=0;n<t.length;++n){var r=t[n].saViewer,i=$(t[n]).attr("sa-note-id"),s=$(t[n]).attr("sa-viewer-index")||0;s=parseInt(s),i&&r.SetNoteFromId(i,s)}if(SA.Edit){var o=this.find(".sa-resizable");o=this.find(".sa-text-editor"),o.saTextEditor({editable:!0}),o=this.find(".sa-presentation-rectangle"),o.saRectangle({editable:!0}),o=this.find(".sa-question"),o.saQuestion({editable:!0}),o=this.find(".sa-presentation-image"),o.saLightBox({aspectRatio:!0,editable:!0}),o=this.find(".sa-lightbox-viewer"),o.saViewer({drawWidget:!1})}else o=this.find(".sa-text-editor"),o.css({overflow:"visible"});return}this.find(".sa-light-box").saLightBox({expand:!1,animate:!1}),this.find(".sa-quiz-hide").show(),this.find(".sa-presentation-title").show();var u=this.clone();return u.find(".sa-edit-gui").remove(),u.find(".sa-standin").remove(),u.find(".ui-resizable").resizable("destroy"),u.find(".sa-lightbox-viewer").empty(),u.html()},jQuery.prototype.saResizable=function(e){return e=e||{},e.start=function(e,t){this.saViewer&&this.saViewer.DisableInteraction()},e.stop=function(e,t){var n=$(this).width();n=100*n/$(this).parent().width(),this.style.width=n.toString()+"%";var r=$(this).height();r=100*r/$(this).parent().height(),this.style.height=r.toString()+"%";var i=$(this).position(),s=100*i.top/$(this).parent().height(),o=100*i.left/$(this).parent().width();this.style.top=s.toString()+"%",this.style.left=o.toString()+"%"},this.addClass("sa-resizable"),this},jQuery.prototype.saViewer=function(e){e=e||{},typeof e=="object"&&(e.viewerIndex=e.viewerIndex||0);if(e.viewId){e.note=SA.GetNoteFromId(e.viewId);if(e.note==null){e.note=new SA.Note;var t=this;return e.note.LoadViewId(e.viewId,function(){g(t,arguments)}),this}}return arguments.length==0?g(this,[e])||this:g(this,arguments)||this},jQuery.prototype.saRecordViewer=function(){for(var e=0;e<this.length;++e)if(this[e].saViewer&&this[e].saViewer.saNote){var t=this[e].saViewer.saViewerIndex||0,n=this[e].saViewer.saNote;this[e].saViewer.Record(n,t)}},jQuery.prototype.saOnResize=function(e){this.addClass("sa-resize");for(var t=0;t<this.length;++t)this[t].onresize=e;return this},jQuery.prototype.saTriggerResize=function(){$(window).trigger("resize")},jQuery.prototype.saFullHeight=function(e){this.css({top:"0px"}),this.addClass("sa-full-height");for(var t=0;t<this.length;++t)this[t].saFullHeight=e;return $(window).off("resize.sa").on("resize.sa",y).trigger("resize"),this},jQuery.prototype.saPresentation=function(e){this.addClass("sa-presentation"),this.addClass("sa-resize"),$(window).off("resize.sa").on("resize.sa",y).trigger("resize");for(var t=0;t<this.length;++t){var n=this[t];n.saPresentation||(n.saPresentation=new b($(n),e),n.onresize=function(){this.saPresentation.Resize()}),setTimeout(function(){n.saPresentation.Resize()},300)}return this},b.prototype.Resize=function(){var e=this.AspectRatio,t=this.Div.parent(),n=t.innerWidth(),r=t.innerHeight(),i=n,s=r;i/s>e?i=s*e:s=i/e,i*=this.Zoom,s*=this.Zoom;var o=(n-i)*.5+this.ShiftX,u=(r-s)*.5+this.ShiftY;this.Div.css({position:"absolute",top:u+"px",height:s+"px",left:o+"px",width:i+"px"})},b.prototype.HandleMouseDown=function(e){var t=this;this.ClickStart=Date.now(),(e.which==1||e.which==3)&&$("body").on("mouseup.presentation",function(e){return t.HandleMouseUp(e)});if(e.which==1)return $("body").on("mousemove.presentation",function(e){return t.HandleMouseMove(e)}),$("body").on("mouseleave.presentation",function(e){return t.HandleMouseUp(e)}),this.DragLastX=e.screenX,this.DragLastY=e.screenY,!1},b.prototype.HandleMouseWheel=function(e){var t=0;e.deltaY?t=e.deltaY:e.wheelDelta&&(t=e.wheelDelta);if(t==0)return;return t>0?this.Zoom*=1.01:t<0&&(this.Zoom*=.99),this.Resize(),!1},b.prototype.HandleMouseMove=function(e){if(Date.now()-this.ClickStart<200)return!0;if(e.which==1){var t=e.screenX-this.DragLastX,n=e.screenY-this.DragLastY;return this.DragLastX=e.screenX,this.DragLastY=e.screenY,this.ShiftX+=t,this.ShiftY+=n,this.Resize(),!1}return!0},b.prototype.HandleMouseUp=function(e){return $("body").off("mouseup.presentation"),e.which==1&&($("body").off("mousemove.presentation"),$("body").off("mouseleave.presentation")),!0},jQuery.prototype.saScalableFont=function(e){this.addClass("sa-scalable-font"),this.addClass("sa-resize"),$(window).off("resize.sa").on("resize.sa",y);for(var t=0;t<this.length;++t){var n=this[t];n.saScalableFont||(n.onresize=function(){r=this.saScalableFont.scale;var e=$(this).parent().innerHeight(),t=Math.round(r*e)+"px";this.style.fontSize=t,$(this).children("font").css({"font-size":t})},n.saScalableFont={},n.saScalableFont.scale=.1);var r=n.saScalableFont.scale,i=n.getAttribute("sa-font-scale");i&&(r=parseFloat(i)),e&&e.scale&&(r=e.scale,typeof r=="string"&&(r.substring(-1)=="%"?r=parseFloat(r.substr(0,str.length-1))/100:r=parseFloat(r))),n.setAttribute("sa-font-scale",r.toString()),n.saScalableFont.scale=r,n.onresize()}return this},jQuery.prototype.saDraggable=function(e){e=e||{grid:[30,39]},this.addClass("sa-draggable");for(var t=0;t<this.length;++t){if(!this[t].saDraggable){var n=new w($(this[t]));this[t].saDraggable=n}this[t].saDraggable.ProcessArguments(e)}return this},w.prototype.ProcessArguments=function(e){e.grid&&(this.XStops=new E(e.grid[0]),this.YStops=new E(e.grid[1]));if(typeof this[e[0]]=="function")return this[e[0]].apply(this,Array.prototype.slice.call(e,1))},w.prototype.Drag=function(e,t){var n=this.Div.position(),r=n.left,i=n.top,s=this.Div.parent().width(),o=this.Div.parent().height(),u=r+e,a=i+t;this.XStops&&(u=this.XStops.Drag(e)),this.YStops&&(a=this.YStops.Drag(t)),this.Percentage?(u/=s,a/=o,u*=100,a*=100,this.Div[0].style.left=u+"%",this.Div[0].style.top=a+"%"):(this.Div[0].style.left=u+"px",this.Div[0].style.top=a+"px"),this.Div[0].saButtons.PlaceButtons()},E.prototype.Start=function(e,t){this.Stopped=!1,this.Delta=0,this.Last=e,this.Size=t,this.Target=e,this.Gap=t/this.Divisions},E.prototype.Drag=function(e){this.Target+=e,e+=3*(this.Target-this.Last)/this.Gap;var t=this.Last+e;if(this.Stopped)return this.Delta=this.Delta+e,Math.abs(this.Delta)>this.Threshold?(this.Stopped=!1,this.Delta=0,this.Last=t,t):this.Stop;var n=this.GetStop(this.Last,t);return n<this.Last&&n<t?(this.Delta=0,this.Last=t,t):n>this.Last&&n>t?(this.Delta=0,this.Last=t,t):(this.Delta=t-n,this.Last=n,this.Stop=n,this.Stopped=!0,n)},E.prototype.GetStop=function(e,t){var n=e*this.Divisions/this.Size,r=t*this.Divisions/this.Size;if(r<n){var i=n;n=r,r=i}var s=Math.floor(r);return s=s*this.Size/this.Divisions,s},jQuery.prototype.saFullWindowOption=function(e){this.addClass("sa-full-window-option");for(var t=0;t<this.length;++t){if(!this[t].saFullWindowOption){var n=new S($(this[t]));this[t].saFullWindowOption=n}e=="off"&&this[t].saFullWindowOption.SetFullWindow($(this[t]),!1)}return this},S.prototype.SetFullWindow=function(e,t){t?(d(e[0]),this.FullWindowOptionOffButton.show(),this.FullWindowOptionButton.hide(),this.Left=e[0].style.left,this.Width=e[0].style.width,this.Top=e[0].style.top,this.Height=e[0].style.height,this.ZIndex=e[0].style.zIndex,e.css({left:"0px",width:"100%",top:"0px",height:"100%","z-index":"10"})):(v(e[0]),this.FullWindowOptionOffButton.hide(),this.FullWindowOptionButton.show(),e.css({left:this.Left,width:this.Width,top:this.Top,height:this.Height,"z-index":this.ZIndex})),$(window).trigger("resize")},jQuery.prototype.saDeletable=function(e){this.addClass("sa-deletable");for(var t=0;t<this.length;++t){var n=this[t];n.saDeletable||(n.saDeletable=new x(n))}return this},N.prototype.StartDrag=function(){this.Dragging=!0;var e=this;this.TmpDrag=function(t){return e.ResizeDrag(t)},this.TmpStop=function(t){return e.ResizeStopDrag(t)},$("body").on("mousemove",this.TmpDrag),$("body").on("mouseup",this.TmpStop),$("body").css({cursor:"col-resize"})},N.prototype.ResizeDrag=function(e){return this.SetWidth(e.pageX-1),this.Width<200&&(this.ResizeStopDrag(),this.SetVisibility(!1)),!1},N.prototype.ResizeStopDrag=function(){return $("body").off("mousemove",this.TmpDrag),$("body").off("mouseup",this.TmpDrag),$("body").css({cursor:"auto"}),!1},N.prototype.SetWidth=function(e){this.Width=e,this.PanelDiv.css({width:this.Width+"px"}),this.MainDiv.css({left:this.Width+"px"}),this.ResizeEdge.css({left:this.Width-2+"px"}),$(window).trigger("resize")},N.prototype.AnimateNotesWindow=function(){var e=(new Date).getTime()-this.AnimationStartTime;if(e>this.AnimationDuration||this.AnimationDuration<=0){this.SetWidth(this.AnimationTarget),this.Visibility?(this.CloseButton.show(),this.OpenButton.hide(),this.PanelDiv.fadeIn()):(this.CloseButton.hide(),this.OpenButton.show()),clearInterval(this.AnimationId),delete this.AnimationId,delete this.AnimationStartTime,delete this.AnimationDuration,delete this.AnimationTarget;return}var t=e/this.AnimationDuration;this.SetWidth(this.Width+(this.AnimationTarget-this.Width)*t);var n=this},N.prototype.SetVisibility=function(e,t){t===undefined&&(t=1e3);if(this.Visibility==e)return;this.Visibility=e,this.AnimationCurrent=this.Width,this.Visibility?this.AnimationTarget=353:(this.PanelDiv.hide(),this.AnimationTarget=0),this.AnimationDuration=t,this.AnimationStartTime=(new Date).getTime();var n=this;this.AnimationLastTime=(new Date).getTime(),this.AnimationId=setInterval(function(){n.AnimateNotesWindow()},10)},N.prototype.Show=function(){this.Visibility=!0,this.ResizeEdge.show(),this.Visibility?(this.Visibility=!1,this.SetVisibility(!0)):this.OpenButton.show()},N.prototype.Hide=function(){this.Visibility=!1,this.PanelDiv.hide(),this.SetWidth(0),this.OpenButton.hide(),this.CloseButton.hide(),this.ResizeEdge.hide(),$(window).trigger("resize")},jQuery.prototype.saMenuButton=function(e){if(this.length==0)return this;var t=this[0];return t.saMenuButton||(t.saMenuButton=new C(e,this)),this},C.prototype.AddMenuItem=function(e,t){var n=this;this[e]=$("<li>").appendTo(this.InsertMenu).text(e).addClass("saButton").click(function(){return t(),n.InsertMenu.hide(),!1})},C.prototype.ShowInsertMenu=function(){this.InsertMenuTimer&&(clearTimeout(this.InsertMenuTimer),this.InsertMenuTimer=0),this.InsertMenu.show()},C.prototype.EventuallyHideInsertMenu=function(){this.InsertMenuTimer&&(clearTimeout(this.InsertMenuTimer),this.InsertMenuTimer=0);var e=this;this.InsertMenuTimer=setTimeout(function(){e.InsertMenuTimer=0,e.InsertMenu.fadeOut(),this.InsertMenuTimer=0},500)},jQuery.prototype.saAnnotationWidget=function(e){for(var t=0;t<this.length;++t){var n=this[t];if(!n.saViewer)return this;n.saAnnotationWidget||($(n).addClass("sa-annotation-widget"),n.saAnnotationWidget=new SA.AnnotationWidget(n.saViewer),n.saAnnotationWidget.SetVisibility(2)),e=="hide"?n.saAnnotationWidget.hide():e=="show"&&n.saAnnotationWidget.show()}return this},C.prototype.AddMenuItem=function(e,t){var n=this;this[e]=$("<li>").appendTo(this.InsertMenu).text(e).addClass("saButton").click(function(){return t(),n.InsertMenu.hide(),!1})},C.prototype.ShowInsertMenu=function(){this.InsertMenuTimer&&(clearTimeout(this.InsertMenuTimer),this.InsertMenuTimer=0),this.InsertMenu.show()},C.prototype.EventuallyHideInsertMenu=function(){this.InsertMenuTimer&&(clearTimeout(this.InsertMenuTimer),this.InsertMenuTimer=0);var e=this;this.InsertMenuTimer=setTimeout(function(){e.InsertMenuTimer=0,e.InsertMenu.fadeOut(),this.InsertMenuTimer=0},500)},SA.FillDiv=function(e){e.saOnResize(function(){var t=e.parent().height()-e.position().top;e.height(t)})},SA.ResizePanel=N})();(function(){"use strict";function e(e,t){var s=this;this.RootNote=e,this.Edit=t,this.FullScreen=!1,typeof e.TypeData=="undefined"&&(e.TypeData={}),e.TypeData.Background||(e.TypeData.Background="#EEEEEE"),e.TypeData.AspectRatio||(e.TypeData.AspectRatio=1.3333),$(body).css({"overflow-x":"hidden"}),this.WindowDiv=$("<div>").appendTo("body").css({position:"fixed",left:"0px",width:"100%"}).saFullHeight(),SA.VIEW_BROWSER=new SA.ViewBrowser(this.WindowDiv),this.ResizePanel=new SA.ResizePanel(this.WindowDiv),this.PresentationDiv=this.ResizePanel.MainDiv,this.WindowDiv.on("swipeleft",function(e){if(s.ResizePanel.Visibility&&e.swipestop.coords[0]<s.ResizePanel.Width)return s.ResizePanel.SetVisibility(!1),!1;s.GotoSlide(s.Index+1)}),this.WindowDiv.on("swiperight",function(e){if(!s.ResizePanel.Visibility&&e.swipestart.coords[0]<10)return s.ResizePanel.Show(),!1;s.GotoSlide(s.Index-1)}),this.AspectDiv=$("<div>").css({border:"1px solid #AAA"}).appendTo(this.PresentationDiv).saPresentation({aspectRatio:this.RootNote.TypeData.AspectRatio}),this.LeftPanel=this.ResizePanel.PanelDiv,this.InitializeLeftPanel(this.LeftPanel),SAM.detectMobile()&&this.ResizePanel.Hide(),this.ShowButton=$("<img>").appendTo(this.PresentationDiv).prop("title","present").addClass("editButton").attr("src",SA.ImagePathUrl+"slide_show.png").css({position:"absolute",top:"2px",right:"20px",width:"20px","z-index":"5"}).click(function(){s.StartFullScreen()}),this.TimerButton=$("<img>").appendTo(this.PresentationDiv).prop("title","present timed").addClass("editButton").attr("src",SA.ImagePathUrl+"timer.png").css({position:"absolute",top:"2px",right:"46px",width:"20px","z-index":"5"}).click(function(){s.StartTimerShow()}),t&&(this.DeleteSlideButton=$("<img>").appendTo(this.AspectDiv).attr("src",SA.ImagePathUrl+"remove.png").prop("title","delete slide").addClass("editButton").css({position:"absolute",width:"12px",height:"12px",left:"0px",top:"0px","z-index":"5"}).click(function(){s.DeleteCurentSlide()})),this.TitlePage=new r(this.AspectDiv,t),this.SlidePage=new n(this.AspectDiv,t),this.HtmlPage=new i(this.AspectDiv,t,e.TypeData.Background),this.GotoSlide(0),document.oncontextmenu=SA.cancelContextMenu,$("body").on("keydown",function(e){return s.HandleKeyDown(e)}),this.UpdateSlidesTab()}function t(e){this.Modified=!1,this.UpdateTimer=null,this.ParentNote=null,this.TextEditor=$("<div>").appendTo(e).css({display:"inline-block",position:"absolute","overflow-y":"auto",padding:"5px",fontFamily:"Verdana,sans-serif",left:"2px",right:"2px",top:"20px",bottom:"2px"});var t=this;this.TextEditor.attr("contenteditable","false").bind("input",function(){t.Modified=!0,t.EventuallyUpdate()}).focusin(function(){SA.ContentEditableHasFocus=!0}).focusout(function(){SA.ContentEditableHasFocus=!1,t.UpdateNote()}).mouseleave(function(){t.UpdateNote()}),this.TextEditor.change(function(){t.UpdateNote()})}function n(e,t){var n=this;this.FullWindowView=null,this.Edit=t,this.Note=null,this.Records=[],this.Div=$("<div>").appendTo(e).hide().addClass("sa-resize").css({position:"absolute",width:"100%",height:"100%",border:"1px solid #AAA"}),this.Div[0].onresize=function(){n.ResizeViews()},this.ViewPanel=$("<div>").appendTo(this.Div).css({background:"#FFF",position:"absolute",top:"0px",bottom:"300px",left:"0px",width:"100%",height:"auto"}),this.BottomDiv=$("<div>").appendTo(this.Div).css({position:"absolute",bottom:"0px",width:"100%",height:"300px"}),this.TitleBar=$("<div>").appendTo(this.BottomDiv).css({position:"absolute",top:"0px",height:"80px","line-height":"80px",width:"100%","padding-left":"3.3em",color:"white","font-size":"160%",background:"#444","font-family":"Arial"}),this.Title=$("<span>").appendTo(this.TitleBar).css({display:"inline-block","vertical-align":"middle","line-height":"normal"}).text("Slide: 1"),this.TextDiv=$("<div>").appendTo(this.BottomDiv).css({position:"absolute","padding-left":"2em",height:"210px",bottom:"5px",width:"100%"}),this.List=new SA.TextEditor(this.TextDiv,SA.VIEWERS),t||this.List.EditOff(),this.ViewerDiv1=$("<div>").appendTo(this.ViewPanel).css({position:"absolute","box-shadow":"10px 10px 5px #AAA"}),this.ViewerDiv1.saViewer(),this.ViewerDiv2=$("<div>").appendTo(this.ViewPanel).css({position:"absolute","box-shadow":"10px 10px 5px #AAA"}),this.ViewerDiv2.saViewer();if(this.Edit){var r=this.ViewerDiv1[0].saViewer;this.AnnotationWidget1=new SA.AnnotationWidget(r.GetAnnotationLayer(),r),this.AnnotationWidget1.SetVisibility(2);var r=this.ViewerDiv2[0].saViewer;this.AnnotationWidget2=new SA.AnnotationWidget(r.GetAnnotationLayer(),r),this.AnnotationWidget2.SetVisibility(2),this.ViewerDiv1[0].saViewer.OnInteraction(function(){n.RecordView1()}),this.ViewerDiv2[0].saViewer.OnInteraction(function(){n.RecordView2()}),this.RemoveView1Button=$("<img>").appendTo(this.ViewerDiv1).attr("src",SA.ImagePathUrl+"remove.png").prop("title","remove view").addClass("editButton").css({position:"absolute",right:"0px",top:"0px",width:"12px",height:"12px","z-index":"5"}).click(function(){SA.presentation.Note.ViewerRecords.splice(0,1),n.DisplayNote(n.Note,SA.presentation.Index)}),this.RemoveView2Button=$("<img>").appendTo(this.ViewerDiv2).attr("src",SA.ImagePathUrl+"remove.png").prop("title","remove view").addClass("editButton").css({position:"absolute",right:"0px",top:"0px",width:"12px",height:"12px","z-index":"5"}).click(function(){SA.presentation.Note.ViewerRecords.splice(1,1),n.DisplayNote(n.Note,SA.presentation.Index)}),this.ViewerDiv1.resizable(),this.ViewerDiv1.mouseup(function(){this.saViewer.EnableInteraction(),n.UpdateEdits(),$(window).trigger("resize")}),this.ViewerDiv1.resize(function(){this.saViewer.DisableInteraction();var e=this.saViewer.GetViewport();return e[2]=$(this).width(),e[3]=$(this).height(),this.saViewer.SetViewport(e),this.saViewer.EventuallyRender(!0),!1}),this.ViewerDiv2.resizable(),this.ViewerDiv2.mouseup(function(){this.saViewer.EnableInteraction(),n.UpdateEdits(),$(window).trigger("resize")}),this.ViewerDiv2.resize(function(){this.saViewer.DisableInteraction();var e=this.saViewer.GetViewport();return e[2]=$(this).width(),e[3]=$(this).height(),this.saViewer.SetViewport(e),this.saViewer.EventuallyRender(!0),!1})}this.FullWindowView1Button=$("<img>").appendTo(this.ViewerDiv1).attr("src",SA.ImagePathUrl+"fullscreenOn.png").prop("title","full window").css({position:"absolute",width:"12px",left:"-5px",top:"-5px",opacity:"0.5","z-index":"-1"}).hover(function(){$(this).css({opacity:"1.0"})},function(){$(this).css({opacity:"0.5"})}).click(function(){n.SetFullWindowView(n.ViewerDiv1)}),this.FullWindowView2Button=$("<img>").appendTo(this.ViewerDiv2).attr("src",SA.ImagePathUrl+"fullscreenOn.png").prop("title","full window").css({position:"absolute",width:"12px",left:"-5px",top:"-5px",opacity:"0.5","z-index":"-1"}).hover(function(){$(this).css({opacity:"1.0"})},function(){$(this).css({opacity:"0.5"})}).click(function(){n.SetFullWindowView(n.ViewerDiv2)}),this.FullWindowViewOffButton=$("<img>").appendTo(this.ViewPanel).hide().attr("src",SA.ImagePathUrl+"fullscreenOff.png").prop("title","full window off").css({position:"absolute",background:"#FFF",width:"16px",left:"1px",top:"1px",opacity:"0.5","z-index":"1"}).hover(function(){$(this).css({opacity:"1.0"})},function(){$(this).css({opacity:"0.5"})}).click(function(){n.SetFullWindowView(null)})}function r(e,t){this.Edit=t,this.Note=null,this.Div=$("<div>").appendTo(e).css({background:"#FFF",position:"absolute",width:"100%",height:"100%",border:"1px solid #AAA"}),this.TopBar=$("<div>").appendTo(this.Div).css({position:"absolute",top:"0%",height:"2%",left:"13%",right:"3%",background:"#DDF1FD"}),this.Image=$("<img>").appendTo(this.Div).attr("src","static/img/SlideAtlas_home.jpg").css({position:"absolute",top:"46%",height:"50%",left:"13%","box-shadow":"10px 10px 5px #888"}),this.TitleBar=$("<div>").appendTo(this.Div).css({position:"absolute",top:"18%",bottom:"58%",left:"0%",right:"3%",background:"#073E87",color:"#FFF"}),this.Title=$("<span>").appendTo(this.TitleBar).attr("contenteditable","true").css({position:"absolute",top:"1em",left:"13%"}).saScalableFont({scale:"0.3"}),this.AuthorBar=$("<div>").appendTo(this.Div).css({position:"absolute",top:"42%",bottom:"0%",left:"62%",right:"3%",background:"#E9F5FE",color:"#888","padding-left":"2em"}),this.AuthorText=$("<span>").appendTo(this.AuthorBar).attr("contenteditable","true").css({position:"absolute",top:"2em"}).saScalableFont({scale:"0.1"});if(this.Edit){var n=this;this.Title.focusin(function(){SA.ContentEditableHasFocus=!0}).focusout(function(){SA.ContentEditableHasFocus=!1}),this.AuthorText.focusin(function(){SA.ContentEditableHasFocus=!0}).focusout(function(){SA.ContentEditableHasFocus=!1})}}function i(e,t,n){this.Edit=t,this.Note=null,this.Div=$("<div>").appendTo(e).hide().css({"background-color":n,position:"absolute",width:"100%",height:"100%"})}function s(e,t){var n=this;this.UserCallback=t,this.Parent=e,this.SearchData=[],e.css({overflow:"auto","text-align":"left",color:"#303030","font-size":"18px"}),this.SearchForm=$("<form>").appendTo(e).css({width:"100%",display:"table"}).submit(function(e){return n.SearchCallback(),!1}),this.SearchLabel=$("<span>").appendTo(this.SearchForm).css({display:"table-cell",padding:"8px",width:"3.5em"}).text("Search:"),this.SearchInput=$("<input>").appendTo(this.SearchForm).css({width:"95%",display:"table-cell",border:"2px inset #CCC"}).focusin(function(){SA.ContentEditableHasFocus=!0}).focusout(function(){SA.ContentEditableHasFocus=!1}),this.SearchResults=$("<div>").appendTo(e).css({position:"absolute",top:"2em",bottom:"0px",width:"100%","overflow-y":"auto"})}function o(e,t){var n=this;this.UserCallback=t,e.css({overflow:"auto","text-align":"left",color:"#303030","font-size":"18px"}),this.ClearButton=$("<button>").appendTo(e).click(function(){n.ClipboardDeleteAll()}).text("Remove All"),this.ClipboardDiv=$("<div>").css({overflow_y:"auto"}).appendTo(e),$.ajax({type:"get",url:"webgl-viewer/getfavoriteviews",success:function(e,t){t=="success"?n.LoadClipboardCallback(e):SA.Debug("ajax failed - get favorite views 2")},error:function(){SA.Debug("AJAX - error() : getfavoriteviews 2")}})}e.prototype.StartTimerShow=function(){var e=this;SA.ContentEditableHasFocus=!0;var t=$("<div>").dialog({modal:!1,resizable:!1,position:{my:"left top",at:"left top",of:window},beforeClose:function(){SA.ContentEditableHasFocus=!1},buttons:{Start:function(){e.StartFullScreen();var t=parseInt(e.DurationInput.val())*1e3;setTimeout(function(){e.TimerCallback(t)},t),$(this).dialog("destroy")}}});this.DurationLabel=$("<label>").appendTo(t).text("Seconds:"),this.DurationInput=$('<input type="number" min="1" step="1">').appendTo(t).val(30).css({width:"4em"})},e.prototype.StartFullScreen=function(){var e=document.body;this.ResizePanel.Hide(),this.EditOff(),$(window).trigger("resize"),this.ShowButton.hide(),this.TimerButton.hide(),e.requestFullscreen?e.requestFullscreen():e.msRequestFullscreen?e.msRequestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen&&e.webkitRequestFullscreen(),this.FullScreen=!0;var t=this;$(e).bind("webkitfullscreenchange mozfullscreenchange fullscreenchange",function(e){var n=document.fullScreen||document.mozFullScreen||document.webkitIsFullScreen;t.FullScreen=n,t.FullScreen||(t.ResizePanel.Show(),t.EditOn(),t.ShowButton.show(),t.TimerButton.show())})},e.prototype.EditOff=function(){SA.Edit&&this.Edit&&(this.Edit=!1,this.SaveButton.hide(),this.InsertMenuButton.hide(),this.DeleteSlideButton.hide(),this.EditTabs.DisableTabDiv(this.BrowserDiv),this.EditTabs.DisableTabDiv(this.SearchDiv),this.EditTabs.DisableTabDiv(this.ClipboardDiv),this.TitlePage.EditOff(),this.SlidePage.EditOff(),this.HtmlPage.EditOff())},e.prototype.EditOn=function(){if(this.FullScreen)return;SA.Edit&&!this.Edit&&(this.Edit=!0,this.SaveButton.show(),this.InsertMenuButton.show(),this.DeleteSlideButton.show(),this.EditTabs.EnableTabDiv(this.BrowserDiv),this.EditTabs.EnableTabDiv(this.SearchDiv),this.EditTabs.EnableTabDiv(this.ClipboardDiv),this.TitlePage.EditOn(),this.SlidePage.EditOn(),this.HtmlPage.EditOn(),this.DeleteSlideButton.show())},e.prototype.InitializeLeftPanel=function(e){this.EditTabs=new SA.TabbedDiv(e),this.EditTabs.Div.css({width:"100%",height:"100%"}),this.SlidesDiv=this.EditTabs.NewTabDiv("Slides"),this.SlidesDiv.css({"text-align":"left",color:"#303030","font-size":"18px"}),this.SlideList=$("<div>").appendTo(this.SlidesDiv).css({position:"absolute",width:"100%",top:"32px",bottom:"3px","overflow-y":"auto"});if(SA.Edit){this.BrowserDiv=this.EditTabs.NewTabDiv("Browse"),this.SearchDiv=this.EditTabs.NewTabDiv("Search"),this.ClipboardDiv=this.EditTabs.NewTabDiv("Clipboard");var n=this;this.SaveButton=$("<img>").appendTo(this.SlidesDiv).prop("title","save").addClass("editButton").attr("src",SA.ImagePathUrl+"save22.png").css({"float":"right"}).click(function(){n.Save()}),this.InsertMenuButton=$("<div>").appendTo(this.SlidesDiv).addClass("editButton").css({"float":"right",position:"relative"}).saMenuButton({"New Slide":function(){n.InsertNewSlide("HTML")},"Copy Slide":function(){n.InsertSlideCopy()},"Insert Text":function(){n.HtmlPage.InsertTextBox().css({height:"25%"})},"Insert Question":function(){n.HtmlPage.InsertQuestion()},"Insert Rectangle":function(){n.HtmlPage.InsertRectangle("#073E87","0%","60%","97.5%","14%")},"Insert Image":function(){n.InsertImage()},"Insert MP4":function(){n.InsertVideo()},"Embed Youtube":function(){n.InsertYoutube()}}),$("<img>").appendTo(this.InsertMenuButton).attr("src",SA.ImagePathUrl+"new_window.png"),this.QuizMenu=$('<select name="quiz" id="quiz">').appendTo(this.SlidesDiv).css({"float":"right",margin:"3px"}).change(function(){this.value=="review"?n.RootNote.Mode="answer-show":this.value=="hidden"?n.RootNote.Mode="answer-hide":this.value=="interactive"&&(n.RootNote.Mode="answer-interactive"),n.UpdateQuestionMode()}),$("<option>").appendTo(this.QuizMenu).text("review"),$("<option>").appendTo(this.QuizMenu).text("hidden"),$("<option>").appendTo(this.QuizMenu).text("interactive"),this.QuizLabel=$("<div>").appendTo(this.SlidesDiv).css({"float":"right","font-size":"small","margin-top":"4px"}).text("quiz"),this.RootNote.Mode=="answer-hide"?this.QuizMenu.val("hidden"):this.RootNote.Mode=="answer-interactive"?this.QuizMenu.val("interactive"):(this.RootNote.Mode="answer-show",this.QuizMenu.val("review")),this.BrowserPanel=new SA.BrowserPanel(this.BrowserDiv,function(e){n.AddViewCallback(e)}),this.BrowserDiv.css({"overflow-y":"auto"}),this.SearchPanel=new SA.SearchPanel(this.SearchDiv,function(e){n.AddImageCallback(e)}),this.ClipboardPanel=new SA.ClipboardPanel(this.ClipboardDiv,function(e){n.AddViewCallback(e)})}this.UserTextDiv=this.EditTabs.NewTabDiv("Notes","private notes"),this.UserNoteEditor=new t(this.UserTextDiv),this.EditTabs.ShowTabDiv(this.SlidesDiv)},t.prototype.EventuallyUpdate=function(){this.UpdateTimer&&(clearTimeout(this.UpdateTimer),this.UpdateTimer=null);var e=this;this.UpdateTimer=setTimeout(function(){e.UpdateNote()},5e3)},t.prototype.UpdateNote=function(){if(this.ParentNote&&this.ParentNote.UserNote){var e=this.ParentNote.UserNote;e.Text=this.TextEditor.html();if(this.ParentNote.Id&&this.Modified){var t=this;e.Save(function(){t.Modified=!1})}}},t.prototype.SetNote=function(e){if(this.ParentNote==e)return;this.UpdateNote(),this.ParentNote=null,this.TextEditor.html(""),this.TextEditor.attr("contenteditable","false").css("border","");if(!e)return;this.ParentNote=e;if(e.UserNote){this.TextEditor.html(e.UserNote.Text).attr("contenteditable","true").css({border:"2px inset #DDD"});return}if(!e.Id){e.SetUserNote(new SA.Note),this.TextEditor.attr("contenteditable","true").css({border:"2px inset #DDD"});return}var t=this;$.ajax({type:"get",url:"/webgl-viewer/getusernotes",data:{parentid:e.Id},success:function(n,r){t.LoadUserNote(n,e.Id)},error:function(){SA.Debug("AJAX - error() : getusernotes")}})},t.prototype.LoadUserNote=function(e,t){if(!this.ParentNote||this.ParentNote.Id!=t)return;var n=this.ParentNote;n.SetUserNote(new SA.Note);if(e.Notes&&e.Notes.length>0){e.Notes.length>1&&SA.Debug("Warning: Only showing the first user note.");var r=e.Notes[0];n.UserNote.Load(r)}this.TextEditor.html(n.UserNote.Text),this.TextEditor.attr("contenteditable","true").css({border:"2px inset #DDD"})},e.prototype.UpdateQuestionMode=function(){if(!this.RootNote)return;$(".sa-question").saQuestion("SetMode",this.RootNote.Mode);if(this.RootNote.Mode=="answer-hide"&&this.Index!=0){var e=$(".sa-presentation-title"),t=e.clone();e.hide(),t.appendTo(e.parent()).html("#"+this.Index).addClass("sa-standin").attr("contenteditable","false").saScalableFont()}else $(".sa-standin").remove(),$(".sa-presentation-title").show();this.UpdateSlidesTab()},e.prototype.TimerCallback=function(e){if(this.Index==this.GetNumberOfSlides()-1){this.GotoSlide(0),SA.ContentEditableHasFocus=!1;return}this.GotoSlide(this.Index+1);var t=this.SlidePage.List.TextEntry[0];$(t).attr("contenteditable","true");var n=window.getSelection();range=document.createRange(),range.selectNodeContents(t),n.removeAllRanges(),n.addRange(range),document.execCommand("bold",!1,null),document.execCommand("bold",!1,null),this.SlidePage.AnnotationWidget1&&this.SlidePage.AnnotationWidget1.SetVisibility(!1),this.SlidePage.AnnotationWidget2&&this.SlidePage.AnnotationWidget2.SetVisibility(!1),range.collapse(!1),n.removeAllRanges(),n.addRange(range),$(t).attr("contenteditable","false");var r=this;setTimeout(function(){r.TimerCallback(e)},e)},e.prototype.AddViewCallback=function(e){if(e.Type=="HTML"){var t=this.Index+1,n=new SA.Note;n.Load(e),this.HtmlPage.UpdateEdits(),this.RootNote.Children.splice(t-1,0,n),this.GotoSlide(t),this.UpdateSlidesTab();return}if(this.Note.Type=="HTML"){this.HtmlPage.InsertView(e);return}var r=new SA.ViewerRecord;r.Load(e.ViewerRecords[0]),this.Note.ViewerRecords.push(r),this.SlidePage.DisplayNote(this.Note,SA.presentation.Index)},e.prototype.AddImageCallback=function(e){var t=new SA.ViewerRecord;t.OverviewBounds=e.bounds,t.Image=e,t.Camera={FocalPoint:[(e.bounds[0]+e.bounds[1])/2,(e.bounds[2]+e.bounds[3])/2,0],Roll:0,Height:e.bounds[3]-e.bounds[2],Width:e.bounds[1]-e.bounds[0]};if(this.Note.Type=="HTML"){this.HtmlPage.InsertViewerRecord(t);return}if(this.Note!=this.RootNote){var n=new SA.Note;n.ViewerRecords[0]=t,this.SlidePage.InsertViewNote(n);return}this.RootNote.ViewerRecords.length==0&&this.RootNote.ViewerRecords.push(t)},e.prototype.HandleKeyDown=function(e){if(SA.ContentEditableHasFocus)return!0;if(e.keyCode=="32"||e.keyCode=="34"||e.keyCode=="78"||e.keyCode=="39"||e.keyCode=="40"||e.keyCode=="13")return this.GotoSlide(this.Index+1),!1;if(e.keyCode=="80"||e.keyCode=="37"||e.keyCode=="38"||e.keyCode=="33")return this.GotoSlide(this.Index-1),!1;if(e.keyCode=="36")return this.GotoSetSlide(0),!1;if(e.keyCode=="35")return this.GotoSlide(this.GetNumberOfSlides()-1),!1},e.prototype.Save=function(){this.HtmlPage.Div.find(".sa-answer").css({color:"#000"});var e=this;this.TitlePage.UpdateEdits(),this.SlidePage.UpdateEdits(),this.HtmlPage.UpdateEdits();for(var t=0;t<SA.Notes.length;++t){var n=SA.Notes[t];n.Type=="UserNote"&&(n.LoadState||n.Text!="")&&n.Save()}var r=this.RootNote;if(r.ViewerRecords.length<1){var i=new SA.ViewerRecord;i.Load({AnnotationVisibility:2,Annotations:[],Camera:{FocalPoint:[510,519],Height:1009,Roll:0,Width:1066},Database:"507f34a902e31010bcdb1366",Image:{TileSize:256,_id:"55b4e5c03ed65909a84cd938",bounds:[0,1020,15,1024],components:3,database:"507f34a902e31010bcdb1366",dimensions:[1020,1009],filename:"projection-screen.jpg",label:"projection-screen.jpg",levels:3,origin:[0,0,0],spacing:[1,1,1],NumberOfLevels:3,OverviewBounds:[0,1020,15,1024]}}),r.ViewerRecords.push(i)}this.RootNote.Save();var s=!1,o=SA.Session.session.views;for(var t=0;t<o.length&&!s;++t)o[t].id==this.RootNote.Id&&(s=!0);s||(o.splice(0,0,{id:this.RootNote.Id}),$.ajax({type:"post",data:{to:SA.SessionId,view:this.RootNote.Id},url:"webgl-viewer/move-view",success:function(e,t){t!="Success"&&SA.Debug(e)},error:function(){SA.Debug("AJAX - error() : session-add-view")}}))},e.prototype.DeleteSlide=function(e){var t=this.GetNumberOfSlides()-1;if(e<1||e>t)return;this.RootNote.Children.splice(e-1,1),this.Index>e&&(this.Index-=1),e==this.Index&&(e==t&&--e,this.Index=-1,this.GotoSlide(e)),this.UpdateSlidesTab()},e.prototype.DeleteCurentSlide=function(){this.DeleteSlide(this.Index)},e.prototype.InsertNewSlide=function(e){var t=this.Index+1,n=new SA.Note;e&&(n.Type=e),this.RootNote.Children.splice(t-1,0,n),n.Parent=this.RootNote,this.GotoSlide(t),this.UpdateSlidesTab(),e=="HTML"&&this.HtmlPage.InitializeSlidePage(),this.UpdateQuestionMode()},e.prototype.InsertSlideCopy=function(e){var t=this.Index+1,n=new SA.Note;this.HtmlPage.UpdateEdits(),n.DeepCopy(this.Note),this.RootNote.Children.splice(t-1,0,n),this.GotoSlide(t),this.UpdateSlidesTab()},e.prototype.InsertImage=function(){var e=prompt("Image URL","https://slide-atlas.org/static/img/SlideAtlas_home.jpg");this.HtmlPage.InsertImage(e)},e.prototype.InsertVideo=function(){var e=prompt("Video URL","https://slide-atlas.org/api/v2/sessions/53ac02d5a7a14110d929adcc/attachments/55fef0e6a7a14162dfb4da32");this.HtmlPage.InsertVideo(e)},e.prototype.InsertYoutube=function(){var e=prompt("Video IFrame URL",'<iframe width="420" height="315" src="https://www.youtube.com/embed/9tCafgGZtxQ" frameborder="0" allowfullscreen></iframe>');this.HtmlPage.InsertIFrame(e)},e.prototype.GotoSlide=function(e){if(e<0||e>=this.GetNumberOfSlides()||e==this.Index)return;this.TitlePage.ClearNote(),this.SlidePage.ClearNote(),this.HtmlPage.ClearNote(),this.AspectDiv.show(),this.Index=e,e==0?(this.Note=this.RootNote,this.Note.Type=="Presentation"?(this.SlidePage.Div.hide(),this.HtmlPage.Div.hide(),this.TitlePage.DisplayNote(this.Note)):this.Note.Type=="HTML"&&(this.TitlePage.Div.hide(),this.SlidePage.Div.hide(),this.HtmlPage.Div.show(),this.HtmlPage.DisplayNote(this.Note),this.Note.Text==""&&this.HtmlPage.InitializeTitlePage()),this.UserNoteEditor.SetNote(this.Note)):(this.Note=this.GetSlide(e),this.Note.Type=="HTML"?(this.TitlePage.Div.hide(),this.SlidePage.Div.hide(),this.HtmlPage.Div.show(),this.HtmlPage.DisplayNote(this.Note),this.UserNoteEditor.SetNote(this.Note)):(this.TitlePage.Div.hide(),this.HtmlPage.Div.hide(),this.SlidePage.DisplayNote(this.Note,e)));if(e<this.RootNote.Children.length){var t=this.RootNote.Children[e];t.ViewerRecords.length>0&&t.ViewerRecords[0].LoadTiles([0,0,400,300]),t.ViewerRecords.length>1&&t.ViewerRecords[1].LoadTiles([0,0,400,300])}this.UpdateSlidesTab(),this.UpdateQuestionMode(),$(window).trigger("resize")},e.prototype.GetNumberOfSlides=function(){return this.RootNote.Children.length+1},e.prototype.GetSlide=function(e){return e<0||e>this.RootNote.Children.length?null:e==0?this.RootNote:this.RootNote.Children[e-1]},e.prototype.SortCallback=function(){var e=this.SlideList.find("div"),t=[],n=0;for(var r=0;r<e.length;++r){var i=parseInt($(e[r]).data("index"));i!=0&&t.push(this.GetSlide(i)),this.Index==i&&(n=t.length)}this.RootNote.Children=t,this.Index=n,this.UpdateSlidesTab()},e.prototype.UpdateSlidesTab=function(){var e=this;if(!this.SlideList)return;this.SlideList.empty(),SA.Edit&&this.SlideList.sortable({update:function(t,n){e.SortCallback()},handle:".ui-icon"});for(var t=0;t<this.GetNumberOfSlides();++t){var n=this.GetSlide(t),r,r=n.Text,i=r.indexOf("sa-presentation-text");if(i==-1)r=n.Title,r==""&&(r="Slide "+t);else{r=r.substring(i),i=r.indexOf(">"),r=r.substring(i+1),i=r.indexOf("<");while(i==0)i=r.indexOf(">"),r=r.substring(i+1),i=r.indexOf("<");r=r.substring(0,i),n.Title==""&&(n.Title=r)}this.RootNote.Mode=="answer-hide"&&(r="#"+t);var s=$("<div>").appendTo(this.SlideList).css({position:"relative","padding-left":"1.5em","padding-right":"1.5em",margin:"5px",color:"#29C",cursor:"pointer"}).hover(function(){$(this).css("color","blue")},function(){$(this).css("color","#29C")}).text(r).data("index",t).click(function(){SA.presentation.GotoSlide($(this).data("index"))}),o=$("<span>").appendTo(s).css({position:"absolute",left:"7px",top:"2px",opacity:"0.5"}).addClass("ui-icon ui-icon-bullet");SA.Edit&&o.addClass("sa-sort-handle"),this.Note==n&&s.css({background:"#EEE"})}},n.prototype.SetFullWindowView=function(e){e?(SA.presentation.EditOff(),this.FullWindowViewOffButton.show(),this.FullWindowView1Button.hide(),this.FullWindowView2Button.hide(),this.BottomDiv.hide(),this.ViewPanel.css({height:"100%"})):(this.FullWindowViewOffButton.hide(),this.FullWindowView1Button.show(),this.FullWindowView2Button.show(),this.BottomDiv.show(),this.ViewPanel.css({bottom:"300px",height:"auto"}),SA.Edit&&SA.presentation.EditOn()),this.FullWindowView=e,this.ResizeViews()},n.prototype.RecordView1=function(){this.Edit&&this.Note&&this.Note.ViewerRecords.length>0&&this.Note.ViewerRecords[0]&&this.Note.ViewerRecords[0].CopyViewer(this.ViewerDiv1[0].saViewer)},n.prototype.RecordView2=function(){this.Edit&&this.Note&&this.Note.ViewerRecords.length>1&&this.Note.ViewerRecords[1]&&this.Note.ViewerRecords[1].CopyViewer(this.ViewerDiv2[0].saViewer)},n.prototype.EditOff=function(){SA.Edit&&this.Edit&&(this.Edit=!1,this.Div.css({width:"100%",left:"0px"}),this.AnnotationWidget1.hide(),this.AnnotationWidget2.hide(),this.ViewerDiv1[0].saViewer.OnInteraction(),this.ViewerDiv2[0].saViewer.OnInteraction(),this.RemoveView1Button.hide(),this.RemoveView2Button.hide(),this.List.EditOff())},n.prototype.EditOn=function(){if(SA.Edit&&!this.Edit){this.Edit=!0,this.AnnotationWidget1.show(),this.AnnotationWidget2.show();var e=this;this.ViewerDiv1[0].saViewer.OnInteraction(function(){e.RecordView1()}),this.ViewerDiv2[0].saViewer.OnInteraction(function(){e.RecordView2()}),this.RemoveView1Button.show(),this.RemoveView2Button.show(),this.List.EditOn()}},n.prototype.PlaceViewer=function(e,t,n){var r=n[2]*.8,i=n[3]*.8,s=t.Camera,o=i/s.Height,r=o*s.Width;r>n[2]*.8&&(r=n[2]*.8,o=r/s.Width,i=o*s.Height);var u=n[0]+(n[2]-r)/2,a=n[1]+(n[3]-i)/2;e&&(e[0].saViewer.SetViewport([u,a,r,i]),e[0].saViewer.EventuallyRender(!1))},n.prototype.ResizeViews=function(){var e=this.ViewPanel.width(),t=this.ViewPanel.height();if(this.FullWindowView){this.ViewerDiv1[0].saViewer.SetViewport([0,0,0,t]),this.ViewerDiv2[0].saViewer.SetViewport([0,0,0,t]),this.FullWindowView[0].saViewer.SetViewport([0,0,e,t]),this.FullWindowView[0].saViewer.EventuallyRender(!1);return}var n=this.Records.length,r;n==0&&(this.ViewerDiv1[0].saViewer.SetViewport([0,0,0,t]),this.ViewerDiv2[0].saViewer.SetViewport([0,0,0,t])),n==1&&(r=this.Records[0],this.PlaceViewer(this.ViewerDiv1,r,[0,0,e,t]),this.ViewerDiv2[0].saViewer.SetViewport([0,0,0,t]));if(n>1){var i=e/2;r=this.Records[0],this.PlaceViewer(this.ViewerDiv1,r,[0,0,i,t]),r=this.Records[1],this.PlaceViewer(this.ViewerDiv2,r,[i,0,i,t])}this.Edit&&(n==0&&(this.AnnotationWidget1.hide(),this.AnnotationWidget2.hide()),n==1&&(this.AnnotationWidget1.show(),this.AnnotationWidget2.hide()),n==2&&(this.AnnotationWidget1.show(),this.AnnotationWidget2.show()))},n.prototype.ClearNote=function(){this.Edit&&this.Note&&this.UpdateEdits(),this.Note=null},n.prototype.DisplayNote=function(e,t){this.Div.show(),this.Note=e,this.ViewerDiv1[0].saViewer.Reset(),this.ViewerDiv2[0].saViewer.Reset(),this.Records=e.ViewerRecords,this.Title.text("Slide: "+t),this.List.LoadNote(e),this.Records.length>0&&this.Records[0].Apply(this.ViewerDiv1[0].saViewer),this.Records.length>1&&this.Records[1].Apply(this.ViewerDiv2[0].saViewer),this.ViewerDiv1[0].saViewer.CopyrightWrapper.hide(),this.ViewerDiv2[0].saViewer.CopyrightWrapper.hide(),this.ResizeViews()},n.prototype.UpdateEdits=function(){this.Note&&this.Note.ViewerRecords.length>0&&this.Note.ViewerRecords[0]&&this.Note.ViewerRecords[0].CopyViewer(this.ViewerDiv1[0].saViewer),this.Note&&this.Note.ViewerRecords.length>1&&this.Note.ViewerRecords[1]&&this.Note.ViewerRecords[1].CopyViewer(this.ViewerDiv2[0].saViewer)},n.prototype.InsertViewNote=function(e){if(e.ViewerRecords.length<1)return;var t=e.ViewerRecords[0];this.Note.ViewerRecords.push(t),this.Note.ViewerRecords.length==1?this.Note.ViewerRecords[0].Apply(this.ViewerDiv1[0].saViewer):this.Note.ViewerRecords.length==2&&this.Note.ViewerRecords[1].Apply(this.ViewerDiv2[0].saViewer),this.DisplayNote(this.Note,SA.presentation.Index)},r.prototype.EditOff=function(){SA.Edit&&this.Edit&&(this.Edit=!1,this.Div.css({width:"100%",left:"0px"}),this.Title.attr("readonly","readonly").attr("spellcheck","false").unbind("focusin").unbind("focusout").blur(),this.AuthorText.attr("readonly","readonly").attr("readonly","readonly").attr("spellcheck","false").unbind("focusin").unbind("focusout").blur())},r.prototype.EditOn=function(){SA.Edit&&!this.Edit&&(this.Edit=!0,this.Title.attr("contenteditable","true").attr("spellcheck","true").focusin(function(){SA.ContentEditableHasFocus=!0}).focusout(function(){SA.ContentEditableHasFocus=!1}),this.AuthorText.attr("readonly","readonly").attr("contenteditable","true").attr("spellcheck","true").focusin(function(){SA.ContentEditableHasFocus=!0}).focusout(function(){SA.ContentEditableHasFocus=!1}))},r.prototype.ClearNote=function(){this.Edit&&this.Note&&this.UpdateEdits(),this.Note=null},r.prototype.DisplayNote=function(e){this.Note=e,this.Div.show(),this.Title.html(e.HiddenTitle),this.AuthorText.html(e.Text);var t=window.getSelection(),n;n=document.createRange(),n.noCursor=!0,n.selectNodeContents(this.Title[0]),t.removeAllRanges(),t.addRange(n),document.execCommand("foreColor",!1,"#FFF"),document.execCommand("fontSize",!1,"6"),document.execCommand("fontName",!1,"Arial"),n.selectNodeContents(this.AuthorText[0]),t.removeAllRanges(),t.addRange(n),document.execCommand("fontSize",!1,"5"),document.execCommand("fontName",!1,"Arial"),t.removeAllRanges(),this.Title.blur(),this.AuthorText.blur()},r.prototype.UpdateEdits=function(){this.Note&&(this.Note.Text=this.AuthorText.html(),this.Note.HiddenTitle=this.Title.html())},i.prototype.EditOff=function(){SA.Edit&&this.Edit&&(this.Edit=!1,this.Div.css({width:"100%",left:"0px"}),this.SaEditOff())},i.prototype.EditOn=function(){SA.Edit&&!this.Edit&&(this.Edit=!0,this.SaEditOn())},i.prototype.SaEditOff=function(){$(".sa-edit-gui").saButtons("disable"),$(".sa-presentation-text").attr("contenteditable","false"),$(".sa-presentation-rectangle").saElement({editable:!1,interactive:!1}),$(".sa-light-box").saLightBox({editable:!1,interactive:!0})},i.prototype.SaEditOn=function(){$(".sa-edit-gui").saButtons("enable"),$(".sa-presentation-text").attr("contenteditable","true"),$(".sa-presentation-rectangle").saElement({editable:!0,interactive:!0}),$(".sa-light-box").saLightBox({editable:!0,interactive:!0})},i.prototype.ClearNote=function(){this.Edit&&this.Note&&this.UpdateEdits(),this.Note=null},i.prototype.DisplayNote=function(e){this.DefaultViewerPositions=[];var t=$(".sa-lightbox-viewer");for(var n=0;n<t.length;++n)this.DefaultViewerPositions.push({left:t[n].style.left,top:t[n].style.top,width:t[n].style.width,height:t[n].style.height});this.Note=e,this.Div.show(),this.Div.saHtml(e.Text),this.Edit?this.SaEditOn():this.SaEditOff(),SA.Edit||$(".sa-text-editor").attr("contenteditable","false");var r=this;this.Div.find(".sa-presentation-image").saLightBox({editable:SA.Edit,aspectRatio:!0}),this.Div.find(".sa-lightbox-viewer").saLightBoxViewer({editable:SA.Edit,"delete":function(e){r.ViewDeleteCallback(e)}}),this.Div.find(".sa-presentation-rectangle").saRectangle({editable:SA.Edit}),$("sa-draggable").saDraggable(),this.BindElements()},i.prototype.InitializeTitlePage=function(){this.Div.empty(),this.Div[0].className="sa-presentation-title-page",this.InsertRectangle("#073E87","0%","31%","97.5%","25%");var e=this.InsertTextBox(50).addClass("sa-presentation-title").css({color:"white",left:"10%",width:"88%",top:"40%"}).text("Title"),t=this.InsertTextBox(28).css({left:"10%",width:"88%",top:"59%"}).text("Author");this.UpdateEdits(),this.BindElements()},i.prototype.InitializeSlidePage=function(){this.Div.empty(),this.Div[0].className="sa-presentation-slide-page",this.InsertRectangle("#073E87","0%","6%","97.5%","14%");var e=this.InsertTextBox(42).css({color:"white",left:"18%",width:"70%",top:"7.25%",height:"11.5%"}).text("Title").addClass("sa-presentation-title");this.UpdateEdits(),this.BindElements()},i.prototype.InsertImage=function(e){var t,n=5+Math.floor(Math.random()*10),r=20+Math.floor(Math.random()*10);t=$("<div>").appendTo(this.Div).css({position:"absolute",left:n+"%",top:r+"%","z-index":"1"}).saLightBox({aspectRatio:!0,editable:SA.Edit}).addClass("sa-presentation-image");var i=$("<img>").appendTo(t).css({width:"100%",height:"100%"});return i[0].onload=function(){this.parentNode.style.width=this.width+"px",this.parentNode.style.height=this.height+"px",this.parentNode.saElement.ConvertToPercentages()},i.attr("src",e)
,t},i.prototype.InsertVideo=function(e){var t=$("<div>").appendTo(this.Div).css({position:"absolute",left:"10%",top:"30%","z-index":"1"}).addClass("sa-presentation-video").saDraggable().saDeletable(),n=$("<video controls>").appendTo(t),e=$('<source type="video/mp4">').appendTo(n).attr("src",e);return n[0].addEventListener("loadeddata",function(){var e=$(this).width()/$(this).height();t.saResizable({aspectRatio:e}),n.css({height:"100%",width:"100%"})},!1),t},i.prototype.InsertRectangle=function(e,t,n,r,i){var s=$("<div>").appendTo(this.Div).css({"background-color":e,border:"1px solid rgba(255, 255, 255, 0)",position:"absolute",left:t,width:r,top:n,height:i}).saRectangle({editable:SA.Edit})},i.prototype.Paste=function(){var e=$("<div>").appendTo(this.Div).css({position:"absolute",left:"5%",top:"25%"}).text("paste here").saDraggable().saDeletable();e.attr("contenteditable","true").focus();var t=window.getSelection(),n=document.createRange();n.noCursor=!0,n.selectNodeContents(e[0]),t.removeAllRanges(),t.addRange(n),document.execCommand("paste",!1,null)},i.prototype.InsertIFrame=function(e){var t,n,r=e.indexOf("width");if(r!=-1){var i=e.substring(r+7),s=i.indexOf('"'),o=i.substr(0,s);t=parseInt(o)/(800*1.333),t=Math.round(t*100),t+="%",e=e.replace(o,t)}r=e.indexOf("height");if(r!=-1){var i=e.substring(r+8),s=i.indexOf('"'),o=i.substr(0,s);n=parseInt(o)/800,n=Math.round(n*100),n+="%",e=e.replace(o,n)}var u=$(e).appendTo(this.Div).css({position:"absolute",display:"block",left:"5%",top:"5%","z-index":"1"}).saDraggable().saDeletable();return u},i.prototype.InsertURL=function(e){var t=$("<div>").appendTo(this.Div).css({position:"absolute",left:"5%",right:"2.5%",top:"25%",bottom:"10%","z-index":"1"}).saDraggable().saDeletable().resizable(),n=$("<iframe>").appendTo(t).css({position:"absolute",display:"block",width:"100%",height:"100%"}).attr("src",e).attr("scrolling","no").addClass("sa-presentation-iframe");return this.BindElements(),n},i.prototype.InsertTextBox=function(e){e=e||30;var t=e/800,n=$("<div>").appendTo(this.Div).css({display:"inline-block",position:"absolute",overflow:"visible",fontFamily:"Verdana,sans-serif",border:"1px solid rgba(255, 255, 255, 0)","box-sizing":"border-box",left:"5%",width:"50%",top:"30%",height:"10%",padding:"2% 1% 1% 1%","z-index":"1"}).addClass("sa-presentation-text").saScalableFont({scale:t,editable:SA.Edit}).text("Text");return this.Edit&&n.saTextEditor({dialog:!0,editable:!0}),n},i.prototype.ShuffleQuestion=function(){var e=this.Div.find('.sa-q [type="multiple-choice"]');for(var t=0;t<e.length;++t){var n=e[t];for(j=n.childNodes.length;j>0;--j){var r=Math.floor(Math.random()*j);n.appendChild(n.removeChild(n.childNodes[r]))}}},i.prototype.InsertQuestion=function(){var e=$("<div>").css({position:"absolute",left:"2%",width:"92%",top:"75%",height:"22.5%",background:"#FFF",border:"1px solid #AAA",padding:"1% 1% 1% 1%","z-index":"1"}).saScalableFont({scale:"0.03"}).saQuestion({editable:SA.Edit}),t=this;e.saQuestion("OpenDialog",function(){e.appendTo(t.Div),e.trigger("resize")})},i.prototype.InsertView=function(e){if(!this.Note)return;var t=new SA.Note,n=t.Id;t.Load(e),delete t.Id,t.Id=n,t.ViewerRecords.length==0?SA.Debug("Insert failed: Note has no viewer records."):this.Note.Parent?(this.Note.Children.push(t),t.Parent=this.Note,this.InsertView2(t)):this.InsertViewerRecord(t.ViewerRecords[0])},i.prototype.InsertViewerRecord=function(e){if(!this.Note)return;var t=this.Note.ViewerRecords.length;this.Note.ViewerRecords.push(e);var n={left:"5%",top:"25%",width:"40%",height:"40%"};if(this.DefaultViewerPositions.length>0)n=this.DefaultViewerPositions.splice(0,1)[0];else{var r=this.Div.children().length*5;n.left=r.toString()+"%",n.top=(r+15).toString()+"%"}var i=this,s=$("<div>").appendTo(this.Div).css({position:"absolute","box-shadow":"10px 10px 5px #AAA","background-color":"#FFF",opacity:"1.0",left:n.left,width:n.width,top:n.top,height:n.height}).saLightBoxViewer({note:this.Note,viewerIndex:t,hideCopyright:!0,editable:SA.Edit,"delete":function(e){i.ViewDeleteCallback(e)}});return s},i.prototype.InsertView2=function(e){if(!this.Note)return;var t={left:"5%",top:"25%",width:"45%",height:"45%"};this.DefaultViewerPositions.length>0&&(t=this.DefaultViewerPositions.splice(0,1)[0]);var n=this,r=$("<div>").appendTo(this.Div).css({position:"absolute","box-shadow":"10px 10px 5px #AAA","background-color":"#FFF",opacity:"1.0",left:t.left,width:t.width,top:t.top,height:t.height}).saLightBoxViewer({note:e,dual:!0,hideCopyright:!0,"delete":function(e){n.ViewDeleteCallback(e)},editable:SA.Edit});return r},i.prototype.InsertViewId2=function(e){if(!this.Note)return;var t={left:"5%",top:"25%",width:"45%",height:"45%"};this.DefaultViewerPositions.length>0&&(t=this.DefaultViewerPositions.splice(0,1)[0]);var n=$("<div>").appendTo(this.Div).css({position:"absolute","box-shadow":"10px 10px 5px #AAA","background-color":"#FFF",opacity:"1.0",left:t.left,width:t.width,top:t.top,height:t.height}).saLightBoxViewer({viewId:e,dual:!0,hideCopyright:!0,editable:SA.Edit});return n},i.prototype.ViewDeleteCallback=function(e){this.DefaultViewerPositions.push({left:e.style.left,top:e.style.top,width:e.style.width,height:e.style.height});if(e.saViewer.saNote!=this.Note){var t=this.Note.Children.indexOf(e.saViewer.saNote);t>=0&&this.Note.Children.splice(t,1)}},i.prototype.BindElements=function(){var e=$(".sa-presentation-iframe");e.addClass("sa-resize");for(var t=0;t<e.length;++t){var n=e[t];n.onresize=function(){var e=$(this).parent().width(),t=$(this).parent().height(),n=Math.min(t,e/1.62)/700;scaleStr=n.toString(),e=Math.floor(e/n).toString(),t=Math.floor(t/n).toString(),$(this).css({"-ms-zoom":scaleStr,"-ms-transform-origin":"0 0","-moz-transform":"scale("+scaleStr+")","-moz-transform-origin":"0px 50px","-o-transform":"scale("+scaleStr+")","-o-transform-origin":"0px 50px","-webkit-transform":"scale("+scaleStr+")","-webkit-transform-origin":"0 0",width:e+"px",height:t+"px"})},n.onresize()}},i.prototype.UpdateEdits=function(){if(this.Note){this.Div.find(".sa-lightbox-viewer").saRecordViewer();var e=this.Div,t=this.Note,n=[];for(var r=0;r<this.Note.ViewerRecords.length;++r){var i=this.Note.ViewerRecords[r],s=r.toString(),o=$("[sa-viewer-index="+s+"]");o.length>0&&(o.attr("sa-viewer-index",n.length),n.push(i))}this.Note.ViewerRecords=n,t.Text=e.saHtml()}},s.prototype.SearchCallback=function(){var e=this,t=this.SearchInput.val();this.Parent.css({cursor:"progress"}),$.ajax({type:"get",url:"/webgl-viewer/query",data:{terms:t},success:function(t,n){e.LoadSearchResults(t),e.Parent.css({cursor:"default"})},error:function(){SA.Debug("AJAX - error() : query"),e.Parent.css({cursor:"default"})}})},s.prototype.LoadSearchResults=function(e){var t=this;this.SearchResults.empty(),this.SearchData=e.images;for(var n=0;n<e.images.length;++n){var r=e.images[n],i=$("<div>").appendTo(this.SearchResults).css({"float":"left",margin:"5px",border:"1px solid #AAA"}).attr("id",r._id).data("index",n).hover(function(){$(this).css({"border-color":"#00F"})},function(){$(this).css({"border-color":"#AAA"})}).click(function(){t.SelectCallback($(this).data("index"))}),s={img:r._id,db:r.database,levels:r.levels,tile_size:r.TileSize,bounds:r.bounds,label:r.label};s.bounds||(s.bounds=[0,r.dimensions[0],0,r.dimensions[1]]);var o=new SA.CutoutThumb(s,100);o.Div.appendTo(i);var u=$("<div>").css({"font-size":"50%"}).appendTo(i).text(r.label)}},s.prototype.SelectCallback=function(e){this.UserCallback&&e>=0&&e<this.SearchData.length&&this.UserCallback(this.SearchData[e])},o.prototype.LoadClipboardCallback=function(e){var t=this;this.ClipboardDiv.empty(),this.ClipboardViews=e.viewArray;for(var n=0;n<this.ClipboardViews.length;++n){var r=this.ClipboardViews[n];r.Thumb.substring(0,6)=="http:/"&&(r.Thumb=r.Thumb.substring(6));var i=$("<img>").appendTo(this.ClipboardDiv).attr("src",r.Thumb).prop("title",r.Title).css({"float":"left",margin:"5px",border:"1px solid #AAA",height:"60px"}).attr("index",n).hover(function(){$(this).css({"border-color":"#00F"})},function(){$(this).css({"border-color":"#AAA"})}).click(function(){t.ClickViewCallback(parseInt(this.getAttribute("index")))})}},o.prototype.ClickViewCallback=function(e){this.UserCallback&&e>=0&&e<this.ClipboardViews.length&&this.UserCallback(this.ClipboardViews[e])},o.prototype.ClipboardDeleteAll=function(){var e=this;this.ClipboardDiv.empty();for(var t=0;t<this.ClipboardViews.length;++t)$.ajax({type:"post",url:"/webgl-viewer/deleteusernote",data:{noteId:this.ClipboardViews[t]._id,col:"views"},success:function(e,t){},error:function(){SA.Debug("AJAX - error() : deleteusernote")}})},SA.SearchPanel=s,SA.ClipboardPanel=o,SA.Presentation=e})();(function(){"use strict";SA.TileLoader="http",SA.LoadQueue=[],SA.LoadingCount=0,SA.LoadingMaximum=10,SA.LoadTimeoutId=0,SA.TimeStamp=0,SA.NumberOfTiles=0,SA.NumberOfTextures=0,SA.MaximumNumberOfTiles=5e4,SA.MaximumNumberOfTextures=5e3,SA.PruneTimeTiles=0,SA.PruneTimeTextures=0,SA.LoadProgressMax=0,SA.ProgressBar=null,SA.FinishedLoadingCallbacks=[],SA.InitProgressBar=function(){if(SA.ProgressBar)return;SA.ProgressBar=$("<div>").appendTo("body").addClass("sa-view-progress-bar")},SA.AdvanceTimeStamp=function(){++SA.TimeStamp},SA.GetCurrentTime=function(){return SA.TimeStamp},SA.Prune=function(){var e=!1;SA.NumberOfTiles>=SA.MaximumNumberOfTiles&&(SA.PruneTimeTiles>SA.TimeStamp&&(SA.PruneTimeTiles=0),SA.PruneTimeTiles+=.05*(SA.TimeStamp-SA.PruneTimeTiles),e=!0),SA.NumberOfTextures>=SA.MaximumNumberOfTextures&&(SA.PruneTimeTextures>SA.TimeStamp&&(SA.PruneTimeTextures=0),SA.PruneTimeTextures+=.05*(SA.TimeStamp-SA.PruneTimeTextures),e=!0);if(e)for(i in SA.Caches)cache=SA.Caches[i],cache.PruneTiles()},SA.ClearQueue=function(){for(var e=0;e<SA.LoadQueue.length;++e){var t=SA.LoadQueue[e];t&&(t.LoadState=0)}SA.LoadQueue=[],SA.LoadQueueUpdate()},SA.LoadQueueAddTile=function(e){if(e.LoadState==0||e.LoadState==4)e.LoadState=1,SA.LoadQueue.push(e)};var e=function(){var e=SA.LoadQueue[0];for(var t=1;t<SA.LoadQueue.length;++t){var n=SA.LoadQueue[t],r=!1;n!=null&&(e==null?r=!0:e.TimeStamp>n.TimeStamp?r=!0:e.TimeStamp==n.TimeStamp&&e.Level<n.Level&&(r=!0)),r?(SA.LoadQueue[t]=e,SA.LoadQueue[t-1]=n):e=n}};SA.LoadQueueRemove=function(e){var t=SA.LoadQueue.length;for(var n=0;n<t;++n)if(SA.LoadQueue[n]==e){e.LoadState=0,SA.LoadQueue[n]=null;return}};var t=function(){SA.LoadingCount=0,SA.LoadQueueUpdate()};SA.LoadQueueUpdate=function(){SA.LoadingCount<0&&(SA.LoadingCount=0);while(SA.LoadingCount<SA.LoadingMaximum&&SA.LoadQueue.length>0){e();var n=SA.LoadQueue.pop();n!=null&&n.LoadState==1&&(n.StartLoad(n.Cache),n.LoadState=2,++SA.LoadingCount)}SA.LoadTimeoutId&&(clearTimeout(SA.LoadTimeoutId),SA.LoadTimeoutId=0),SA.LoadingCount&&(SA.LoadTimeoutId=setTimeout(function(){t()},1e3));if(SA.ProgressBar){SA.LoadProgressMax<SA.LoadQueue.length&&(SA.LoadProgressMax=SA.LoadQueue.length);var r=(100*SA.LoadQueue.length/SA.LoadProgressMax).toFixed();r+="%",SA.ProgressBar.css({width:r}),SA.LoadQueue.length==0&&(SA.LoadProgressMax=0)}if(SA.FinishedLoadingCallbacks.length>0&&SA.LoadQueue.length==0&&SA.LoadingCount==0){var i=SA.FinishedLoadingCallbacks.slice(0);SA.FinishedLoadingCallbacks=[];for(var s=0;s<i.length;++s)i[s]()}},SA.AddFinishedLoadingCallback=function(e){SA.FinishedLoadingCallbacks.push(e),SA.LoadQueueUpdate()},SA.ClearFinishedLoadingCallbacks=function(){SA.FinishedLoadingCallbacks=[]},SA.LoadQueueLoaded=function(e){--SA.LoadingCount,e.LoadState=3,SA.LoadQueueUpdate()},SA.LoadQueueError=function(e){e.LoadState=4,--SA.LoadingCount,SA.LoadQueueUpdate()}})();window.SAM=window.SAM||{},function(){"use strict";function e(){this.ZRange=[-1,1],this.Roll=0,this.Matrix=mat4.create(),this.Height=16384,this.Width=this.Height*1.62,this.FocalPoint=[8192,8192],this.ComputeMatrix(),this.Points=[],this.Buffer=null,this.CreateBuffer(),this.Mirror=!1,this.ViewportWidth=162,this.ViewportHeight=100}e.prototype.GetSpacing=function(){return this.GetHeight()/this.ViewportHeight},e.prototype.DeepCopy=function(e){e.ZRange&&(this.ZRange=e.ZRange.slice(0)),this.Roll=e.Roll,this.Height=e.Height,this.Width=e.Width,this.SetFocalPoint(e.FocalPoint),e.ViewportWidth&&(this.ViewportWidth=e.ViewportWidth),e.ViewportHeight&&(this.ViewportHeight=e.ViewportHeight),this.ComputeMatrix()},e.prototype.SetViewport=function(e){if(10*e[3]<e[2])return;this.ViewportWidth=e[2],this.ViewportHeight=e[3],this.Width=this.Height*this.ViewportWidth/this.ViewportHeight,this.ComputeMatrix()},e.prototype.Serialize=function(){var e={};return e.FocalPoint=[this.FocalPoint[0],this.FocalPoint[1]],e.Roll=this.Roll,e.Height=this.GetHeight(),e.Width=this.GetWidth(),e},e.prototype.Load=function(e){this.SetFocalPoint(e.FocalPoint),this.Roll=e.Roll,this.Height=e.Height,e.Width?this.Width=e.Width:this.Width=this.Height*1.62,this.ComputeMatrix()},e.prototype.GetRotation=function(){return this.Roll*180/3.1415926535},e.prototype.GetFocalPoint=function(){return[this.FocalPoint[0],this.FocalPoint[1]]},e.prototype.SetFocalPoint=function(e){if(isNaN(e[0])||isNaN(e[1])){console.log("Camera 1");return}this.FocalPoint[0]=e[0],this.FocalPoint[1]=e[1]},e.prototype.ConvertPointViewerToWorld=function(e,t){e/=this.ViewportWidth,t/=this.ViewportHeight,e=(e*2-1)*this.Matrix[15],t=(1-t*2)*this.Matrix[15];var n=this.Matrix,r=n[0]*n[5]-n[1]*n[4],i=(e*n[5]-t*n[4]+n[4]*n[13]-n[5]*n[12])/r,s=(t*n[0]-e*n[1]-n[0]*n[13]+n[1]*n[12])/r;return[i,s]},e.prototype.ConvertPointWorldToViewer=function(e,t){var n=this.Matrix,r=e*n[3]+t*n[7]+n[15],i=(e*n[0]+t*n[4]+n[12])/r,s=(e*n[1]+t*n[5]+n[13])/r;return i=(1+i)*.5*this.ViewportWidth,s=(1-s)*.5*this.ViewportHeight,[i,s]},e.prototype.HandleTranslate=function(e,t){var n=Math.sin(this.Roll),r=Math.cos(this.Roll),i=this.FocalPoint[0],s=this.FocalPoint[1],o=10,u=this.GetWidth(),a=this.GetHeight();this.Mirror&&(t=-t),e*=u,t*=u;var f=e*r+t*n,l=t*r-e*n;this.Translate(f,l,0)},e.prototype.HandleRoll=function(e,t,n,r){if(e==0&&t==0)return;var i=-t*n+e*r;i/=e*e+t*t,this.Mirror&&(i=-i),this.Roll+=i,this.ComputeMatrix()},e.prototype.Translate=function(e,t,n){if(isNaN(e)||isNaN(t)||isNaN(n)){console.log("Camera 2");return}this.FocalPoint[0]+=e,this.FocalPoint[1]+=t,this.ComputeMatrix()},e.prototype.GetHeight=function(){return this.Height},e.prototype.SetHeight=function(e){if(isNaN(e)){console.log("Camera 3");return}this.Height=e,this.Width=e*this.ViewportWidth/this.ViewportHeight},e.prototype.GetWidth=function(){return this.Width},e.prototype.SetWidth=function(e){if(isNaN(e)){console.log("Camera 4");return}this.Width=e,this.Height=e*this.ViewportHeight/this.ViewportWidth},e.prototype.SetRoll=function(e){this.Roll=e},e.prototype.GetBounds=function(){var e=this.GetWidth(),t=new Array(4);return t[0]=this.FocalPoint[0]-e*.5,t[1]=t[0]+e,t[2]=this.FocalPoint[1]-this.Height*.5,t[3]=t[2]+this.Height,t},e.prototype.ComputeMatrix=function(){var e=Math.sin(this.Roll),t=Math.cos(this.Roll),n=this.FocalPoint[0],r=this.FocalPoint[1],i=10,s=this.GetWidth(),o=this.Height;if(s<0)return;this.Mirror&&(o=-o),mat4.identity(this.Matrix),this.Matrix[0]=t,this.Matrix[1]=-e*s/o,this.Matrix[4]=-e,this.Matrix[5]=-t*s/o,this.Matrix[9]=0,this.Matrix[10]=(this.ZRange[1]-this.ZRange[0])*.5,this.Matrix[12]=-t*n+e*r,this.Matrix[13]=-(s/o)*(-e*n-t*r),this.Matrix[14]=-i+(this.ZRange[1]+this.ZRange[0])*.25*s,this.Matrix[15]=.5*s},e.prototype.Reset=function(){var e=[];e[0]=e[2]=e[4]=0,e[1]=TILE_DIMENSIONS[0]*ROOT_SPACING[0],e[3]=TILE_DIMENSIONS[1]*ROOT_SPACING[1],e[5]=NUMBER_OF_SECTIONS*ROOT_SPACING[2],this.SetFocalPoint([(e[0]+e[1])*.5,(e[2]+e[3])*.5]),this.SetHeight(e[3]-e[2]),this.ComputeMatrix()},e.prototype.DisplayToWorld=function(e,t,n){var r=this.Height/this.ViewportHeight;e-=.5*this.ViewportWidth,t-=.5*this.ViewportHeight;var i=[];return i[0]=this.FocalPoint[0]+e*r,i[1]=this.FocalPoint[1]+t*r,i[2]=10+n*this.Height*.5,i},e.prototype.AddPoint=function(e,t,n){this.Points.push(e),this.Points.push(t),this.Points.push(n)},e.prototype.CreateBuffer=function(e){e&&(this.Buffer!=null&&e.deleteBuffer(this.Buffer),this.Buffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.Buffer),e.bufferData(e.ARRAY_BUFFER,new Float32Array(this.Points),e.STATIC_DRAW))},e.prototype.UpdateBuffer=function(){this.Points=[];var e=this.FocalPoint[0],t=this.FocalPoint[1],n=this.GetWidth()*.5,r=this.GetHeight()*.5;this.AddPoint(e-n,t-r),this.AddPoint(e+n,t-r),this.AddPoint(e+n,t+r),this.AddPoint(e-n,t+r),this.AddPoint(e-n,t-r),this.CreateBuffer()},e.prototype.Draw=function(e,t){var n=e.Camera,r=e.Viewport,i=this.FocalPoint[0],s=this.FocalPoint[1],o=this.GetWidth()*.5,u=this.GetHeight()*.5,a=(i*n.Matrix[0]+s*n.Matrix[4]+n.Matrix[12])/n.Matrix[15],f=(i*n.Matrix[1]+s*n.Matrix[5]+n.Matrix[13])/n.Matrix[15];if(!t){a=(1+a)*r[2]*.5,f=(1-f)*r[3]*.5,o=o*r[3]/n.GetHeight(),u=u*r[3]/n.GetHeight();var l=e.Context2d;l.save();var c=Math.cos(this.Roll),h=Math.sin(this.Roll);l.setTransform(c,-h,+h,c,(1-c)*a-h*f,(1-c)*f+h*a),l.strokeStyle="#4011E5",l.beginPath(),l.rect(a-o,f-u,2*o,2*u),l.stroke(),l.restore()}},SAM.Camera=e}();(function(){"use strict";var e;SA.DownloadImageData=function(e,t){var n=e.width,r=e.height,i=[0,0,n,r],s=new SA.TileView;s.InitializeViewport(i,1,!0),s.Canvas.attr("width",n),s.Canvas.attr("height",r),s.Context2d.putImageData(e,0,0),s.Canvas[0].toBlob(function(e){saveAs(e,t)},"image/png")},SA.GetCutoutImage=function(t,n,r,i,s,o,u){var a=n[0],f=n[1],l=[0,0,a,f],c=new SA.TileView;e=c,c.SetCache(t),c.SetViewport(l);var h=c.Camera;h.SetFocalPoint(r),h.SetRoll(s),h.SetHeight(f*i),h.ComputeMatrix();var p=t.ChooseTiles(h,0,[]);for(var d=0;d<p.length;++d)SA.LoadQueueAddTile(p[d]);SA.AddFinishedLoadingCallback(function(){SA.GetCutoutImage2(c,o,u)}),SA.LoadQueueUpdate(),console.log("trigger "+SA.LoadQueue.length+" "+SA.LoadingCount)},SA.GetCutoutImage2=function(e,t,n){e.DrawTiles();var r=e.GetViewport();t&&t!=""&&e.Canvas[0].toBlob(function(e){saveAs(e,t)},"image/png");if(n){var i=e.Context2d,s=e.GetImageData();n(s)}};var t=function(e,t,n){n||(n=e.bounds),this.ImageData=e,this.Height=t,this.Width=Math.ceil(t*(n[1]-n[0])/(n[3]-n[2])),this.Div=$("<div>").css({width:this.Width+"px",height:this.Height+"px"}).addClass("sa-view-cutout-thumb-div");var r;if(e.bounds)var r=[Math.max(n[0],e.bounds[0]),Math.min(n[1],e.bounds[1]),Math.max(n[2],e.bounds[2]),Math.min(n[3],e.bounds[3])];else r=[Math.max(n[0],0),n[1],Math.max(n[2],0),n[3]];var i=256;e.tile_size&&(i=e.tile_size),this.Level=0;while(r[3]-r[2]>this.Height&&this.Level<e.levels-1)this.Level+=1,r[0]*=.5,r[1]*=.5,r[2]*=.5,r[3]*=.5;var i=256;e.tile_size&&(i=e.tile_size),this.ScreenPixelSpacing=(n[3]-n[2])/this.Height;var s=(i<<this.Level)/this.ScreenPixelSpacing;this.GridReq=[Math.floor(r[0]/i),Math.floor(r[1]/i),Math.floor(r[2]/i),Math.floor(r[3]/i)],this.ScreenPixelOrigin=[this.GridReq[0]*(i<<this.Level),this.GridReq[2]*(i<<this.Level)];for(var o=this.GridReq[2];o<=this.GridReq[3];++o)for(var u=this.GridReq[0];u<=this.GridReq[1];++u){var a=u,f=o,l=this.Level,c="";while(l<e.levels-1)(a&1)==0&&(f&1)==0&&(c="q"+c),(a&1)==1&&(f&1)==0&&(c="r"+c),(a&1)==0&&(f&1)==1&&(c="t"+c),(a&1)==1&&(f&1)==1&&(c="s"+c),a>>=1,f>>=1,++l;var h=((u<<this.Level)*i-n[0])/this.ScreenPixelSpacing,p=((o<<this.Level)*i-n[2])/this.ScreenPixelSpacing,d=$("<img>").appendTo(this.Div).attr("width",s).attr("height",s).attr("src","/tile?img="+e.img+"&db="+e.db+"&name=t"+c+".jpg").attr("alt",e.label).css({left:h.toString()+"px",top:p.toString()+"px"}).addClass("sa-view-cutout-thumb-tile")}};t.prototype.AppendTo=function(e){return this.Div.appendTo(e),this},t.prototype.Click=function(e){var t=this;return this.ClickCallback=e,this.Div.click(function(e){var n=e.pageX,r=e.pageY,i=t.Div.offset();n-=i.left,r-=i.top,console.log("click: "+n+", "+r),t.SlideX=n*t.ScreenPixelSpacing+t.ScreenPixelOrigin[0],t.SlideY=r*t.ScreenPixelSpacing+t.ScreenPixelOrigin[1],t.ClickCallback(t)}),this},SA.CutoutThumb=t})();(function(){"use strict";function e(e,t,n,r,i){if(t<0||t>=e.width||n<0||n>=e.height)return 0;var s=4*(t+n*e.width);return i?r-(e.data[s]+e.data[s+1]+e.data[s+2]):e.data[s]+e.data[s+1]+e.data[s+2]-r}function t(t,n,r,i){var s=r,o=i;if(s<0||s>=t.width||o<0||o>=t.height){alert("Seed outside viewport");return}var u,a,f,l,c,h,p,d,v,m;p=1,d=0,v=-d,m=p;var g=!1;a=e(t,s,o,n,g);if(a==0){alert("Seed point on threshold.");return}a<0&&(g=!0,a=-a);while(a>0)c=s,h=o,u=a,s=c+p,o=h+d,a=e(t,s,o,n,g);var y=u/(u-a),b=[[c+p*y,h+d*y]];r=c,i=h;for(;;){f=e(t,c+v,h+m,n,g),f>0?(l=e(t,s+v,o+m,n,g),l>0?(y=a/(a-l),b.push([s+v*y,o+m*y]),u=l,c=s+v,h=o+m,p=-v,d=-m,v=-d,m=p):(y=f/(f-l),b.push([c+v+p*y,h+m+d*y]),u=f,c+=v,h+=m,a=l,s+=v,o+=m)):(y=u/(u-f),b.push([c+v*y,h+m*y]),a=f,s=c+v,o=h+m,p=v,d=m,v=-d,m=p);if(c==r&&h==i&&p==1)return b}}function n(n,r,i,s){if(i<0||i>=n.width||s<0||s>=n.height){alert("Seed outside viewport");return}var o=!1,u=e(n,i,s,r,o);console.log("seed value : "+(u+r));if(u==0){alert("Seed point on threshold.");return}u<0&&(o=!0,u=-u);var a,f,l=i;for(;;){a=l,l=a+1,f=u,u=e(n,l,s,r,o);if(f>0&&u<=0){var c=t(n,r,a,s),h=c[0][0],p=c[0][1],d=[h,h,p,p];for(var v=1;v<c.length;++v){var h=c[v][0],p=c[v][1];d[0]>h&&(d[0]=h),d[1]<h&&(d[1]=h),d[2]>p&&(d[2]=p),d[3]<p&&(d[3]=p)}if(d[0]<i&&i<d[1]&&d[2]<s&&s<d[3])return c}}}function r(e,t){var r=e.LastMouseX,i=e.LastMouseY,s=e.MainView.Context2d,o=e.GetViewport(),u=s.getImageData(0,0,o[2],o[3]),a=n(u,t*3,r,i),f=[];for(var l=0;l<a.length;++l){var c=a[l];f.push(e.ConvertPointViewerToWorld(c[0],c[1]))}var h=new SAM.PolylineWidget(e,!1);h.Shape.Points=f,h.Shape.Closed=!0,h.LineWidth=0,h.Shape.UpdateBuffers(this.Layer.AnnotationView),eventuallyRender()}})();(function(){"use strict";function e(e,t){var n=t.GetCenter(),r,i=!1,s=[n[0],n[0],n[1],n[1]];for(var o=0;o<e.length;++o)if(e[o]!=t){match=e[o].GetArea()/t.GetArea();if(match<1.2&&match>.8){var u=e[o].GetCenter();u[0]<s[0]&&(s[0]=u[0]),u[0]>s[1]&&(s[1]=u[0]),u[1]<s[2]&&(s[2]=u[1]),u[1]>s[3]&&(s[3]=u[1]),u[0]-=n[0],u[1]-=n[1];var a=u[0]*u[0]+u[1]*u[1];if(!i||a<r)r=a,i=e[o]}}var f=i.GetCenter();f[0]-=n[0],f[1]-=n[1];var l=1;Math.abs(f[0])>Math.abs(f[1])&&(l=0);var c=Math.sign(f[l]),h=l?0:1,p=Math.sign(s[2*h]+s[2*h+1]-2*n[h]);e.splice(e.indexOf(t),1),e.splice(e.indexOf(i),1);var d=[t,i],v=i,m=v.GetBounds();SA.PermuteBounds(m,l,c),SA.PermuteBounds(m,h,p);var g=!1;for(;;){var y=-1;for(var o=0;o<e.length;++o){var s=e[o].GetBounds();SA.PermuteBounds(s,l,c),SA.PermuteBounds(s,h,p);if(s[(h<<1)+1]>m[h<<1]&&(s[h<<1]>m[(h<<1)+1]||s[l<<1]>m[(l<<1)+1])){var b=e[o].GetArea()/v.GetArea();b>.9&&b<1.1&&(y<0?(y=o,g=s):s[h<<2]<g[h<<1]?(y=o,g=s):s[h<<1]<g[(h<<1)+1]&&s[(l<<1)+1]<g[l<<1]&&(y=o,g=s))}}if(y==-1)return d;console.log(y),v=e.splice(y,1)[0],d.push(v),m=g}}function t(e,t,n){function u(e,i){var o=e.GetBounds();SA.PermuteBounds(o,t,r),SA.PermuteBounds(o,n,s);var u=i.GetBounds();return SA.PermuteBounds(u,t,r),SA.PermuteBounds(u,n,s),u[(n<<1)+1]>o[n<<1]&&(u[n<<1]>o[(n<<1)+1]||u[t<<1]>o[(t<<1)+1])?!0:!1}var r=t[0]=="-"?-1:1,s=n[0]=="-"?-1:1,t=t[1]=="x"?0:1,n=n[1]=="x"?0:1,o=e.slice(0),a=0;while(o.length>0){var f=null,l=-1;for(i=0;i<o.length;++i)if(l<0||u(o[i],f))l=i,f=o[i];e[a++]=f,o.splice(l,1)}}function n(){this.Points=[],this.World=!1,this.Bounds=undefined,this.Area=undefined,this.Camera=undefined}function r(e){var t=e.GetViewport(),n=t[0],r=t[1],i=t[2],s=t[3],o=e.MainView.Context2d;this.Viewer=e,this.Context=o,this.Data=e.MainView.GetImageData();var u=e.MainView.GetImageData();d(u,1);var a=0;while(a<u.data.length){var f=(u.data[a++]+u.data[a++]+u.data[a++])/3;this.Data.data[a++]=Math.round(f)}d(u,4);var a=0,l=128,c=128;while(a<u.data.length){var f=(u.data[a++]+u.data[a++]+u.data[a++])/3;f=2*(this.Data.data[a]-f)+128,l=Math.min(l,f),c=Math.max(c,f),f=Math.min(f,255),f=Math.max(f,0),this.Data.data[a++]=Math.round(f)}console.log("center surround range "+l+", "+c),this.Canvas=document.createElement("canvas"),this.CanvasContext=this.Canvas.getContext("2d"),this.Canvas.width=i,this.Canvas.height=s,this.Mask=this.CanvasContext.createImageData(i,s);for(var h=0;h<this.Mask.data.length;++h)this.Mask.data[h]=this.Data.data[h];this.ImageAnnotation=new SAM.ImageAnnotation,this.ImageAnnotation.Image=document.createElement("img"),this.ImageAnnotation.Image.src=this.Canvas.toDataURL("image/png");var p=e.GetCamera(),i=p.GetWidth();this.ImageAnnotation.Origin=[p.FocalPoint[0]-i/2,p.FocalPoint[1]-p.Height/2],this.ImageAnnotation.Height=p.Height,e.AddShape(this.ImageAnnotation),this.PositiveSpheres=[],this.NegativePoints=[],this.MaskViewport=t.slice(0),this.MaskMatrix=mat4.create(e.MainView.Camera.Matrix)}function o(e){if(e.which==1){var t=s.Viewer.ConvertPointViewerToWorld(e.clientX,e.clientY);s.AddPositive(t),s.Update(),s.Draw(),console.log("Positive")}if(e.which==3){var t=s.Viewer.ConvertPointViewerToWorld(e.clientX,e.clientY);s.AddNegative(t),s.Update(),s.Draw(),console.log("Negative")}}function u(){window.SA&&(s===undefined&&(s=new r(SA.VIEWERS[0])),SA.VIEWERS[0].MainView.Canvas.mouseup(function(){o(event)}))}function a(e,t,n,r){this.Symetric=!1,this.Axis=0,this.Height=r,this.Width=n,this.Div=$("<div>").appendTo("body").addClass("sa-view-align-histogram-div"),this.Canvas=$("<canvas>").appendTo(this.Div).addClass("sa-view-align-histogram-canvas"),this.Context=this.Canvas[0].getContext("2d"),this.SetSize(e,t,n,r)}function f(){this.PointCoordinates=[],this.TrianglePointIds=[],this.Points=[],this.Edges=[],this.Triangles=[]}function l(e){this.StartIdx=0,this.EndIdx=0,this.Allocate(e)}function c(e,t){this.Bounds=e,this.Spacing=t,this.Dimensions=[Math.ceil((e[1]-e[0])/t),Math.ceil((e[3]-e[2])/t)];var n=this.Dimensions[0]*this.Dimensions[1];n>1e6&&SA.Debug("Warning: Distance map memory requirement is large."),this.Map=new Array(n);for(var r=0;r<n;++r)this.Map[r]=n;this.Queue=null}function h(e,t,n,r,i,s,o){var u=(e.GetIntensity(t,n)-s)*o,a=(e.GetIntensity(r,i)-s)*o;if(u>0&&a>0||u<=0&&a<=0)return!1;if(u>0){var f=r;r=t,t=f,f=i,i=n,n=f,f=a,a=u,u=f}if(e.MarkEdge(t,n,r,i))return!1;var l,c,h,p,d,v,m,g,y,b;m=r-t,g=i-n,y=-g,b=m;var w=u/(u-a),E=[[t+m*w+.5,n+g*w+.5]],S=t,x=n,T=m,N=g;for(;;){l=t+y,c=n+b;if(!e.InBounds(l,c))return E;p=r+y,d=i+b,h=(e.GetIntensity(l,c)-s)*o;if(h>0){if(e.MarkEdge(l,c,t,n))return E;w=u/(u-h),E.push([t+y*w+.5,n+b*w+.5]),a=h,r=l,i=c,m=y,g=b,y=-g,b=m}else{v=(e.GetIntensity(p,d)-s)*o;if(v>0){if(e.MarkEdge(p,d,l,c))return E;w=h/(h-v),E.push([t+y+m*w+.5,n+b+g*w+.5]),u=h,t=l,n=c,a=v,r=p,i=d}else{if(e.MarkEdge(r,i,p,d))return E;w=a/(a-v),E.push([r+y*w+.5,i+b*w+.5]),u=v,t=p,n=d,m=-y,g=-b,y=-g,b=m}}if(e.MarkEdge(t,n,r,i))return E}}function p(e,t){var r,i,s,o=0;for(var u=1;u<e.height;++u)for(var a=1;a<e.width;++a){var f=SA.SeedIsoContour(e,a,u,a-1,u,t);f&&(r=new n,r.Camera=e.Camera,r.SetPoints(f),i=Math.abs(r.GetArea()),i>o&&(o=i,s=r));var l=SA.SeedIsoContour(e,a,u,a,u-1,t);l&&(r=new n,r.Camera=e.Camera,r.SetPoints(l),i=Math.abs(r.GetArea()),i>o&&(o=i,s=r))}return s}function d(e,t){if(t<1)return;var n=2*t+1,r=new Array(n),i=new Array(n+1);i[0]=0;for(var s=-t,o=0;s<=t;++s,++o)t==0?r[o]=1:r[o]=Math.exp(-s*s/(t*t)),i[o+1]=i[o]+r[o];var u=i[r.length];for(var s=0;s<r.length;++s)r[s]/=u,i[s+1]/=u;var a=new Array(e.data.length),f=0;for(var l=0;l<e.height;++l){var c=l*e.width*4;for(var h=0;h<e.width;++h){var p=Math.max(t-h,0),d=Math.min(t-h+e.width,n),v=c+(h-t+p)*4,m=0,g=0,y=0,b=0;for(var w=v,E=p;E<d;++E)m+=r[E]*e.data[w++],g+=r[E]*e.data[w++],y+=r[E]*e.data[w++],b+=r[E]*e.data[w++];if(h<t||e.width-h<=t)m/=i[d]-i[p],g/=i[d]-i[p],y/=i[d]-i[p],b/=i[d]-i[p];a[f++]=m,a[f++]=g,a[f++]=y,a[f++]=b}}for(var s=0;s<a.length;++s)e.data[s]=a[s];f=0;for(var l=0;l<e.height;++l){var c=l*e.width*4,p=Math.max(t-l,0),d=Math.min(t-l+e.height,n),S=c-(t-p)*e.width*4,x=l<t||e.height-l<=t;for(var h=0;h<e.width;++h,S+=4){var m=0,g=0,y=0,b=0;for(var T=S,E=p;E<d;++E)m+=r[E]*a[T],g+=r[E]*a[T+1],y+=r[E]*a[T+2],b+=r[E]*a[T+3],T+=e.width*4;x&&(m/=i[d]-i[p],g/=i[d]-i[p],y/=i[d]-i[p],b/=i[d]-i[p]),e.data[f++]=m,e.data[f++]=g,e.data[f++]=y,e.data[f++]=b}}}function v(e){var t=0,n=0,r=0,i=0;for(var s=0;s<e.data.length;){var o=e.data[s++],u=e.data[s++],a=e.data[s++],f=e.data[s++];i+=f,t+=o*f,n+=u*f,r+=a*f}t/=i,n/=i,r/=i;var l=0,c=0,h=0,p=0,d=0,v=0;for(var s=0;s<e.data.length;){var o=e.data[s++]-t,u=e.data[s++]-n,a=e.data[s++]-r,f=e.data[s++];l+=o*o*f,c+=a*a*f,h+=u*u*f,p+=o*a*f,d+=o*u*f,v+=u*a*f}l/=i,c/=i,h/=i,d/=i,p/=i,v/=i;var m=[1,1,1],g=Math.sqrt(m[0]*m[0]+m[1]*m[1]+m[2]*m[2]),y=0;for(var s=0;s<10;++s){var o=m[0]*l+m[1]*d+m[2]*p,u=m[0]*d+m[1]*h+m[2]*v,a=m[0]*p+m[1]*v+m[2]*c,b=Math.sqrt(o*o+u*u+a*a);y=b/g,g=1,m=[o/b,u/b,a/b]}return console.log("val = "+Math.sqrt(y)+", v=("+m[0]+", "+m[1]+", "+m[2]+"), ave=("+t+", "+n+", "+r+")"),{val:y,v:m,ave:[t,n,r]}}function m(e){pc=ComputePrincipleComponent(e),pc.val=Math.sqrt(pc.val);var t=0,n=0,r=0;for(var i=0;i<e.data.length;i+=4){var s=e.data[i],o=e.data[i+1],u=e.data[i+2];s-=pc.ave[0],o-=pc.ave[1],u-=pc.ave[2];var a=s*pc.v[0]+o*pc.v[1]+u*pc.v[2];s=Math.round(pc.ave[0]+a*pc.v[0]),o=Math.round(pc.ave[1]+a*pc.v[1]),u=Math.round(pc.ave[2]+a*pc.v[2]),s=Math.min(s,255),o=Math.min(o,255),u=Math.min(u,255),s=Math.max(s,0),o=Math.max(o,0),u=Math.max(u,0),e.data[i]=s,e.data[i+1]=o,e.data[i+2]=u}}function g(e){var t=e.Points,n=[t[0][0],t[0][0],t[0][1],t[0][1]];for(var r=0;r<t.length;++r)t[r][0]<n[0]&&(n[0]=t[r][0]),t[r][0]>n[1]&&(n[1]=t[r][0]),t[r][1]<n[2]&&(n[2]=t[r][1]),t[r][1]>n[3]&&(n[3]=t[r][1]);return n}function y(e,t,n,r){var i=new Array(256);for(var s=0;s<256;++s)i[s]=0;for(var s=1;s<e.length-1;++s){var o=[e[s-1][0]-e[s][0],e[s-1][1]-e[s][1]],u=[e[s+1][0]-e[s][0],e[s+1][1]-e[s][1]],a=Math.sqrt(o[0]*o[0]+o[1]*o[1]),f=Math.sqrt(u[0]*u[0]+u[1]*u[1]);if(a>0&&f>0){var l=(o[0]*u[1]-o[1]*u[0])/(a*f),c=Math.floor((e[s][r]-t)*256/(n-t));c>=0&&c<256&&(i[c]+=l)}}return i}function b(e,t){var n=0,r=0;for(var i=-200;i<=200;++i){var s=0,o=Math.max(0,-i),u=Math.min(256,256-i);for(var a=o;a<u;++a)s+=e[a]*t[a+i];s>n&&(n=s,r=i)}return r}function E(e,t){var n=g(e),r=g(t);n[0]=Math.min(n[0],r[0]),n[1]=Math.max(n[1],r[1]),n[2]=Math.min(n[2],r[2]),n[3]=Math.max(n[3],r[3]),w?(w.Clear(),w.SetSize(20,n[2],100,n[3]-n[2])):(w=new a(20,n[2],100,n[3]-n[2]),w.Axis=1,w.Symmetrc=!0),MakeContourPolyline(e,SA.VIEWERS[0]),MakeContourPolyline(t,SA.VIEWERS[1]);var i=y(e,n[0],n[1],0),s=y(t,n[0],n[1],0),o=b(i,s)*(n[1]-n[0])/256;i=y(e,n[2],n[3],1),s=y(t,n[2],n[3],1),w.Draw(i,"green"),w.Draw(s,"red");var u=b(i,s)*(n[3]-n[2])/256;return[o,u]}function S(e,t){var n=g(e),r=g(t);n[0]=Math.min(n[0],r[0]),n[1]=Math.max(n[1],r[1]),n[2]=Math.min(n[2],r[2]),n[3]=Math.max(n[3],r[3]);var i=(n[0]+n[1])*.5,s=(n[2]+n[3])*.5;n[0]=i+1.1*(n[0]-i),n[1]=i+1.1*(n[1]-i),n[2]=s+1.1*(n[2]-s),n[3]=s+1.1*(n[3]-s);var o=new SA.DistanceMap(n,2);o.AddContour(e),o.Update();var u=0,a=0;for(var f=0;f<100;++f){var l=0,c=0,h=0;for(var p=0;p<t.length;++p){var d=t[p][0]-u,v=t[p][1]-a,m=o.GetGradient(d,v);l+=m[0],c+=m[1],h+=o.GetDistance(d,v)}h/=t.length,h<1&&(h=1);var y=Math.abs(l)+Math.abs(c);y>h&&(l=l*h/y,c=c*h/y),u+=l,a+=c}var b={delta:[u,a]};return b}function x(e,t,n){var r=e.GetCenter(),i=t.GetCenter();t.Translate([r[0]-i[0],r[1]-i[1]]);var s=e.GetBounds(),o=t.GetBounds();s[0]=Math.min(s[0],o[0]),s[1]=Math.max(s[1],o[1]),s[2]=Math.min(s[2],o[2]),s[3]=Math.max(s[3],o[3]);var u=(s[0]+s[1])*.5,a=(s[2]+s[3])*.5;s[0]=u+1.1*(s[0]-u),s[1]=u+1.1*(s[1]-u),s[2]=a+1.1*(s[2]-a),s[3]=a+1.1*(s[3]-a);var f=Math.sqrt((s[1]-s[0])*(s[3]-s[2])/1e5),l=new SA.DistanceMap(s,f);l.AddContour(e),l.Update(),T(t,l),n||L(t,l)}function T(e,t){var n=e.GetCenter(),r=n[0],i=n[1],s=r,o=i,u=0;for(var a=0;a<200;++a){var f=0,l=0,c=0,h=0,p=0;for(var d=0;d<e.Length();++d){var v=e.GetPoint(d)[0],m=e.GetPoint(d)[1],g=t.GetGradient(v,m);f+=g[0],l+=g[1],c+=t.GetDistance(v,m);var y=v-r,b=m-i,w=y*g[1]-b*g[0];h+=w,p+=Math.sqrt(y*y+b*b)}c/=e.Length(),c<1&&(c=1);var E=Math.abs(f)+Math.abs(l);E>c&&(f=f*c/E,l=l*c/E),h/=p*100,e.Transform([-f,-l],[r,i],h),r-=f,i-=l,u+=h}var S=e.GetCenter();return console.log("2: "+(n[0]-S[0])+", "+(n[1]-S[1])),{delta:[r-s,i-o],roll:u,c0:[s,o],c1:[r,i]}}function L(e,t){var n=new f;e.GetArea()<0&&e.Points.reverse(),n.TriangulateContour(e),n.CreateFullMesh();while(n.ConditionEdgeRotate());n.Update(),D=new f,D.DeepCopy(n);var r=n.PointCoordinates.length/2,i=new Array(r);for(var s=0;s<N;++s){var o=0;for(var u=0;u<r;++u){var a=n.GetPointCoordinates(u),l=t.GetGradient(a[0],a[1]);n.PointCoordinates[o]-=l[0]*k,n.PointCoordinates[o+1]-=l[1]*k,i[o]=0,i[o+1]=0,o+=2}for(var u=0;u<n.Edges.length;++u){var c=n.Edges[u];if(c===undefined)continue;var h=n.GetPointCoordinates(c.vert0),p=n.GetPointCoordinates(c.vert1),d=p[0]-h[0],v=p[1]-h[1],m=Math.sqrt(d*d+v*v),g=C*(m-c.length)/(2*m);o=c.vert0<<1,i[o++]+=d*g,i[o]+=v*g,o=c.vert1<<1,i[o++]-=d*g,i[o]-=v*g}var o=0;for(var u=0;u<r;++u)n.PointCoordinates[o]+=i[o++],n.PointCoordinates[o]+=i[o++]}var o=0;for(var y=0;y<e.Length();++y)e.SetPoint(y,[n.PointCoordinates[o++],n.PointCoordinates[o++]]);n.Update(),_=n}function H(){_.ConvertPointsToWorld(SA.VIEWERS[0]),SA.VIEWERS[0].AddShape(_),D.ConvertPointsToWorld(SA.VIEWERS[1]),SA.VIEWERS[1].AddShape(D)}function j(e){var t=SA.VIEWERS[0],n=t.GetCamera().GetBounds(),r=SA.VIEWERS[1],i=r.GetCamera().GetBounds();for(var s=0;s<t.WidgetList.length;++s){var o=t.WidgetList[s];if(o instanceof PolylineWidget&&o.Shape.Points.length>0){var u=o.Shape.GetBounds(),a=[(u[0]+u[1])*.5,(u[2]+u[3])*.5],f=t.ConvertPointWorldToViewer(a[0],a[1]);if(a[0]<n[0]||a[0]>n[1]||a[1]<n[2]||a[1]>n[3])continue;var l=o.Shape.OutlineColor,c=null,h=1e7;for(var p=0;p<r.WidgetList.length;++p){var d=r.WidgetList[p];if(d instanceof PolylineWidget&&d.Shape.Points.length>0){var v=d.Shape.OutlineColor;if(Math.abs(l[0]-v[0])<.01&&Math.abs(l[1]-v[1])<.01&&Math.abs(l[2]-v[2])<.01){var m=d.Shape.GetBounds(),g=[(m[0]+m[1])*.5,(m[2]+m[3])*.5],y=r.ConvertPointWorldToViewer(g[0],g[1]);if(g[0]<i[0]||g[0]>i[1]||g[1]<i[2]||g[1]>i[3])continue;var b=(y[0]-f[0])*(y[0]-f[0])+(y[1]-f[1])*(y[1]-f[1]);if(!c||h<b)h=b,c=d}}}h<1e5&&U(o,c,e)}}}function F(e){e[0]=e[0]/255,e[1]=e[1]/255,e[2]=e[2]/255;for(var t=0;t<2;++t){var n=SA.VIEWERS[t],r=[];for(var i=0;i<n.WidgetList.length;++i){var s=n.WidgetList[i];if(s instanceof PolylineWidget){var o=s.Shape.OutlineColor;Math.abs(o[0]-e[0])<.05&&Math.abs(o[1]-e[1])<.05&&Math.abs(o[2]-e[2])<.05&&r.push(s)}}n.WidgetList=r}var u=SA.display.GetNote();while(u.Parent)u=u.Parent;for(var t=0;t<u.ViewerRecords.length;++t){var a=u.ViewerRecords[t],r=[];for(var f=0;f<a.Annotations.length;++f){var l=a.Annotations[f],c=l.outlinecolor;Math.abs(c[0]-e[0])<.05&&Math.abs(c[1]-e[1])<.05&&Math.abs(c[2]-e[2])<.05&&r.push(l)}a.Annotations=r}eventuallyRender()}function I(e,t){e[0]=e[0]/255,e[1]=e[1]/255,e[2]=e[2]/255;var n=SA.VIEWERS[0],r=n.GetCamera().GetBounds(),i=null,s=0;for(var o=0;o<n.WidgetList.length;++o){var u=n.WidgetList[o];if(u instanceof PolylineWidget&&u.Shape.Points.length>0){var a=u.Shape.GetBounds(),f=[(a[0]+a[1])*.5,(a[2]+a[3])*.5];if(f[0]<r[0]||f[0]>r[1]||f[1]<r[2]||f[1]>r[3])continue;var l=u.Shape.OutlineColor;Math.abs(l[0]-e[0])<.05&&Math.abs(l[1]-e[1])<.05&&Math.abs(l[2]-e[2])<.05&&(++s,i=u)}}if(s!=1)return;var c=SA.VIEWERS[1],h=c.GetCamera().GetBounds(),p=null,d=0;for(var v=0;v<c.WidgetList.length;++v){var m=c.WidgetList[v];if(m instanceof PolylineWidget&&u.Shape.Points.length>0){var g=m.Shape.GetBounds(),y=[(g[0]+g[1])*.5,(g[2]+g[3])*.5];if(y[0]<h[0]||y[0]>h[1]||y[1]<h[2]||y[1]>h[3])continue;var b=m.Shape.OutlineColor;Math.abs(b[0]-e[0])<.05&&Math.abs(b[1]-e[1])<.05&&Math.abs(b[2]-e[2])<.05&&(++d,p=m)}}if(d!=1)return;U(i,p,t)}function R(e){e[0]=e[0]/255,e[1]=e[1]/255,e[2]=e[2]/255;var t=SA.VIEWERS[0],n=t.GetCamera().GetBounds();for(var r=0;r<t.WidgetList.length;++r){var i=t.WidgetList[r];if(i instanceof PolylineWidget&&i.Shape.Points.length>0){var s=i.Shape.GetBounds(),o=[(s[0]+s[1])*.5,(s[2]+s[3])*.5],u=i.Shape.OutlineColor;if(o[0]<n[0]||o[0]>n[1]||o[1]<n[2]||o[1]>n[3])continue;if(Math.abs(u[0]-e[0])<.05&&Math.abs(u[1]-e[1])<.05&&Math.abs(u[2]-e[2])<.05){var a=i.ComputeArea();q+=a,console.log(a)}}}}function U(e,t,r){var i=SA.display.GetNote(),s=i.ViewerRecords[i.StartIndex+1].Transform;if(!s)return;var o=new n;o.World=!0,o.SetPoints(e.Shape.Points),o.Camera=SA.VIEWER1.GetCamera(),o.WorldToViewer(),o.Resample(1);var u=new n;u.World=!0,u.SetPoints(t.Shape.Points),u.Camera=SA.VIEWER2.GetCamera(),u.WorldToViewer(),u.Resample(1);if(o.Points.length==0||u.Points.length==0)return;var a=new n;a.DeepCopy(u),x(o,u,!0),A=o,O=a,M=u,P=s;if(r){var f=SA.VIEWERS[0].GetCamera(),l=f.GetBounds(),c=0;while(c<s.Correlations.length){var h=s.Correlations[c];h.point0[0]>l[0]&&h.point0[0]<l[1]&&h.point0[1]>l[2]&&h.point0[1]<l[3]?s.Correlations.splice(c,1):++c}}P=s;var p=10,d=Math.ceil(u.Length()/p);for(var v=2;v<a.Length();v+=d){var m=u.GetPoint(v);o.Camera&&(m=o.Camera.ConvertPointViewerToWorld(m[0],m[1]));var g=a.GetPoint(v);u.Camera&&(g=u.Camera.ConvertPointViewerToWorld(g[0],g[1]));var h=new SA.PairCorrelation;h.SetPoint0(m),h.SetPoint1(g),s.Correlations.push(h)}console.log("Finished alignment"),SA.display.SynchronizeViews(0,i),eventuallyRender()}function z(e,t){var n=e.length,r=0,s=0;for(i=0;i<n;++i){var o=0;for(j1=0;j1<n;++j1){var u=i+j1;u>=n&&(u-=n),o+=e[j1]*t[u]}o>r&&(r=o,s=i)}return s}function W(e){var t=new Array(e.length-1);for(var n=1;n<e.length;++n)t[n-1]=e[n]-e[n-1];return t}function X(e){var t=new Array(e.length),n=0;for(var r=0;r<e.length;++r)n+=e[r],t[r]=n;return t}function V(e,t){var n=-1,r=-1,i=X(e),s=i[i.length-1];for(var o=t;o<e.length-10;++o){var u=0,a=i[o]/s;a>.1&&a<.9&&(u=1/(e[o]+1),u*=Math.exp(o/8)),u>n&&(n=u,r=o)}return r}function J(e,t,n){var r=-1,i=-1,s=X(e),n=s[s.length-1];for(var o=val;o<e.length-10;++o){var u=0,a=s[o]/n;a>.1&&a<.9&&(u=1/(e[o]+1),u*=Math.exp(o/8)),u>r&&(r=u,i=o)}return i}function K(e,t,n){n==undefined&&(n=!0);var r=0,i=0,s=0,o=0;for(var u=0;u<e.height;++u)for(var a=0;a<e.width;++a){var f=Math.floor((e.data[o]+e.data[o+1]+e.data[o+2])/3);f>t==n?(e.data[o]=e.data[o+1]=e.data[o+2]=0,e.data[o+3]=255):(++s,r+=a,i+=u,e.data[o+3]=0),o+=4}e.mid_x=r/s,e.mid_y=i/s}function Q(e,t){var n=e.MainView.Context2d;n.putImageData(t,0,0)}function Y(e,t,n,r){G||(G=new a("50%","50%",400,200)),G.Clear();var i=e.MainView.GetImageData(),s=SA.ComputeIntensityHistogram(i);G.Draw(s,t,n,r);var o=X(s);G.Draw(o,"red",n,r)}function Z(e){var t=SA.VIEWERS[0].MainView.GetImageData();d(t,e),Q(SA.VIEWERS[0],t)}function et(){var e=SA.VIEWERS[0].MainView.GetImageData();d(e,2);var t=SA.ComputeIntensityHistogram(e),n=SA.PickThreshold(t);K(e,n),m(e),Q(SA.VIEWERS[1],e)}function tt(){var e=SA.VIEWERS[0].MainView.GetImageData(),t=SA.ComputeIntensityHistogram(e),n=SA.PickThreshold(t);K(e,n);var r=SA.VIEWERS[1].MainView.GetImageData(),i=SA.ComputeIntensityHistogram(r),s=SA.PickThreshold(i);K(r,s);var o=r.mid_x-e.mid_x,u=r.mid_y-e.mid_y,a=SA.VIEWERS[0].GetCamera(),f=SA.VIEWERS[0].GetViewport();o=o*a.Height/f[3],u=u*a.Height/f[3],SA.VIEWERS[0].AnimateTranslate(-o/2,-u/2),SA.VIEWERS[1].AnimateTranslate(o/2,u/2),console.log("Translate = ("+o+", "+u+")")}function nt(e){var t=SA.VIEWERS[0],n=t.MainView.GetImageData();d(n,2);var r=SA.ComputeIntensityHistogram(n,!0),i=SA.PickThreshold(r),s=p(n,i),o=SA.VIEWERS[1],u=o.MainView.GetImageData();d(u,2);var a=SA.ComputeIntensityHistogram(u,!0),f=SA.PickThreshold(a),l=p(u,f),c=S(s,l);e&&(s=DecimateContour(s,1),TranslateContour(l,[-c.delta[0],-c.delta[1]]),l=DecimateContour(l,1),MakeContourPolyline(s,SA.VIEWERS[0]),MakeContourPolyline(l,SA.VIEWERS[0]));var h=SA.VIEWERS[0].GetCamera(),v=SA.VIEWERS[0].GetViewport(),m=c.delta[0]*h.Height/v[3],g=c.delta[1]*h.Height/v[3];SA.VIEWERS[0].AnimateTranslate(-m/2,-g/2),SA.VIEWERS[1].AnimateTranslate(m/2,g/2),console.log("Translate = ("+m+", "+g+")")}function rt(){var e=SA.VIEWERS[0],t=e.MainView.GetImageData();d(t,5);var n=SA.ComputeIntensityHistogram(t,!0),r=SA.PickThreshold(n),i=p(t,r),s=SA.VIEWERS[1],o=s.MainView.GetImageData();d(o,5);var u=SA.ComputeIntensityHistogram(o,!0),a=SA.PickThreshold(u),f=p(o,a),l=RigidAlignContours(i,f),c=viewport2[2]*.5-l.c0[0],h=viewport2[3]*.5-l.c0[1],v=Math.cos(l.roll),m=Math.sin(l.roll),g=v*c+m*h,y=-m*c+v*h;g+=l.c1[0],y+=l.c1[1],g-=viewport2[2]*.5,y-=viewport2[3]*.5;var b=SA.VIEWERS[0].GetCamera(),g=g*b.Height/viewport2[3],y=y*b.Height/viewport2[3];SA.VIEWERS[1].AnimateTransform(-g,-y,-l.roll)}function it(){var e=SA.VIEWERS[0],t=e.MainView.GetImageData();d(t,5);var n=SA.ComputeIntensityHistogram(t),r=SA.PickThreshold(n),i=p(t,r);MakeContourPolyline(i,SA.VIEWERS[0]);var s=g(i),o=new SA.DistanceMap(s,1);o.AddContour(i),o.Update(),o.Draw(SA.VIEWERS[1])}function st(){var e=SA.VIEWERS[0],t=e.MainView.Context2d,n=e.MainView.GetImageData();d(n,2);var r=SA.ComputeIntensityHistogram(n),i=SA.PickThreshold(r);K(n,i,!1),t.putImageData(n,0,0);var s=[0,n.width,0,n.height],o=new SA.DistanceMap(s,1);o.AddImageData(n),o.Update(),o.Draw(SA.VIEWERS[1])}function ot(e){var t=SA.VIEWERS[0],n=t.MainView.GetImageData();d(n,2);var r=p(n,e);ContourRemoveDuplicatePoints(r,1);if(r.length>1)var i=MakeContourPolyline(r,SA.VIEWERS[0])}function ut(e){e==undefined&&(e=3);var t=SA.VIEWERS[1],n=t.MainView.GetImageData();d(n,2);var r=SA.ComputeIntensityHistogram(n,!0),i=SA.PickThreshold(r),s=p(n,i);ContourRemoveDuplicatePoints(s,3),CONTOUR=s;var o=new f;o.TriangulateContour(s),o.CreateFullMesh();while(o.ConditionEdgeRotate());o.Update(),o.ConvertPointsToWorld(t),t.AddShape(o),eventuallyRender()}function at(e){e==undefined&&(e=3);var t=SA.VIEWERS[0],n=t.MainView.GetImageData();d(n,2);var r=SA.ComputeIntensityHistogram(n,!0),i=SA.PickThreshold(r),s=p(n,i);MakeContourPolyline(s,SA.VIEWERS[0]),t=SA.VIEWERS[1];var o=t.MainView.GetImageData();d(o,2);var u=SA.ComputeIntensityHistogram(o,!0),a=SA.PickThreshold(u),f=p(o,a);ContourRemoveDuplicatePoints(f,e),x(s,f),MakeContourPolyline(f,SA.VIEWERS[0]),eventuallyRender()}function ft(e,t,n){var r=2;d(e,r);var i=SA.ComputeIntensityHistogram(e,!0),s=SA.PickThreshold(i),o=SA.GetHagFishContours(e,s,min,max);return o}function lt(e,t){var n=2,r=2e-5,i=.5;t||(t=10),d(e,n);var s=SA.ComputeIntensityHistogram(e,!0),o=SA.PickThresholdContaining(s,t),u=SA.GetHagFishContours(e,o,r,i);return u}function mt(){pt=new SA.Note,pt.Id="5523dad0dd98b56d82d6d062",pt.Title="AutoStack",pt.CoordinateSystem="Pixel",pt.HiddenTitle="AutoStack",pt.HideAnnotations=!1,pt.Type="Stack",pt.ViewerRecords=[],dt=undefined,SA.VIEWERS[0].WidgetList=[],eventuallyRender()}function gt(){console.log("Accept"),ht=ct,ct=[],SA.VIEWERS[0].WidgetList=[],eventuallyRender(),wt(),console.log("Finished: adding contours.")}function yt(e,t,n){SA.VIEWERS[0].WidgetList=[],eventuallyRender(),ht=[];var r=SA.VIEWERS[0],i=r.MainView.GetImageData();d(i,e);var s=SA.ComputeIntensityHistogram(i,!0),o=SA.PickThreshold(s),u=SA.GetHagFishContours(i,o,t,n);ct=[];while(u.length){var a=u[0].GetBounds(),f=0;for(var l=1;l<u.length;++l){var c=u[l].GetBounds();c[2]>a[3]&&c[0]<a[1]&&(a=c,f=l)}ct.push(u.splice(f,1)[0])}for(var l=0;l<ct.length;++l){var h=l/ct.length;ct[l].MakePolyline([h,0,1-h],SA.VIEWERS[0].MainView)}eventuallyRender()}function bt(e,t,r){var i=new PairTransformation;e.Transform=i;var s=new n;s.DeepCopy(r),RigidAlignContours(t,s);var o=t.GetCenter(),u=s.GetCenter();console.log("shift: "+(u[0]-o[0])+", "+(u[1]-o[1])),s.MakePolyline([1,0,1],SA.VIEWERS[0].MainView);var a=40,f=Math.ceil(r.Length()/a);for(var l=2;l<r.Length();l+=f){var c=s.GetPoint(l);t.Camera&&(c=t.Camera.ConvertPointViewerToWorld(c[0],c[1]));var h=r.GetPoint(l);r.Camera&&(h=r.Camera.ConvertPointViewerToWorld(h[0],h[1]));var p=new SA.PairCorrelation;p.SetPoint0(c),p.SetPoint1(h),i.Correlations.push(p)}}function wt(){for(var e=0;e<ht.length;++e){var t=SA.VIEWERS[0].GetCache().Image,n=ht[e],r=n.GetBounds(),i=new ViewerRecord;i.Camera={};var s=[(r[0]+r[1])/2,(r[2]+r[3])/2];i.Camera.Height=r[3]-r[2],i.Camera.Width=r[2]-r[0],i.Camera.Roll=0;if(n.Camera){s=n.Camera.ConvertPointViewerToWorld(s[0],s[1]);var o=n.Camera.ConvertPointViewerToWorld(r[0],r[2]);i.Camera.Width=Math.abs((s[0]-o[0])*2),i.Camera.Height=Math.abs((s[1]-o[1])*2),i.Camera.Roll=n.Camera.Roll}i.Camera.SetFocalPoint(s),i.Image=t,i.Database=t.db,dt&&bt(i,dt,ht[e]),dt=ht[e],pt.ViewerRecords.push(i)}}function xt(){var e=new Date,t=JSON.stringify(pt.Serialize());$.ajax({type:"post",url:"/webgl-viewer/saveviewnotes",data:{note:t,date:e.getTime()},success:function(e,t){Et=e,St=new SA.Note,St.Load(e),SA.Debug("Auto Stack Saved")},error:function(){SA.Debug("AJAX - error() : saveviewnotes")}})}function Nt(){if(ct.length==0){ct=Tt,Tt=[];return}var e=ct[0].GetBounds(),t=(e[1]-e[0])/500,n=SA.VIEWERS[0].GetCamera().Roll;SA.VIEWERS[0].GetImage(e,n,t,Ct)}function Ct(e){var t=ct[0].Threshold;Tt.push(p(e,t)),ct.slice(1),Nt()}SA.PermuteBounds=function(e,t,n){if(n<0){t<<=1;var r=e[t];e[t]=-e[t+1],e[t+1]=-r}},n.prototype.DeepCopy=function(e){this.Points=new Array(e.Points.length);for(var t=0;t<e.Points.length;++t)this.Points[t]=e.Points[t].slice(0);this.World=e.World,e.Camera&&(this.Camera=new SAM.Camera,this.Camera.DeepCopy(e.Camera)),delete this.Bounds,delete this.Area},n.prototype.SetPoints=function(e){this.Points=e.slice(0),delete this.Bounds,delete this.Area},n.prototype.Length=function(){return this.Points.length},n.prototype.GetDistanceSquared=function(e,t){if(this.Points.length==0)return 0;var n=this.Points[0],r=n[0]-e,i=n[1]-t,s=r*r+i*i;for(var o=1;o<this.Points.length;++o){var u=this.Points[o];r=u[0]-e,i=u[1]-t;var a=r*r+i*i;a<s&&(s=a,n=u)}return s},n.prototype.GetPoint=function(e){return this.Points[e]},n.prototype.SetPoint=function(e,t){this.Points[e]=[t[0],t[1]],delete this.Bounds,delete this.Area},n.prototype.GetBounds=function(){if(this.Length()==0)return this.Bounds;if(!this.Bounds){var e=this.Points[0][0],t=e,n=this.Points[0][1],r=n;for(var i=1;i<this.Points.length;++i){var s=this.Points[i];s[0]<e&&(e=s[0]),s[0]>t&&(t=s[0]),s[1]<n&&(n=s[1]),s[1]>r&&(r=s[1])}this.Bounds=[e,t,n,r]}return this.Bounds.slice(0)},n.prototype.GetCenter=function(e){var t=this.GetBounds();return[(t[0]+t[1])/2,(t[2]+t[3])/2]},n.prototype.GetArea=function(){if(this.Area)return this.Area;if(this.Points.length<3)return this.Area=0,0;var e=0,t=0;for(var n=0;n<this.Points.length;++n)e+=this.Points[n][0],t+=this.Points[n][1];e/=this.Points.length,t/=this.Points.length;var r=0,i=this.Points[this.Points.length-1],s=i[0]-e,o=i[1]-t;for(var n=0;n<this.Points.length;++n){var u=this.Points[n],a=u[0]-e,f=u[1]-t;r+=s*f-o*a,s=a,o=f}return this.Area=r/2,this.Area},n.prototype.Transform=function(e,t,n){delete this.Bounds,delete this.Area;for(var r=0;r<this.Points.length;++r){var i=this.Points[r][0],s=this.Points[r][1],o=i-t[0],u=s-t[1],a=Math.sin(n),f=Math.cos(n),l=f*o+a*u,c=-a*o+f*u;this.Points[r][0]=i+(l-o)+e[0],this.Points[r][1]=s+(c-u)+e[1]}},n.prototype.Translate=function(e){delete this.Bounds,delete this.Area;for(var t=0;t<this.Points.length;++t)this.Points[t][0]+=e[0],this.Points[t][1]+=e[1]},n.prototype.RemoveDuplicatePoints=function(e){e==undefined&&(e=0);var t=this.Points[this.Points.length-1],n=0;while(n<this.Points.length){var r=this.Points[n],i=r[0]-t[0],s=r[1]-t[1];Math.sqrt(i*i+s*s)<=e?this.Points.splice(n,1):(++n,t=r)}},n.prototype.Resample=function(e){var t=[],n=this.Points[this.Points.length-1],r=1,i=0;while(r<this.Points.length){var s=this.Points[r],o=s[0]-n[0],u=s[1]-n[1],a=Math.sqrt(o*o+u*u);i-=a;while(i<0){var f=s[0]+o*i/a,l=s[1]+u*i/a;t.push([f,l]),i+=e}r+=1,n=s}this.Points=t},n.prototype.Decimate=function(e){var t=!0;while(t){t=!1;var n=[];n.push(this.Points[0]);var r=3;while(r<this.Points.length){var i=this.Points[r],s=this.Points[r-1],o=this.Points[r-2],u=this.Points[r-3],a=(s[0]+o[0])*.5,f=(s[1]+o[1])*.5,l=i[1]-u[1],c=-(i[0]-u[0]),h=Math.sqrt(l*l+c*c);l/=h,c/=h,h=Math.abs(l*(a-this.Points[r-3][0])+c*(f-this.Points[r-3][1]));var p=(i[0]-s[0])*(u[0]-s[0])+(i[1]-s[1])*(u[1]-s[1]),d=(i[0]-o[0])*(u[0]-o[0])+(i[1]-o[1])*(u[1]-o[1]);h<e&&p<0&&d<0?(n.push([a,f]),t=!0,r+=2):(n.push(this.Points[r-2]),++r)}r-=2;while(r<this.Points.length)n.push(this.Points[r]),++r;this.Points=n}},n.prototype.TransformToWorld=function(){if(this.World)return;delete this.Bounds,delete this.Area;for(var e=0;e<this.Points.length;++e){var t=this.Points[e];this.Points[e]=this.Camera.ConvertPointViewerToWorld(t[0],t[1])}this.World=!0},n.prototype.WorldToViewer=function(){if(!this.World)return;delete this.Bounds,delete this.Area;for(var e=0;e<this.Points.length;++e){var t=this.Points[e];this.Points[e]=this.Camera.ConvertPointWorldToViewer(t[0],t[1])}this.World=!1},n.prototype.MakePolyline=function(e,t){var n=[];for(var r=0;r<this.Points.length;++r){var i=this.Points[r];!this.World&&this.Camera?n.push(this.Camera.ConvertPointViewerToWorld(i[0],i[1])):n.push([i[0],i[1]])}var s=new SAM.Polyline;return s.OutlineColor=e,s.Points=n,s.Closed=!0,s.LineWidth=0,s.UpdateBuffers(t),s.FixedSize=!1,t&&t.AddShape(s),s},n.prototype.MakeStackSectionWidget=function(e){var t=new SA.StackSectionWidget;return t.Shapes.push(this.MakePolyline([0,1,0],e)),t},r.prototype.WorldPointToMask=function(e){var t=this.MaskViewport,n=this.MaskMatrix,r=e[0]*n[3]+e[1]*n[7]+n[15],i=(e[0]*n[0]+e[1]*n[4]+n[12])/r,s=(e[0]*n[1]+e[1]*n[5]+n[13])/r;return i=(1+i)*.5*t[2],s=(1-s)*.5*t[3],[i,s]},r.prototype.Draw=function(){this.CanvasContext.putImageData(this.Mask,0,0),this.ImageAnnotation.Image.src=this.Canvas.toDataURL("image/png"),this.Viewer.EventuallyRender()},r.prototype.AddPositive=function(e){var t=this.WorldPointToMask(e);t[0]=Math.round(t[0]),t[1]=Math.round(t[1]);if(t[0]>=0&&t[0]<this.Data.width&&t[1]>=0&&t[1]<this.Data.height){var n=this.GetPixel(t);if(this.Evaluate(n))return;var r={center:n,r2:4e3};for(var i=0;i<this.NegativePoints;++i){var s=this.NegativePoints[i],o=0,u;for(var a=0;a<n.length;++a)u=s[a]-n[a],o+=u*u,o=o-2*Math.sqrt(o)+1;o<r.r2&&(r.r2=o)}r.r2>1&&this.PositiveSpheres.push(r)}},r.prototype.AddNegative=function(e){var t=this.WorldPointToMask(e);t[0]=Math.round(t[0]),t[1]=Math.round(t[1]);var n=this.GetPixel(t);if(t[0]>=0&&t[0]<this.Data.width&&t[1]>=0&&t[1]<this.Data.height&&this.Evaluate(n)){this.NegativePoints.push(n);for(var r=0;r<this.PositiveSpheres.length;++r){var i=this.PositiveSpheres[r],s=0,o;for(var u=0;u<n.length;++u)o=n[u]-i.center[u],s+=o*o;s=s-2*Math.sqrt(s)+1,s<i.r2&&(i.r2=s)}}},r.prototype.Evaluate=function(e){for(var t=0;t<this.PositiveSpheres.length;++t){var n=this.PositiveSpheres[t],r=0;for(var i=0;i<e.length;++i){var s=e[i]-n.center[i];r+=s*s}if(r<n.r2)return!0}return!1},r.prototype.GetPixel=function(e){return idx=e[0]+e[1]*this.Data.width<<2,[this.Data.data[idx++],this.Data.data[idx++],this.Data.data[idx++],this.Data.data[idx],e[0],e[1]]},r.prototype.Update=function(){var e=0;for(var t=0;t<this.Data.height;++t)for(var n=0;n<this.Data.width;++n){var r=this.GetPixel([n,t]);this.Evaluate(r)?(this.Mask.data[e]=255,this.Mask.data[e+1]=0,this.Mask.data[e+2]=0,this.Mask.data[e+3]=255):(this.Mask.data[e]=0,this.Mask.data[e+1]=255,this.Mask.data[e+2]=0,this.Mask.data[e+3]=0),e+=4}};var s;a.prototype.SetSize=function(e,t,n,r){this.Height=r,this.Width=n,typeof e=="number"&&(e=e.toString()+"px"),typeof t=="number"&&(t=t.toString()+"px"),this.Div.css({width:n.toString(),height:r.toString(),top:t,left:e}),this.Canvas[0].width=n,this.Canvas[0].height=r},a.prototype.Clear=function(){this.Context.clearRect(0,0,this.Width,this.Height)},a.prototype.Draw=function(e,t,n,r){n||(n=0),r||(r=e.length);var i=0,s=0;for(var o=n;o<r;++o){var u=e[o];u>i&&(i=u),u<s&&(s=u)}var a=this.Context,f,l,c,h,p,d;this.Axis?(f=(this.Width-2)/(i-s),c=-s*f+1,l=(this.Height-2)/(r-n),h=-n*l+1):(f=-(this.Height-2)/(i-s),c=-i*f+1,l=(this.Width-2)/(r-n),h=-n*l+1),a.beginPath(),a.strokeStyle="#EEE",p=n*l+h,this.Axis?a.moveTo(c,p):a.moveTo(p,c),p=r*l+h,this.Axis?a.lineTo(c,p):a.lineTo(p,c),a.stroke(),a.beginPath(),a.strokeStyle=t,p=Math.floor(n*l+h),d=Math.floor(e[0]*f+c),this.Axis?a.moveTo(d,p):a.moveTo(p,d);for(var o=n+1;o<r;++o)p=Math.floor(o*l+h),d=Math.floor(e[o]*f+c),this.Axis?a.lineTo(d,p):a.lineTo(p,d);a.stroke()},f.prototype.DeepCopy=function(e){this.PointCoordiantes=new Array(e.PointCoordinates.length);for(var t=0;t<e.PointCoordinates.length;++t)this.PointCoordinates[t]=e.PointCoordinates[t];this.TrianglePointIds=new Array(e.TrianglePointIds.length);for(var t=0;t<e.TrianglePointIds.length;++t)this.TrianglePointIds[t]=e.TrianglePointIds[t]},f.prototype.GetPointCoordinates=function(e){var t=e<<1;return[this.PointCoordinates[t++],this.PointCoordinates[t]]},f.prototype.ConvertPointsToWorld=function(e){var t=e.GetViewport(),n=0;while(n<this.PointCoordinates.length){var r=e.ConvertPointViewerToWorld(this.PointCoordinates[n],this.PointCoordinates[n+1]);this.PointCoordinates[n++]=r[0],this.PointCoordinates[n++]=r[1]}},f.prototype.Draw=function(e){var t=e.Context2d;t.save(),t.setTransform(1,0,0,1,0,0),t.transform(.5*e.Viewport[2],0,0,-0.5*e.Viewport[3],.5*e.Viewport[2],.5*e.Viewport[3]);var n=1/e.Camera.Matrix[15];t.transform(e.Camera.Matrix[0]*n,e.Camera.Matrix[1]*n,e.Camera.Matrix[4]*n,e.Camera.Matrix[5]*n,e.Camera.Matrix[12]*n,e.Camera.Matrix[13]*n),t.strokeStyle="#000",t.lineWidth=10;var r,i,s,o=0;while(o<this.TrianglePointIds.length)t.beginPath(),s=this.TrianglePointIds[o++]<<1,r=this.PointCoordinates[s++],i=this.PointCoordinates[s],t.moveTo(r,i),s=this.TrianglePointIds[o++]<<1,t.lineTo(this.PointCoordinates[s++],this.PointCoordinates[s]),s=this.TrianglePointIds[o++]<<1,t.lineTo(this.PointCoordinates[s++],this.PointCoordinates[s]),t.lineTo(r,i),t.stroke();t.restore()},f.prototype.OtherTriangleEdges=function(e,t){if(e.edge0===t)return[e.edge1,e.edge2];if(e.edge1===t)return[e.edge2,e.edge0];if(e.edge2===t)return[e.edge0,e.edge1];SA.Debug("Triangle does not contain the edge")},f.prototype.PointIdSharedByEdges=function(e,t){if(e.vert0==t.vert0)return e.vert0;if(e.vert0==t.vert1)return e.vert0;if(e.vert1==t.vert0)return e.vert1;if(e.vert1==t.vert1)return e.vert1;SA.Debug("Edges do not share a point")},f.prototype.SwapEdgeTriangle=function(e,t,n){e.tri0==t&&(e.tri0=n),e.tri1!=undefined&&e.tri1==t&&(e.tri1=n)},f.prototype.ConditionEdgeRotate=function(){var e=!1;for(var t=0;t<this.Edges.length;++t){var n=this.Edges[t];if(n===undefined||n.tri1==undefined)continue;var r=this.Triangles[n.tri0],i=this.Triangles[n.tri1],s=[];s=s.concat(this.OtherTriangleEdges(r,n)),s=s.concat(this.OtherTriangleEdges(i,n));var o=new Array(4);o[0]=this.PointIdSharedByEdges(s[3],s[0]),o[1]=this.PointIdSharedByEdges(s[0],s[1]),o[2]=this.PointIdSharedByEdges(s[1],s[2]),o[3]=this.PointIdSharedByEdges(s[2],s[3]);var u=o[1]<<1,a=o[3]<<1,f=this.PointCoordinates[a]-this.PointCoordinates[u],l=this.PointCoordinates
[a+1]-this.PointCoordinates[u+1],c=Math.sqrt(f*f+l*l);if(c<n.length){var u=o[1]<<1,h=o[2]<<1,a=o[3]<<1,p=this.PointCoordinates[u]-this.PointCoordinates[h],d=this.PointCoordinates[u+1]-this.PointCoordinates[h+1],v=this.PointCoordinates[a]-this.PointCoordinates[h],m=this.PointCoordinates[a+1]-this.PointCoordinates[h+1],g=v*d-m*p,y=o[0]<<1;p=this.PointCoordinates[u]-this.PointCoordinates[y],d=this.PointCoordinates[u+1]-this.PointCoordinates[y+1],v=this.PointCoordinates[a]-this.PointCoordinates[y],m=this.PointCoordinates[a+1]-this.PointCoordinates[y+1];var b=p*m-d*v;if(b<0&&g<0||b>0&&g>0)e=!0,n.vert0=o[1],n.vert1=o[3],n.length=c,r.vert0=o[1],r.vert1=o[2],r.vert2=o[3],r.edge0=s[1],r.edge1=s[2],r.edge2=n,i.vert0=o[1],i.vert1=o[3],i.vert2=o[0],i.edge0=n,i.edge1=s[3],i.edge2=s[0],this.SwapEdgeTriangle(s[0],n.tri0,n.tri1),this.SwapEdgeTriangle(s[2],n.tri1,n.tri0)}}return e},f.prototype.AddEdge=function(e,t,n){if(e>t){var r=e;e=t,t=r}var i=undefined;for(var s=0;s<this.EdgeHash[e].length&&!i;++s){var o=this.EdgeHash[e][s];o.vert1==t&&(i=o,i.tri1=n)}if(i==undefined){i={vert0:e,vert1:t,tri0:n},this.EdgeHash[e].push(i);var u=e<<1,a=t<<1,f=this.PointCoordinates[a]-this.PointCoordinates[u],l=this.PointCoordinates[a+1]-this.PointCoordinates[u+1];i.length=Math.sqrt(f*f+l*l)}return i},f.prototype.CreateFullMesh=function(){var e=this.PointCoordinates.length/2,t=this.TrianglePointIds.length/3;this.Triangles=new Array(t),this.EdgeHash=new Array(e);for(var n=0;n<this.EdgeHash.length;++n)this.EdgeHash[n]=[];var r=0,i=0;while(r<this.TrianglePointIds.length){var s=this.TrianglePointIds[r++],o=this.TrianglePointIds[r++],u=this.TrianglePointIds[r++],a={vert0:s,vert1:o,vert2:u};a.edge0=this.AddEdge(s,o,i),a.edge1=this.AddEdge(o,u,i),a.edge2=this.AddEdge(u,s,i),this.Triangles[i]=a,++i}var f=e+t-1;this.Edges=new Array(f);var l=0;for(var n=0;n<this.EdgeHash.length;++n)for(var c=0;c<this.EdgeHash[n].length;++c)this.Edges[l++]=this.EdgeHash[n][c];delete this.EdgeHash},f.prototype.Update=function(){var e=0,t=0;for(t=0;t<this.Triangles.length;++t){var n=this.Triangles[t];this.TrianglePointIds[e++]=n.vert0,this.TrianglePointIds[e++]=n.vert1,this.TrianglePointIds[e++]=n.vert2}},f.prototype.DrawInCanvas=function(e){var t=0,n;while(t<this.TrianglePointIds.length)n=this.TrianglePointIds[t++]<<1,e.beginPath(this.PointCoordinates[n++],this.PointCoordinates[n]),n=this.TrianglePointIds[t++]<<1,e.lineTo(this.PointCoordinates[n++],this.PointCoordinates[n]),n=this.TrianglePointIds[t++]<<1,e.lineTo(this.PointCoordinates[n++],this.PointCoordinates[n]),e.stroke()},f.prototype.TriangulateContour=function(e){var t,n,r,i=e.Length();this.PointCoordinates=new Array(i*2),this.TrianglePointIds=new Array;var s=new Array(i),o=e.GetPoint(i-1)[0],u=e.GetPoint(i-1)[1],a=e.GetPoint(0)[0],f=e.GetPoint(0)[1],l=a-o,c=f-u,h=Math.sqrt(l*l+c*c),p,d,v,m,g;for(var y=0;y<i;++y)this.PointCoordinates[y<<1]=a,this.PointCoordinates[(y<<1)+1]=f,p=e.GetPoint((y+1)%i)[0],d=e.GetPoint((y+1)%i)[1],v=p-a,m=d-f,g=Math.sqrt(v*v+m*m),t=v*c-l*m,n=l*v+c*m,r=Math.atan2(t,n),s[y]=r,o=a,u=f,a=p,f=d,l=v,c=m,h=g;var b=0,w=i;while(w>2){var E=10,S=x-1;for(var y=0;y<i;++y)s[y]<E&&(E=s[y],S=y);if(E>0)return;s[S]=100,--w;var x=S;do--x,x<0&&(x=i-1);while(s[x]>10);var T=S;do++T,T>=i&&(T=0);while(s[T]>10);this.TrianglePointIds[b++]=x,this.TrianglePointIds[b++]=S,this.TrianglePointIds[b++]=T,S=x,x=S;do--x,x<0&&(x=i-1);while(s[x]>10);var N=T;do++N,N>=i&&(N=0);while(s[N]>10);var C=e.GetPoint(x),k=e.GetPoint(S),L=e.GetPoint(T),A=e.GetPoint(N),l=k[0]-C[0],c=k[1]-C[1],v=L[0]-k[0],m=L[1]-k[1],O=A[0]-L[0],M=A[1]-L[1],h=Math.sqrt(l*l+c*c),g=Math.sqrt(v*v+m*m),_=Math.sqrt(O*O+M*M),t=v*c-l*m,n=l*v+c*m;s[S]=Math.atan2(t,n),t=(O*m-v*M)/(g*_),n=(v*O+m*M)/(g*_),s[T]=Math.atan2(t,n)}},l.prototype.Push=function(e){var t=this.EndIdx+1;t>=this.Array.length&&t==0,this.Array[t]!=null&&(this.Allocate(this.Array.length*2),t=this.EndIdx+1),this.Array[this.EndIdx]=e,this.EndIdx=t},l.prototype.Shift=function(){var e=this.Array[this.StartIdx];return e==null?e:(this.Array[this.StartIdx]=null,this.StartIdx+=1,this.StartIdx>=this.Array.length&&this.StartIdx==0,e)},l.prototype.Allocate=function(e){if(this.Array&&this.Array.length>e)return;var t=new Array(e),n=0;if(this.Array){for(var r=this.StartIdx;r!=this.EndIdx;++r)r>=this.Array.length&&(r=0),t[n++]=this.Array[r];this.StartIdx=0,this.EndIdx=n,delete this.Array}while(n++<e)t[n]=null;this.Array=t},c.prototype.Draw=function(e){var t=e.MainView.Context2d,n=t.createImageData(this.Dimensions[0],this.Dimensions[1]),r=0,i=this.Dimensions[0]*this.Dimensions[1];for(var s=0;s<i;++s)r<this.Map[s]&&(r=this.Map[s]);var o=0;for(var s=0;s<i;++s)n.data[o]=n.data[o+1]=n.data[o+2]=Math.floor(255*this.Map[s]/r),n.data[o+3]=255,o+=4;t.putImageData(n,10,10)},c.prototype.AddContour=function(e){for(var t=0;t<e.Length();++t){var n=Math.round((e.GetPoint(t)[0]-this.Bounds[0])/this.Spacing),r=Math.round((e.GetPoint(t)[1]-this.Bounds[2])/this.Spacing);n>=0&&n<this.Dimensions[0]&&r>=0&&r<this.Dimensions[1]&&(this.Map[n+r*this.Dimensions[0]]=0)}},c.prototype.AddPolyline=function(e){var t,n,r,i=e.Points;if(i.length==0)return;t=[(i[0][0]-this.Bounds[0])/this.Spacing,(i[0][1]-this.Bounds[2])/this.Spacing],n=t;for(var s=1;s<i.length;++s)r=[(i[s][0]-this.Bounds[0])/this.Spacing,(i[s][1]-this.Bounds[2])/this.Spacing],this.AddEdge(n,r),n=r;e.Closed&&i.length>2&&this.AddEdge(r,t);if(e.Closed&&i.length>2&&!1){this.AddEdge(r,t),this.Queue||(this.Queue=new l(this.Dimensions[0]+this.Dimensions[1]));var o=i[2][0]-i[0][0],u=i[0][1]-i[2][1],a=1/Math.sqrt(u*u+o*o);u*=a,o*=a;var f=(i[1][0]-this.Bounds[0])/this.Spacing,c=(i[1][1]-this.Bounds[2])/this.Spacing,h,p;do{f+=u,c+=o,h=Math.round(f),p=Math.round(c);if(h<0||h>=this.Dimensions[0]||p<0||p>=this.Dimensions[1])return}while(this.Map[h+p*this.Dimensions[0]]==0);this.Queue.Push([h,p]);var d,v;while((d=this.Queue.Shift())!=null)this.AddSeedToQueue(d[0]-1,d[1]),this.AddSeedToQueue(d[0]+1,d[1]),this.AddSeedToQueue(d[0],d[1]-1),this.AddSeedToQueue(d[0],d[1]+1)}},c.prototype.Fill=function(e,t){this.Queue||(this.Queue=new l(this.Dimensions[0]+this.Dimensions[1])),this.Queue.Push([e,t]);var n=this.Dimensions[0]-1,r=this.Dimensions[1]-1,i,s;while((i=this.Queue.Shift())!=null)i[0]>0&&this.AddSeedToQueue(i[0]-1,i[1]),i[0]<n&&this.AddSeedToQueue(i[0]+1,i[1]),i[1]>0&&this.AddSeedToQueue(i[0],i[1]-1),i[1]<r&&this.AddSeedToQueue(i[0],i[1]+1)},c.prototype.AddSeedToQueue=function(e,t){var n=e+t*this.Dimensions[0];e>=0&&e<this.Dimensions[0]&&t>=0&&t<this.Dimensions[1]&&this.Map[n]!=0&&(this.Map[n]=0,this.Queue.Push([e,t]))},c.prototype.AddEdge=function(e,t){var n=Math.max(Math.abs(e[0]-t[0]),Math.abs(e[1]-t[1]));n=Math.ceil(n);for(var r=0;r<=n;++r){var i=Math.round((e[0]*(n-r)+t[0]*r)/n),s=Math.round((e[1]*(n-r)+t[1]*r)/n);this.Map[i+s*this.Dimensions[0]]=0}},c.prototype.AddImageData=function(e){var t=0;for(var n=0;n<e.height;++n)for(var r=0;r<e.width;++r)r>=0&&r<this.Dimensions[0]&&n>=0&&n<this.Dimensions[1]&&e.data[i+3]==255&&(this.Map[r+n*this.Dimensions[0]]=0),i+=4},c.prototype.Update=function(){var e=0;while(this.UpdatePass())++e},c.prototype.UpdatePass=function(){var e=!1,t;for(var n=0;n<this.Dimensions[1];++n){t=n*this.Dimensions[0];var r=this.Map[t];for(var i=1;i<this.Dimensions[0];++i)++t,++r,r<this.Map[t]?(this.Map[t]=r,e=!0):r=this.Map[t];for(var i=this.Dimensions[0]-2;i>=0;--i)--t,++r,r<this.Map[t]?(this.Map[t]=r,e=!0):r=this.Map[t]}for(var i=0;i<this.Dimensions[0];++i){t=i;var r=this.Map[t];for(var n=1;n<this.Dimensions[1];++n)t+=this.Dimensions[0],++r,r<this.Map[t]?(this.Map[t]=r,e=!0):r=this.Map[t];for(var n=this.Dimensions[1]-2;n>=0;--n)t-=this.Dimensions[0],++r,r<this.Map[t]?(this.Map[t]=r,e=!0):r=this.Map[t]}return e},c.prototype.GetDistance=function(e,t){var n=Math.round((e-this.Bounds[0])/this.Spacing),r=Math.round((t-this.Bounds[2])/this.Spacing);if(n>=0&&n<this.Dimensions[0]&&r>=0&&r<this.Dimensions[1])return this.Map[n+r*this.Dimensions[0]];var i=0;return n<0&&(i+=-0.1*n,n=0),n>=this.Dimensions[0]&&(i+=.1*(n-this.Dimensions[0]+1),n=this.Dimensions[0]-1),r<0&&(i+=-0.1*r,r=0),r>=this.Dimensions[1]&&(i+=.1*(r-this.Dimensions[1]+1),r=this.Dimensions[1]-1),i+this.Map[n+r*this.Dimensions[0]]},c.prototype.GetGradient=function(e,t){var n=Math.round((e-this.Bounds[0])/this.Spacing),r=Math.round((t-this.Bounds[2])/this.Spacing),i=0,s=0;if(n<0||n>=this.Dimensions[0]||r<0||r>=this.Dimensions[1]){n-=this.Dimensions[0]*.5,r-=this.Dimensions[1]*.5;var o=Math.sqrt(n*n+r*r);return[n/(10*o),r/(10*o)]}var u=n+r*this.Dimensions[0];n==0?i=this.Map[u+1]-this.Map[u]:n==this.Dimensions[0]-1?i=this.Map[u]-this.Map[u-1]:i=this.Map[u+1]-this.Map[u-1];var a=this.Dimensions[0];return r==0?s=this.Map[u+a]-this.Map[u]:r==this.Dimensions[1]-1?s=this.Map[u]-this.Map[u-a]:s=this.Map[u+a]-this.Map[u-a],i*=this.Spacing,s*=this.Spacing,[i,s]},SA.SeedIsoContour=function(e,t,n,r,i,s){this.Bounds=[0,-1,0,-1];var o=h(e,t,n,r,i,s,1);if(!o)return!1;var u=h(e,r,i,t,n,s,-1);if(!u||u.length<2)return o;u.reverse(),u.pop();var a=u.concat(o);return a},SA.ComputeIntensityHistogram=function(e,t){t===undefined&&(t=!1);var n=new Array(256);for(var r=0;r<256;++r)n[r]=0;var i=e.data,s=e.width*e.height*4;for(var r=0;r<s;){var o=Math.floor((e.data[r++]+e.data[r++]+e.data[r++])/3);(!t||o<254)&&o>5&&++n[o],++r}return n};var w=undefined,N=5e3,C=.2,k=.03,A,O,M,_,D,P,B;SA.DeformableAlignViewers=function(e){var t=SA.display.GetNote(),r=t.ViewerRecords[t.StartIndex+1].Transform;if(!r)return;var i=SA.VIEWERS[1].GetViewport(),s=i[0]+i[2]/2-40,o=i[1]+i[3]/2-40;B===undefined&&(B=$("<img>").appendTo("body").attr("src",SA.ImagePathUrl+"circular.gif").attr("alt","waiting...").hide().addClass("sa-view-align-waiting")),B.show().css({left:s+"px",top:o+"px"}),window.setTimeout(function(){var i=3,s=SA.VIEWERS[0],o=s.MainView.GetImageData();d(o,2);var u=SA.ComputeIntensityHistogram(o,!0),a=SA.PickThreshold(u),f=p(o,a);s=SA.VIEWERS[1];var l=s.MainView.GetImageData();d(l,2);var c=SA.ComputeIntensityHistogram(l,!0),h=SA.PickThreshold(c),v=p(l,h);v.RemoveDuplicatePoints(i);var m=new n;m.DeepCopy(v),x(f,v),A=f,O=m,M=v;if(!e){var g=SA.VIEWERS[0].GetCamera(),y=g.GetBounds(),b=0;while(b<r.Correlations.length){var w=r.Correlations[b];w.point0[0]>y[0]&&w.point0[0]<y[1]&&w.point0[1]>y[2]&&w.point0[1]<y[3]?r.Correlations.splice(b,1):++b}}P=r;var E=40,S=Math.ceil(v.Length()/E);for(var T=2;T<m.Length();T+=S){var N=SA.VIEWERS[0].GetViewport(),C=SA.VIEWERS[0].ConvertPointViewerToWorld(v.GetPoint(T)[0],v.GetPoint(T)[1]),N=SA.VIEWERS[1].GetViewport(),k=SA.VIEWERS[1].ConvertPointViewerToWorld(m.GetPoint(T)[0],m.GetPoint(T)[1]),w=new SA.PairCorrelation;w.SetPoint0(C),w.SetPoint1(k),r.Correlations.push(w)}console.log("Finished alignment"),SA.display.SynchronizeViews(0,t),B.hide()},10)};var q=0;SA.PickThreshold=function(e){return V(e,10)};var G=undefined;SA.testAlignTranslation=function(e){var t=SA.VIEWERS[0],n=t.MainView.GetImageData();d(n,2);var r=SA.ComputeIntensityHistogram(n,!0),i=SA.PickThreshold(r),s=p(n,i),o=SA.VIEWERS[1],u=o.GetViewport(),a=o.MainView.GetImageData();d(a,2);var f=SA.ComputeIntensityHistogram(a,!0),l=SA.PickThreshold(f),c=p(a,l),h=S(s,c);e&&(s=DecimateContour(s,1),TranslateContour(c,[-h.delta[0],-h.delta[1]]),c=DecimateContour(c,1),MakeContourPolyline(s,SA.VIEWERS[0]),MakeContourPolyline(c,SA.VIEWERS[0]));var v=SA.VIEWERS[0].GetCamera(),m=SA.VIEWERS[0].GetViewport(),g=h.delta[0]*v.Height/m[3],y=h.delta[1]*v.Height/m[3];SA.VIEWERS[0].AnimateTranslate(-g/2,-y/2),SA.VIEWERS[1].AnimateTranslate(g/2,y/2),console.log("Translate = ("+g+", "+y+")")},SA.GetHagFishContours=function(e,t,r,i){var s=e.width*e.height,r=r*s,i=i*s,o=[];for(var u=1;u<e.width;++u)for(var a=e.height-1;a>0;--a){var f=SA.SeedIsoContour(e,u,a,u-1,a,t);if(f){var l=new n;l.Camera=e.Camera,l.Threshold=t,l.SetPoints(f),l.RemoveDuplicatePoints(2);var c=l.GetArea();c>r&&c<i&&(console.log(c/s),o.push(l))}var h=SA.SeedIsoContour(e,u,a,u,a-1,t);h&&(l=new n,l.Camera=e.Camera,l.Threshold=t,l.SetPoints(h),l.RemoveDuplicatePoints(2),c=l.GetArea(),c>r&&c<i&&(console.log(c/s),o.push(l)))}return o};var ct,ht=[],pt,dt,vt,Et,St,Tt=[];SA.DistanceMap=c,SA.Contour=n,SA.Segmentation=r})();window.SA=window.SA||{},function(){"use strict";function e(e,t){this.Tile=e,this.Cache=t}function t(){this.tiles=[]}function n(e){return function(){e.HandleLoadedImage()}}function r(e){return function(){e.HandleErrorImage()}}function s(e,t,n,r,i,s){this.Cache=s,this.X=e,this.Y=t,this.Z=n,this.Level=r,this.Children=[],this.Parent=null,this.LoadState=0,this.Name=i,this.Texture=null,this.TimeStamp=SA.TimeStamp,this.BranchTimeStamp=SA.TimeStamp,this.Matrix=mat4.create(),mat4.identity(this.Matrix),this.Matrix[14]=n*s.RootSpacing[2]-.1*this.Level;if(!s.Warp){var o=s.TileDimensions[0]*s.RootSpacing[0]/(1<<this.Level),u=s.TileDimensions[1]*s.RootSpacing[1]/(1<<this.Level);this.Matrix[0]=o,this.Matrix[5]=-u,this.Matrix[12]=this.X*o,this.Matrix[13]=(this.Y+1)*u,this.Matrix[15]=1}++SA.NumberOfTiles}e.prototype.HandleLoadedImage=function(){var e=(new Date).getTime();i.add({name:this.Tile.Name,loadtime:e-this.Tile.starttime}),SA.LoadQueueLoaded(this.Tile)},e.prototype.HandleErrorImage=function(){console.log("LoadTile error "+this.Tile.Name),SA.LoadQueueError(this.Tile)},t.prototype.add=function(e){this.tiles.push(e)},t.prototype.report=function(){var e=0;for(var t=0;t<this.tiles.length;t++)e+=this.tiles[t].loadtime;var n={};n.count=this.tiles.length,n.average=e/this.tiles.length,n.total=e,console.log(n)};var i=new t;s.prototype.delete=function(e){--SA.NumberOfTiles,this.DeleteTexture(e),delete this.Matrix,this.Matrix=null,this.Image&&(delete this.Image,this.Image=0);for(var t=0;t<4;++t)this.Children[t]!=null&&(this.Children[t].delete(e),this.Children[t]=null)},s.prototype.LoadQueueAdd=function(){var e=this;while(e&&e.TimeStamp!=SA.TimeStamp)e.TimeStamp=SA.TimeStamp,e=e.Parent;if(this.LoadState!=0)return;if(this.Parent){if(this.Parent.LoadState==0)return this.Parent.LoadQueueAdd();if(this.Parent.LoadState==1)return}SA.LoadQueueAddTile(this)},s.prototype.CreateWarpBuffer=function(e,t){var n=this.Cache.TileDimensions,r=this.Cache.RootSpacing,i=1<<this.Level,s=[r[0]*n[0]/i,r[1]*n[1]/i],o=[s[0]*this.X,s[0]*(this.X+1),s[1]*this.Y,s[1]*(this.Y+1),this.Level,this.Level],u=[],a=[],f=[];e.CreateMeshFromBounds(o,u,a,f),this.VertexTextureCoordBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.VertexTextureCoordBuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(a),t.STATIC_DRAW),this.VertexTextureCoordBuffer.itemSize=2,this.VertexTextureCoordBuffer.numItems=a.length/2,this.VertexPositionBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.VertexPositionBuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(u),t.STATIC_DRAW),this.VertexPositionBuffer.itemSize=3,this.VertexPositionBuffer.numItems=u.length/3,this.CellBuffer=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.CellBuffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint16Array(f),t.STATIC_DRAW),this.CellBuffer.itemSize=1,this.CellBuffer.numItems=f.length},s.prototype.StartLoad=function(t){if(this.LoadState>=2)return;this.Image=new Image,this.starttime=(new Date).getTime();var i=new e(this,t);this.Image.onload=n(i),this.Image.onerror=r(i),SA.TileLoader=="websocket"?this.LoadWebSocket(t):this.LoadHttp(t)},s.prototype.LoadHttp=function(e){if(e.TileSource){this.Name=e.TileSource.getTileUrl(this.Level,this.X,this.Y,this.Z),this.Image.src=this.Name;return}var t;e.Image.type&&e.Image.type=="stack"?t=e.GetSource()+this.Name+".png":t=e.GetSource()+this.Name+".jpg";if(e.UseIIP){var n=this.Level+2,r=Math.ceil(e.Image.dimensions[0]/(e.Image.TileSize<<e.Image.levels-this.Level-1)),i=this.Y*r+this.X;t="http://iip.slide-atlas.org/iipsrv.fcgi?FIF="+e.Image.filename+"&jtl="+n+","+i}this.Image.src=t},s.prototype.LoadWebSocket=function(e){var t="";e.Image.type&&e.Image.type=="stack"?t=this.Name+".png":t=this.Name+".jpg";var n=e.Image._id;ws.FetchTile(t,n,e,this.Image)},s.prototype.Draw=function(e,t){if(this.LoadState!=3)return;if(t.gl)this.Texture==null&&this.CreateTexture(t.gl),t.gl.bindBuffer(t.gl.ARRAY_BUFFER,t.tileVertexPositionBuffer),t.gl.vertexAttribPointer(t.ShaderProgram.vertexPositionAttribute,t.tileVertexPositionBuffer.itemSize,t.gl.FLOAT,!1,0,0),t.gl.bindBuffer(t.gl.ARRAY_BUFFER,t.tileVertexTextureCoordBuffer),t.gl.vertexAttribPointer(t.ShaderProgram.textureCoordAttribute,t.tileVertexTextureCoordBuffer.itemSize,t.gl.FLOAT,!1,0,0),t.gl.bindBuffer(t.gl.ELEMENT_ARRAY_BUFFER,t.tileCellBuffer),t.gl.activeTexture(t.gl.TEXTURE0),t.gl.bindTexture(t.gl.TEXTURE_2D,this.Texture),t.gl.uniform1i(e.samplerUniform,0),t.gl.uniformMatrix4fv(e.mvMatrixUniform,!1,this.Matrix),t.gl.drawElements(t.gl.TRIANGLES,t.tileCellBuffer.numItems,t.gl.UNSIGNED_SHORT,0);else{t.Context2d.save(),t.Context2d.transform(this.Matrix[0],this.Matrix[1],this.Matrix[4],this.Matrix[5],this.Matrix[12],this.Matrix[13]),t.Context2d.transform(1,0,0,-1,0,1);var n=this.Cache.Image.TileSize;n==undefined&&(n=256),t.Context2d.transform(1/n,0,0,1/n,0,0),t.Context2d.drawImage(this.Image,0,0);if(SA.WaterMark){var r=(this.X+1)*(this.Y+1)*4;t.Context2d.translate(128,128),t.Context2d.rotate(r),t.Context2d.translate(-128,-128),t.Context2d.fillStyle="rgba(0, 0, 0, 0.016)",t.Context2d.strokeStyle="rgba(50,50,50, 0.05)",t.Context2d.font="30px Comic Sans MS",t.Context2d.fillText("SlideAtlas",10,10)}t.Context2d.restore()}},s.prototype.CreateTexture=function(e){if(!e){alert("Textures need a gl instance");return}if(this.Texture!=null)return;++SA.NumberOfTextures,this.Texture=e.createTexture();var t=this.Texture;e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!0),e.bindTexture(e.TEXTURE_2D,t),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,this.Image),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null)},s.prototype.DeleteTexture=function(e){if(!e){alert("Textures need a gl instance");return}this.Texture&&(--SA.NumberOfTextures,e.deleteTexture(this.Texture),this.Texture=null)},SA.Tile=s}();(function(){"use strict";function t(){this.UseIIP=!1,this.Levels=[],SA.Caches.push(this),this.NumberOfSections=1}SA.SlideAtlasSource=function(){this.Prefix=undefined,this.getTileUrl=function(e,t,n,r){var i=this.Prefix+"t";while(e>0){--e;var s=t>>e&1,o=n>>e&1,u=s+2*o;u==0&&(i+="q"),u==1&&(i+="r"),u==2&&(i+="t"),u==3&&(i+="s")}return i+=".jpg",i}},SA.GigamacroSource=function(){this.Prefix="http://www.gigamacro.com/content/AMNH/unit_box_test2_05-01-2015/zoomify/",this.GridSizeDebug=[[1,1],[2,2],[4,3],[7,5],[14,9],[28,17],[56,34]],this.setDimensions=function(e,t){this.Dimensions=[e,t],this.GridSize=[],this.Levels=0;for(;;){var n=[Math.ceil(e/256),Math.ceil(t/256)];this.GridSize.splice(0,0,n),this.Levels+=1;if(n[0]==1&&n[1]==1)return;e/=2,t/=2}},this.getTileUrl=function(e,t,n,r){var i=this.GridSize[e];if(t<0||t>=i[0]||n<0||n>=i[1])return"";var s=n*i[0]+t;for(var o=0;o<e;++o)i=this.GridSize[o],s+=i[0]*i[1];var u=Math.floor(s/256),a=this.Prefix+"TileGroup"+u+"/"+e+"-"+t+"-"+n+".jpg";return a}},SA.GirderSource=function(){this.height=18432,this.width=18432,this.tileSize=256,this.minLevel=0,this.maxLevel=7,this.getTileUrl=function(e,t,n){return"http://lemon:8081/api/v1/item/564e42fe3f24e538e9a20eb9/tiles/zxy/"+e+"/"+t+"/"+n}},SA.IIIFSource=function(){this.Prefix="http://ids.lib.harvard.edu/ids/view/Converter?id=834753&c=jpgnocap",this.TileSize=256,this.setDimensions=function(e,t){this.Dimensions=[e,t],this.GridSize=[],this.Levels=0;for(;;){var n=[Math.ceil(e/256),Math.ceil(t/256)];this.Levels+=1;if(n[0]==1&&n[1]==1)return;e/=2,t/=2}},this.getTileUrl=function(e,t,n,r){var i=t*256,s=n*256,o=i+256,u=s+256,a=this.Levels-e-1,f=this.Dimensions[0]>>a,l=this.Dimensions[1]>>a;o>f&&(o=f),u>l&&(u=l),f=o-i,l=u-s,a=1/(1<<a);var c=this.Prefix+"&s="+a+"&r=0&x="+i+"&y="+s+"&w="+f+"&h="+l;return c}},SA.DanielSource=function(){this.Prefix="http://dragon.krash.net:2009/data/1",this.MinLevel=0,this.MaxLevel=7,this.getTileUrl=function(e,t,n,r){if(r<this.MinLevel)return"";if(r>this.MaxLevel)return"";var i=this.Prefix+e+"-"+t+"-"+n;return i}},SA.IIPSource=function(){this.getTileUrl=function(e,t,n,r){var i=Math.ceil(this.ImageWidth/(this.TileSize<<this.NumLevels-r-1)),s=n*i+t;imageSrc=this.Prefix+(r+2)+","+s},this.ImageWidth=0,this.TileSize=256,this.NumLevels=0},SA.FindCache=function(e){for(var t=0;t<SA.Caches.length;++t)if(SA.Caches[t].Image._id==e._id)return SA.Caches[t];var n=new SA.Cache;if(e._id=="556e0ad63ed65909dbc2e383"){var r=new SA.IIIFSource;return r.Prefix="http://ids.lib.harvard.edu/ids/view/Converter?id=47174896",r.setDimensions(2087,2550),e.levels=r.Levels,e.dimensions=r.Dimensions,e.bounds=[0,e.dimensions[0]-1,0,e.dimensions[1]-1],n.SetImageData(e),n.TileSource=r,n}if(e._id=="556c89a83ed65909dbc2e317"){var r=new SA.IIIFSource;return r.Prefix="http://ids.lib.harvard.edu/ids/view/Converter?id=834753&c=jpgnocap",r.setDimensions(3890,5787),e.levels=r.Levels,e.dimensions=r.Dimensions,e.bounds=[0,e.dimensions[0]-1,0,e.dimensions[1]-1],n.SetImageData(e),n.TileSource=r,n}if(e._id=="555a1af93ed65909dbc2e19a"){var r=new SA.GigamacroSource;return r.Prefix="http://www.gigamacro.com/content/AMNH/unit_box_test2_05-01-2015/zoomify/",r.setDimensions(14316,8459),e.levels=r.Levels,e.dimensions=r.Dimensions,e.bounds=[0,e.dimensions[0]-1,0,e.dimensions[1]-1],n.SetImageData(e),n.TileSource=r,n}if(e._id=="555a5e163ed65909dbc2e19d"){var r=new SA.GigamacroSource;return r.Prefix="http://www.gigamacro.com/content/cmnh/redbug_bottom/zoomify/",r.setDimensions(64893,40749),e.levels=r.Levels,e.dimensions=r.Dimensions,e.bounds=[0,e.dimensions[0]-1,0,e.dimensions[1]-1],n.SetImageData(e),n.TileSource=r,n}if(e._id=="555b66483ed65909dbc2e1a0"){var r=new SA.GigamacroSource;return r.Prefix="http://www.gigamacro.com/content/cmnh/redbug_top/zoomify/",r.setDimensions(64893,40749),e.levels=r.Levels,e.dimensions=r.Dimensions,e.bounds=[0,e.dimensions[0]-1,0,e.dimensions[1]-1],n.SetImageData(e),n.TileSource=r,n}if(e._id=="555b664d3ed65909dbc2e1a3"){var r=new SA.GigamacroSource;return r.Prefix="http://www.gigamacro.com/content/AMNH/drawer_unit_box_test_05-01-2015_08-52-29_0000/zoomify/",r.setDimensions(11893,7322),e.levels=r.Levels,e.dimensions=r.Dimensions,e.bounds=[0,e.dimensions[0]-1,0,e.dimensions[1]-1],n.SetImageData(e),n.TileSource=r,n}if(e._id=="555b66523ed65909dbc2e1a6"){var r=new SA.GigamacroSource;return r.Prefix="http://www.gigamacro.com/content/AMNH/full_drawer_test_05-01-2015_09-04-17_0000/zoomify/",r.setDimensions(44245,34013),e.levels=r.Levels,e.dimensions=r.Dimensions,e.bounds=[0,e.dimensions[0]-1,0,e.dimensions[1]-1],n.SetImageData(e),n.TileSource=r,n}if(e._id=="555c93973ed65909dbc2e1b5"){var r=new SA.GigamacroSource;return r.Prefix="http://www.gigamacro.com/content/gigamacro/impasto_polarized/zoomify/",r.setDimensions(76551,57364),e.levels=r.Levels,e.dimensions=r.Dimensions,e.bounds=[0,e.dimensions[0]-1,0,e.dimensions[1]-1],n.SetImageData(e),n.TileSource=r,n}if(e._id=="555c93913ed65909dbc2e1b2"){var r=new SA.GigamacroSource;return r.Prefix="http://www.gigamacro.com/content/gigamacro/restoration_polaraized/zoomify/",r.setDimensions(55884,55750),e.levels=r.Levels,e.dimensions=r.Dimensions,e.bounds=[0,e.dimensions[0]-1,0,e.dimensions[1]-1],n.SetImageData(e),n.TileSource=r,n}if(e._id=="555f46503ed65909dbc2e1b8"){var r=new SA.GigamacroSource;return r.Prefix="http://www.gigamacro.com/content/gigamacro/eucalyptus_10-31-2010/zoomify/",r.setDimensions(38392,45242),e.levels=r.Levels,e.dimensions=r.Dimensions,e.bounds=[0,e.dimensions[0]-1,0,e.dimensions[1]-1],n.SetImageData(e),n.TileSource=r,n}if(e._id=="555f46553ed65909dbc2e1bb"){var r=new SA.GigamacroSource;return r.Prefix="http://www.gigamacro.com/content/Bunton/leaf_fossil_04-30-2015/zoomify/",r.setDimensions(22590,10793),e.levels=r.Levels,e.dimensions=r.Dimensions,e.bounds=[0,e.dimensions[0]-1,0,e.dimensions[1]-1],n.SetImageData(e),n.TileSource=r,n}if(e._id=="555f465a3ed65909dbc2e1be"){var r=new SA.GigamacroSource;return r.Prefix="http://www.gigamacro.com/content/formsandsurfaces/maiden_hair_fern_v1_7-6-2012/zoomify/",r.setDimensions(22092,22025),e.levels=r.Levels,e.dimensions=r.Dimensions,e.bounds=[0,e.dimensions[0]-1,0,e.dimensions[1]-1],n.SetImageData(e),n.TileSource=r,n}if(e._id=="555f46623ed65909dbc2e1c1"){var r=new SA.GigamacroSource;return r.Prefix="http://www.gigamacro.com/content/gigamacro/nancy_plants_7-28-2014/zoomify/",r.setDimensions(40687,69306),e.levels=r.Levels,e.dimensions=r.Dimensions,e.bounds=[0,e.dimensions[0]-1,0,e.dimensions[1]-1],n.SetImageData(e),n.TileSource=r,n}return n.SetImageData(e),n};var e=function(e,t){this.Tiles=new Array(e*t),this.GridDims=[e,t]};e.prototype.SetTile=function(e){return this.Tiles[e.X+e.Y*this.GridDims[0]]=e},e.prototype.GetTile=function(e,t){return this.Tiles[e+t*this.GridDims[0]]},t.prototype.destructor=function(){},t.prototype.SetImageData=function(t){t.TileSize||(t.TileSize=256),this.Image=t,this.Levels=new Array(t.levels);for(var n=0;n<t.levels;++n){var r=t.levels-1-n;this.Levels[n]=new e(Math.ceil(t.dimensions[0]/(t.TileSize<<r)),Math.ceil(t.dimensions[1]/(t.TileSize<<r)))}this.TileSource||(this.TileSource=new SA.SlideAtlasSource,this.TileSource.Prefix="/tile?img="+t._id+"&db="+t.database+"&name="),this.Warp=null,this.RootSpacing=[1<<t.levels-1,1<<t.levels-1,10];if(t.type&&t.type=="stack"){this.NumberOfSections=t.dimensions[2],this.TileDimensions=[t.dimensions[0],t.dimensions[1]];var i;for(var s=1;s<=this.NumberOfSections;++s)i=this.GetTile(s,0,0),i.LoadQueueAdd();SA.LoadQueueUpdate()}else this.TileDimensions=[t.TileSize,t.TileSize],this.NumberOfSections=1},t.prototype.SetScene=function(e){var t={TileSize:e.tileSize,levels:e.numLevels,dimensions:e.dimensions,bounds:[0,e.dimensions[0],0,e.dimensions[1]]};this.SetImageData(t),this.TileSource=e},t.prototype.GetLeafSpacing=function(){return this.RootSpacing[0]/(1<<this.Image.levels-1)},t.prototype.GetBounds=function(){return this.Image&&this.Image.bounds?this.Image.bounds:[0,1e4,0,1e4]},t.prototype.ImageToWorld=function(e){return this.Warp?this.Warp.ImageToWorld(e):[e[0]+this.Origin[0],e[1]+this.Origin[1]]},t.prototype.WorldToImage=function(e){return this.Warp?this.Warp.WorldToImage(e):[e[0]-this.Origin[0],e[1]-this.Origin[1]]},t.prototype.GetSource=function(){return this.Source},t.prototype.LoadRoots=function(){var e;if(this.Image.dimensions==undefined)return;for(var t=1;t<=this.Image.dimensions[2];++t)e=this.GetTile(t,0,0),e.LoadQueueAdd();SA.LoadQueueUpdate();return},t.prototype.ChooseTiles=function(e,t,n){SA.AdvanceTimeStamp(),SA.Prune();var r=e.ViewportHeight,i=this.TileDimensions[1]*this.RootSpacing[1]/e.Height;i=i*r/this.TileDimensions[1];var s=0;while(i>1)++s,i*=.5;s>=this.Image.levels&&(s=this.Image.levels-1);var o=0,u=0,a=e.GetWidth()*.5,f=e.GetHeight()*.5,l=e.Roll,c=Math.sin(l),h=Math.cos(l),p,d;p=a*h+f*c,d=f*h-a*c,o<p&&(o=p),o<-p&&(o=-p),u<d&&(u=d),u<-d&&(u=-d),p=a*h-f*c,d=-f*h-a*c,o<p&&(o=p),o<-p&&(o=-p),u<d&&(u=d),u<-d&&(u=-d);var v=[];v[0]=e.FocalPoint[0]-o,v[1]=e.FocalPoint[0]+o,v[2]=e.FocalPoint[1]-u,v[3]=e.FocalPoint[1]+u;if(this.Warp){var m=this.WorldToImage([v[0],v[2]]);if(!m)return n.length=0,n;var g=[m[0],m[0],m[1],m[1]];m=this.WorldToImage([v[1],v[2]]);if(!m)return n.length=0,n;g[0]>m[0]&&(g[0]=m[0]),g[1]<m[0]&&(g[1]=m[0]),g[2]>m[1]&&(g[2]=m[1]),g[3]<m[1]&&(g[3]=m[1]),m=this.WorldToImage([v[0],v[3]]);if(!m)return n.length=0,n;g[0]>m[0]&&(g[0]=m[0]),g[1]<m[0]&&(g[1]=m[0]),g[2]>m[1]&&(g[2]=m[1]),g[3]<m[1]&&(g[3]=m[1]),m=this.WorldToImage([v[1],v[3]]);if(!m)return n.length=0,n;g[0]>m[0]&&(g[0]=m[0]),g[1]<m[0]&&(g[1]=m[0]),g[2]>m[1]&&(g[2]=m[1]),g[3]<m[1]&&(g[3]=m[1]),v=g}var y,b,n=[];for(var w=s;w>=0;--w){b=this.GetVisibleTileIds(w,v);for(var E=0;E<b.length;++E)y=this.GetTile(t,w,b[E]),y&&(y.LoadQueueAdd(),n.push(y))}return SA.LoadQueueUpdate(),n},t.prototype.GetVisibleTileIds=function(e,t){this.Image.bounds&&(t[0]=Math.max(t[0],this.Image.bounds[0]),t[1]=Math.min(t[1],this.Image.bounds[1]),t[2]=Math.max(t[2],this.Image.bounds[2]),t[3]=Math.min(t[3],this.Image.bounds[3]));var n,r=[],i=1<<e,s=[];s[0]=Math.floor(t[0]*i/(this.TileDimensions[0]*this.RootSpacing[0])),s[1]=Math.ceil(t[1]*i/(this.TileDimensions[0]*this.RootSpacing[0]))-1,s[2]=Math.floor(t[2]*i/(this.TileDimensions[1]*this.RootSpacing[1])),s[3]=Math.ceil(t[3]*i/(this.TileDimensions[1]*this.RootSpacing[1]))-1;var o=Math.floor((s[0]+s[1])*.5),u=Math.floor((s[2]+s[3])*.5),a=Math.max(o-s[0],s[1]-o,u-s[2],s[3]-u),f,l,c;while(a>0){for(c=-a;c<a;++c)f=o-a,l=u-c,f>=s[0]&&f<=s[1]&&l>=s[2]&&l<=s[3]&&r.push(f|l<<e),f=o+c,l=u-a,f>=s[0]&&f<=s[1]&&l>=s[2]&&l<=s[3]&&r.push(f|l<<e),f=o+a,l=u+c,f>=s[0]&&f<=s[1]&&l>=s[2]&&l<=s[3]&&r.push(f|l<<e),f=o-c,l=u+a,f>=s[0]&&f<=s[1]&&l>=s[2]&&l<=s[3]&&r.push(f|l<<e);a-=1}return r.push(o|u<<e),r},t.prototype.GetTileIdContainingPoint=function(e,t){var n=1<<e,r=Math.floor(t[0]*n),i=Math.floor(t[1]*n);r<0&&(r=0),r>=n&&(r=n-1),i<0&&(i=0),i>=n&&(i=n-1);var s=r|i<<e;return s},t.prototype.UpdateBranchTimeStamp=function(e){var t=GetCurrentTime();e.Children[0]!=null&&e.Children[0].BranchTimeStamp<t&&(t=e.Children[0].BranchTimeStamp),e.Children[1]!=null&&e.Children[1].BranchTimeStamp<t&&(t=e.Children[1].BranchTimeStamp),e.Children[2]!=null&&e.Children[2].BranchTimeStamp<t&&(t=e.Children[2].BranchTimeStamp),e.Children[3]!=null&&e.Children[3].BranchTimeStamp<t&&(t=e.Children[3].BranchTimeStamp),t==GetCurrentTime()&&(t=e.TimeStamp),t!=e.BranchTimeStamp&&(e.BranchTimeStamp=t,e.Parent!=null&&this.UpdateBranchTimeStamp(e.Parent))},t.prototype.GetTile=function(e,t,n){var r=1<<t,i=n&r-1,s=n>>t;return this.RecursiveGetTile(t,i,s,e)},t.prototype.RecursiveGetTile=function(e,t,n,r){if(!this.Levels[e])return null;var i=this.Levels[e].GetTile(t,n);if(i)return i;var i=new SA.Tile(t,n,r,e,this.TileSource.getTileUrl(e,t,n,r),this);this.Levels[e].SetTile(i);if(e>0){var s=this.RecursiveGetTile(e-1,t>>1,n>>1,r);s.Children[0]==null&&s.Children[1]==null&&s.Children[2]==null&&s.Children[3]==null&&(s.BranchTimeStamp=SA.GetCurrentTime());var o=t&1,u=n&1,a=o+2*u;s.Children[a]=i,i.Parent=s}return i},t.prototype.PruneTiles=function(){for(var e=0;e<this.Levels[0].Tiles.length;++e){var t=this.Levels[0].Tiles[e];t!=null&&(t.BranchTimeStamp<SA.PruneTimeTiles||t.BranchTimeStamp<SA.PruneTimeTextures)&&this.RecursivePruneTiles(t)}},t.prototype.RecursivePruneTiles=function(e){var t=!0;for(var n=0;n<4;++n){var r=e.Children[n];r!=null&&(t=!1,(r.BranchTimeStamp<SA.PruneTimeTiles||r.BranchTimeStamp<SA.PruneTimeTextures)&&this.RecursivePruneTiles(r))}if(t&&e.Parent!=null){e.BranchTimeStamp<SA.PruneTimeTextures&&e.DeleteTexture();if(e.BranchTimeStamp<SA.PruneTimeTiles){e.LoadState==1&&SA.LoadQueueRemove(e);var i=e.Parent;i.Children[0]==e?i.Children[0]=null:i.Children[1]==e?i.Children[1]=null:i.Children[2]==e?i.Children[2]=null:i.Children[3]==e&&(i.Children[3]=null),e.Parent=null,this.UpdateBranchTimeStamp(i),e.destructor()}}},SA.Cache=t})();(function(){"use strict";function t(){this.Matrix=mat4.create(),mat4.identity(this.Matrix),this.Caches=[],this.Markers=[]}var e=0;t.prototype.GetBounds=function(){var e=[0,1e4,0,1e4];for(var t=0;t<this.Caches.length;++t){var n=this.Caches[t],r=n.GetBounds();t==0?e=[r[0],r[1],r[2],r[3]]:(r[0]<e[0]&&(e[0]=r[0]),r[1]>e[1]&&(e[1]=r[1]),r[2]<e[2]&&(e[2]=r[2]),r[3]<e[3]&&(e[3]=r[3]))}return e},t.prototype.GetLeafSpacing=function(){if(!this.LeafSpacing)for(var e=0;e<this.Caches.length;++e){var t=this.Caches[e],n=t.GetLeafSpacing();if(!this.LeafSpacing||n<this.LeafSpacing)this.LeafSpacing=n}return this.LeafSpacing},t.prototype.LoadRoots=function(){for(var e=0;e<this.Caches.length;++e){var t=this.Caches[e];t&&t.LoadRoots()}},t.prototype.FindImage=function(e){for(var t=0;t<this.Caches.length;++t){var n=this.Caches[t];if(n.Image._id==e)return n}return null},t.prototype.Draw=function(t){var n=!0;if(t.gl){var r=t.ShaderProgram,i=t.gl;i.viewport(t.Viewport[0],t.Viewport[1],t.Viewport[2],t.Viewport[3]),i.uniformMatrix4fv(r.pMatrixUniform,!1,t.Camera.Matrix)}else{var s=1/t.Camera.Matrix[15];t.Context2d.transform(t.Camera.Matrix[0]*s,t.Camera.Matrix[1]*s,t.Camera.Matrix[4]*s,t.Camera.Matrix[5]*s,t.Camera.Matrix[12]*s,t.Camera.Matrix[13]*s)}for(var o=0;o<this.Caches.length;++o){var u=this.Caches[o];this.Tiles=u.ChooseTiles(t.Camera,e,t.Tiles);var a=this.Tiles.slice(0),f=[],l=0;while(l<a.length){var c=a[l];c.LoadState==3?f.push(c):(a[l].LoadState<3&&(n=!1),c.Parent),++l}for(var l=f.length-1;l>=0;--l)f[l].Draw(r,t)}return n},t.prototype.LoadTilesInView=function(t){for(var n=0;n<this.Caches.length;++n){var r=this.Caches[n];this.Tiles=r.ChooseTiles(t.Camera,e,t.Tiles)}},t.prototype.LoadTilesInView2=function(t){for(var n=0;n<this.Caches.length;++n){var r=this.Caches[n],i=r.ChooseTiles(t.Camera,e);for(var s=0;s<i.length;++s)i[s].LoadState=1,LOAD_QUEUE.push(i[s])}SA.LoadQueueUpdate()},t.prototype.LoadTilesInView=function(t){for(var n=0;n<this.Caches.length;++n)var r=this.Caches[n],i=r.ChooseTiles(t.Camera,e)},SA.Section=t})();(function(){"use strict";function e(e,t){SAM.View.call(this,e,t),this.Section=new SA.Section,this.Tiles=[],t&&(this.gl=this.Canvas[0].getContext("webgl")||this.Canvas[0].getContext("experimental-webgl")),this.gl?SA.initWebGL(this):this.Context2d=this.Canvas[0].getContext("2d")}e.prototype=new SAM.View,e.prototype.GetBounds=function(){return this.Section.GetBounds()},e.prototype.GetLeafSpacing=function(){return this.Section.GetLeafSpacing()},e.prototype.AddCache=function(e){if(!e)return;this.Section.Caches.push(e)},e.prototype.SetCache=function(e){e?this.Section.Caches=[e]:this.Section.Caches=[]},e.prototype.GetCache=function(){return this.Section.Caches[0]},e.prototype.Draw=function(){if(this.gl){var e=this.gl;e.clear(SA.GL.COLOR_BUFFER_BIT|SA.GL.DEPTH_BUFFER_BIT);var t=SA.imageProgram;e.useProgram(t),e.clearColor(1,1,1,1),e.disable(e.DEPTH_TEST),e.enable(e.BLEND)}return this.DrawTiles()};var t=!1;e.prototype.DrawTiles=function(){if(this.gl){if(t)return;return this.Section.Draw(this)}this.Clear(),this.Context2d.fillStyle="#ffffff",this.Context2d.setTransform(1,0,0,-1,0,this.Viewport[3]),this.Context2d.transform(.5*this.Viewport[2],0,0,.5*this.Viewport[3],.5*this.Viewport[2],.5*this.Viewport[3]);if(t)return;return this.Section.Draw(this)},SA.TileView=e})();(function(){"use strict";function u(t){var n=this;this.Parent=t,t.addClass("sa-viewer"),this.Div=$("<div>").appendTo(this.Parent).css({position:"relative","border-width":"0px",width:"100%",height:"100%","box-sizing":"border-box"}).addClass("sa-resize"),this.Div.saOnResize(function(){n.UpdateSize()}),this.Drawing=!1,this.RenderPending=!1,this.HistoryFlag=!1,this.InteractionState=e,this.InteractionListeners=[],this.InteractionEnabled=!0,this.AnimateLast,this.AnimateDuration=0,this.TranslateTarget=[0,0],this.MainView=new SA.TileView(this.Div,!1),this.MainView.OutlineColor=[0,0,0],this.MainView.Camera.ZRange=[0,1],this.MainView.Camera.ComputeMatrix(),this.Layers=[];if(!SAM.detectMobile()||SAM.MOBILE_DEVICE=="iPad")this.OverViewVisibility=!0,this.OverViewScale=.02,this.OverViewport=[80,20,180,180],this.OverViewDiv=$("<div>").appendTo(this.Div),this.OverView=new SA.TileView(this.OverViewDiv),this.OverView.Camera.ZRange=[-1,0],this.OverView.Camera.SetFocalPoint([13e3,11e3]),this.OverView.Camera.SetHeight(22e3),this.OverView.Camera.ComputeMatrix(),this.RotateIconHover=!1,this.RotateIconDrag=!1,this.RotateIcon=$("<img>").appendTo(this.OverView.CanvasDiv).attr("src",SA.ImagePathUrl+"rotate.png").addClass("sa-view-rotate").mouseenter(function(e){return n.RollEnter(e)}).mouseleave(function(e){return n.RollLeave(e)}).mousedown(function(e){return n.RollDown(e)}).attr("draggable","false").on("dragstart",function(){return!1}),this.OverViewDiv.css({"z-index":"200"});this.ZoomTarget=this.MainView.Camera.GetHeight(),this.RollTarget=this.MainView.Camera.Roll,this.DoubleClickX=0,this.DoubleClickY=0,this.StackCorrelations=undefined,this.RecordIndex=0;var n=this,r=this.MainView.CanvasDiv;r.on("mousedown.viewer",function(e){return n.HandleMouseDown(e)}),r.on("mousemove.viewer",function(e){return this.focus(),SA.FirefoxWhich(e),n.HandleMouseMove(e)}),$(document.body).on("mouseup.viewer",function(e){return n.HandleMouseUp(e),!0}),r.on("wheel.viewer",function(e){return n.HandleMouseWheel(e.originalEvent)}),r.on("touchstart.viewer",function(e){return n.HandleTouchStart(e.originalEvent)}),r.on("touchmove.viewer",function(e){return n.HandleTouchMove(e.originalEvent)}),r.on("touchend.viewer",function(e){return n.HandleTouchEnd(e.originalEvent),!0}),this.MainView.CanvasDiv.attr("tabindex","1"),r.on("keydown.viewer",function(e){return n.HandleKeyDown(e)});if(this.OverView){var r=this.OverView.CanvasDiv;r.on("mousedown.viewer",function(e){return n.HandleOverViewMouseDown(e)}),r.on("mouseup.viewer",function(e){return n.HandleOverViewMouseUp(e)}),r.on("mousemove.viewer",function(e){return n.HandleOverViewMouseMove(e)})}this.CopyrightWrapper=$("<div>").appendTo(this.MainView.CanvasDiv).addClass("sa-view-copyright"),SA.Session&&SA.Session.sessid=="560b5127a7a1412195d13685"&&(this.Icon=$("<img>").appendTo(this.MainView.CanvasDiv).attr("src","http://static1.squarespace.com/static/5126bbb4e4b08c2e6d1cb6e4/t/54e66f05e4b0440df79a5729/1424387847915/").prop("title","UC Davis").css({position:"absolute",bottom:"80px",left:"7px",width:"128px","z-index":"4"})),SA.Session&&SA.Session.sessid=="57504ba7a7a1411310dd2637"&&(this.Icon=$("<img>").appendTo(this.MainView.CanvasDiv).attr("src","https://slide-atlas.org/api/v2/sessions/53d9230fdd98b54fd71e8ed7/attachments/57518ce4a7a14113156b8166").prop("title","Philips").css({position:"absolute",bottom:"90px",left:"7px",width:"100px","z-index":"4"}));var i=this.NewAnnotationLayer(),s=new SA.AnnotationWidget(i,this)}function f(e){var t={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4","indianred ":"#cd5c5c","indigo ":"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgrey:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370d8",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#d87093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"};return typeof t[e.toLowerCase()]!="undefined"?t[e.toLowerCase()]:!1}var e=0,t=1,n=2,r=3,i=4,s=5,o=6;u.prototype.Delete=function(){this.Div.remove(),$(document.body).off("mouseup.viewer"),this.MainView.Delete(),this.OverView&&(this.OverView.Delete(),delete this.OverView),delete this.MainView,delete this.Parent,delete this.Div,delete this.InteractionListeners,delete this.RotateIcon,delete this.StackCorrelations,delete this.CopyrightWrapper},u.prototype.AddLayer=function(e){this.Layers.push(e)},u.prototype.GetAnnotationLayer=function(){for(var e=0;e<this.Layers.length;++e)if(this.Layers[e]instanceof SAM.AnnotationLayer)return this.Layers[e];return null},u.prototype.Record=function(e,t){t=t||0,e.ViewerRecords[t].CopyViewer(this)},u.prototype.ProcessArguments=function(e){e.overview!==undefined&&this.SetOverViewVisibility(e.overview),e.zoomWidget!==undefined&&this.SetZoomWidgetVisibility(e.zoomWidget),e.drawWidget!==undefined&&this.SetAnnotationWidgetVisibility(e.drawWidget),e.menu!==undefined&&(this.Menu||(this.Menu=new SA.ViewEditMenu(this,null)),this.Menu.SetVisibility(e.menu));if(e.tileSource){var t=e.tileSource.width,n=e.tileSource.height,r=new SA.Cache;r.TileSource=e.tileSource;var i=new SA.Note,s={levels:e.tileSource.maxLevel+1,dimensions:[t,n],bounds:[0,t-1,0,n-1],_id:i.TempId},o=new SA.ViewerRecord;o.Image=s,o.OverviewBounds=[0,t-1,0,n-1],o.Camera={FocalPoint:[t/2,n/2],Roll:0,Height:n},i.ViewerRecords.push(o),r.SetImageData(s),e.note=i}if(e.note){this.saNote=e.note;var u=this.saViewerIndex=e.viewerIndex||0;e.note.ViewerRecords[u].Apply(this),this.Parent.attr("sa-note-id",e.note.Id||e.note.TempId),this.Parent.attr("sa-viewer-index",this.saViewerIndex)}e.hideCopyright!=undefined&&this.SetCopyrightVisibility(!e.hideCopyright),e.interaction!==undefined&&this.SetInteractionEnabled(e.interaction)},u.prototype.SetViewerRecord=function(e){e.Apply(this)},u.prototype.SetNote=function(e,t){if(!e||t<0||t>=e.ViewerRecords.length){console.log("Cannot set viewer record of note");return}this.SetViewerRecord(e.ViewerRecords[t]),this.saNote=e,this.saViewerIndex=t},u.prototype.SetNoteFromId=function(e,t){var n=this,r=SA.GetNoteFromId(e);if(!r){r=new SA.Note;var n=this;return r.LoadViewId(e,function(){n.SetNote(r,t)}),r}return this.SetNote(r,t),r},u.prototype.SetOverViewVisibility=function(e){this.OverViewVisibility=e;if(!this.OverViewDiv)return;e?this.OverViewDiv.show():this.OverViewDiv.hide()},u.prototype.GetOverViewVisibility=function(){return this.OverViewVisibility},u.prototype.Hide=function(){this.MainView.CanvasDiv.hide(),this.OverView&&this.OverView.CanvasDiv.hide()},u.prototype.Show=function(){this.MainView.CanvasDiv.show(),this.OverView&&this.OverViewVisibility&&this.OverView.CanvasDiv.show()},u.prototype.EventuallyRender=function(e){if(!this.RenderPending){this.RenderPending=!0;var t=this;requestAnimFrame(function(){t.RenderPending=!1,t.Draw(),e&&t.TriggerInteraction()})}},u.prototype.RollEnter=function(e){this.RotateIconHover=!0,this.RotateIcon.addClass("sa-active")},u.prototype.RollLeave=function(e){this.RotateIconHover=!1,this.RotateIconDrag||this.RotateIcon.removeClass("sa-active")},u.prototype.RollDown=function(e){if(!this.OverView)return;this.RotateIconDrag=!0;var t=this.OverView.CanvasDiv,n=t.offset(),r=n.left+t.width()/2,i=n.top+t.height()/2;return this.RotateIconX=e.clientX-r,this.RotateIconY=e.clientY-i,!1},u.prototype.RollMove=function(e){if(!this.OverView)return;if(!this.RotateIconDrag)return;if(e.which!=1){this.RotateIconDrag=!1;return}var t=this.MainView.CanvasDiv.offset(),n=this.OverViewport[0]+this.OverViewport[2]/2,r=this.OverViewport[1]+this.OverViewport[3]/2,i=e.clientX-t.left-n,s=e.clientY-t.top-r,o=i*this.RotateIconY-s*this.RotateIconX,u=o/(i*i+s*s);return this.MainView.Camera.Roll-=u,this.UpdateCamera(),this.EventuallyRender(!0),this.RotateIconX=i,this.RotateIconY=s,!1},u.prototype.UpdateSize=function(){if(!this.MainView)return;this.MainView.UpdateCanvasSize()&&this.EventuallyRender();var e=this.GetAnnotationLayer();e&&e.UpdateSize();if(this.OverView){var t=this.MainView.GetWidth(),n=this.MainView.GetHeight(),r=t*n,i=this.GetOverViewBounds(),s=(i[1]-i[0])/(i[3]-i[2]),o=Math.sqrt(r*this.OverViewScale/s),u=o*s;if(o>n/2){o=n/2;var u=o*s;this.OverViewScale=u*o/r}var a=Math.sqrt(o*o+u*u)/2;this.OverViewport=[t-a-u/2,a-o/2,u,o],this.OverViewDiv.css({left:this.OverViewport[0]+"px",width:this.OverViewport[2]+"px",top:this.OverViewport[1]+"px",height:this.OverViewport[3]+"px"}),this.OverView.UpdateCanvasSize()}},u.prototype.RollUp=function(e){return this.RotateIconDrag=!1,this.RotateIconHover||this.RotateIcon.addClass("sa-active"),!1},u.prototype.GetMainCanvas=function(){return this.MainView.Canvas},u.prototype.OnInteraction=function(e){e?this.InteractionListeners.push(e):this.InteractionListeners=[]},u.prototype.TriggerInteraction=function(){for(var e=0;e<this.InteractionListeners.length;++e){var t=this.InteractionListeners[e];t()}},u.prototype.GetDiv=function(){return this.MainView.CanvasDiv},u.prototype.InitializeZoomGui=function(){this.ZoomTab=new SA.Tab(this.GetDiv(),SA.ImagePathUrl+"mag.png","zoomTab"),this.ZoomTab.Div.css({"box-sizing":"border-box",position:"absolute",bottom:"0px",right:"7px","z-index":"200"}).prop("title","Zoom scroll"),this.ZoomTab.Panel.addClass("sa-view-zoom-panel"),this.ZoomDisplay=$("<div>").appendTo(this.ZoomTab.Div).addClass("sa-view-zoom-text").html("");var e=this;this.ZoomDiv=$("<div>").appendTo(this.ZoomTab.Panel).addClass("sa-view-zoom-panel-div"),this.ZoomInButton=$("<img>").appendTo(this.ZoomDiv).addClass("sa-view-zoom-button sa-zoom-in").attr("type","image").attr("src",SA.ImagePathUrl+"zoomin2.png").click(function(){e.AnimateZoom(.5)}).attr("draggable","false").on("dragstart",function(){return!1}),this.ZoomOutButton=$("<img>").appendTo(this.ZoomDiv).addClass("sa-view-zoom-button sa-zoom-out").attr("type","image").attr("src",SA.ImagePathUrl+"zoomout2.png").click(function(){e.AnimateZoom(2)}).attr("draggable","false").on("dragstart",function(){return!1}),this.ZoomInButton.addClass("sa-active"),this.ZoomOutButton.addClass("sa-active")},u.prototype.UpdateZoomGui=function(){if(!this.ZoomDisplay)return;var e=this.GetCamera().GetHeight(),t=this.GetViewport()[3],n=40*t/e;n<2?n=n.toFixed(2):n<4?n=n.toFixed(1):n=Math.round(n),this.ZoomDisplay.html("x"+n),this.ZoomTarget=e},u.prototype.SaveImage=function(e){this.MainView.Canvas[0].toBlob(function(t){saveAs(t,e)},"image/png")},u.prototype.CancelLargeImage=function(){ClearFinishedLoadingCallbacks(),ClearQueue(),this.EventuallyRender(!1)},u.prototype.SaveLargeImage=function(e,t,n,r,i){var s=this,o=this.GetCache(),u=[0,0,t,n],a=this.GetCamera(),f=new SA.TileView;f.SetCache(o),f.Canvas.attr("width",t),f.Canvas.attr("height",n),f.SetViewport([0,0,t,n]);var l=f.Camera;l.SetFocalPoint(a.FocalPoint),l.Roll=a.Roll,l.Height=a.GetHeight(),l.Width=a.GetWidth(),l.ViewportWidth=t,l.ViewportHeight=n,l.ComputeMatrix();var c=o.ChooseTiles(l,0,[]);for(var h=0;h<c.length;++h)SA.LoadQueueAddTile(c[h]);SA.LoadQueueUpdate(),SA.AddFinishedLoadingCallback(function(){s.SaveLargeImage2(f,e,t,n,r,i)})},u.prototype.SaveLargeImage2=function(e,t,n,r,i,s){var o=t;if(i){var u=SA.display.GetNote(),a=t.indexOf(".");a<0?o=t+ZERO_PAD(u.StartIndex,4)+".png":o=t.substring(0,a)+ZERO_PAD(u.StartIndex,4)+t.substring(a,t.length)}console.log(o+" "+SA.LoadQueue.length+" "+SA.LoadingCount),e.Draw()||console.log("Sanity check failed. Not all tiles were available."),this.MainView.DrawShapes();for(var f=0;f<this.Layers.length;++f)this.Layers[f].Draw(e);e.Canvas[0].toBlob(function(e){saveAs(e,o)},"image/png");if(i){var u=SA.display.GetNote();if(u.StartIndex<u.ViewerRecords.length-1){SA.display.NavigationWidget.NextNote();var l=this;setTimeout(function(){l.SaveLargeImage(t,n,r,i,s)},1e3);return}}s()};var a;u.prototype.EventuallySaveImage=function(e,t){var n=this;SA.AddFinishedLoadingCallback(function(){n.SaveImage(e),t&&t()}),this.EventuallyRender(!1)},u.prototype.SaveStackImages=function(e){var t=this;SA.AddFinishedLoadingCallback(function(){t.SaveStackImage(e)}),this.EventuallyRender(!1)},u.prototype.SaveStackImage=function(e){var t=this,n=SA.display.GetNote(),r=e+ZERO_PAD(n.StartIndex,4);this.SaveImage(r),n.StartIndex<n.ViewerRecords.length-1&&(SA.display.NavigationWidget.NextNote(),SA.AddFinishedLoadingCallback(function(){t.SaveStackImage(e)}),this.EventuallyRender(!1))},u.prototype.SetOverViewBounds=function(e){this.OverViewBounds=e,this.OverView&&(this.OverView.Camera.SetHeight(e[3]-e[2]),this.OverView.Camera.SetFocalPoint([.5*(e[0]+e[1]),.5*(e[2]+e[3])]),this.OverView.Camera.ComputeMatrix())},u.prototype.GetOverViewBounds=function(){if(this.OverViewBounds)return this.OverViewBounds;var e=this.GetCache();if(e&&e.Image){if(e.Image.bounds)return e.Image.bounds;if(e.Image.dimensions){var t=e.Image.dimensions;return[0,t[0],0,t[1]]}}if(this.OverView){var n=this.OverView.Camera,r=n.GetHeight()/2,i=n.GetWidth()/2;return this.OverViewBounds=[n.FocalPoint[0]-i,n.FocalPoint[0]+i,n.FocalPoint[1]-r,n.FocalPoint[1]+r],this.OverViewBounds}return[0,1e4,0,1e4]},u.prototype.SetSection=function(e){if(e==null)return;this.MainView.Section=e,this.OverView&&(this.OverView.Section=e),this.EventuallyRender(!0)},u.prototype.SetCache=function(e){e&&e.Image&&(e.Image.bounds&&this.SetOverViewBounds(e.Image.bounds),e.Image.copyright==undefined&&(e.Image.copyright="Copyright 2016. All Rights Reserved."),this.CopyrightWrapper.html(e.Image.copyright)),this.MainView.SetCache(e);if(this.OverView){this.OverView.SetCache(e);if(e){var t=e.GetBounds();if(t){this.OverView.Camera.SetFocalPoint([(t[0]+t[1])/2,(t[2]+t[3])/2]);var n=t[3]-t[2],r=(t[1]-t[0])*this.OverView.Viewport[3]/this.OverView.Viewport[2];r>n&&(n=r),this.OverView.Camera.SetHeight(n),this.OverView.Camera.ComputeMatrix()}}}this.UpdateSize()},u.prototype.GetCache=function(){return this.MainView.GetCache()},u.prototype.SetViewport=function(e){if(this.OverView){var t=e[2]*e[3],n=this.GetOverViewBounds(),r=(n[1]-n[0])/(n[3]-n[2]),i=Math.sqrt(t*this.OverViewScale/r),s=i*r;if(i>e[3]/2){i=e[3]/2;var s=i*r;this.OverViewScale=s*i/t}var o=Math.sqrt(i*i+s*s)/2;this.OverViewport=[e[2]-o-s/2,e[1]+o-i/2,s,i],this.OverViewDiv.css({left:this.OverViewport[0]+"px",width:this.OverViewport[2]+"px",top:this.OverViewport[1]+"px",height:this.OverViewport[3]+"px"}),this.OverView.UpdateCanvasSize()}},u.prototype.GetViewport=function(){return this.MainView.Viewport},u.prototype.ToggleMirror=function(){this.MainView.Camera.Mirror=!this.MainView.Camera.Mirror,this.OverView&&(this.OverView.Camera.Mirror=!this.OverView.Camera.Mirror)},u.prototype.AnimateCamera=function(e,t,n){this.ZoomTarget=n,this.TranslateTarget[0]=e[0],this.TranslateTarget[1]=e[1],this.RollTarget=t,this.AnimateLast=(new Date).getTime(),this.AnimateDuration=200,this.EventuallyRender(!0)},u.prototype.UpdateCamera=function(){var e=this.MainView.Camera;this.ZoomTarget=e.Height,this.TranslateTarget[0]=e.FocalPoint[0],this.TranslateTarget[1]=e.FocalPoint[1],this.RollTarget=e.Roll,this.OverView&&(this.OverView.CanvasDiv.css({transform:"rotate("+e.Roll+"rad"}),this.OverView.Camera.Roll=0,this.OverView.Camera.ComputeMatrix()),this.MainView.Camera.ComputeMatrix(),this.UpdateZoomGui()},u.prototype.SetCamera=function(e,t,n){this.MainView.Camera.SetHeight(n),this.MainView.Camera.SetFocalPoint([e[0],e[1]]),this.MainView.Camera.Roll=t*3.14159265359/180,this.UpdateCamera(),this.EventuallyRender(!0)},u.prototype.GetCamera=function(){return this.MainView.Camera},u.prototype.AnimateZoomTo=function(e,t){if(this.AnimateDuration>0)return;SA.StackCursorFlag=!1,this.ZoomTarget=this.MainView.Camera.GetHeight()*e,this.ZoomTarget<.9/32&&(this.ZoomTarget=.9/32);var n=this.GetViewport()[3],r=Math.round(Math.log(32*n/this.ZoomTarget)/Math.log(2));this.ZoomTarget=32*n/Math.pow(2,r),e=this.ZoomTarget/this.MainView.Camera.GetHeight(),this.TranslateTarget[0]=t[0]-e*(t[0]-this.MainView.Camera.FocalPoint[0]),this.TranslateTarget[1]=t[1]-e*(t[1]-this.MainView.Camera.FocalPoint[1]),this.RollTarget=this.MainView.Camera.Roll,this.AnimateLast=(new Date).getTime(),this.AnimateDuration=200,this.EventuallyRender(!0)},u.prototype.AnimateZoom=function(e){this.MouseUpTime-=1e3;if(this.AnimateDuration>0)return;var t=this.GetCamera().GetFocalPoint();this.AnimateZoomTo(e,t)},u.prototype.AnimateTranslate=function(e,t){this.TranslateTarget[0]=this.MainView.Camera.FocalPoint[0]+e,this.TranslateTarget[1]=this.MainView.Camera.FocalPoint[1]+t,this.ZoomTarget=this.MainView.Camera.GetHeight(),this.RollTarget=this.MainView.Camera.Roll,this.AnimateLast=(new Date).getTime(),this.AnimateDuration=200,this.EventuallyRender(!0)},u.prototype.AnimateRoll=function(e){e*=Math.PI/180,this.RollTarget=this.MainView.Camera.Roll+e,this.ZoomTarget=this.MainView.Camera.GetHeight(),this.TranslateTarget[0]=this.MainView.Camera.FocalPoint[0],this.TranslateTarget[1]=this.MainView.Camera.FocalPoint[1],this.AnimateLast=(new Date).getTime(),this.AnimateDuration=200,this.EventuallyRender(!0)},u.prototype.AnimateTransform=function(e,t,n){this.TranslateTarget[0]=this.MainView.Camera.FocalPoint[0]+e,this.TranslateTarget[1]=this.MainView.Camera.FocalPoint[1]+t,this.RollTarget=this.MainView.Camera.Roll+n,this.ZoomTarget=this.MainView.Camera.GetHeight(),this.AnimateLast=(new Date).getTime(),this.AnimateDuration=200,this.EventuallyRender(!0)},u.prototype.DegToRad=function(e){return e*Math.PI/180},u.prototype.Draw=function(){SA&&SA.RootNote&&SA.RootNote.WaterMark?SA.WaterMark=!0:SA.WaterMark=!1;if(this.Drawing)return;this.Drawing=!0,this.Animate();if(!this.MainView||!this.MainView.Section)return;this.ConstrainCamera(),this.MainView.Draw()||this.EventuallyRender();for(var e=0;e<this.Layers.length;++e)this.Layers[e].Draw(this.MainView);this.MainView.DrawShapes(),this.OverView&&(this.OverView.Draw(),this.OverView.DrawOutline(!0)),this.OverView&&(this.MainView.Camera.Draw(this.OverView),this.HistoryFlag&&this.OverView.DrawHistory(this.MainView.Viewport[3]));var t=this.GetCache();if(t!=undefined)var n=t.Image.copyright;SA.StackCursorFlag&&SA.Edit&&(this.MainView.DrawFocalPoint(),this.StackCorrelations&&this.MainView.DrawCorrelations(this.StackCorrelations,this.RecordIndex)),SA.LoadQueueUpdate(),this.Drawing=!1},u.prototype.Reset=function(){this.MomentumX=0,this.MomentumY=0,this.MomentumRoll=0,this.MomentumScale=0,this.MomentumTimerId&&(window.cancelAnimationFrame(this.MomentumTimerId),this.MomentumTimerId=0),this.StartTouchTime=0,this.SetCache(null),this.MainView.ShapeList=[];for(var e=0;e<this.Layers.length;++e)this.Layers[e].Reset&&this.Layers[e].Reset()},u.prototype.AddShape=function(e){this.MainView.AddShape(e)},u.prototype.Animate=function(){if(this.AnimateDuration<=0)return;var e=(new Date).getTime();if(e>=this.AnimateLast+this.AnimateDuration){this.AnimateDuration=0,this.MainView.Camera.SetHeight(this.ZoomTarget),this.MainView.Camera.Roll=this.RollTarget;if(this.OverView){var t=this.RollTarget;this.OverView.CanvasDiv.css({transform:"rotate("+t+"rad"}),this.OverView.Camera.Roll=0,this.OverView.Camera.ComputeMatrix()}this.MainView.Camera.SetFocalPoint([this.TranslateTarget[0],this.TranslateTarget[1]]),this.UpdateZoomGui(),SA.RECORDER_WIDGET&&SA.RECORDER_WIDGET.RecordState()}else{var n=this.MainView.Camera.GetHeight(),r=this.MainView.Camera.GetFocalPoint(),i=this.MainView.Camera.Roll;this.MainView.Camera.SetHeight(n+(this.ZoomTarget-n)*(e-this.AnimateLast)/this.AnimateDuration),this.MainView.Camera.Roll=i+(this.RollTarget-i)*(e-this.AnimateLast)/this.AnimateDuration;if(this.OverView){var t=this.MainView.Camera.Roll;this.OverView.CanvasDiv.css({transform:"rotate("+t+"rad"}),this.OverView.Camera.Roll=0,this.OverView.Camera.ComputeMatrix()}this.MainView.Camera.SetFocalPoint([r[0]+(this.TranslateTarget[0]-r[0])*(e-this.AnimateLast)/this.AnimateDuration,r[1]+(this.TranslateTarget[1]-r[1])*(e-this.AnimateLast)/this.AnimateDuration]),this.AnimateDuration-=e-this.AnimateLast,this.EventuallyRender(!0)}this.MainView.Camera.ComputeMatrix(),this.OverView&&this.OverView.Camera.ComputeMatrix(),this.AnimateLast=e},u.prototype.OverViewPlaceCamera=function(e,t){if(!this.OverView)return;e/=this.OverView.Viewport[2],t/=this.OverView.Viewport[3],e=(e*2-1)*this.OverView.Camera.Matrix[15],t=(1-t*2)*this.OverView.Camera.Matrix[15];var n=this.OverView.Camera.Matrix,r=n[0]*n[5]-n[1]*n[4],i=(e*n[5]-t*n[4]+n[4]*n[13]-n[5]*n[12])/r,s=(t*n[0]-e*n[1]-n[0]*n[13]+n[1]*n[12])/r;this.TranslateTarget[0]=i,this.TranslateTarget[1]=s,this.AnimateLast=(new Date).getTime(),this.AnimateDuration=100,this.EventuallyRender(!0)},u.prototype.SetInteractionEnabled=function(e){this.InteractionEnabled=e},u.prototype.EnableInteraction=function(){this.InteractionEnabled=!0},u.prototype.DisableInteraction=function(){this.InteractionEnabled=!1},u.prototype.RecordMouseDown=function(e){this.LastMouseX=this.MouseX||0,this.LastMouseY=this.MouseY||0,this.LastMouseTime=this.MouseTime||0,this.SetMousePositionFromEvent(e),SA.LinkDiv&&SA.LinkDiv.is(":visible")&&SA.LinkDiv.fadeOut(),typeof FAVORITES_WIDGET!="undefined"&&FAVORITES_WIDGET.hidden==0&&FAVORITES_WIDGET.ShowHideFavorites();var t=new Date,n=t.getTime()-this.MouseUpTime;n<200&&(this.DoubleClick=!0)},u.prototype.SetMousePositionFromEvent=function(e){e.offsetX&&e.offsetY?(this.MouseX=e.offsetX,this.MouseY=e.offsetY,this.MouseTime=(new Date).getTime()):e.layerX&&e.layerY&&(this.MouseX=e.layerX,this.MouseY=e.layerY,this.MouseTime=(new Date).getTime(),e.offsetX=e.layerX,e.offsetY=e.layerY)},u.prototype.RecordMouseMove=function(e){return this.LastMouseX=this.MouseX,this.LastMouseY=this.MouseY,this.LastMouseTime=this.MouseTime,this.SetMousePositionFromEvent(e),this.MouseDeltaX=this.MouseX-this.LastMouseX,this.MouseDeltaY=this.MouseY-this.LastMouseY,this.MouseDeltaTime=this.MouseTime-this.LastMouseTime,this.MouseDeltaX!=0||this.MouseDeltaY!=0},u.prototype.RecordMouseUp=function(e){this.SetMousePositionFromEvent(e),this.MouseDown=!1;var t=new Date;this.MouseUpTime=t.getTime(),this.DoubleClick=!1},u.prototype.HandleTouch=function(e,t){var n=new Date,r=n.getTime();if(r-this.Time<20&&!t)return!1;this.LastTime=this.Time,this.Time=r;if(!e)var e=event;var i=this.GetViewport();this.LastTouches=this.Touches;var s=this.Canvas;this.Touches=[];for(var o=0;o<e.targetTouches.length;++o){var u=this.MainView.Canvas.offset(),a=e.targetTouches[o].pageX-u.left,f=e.targetTouches[o].pageY-u.top;this.Touches.push([a,f])}this.LastMouseX=this.MouseX,this.LastMouseY=this.MouseY;var l=this.Touches.length;this.MouseX=this.MouseY=0;for(var o=0;o<l;++o)this.MouseX+=this.Touches[o][0],this.MouseY+=this.Touches[o][1];return this.MouseX=this.MouseX/l,this.MouseY=this.MouseY/l,this.offsetX=this.MouseX,this.offsetY=this.MouseY,!0},u.prototype.HandleTouchStart=function(e){if(!this.InteractionEnabled)return!0;this.HandleTouch(e,!0),this.StartTouchTime=this.Time,SA.TriggerStartInteraction(),this.MomentumX=0,this.MomentumY=0,this.MomentumRoll=0,this.MomentumScale=0,this.MomentumTimerId&&(window.cancelAnimationFrame(this.MomentumTimerId),this.MomentumTimerId=0);if(this.Touches.length>=4){var t=this.GetCamera(),n=this.MainView.Section.GetBounds();return t.SetFocalPoint([(n[0]+n[1])*.5,(n[2]+n[3])*.5]),t.Roll=0,t.SetHeight(n[3]-n[2]),t.ComputeMatrix(),this.EventuallyRender(),!0}return!1},u.prototype.HandleTouchMove=function(e){if(this.StartTouchTime==0)return!1;if(!this.HandleTouch(e,!1))return;SA.display.NavigationWidget&&SA.display.NavigationWidget.Visibility&&SA.display.NavigationWidget.ToggleVisibility(),typeof MOBILE_ANNOTATION_WIDGET!="undefined"&&MOBILE_ANNOTATION_WIDGET.Visibility&&MOBILE_ANNOTATION_WIDGET.ToggleVisibility();var t=this.MainView.CanvasDiv.width(),n=1e3*(this.MouseX-this.LastMouseX)/((this.Time-this.LastTime)*t);console.log(n);if(SA.display.NavigationWidget){if(n>4)return SA.display.NavigationWidget.PreviousNote(),!1;if(n<-4)return SA.display.NavigationWidget.NextNote(),!1}if(this.Touches.length==1){this.HandleTouchPan(this);return}if(this.Touches.length==2){this.HandleTouchPinch(this);return}if(this.Touches.length==3){this.HandleTouchRotate(this);return}},u.prototype.HandleTouchPan=function(e){if(!this.InteractionEnabled)return!0;if(this.Touches.length!=1||this.LastTouches.length!=1)return;this.MomentumTimerId&&(window.cancelAnimationFrame(this.MomentumTimerId),this.MomentumTimerId=0);var t=this.ConvertPointViewerToWorld(this.LastMouseX,this.LastMouseY),n=this.ConvertPointViewerToWorld(this.MouseX,this.MouseY),r=n[0]-t[0],i=n[1]-t[1],s=e.Time-this.LastTime,o=r/s,u=i/s,a=Math.min(this.Time-this.LastTime,250)/250;this.MomentumX+=(o-this.MomentumX)*a,this.MomentumY+=(u-this.MomentumY)*a,this.MomentumRoll=0,this.MomentumScale=0;var f=this.GetCamera();f.Translate(-r,-i,0),f.ComputeMatrix(),this.EventuallyRender(!0)},u.prototype.HandleTouchRotate=function(e){if(!this.InteractionEnabled)return!0;var t=this.Touches.length;if(this.LastTouches.length!=t||t!=3)return;this.MomentumTimerId&&(window.cancelAnimationFrame(this.MomentumTimerId),this.MomentumTimerId=0);var n=this.ConvertPointViewerToWorld(this.LastMouseX,this.LastMouseY),r=this.ConvertPointViewerToWorld(this.MouseX,this.MouseY),i=e.Time-this.LastTime,s,o,u=0;for(var a=0;a<t;++a){s=this.LastTouches[a][0]-this.LastMouseX,o=this.LastTouches[a][1]-this.LastMouseY;var f=Math.atan2(o,s);s=this.Touches[a][0]-this.MouseX,o=this.Touches[a][1]-this.MouseY,f-=Math.atan2(o,s),f>Math.PI&&(f-=2*Math.PI),f<-Math.PI&&(f+=2*Math.PI),u+=f}u/=t;var l=this.GetCamera();n[0]=l.FocalPoint[0]-r[0],n[1]=l.FocalPoint[1]-r[1];var c=Math.cos(u),h=Math.sin(u);s=r[0]+(n[0]*c-n[1]*h),o=r[1]+(n[0]*h+n[1]*c);var p=u/i;this.MomentumX=0,this.MomentumY=0,this.MomentumRoll=(this.MomentumRoll+p)*.5,this.MomentumScale=0,l.Roll=l.Roll-u,l.ComputeMatrix();if(this.OverView){var d=this.OverView.Camera;d.Roll=l.Roll,d.ComputeMatrix()}this.EventuallyRender(!0)},u.prototype.HandleTouchPinch=function(e){if(!this.InteractionEnabled)return!0;var t=this.Touches.length;if(this.LastTouches.length!=t||t!=2)return;this.MomentumTimerId&&(window.cancelAnimationFrame(this.MomentumTimerId),this.MomentumTimerId=0);var n=this.ConvertPointViewerToWorld(this.LastMouseX,this.LastMouseY),r=this.ConvertPointViewerToWorld(this.MouseX,this.MouseY),i=e.Time-this.LastTime;if(i==0)return;var s=1,o=0,u=0;for(var a=0;a<t;++a)l=this.LastTouches[a][0]-this.LastMouseX,c=this.LastTouches[a][1]-this.LastMouseY,o+=Math.sqrt(l*l+c*c),l=this.Touches[a][0]-this.MouseX,c=this.Touches[a][1]-this.MouseY,u+=Math.sqrt(l*l+c*c);if(o<2||u<2)return;s=u/o;var f=this.GetCamera();n[0]=f.FocalPoint[0]-r[0],n[1]=f.FocalPoint[1]-r[1];var l=r[0]+n[0]/s,c=r[1]+n[1]/s,h=(s-1)/i;this.MomentumX=0,this.MomentumY=0,this.MomentumRoll=0,this.MomentumScale=(this.MomentumScale+h)*.5,f.FocalPoint[0]=l,f.FocalPoint[1]=c,f.SetHeight(f.GetHeight()/s),f.ComputeMatrix(),this.EventuallyRender(!0)},u.prototype.HandleTouchEnd=function(e){if(!this.InteractionEnabled)return!0;var t=(new Date).getTime();this.LastTime=this.Time,this.Time=t;var n=Math.min(this.Time-this.LastTime,250)/250;this.MomentumX=this.MomentumX*(1-n),this.MomentumY=this.MomentumY*(1-n),this.MomentumRoll=this.MomentumRoll*(1-n),this.MomentumScale=this.MomentumScale*(1-n),t-=this.StartTouchTime;if(e.targetTouches.length==0&&SAM.MOBILE_DEVICE){this.StartTouchTime=0;if(t<90){SA.display&&SA.display.NavigationWidget&&SA.display.NavigationWidget.ToggleVisibility(),typeof MOBILE_ANNOTATION_WIDGET!="undefined"&&MOBILE_ANNOTATION_WIDGET.ToggleVisibility();return}if(this.ActiveWidget!=null){this.ActiveWidget.HandleTouchEnd(e);return}this.HandleMomentum()}this.HandleMomentum(e),this.StartTouchTime=0},u.prototype.HandleMomentum=function(){this.MomentumTimerId&&(window.cancelAnimationFrame(this.MomentumTimerId),this.MomentumTimerId=0);var t=(new Date).getTime();if(t-this.LastTime<50){var n=this;this.MomentumTimerId=requestAnimFrame(function(){n.HandleMomentum()});return}this.LastTime=this.Time,this.Time=t;var r=this.Time-this.LastTime,i=200,s=Math.exp(-r/i),o=-i*s+i,u=this.MainView.Camera;u.Translate(-(this.MomentumX*o),-(this.MomentumY*o),0),u.SetHeight(u.Height/(this.MomentumScale*o+1)),u.Roll=u.Roll-this.MomentumRoll*o,u.ComputeMatrix();if(this.OverView){var a=this.OverView.Camera;a.Roll=u.Roll,a.ComputeMatrix()}this.Draw(),this.MomentumX*=s,this.MomentumY*=s,this.MomentumScale*=s,this.MomentumRoll*=s;if(Math.abs(this.MomentumX)<.01&&Math.abs(this.MomentumY)<.01&&Math.abs(this.MomentumRoll)<2e-4&&Math.abs(this.MomentumScale)<5e-5)this.MomentumTimerId=0,this.InteractionState!=e&&(this.InteractionState=e,SA.RECORDER_WIDGET&&SA.RECORDER_WIDGET.RecordState()),this.UpdateZoomGui();else{var n=this;this.MomentumTimerId=requestAnimFrame(function(){n.HandleMomentum()})}},u.prototype.ConstrainCamera=function(){var e=this.GetOverViewBounds();if(!e)return;var t=this.MainView.GetLeafSpacing(),n=this.MainView.GetViewport(),r=this.MainView.Camera,i=!1;r.FocalPoint[0]<e[0]&&(r.SetFocalPoint([e[0],r.FocalPoint[1]]),i=!0),r.FocalPoint[0]>e[1]&&(r.SetFocalPoint([e[1],r.FocalPoint[1]]),i=!0),r.FocalPoint[1]<e[2]&&(r.SetFocalPoint([r.FocalPoint[0],e[2]]),i=!0),r.FocalPoint[1]>e[3]&&(r.SetFocalPoint([r.FocalPoint[0],e[3]]),i=!0);var s=2*(e[3]-e[2]);r.GetHeight()>s&&(r.SetHeight(s),this.ZoomTarget=s,i=!0);var o=n[3]*t*.5;r.GetHeight()<o&&(r.SetHeight(o),this.ZoomTarget=o,i=!0),i&&r.ComputeMatrix()},u.prototype.HandleMouseDown=function(e){return this.InteractionEnabled?(this.FireFoxWhich=e.which,e.preventDefault(),this.RecordMouseDown(e),this.RotateIconDrag&&(this.RotateIconDrag=!1),this.DoubleClick?(e.preventDefault(),this.HandleDoubleClick(e)):e.which==1?(e.ctrlKey?this.InteractionState=n:e.altKey?this.InteractionState=r:this.InteractionState=t,!1):e.which==2?(this.InteractionState=n,!1):!0):!0},u.prototype.HandleDoubleClick=function(e){if(!this.InteractionEnabled)return!0;var t=this.ConvertPointViewerToWorld(e.offsetX,e.offsetY);return e.which==1?this.AnimateZoomTo(.5,t):e.which==3&&this.AnimateZoomTo(2,t),!0},u.prototype.HandleMouseUp=function(t){if(!this.InteractionEnabled)return!0;var n=new Date;return this.MouseUpTime=n.getTime(),this.FireFoxWhich=0,this.RecordMouseUp(t),this.RotateIconDrag?(this.RollUp(t),!1):this.InteractionState==i||this.InteractionState==s?this.HandleOverViewMouseUp(t):(this.InteractionState!=e&&(this.InteractionState=e,SA.RECORDER_WIDGET&&SA.RECORDER_WIDGET.RecordState()),!1)},u.prototype.HandleMouseMove=function(o){if(!this.InteractionEnabled)return!0;if($(o.target).width()!=$(o.currentTarget).width())return!0;if(!this.RecordMouseMove(o))return!0;if(this.RotateIconDrag)return this.RollMove
(o),!1;if(this.InteractionState==i||this.InteractionState==s)return this.HandleOverViewMouseMove(o);if(this.InteractionState==e)return!0;var u=o.offsetX,a=o.offsetY;if(this.InteractionState==n){var f=u-this.MainView.Viewport[2]*.5,l=a-this.MainView.Viewport[3]*.5;this.MainView.Camera.HandleRoll(f,l,this.MouseDeltaX,this.MouseDeltaY),this.RollTarget=this.MainView.Camera.Roll,this.UpdateCamera()}else if(this.InteractionState==r){var c=this.MouseDeltaY/this.MainView.Viewport[2];this.MainView.Camera.SetHeight(this.MainView.Camera.GetHeight()/(1+c*5)),this.ZoomTarget=this.MainView.Camera.GetHeight(),this.UpdateCamera()}else if(this.InteractionState==t){var h=-this.MouseDeltaX/this.MainView.Viewport[2],c=-this.MouseDeltaY/this.MainView.Viewport[2],p=Math.sqrt(h*h+c*c)/this.MouseDeltaTime;p=1+p*1e3,p>3&&(p=3),h*=p,c*=p,this.MainView.Camera.HandleTranslate(h,c,0)}this.TriggerInteraction(),this.EventuallyRender(!0);var u=o.offsetX,a=o.offsetY;return!1},u.prototype.HandleMouseWheel=function(e){if(!this.InteractionEnabled)return!0;e.offsetX||(e.offsetX=e.layerX,e.offsetY=e.layerY);var t=0;e.deltaY?t=e.deltaY:e.wheelDelta&&(t=e.wheelDelta),t>0?this.ZoomTarget*=1.1:t<0&&(this.ZoomTarget/=1.1);var n=this.ConvertPointViewerToWorld(e.offsetX,e.offsetY),r=this.ZoomTarget/this.MainView.Camera.GetHeight();return this.TranslateTarget[0]=n[0]-r*(n[0]-this.MainView.Camera.FocalPoint[0]),this.TranslateTarget[1]=n[1]-r*(n[1]-this.MainView.Camera.FocalPoint[1]),this.RollTarget=this.MainView.Camera.Roll,this.AnimateLast=(new Date).getTime(),this.AnimateDuration=200,this.EventuallyRender(!0),!1},u.prototype.HandleKeyDown=function(e){if(!this.InteractionEnabled)return!0;if(e.keyCode==83&&e.ctrlKey)return SAVING_IMAGE||(SAVING_IMAGE=new SAM.Dialog,SAVING_IMAGE.Title.text("Saving"),SAVING_IMAGE.Body.css({margin:"1em 2em"}),SAVING_IMAGE.WaitingImage=$("<img>").appendTo(SAVING_IMAGE.Body).attr("src",SA.ImagePathUrl+"circular.gif").attr("alt","waiting...").addClass("sa-view-save"),SAVING_IMAGE.ApplyButton.hide(),SAVING_IMAGE.SavingFlag=!1,SAVING_IMAGE.Count=0),SAVING_IMAGE.SavingFlag||(SAVING_IMAGE.SavingFlag=!0,SAVING_IMAGE.Show(1),this.EventuallySaveImage("slideAtlas"+ZERO_PAD(SAVING_IMAGE.Count,3),function(){SAVING_IMAGE.SavingFlag=!1,SAVING_IMAGE.Count+=1,SAVING_IMAGE.Hide()})),!1;if(e.keyCode==86&&e.ctrlKey){var t=JSON.parse(localStorage.ClipBoard),n;t.Camera&&(n=new SAM.Camera,n.Load(t.Camera));if(t.Type=="CircleWidget"){var r=new SAM.CircleWidget(this,!1);r.PasteCallback(t.Data,this.MouseWorld,n)}if(t.Type=="PolylineWidget"){var r=new SAM.PolylineWidget(this,!1);r.PasteCallback(t.Data,this.MouseWorld,n)}if(t.Type=="TextWidget"){var r=new SAM.TextWidget(this,"");r.PasteCallback(t.Data,this.MouseWorld,n)}if(t.Type=="RectWidget"){var r=new SAM.RectWidget(this,"");r.PasteCallback(t.Data,this.MouseWorld,n)}if(t.Type=="GridWidget"){var r=new SAM.GridWidget(this,"");r.PasteCallback(t.Data,this.MouseWorld,n)}return!1}if(String.fromCharCode(e.keyCode)=="R")return this.MainView.Camera.ComputeMatrix(),this.ZoomTarget=this.MainView.Camera.GetHeight(),this.EventuallyRender(!0),!1;if(e.keyCode==38){var i=this.GetCamera(),s=Math.cos(i.Roll),o=-Math.sin(i.Roll),u=0,a=-0.9*i.GetHeight(),f=u*s-a*o,l=u*o+a*s;return this.TranslateTarget[0]=i.FocalPoint[0]+f,this.TranslateTarget[1]=i.FocalPoint[1]+l,this.AnimateLast=(new Date).getTime(),this.AnimateDuration=200,this.EventuallyRender(!0),!1}if(e.keyCode==40){var i=this.GetCamera(),s=Math.cos(i.Roll),o=-Math.sin(i.Roll),u=0,a=.9*i.GetHeight(),f=u*s-a*o,l=u*o+a*s;return this.TranslateTarget[0]=i.FocalPoint[0]+f,this.TranslateTarget[1]=i.FocalPoint[1]+l,this.AnimateLast=(new Date).getTime(),this.AnimateDuration=200,this.EventuallyRender(!0),!1}if(e.keyCode==37){var i=this.GetCamera(),s=Math.cos(i.Roll),o=-Math.sin(i.Roll),u=-0.9*i.GetWidth(),a=0,f=u*s-a*o,l=u*o+a*s;return this.TranslateTarget[0]=i.FocalPoint[0]+f,this.TranslateTarget[1]=i.FocalPoint[1]+l,this.AnimateLast=(new Date).getTime(),this.AnimateDuration=200,this.EventuallyRender(!0),!1}if(e.keyCode==39){var i=this.GetCamera(),s=Math.cos(i.Roll),o=-Math.sin(i.Roll),u=.9*i.GetWidth(),a=0,f=u*s-a*o,l=u*o+a*s;return this.TranslateTarget[0]=i.FocalPoint[0]+f,this.TranslateTarget[1]=i.FocalPoint[1]+l,this.AnimateLast=(new Date).getTime(),this.AnimateDuration=200,this.EventuallyRender(!0),!1}return!0},u.prototype.GetPixelsPerUnit=function(){return this.MainView.GetPixelsPerUnit()},u.prototype.GetMetersPerUnit=function(){return this.MainView.GetMetersPerUnit()},u.prototype.ConvertPointWorldToViewer=function(e,t){var n=this.MainView.Camera;return n.ConvertPointWorldToViewer(e,t)},u.prototype.ConvertPointViewerToWorld=function(e,t){var n=this.MainView.Camera;return n.ConvertPointViewerToWorld(e,t)},u.prototype.OverViewCheckActive=function(e){if(!this.OverView)return!1;var t=e.offsetX,n=e.offsetY,r=this.OverViewport[2]/2,i=this.OverViewport[3]/2,s=this.OverViewport[0]+r,o=this.OverViewport[1]+i;t-=s,n-=o;var u=this.MainView.Camera.Roll,a=Math.cos(u),f=Math.sin(u),l=Math.abs(a*t+f*n),c=Math.abs(a*n-f*t);Math.abs(r-l)<5&&c<i||Math.abs(i-c)<5&&l<r?(this.OverViewActive=!0,this.OverView.CanvasDiv.addClass("sa-view-overview-canvas sa-active")):(this.OverViewActive=!1,this.OverView.CanvasDiv.removeClass("sa-view-overview-canvas sa-active"))},u.prototype.HandleOverViewMouseDown=function(e){if(!this.InteractionEnabled)return!0;if(this.RotateIconDrag)return;return this.InteractionState=i,this.OverviewEventX=e.pageX,this.OverviewEventY=e.pageY,!1},u.prototype.HandleOverViewMouseUp=function(t){if(!this.InteractionEnabled)return!0;if(this.RotateIconDrag)return;if(this.InteractionState==s){this.InteractionState=e;return}this.RollTarget=this.MainView.Camera.Roll;if(t.which==1){var n=t.offsetX,r=t.offsetY;n==undefined&&(n=t.layerX),r==undefined&&(r=t.layerY),this.OverViewPlaceCamera(n,r)}return this.InteractionState=e,!1},u.prototype.HandleOverViewMouseMove=function(e){if(!this.InteractionEnabled)return!0;if(this.RotateIconDrag)return this.RollMove(e),!1;if(this.InteractionState==i){if(Math.abs(e.pageX-this.OverviewEventX)>5||Math.abs(e.pageY-this.OverviewEventY)>5){this.InteractionState=s;var t=this.GetViewport()[2],n=Math.max(t-e.pageX,e.pageY);this.OverViewScaleLast=n}return!1}if(this.InteractionState!==s)return!0;var t=this.GetViewport()[2],n=Math.max(t-e.pageX,e.pageY),r=n/this.OverViewScaleLast;return this.OverViewScale*=r*r,this.OverViewScaleLast=n,n<60?this.RotateIcon.hide():this.RotateIcon.show(),this.UpdateSize(),!1},u.prototype.HandleOverViewMouseWheel=function(e){if(!this.InteractionEnabled)return!0;var t=0;return e.deltaY?t=e.deltaY:e.wheelDelta&&(t=e.wheelDelta),t>0?this.OverViewScale*=1.2:t<0&&(this.OverViewScale/=1.2),this.UpdateSize(),!0},u.prototype.SetAnnotationWidgetVisibility=function(e){if(this.Layers.length==0)return;var t=this.GetAnnotationLayer();if(!t)return;e?(t.AnnotationWidget||(t.AnnotationWidget=new SA.AnnotationWidget(t)),t.AnnotationWidget.show()):t.AnnotationWidget&&t.AnnotationWidget.hide()},u.prototype.SetZoomWidgetVisibility=function(e){e?(this.ZoomTab||this.InitializeZoomGui(),this.ZoomTab.show()):this.ZoomTab&&this.ZoomTab.hide()},u.prototype.SetCopyrightVisibility=function(e){e?this.CopyrightWrapper.show():this.CopyrightWrapper.hide()},u.prototype.GetNumberOfLayers=function(){return this.Layers.length},u.prototype.GetLayer=function(e){return e>=0&&e<this.Layers.length?this.Layers[e]:null},u.prototype.NewAnnotationLayer=function(){var e=new SAM.AnnotationLayer(this.Div);return this.AddLayer(e),e.ScaleWidget.View=this.MainView,e.Viewer=this,e},u.prototype.ClearAnnotations=function(){var e=this.GetAnnotationLayer();e&&(e.Reset(),e.EventuallyDraw())},u.prototype.AddAnnotation=function(e){var t=this.GetAnnotationLayer();if(t)return t.EventuallyDraw(),t.LoadWidget(e)},SA.Viewer=u})();(function(){"use strict";function e(){this.point0=[0,0],this.point1=[0,0],this.Roll=0,this.Height=0}function t(){this.Correlations=[]}e.prototype.Serialize=function(){return{point0:[this.point0[0],this.point0[1]],point1:[this.point1[0],this.point1[1]],roll:this.Roll,height:this.Height}},e.prototype.Load=function(e){this.point0[0]=e.point0[0],this.point0[1]=e.point0[1],this.point1[0]=e.point1[0],this.point1[1]=e.point1[1],e.roll&&(this.Roll=e.roll),e.height&&(this.Height=e.height)},e.prototype.GetRoll=function(e){return e!==undefined&&e==0?-this.Roll:this.Roll},e.prototype.GetPoint=function(e){return e==0?this.GetPoint0():e==1?this.GetPoint1():(alert("Bad correlation point index: "+e),[0,0])},e.prototype.GetPoint0=function(){return[this.point0[0],this.point0[1]]},e.prototype.SetPoint0=function(e){this.point0[0]=e[0],this.point0[1]=e[1]},e.prototype.GetPoint1=function(){return[this.point1[0],this.point1[1]]},e.prototype.SetPoint1=function(e){this.point1[0]=e[0],this.point1[1]=e[1]},e.prototype.SetRoll=function(e){this.Roll=e},e.prototype.SetHeight=function(e){this.Height=e},t.prototype.Serialize=function(){return JSON.parse(JSON.stringify(this))},t.prototype.Load=function(e){for(ivar in e)this[ivar]=e[ivar]},t.prototype.AddCorrelation=function(e,t){index=this.Correlations.length;var n=new SA.PairCorrelation;return n.SetPoint0(e),n.SetPoint1(t),this.Correlations.push(n),index},t.prototype.Load=function(e){e.View0&&(this.View0=e.View0),e.View1&&(this.View1=e.View1);for(var t=0;t<e.Correlations.length;++t){var n=new SA.PairCorrelation;n.Load(e.Correlations[t]),this.Correlations.push(n)}},t.prototype.WeightedTransform=function(e,t,n,r){var i=[n[0],n[1]];if(this.Correlations.length==0)return i;r===undefined&&(r=2e4);if(this.Correlations.length==0)return i[0]=n[0],i[1]=n[1],this.DeltaRoll=0,i;if(this.Correlations.length<=1){var s=this.Correlations[0];this.DeltaRoll=s.GetRoll(t),l=s.GetPoint(e);var o=n[0]-l[0],u=n[1]-l[1],a=Math.cos(this.DeltaRoll),f=Math.sin(this.DeltaRoll);return c=s.GetPoint(t),i[0]=a*o+f*u+c[0],i[1]=a*u-f*o+c[1],i}var l,c,h,p,d=r*r,v=0,m=[0,0],g=[0,0];for(var y=0;y<this.Correlations.length;++y){var s=this.Correlations[y];l=s.GetPoint(e),c=s.GetPoint(t),h=l[0]-n[0],p=l[1]-n[1];var b=h*h+p*p,w=Math.max(Math.exp(-b/d),1e-7);v+=w,m[0]+=w*l[0],m[1]+=w*l[1],g[0]+=w*c[0],g[1]+=w*c[1]}m[0]=m[0]/v,m[1]=m[1]/v,g[0]=g[0]/v,g[1]=g[1]/v,this.DeltaRoll=0;var E=0,v=0,S=0;for(var y=0;y<this.Correlations.length;++y){var s=this.Correlations[y];l=s.GetPoint(e),c=s.GetPoint(t),h=l[0]-n[0],p=l[1]-n[1];var x=h*h+p*p,w=Math.max(Math.exp(-x/d),1e-7);h=l[0]-m[0],p=l[1]-m[1];var T=Math.atan2(h,p),N=h*h+p*p;h=c[0]-g[0],p=c[1]-g[1];var C=Math.atan2(h,p),k=h*h+p*p;w*=Math.sqrt(Math.min(N,k));var L=C-T,A=Math.PI*2;while(L>Math.PI)L-=A;while(L<-Math.PI)L+=A;S+=L*w,v+=w}v>0&&(E=S/v),this.DeltaRoll=S/v,i[0]-=m[0],i[1]-=m[1];var a=Math.cos(E),f=Math.sin(E),h=a*i[0]+f*i[1],p=a*i[1]-f*i[0];return i[0]=h+g[0],i[1]=p+g[1],i},t.prototype.ForwardTransform=function(e,t){return this.DeltaRoll=0,this.Correlations.length==0?e:this.WeightedTransform(0,1,e,t)},t.prototype.ReverseTransform=function(e,t){return this.DeltaRoll=0,this.Correlations.length==0?e:this.WeightedTransform(1,0,e,t)},t.prototype.ForwardTransformCamera=function(e,t){t.FocalPoint=this.ForwardTransform(e.FocalPoint,e.Height/2),t.Roll=e.Roll+this.DeltaRoll,t.Height=e.Height,t.Width=t.Height*t.ViewportWidth/t.ViewportHeight},t.prototype.ReverseTransformCamera=function(e,t){t.FocalPoint=this.ReverseTransform(e.FocalPoint,e.Height/2),t.Roll=e.Roll+this.DeltaRoll,t.Height=e.Height,t.Width=t.Height*t.ViewportWidth/t.ViewportHeight},SA.PairCorrelation=e,SA.PairTransformation=t})();(function(){"use strict";function e(e){var t=this;this.Thumb=null,this.Active=!1,this.Color=[0,1,0],this.Shapes=[],this.Bounds=null,e&&(this.Viewer=e,this.Viewer.AddWidget(this))}e.prototype.IsEmpty=function(){return this.Shapes.length==0},e.prototype.Union=function(e){for(var t=0;t<e.Shapes.length;++t)this.Shapes.push(e.Shapes[t]);this.Bounds=null},e.prototype.ContainedInBounds=function(e){var t=this.GetBounds();if(t[0]>e[0]&&t[1]<e[1]&&t[2]>e[2]&&t[3]<e[3])return 2;if(t[1]<e[0]||t[0]>e[1]||t[3]<e[2]||t[2]>e[3])return 0;var n=!1,r=!1;for(var i=0;i<this.Shapes.length;++i){var s=this.Shapes[i].ContainedInBounds(e);if(s==1)return 1;s==0&&(r=!0),s==2&&(n=!0);if(n&&r)return 1}return n?2:0},e.prototype.GetViewCenter=function(e){var t=this.GetBounds();return e.Camera.ConvertPointWorldToViewer((t[0]+t[1])*.5,(t[2]+t[3])*.5)},e.prototype.GetViewBounds=function(e){if(this.Shapes.length==0)return[0,0,0,0];var t=this.GetViewCenter(e),n=[t[0],t[0],t[1],t[1]];for(var r=0;r<this.Shapes.length;++r){var i=this.Shapes[r];for(var s=0;s<i.Points.length;++s){var o=i.Points[s];o=e.Camera.ConvertPointWorldToViewer(o[0],o[1]),o[0]<n[0]&&(n[0]=o[0]),o[0]>n[1]&&(n[1]=o[0]),o[1]<n[2]&&(n[2]=o[1]),o[1]>n[3]&&(n[3]=o[1])}}return n},e.prototype.ComputeViewUpperRight=function(e){var t=this.GetBounds(),n=e.Camera.ConvertPointWorldToViewer(t[0],t[2]),r=e.Camera.ConvertPointWorldToViewer(t[0],t[3]),i=e.Camera.ConvertPointWorldToViewer(t[1],t[3]),s=e.Camera.ConvertPointWorldToViewer(t[1],t[2]);this.ViewUpperRight=n;var o=n[0]-n[1],u=r[0]-r[1];u>o&&(o=u,this.ViewUpperRight=r),u=i[0]-i[1],u>o&&(o=u,this.ViewUpperRight=i),u=s[0]-s[1],u>o&&(o=u,this.ViewUpperRight=s)},e.prototype.Draw=function(e){this.ComputeViewUpperRight(e);for(var t=0;t<this.Shapes.length;++t)this.Active?this.Shapes[t].OutlineColor=[1,1,0]:this.Shapes[t].OutlineColor=this.Color,this.Shapes[t].Draw(e)},e.prototype.Serialize=function(){if(this.Thumb)return null;var e=new Object;e.type="stack_section",e.color=this.Color,e.shapes=[];for(var t=0;t<this.Shapes.length;++t){var n=this.Shapes[t],r={closedloop:n.Closed,points:[]};for(var i=0;i<n.Points.length;++i)r.points.push([n.Points[i][0],n.Points[i][1]]);e.shapes.push(r)}return e},e.prototype.Load=function(e){e.color&&(this.Color[0]=parseFloat(e.color[0]),this.Color[1]=parseFloat(e.color[1]),this.Color[2]=parseFloat(e.color[2]));if(!e.shapes)return;for(var t=0;t<e.shapes.length;t++){var n=e.shapes[t];if(n.points){var r=n.points,i=new SAM.Polyline;i.OutlineColor=this.Color,i.FixedSize=!1,i.LineWidth=0,n.closedloop&&(i.Closed=n.closedloop),this.Shapes.push(i);for(var s=0;s<r.length;++s)i.Points[s]=[r[s][0],r[s][1]];i.UpdateBuffers()}}},e.prototype.GetCenter=function(){var e=this.GetBounds();return[(e[0]+e[1])*.5,(e[2]+e[3])*.5]},e.prototype.GetBounds=function(){if(this.Thumb){var e=this.Thumb.Height*this.Thumb.ScreenPixelSpacing/4,t=this.ThumbX,n=this.ThumbY;return[t-e,t+e,n-e,n+e]}if(this.Shapes.length==0)return this.Bounds;if(!this.Bounds){this.Bounds=this.Shapes[0].GetBounds();for(var r=1;r<this.Shapes.length;++r){var i=this.Shapes[r].GetBounds();i[0]<this.Bounds[0]&&(this.Bounds[0]=i[0]),i[1]>this.Bounds[1]&&(this.Bounds[1]=i[1]),i[2]<this.Bounds[2]&&(this.Bounds[2]=i[2]),i[3]>this.Bounds[3]&&(this.Bounds[3]=i[3])}}return this.Bounds.slice(0)},e.prototype.Deactivate=function(){this.Viewer.DeactivateWidget(this);for(var e=0;e<this.Shapes.length;++e)this.Shapes[e].Active=!1;eventuallyRender()},e.prototype.HandleKeyPress=function(e,t){return!0},e.prototype.HandleMouseDown=function(e){return!0},e.prototype.HandleMouseUp=function(e){return!0},e.prototype.HandleDoubleClick=function(e){return!0},e.prototype.HandleMouseMove=function(e){return!0},e.prototype.CheckActive=function(e){return!1},e.prototype.GetActive=function(){return!1},e.prototype.SetActive=function(e){if(e){this.Viewer.ActivateWidget(this);for(var t=0;t<this.Shapes.length;++t)this.Shapes[t].Active=!0;eventuallyRender()}else this.Deactivate(),this.Viewer.DeactivateWidget(this)},e.prototype.RemoveFromViewer=function(){this.Viewer&&this.Viewer.RemoveWidget(this)},e.prototype.RigidAlign=function(e,t){var n=this.GetCenter(),r=e.GetCenter();t[0]=r[0]-n[0],t[1]=r[1]-n[1];if(this.Thumb||e.Thumb){t[2]=0;return}var i=this.GetBounds();i[0]+=t[0],i[1]+=t[0],i[2]+=t[1],i[3]+=t[1];var s=e.GetBounds();s[0]=Math.min(i[0],s[0]),s[1]=Math.max(i[1],s[1]),s[2]=Math.min(i[2],s[2]),s[3]=Math.max(i[3],s[3]);var o=(s[0]+s[1])*.5,u=(s[2]+s[3])*.5;s[0]=o+1.1*(i[0]-o),s[1]=o+1.1*(i[1]-o),s[2]=u+1.1*(i[2]-u),s[3]=u+1.1*(i[3]-u);var a;a=Math.sqrt((s[1]-s[0])*(s[3]-s[2])/16e4);var f=new SA.DistanceMap(s,a);for(var l=0;l<e.Shapes.length;++l)f.AddPolyline(e.Shapes[l]);f.Update(),eventuallyRender(),this.RigidAlignWithMap(f,t)},e.prototype.RigidAlignWithMap=function(e,t){var n=this.GetCenter(),r=[0,0,0],i=null,s=-1;for(var o=-180;o<180;o+=30){r=[t[0],t[1],Math.PI*o/180];var u;for(var a=0;a<5;++a)u=this.RigidDecentStep(r,n,e,2e5);u*=1+Math.abs(o/180);if(s<0||u<s)s=u,i=r.slice(0)}r=i;var f=2e5;for(var a=0;a<100;++a)f=this.RigidDecentStep(r,n,e,f);t[0]=r[0],t[1]=r[1],t[2]=r[2]},e.prototype.RigidDecentStep=function(e,t,n,r){var i,s,o,u,a=Math.sin(e[2]),f=Math.cos(e[2]),l=0,c=0,h=0,p=0,d=0;for(var v=0;v<this.Shapes.length;++v){var m=this.Shapes[v];for(var g=0;g<m.Points.length;++g){var y=m.Points[g],b=y[0],w=y[1];i=b-t[0],s=w-t[1],o=f*i+a*s,u=-a*i+f*s,b=b+(o-i)+e[0],w=w+(u-s)+e[1];var E=n.GetDistance(b,w)*n.Spacing;h+=E;var S=1;r>0&&(S=Math.exp(-0.69*E*E/(r*r))),E*=S;var x=n.GetGradient(b,w),T=Math.sqrt(x[0]*x[0]+x[1]*x[1]);if(T>0){++d,x[0]=-x[0]*E/T,x[1]=-x[1]*E/T,l+=x[0],c+=x[1];var N=u*x[0]-o*x[1];p+=N/(o*o+u*u)}else var C=1}}var k=h/d;return e[0]+=l/d,e[1]+=c/d,e[2]+=p/d,k},e.prototype.Transform=function(e,t,n){this.Bounds=null;for(var r=0;r<this.Shapes.length;++r){var i=this.Shapes[r];i.Trans=null;for(var s=0;s<i.Points.length;++s){var o=i.Points[s],u=o[0],a=o[1],f=u-t[0],l=a-t[1],c=Math.sin(n),h=Math.cos(n),p=h*f+c*l,d=-c*f+h*l;o[0]=u+(p-f)+e[0],o[1]=a+(d-l)+e[1]}i.UpdateBuffers(this.Layer.AnnotationView)}},e.prototype.Translate=function(e){this.Bounds=null;for(var t=0;t<this.Shapes.length;++t){var n=this.Shapes[t];for(var r=0;r<n.Points.length;++r){var i=n.Points[r];i[0]+=e[0],i[1]+=e[1]}n.UpdateBuffers(this.Layer.AnnotationView)}},e.prototype.RemoveDuplicatePoints=function(e){e==undefined&&(e=0);for(var t=0;t<this.Shapes.length;++t){var n=this.Shapes[t],r=n.Points[n.Points.length-1],i=0;while(i<n.Points.length){var s=n.Points[i],o=s[0]-r[0],u=s[1]-r[1];Math.sqrt(o*o+u*u)<=e?n.Points.splice(i,1):(++i,r=s)}n.UpdateBuffers(this.Layer.AnnotationView)}},e.prototype.Decimate=function(){var e=this.GetBounds(),t=(e[1]-e[0]+e[3]-e[2])/400;for(var n=0;n<this.Shapes.length;++n)this.Shapes[n].Decimate(t)},SA.StackSectionWidget=e})();(function(){"use strict";function e(e,t,n){if(e==null)return;this.UserNoteFlag=!SA.Edit;var r=e.AnnotationView.CanvasDiv;this.Type="sections",this.Viewer=t,this.Layer=e,this.Layer.AddWidget(this);var i=this;this.Sections=[],this.Active=!1,this.Layer.EventuallyDraw(),this.ActiveSection=null,this.DragBounds=null,this.DragViewBounds=null,this.DeleteButton=$("<img>").appendTo(r).hide().css({height:"20px",position:"absolute","z-index":"500"}).attr("src",SAM.ImagePathUrl+"deleteSmall.png").click(function(){i.DeleteActiveSection()}),this.Menu=$("<div>").appendTo(r).hide().css({width:"150px","background-color":"white","border-style":"solid","border-width":"1px","border-radius":"5px","border-color":"#BBB",position:"absolute","z-index":"400",padding:"0px 2px"}),$("<button>").appendTo(this.Menu).text("Horizontal Sort").css({margin:"2px 0px",width:"100%"}).mouseup(function(){i.Menu.hide(),i.Sort(0)}),$("<button>").appendTo(this.Menu).text("Vertical Sort").css({margin:"2px 0px",width:"100%"}).mouseup(function(){i.Menu.hide(),i.Sort(1)}),$("<button>").appendTo(this.Menu).text("Delete").css({margin:"2px 0px",width:"100%"}).mouseup(function(){i.Menu.hide(),i.DeleteActiveSection()})}e.prototype.ComputeSections=function(e){this.Viewer=e;var t=this.Viewer.MainView.GetImageData(),n=SA.ComputeIntensityHistogram(t,!0),r=SA.PickThreshold(n);console.log("Threshold; "+r);var i=SA.GetHagFishContours(t,r,1e-4,.5);console.log("num contours: "+i.length);for(var s=0;s<i.length;++s)this.Sections.push(i[s].MakeStackSectionWidget(this.Layer.AnnotationView));this.MergeCloseSections(0),console.log("num merge: "+this.Sections.length),this.ViewSortSections(1,-1,0,1),this.CreationCamera=this.Layer.GetCamera().Serialize()},e.prototype.GetBounds=function(){if(this.Sections.length==0)return[0,0,0,0];var e=this.Sections[0].GetBounds();for(var t=0;t<this.Sections.length;++t){var n=this.Sections[t].GetBounds();n[0]<e[0]&&(e[0]=n[0]),n[1]>e[1]&&(e[1]=n[1]),n[2]<e[2]&&(e[2]=n[2]),n[3]>e[3]&&(e[3]=n[3])}return e},e.prototype.Sort=function(e){var t=0,n=1,r=1,i=1;if(this.ActiveSection){var s=this.GetBounds(),o=this.Layer.GetCamera().ConvertPointWorldToViewer((s[0]+s[1])*.5,(s[0]+s[1])*.5),u=this.ActiveSection.GetViewCenter(this.Layer.AnnotationView);u[0]<o[0]&&(r=-1),u[1]<o[1]&&(i=-1)}if(e==1){var a=r;r=i,i=a,t=1,n=0}this.ViewSortSections(t,r,n,i)},e.prototype.ViewSortSections=function(e,t,n,r){function i(t,r){return t[(n<<1)+1]>r[n<<1]&&(t[n<<1]>r[(n<<1)+1]||t[e<<1]>r[(e<<1)+1])?!0:!1}for(var s=0;s<this.Sections.length;++s){var o=this.Sections[s];o.ViewBounds=o.GetViewBounds(this.Layer.AnnotationView),SA.PermuteBounds(o.ViewBounds,e,t),SA.PermuteBounds(o.ViewBounds,n,r)}for(var s=1;s<this.Sections.length;++s){var u=this.Sections[s-1].ViewBounds,a=-1;for(var f=s;f<this.Sections.length;++f){var l=this.Sections[f].ViewBounds;i(l,u)&&(u=l,a=f)}if(a>0){var c=this.Sections[a];this.Sections[a]=this.Sections[s-1],this.Sections[s-1]=c}}this.Layer.EventuallyDraw()},e.prototype.RemoveFromLayer=function(){this.Layer&&this.RemoveWidget(this)},e.prototype.DeleteActiveSection=function(){if(this.ActiveSection==null)return;var e=this.ActiveSection;this.SetActiveSection(null),this.RemoveSection(e),this.IsEmpty()&&(this.RemoveFromLayer(),this.Layer.EventuallyDraw(),window.SA&&SA.RecordState())},e.prototype.RemoveSection=function(e){this.ActiveSection==e&&(this.ActiveSection=null);var t=this.Sections.indexOf(e);t>-1&&this.Sections.splice(t,1)},e.prototype.SetActiveSection=function(e){if(e==this.ActiveSection)return;this.ActiveSection?(this.ActiveSection.Active=!1,this.DeleteButton.hide()):(e.Active=!0,this.DeleteButton.show()),this.ActiveSection=e,this.Layer.EventuallyDraw()},e.prototype.PlaceDeleteButton=function(e){if(e){var t=e.ViewUpperRight;this.DeleteButton.show().css({left:t[0]-10+"px",top:t[1]-10+"px"})}},e.prototype.DrawBounds=function(e,t,n,r){var i=[t[0],t[2]],s=[t[1],t[2]],o=[t[1],t[3]],u=[t[0],t[3]];n&&(i=e.Camera.ConvertPointWorldToViewer(i[0],i[1]),s=e.Camera.ConvertPointWorldToViewer(s[0],s[1]),o=e.Camera.ConvertPointWorldToViewer(o[0],o[1]),u=e.Camera.ConvertPointWorldToViewer(u[0],u[1]));var a=e.Context2d;a.save(),a.setTransform(1,0,0,1,0,0),a.beginPath(),a.strokeStyle=r,a.moveTo(i[0],i[1]),a.lineTo(s[0],s[1]),a.lineTo(o[0],o[1]),a.lineTo(u[0],u[1]),a.lineTo(i[0],i[1]),a.stroke(),a.restore()},e.prototype.Draw=function(e){if(!this.Active)return;for(var t=0;t<this.Sections.length;++t){var n=this.Sections[t];n.Draw(e);var r=n.ViewUpperRight,i=e.Context2d;i.save(),i.setTransform(1,0,0,1,0,0),i.font="20px Georgia",i.fillStyle="#00F",i.fillText((t+1).toString(),r[0]-10,r[1]+25),i.restore()}this.ActiveSection&&this.PlaceDeleteButton(this.ActiveSection);if(this.ActiveSection){var s=this.ActiveSection.GetBounds();this.DrawBounds(e,s,!0,"#FF0")}this.DragBounds&&this.DrawBounds(e,this.DragBounds,!0,"#F00")},e.prototype.Serialize=function(){var e=new Object;e.type="sections",e.sections=[];for(var t=0;t<this.Sections.length;++t){var n=this.Sections[t].Serialize();e.sections.push(n)}return e.creation_camera=this.CreationCamera,e.user_note_flag=this.UserNoteFlag,e},e.prototype.Load=function(e){for(var t=0;t<e.sections.length;t++){var n=new SA.StackSectionWidget;n.Load(e.sections[t]),n.IsEmpty()||this.Sections.push(n)}this.CreationCamera=e.creation_camera,this.UserNoteFlag=e.user_note_flag,this.IsEmpty()&&this.RemoveFromLayer()},e.prototype.IsEmpty=function(){return this.Sections.length==0},e.prototype.HandleMouseWheel=function(e){return!0},e.prototype.HandleKeyPress=function(e,t){return e.keyCode==46?(this.DeleteActiveSection(),!1):!0},e.prototype.HandleMouseDown=function(e){return this.StartX=e.offsetX,this.StartY=e.offsetY,this.ActiveSection?(e.which==3&&this.Menu.show().css({left:e.offsetX+"px",top:e.offsetY+"px"}),!1):!0},e.prototype.HandleMouseUp=function(e){var t=e.offsetX,n=e.offsetY;return e.which==1&&(Math.abs(t-this.StartX)+Math.abs(n-this.StartY)<5||this.DragBounds&&this.ProcessBounds(this.DragBounds),this.DragBounds=null,this.Layer.EventuallyDraw()),this.Menu.hide(),!1},e.prototype.HandleDoubleClick=function(e){return!0},e.prototype.HandleMouseMove=function(e){var t=e.offsetX,n=e.offsetY;if(e.which==1){var r=this.Layer.GetCamera().ConvertPointViewerToWorld(this.StartX,this.StartY),i=this.Layer.GetCamera().ConvertPointViewerToWorld(t,n);return this.DragBounds=[r[0],i[0],r[1],i[1]],this.Layer.EventuallyDraw(),!1}if(e.which==0){var s=this.Layer.GetCamera().ConvertPointViewerToWorld(t,n),o=null,u=-1,a=10/this.Layer.GetPixelsPerUnit();for(var f=0;f<this.Sections.length;++f){var l=this.Sections[f].GetBounds();if(s[0]>l[0]-a&&s[0]<l[1]+a&&s[1]>l[2]-a&&s[1]<l[3]+a){var c=(l[1]-l[0])*(l[3]-l[2]);if(o==null||c<u)o=this.Sections[f],u=c}}return this.SetActiveSection(o),!0}},e.prototype.CheckActive=function(e){return this.Active},e.prototype.GetActive=function(){return this.Active},e.prototype.SetActive=function(e){e?(this.Layer.ActivateWidget(this),this.Active=!0):(this.Layer.DeactivateWidget(this),this.Active=!1,this.DeactivateCallback&&this.DeactivateCallback()),this.Layer.EventuallyDraw()},e.prototype.Deactivate=function(){this.SetActive(!1)},e.prototype.ProcessBounds=function(e){if(e[0]>e[1]){var t=e[0];e[0]=e[1],e[1]=t}if(e[2]>e[3]){var t=e[2];e[2]=e[3],e[3]=t}var n=[],r=[];for(var i=0;i<this.Sections.length;++i){var s=this.Sections[i],o=s.ContainedInBounds(e);o==2&&n.push(s),o==1&&r.push(s)}if(n.length>1)for(var i=1;i<n.length;++i)n[0].Union(n[i]),this.RemoveSection(n[i]);if(n.length==0&&r.length==0){var u=this,a=(e[1]-e[0]+e[3]-e[2])/600;a<1&&(a=1),SA.GetCutoutImage(this.Viewer.GetCache(),[Math.round((e[1]-e[0])/a),Math.round((e[3]-e[2])/a)],[.5*(e[0]+e[1]),.5*(e[2]+e[3])],a,0,null,function(e){var t=SA.ComputeIntensityHistogram(e,!0),n=SA.PickThreshold(t),r=u.GetBigContours(e,n);if(r.length==0)return;var i=new SA.StackSectionWidget;for(var s=0;s<r.length;++s)i.Shapes.push(r[s].MakePolyline([0,1,0]));u.Sections.push(i),u.Layer.EventuallyDraw()})}if(n.length==0&&r.length==1){var s=r[0];n=[],r=[];for(var i=0;i<s.Shapes.length;++i){var f=s.Shapes[i].ContainedInBounds(e);f==1&&r.push(s.Shapes[i]),f==2&&n.push(s.Shapes[i])}if(r.length==0){var l,c=new SA.StackSectionWidget;c.Shapes=n;for(var i=0;i<n.length;++i)l=s.Shapes.indexOf(n[i]),l!=-1&&s.Shapes.splice(l,1),s.Bounds=null;l=this.Sections.indexOf(s),this.Sections.splice(l,0,c)}}},e.prototype.GetContours=function(e,t){var n=[];for(var r=1;r<e.width;++r)for(var i=1;i<e.height;++i){var s=SA.SeedIsoContour(e,r,i,r-1,i,t);if(s){var o=new SA.Contour;o.Camera=e.Camera,o.Threshold=t,o.SetPoints(s),o.RemoveDuplicatePoints(2);var u=o.GetArea();n.push(o)}var a=SA.SeedIsoContour(e,r,i,r,i-1,t);a&&(o=new SA.Contour,o.Camera=e.Camera,o.Threshold=t,o.SetPoints(a),o.RemoveDuplicatePoints(2),u=o.GetArea(),n.push(o))}return n},e.prototype.GetBigContours=function(e,t){var n=this.GetContours(e,t),r=0;for(var i=0;i<n.length;++i)n[i].GetArea()>r&&(r=n[i].GetArea());var s=[];for(var i=0;i<n.length;++i)n[i].GetArea()>r*.5&&s.push(n[i]);return s},e.prototype.MergeCloseSections=function(e){for(var t=0;t<this.Sections.length;++t){var n=this.Sections[t];for(var r=t+1;r<this.Sections.length;++r){var i=this.Sections[r],s=n.GetBounds(),o=i.GetBounds();s[1]+e>o[0]&&s[0]-e<o[1]&&s[3]+e>o[2]&&s[2]-e<o[3]&&(n.Union(i),this.Sections.splice(r,1),--r)}}},SA.SectionsWidget=e})();